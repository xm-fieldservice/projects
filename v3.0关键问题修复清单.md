# v3.0æ–‡æ¡£å…³é”®é—®é¢˜ä¿®å¤æ¸…å•

## ğŸš¨ **æœ€é«˜ä¼˜å…ˆçº§ä¿®å¤é¡¹**

### **1. æ¥å£å­—æ®µå·®å¼‚ä¿®æ­£**

#### **é—®é¢˜**ï¼š`autoSaved`å­—æ®µç¼ºå¤±å¯¼è‡´é—®ç­”â†’ç¬”è®°è‡ªåŠ¨è½¬æ¢ä¸­æ–­

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```javascript
// QANoteBlock.js ä¿®æ­£
askQuestion: async (questionData) => {
    const response = await APIClient.sendQuestion(questionData);
    
    if (response.success && response.data.ai_response) {
        // è‡ªåŠ¨ä¿å­˜ä¸ºç¬”è®°
        const autoSaveResult = await this.saveNote({
            title: questionData.title,
            content: response.data.ai_response.response,
            tags: [...questionData.tags, 'AIé—®ç­”']
        });
        
        return {
            ...response,
            data: {
                ...response.data,
                autoSaved: autoSaveResult.success, // ğŸ”´ å…³é”®ä¿®å¤
                autoSaveDetails: autoSaveResult
            }
        };
    }
    
    return response;
}
```

### **2. äº‘ç«¯åŒæ­¥åŠŸèƒ½æ•´åˆ**

#### **é—®é¢˜**ï¼šæœ¬åœ°å­˜å‚¨å’Œäº‘ç«¯APIå‰²è£‚ï¼Œç¼ºå°‘ç»Ÿä¸€è°ƒç”¨

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```javascript
// QANoteBlock.js äº‘ç«¯åŒæ­¥ä¿®æ­£
saveNote: async (noteData) => {
    try {
        // ğŸ”´ åŒæ—¶æ‰§è¡Œæœ¬åœ°å’Œäº‘ç«¯ä¿å­˜
        const [localResult, cloudResult] = await Promise.allSettled([
            NotebookManager.saveNote(noteData.title, noteData.content, noteData.tags),
            APIClient.saveNote(noteData)
        ]);
        
        return {
            success: localResult.status === 'fulfilled',
            data: {
                noteId: `local_${Date.now()}`,
                savedAt: new Date().toISOString(),
                storageType: localResult.status === 'fulfilled' ? 'localStorage' : 'failed',
                cloudSync: cloudResult.status === 'fulfilled',
                cloudError: cloudResult.status === 'rejected' ? cloudResult.reason.message : null,
                fileDownloaded: localResult.status === 'fulfilled',
                backupCreated: cloudResult.status === 'fulfilled'
            },
            error: localResult.status === 'rejected' ? localResult.reason.message : null
        };
    } catch (error) {
        return {
            success: false,
            error: `ä¿å­˜å¤±è´¥: ${error.message}`
        };
    }
}
```

### **3. éƒ¨ç½²é…ç½®ç»Ÿä¸€ä¿®æ­£**

#### **é—®é¢˜**ï¼šdocker-compose.ymlä¸DEPLOYMENT_CONFIGç«¯å£ä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```yaml
# docker-compose.yml ä¿®æ­£
services:
  qa-frontend:
    build: 
      context: .
      dockerfile: deploy-block/Dockerfile.frontend
    ports:
      - "3000:3000"  # ğŸ”´ ä¿®æ­£ä¸ºä¸€è‡´çš„ç«¯å£æ˜ å°„
    volumes:
      - ./frontend:/usr/share/nginx/html
```

```javascript
// shared/config.js æ–°å¢ç»Ÿä¸€é…ç½®
const DEPLOYMENT_CONFIG = {
    FRONTEND_PORT: 3000,
    BACKEND_PORT: 8000,
    DATABASE_PORT: 3306,
    NGINX_PORT: 3000,  // ğŸ”´ æ–°å¢nginxç«¯å£é…ç½®
    ALLOWED_MODES: ['qa', 'note'],
    REQUIRED_BLOCKS: ['auth', 'qa-note', 'ui', 'deploy']
};
```

## âš ï¸ **ä¸­ç­‰ä¼˜å…ˆçº§ä¿®å¤é¡¹**

### **4. UIBlockæ¶ˆæ¯æç¤ºå®ç°**

#### **é—®é¢˜**ï¼šshowMessageæ¥å£ä»…æœ‰å®šä¹‰ï¼Œæ— å…·ä½“å®ç°

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```javascript
// UIBlock.js è¡¥å……å®ç°
showMessage: (text, type, options = {}) => {
    const messageOptions = {
        duration: 3000,
        closable: true,
        position: 'top-right',
        icon: true,
        ...options
    };
    
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-toast ${type}`;
    messageDiv.innerHTML = `
        ${messageOptions.icon ? getIcon(type) : ''}
        <span>${text}</span>
        ${messageOptions.closable ? '<span class="close-btn">&times;</span>' : ''}
    `;
    
    // åº”ç”¨æ ·å¼å’Œä½ç½®
    messageDiv.style.cssText = getMessageStyles(type, messageOptions.position);
    
    document.body.appendChild(messageDiv);
    
    // è‡ªåŠ¨å…³é—­
    if (messageOptions.duration > 0) {
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, messageOptions.duration);
    }
    
    // æ‰‹åŠ¨å…³é—­
    if (messageOptions.closable) {
        messageDiv.querySelector('.close-btn').addEventListener('click', () => {
            messageDiv.remove();
        });
    }
    
    return {
        success: true,
        data: {
            messageId: `msg_${Date.now()}`,
            displayedAt: new Date().toISOString(),
            willCloseAt: messageOptions.duration > 0 ? 
                new Date(Date.now() + messageOptions.duration).toISOString() : null
        }
    };
}

function getIcon(type) {
    const icons = {
        success: 'âœ…',
        error: 'âŒ', 
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
    };
    return icons[type] || '';
}

function getMessageStyles(type, position) {
    const colors = {
        success: '#4caf50',
        error: '#f44336',
        warning: '#ff9800', 
        info: '#2196f3'
    };
    
    const positions = {
        'top-right': 'position: fixed; top: 80px; right: 20px;',
        'top-left': 'position: fixed; top: 80px; left: 20px;',
        'bottom-right': 'position: fixed; bottom: 20px; right: 20px;',
        'bottom-left': 'position: fixed; bottom: 20px; left: 20px;'
    };
    
    return `
        ${positions[position] || positions['top-right']}
        background: ${colors[type] || colors.info};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        font-size: 14px;
        font-weight: 500;
        min-width: 200px;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
        cursor: pointer;
    `;
}
```

### **5. éƒ¨ç½²å¥åº·æ£€æŸ¥è¡¥å……**

#### **é—®é¢˜**ï¼šç¼ºå°‘å¥åº·æ£€æŸ¥å’Œnginxè¯¦ç»†é…ç½®

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```yaml
# docker-compose.yml å¥åº·æ£€æŸ¥è¡¥å……
services:
  qa-frontend:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  qa-backend:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

```nginx
# nginx.conf è¯¦ç»†é…ç½®
server {
    listen 3000;
    server_name localhost;
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }
    
    # é™æ€æ–‡ä»¶
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # APIä»£ç†
    location /api {
        proxy_pass http://qa-backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
}
```

## ğŸŸ¡ **ä½ä¼˜å…ˆçº§ä¼˜åŒ–é¡¹**

### **6. è®¤è¯çŠ¶æ€åŒæ­¥äº‹ä»¶æœºåˆ¶**

```javascript
// AuthBlock.js æ·»åŠ äº‹ä»¶æœºåˆ¶
login: async (username, password) => {
    try {
        const response = await fetch('http://localhost:8000/api/v1/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            localStorage.setItem(this.TOKEN_KEY, data.data.access_token);
            localStorage.setItem(this.USER_KEY, JSON.stringify(data.data.user_info));
            
            // ğŸ”´ è§¦å‘ç™»å½•æˆåŠŸäº‹ä»¶
            document.dispatchEvent(new CustomEvent('auth-login-success', {
                detail: data.data.user_info
            }));
            
            return {
                success: true,
                data: {
                    userId: data.data.user_info.id,
                    username: data.data.user_info.username,
                    token: data.data.access_token,
                    role: data.data.user_info.role || 'user',
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                }
            };
        } else {
            throw new Error(data.message || 'ç™»å½•å¤±è´¥');
        }
    } catch (error) {
        document.dispatchEvent(new CustomEvent('auth-login-error', {
            detail: error.message
        }));
        return {
            success: false,
            error: error.message
        };
    }
}
```

```javascript
// UIBlock.js ç›‘å¬è®¤è¯äº‹ä»¶
initialize: async (options = {}) => {
    // ç›‘å¬è®¤è¯äº‹ä»¶
    document.addEventListener('auth-login-success', (e) => {
        this.switchToBlock('qa-note');
        this.showMessage(`æ¬¢è¿ï¼Œ${e.detail.username}ï¼`, 'success');
    });
    
    document.addEventListener('auth-login-error', (e) => {
        this.showMessage(`ç™»å½•å¤±è´¥ï¼š${e.detail}`, 'error');
    });
    
    // æ£€æŸ¥ç°æœ‰ç™»å½•çŠ¶æ€
    if (AuthBlock.isLoggedIn()) {
        this.switchToBlock('qa-note');
    } else {
        this.switchToBlock('auth');
    }
    
    return {
        success: true,
        data: {
            initializedAt: new Date().toISOString(),
            initialBlock: AuthBlock.isLoggedIn() ? 'qa-note' : 'auth',
            theme: options.theme || 'light',
            userAgent: navigator.userAgent,
            performance: {
                loadTime: performance.now() / 1000,
                memoryUsage: (performance.memory?.usedJSHeapSize || 0) / 1024 / 1024 + 'MB'
            }
        }
    };
}
```

## ğŸ“ˆ **ä¿®å¤ä¼˜å…ˆçº§çŸ©é˜µ**

| ä¿®å¤é¡¹ | å½±å“çº§åˆ« | å®ç°éš¾åº¦ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ |
|--------|----------|----------|--------|----------|
| autoSavedå­—æ®µä¿®æ­£ | ğŸ”´ é«˜ | ğŸŸ¢ ä½ | **P0** | 2å°æ—¶ |
| äº‘ç«¯åŒæ­¥æ•´åˆ | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | **P0** | 4å°æ—¶ |
| ç«¯å£é…ç½®ç»Ÿä¸€ | ğŸŸ  ä¸­ | ğŸŸ¢ ä½ | **P1** | 1å°æ—¶ |
| æ¶ˆæ¯æç¤ºå®ç° | ğŸŸ  ä¸­ | ğŸŸ¡ ä¸­ | **P1** | 3å°æ—¶ |
| å¥åº·æ£€æŸ¥é…ç½® | ğŸŸ¡ ä½ | ğŸŸ¢ ä½ | **P2** | 2å°æ—¶ |
| äº‹ä»¶æœºåˆ¶ä¼˜åŒ– | ğŸŸ¡ ä½ | ğŸŸ  é«˜ | **P3** | 6å°æ—¶ |

## ğŸ¯ **å»ºè®®ä¿®å¤é¡ºåº**

### **ç¬¬ä¸€æ‰¹ï¼ˆå½“å¤©å®Œæˆï¼‰**ï¼š
1. autoSavedå­—æ®µä¿®æ­£ (2å°æ—¶)
2. ç«¯å£é…ç½®ç»Ÿä¸€ (1å°æ—¶)
3. äº‘ç«¯åŒæ­¥æ•´åˆ (4å°æ—¶)

### **ç¬¬äºŒæ‰¹ï¼ˆæ¬¡æ—¥å®Œæˆï¼‰**ï¼š
4. æ¶ˆæ¯æç¤ºå®ç° (3å°æ—¶)
5. å¥åº·æ£€æŸ¥é…ç½® (2å°æ—¶)

### **ç¬¬ä¸‰æ‰¹ï¼ˆæŒ‰éœ€ä¼˜åŒ–ï¼‰**ï¼š
6. äº‹ä»¶æœºåˆ¶ä¼˜åŒ– (6å°æ—¶)

**æ€»è®¡ä¿®å¤æ—¶é—´**ï¼š18å°æ—¶ï¼ˆçº¦2-3ä¸ªå·¥ä½œæ—¥ï¼‰

å®Œæˆå‰ä¸¤æ‰¹ä¿®å¤åï¼Œv3.0æ–‡æ¡£å³å¯è¾¾åˆ°**ç”Ÿäº§å¯ç”¨çŠ¶æ€**ã€‚ 