<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试表单显示问题</title>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/style/jsmind.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/es6/jsmind.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/es6/jsmind.draggable-node.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            min-height: 100vh; /* 确保页面高度 */
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            position: relative;
            z-index: 1000; /* 确保显示在最前面 */
        }
        
        .container {
            display: flex;
            height: 600px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .mindmap-section {
            flex: 1;
            border-right: 2px solid #ddd;
        }
        
        #jsmind_container {
            width: 100%;
            height: 100%;
        }
        
        .details-section {
            width: 400px;
            background: #f9f9f9;
            padding: 20px;
            overflow-y: auto;
            border: 2px solid red; /* 红色边框便于调试 */
        }
        
        .node-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid green; /* 绿色边框便于调试 */
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .form-textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        #debugLog {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            position: relative;
            z-index: 1000;
            display: block !important; /* 强制显示 */
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="debug-info">
        <h3>🔍 调试信息</h3>
        <p>状态: <span id="status">正在初始化...</span></p>
        <p>当前选中节点: <span id="currentNode">无</span></p>
        <p>详情页状态: <span id="detailsStatus">未显示</span></p>
        <button class="test-btn" onclick="testShowForm()">强制显示表单</button>
        <button class="test-btn" onclick="testSelectNode()">测试选中节点</button>
        <button class="test-btn" onclick="testSelectChild()">测试子节点</button>
        <button class="test-btn" onclick="clearLog()">清空日志</button>
    </div>
    
    <div class="container">
        <div class="mindmap-section">
            <div id="jsmind_container"></div>
        </div>
        
        <div class="details-section">
            <h3>📋 节点详情页</h3>
            <div id="placeholder" style="text-align: center; color: #666; margin: 20px 0;">
                请点击思维导图中的任意节点<br>查看详细信息
            </div>
            <div id="nodeDetails" style="display: none; border: 2px solid blue;"></div>
        </div>
    </div>
    
    <div id="debugLog"></div>

    <script type="text/javascript">
        var debugLog = document.getElementById('debugLog');
        var status = document.getElementById('status');
        var currentNodeSpan = document.getElementById('currentNode');
        var detailsStatusSpan = document.getElementById('detailsStatus');
        
        // 基础测试 - 确认JavaScript正在运行
        console.log('🚀 JavaScript开始执行');
        // alert('🚀 JavaScript正在运行!'); // 强制弹窗确认
        
        // 立即向页面写入测试内容
        setTimeout(function() {
            var testDiv = document.getElementById('debugLog');
            if (testDiv) {
                testDiv.innerHTML = '🚀 JavaScript正在运行，日志系统已启动<br>';
                testDiv.style.display = 'block';
                testDiv.style.background = 'yellow';
                testDiv.style.color = 'black';
                console.log('✅ 日志区域已找到并设置');
            } else {
                console.log('❌ 找不到debugLog元素');
                // 强制创建日志区域
                var newLog = document.createElement('div');
                newLog.id = 'emergency-log';
                newLog.style.cssText = 'position:fixed; top:10px; right:10px; width:300px; height:200px; background:yellow; border:2px solid red; padding:10px; font-size:12px; z-index:9999; overflow-y:auto;';
                newLog.innerHTML = '🚨 紧急日志区域<br>JavaScript正在运行<br>';
                document.body.appendChild(newLog);
            }
        }, 100);
        
        function log(message) {
            console.log(message);
            var time = new Date().toLocaleTimeString();
            if (debugLog) {
                debugLog.innerHTML += `[${time}] ${message}<br>`;
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }
        
        function clearLog() {
            debugLog.innerHTML = '';
        }
        
        function updateStatus(msg) {
            status.textContent = msg;
            log('状态更新: ' + msg);
        }
        
        log('页面开始加载...');
        updateStatus('正在初始化jsMind...');
        
        // 节点数据库
        var nodeDatabase = {
            "root": {
                id: "root",
                title: "测试根节点",
                content: "这是根节点的内容",
                relations: { parent: null, children: ["test1", "test2"] },
                tags: { categories: ["测试"], technical: ["JavaScript"], status: ["活跃"] },
                time: "创建时间: 2024-01-20 | 修改时间: 2024-01-20",
                author: "测试用户"
            },
            "test1": {
                id: "test1", 
                title: "测试子节点1",
                content: "这是第一个测试子节点",
                relations: { parent: "root", children: [] },
                tags: { categories: ["子节点"], technical: ["Test"], status: ["完成"] },
                time: "创建时间: 2024-01-20",
                author: "测试用户"
            },
            "test2": {
                id: "test2", 
                title: "测试子节点2",
                content: "这是第二个测试子节点",
                relations: { parent: "root", children: [] },
                tags: { categories: ["子节点"], technical: ["Test"], status: ["完成"] },
                time: "创建时间: 2024-01-20",
                author: "测试用户"
            }
        };

        // 思维导图数据
        var mindData = {
            meta: { name: "测试", author: "Test", version: "1.0.0" },
            format: "node_tree",
            data: {
                id: "root",
                topic: "🧠 测试根节点",
                children: [
                    { id: "test1", topic: "测试子节点1", direction: "right" },
                    { id: "test2", topic: "测试子节点2", direction: "right" }
                ]
            }
        };

        // 配置选项
        var options = {
            container: 'jsmind_container',
            editable: true,
            theme: 'primary'
        };

        log('开始创建jsMind实例...');
        
        // 创建jsMind实例
        var jm = new jsMind(options);
        log('jsMind实例创建成功: ' + (jm ? 'YES' : 'NO'));
        
        jm.show(mindData);
        log('思维导图数据加载完成');
        
        jm.enable_draggable_node();
        log('拖拽功能已启用');
        
        log('jsMind实例创建完成');
        updateStatus('jsMind已初始化');

        // 显示节点详情函数
        function showNodeDetails(nodeId) {
            log(`🎯 showNodeDetails被调用，nodeId: ${nodeId}`);
            
            var nodeInfo = nodeDatabase[nodeId];
            var placeholder = document.getElementById('placeholder');
            var detailsDiv = document.getElementById('nodeDetails');
            
            log(`找到的节点信息: ${nodeInfo ? '存在' : '不存在'}`);
            
            if (!nodeInfo) {
                log('❌ 没有找到节点信息，创建默认信息');
                var node = jm.get_node(nodeId);
                nodeInfo = {
                    id: nodeId,
                    title: node ? node.topic : '未知节点',
                    content: "暂无详细内容",
                    relations: { parent: null, children: [] },
                    tags: { categories: [], technical: [], status: [] },
                    time: "创建时间: " + new Date().toLocaleDateString(),
                    author: "用户"
                };
                nodeDatabase[nodeId] = nodeInfo;
                log('✅ 默认节点信息已创建');
            }
            
            try {
                log('开始更新UI...');
                placeholder.style.display = 'none';
                detailsDiv.style.display = 'block';
                
                var formHTML = `
                    <div class="node-form">
                        <h4 style="color: red;">✅ 表单已成功加载！</h4>
                        <p style="background: #e7f3ff; padding: 5px; border-radius: 3px;">
                            🎯 当前节点: <strong>${nodeInfo.id}</strong>
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">🏷️ 节点ID</label>
                            <input type="text" class="form-input" value="${nodeInfo.id}" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">📝 节点标题</label>
                            <input type="text" class="form-input" value="${nodeInfo.title}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">📄 节点内容</label>
                            <textarea class="form-input form-textarea">${nodeInfo.content}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">👤 作者</label>
                            <input type="text" class="form-input" value="${nodeInfo.author}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">⏰ 时间</label>
                            <input type="text" class="form-input" value="${nodeInfo.time}" readonly>
                        </div>
                        
                        <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            🎉 表单显示成功！<br>
                            时间: ${new Date().toLocaleTimeString()}<br>
                            节点: ${nodeInfo.title}
                        </div>
                    </div>
                `;
                
                detailsDiv.innerHTML = formHTML;
                currentNodeSpan.textContent = nodeInfo.title;
                detailsStatusSpan.textContent = `已显示: ${nodeInfo.id}`;
                updateStatus(`✅ 表单显示成功: ${nodeInfo.title}`);
                
            } catch (error) {
                log('❌ 错误: ' + error.message);
                updateStatus('表单显示失败: ' + error.message);
            }
        }

        // 测试函数
        function testShowForm() {
            log('🧪 强制测试显示表单');
            showNodeDetails('root');
        }
        
        function testSelectNode() {
            log('🧪 测试选中节点');
            var rootNode = jm.get_root();
            log('根节点: ' + (rootNode ? rootNode.id : '无'));
            if (rootNode) {
                jm.select_node(rootNode.id);
                showNodeDetails(rootNode.id);
            }
        }
        
        function testSelectChild() {
            log('🧪 测试选中子节点');
            var test1Node = jm.get_node('test1');
            var test2Node = jm.get_node('test2');
            
            log('test1节点: ' + (test1Node ? '存在' : '不存在'));
            log('test2节点: ' + (test2Node ? '存在' : '不存在'));
            
            if (test1Node) {
                log('选中test1节点...');
                jm.select_node('test1');
                showNodeDetails('test1');
            } else if (test2Node) {
                log('选中test2节点...');
                jm.select_node('test2');
                showNodeDetails('test2');
            } else {
                log('❌ 没有找到子节点');
            }
        }

        // 多重事件监听策略
        setTimeout(function() {
            log('🔧 开始绑定事件监听器...');
            
            // 基础测试: 确认事件监听器是否能工作
            log('jsMind实例状态: ' + (jm ? '存在' : '不存在'));
            log('add_event_listener方法: ' + (typeof jm.add_event_listener));
            
            // 调试: 监听所有jsMind事件
            try {
                jm.add_event_listener(function(type, data) {
                    // 记录所有事件，不管什么类型
                    log(`🎯 jsMind事件: "${type}"`);
                    log(`🎯 事件数据: ${JSON.stringify(data)}`);
                    
                    // 如果是选中相关事件，立即调用更新
                    if (type === 'select_node' || type === 'click_node' || type.includes('select') || type.includes('click')) {
                        if (data && data.node) {
                            log(`✅ 检测到选中事件，更新详情页: ${data.node.id}`);
                            showNodeDetails(data.node.id);
                        }
                    }
                });
                log('✅ jsMind事件监听器绑定成功');
                
                // 测试事件监听器是否工作 - 程序化触发
                setTimeout(function() {
                    log('🧪 测试事件监听器 - 程序化选中test1');
                    jm.select_node('test1');
                }, 2000);
                
            } catch (error) {
                log('❌ jsMind事件监听器绑定失败: ' + error.message);
            }
            
            // 备用方案: 直接监听DOM上的所有点击事件
            document.addEventListener('click', function(e) {
                log(`🖱️ 全局点击事件: ${e.target.tagName} - ${e.target.className}`);
                
                // 检查是否在思维导图区域
                var mindmapContainer = document.getElementById('jsmind_container');
                if (mindmapContainer && mindmapContainer.contains(e.target)) {
                    log('🎯 点击了思维导图区域');
                    
                    // 延迟检查当前选中的节点
                    setTimeout(function() {
                        var selected = jm.get_selected_node();
                        if (selected) {
                            log(`✅ DOM点击后检测到选中节点: ${selected.id}`);
                            showNodeDetails(selected.id);
                        } else {
                            log('❌ DOM点击后没有选中节点');
                        }
                    }, 100);
                }
            });
            log('✅ 全局DOM点击监听器已绑定');
            
        }, 1000);

        // 页面加载完成自动测试
        window.addEventListener('load', function() {
            log('页面加载完成');
            
            setTimeout(function() {
                log('自动执行测试...');
                testShowForm();
            }, 2000);
        });
        
        log('脚本加载完成');
    </script>
</body>
</html> 