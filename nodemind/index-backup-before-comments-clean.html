<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsMind æœ¬åœ°ç‰ˆæ¼”ç¤º</title>
    <link type="text/css" rel="stylesheet" href="node_modules/jsmind/style/jsmind.css" />
    <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <!-- å¤–éƒ¨æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/template-styles.css">
    
    <!-- NodeMind æ ¸å¿ƒè„šæœ¬ -->
    <script src="src/services/nodemind_standard_parser.js"></script>
</head>

<body>
    <!-- å¤–éƒ¨JavaScriptæ–‡ä»¶ -->
    <script src="assets/js/app.js"></script>
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #6c757d;
            font-weight: 500;
        }
        
        .log-app {
            color: #007bff;
            font-weight: 500;
        }
        
        .log-command {
            color: #495057;
            margin-top: 2px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .calibration-info {
            margin-top: 15px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }
        
        .status-calibrating {
            color: #ff9800;
            font-weight: 500;
        }
        
        .status-calibrated {
            color: #4caf50;
            font-weight: 500;
        }
        
        .status-uncalibrated {
            color: #f44336;
            font-weight: 500;
        }
        
        /* æ ‡ç­¾ç®¡ç†ç»„ä»¶æ ·å¼ */
        .tags-management-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .tags-management-title {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tag-groups-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* èŠ‚ç‚¹ä¿¡æ¯é€‰é¡¹å¡ä¸­çš„æ ‡ç­¾ç»„æ ·å¼ä¼˜åŒ– */
        #tab-injection .tags-management-section .tag-group {
            margin-bottom: 0;
            padding: 12px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        
        #tab-injection .tags-management-section .tag-group-title {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
        
        #tab-injection .tags-management-section .tag-group-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        #tab-injection .tags-management-section .tag-item {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            border: 1px solid transparent;
        }
        
        #tab-injection .tags-management-section .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* æ‹·è´ç²˜è´´æŒ‰é’®æ ·å¼ */
        .btn-copy, .btn-paste {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-copy:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .btn-paste:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        /* åˆ†å‰²çº¿æ ·å¼ */
        .detail-splitter {
            width: 4px;
            background: #dee2e6;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }
        
        .detail-splitter:hover {
            background: #007bff;
        }
        
        .side-panel-splitter {
            height: 4px;
            background: #dee2e6;
            cursor: row-resize;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }
        
        .side-panel-splitter:hover {
            background: #007bff;
        }
        
        /* è¯¦æƒ…å·¥ä½œåŒºå¸ƒå±€ */
        .detail-workspace {
            display: flex;
            height: 100%;
            gap: 0;
        }
        
        .detail-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
        }
        
        .detail-side-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
        }
        
        .section-header {
            padding: 12px 15px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .section-header h4 {
            margin: 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* AIè¾“å…¥åŒºåŸŸæ ·å¼ */
        .ai-interaction-section {
            margin-top: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .ai-input-area {
            padding: 15px;
        }
        
        .ai-input {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
            background: white;
        }
        
        .ai-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .ai-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .content-editor {
            min-height: 200px;
        }
        
        /* æ ‡é¢˜åŒºåŸŸå’Œå…ƒä¿¡æ¯æ ·å¼ */
        .title-section {
            margin-bottom: 15px;
        }
        
        .title-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            background: white;
        }
        
        .title-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .node-meta-section {
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6c757d;
        }
        
        .meta-time {
            font-weight: 500;
        }
        
        .content-editor-section {
            margin-bottom: 15px;
        }
        
        .tags-section {
            margin-bottom: 15px;
        }
        
        .tags-label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: block;
        }
        
        /* æ¨¡æ¿åˆ—è¡¨æ ·å¼ */
        .template-list {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }
        
        /* æ¶ˆæ¯æç¤ºåŠ¨ç”» */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* æ–°çš„èŠ‚ç‚¹ä¿¡æ¯é¢æ¿å¸ƒå±€æ ·å¼ */
        .detail-workspace {
            display: flex;
            height: 100%;
            gap: 0;
            background: #f8f9fa;
        }
        
        .detail-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
            overflow-y: auto;
            min-width: 0;
        }
        
        .detail-splitter {
            width: 4px;
            background: #dee2e6;
            cursor: col-resize;
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        .detail-splitter:hover {
            background: #007bff;
        }
        
        .detail-splitter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: #adb5bd;
            border-radius: 1px;
        }
        
        .detail-side-panel {
            width: 300px;
            min-width: 200px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
        }
        
        /* æ ‡é¢˜åŒºåŸŸ */
        .title-section {
            margin-bottom: 8px;
        }
        
        .title-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            background: #ffffff;
            transition: border-color 0.2s ease;
        }
        
        .title-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        /* èŠ‚ç‚¹å…ƒä¿¡æ¯åŒºåŸŸ */
        .node-meta-section {
            margin-bottom: 16px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .meta-row label {
            font-weight: 600;
            color: #495057;
            min-width: 40px;
        }
        
        .meta-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: #ffffff;
        }
        
        .meta-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .meta-time {
            color: #6c757d;
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* å†…å®¹ç¼–è¾‘åŒºåŸŸ */
        .content-editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        
        .editor-header {
            margin-bottom: 8px;
        }
        
        .editor-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .content-editor {
            flex: 1;
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            background: #ffffff;
            resize: vertical;
            min-height: 300px; /* å¢åŠ æœ€å°é«˜åº¦ */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            transition: border-color 0.2s ease;
        }
        
        .content-editor.expanded {
            min-height: 450px; /* æ‰©å±•åçš„é«˜åº¦ */
        }
        
        .content-editor:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        /* å†…å®¹å¤´éƒ¨åŒºåŸŸ */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
        .content-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* é—®ç­”å¼€å…³æ ·å¼ */
        .qa-switch-container {
            display: flex;
            align-items: center;
        }
        
        .qa-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .qa-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .qa-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: #ccc;
            border-radius: 24px;
            transition: 0.3s;
            margin-right: 8px;
        }
        
        .qa-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .qa-switch input:checked + .qa-slider {
            background-color: #007bff;
        }
        
        .qa-switch input:checked + .qa-slider:before {
            transform: translateX(20px);
        }
        
        .qa-label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }
        
        /* AIäº¤äº’åŒºåŸŸ */
        .ai-interaction-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
        }
        
        .ai-input-area {
            margin-bottom: 12px;
        }
        
        .ai-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            background: #ffffff;
        }
        
        .ai-input:disabled {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .ai-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        
        .btn-save, .btn-submit {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-save:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-submit {
            background: #007bff;
            color: white;
        }
        
        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .ai-agent-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .agent-selector {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: #ffffff;
        }
        
        .agent-selector:disabled {
            background: #e9ecef;
            color: #6c757d;
        }
        
        /* æ ‡ç­¾åŒºåŸŸ */
        .tags-section {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
        }
        
        .tags-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .tags-label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
        
        /* é¡¹ç›®ä¿¡æ¯é¡µé¢æ ·å¼ */
        .node-info-panel {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .node-info-panel h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }
        
        /* é¡¹ç›®æŒ‰é’®å®¹å™¨æ ·å¼ */
        .basic-info-panel .project-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        /* æ ¡å‡†åŠŸèƒ½æ ·å¼ - ä»…å½±å“é¡¹ç›®ä¿¡æ¯é¢æ¿ */
        .basic-info-panel .calibrate-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .basic-info-panel .calibrate-btn:hover {
            background: #0056b3;
        }
        
        /* æç¤ºè¯æ¨¡æ¿æŒ‰é’®æ ·å¼ */
        .template-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .template-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .template-button:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .basic-info-panel .status-calibrated {
            color: #28a745;
            font-weight: 600;
        }
        
        .basic-info-panel .status-uncalibrated {
            color: #000000;
            font-weight: 600;
        }
        
        .basic-info-panel .status-calibrating {
            color: #ffc107;
            font-weight: 600;
        }
        
        .basic-info-panel .calibration-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #dee2e6;
        }
        
        /* å‘½ä»¤æ³¨å…¥æµ‹è¯•æ¡†æ ·å¼ */
        .basic-info-panel .command-injection-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #dee2e6;
        }
        
        .basic-info-panel .command-injection-section h4 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .basic-info-panel .injection-input-area {
            margin-bottom: 12px;
        }
        
        .basic-info-panel .injection-input-area label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
        }
        
        .basic-info-panel .injection-input-area textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        
        .basic-info-panel .injection-input-area textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .basic-info-panel .injection-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .basic-info-panel .inject-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .basic-info-panel .inject-btn:hover {
            background: #c82333;
        }
        
        .basic-info-panel .inject-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .basic-info-panel .clear-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .basic-info-panel .clear-btn:hover {
            background: #5a6268;
        }
        
        .basic-info-panel .injection-status {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .basic-info-panel .injection-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .basic-info-panel .injection-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* æ•´åˆæ§åˆ¶æ æ ·å¼ */
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 12px;
        }
        
        .toggle-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            user-select: none;
        }
        
        .toggle-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        
        .toggle-label {
            font-weight: 500;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .button-group .btn {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .button-group .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .button-group .btn-secondary:hover {
            background: #545b62;
        }
        
        .button-group .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .button-group .btn-primary:hover {
            background: #0056b3;
        }
        
        .button-group .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .button-group .btn-info:hover {
            background: #138496;
        }
        
        /* å…¨å±æ¨¡å¼æ ·å¼ */
        .content-section.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background: white !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        }
        
        .content-section.fullscreen .content-editor {
            height: calc(100vh - 120px) !important;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .content-section.fullscreen .controls-row {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding: 12px 0;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        /* è°ƒè¯•æ¨¡å¼å†…å®¹æ ·å¼ */
        .content-editor.debug-mode {
            font-family: 'Consolas', 'Monaco', monospace !important;
            font-size: 12px !important;
            line-height: 1.4 !important;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .content-editor.normal-mode {
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            background: white;
        }

        /* å³ä¾§é¢æ¿å„åŒºåŸŸ */
        .session-list-section {
            height: 60%; /* é»˜è®¤å æ®60%é«˜åº¦ */
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 100px; /* æœ€å°é«˜åº¦é™åˆ¶ */
            overflow: hidden;
        }
        
        .template-section {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 80px; /* æœ€å°é«˜åº¦é™åˆ¶ */
            overflow: hidden;
        }
        
        /* å³ä¾§é¢æ¿å†…éƒ¨åˆ†å‰²çº¿ */
        .side-panel-splitter {
            height: 4px;
            background: #dee2e6;
            cursor: row-resize;
            position: relative;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        
        .side-panel-splitter:hover {
            background: #007bff;
        }
        
        .side-panel-splitter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 2px;
            background: #adb5bd;
            border-radius: 1px;
        }
        
        .section-header {
            margin-bottom: 12px;
            flex-shrink: 0; /* æ ‡é¢˜ä¸æ”¶ç¼© */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }
        
        .view-mode-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
        }
        
        .view-mode-btn:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶æ»šåŠ¨ */
            min-height: 0; /* å…è®¸æ”¶ç¼© */
        }
        
        .template-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0; /* åˆ—è¡¨é¡¹ä¸æ”¶ç¼© */
        }
        
        .template-item:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .detail-side-panel {
                width: 250px;
                min-width: 200px;
            }
        }
        
        @media (max-width: 900px) {
            .detail-workspace {
                flex-direction: column;
            }
            
            .detail-splitter {
                display: none;
            }
            
            .detail-side-panel {
                width: 100%;
                max-height: 300px;
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
        }

        /* å››ç»„ä»¶å¸ƒå±€æ ·å¼ */
        .detail-workspace {
            display: flex;
            flex-direction: column;
            height: 800px;
            font-family: inherit;
        }

        /* æ ‡é¢˜åŒºåŸŸ */
        .title-area {
            background: #fafafa;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .qa-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qa-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .qa-toggle label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .title-content {
            flex: 1;
        }

        .node-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
            line-height: 1.4;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content-area {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* å›ºå®šé€‰é¡¹å¡æ¡†æ¶å®½åº¦ - ä¸è‡ªåŠ¨è°ƒèŠ‚ */
        .details-panel {
            width: 800px !important; /* å›ºå®šå®½åº¦ï¼Œä¸ä½¿ç”¨ clamp å‡½æ•° */
            min-width: 800px !important;
            max-width: 800px !important;
            flex-shrink: 0 !important;
        }
        
        /* å›ºå®šé€‰é¡¹å¡æ ‡ç­¾æŒ‰é’®å®½åº¦ - ä¸ä½¿ç”¨å¼¹æ€§å¸ƒå±€ */
        .tab-button {
            flex: none !important; /* å–æ¶ˆå¼¹æ€§å¸ƒå±€ */
            width: 400px !important; /* å›ºå®šå®½åº¦ï¼Œæ€»å®½åº¦800pxçš„ä¸€åŠ */
            min-width: 400px !important;
            max-width: 400px !important;
        }
        
        /* ç¡®ä¿é€‰é¡¹å¡å¤´éƒ¨ä¸ä½¿ç”¨flexçš„è‡ªåŠ¨åˆ†é… */
        .tab-header {
            display: flex !important;
            width: 800px !important; /* ä¸é€‰é¡¹å¡æ¡†æ¶å®½åº¦ä¸€è‡´ */
        }

        /* ç»„ä»¶A: å†…å®¹ç¼–è¾‘å™¨ */
        .content-section {
            flex: 0 0 auto;
            max-height: 280px;
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .content-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .content-controls {
            display: flex;
            gap: 8px;
        }

        .title-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .content-editor {
            height: 150px;
            max-height: 180px;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .meta-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        /* ç»„ä»¶B: ä¸‰æ ‡ç­¾é¡µç»„ä»¶ */
        .tags-section {
            padding: 0;
            background: #f9f9f9;
            border: 3px solid #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 400px;
            margin-top: 190px;
        }

        /* å†…éƒ¨æ ‡ç­¾é¡µå¤´éƒ¨ */
        .inner-tab-header {
            display: flex;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .inner-tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
            position: relative;
        }

        .inner-tab-button:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .inner-tab-button.active {
            background: #fff;
            color: #007bff;
            font-weight: 600;
        }

        .inner-tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #007bff;
        }

        /* å†…éƒ¨æ ‡ç­¾é¡µå†…å®¹å®¹å™¨ */
        .inner-tab-content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .inner-tab-content {
            display: none;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .inner-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* ä¼šè¯åˆ—è¡¨æ ·å¼ */
        .sessions-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .session-item {
            padding: 12px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .session-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
            transform: translateY(-1px);
        }

        .session-item.active {
            background-color: #e7f3ff;
            border-color: #007bff;
            border-width: 2px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .session-title {
            font-weight: 500;
            color: #333;
            flex: 1;
            margin-right: 8px;
            line-height: 1.4;
        }

        .session-actions {
            display: flex;
            gap: 4px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .session-item:hover .session-actions {
            opacity: 1;
        }

        .session-favorite-btn,
        .session-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .session-favorite-btn:hover {
            background-color: #ffc107;
            color: white;
        }

        .session-delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }

        .session-time {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .session-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .session-tag {
            background-color: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .session-empty {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .session-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .session-empty-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .session-empty-hint {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        /* æ¨¡æ¿åˆ—è¡¨æ ·å¼ */
        .templates-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .template-item {
            padding: 12px 16px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-item:hover {
            border-color: #28a745;
            box-shadow: 0 2px 4px rgba(40,167,69,0.1);
        }

        .template-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }

        .template-desc {
            font-size: 12px;
            color: #6c757d;
        }
        
        .template-item.selected {
            border-color: #28a745;
            border-width: 2px;
            background: #f8fff9;
            box-shadow: 0 2px 8px rgba(40,167,69,0.2);
        }

        .tags-header {
            margin-bottom: 15px;
        }

        .tags-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .tag-group {
            margin-bottom: 15px;
        }

        .tag-group-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            padding: 4px 8px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tag.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content-area {
                flex-direction: column;
            }
        }

        /* èŠ‚ç‚¹é€‰ä¸­é«˜äº®æ ·å¼ */
        .jmnode-selected {
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.6) !important;
            border: 2px solid #007bff !important;
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        /* ç§»é™¤äº†èŠ‚ç‚¹é€‰æ‹©åé¦ˆåŠ¨ç”»ç›¸å…³æ ·å¼ */

        /* é€‰é¡¹å¡åˆ‡æ¢åŠ¨ç”»å¢å¼º */
        .details-panel .tab-content {
            transition: all 0.3s ease;
        }

        .details-panel .tab-content.active {
            animation: slideInFromRight 0.3s ease-out;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* èŠ‚ç‚¹ä¿¡æ¯æ ‡ç­¾é¡µæŒ‰é’®é«˜äº® */
        .details-panel .tab-button.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* ç§»é™¤äº†æ ‡ç­¾é¡µåˆ‡æ¢åé¦ˆåŠ¨ç”»ç›¸å…³æ ·å¼ */
        
        /* èŠ‚ç‚¹ä¿¡æ¯é¢æ¿ä¸»å®¹å™¨æ ‡æ³¨ - æµ…è“è‰²è¾¹æ¡† */
        #injection-info-content {
            border: 3px solid #87CEEB;
            box-shadow: 0 0 10px rgba(135, 206, 235, 0.3);
            padding-bottom: 200px;
        }

        /* å·¦ä¾§é¢æ¿æ ·å¼ */
        .left-panel, #left-panel {
            /* ç§»é™¤äº†çº¢è‰²è¾¹æ¡† */
        }

      </style>
      
      <!-- ğŸ”¥ ç¬¬ä¸‰æ¬¡é‡æ„æ ¸å¿ƒæ¨¡å— - ä¸‡èƒ½æ•°æ®æ¶æ„ -->
      <script src="3rd_reconstruction/src/core/universal_data_service.js"></script>
      <script src="3rd_reconstruction/src/core/smart_md_parser.js"></script>
      <script src="3rd_reconstruction/src/adapters/ui_integration_adapter.js"></script>
      <script src="3rd_reconstruction/src/services/tag_service_replacement.js"></script>
      
      <!-- æ¶æ„å®ˆæŠ¤å·¥å…· - å®æ—¶ç›‘æ§æ¨¡å—åŒ–è§„èŒƒ -->
      <!-- <script src="src/utils/architecture_guard.js" type="module"></script> -->
      
      <!-- æ•°æ®ç»“æ„ç»Ÿä¸€ä¸æŸ“è‰²ç³»ç»Ÿ -->
      <script src="src/services/data_structure_unifier.js"></script>
      <script src="src/services/unified_node_styling_service.js"></script>
      <script src="fix_data_structure_and_coloring.js"></script>
      
      <!-- å¯è§†åŒ–ä¿®å¤æœåŠ¡ -->
      <script src="src/services/visual_repair_service.js"></script>
      
      <!-- æ¨¡æ¿ç®¡ç†æœåŠ¡ -->
      <script src="src/services/template_service.js"></script>
      <script src="src/services/template_selection_service.js"></script>
      <link rel="stylesheet" href="src/styles/template_selection.css">
      
      <!-- èŠ‚ç‚¹äº‹ä»¶å¤„ç†å™¨ - æ›¿æ¢å†…è”äº‹ä»¶ -->
      <script type="module">
        import { 
          handleNodeContentChange,
          handleNodeTitleChange,
          handleQAModeChange,
          handleProjectAuthorChange
        } from './src/services/node_service.js';
        
        // ç«‹å³æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.handleNodeContentChange = handleNodeContentChange;
        window.handleNodeTitleChange = handleNodeTitleChange;
        window.handleQAModeChange = handleQAModeChange;
        window.handleProjectAuthorChange = handleProjectAuthorChange;
        
        // ğŸ”§ èŠ‚ç‚¹äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–ï¼ˆç´§æ€¥ä¿®å¤ç¼ºå¤±å‡½æ•°ï¼‰
        function initializeNodeEventListeners() {
            
            try {
                // æ ¸å¿ƒå·¥å…·æ æŒ‰é’®äº‹ä»¶ç»‘å®š
                const buttons = [
                    'show_guide_button',
                    'export_custom_file_button', 
                    'import_file_button',
                    'create_new_mindmap_button',
                    'sync_tags_button',
                    'extensionToggleBtn',
                    'panelToggleBtn'
                ];
                
                buttons.forEach(buttonId => {
                    const btn = document.getElementById(buttonId);
                    if (btn && !btn.onclick && !btn.hasEventListener) {
                        btn.hasEventListener = true; // æ ‡è®°å·²ç»‘å®š
                    }
                });
                
                // æ ‡ç­¾é¡µæŒ‰é’®äº‹ä»¶ç»‘å®š
                const tabButtons = [
                    'tab_button_workspace',
                    'tab_button_knowledge', 
                    'tab_button_project',
                    'detail_tab_injection',
                    'detail_tab_project'
                ];
                
                tabButtons.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab && !tab.hasEventListener) {
                        tab.hasEventListener = true;
                    }
                });
                
                // å››ç»„ä»¶ç›¸å…³äº‹ä»¶åˆå§‹åŒ–
                if (window.initializeFourComponentEvents && typeof window.initializeFourComponentEvents === 'function') {
                    window.initializeFourComponentEvents();
                }
                
                // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶ç»‘å®š
                if (window.bindNodeEvents && typeof window.bindNodeEvents === 'function') {
                    window.bindNodeEvents();
                }
                
                
            } catch (error) {
                console.error('âŒ èŠ‚ç‚¹äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–å‡½æ•°
        function initModularEvents() {
          initializeNodeEventListeners();
        }
        
        // å¤šé‡åˆå§‹åŒ–ç­–ç•¥
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initModularEvents);
        } else {
          // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
          initModularEvents();
        }

        // ç®€åŒ–çš„æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function initInnerTabSwitching() {
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            const innerTabButtons = document.querySelectorAll('.inner-tab-button');
            const innerTabContents = document.querySelectorAll('.inner-tab-content');
            
            
            // åˆ—å‡ºæ‰€æœ‰æ‰¾åˆ°çš„å…ƒç´ 
            innerTabButtons.forEach((btn, i) => {
            });
            
            innerTabContents.forEach((content, i) => {
            });

            if (innerTabButtons.length === 0 || innerTabContents.length === 0) {
                console.warn('âš ï¸ [æ ‡ç­¾é¡µ] æœªæ‰¾åˆ°æ ‡ç­¾é¡µå…ƒç´ ');
                return;
            }

            // ä½¿ç”¨onclickç›´æ¥ç»‘å®šï¼Œé¿å…addEventListenerå†²çª
            innerTabButtons.forEach((button, index) => {
                const tabName = button.getAttribute('data-tab');
                
                // ç§»é™¤æ—§çš„äº‹ä»¶å¤„ç†å™¨
                button.onclick = null;
                
                // ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶
                button.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    innerTabButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // éšè—æ‰€æœ‰å†…å®¹
                    innerTabContents.forEach(content => content.classList.remove('active'));
                    
                    // æ¿€æ´»ç‚¹å‡»çš„æŒ‰é’®
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
                    const targetContent = document.getElementById(`inner-tab-${tabName}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                };
            });
            
        }

        // å•ä¸€åˆå§‹åŒ–ç­–ç•¥
        
        // ç®€åŒ–çš„äº‹ä»¶ç»‘å®šå‡½æ•°
        function bindTabEvents() {
            const buttons = document.querySelectorAll('.inner-tab-button');
            
            buttons.forEach((button) => {
                const tabName = button.getAttribute('data-tab');
                
                button.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // åˆ‡æ¢é€»è¾‘
                    buttons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.inner-tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    const targetContent = document.getElementById(`inner-tab-${tabName}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                };
            });
        }

        // åˆå§‹åŒ–ç­–ç•¥
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initInnerTabSwitching();
                bindTabEvents();
            }, 100);
        });

      </script>
      <script src="md-parser-fixed.js"></script>
      
</head>
<body>

    <div class="container">
        <div class="header">
            <!-- ä¿ç•™åŒºåŸŸå¤‡ç”¨ -->
        </div>
        
        <div class="toolbar">
            <input type="file" id="import_file_input" accept=".json,.jm,.mm" style="display: none;">
            
            <div class="toolbar-left">
                <button id="show_guide_button" class="btn btn-primary" style="background: #007bff; border: 2px solid #0056b3; font-size: 16px; font-weight: 600; padding: 12px 24px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); transition: all 0.3s ease;">
                    ğŸ“š ä½¿ç”¨æŒ‡å—
                </button>
                <button id="export_custom_file_button" class="btn btn-info">
                    ğŸ’¾ ä¿å­˜æ–‡ä»¶
                </button>
                <button id="import_file_button" class="btn btn-success">
                    ğŸ“‚ å¯¼å…¥MDæ–‡æ¡£
                </button>
                <button id="create_new_mindmap_button" class="btn btn-warning">
                    âœ¨ æ–°è„‘å›¾
                </button>
                <button id="sync_tags_button" class="btn btn-secondary">
                    ğŸ”„ æ ‡ç­¾åŒæ­¥
                </button>
                <button onclick="handleAnalyzeTagData()" class="btn btn-info">
                    ğŸ” åˆ†ææ ‡ç­¾æ•°æ®
                </button>
                <button onclick="testTagSync()" class="btn btn-info">
                    ğŸ§ª æµ‹è¯•æ ‡ç­¾
                </button>
                <button onclick="visualRepairService.triggerCheck()" class="btn btn-warning">
                    ğŸ› ï¸ ä¿®å¤æ£€æŸ¥
                </button>
                <button onclick="openMDDirectPanel()" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                    ğŸ“ MDç›´å­˜
                </button>

            </div>
            
            <div class="toolbar-right">
                <button class="btn btn-info" id="extensionToggleBtn">
                    â—€ æŠ˜å æ‰©å±•åŒº
                </button>
                <button class="btn btn-secondary" id="panelToggleBtn">
                    ğŸ“‹ éšè—è¯¦æƒ…é¢æ¿
                </button>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="mindmap-container">
                <div class="mindmap-tab-container">
                    <div class="mindmap-tab-header">
                        <button id="tab_button_workspace" class="mindmap-tab-button" data-tab="workspace">
                            ğŸ·ï¸ æ ‡ç­¾ç®¡ç†
                        </button>
                        <button id="tab_button_knowledge" class="mindmap-tab-button" data-tab="knowledge">
                            ğŸ“‹ ä¸´æ—¶å·¥ä½œåŒºB
                        </button>
                        <button id="tab_button_project" class="mindmap-tab-button active" data-tab="project">
                            ğŸš€ é¡¹ç›®ç®¡ç†
                        </button>
                    </div>
                    
                    <div id="mindmap-tab-workspace" class="mindmap-tab-content">
                        <div id="jsmind_container_workspace" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <div id="mindmap-tab-knowledge" class="mindmap-tab-content">
                        <div id="jsmind_container_knowledge" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <div id="mindmap-tab-project" class="mindmap-tab-content active">
                        <div id="jsmind_container_project" class="jsmind-tab-canvas"></div>
                    </div>
                </div>
            </div>
            
            <div class="details-panel">
                <div class="tab-container">
                    <div class="tab-header">
                        <button id="detail_tab_injection" class="tab-button active" data-tab="injection">
                            ğŸ“„ èŠ‚ç‚¹ä¿¡æ¯
                        </button>
                        <button id="detail_tab_project" class="tab-button" data-tab="project">
                            ğŸ“‹ é¡¹ç›®ä¿¡æ¯
                        </button>
                    </div>
                    
                    <div id="tab-injection" class="tab-content active">
                        <div id="injection-info-content">
                            <!-- å››ç»„ä»¶å¸ƒå±€ä¸»ä½“ -->
                            <div class="detail-workspace" id="detail-workspace">
                                <!-- æ ‡é¢˜åŒºåŸŸï¼ˆåŠ¨æ€è°ƒæ•´ï¼‰ -->
                                <div class="title-area" id="title-area">
                                    <div class="title-content">
                                        <h3 class="node-title" id="node-title">ç‚¹å‡»æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯</h3>
                                    </div>
                                </div>
                                
                                <!-- ä¸»å†…å®¹åŒºåŸŸ -->
                                <div class="main-content-area" id="main-content-area">
                                    <!-- å·¦ä¾§é¢æ¿ -->
                                    <div class="left-panel" id="left-panel">
                                        <!-- ç»„ä»¶A: å†…å®¹ç¼–è¾‘å™¨ï¼ˆèŠ‚ç‚¹è”åŠ¨ï¼‰ -->
                                        <div class="content-section" id="content-section">
                                            <div class="content-header">
                                                <div class="content-controls">
                                                    <!-- æ•´åˆçš„æ§åˆ¶æ  -->
                                                    <div class="controls-row">
                                                        <div class="toggle-group">
                                                            <label class="toggle-item">
                                                                <input type="checkbox" id="qa-mode-toggle" checked onchange="onQAModeChange()">
                                                                <span class="toggle-label">é—®ç­”æ¨¡å¼</span>
                                                            </label>
                                                            <label class="toggle-item">
                                                                <input type="checkbox" id="debug-mode-toggle" onchange="onDebugModeChange()">
                                                                <span class="toggle-label">è°ƒè¯•</span>
                                                            </label>
                                                        </div>
                                                        <div class="button-group">
                                                            <button class="btn btn-info" onclick="testDebugFunction()" title="æµ‹è¯•è°ƒè¯•åŠŸèƒ½">ğŸ§ª æµ‹è¯•</button>
                                                            <button class="btn btn-secondary" onclick="toggleFullscreen()" title="å…¨å±æ¨¡å¼">ğŸ” å…¨å±</button>
                                                            <button class="btn btn-primary" onclick="fourComponentSubmitContent()">âœ… æäº¤</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <textarea class="content-editor" id="content-editor" 
                                                      placeholder="åœ¨è¿™é‡Œç¼–è¾‘èŠ‚ç‚¹å†…å®¹..."></textarea>
                                            <div class="meta-info" id="meta-info">
                                                åˆ›å»ºæ—¶é—´: -- | ä¿®æ”¹æ—¶é—´: --
                                            </div>
                                        </div>
                                        
                                                                <!-- ç»„ä»¶B: ä¸‰æ ‡ç­¾é¡µç»„ä»¶ï¼ˆæ ‡ç­¾ç»„ä»¶ã€ä¼šè¯åˆ—è¡¨ã€æ¨¡æ¿åˆ—è¡¨ï¼‰ -->
                        <div class="tags-section" id="tags-section">
                            <!-- æ ‡ç­¾é¡µå¤´éƒ¨ -->
                            <div class="inner-tab-header">
                                <button class="inner-tab-button active" data-tab="tags" onclick="console.log('å¼€å§‹æ‰§è¡Œæ ‡ç­¾ç»„ä»¶ç‚¹å‡»'); try { if(typeof switchTabDirect === 'function') { console.log('switchTabDirectå‡½æ•°å­˜åœ¨ï¼Œå¼€å§‹è°ƒç”¨'); switchTabDirect('tags'); } else { console.error('switchTabDirectå‡½æ•°ä¸å­˜åœ¨ï¼'); } } catch(e) { console.error('æ‰§è¡ŒswitchTabDirectæ—¶å‡ºé”™:', e); }">ğŸ·ï¸ æ ‡ç­¾ç»„ä»¶</button>
                                <button class="inner-tab-button" data-tab="sessions" onclick="console.log('å¼€å§‹æ‰§è¡Œä¼šè¯åˆ—è¡¨ç‚¹å‡»'); try { if(typeof switchTabDirect === 'function') { console.log('switchTabDirectå‡½æ•°å­˜åœ¨ï¼Œå¼€å§‹è°ƒç”¨'); switchTabDirect('sessions'); } else { console.error('switchTabDirectå‡½æ•°ä¸å­˜åœ¨ï¼'); } } catch(e) { console.error('æ‰§è¡ŒswitchTabDirectæ—¶å‡ºé”™:', e); }">ğŸ“‹ ä¼šè¯åˆ—è¡¨</button>
                                <button class="inner-tab-button" data-tab="templates" onclick="console.log('å¼€å§‹æ‰§è¡Œæ¨¡æ¿åˆ—è¡¨ç‚¹å‡»'); try { if(typeof switchTabDirect === 'function') { console.log('switchTabDirectå‡½æ•°å­˜åœ¨ï¼Œå¼€å§‹è°ƒç”¨'); switchTabDirect('templates'); } else { console.error('switchTabDirectå‡½æ•°ä¸å­˜åœ¨ï¼'); } } catch(e) { console.error('æ‰§è¡ŒswitchTabDirectæ—¶å‡ºé”™:', e); }">ğŸ“„ æ¨¡æ¿åˆ—è¡¨</button>
                            </div>
                            
                            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
                            <div class="inner-tab-content-container">
                                <!-- æ ‡ç­¾ç»„ä»¶é¡µé¢ -->
                                <div id="inner-tab-tags" class="inner-tab-content active">
                                    <div class="tag-groups-container" id="tag-groups">
                                        <!-- æ ‡ç­¾ç»„ä»¶å°†åœ¨åˆå§‹åŒ–æ—¶ä»æ ‡ç­¾ç®¡ç†è„‘å›¾åŠ¨æ€åŠ è½½ -->
                                        <div class="loading-tags-state">
                                            <div class="loading-icon">ğŸ”„</div>
                                            <div class="loading-text">æ­£åœ¨ä»æ ‡ç­¾ç®¡ç†è„‘å›¾åŠ è½½æ ‡ç­¾...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ä¼šè¯åˆ—è¡¨é¡µé¢ -->
                                <div id="inner-tab-sessions" class="inner-tab-content">
                                    <div class="sessions-container">
                                        <div class="session-item">
                                            <div class="session-title">ğŸ’¬ é¡¹ç›®è®¨è®ºä¼šè¯</div>
                                            <div class="session-time">2024-01-15 14:30</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆè®¨è®º</div>
                                            <div class="session-time">2024-01-15 10:15</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">ğŸ“‹ éœ€æ±‚åˆ†æä¼šè¯</div>
                                            <div class="session-time">2024-01-14 16:45</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">ğŸ¨ UIè®¾è®¡è®¨è®º</div>
                                            <div class="session-time">2024-01-14 11:20</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">ğŸš€ åŠŸèƒ½ä¼˜åŒ–ä¼šè¯</div>
                                            <div class="session-time">2024-01-13 15:30</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">ğŸ“Š æ•°æ®åˆ†æè®¨è®º</div>
                                            <div class="session-time">2024-01-13 09:45</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æ¨¡æ¿åˆ—è¡¨é¡µé¢ -->
                                <div id="inner-tab-templates" class="inner-tab-content">
                                    <div class="templates-container">
                                        <div class="template-item">
                                            <div class="template-title">ğŸ“ ç¬”è®°æ¨¡æ¿</div>
                                            <div class="template-desc">ç”¨äºæ—¥å¸¸ç¬”è®°è®°å½•</div>
                                        </div>
                                        <div class="template-item">
                                            <div class="template-title">ğŸ’¡ æƒ³æ³•æ¨¡æ¿</div>
                                            <div class="template-desc">ç”¨äºè®°å½•åˆ›æ„æƒ³æ³•</div>
                                        </div>
                                        <div class="template-item">
                                            <div class="template-title">ğŸ“‹ ä»»åŠ¡æ¨¡æ¿</div>
                                            <div class="template-desc">ç”¨äºä»»åŠ¡ç®¡ç†</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-project" class="tab-content">
                        <div id="project-info-content">
                            <div class="basic-info-panel">
                                <h4>ğŸ“‹ é¡¹ç›®åŸºæœ¬ä¿¡æ¯</h4>
                                <div class="project-buttons">
                                    <button class="calibrate-btn" onclick="performCalibration()">æ ¡å‡†</button>
                                </div>
                                <div class="info-item">
                                    <label>é¡¹ç›®åç§°:</label>
                                    <span id="project-name-display">NodeMind æ€ç»´å¯¼å›¾</span>
                                </div>
                                <div class="info-item">
                                    <label>é¡¹ç›®è·¯å¾„:</label>
                                    <span id="project-path-display">æœªè®¾ç½®</span>
                                </div>
                                <div class="info-item">
                                    <label>ç‰ˆæœ¬:</label>
                                    <span>1.0.0</span>
                                </div>
                                <div class="info-item">
                                    <label>ä½œè€…:</label>
                                    <span>NodeMind Team</span>
                                </div>
                                <div class="info-item">
                                    <label>æè¿°:</label>
                                    <span>åŸºäºjsMindçš„æ€ç»´å¯¼å›¾åº”ç”¨</span>
                                </div>
                                <div class="calibration-info" id="calibration-info" style="display: none;">
                                    <div class="info-item">
                                        <label>åº”ç”¨åç§°:</label>
                                        <span id="app-name-display">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>çŠ¶æ€:</label>
                                        <span id="calibration-status" class="status-uncalibrated">æœªæ ¡å‡†</span>
                                    </div>
                                    <div class="info-item">
                                        <label>è¾“å…¥æ¡†åæ ‡:</label>
                                        <span id="input-coordinates">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>å±å¹•ä¿¡æ¯:</label>
                                        <span id="screen-info">-</span>
                                    </div>
                                </div>
                                <div class="command-injection-section" id="command-injection-section">
                                    <h4>ğŸ’‰ å‘½ä»¤æ³¨å…¥æµ‹è¯•æ¡†</h4>
                                    <div class="template-selection">
                                        <label>æ¨¡æ¿åœºæ™¯:</label>
                                        <select id="template-scene-select" onchange="onTemplateSceneChanged()">
                                            <option value="">é€‰æ‹©åœºæ™¯...</option>
                                            <option value="è‡ªç„¶æ¨¡å¼">è‡ªç„¶æ¨¡å¼</option>
                                            <option value="æŠ€æœ¯æ¨¡å¼">æŠ€æœ¯æ¨¡å¼</option>
                                            <option value="åˆ›æ„æ¨¡å¼">åˆ›æ„æ¨¡å¼</option>
                                        </select>
                                        <label>æ¨¡æ¿ç‰ˆæœ¬:</label>
                                        <select id="template-version-select" onchange="onTemplateVersionChanged()">
                                            <option value="">é€‰æ‹©ç‰ˆæœ¬...</option>
                                        </select>
                                    </div>
                                    <div class="injection-input-area">
                                        <label for="command-input">å‘½ä»¤å†…å®¹:</label>
                                        <textarea id="command-input" placeholder="è¯·è¾“å…¥è¦æ³¨å…¥çš„å‘½ä»¤..." rows="3"></textarea>
                                    </div>
                                    <div class="injection-buttons">
                                        <button class="inject-btn" onclick="injectCommand()" disabled>æ³¨å…¥å‘½ä»¤</button>
                                        <button class="clear-btn" onclick="clearCommandInput()">æ¸…ç©º</button>
                                        <button class="template-test-btn" onclick="testTemplate()">æµ‹è¯•æ¨¡æ¿</button>
                                    </div>
                                    <div class="injection-status" id="injection-status">
                                        <span>è¯·å…ˆå®Œæˆæ ¡å‡†æ‰èƒ½ä½¿ç”¨å‘½ä»¤æ³¨å…¥åŠŸèƒ½</span>
                                    </div>
                                    <div class="injection-log-section">
                                        <h5>ğŸ“ æ³¨å…¥æ—¥å¿— <button class="log-export-btn" onclick="exportInjectionLogs()">å¯¼å‡ºæ—¥å¿—</button></h5>
                                        <div class="log-display" id="injection-log-display">
                                            <div class="log-empty">æš‚æ— æ³¨å…¥è®°å½•</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>jsMind æœ¬åœ°ç‰ˆæœ¬å·²åŠ è½½</span>
            </div>
            <div class="status-item">
                å½“å‰ä¸»é¢˜: <span id="currentTheme">primary</span>
            </div>
            <div class="status-item">
                é€‰ä¸­èŠ‚ç‚¹: <span id="selectedNode">æ— </span>
            </div>
        </div>
    </div>

    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="context_menu_focus_node">ğŸ”¬ å•ç‹¬æ˜¾ç¤ºåˆ°ä¸´æ—¶å·¥ä½œåŒº</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context_menu_sync" style="display: none;">ğŸ”„ åŒæ­¥</div>
        <div class="context-menu-divider" id="context_menu_sync_divider" style="display: none;"></div>
        <div class="context-menu-item" id="context_menu_hide">âŒ å–æ¶ˆ</div>
    </div>

    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.js"></script>
    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.draggable-node.js"></script>
    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.screenshot.js"></script>

    <!-- ğŸš€ æ¿€æ´»æ¨¡å—åŒ–æ¶æ„ -->
            <!-- <script type="module" src="src/app.js"></script> -->
    
    <!-- 
    ä¿®æ”¹å±¥å† - æç¤ºè¯æ¨¡æ¿åŠŸèƒ½æ¢å¤ (2024)
    1. åˆ é™¤é‡å¤çš„"æç¤ºè¯æ¨¡æ¿"h4æ ‡é¢˜ï¼Œæ”¹ä¸ºå•ä¸€æŒ‰é’®å…¥å£
    2. ä¿®å¤æ¨¡æ¿ç®¡ç†å™¨ç©ºç™½é¡µé—®é¢˜ï¼Œæ·»åŠ å†…å®¹åˆå§‹åŒ–å‡½æ•°
    3. ä¿®å¤è¿”å›æŒ‰é”®ä¸ç®¡ç”¨é—®é¢˜ï¼Œæ·»åŠ å®Œæ•´äº‹ä»¶ç»‘å®š
    4. å¼•å…¥template-manager.bundle.jsæ”¯æŒå®Œæ•´æ¨¡æ¿ç®¡ç†å™¨
    5. æ·»åŠ é™çº§æœºåˆ¶ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨
    ä¿®æ”¹ä½ç½®ï¼šindex.html.2059-2069, 1110-1126, 3725-3840, 1620
    -->
    <script>
        // ç›´æ¥åˆ‡æ¢å‡½æ•°ï¼ˆæœ€ä¼˜å…ˆå®šä¹‰ï¼Œç¡®ä¿å†…è”äº‹ä»¶å¯ä»¥è°ƒç”¨ï¼‰
        window.switchTabDirect = function(tabName) {
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.inner-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.inner-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ¿€æ´»ç‚¹å‡»çš„æŒ‰é’®
            const clickedButton = document.querySelector(`.inner-tab-button[data-tab="${tabName}"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°ç›®æ ‡æŒ‰é’®:', tabName);
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
            const targetId = `inner-tab-${tabName}`;
            const targetContent = document.getElementById(targetId);
            
            if (targetContent) {
                targetContent.classList.add('active');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°ç›®æ ‡å†…å®¹:', targetId);
                // åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„inner-tab ID
                document.querySelectorAll('[id*="inner-tab"]').forEach(el => {
                });
            }
            
        };

        // ç®€åŒ–çš„æ€ç»´å¯¼å›¾åˆå§‹åŒ– - åŸºäºå·¥ä½œç‰ˆæœ¬jsmind-project.html
        
        // æ€ç»´å¯¼å›¾æ•°æ®é…ç½®
        var mindmapData = {
            workspace: {
                meta: { name: "æ ‡ç­¾ç®¡ç†", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "workspace_root",
                    topic: "ğŸ·ï¸ æ ‡ç­¾ç®¡ç†",
                    children: [
                        {
                            id: "tag_group_normal", 
                            topic: "å¸¸è§„ç»„", 
                            direction: "right",
                            children: [
                                { id: "tag_project", topic: "é¡¹ç›®", isTag: true, tagGroup: "å¸¸è§„" },
                                { id: "tag_milestone", topic: "é‡Œç¨‹ç¢‘", isTag: true, tagGroup: "å¸¸è§„" },
                                { id: "tag_completed", topic: "å®Œæˆ", isTag: true, tagGroup: "å¸¸è§„" },
                                { id: "tag_inprogress", topic: "è¿›è¡Œä¸­", isTag: true, tagGroup: "å¸¸è§„" },
                                { id: "tag_planned", topic: "è®¡åˆ’", isTag: true, tagGroup: "å¸¸è§„" }
                            ]
                        },
                        {
                            id: "tag_group_ai", 
                            topic: "AIç»„", 
                            direction: "left",
                            children: [
                                { id: "tag_memory", topic: "è®°å¿†", isTag: true, tagGroup: "AI" },
                                { id: "tag_attention", topic: "æ³¨æ„åŠ›", isTag: true, tagGroup: "AI" },
                                { id: "tag_experience", topic: "ç»éªŒ", isTag: true, tagGroup: "AI" },
                                { id: "tag_hallucination", topic: "å¹»è§‰", isTag: true, tagGroup: "AI" }
                            ]
                        },
                        {
                            id: "tag_group_notes", 
                            topic: "ç¬”è®°ç»„", 
                            direction: "left",
                            children: [
                                { id: "tag_followup", topic: "è·Ÿè¿›", isTag: true, tagGroup: "ç¬”è®°" },
                                { id: "tag_issue", topic: "è®®é¢˜", isTag: true, tagGroup: "ç¬”è®°" }
                            ]
                        }
                    ]
                }
            },
            knowledge: {
                meta: { name: "ä¸´æ—¶å·¥ä½œåŒºB", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "knowledge_root",
                    topic: "ğŸ“‹ ä¸´æ—¶å·¥ä½œåŒºB",
                    children: []
                }
            },
            project: {
                meta: { name: "é¡¹ç›®ç®¡ç†", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "project_root",
                    topic: "ğŸš€ é¡¹ç›®ç®¡ç†",
                    children: [
                        { id: "pj_1", topic: "éœ€æ±‚åˆ†æ", direction: "right" },
                        { id: "pj_2", topic: "è®¾è®¡é˜¶æ®µ", direction: "right" },
                        { id: "pj_3", topic: "å¼€å‘å®æ–½", direction: "left" },
                        { id: "pj_4", topic: "æµ‹è¯•éƒ¨ç½²", direction: "left" },
                        {
                            id: "current_template_list",
                            topic: "å½“å‰æ¨¡æ¿åˆ—è¡¨",
                            direction: "right",
                            children: [
                                { id: "tmpl_1", topic: "è‡ªç„¶æ¨¡å¼" },
                                { id: "tmpl_2", topic: "ä»£ç è‡ªæŸ¥" },
                                { id: "tmpl_3", topic: "ä¿®æ”¹ä»£ç " },
                                { id: "tmpl_4", topic: "ä¸ç”Ÿæ•ˆ" },
                                { id: "tmpl_5", topic: "æ—¥å¿—-ä¿®æ”¹ä»£ç " },
                                { id: "tmpl_6", topic: "æ–°åŠŸèƒ½" }
                            ]
                        }
                    ]
                }
            }
        };

        // åŸºç¡€é…ç½®
        var baseOptions = {
            editable: true,
            theme: 'primary',
            view: { engine: 'canvas', hmargin: 150, vmargin: 80, line_width: 2, line_color: '#566' },
            layout: { hspace: 40, vspace: 30, pspace: 15 },
            shortcut: { enable: true, handles: {}, mapping: { addchild: 4096 + 13, addbrother: 13, editnode: 113, delnode: 46, toggle: 32, left: 37, up: 38, right: 39, down: 40 } },
            default_direction: 'right'
        };

        // å…¨å±€å˜é‡
        var mindmaps = {};
        var currentMindmap = 'project';
        var selectedNodeId = null;
        var nodeDatabase = {}; // èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æ•°æ®åº“
        var lastSavedFilePath = null; // æ–‡ä»¶ä¿å­˜è·¯å¾„
        
        // é¡¹ç›®ä¿¡æ¯
        var projectInfo = {
            name: 'æœªè®¾ç½®',
            path: 'æœªè®¾ç½®',
            description: 'æœªè®¾ç½®',
            author: 'æœªè®¾ç½®',
            version: '1.0.0'
        };
        
        // å­˜å‚¨é”®åé…ç½®
        var STORAGE_KEYS = {
            MINDMAP_DATA: 'nodemind_mindmap_data',
            NODE_DATABASE: 'nodemind_node_database',
            SESSION_DATABASE: 'nodemind_session_database',
            CURRENT_THEME: 'nodemind_current_theme',
            DRAG_ENABLED: 'nodemind_drag_enabled',
            SELECTED_NODE: 'nodemind_selected_node',
            VIEW_DATA: 'nodemind_view_data',
            LAST_SAVED_PATH: 'nodemind_last_saved_path',
            PROJECT_INFO: 'nodemind_project_info',
            FOUR_COMPONENT_DATA: 'nodemind_four_component_data',
            FOUR_COMPONENT_GLOBAL_STATE: 'nodemind_four_component_global_state',
            FOUR_COMPONENT_SESSIONS: 'nodemind_four_component_sessions'
        };

        // åˆå§‹åŒ–æ€ç»´å¯¼å›¾
        function initMindmaps() {
            
            // åˆ›å»ºå·¥ä½œç©ºé—´è„‘å›¾
            mindmaps.workspace = new jsMind({ ...baseOptions, container: 'jsmind_container_workspace' });
            mindmaps.workspace.show(mindmapData.workspace);
            
            // åˆ›å»ºçŸ¥è¯†åº“è„‘å›¾
            mindmaps.knowledge = new jsMind({ ...baseOptions, container: 'jsmind_container_knowledge' });
            mindmaps.knowledge.show(mindmapData.knowledge);
            
            // åˆ›å»ºé¡¹ç›®ç®¡ç†è„‘å›¾
            mindmaps.project = new jsMind({ ...baseOptions, container: 'jsmind_container_project' });
            mindmaps.project.show(mindmapData.project);

            // å¯ç”¨æ‹–æ‹½åŠŸèƒ½
            Object.values(mindmaps).forEach((mindmap, index) => {
                try {
                    if (typeof mindmap.enable_draggable_node === 'function') {
                        mindmap.enable_draggable_node();
                    }
                } catch (dragError) {
                }
            });
            
            // *** å…³é”®ä¿®å¤ï¼šæ•°æ®èåˆ - ç¡®ä¿jsMindèŠ‚ç‚¹ä¸nodeDatabaseåŒæ­¥ ***
            syncMindmapDataWithNodeDatabase();
            
            
            // ç»‘å®šèŠ‚ç‚¹é€‰æ‹©äº‹ä»¶
            bindNodeEvents();
        }
        
        // æ•°æ®èåˆå‡½æ•°ï¼šç¡®ä¿jsMindä¸­çš„æ‰€æœ‰èŠ‚ç‚¹åœ¨nodeDatabaseä¸­éƒ½æœ‰å¯¹åº”è®°å½•
        function syncMindmapDataWithNodeDatabase() {
            
            let syncCount = 0;
            let newCount = 0;
            
            // éå†æ‰€æœ‰æ€ç»´å¯¼å›¾
            Object.keys(mindmaps).forEach(mapId => {
                const mindmap = mindmaps[mapId];
                if (mindmap) {
                    
                    // è·å–è¯¥è„‘å›¾çš„æ•°æ®
                    const mapData = mindmap.get_data();
                    if (mapData && mapData.data) {
                        // é€’å½’éå†æ‰€æœ‰èŠ‚ç‚¹
                        traverseAndSyncNode(mapData.data);
                    }
                }
            });
            
            // éå†èŠ‚ç‚¹å¹¶åŒæ­¥åˆ°nodeDatabase
            function traverseAndSyncNode(nodeData) {
                if (!nodeData || !nodeData.id) return;
                
                const nodeId = nodeData.id;
                const cleanTitle = nodeData.topic ? nodeData.topic.replace(' ğŸ“„', '') : 'æœªå‘½åèŠ‚ç‚¹';
                
                // æ£€æŸ¥nodeDatabaseä¸­æ˜¯å¦å­˜åœ¨è¯¥èŠ‚ç‚¹
                if (!nodeDatabase[nodeId]) {
                    // åˆ›å»ºæ–°çš„èŠ‚ç‚¹è®°å½•
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: cleanTitle,
                        content: '',
                        sessions: [], // æ–°å¢ä¼šè¯æ•°æ®
                        author: projectInfo.author || 'NodeMind',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        tags: { categories: [], technical: [], status: [] }
                    };
                    newCount++;
                } else {
                    // ç¡®ä¿ç°æœ‰èŠ‚ç‚¹æ•°æ®ç»“æ„å®Œæ•´
                    const existingNode = nodeDatabase[nodeId];
                    
                    // æ›´æ–°æ ‡é¢˜ï¼ˆå¦‚æœèŠ‚ç‚¹æ ‡é¢˜åœ¨è„‘å›¾ä¸­è¢«ä¿®æ”¹ï¼‰
                    if (existingNode.title !== cleanTitle) {
                        existingNode.title = cleanTitle;
                        existingNode.modified = new Date().toISOString();
                    }
                    
                    // ç¡®ä¿å¿…è¦å­—æ®µå­˜åœ¨
                    if (!existingNode.sessions) existingNode.sessions = [];
                    if (!existingNode.tags) existingNode.tags = { categories: [], technical: [], status: [] };
                    if (!existingNode.author) existingNode.author = projectInfo.author || 'NodeMind';
                    if (!existingNode.created) existingNode.created = new Date().toISOString();
                    if (!existingNode.modified) existingNode.modified = new Date().toISOString();
                    
                    syncCount++;
                }
                
                // é€’å½’å¤„ç†å­èŠ‚ç‚¹
                if (nodeData.children && Array.isArray(nodeData.children)) {
                    nodeData.children.forEach(childNode => {
                        traverseAndSyncNode(childNode);
                    });
                }
            }
            
            
            // ä¿å­˜èåˆåçš„æ•°æ®
            setTimeout(autoSaveData, 100);
        }
        
        // ç»‘å®šèŠ‚ç‚¹äº‹ä»¶
        function bindNodeEvents() {
            
            Object.keys(mindmaps).forEach(mapId => {
                const mindmap = mindmaps[mapId];
                if (mindmap) {
                    // ç»‘å®šèŠ‚ç‚¹é€‰æ‹©äº‹ä»¶  
                    mindmap.add_event_listener(function(type, data) {
                        // å…¼å®¹ä¸åŒç‰ˆæœ¬çš„äº‹ä»¶ç±»å‹
                        if (type === 'select' || type === 1 || (jsMind.event_type && type === jsMind.event_type.select)) {
                            handleNodeSelect(data.node, mapId);
                        } else if (type === 'edit' || type === 2 || (jsMind.event_type && type === jsMind.event_type.edit)) {
                            handleNodeEdit(data.node, mapId);
                        }
                    });
                } else {
                }
            });
            
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ç»‘å®š DOM ç‚¹å‡»äº‹ä»¶
            setTimeout(() => {
                const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.addEventListener('click', function(e) {
                            
                            // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„èŠ‚ç‚¹ï¼ˆæ”¯æŒå¤šç§èŠ‚ç‚¹å…ƒç´ ï¼‰
                            let nodeElement = e.target.closest('jmnode');
                            if (!nodeElement) {
                                nodeElement = e.target.closest('[nodeid]');
                            }
                            if (!nodeElement && e.target.hasAttribute('nodeid')) {
                                nodeElement = e.target;
                            }
                            
                            if (nodeElement) {
                                const nodeId = nodeElement.getAttribute('nodeid');
                                const mapId = containerId.replace('jsmind_container_', '');
                                const mindmap = mindmaps[mapId];
                                
                                
                                if (mindmap && nodeId) {
                                    const node = mindmap.get_node(nodeId);
                                    if (node) {
                                        handleNodeSelect(node, mapId);
                                    } else {
                                    }
                                } else {
                                }
                            } else {
                            }
                        });
                    } else {
                    }
                });
                
                // é¢å¤–çš„å…¨å±€ç‚¹å‡»ç›‘å¬å™¨
                document.addEventListener('click', function(e) {
                    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†jsmindèŠ‚ç‚¹
                    if (e.target.tagName === 'jmnode' || e.target.closest('jmnode')) {
                        
                        let nodeElement = e.target.tagName === 'jmnode' ? e.target : e.target.closest('jmnode');
                        const nodeId = nodeElement.getAttribute('nodeid');
                        
                        if (nodeId) {
                            
                            // æŸ¥æ‰¾å¯¹åº”çš„æ€ç»´å¯¼å›¾
                            let mapId = null;
                            const containers = ['workspace', 'knowledge', 'project'];
                            
                            for (const containerId of containers) {
                                const container = document.getElementById(`jsmind_container_${containerId}`);
                                if (container && container.contains(nodeElement)) {
                                    mapId = containerId;
                                    break;
                                }
                            }
                            
                            if (mapId && mindmaps[mapId]) {
                                const node = mindmaps[mapId].get_node(nodeId);
                                if (node) {
                                    handleNodeSelect(node, mapId);
                                }
                            }
                        }
                    }
                });
                
            }, 1000);
        }
        
        // å¤„ç†èŠ‚ç‚¹é€‰æ‹©
        function handleNodeSelect(node, mapId) {
            if (!node) {
                return;
            }
            
            
            // è®¾ç½®å…¨å±€å˜é‡
            selectedNodeId = node.id;
            currentMindmap = mapId;
            
            // ç¡®ä¿å…¨å±€å˜é‡è¢«æ­£ç¡®è®¾ç½®
            window.selectedNodeId = node.id;
            window.currentMindmap = mapId;
            
            
            // æ·»åŠ è§†è§‰åé¦ˆï¼šé«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„èŠ‚ç‚¹
            try {
                highlightSelectedNode(node.id, mapId);
            } catch (error) {
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusElement = document.getElementById('selectedNode');
            if (statusElement) {
                statusElement.textContent = node.topic || 'æ— ';
            }
            
            // === ä¼šè¯ç³»ç»Ÿé›†æˆ ===
            // æ›´æ–°ä¼šè¯åˆ—è¡¨æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹çš„ä¼šè¯
            try {
                updateSessionsList(node.id);
            } catch (error) {
            }
            
            // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
            try {
                showNodeDetails(node);
            } catch (error) {
            }
            
        }
        
        // é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„èŠ‚ç‚¹ï¼ˆç®€åŒ–ç‰ˆï¼Œæ— åŠ¨ç”»ï¼‰
        function highlightSelectedNode(nodeId, mapId) {
            // ç§»é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.jmnode-selected').forEach(el => {
                el.classList.remove('jmnode-selected');
            });
            
            // é«˜äº®å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹ï¼ˆä»…é™æ€é«˜äº®ï¼Œæ— åŠ¨ç”»ï¼‰
            const container = document.getElementById(`jsmind_container_${mapId}`);
            if (container) {
                const nodeElement = container.querySelector(`jmnode[nodeid="${nodeId}"]`);
                if (nodeElement) {
                    nodeElement.classList.add('jmnode-selected');
                }
            }
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹é€‰æ‹©åé¦ˆåŠ¨ç”»ï¼ˆå·²ç¦ç”¨ï¼‰
        function showNodeSelectionFeedback(node) {
            // åŠŸèƒ½å·²ç¦ç”¨ - ä¸æ˜¾ç¤ºèŠ‚ç‚¹é€‰æ‹©åé¦ˆåŠ¨ç”»
            return;
        }
        
        // ç®€åŒ–çš„èŠ‚ç‚¹ç¼–è¾‘å¤„ç† - ä½¿ç”¨MDç›´å­˜é€»è¾‘
        async function handleNodeEdit(node, mapId) {
            if (!node) return;
            
            
            // è·å–çº¯å‡€çš„æ ‡é¢˜
            const cleanTitle = node.topic.replace(' ğŸ“„', '');
            
            // ç«‹å³æ›´æ–°nodeDatabaseï¼ˆç¡®ä¿æ•°æ®æŒä¹…åŒ–ï¼‰
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            } else {
                nodeDatabase[node.id].title = cleanTitle;
                nodeDatabase[node.id].modified = new Date().toISOString();
            }
            
            // åŒæ­¥æ›´æ–°å››ç»„ä»¶æ•°æ®
            if (!fourComponentNodeState.nodeData[node.id]) {
                fourComponentNodeState.nodeData[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: nodeDatabase[node.id].content || '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            } else {
                fourComponentNodeState.nodeData[node.id].title = cleanTitle;
                fourComponentNodeState.nodeData[node.id].updateTime = new Date().toLocaleString('zh-CN');
            }
            
            // ç«‹å³ä¿å­˜åˆ°localStorage
            saveFourComponentData();
            autoSaveData();
            
            // ä½¿ç”¨MDç›´å­˜æœåŠ¡çš„ç®€æ´é€»è¾‘ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
            try {
                const service = await initMDDirectService();
                
                // æ„é€ MDæ ¼å¼å†…å®¹
                const existingData = nodeDatabase[node.id];
                const mdContent = `# ${cleanTitle}\n\n${existingData?.content || ''}`;
                
                // ä½¿ç”¨MDç›´å­˜é€»è¾‘æ›´æ–°
                const result = await service.addMDContent(mdContent, {
                    nodeId: node.id,
                    updateExisting: true
                });
                
                if (result.success) {
                }
            } catch (error) {
                console.error('âŒ MDç›´å­˜åŒæ­¥å¤±è´¥:', error);
                // æ•°æ®å·²ç»ä¿å­˜åˆ°nodeDatabaseï¼Œä¸å½±å“æŒä¹…åŒ–
            }
            
            // å¦‚æœå½“å‰æ­£åœ¨æ˜¾ç¤ºè¯¥èŠ‚ç‚¹ï¼Œåˆ·æ–°æ˜¾ç¤º
            if (selectedNodeId === node.id || fourComponentNodeState.currentNode === node.id) {
                updateFourComponentsForNode(node.id);
            }
            
            // å…³é”®ä¿®å¤ï¼šç«‹å³æ›´æ–°æ€ç»´å¯¼å›¾æ˜¾ç¤º
            const mindmap = mindmaps[mapId];
            if (mindmap) {
                // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æœ‰å†…å®¹ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºå†…å®¹å›¾æ ‡
                const hasContent = nodeDatabase[node.id].content && nodeDatabase[node.id].content.trim().length > 0;
                const displayTitle = hasContent ? `${cleanTitle} ğŸ“„` : cleanTitle;
                
                // æ›´æ–°æ€ç»´å¯¼å›¾ä¸­çš„èŠ‚ç‚¹æ˜¾ç¤º
                mindmap.update_node(node.id, displayTitle);
            }
        }
        
        // ç®€åŒ–çš„èŠ‚ç‚¹è¯¦æƒ…æ˜¾ç¤º - ä½¿ç”¨MDç›´å­˜é€»è¾‘
        async function showNodeDetails(node) {
            if (!node) {
                return;
            }
            
            
            // ç®€åŒ–çš„å½“å‰å†…å®¹ä¿å­˜ - ä½¿ç”¨MDç›´å­˜é€»è¾‘
            const currentNodeId = fourComponentNodeState.currentNode;
            if (currentNodeId && currentNodeId !== node.id) {
                await saveCurrentNodeContentViaMD(currentNodeId);
            }
            
            // è·å–çº¯å‡€çš„æ ‡é¢˜
            const cleanTitle = node.topic.replace(' ğŸ“„', '');
            
            // ç¡®ä¿èŠ‚ç‚¹æ•°æ®å­˜åœ¨ï¼ˆä½¿ç”¨ç®€åŒ–é€»è¾‘ï¼‰
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            } else {
                // åŒæ­¥æ ‡é¢˜
                nodeDatabase[node.id].title = cleanTitle;
            }
            
            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šè®¾ç½®å½“å‰èŠ‚ç‚¹ID
            fourComponentNodeState.currentNode = node.id;
            
            // åˆ‡æ¢åˆ°èŠ‚ç‚¹ä¿¡æ¯æ ‡ç­¾é¡µ
            switchToDetailTab();
            
            // æ›´æ–°å››ç»„ä»¶æ˜¾ç¤º
            updateFourComponentsForNode(node.id);
        }
        
        // ç¬¬ä¸‰æ¬¡é‡æ„ï¼šç®€åŒ–èŠ‚ç‚¹å†…å®¹ä¿å­˜
        async function saveCurrentNodeContentViaMD(nodeId) {
            if (!nodeId) return;
            
            
            try {
                const contentEditor = document.getElementById('content-editor');
                
                if (contentEditor && nodeDatabase[nodeId]) {
                    nodeDatabase[nodeId].content = contentEditor.value || '';
                    nodeDatabase[nodeId].modified = new Date().toISOString();
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('nodemind_node_database', JSON.stringify(nodeDatabase));
                    
                }
            } catch (error) {
                console.error('âŒ [ç¬¬ä¸‰æ¬¡é‡æ„] èŠ‚ç‚¹ä¿å­˜å¤±è´¥:', error);
            }
        }
        
        // æ¸…ç†å…¶ä»–æ ‡ç­¾é¡µçš„å†…å®¹ï¼Œé˜²æ­¢å†…å®¹æ··æ·†
        function clearOtherTabContents() {
            // ä¸å†é‡ç½®injectionå†…å®¹ï¼Œå› ä¸ºå®ƒç°åœ¨æ˜¯èŠ‚ç‚¹ä¿¡æ¯é¡µé¢
            
            // é‡ç½®é¡¹ç›®ä¿¡æ¯æ ‡ç­¾é¡µå†…å®¹ï¼ˆä¿æŒæ ¡å‡†åŠŸèƒ½ï¼‰
            const projectContent = document.getElementById('project-info-content');
            if (projectContent) {
                projectContent.innerHTML = `
                    <div class="basic-info-panel">
                        <h4>ğŸ“‹ é¡¹ç›®åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="project-buttons">
                            <button class="calibrate-btn" onclick="performCalibration()">æ ¡å‡†</button>
                        </div>
                        <div class="info-item">
                            <label>é¡¹ç›®åç§°:</label>
                            <span id="project-name-display">NodeMind æ€ç»´å¯¼å›¾</span>
                        </div>
                        <div class="info-item">
                            <label>é¡¹ç›®è·¯å¾„:</label>
                            <span id="project-path-display">æœªè®¾ç½®</span>
                        </div>
                        <div class="info-item">
                            <label>ç‰ˆæœ¬:</label>
                            <span>1.0.0</span>
                        </div>
                        <div class="info-item">
                            <label>ä½œè€…:</label>
                            <span>NodeMind Team</span>
                        </div>
                        <div class="info-item">
                            <label>æè¿°:</label>
                            <span>åŸºäºjsMindçš„æ€ç»´å¯¼å›¾åº”ç”¨</span>
                        </div>
                        <div class="calibration-info" id="calibration-info" style="display: none;">
                            <div class="info-item">
                                <label>åº”ç”¨åç§°:</label>
                                <span id="app-name-display">-</span>
                            </div>
                            <div class="info-item">
                                <label>çŠ¶æ€:</label>
                                <span id="calibration-status" class="status-uncalibrated">æœªæ ¡å‡†</span>
                            </div>
                            <div class="info-item">
                                <label>è¾“å…¥æ¡†åæ ‡:</label>
                                <span id="input-coordinates">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="node-info-panel">
                        <h4>ğŸ“ å½“å‰èŠ‚ç‚¹ä¿¡æ¯</h4>
                        <div class="info-item">
                            <label>èŠ‚ç‚¹ä½œè€…:</label>
                            <input type="text" id="project-node-author" class="meta-input" 
                                   value="" placeholder="è¾“å…¥ä½œè€…ä¿¡æ¯">
                        </div>
                    </div>
                `;
                // é‡æ–°åˆå§‹åŒ–é¡¹ç›®ä¿¡æ¯
                initProjectInfo();
            }
        }
        
        // åˆ‡æ¢åˆ°èŠ‚ç‚¹ä¿¡æ¯æ ‡ç­¾é¡µ
        function switchToDetailTab() {
            switchDetailTab('injection');
        }
        
        // åˆ‡æ¢è¯¦æƒ…é¢æ¿æ ‡ç­¾é¡µï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼Œæ·»åŠ æ›´ä¸¥æ ¼çš„æ£€æŸ¥å’ŒåŠ¨ç”»æ•ˆæœï¼‰
        function switchDetailTab(tabId) {
            
            // ç§»é™¤äº†åˆ‡æ¢åŠ¨ç”»æç¤º
            
            // ç§»é™¤æ‰€æœ‰è¯¦æƒ…é¢æ¿æ ‡ç­¾é¡µçš„activeçŠ¶æ€
            document.querySelectorAll('.details-panel .tab-button').forEach(btn => {
                btn.classList.remove('active');
                // ç§»é™¤ä¹‹å‰çš„é«˜äº®æ•ˆæœ
                btn.style.transform = '';
                btn.style.boxShadow = '';
            });
            
            document.querySelectorAll('.details-panel .tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none'; // å¼ºåˆ¶éšè—
            });
            
            // æ¿€æ´»æŒ‡å®šçš„æ ‡ç­¾é¡µ
            const tabButton = document.getElementById(`detail_tab_${tabId}`);
            const tabContent = document.getElementById(`tab-${tabId}`);
            
            if (tabButton && tabContent) {
                tabButton.classList.add('active');
                tabContent.classList.add('active');
                tabContent.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤º
                
                // ç§»é™¤äº†æŒ‰é’®é—ªçƒæ•ˆæœ
                
                
                // ç¡®ä¿åˆ‡æ¢åå†…å®¹æ­£ç¡®æ˜¾ç¤º
                setTimeout(() => {
                    // æ¸…ç†ä»»ä½•å¯èƒ½æ®‹ç•™çš„è¡¨å•å†…å®¹
                    clearNodeFormFromTab(tabContent);
                    
                    // å¦‚æœæ˜¯èŠ‚ç‚¹ä¿¡æ¯æ ‡ç­¾é¡µï¼Œç¡®ä¿å››ç»„ä»¶æ­£ç¡®åˆå§‹åŒ–
                    if (tabId === 'injection') {
                        initializeFourComponents();
                        
                        // å¦‚æœæœ‰å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹ï¼Œç«‹å³æ›´æ–°
                        if (selectedNodeId) {
                            updateFourComponentsForNode(selectedNodeId);
                        }
                    }
                }, 100);
            } else {
            }
        }
        
        // æ˜¾ç¤ºæ ‡ç­¾é¡µåˆ‡æ¢åé¦ˆï¼ˆå·²ç¦ç”¨ï¼‰
        function showTabSwitchFeedback(tabId) {
            // åŠŸèƒ½å·²ç¦ç”¨ - ä¸æ˜¾ç¤ºæ ‡ç­¾é¡µåˆ‡æ¢åé¦ˆ
            return;
        }
        
        // ä»æŒ‡å®šæ ‡ç­¾é¡µæ¸…ç†èŠ‚ç‚¹è¡¨å•å†…å®¹ï¼ˆé˜²æ­¢å†…å®¹æ³„éœ²åˆ°å…¶ä»–æ ‡ç­¾é¡µï¼‰
        function clearNodeFormFromTab(tabElement) {
            if (!tabElement) return;
            
            const forms = tabElement.querySelectorAll('.node-detail-form');
            forms.forEach(form => {
                if (tabElement.id !== 'tab-injection') {
                    // å¦‚æœä¸æ˜¯èŠ‚ç‚¹ä¿¡æ¯æ ‡ç­¾é¡µï¼Œç§»é™¤ä»»ä½•èŠ‚ç‚¹è¡¨å•
                    form.remove();
                }
            });
        }
        
        // æ›´æ–°èŠ‚ç‚¹æ ‡é¢˜
        function updateNodeTitle(nodeId, title) {
            if (nodeDatabase[nodeId]) {
                nodeDatabase[nodeId].title = title;
                nodeDatabase[nodeId].modified = new Date().toISOString();
                
                // åŒæ­¥æ›´æ–°æ€ç»´å¯¼å›¾æ˜¾ç¤º
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const node = currentMindmapInstance.get_node(nodeId);
                    if (node) {
                        // ä¿æŒå†…å®¹å›¾æ ‡
                        const hasContent = nodeDatabase[nodeId].content && nodeDatabase[nodeId].content.trim().length > 0;
                        const displayTitle = hasContent ? `${title} ğŸ“„` : title;
                        currentMindmapInstance.update_node(nodeId, displayTitle);
                    }
                }
                
                // *** æ·»åŠ è‡ªåŠ¨ä¿å­˜ ***
                setTimeout(autoSaveData, 200);
            }
        }
        
        // æ›´æ–°èŠ‚ç‚¹å†…å®¹
        function updateNodeContent(nodeId, content) {
            
            // ç¡®ä¿èŠ‚ç‚¹æ•°æ®å­˜åœ¨
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: 'æœªå‘½åèŠ‚ç‚¹',
                    content: '',
                    sessions: [],
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            // æ›´æ–°èŠ‚ç‚¹å†…å®¹
            nodeDatabase[nodeId].content = content || '';
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            // è§£æå†…å®¹æ›´æ–°ä¼šè¯æ•°æ®
            parseContentToSessions(nodeId, content);
            
            // æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤ºå›¾æ ‡
            updateNodeContentIcon(nodeId, content);
            
            // è§¦å‘è‡ªåŠ¨ä¿å­˜
            setTimeout(autoSaveData, 200);
            
        }
        
        // ä»å®Œæ•´MDå†…å®¹è§£æå›ä¼šè¯æ•°æ®
        function parseContentToSessions(nodeId, content) {
            initializeNodeSessions(nodeId);
            
            // *** ä¿®å¤ä¼šè¯è¢«æ„å¤–æ¸…é™¤çš„BUG ***
            if (!content || content.trim() === '') {
                // ğŸ”’ ä¿æŠ¤ç°æœ‰ä¼šè¯ï¼šå†…å®¹ä¸ºç©ºæ—¶ä¸è‡ªåŠ¨æ¸…ç©ºä¼šè¯
                // åªæœ‰åœ¨æ˜ç¡®çš„åˆ é™¤æ“ä½œæ—¶æ‰æ¸…ç©ºï¼Œè€Œä¸æ˜¯å› ä¸ºå†…å®¹ä¸´æ—¶ä¸ºç©º
                
                // å¦‚æœæ²¡æœ‰ä»»ä½•ä¼šè¯ï¼Œå°±ä¸éœ€è¦åšä»»ä½•å¤„ç†
                if (sessionDatabase[nodeId].sessions.length === 0) {
                    return;
                }
                
                // ä¿ç•™ç°æœ‰ä¼šè¯ï¼Œåªé‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆä¸æ¸…ç©ºæ•°æ®ï¼‰
                const sessionListContainer = document.getElementById(`session-list-${nodeId}`);
                if (sessionListContainer) {
                    renderSessionList(nodeId);
                }
                
                return;
            }
            
            // æŒ‰æ ‡é¢˜åˆ†å‰²å†…å®¹
            const sections = content.split(/^# /m).filter(section => section.trim());
            const sessions = [];
            
            sections.forEach((section, index) => {
                const lines = section.trim().split('\n');
                const title = lines[0].trim();
                const sessionContent = lines.slice(1).join('\n').trim();
                
                // æŸ¥æ‰¾ç°æœ‰ä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯
                let existingSession = sessionDatabase[nodeId].sessions.find(s => s.title === title);
                
                if (existingSession) {
                    // æ›´æ–°ç°æœ‰ä¼šè¯
                    existingSession.content = sessionContent;
                    existingSession.lastModified = new Date().toISOString();
                    sessions.push(existingSession);
                } else {
                    // åˆ›å»ºæ–°ä¼šè¯
                    const newSession = {
                        id: `session-${nodeId}-${Date.now()}-${index}`,
                        title: title,
                        content: sessionContent,
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };
                    sessions.push(newSession);
                }
            });
            
            // æ›´æ–°ä¼šè¯æ•°æ®
            sessionDatabase[nodeId].sessions = sessions;
            
            // é‡æ–°æ¸²æŸ“ä¼šè¯åˆ—è¡¨
            const sessionListContainer = document.getElementById(`session-list-${nodeId}`);
            if (sessionListContainer) {
                renderSessionList(nodeId);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveSessionData();
        }
        
        // æ›´æ–°èŠ‚ç‚¹ä½œè€…
        function updateNodeAuthor(nodeId, author) {
            if (nodeDatabase[nodeId]) {
                nodeDatabase[nodeId].author = author;
                nodeDatabase[nodeId].modified = new Date().toISOString();
            }
        }
        
        // æ›´æ–°èŠ‚ç‚¹å†…å®¹å›¾æ ‡
        function updateNodeContentIcon(nodeId, content) {
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                const node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    const hasContent = content && content.trim().length > 0;
                    const originalTopic = nodeDatabase[nodeId].title || node.topic;
                    const newTopic = hasContent ? `${originalTopic} ğŸ“„` : originalTopic.replace(' ğŸ“„', '');
                    
                    if (node.topic !== newTopic) {
                        currentMindmapInstance.update_node(nodeId, newTopic);
                    }
                }
            }
        }
        
        // ä¿å­˜èŠ‚ç‚¹è¯¦æƒ…
        function saveNodeDetails(nodeId) {
            autoSaveData();
            showMessage('ğŸ’¾ èŠ‚ç‚¹è¯¦æƒ…å·²ä¿å­˜', 1500);
        }
        
        // æäº¤å†…å®¹ï¼ˆæ ¹æ®é—®ç­”æ¨¡å¼å†³å®šï¼šå‘½ä»¤æ³¨å…¥ OR ç¬”è®°ä¿å­˜ï¼‰
        async function submitContent(nodeId) {
            
            // è·å–å†…å®¹ç¼–è¾‘å™¨
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('âŒ æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            
            // è·å–èŠ‚ç‚¹ä¿¡æ¯
            const nodeData = nodeDatabase[nodeId] || {};
            const nodeTitle = (nodeData.title || `èŠ‚ç‚¹${nodeId}`).trim();
            
            // ğŸ”‘ æ£€æŸ¥é—®ç­”æ¨¡å¼çŠ¶æ€
            const qaToggle = document.getElementById('qa-mode-toggle');
            const isQAMode = qaToggle && qaToggle.checked;
            
            
            if (!isQAMode) {
                // ğŸ“ éé—®ç­”æ¨¡å¼ï¼šæ‰§è¡Œç¬”è®°ä¿å­˜
                
                if (!nodeTitle && !content) {
                    showMessage('âŒ è¯·å…ˆè¾“å…¥æ ‡é¢˜æˆ–å†…å®¹', 2000, 'error');
                    return;
                }
                
                // ä¿å­˜èŠ‚ç‚¹æ•°æ®
                autoSaveData();
                
                // åœ¨å†…å®¹æœ«å°¾æ·»åŠ ä¿å­˜æ—¶é—´æˆ³
                if (content && !content.includes('[å·²ä¿å­˜]')) {
                    const timestamp = new Date().toLocaleString();
                    const newContent = content + `\n[å·²ä¿å­˜ ${timestamp}]`;
                    contentEditor.value = newContent;
                    
                    // ä¿å­˜åˆ°nodeDatabase
                    if (nodeDatabase[nodeId]) {
                        nodeDatabase[nodeId].content = newContent;
                    }
                    
                }
                
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæ¶ˆæ¯
                showMessage('ğŸ’¾ ç¬”è®°å·²ä¿å­˜', 2000, 'success');
                
                // è®°å½•æ—¥å¿—
                const logEntry = `${new Date().toLocaleString()} - èŠ‚ç‚¹ "${nodeTitle}" ç¬”è®°å·²ä¿å­˜`;
                
                return; // ğŸ“ ç¬”è®°æ¨¡å¼åˆ°æ­¤ç»“æŸï¼Œä¸æ‰§è¡Œæ³¨å…¥
            }
            
            // ğŸ¤– é—®ç­”æ¨¡å¼ï¼šæ‰§è¡Œå‘½ä»¤æ³¨å…¥æµç¨‹
            
            // æ„å»ºæ³¨å…¥å†…å®¹ï¼ˆæ ‡é¢˜+å†…å®¹æ ¼å¼ï¼‰
            let injectionContent = '';
            
            if (nodeTitle && content) {
                // éƒ½å­˜åœ¨ï¼šä½¿ç”¨ "- æ ‡é¢˜\n- å†…å®¹" æ ¼å¼
                injectionContent = `- ${nodeTitle}\n- ${content}`;
            } else if (nodeTitle) {
                // åªæœ‰æ ‡é¢˜ï¼šç›´æ¥ä½¿ç”¨æ ‡é¢˜
                injectionContent = nodeTitle;
            } else if (content) {
                // åªæœ‰å†…å®¹ï¼šç›´æ¥ä½¿ç”¨å†…å®¹
                injectionContent = content;
            } else {
                // éƒ½æ²¡æœ‰ï¼šæç¤ºé”™è¯¯
                showMessage('âŒ è¯·å…ˆè¾“å…¥æ ‡é¢˜æˆ–å†…å®¹', 2000, 'error');
                return;
            }
            
            try {
                // è·å–æäº¤æŒ‰é’®å¹¶ç«‹å³æ›´æ–°çŠ¶æ€
                const submitButton = document.querySelector(`button[onclick="submitContent('${nodeId}')"]`);
                const originalText = submitButton ? submitButton.textContent : '';
                
                if (submitButton) {
                    submitButton.textContent = 'â³ å‡†å¤‡æ³¨å…¥...';
                    submitButton.disabled = true;
                }

                // æ˜¾ç¤ºå‡†å¤‡æ³¨å…¥çš„æç¤º
                showMessage('ğŸ¯ å‡†å¤‡æ³¨å…¥ä¸­ï¼Œæ­£åœ¨è®©å‡ºçª—å£ç„¦ç‚¹...', 2000, 'warning');
                
                // å»¶è¿Ÿ500msåè®©æµè§ˆå™¨å¤±å»ç„¦ç‚¹
                setTimeout(() => {
                    try {
                        // è®©å½“å‰çª—å£å¤±å»ç„¦ç‚¹ï¼Œä¸ºinjectionå·¥å…·è®©è·¯
                        window.blur();
                    } catch (e) {
                    }
                }, 500);

                // å»¶è¿Ÿ1.5ç§’åæ‰§è¡Œæ³¨å…¥åè®®
                setTimeout(async () => {
                    try {
                        // åˆ›å»ºä¸€é”®æ³¨å…¥çš„JSONåè®®
                const injectionData = {
                    source: 'nodemind',
                    type: 'content-injection',
                    content: injectionContent,
                    direct_inject: true,  // å…³é”®ï¼šæ ‡è¯†ä¸ºç›´æ¥æ³¨å…¥
                    timestamp: new Date().toISOString(),
                    nodeId: nodeId,
                    nodeTitle: nodeTitle,
                    projectName: 'NodeMind'
                };

                // æ„å»ºå®Œæ•´çš„å‰ªè´´æ¿å†…å®¹
                const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                        // å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè§¦å‘injectionå·¥å…·
                await navigator.clipboard.writeText(clipboardContent);

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showMessage('ğŸ¯ ä¸€é”®æ³¨å…¥å·²è§¦å‘ï¼injectionå·¥å…·æ­£åœ¨è‡ªåŠ¨æ‰§è¡Œ...', 3000, 'success');
                
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                if (submitButton) {
                    submitButton.textContent = 'âœ… æ³¨å…¥å·²è§¦å‘';
                    
                            // 3ç§’åæ¢å¤æŒ‰é’®
                    setTimeout(() => {
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                            }, 3000);
                }

                // åœ¨å†…å®¹æœ«å°¾æ·»åŠ [å·²æ³¨å…¥]æ ‡ç­¾
                if (content && !content.includes('[å·²æ³¨å…¥]')) {
                    const newContent = content + '\n[å·²æ³¨å…¥]';
                    contentEditor.value = newContent;
                    
                    // ä¿å­˜åˆ°nodeDatabase
                    if (nodeDatabase[nodeId]) {
                        nodeDatabase[nodeId].content = newContent;
                    }
                    
                }

                
                // è®°å½•åˆ°æ—¥å¿—
                const logEntry = `${new Date().toLocaleString()} - èŠ‚ç‚¹ "${nodeTitle}" æ ‡é¢˜+å†…å®¹å·²æ³¨å…¥åˆ°Cursor`;

                    } catch (innerError) {
                        console.error('å»¶è¿Ÿæ³¨å…¥å¤±è´¥:', innerError);
                        showMessage('âŒ å»¶è¿Ÿæ³¨å…¥å¤±è´¥ï¼š' + innerError.message, 3000, 'error');
                        
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        if (submitButton) {
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                        }
                    }
                }, 1500); // å»¶è¿Ÿ1.5ç§’æ‰§è¡Œ

            } catch (error) {
                console.error('ä¸€é”®æ³¨å…¥å¤±è´¥:', error);
                showMessage('âŒ ä¸€é”®æ³¨å…¥å¤±è´¥ï¼š' + error.message, 3000, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const submitButton = document.querySelector(`button[onclick="submitContent('${nodeId}')"]`);
                if (submitButton) {
                    submitButton.textContent = submitButton.textContent.includes('â³') ? 'æäº¤' : submitButton.textContent;
                    submitButton.disabled = false;
                }
            }
        }
        
        // åˆ‡æ¢é—®ç­”æ¨¡å¼
        function toggleQAMode(nodeId, isQAMode) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            const templateSection = document.getElementById(`template-section-${nodeId}`);
            
            if (!contentEditor) {
                console.error('æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨');
                return;
            }
            
            if (isQAMode) {
                // å¼€å¯é—®ç­”æ¨¡å¼
                contentEditor.placeholder = "AIäº¤äº’ï¼ŒæŒ‡ä»¤ï¼Œæé—®ï¼Œæç¤ºè¯è¾“å…¥åŒºã€‚ä¸€æ¬¡é—®ç­”æˆ–è€…æŒ‡ä»¤-å›å¤ï¼Œç®—æ˜¯ä¸€";
                contentEditor.style.color = "#6c757d";
                contentEditor.style.fontStyle = "italic";
                
                // æ¿€æ´»æç¤ºè¯æ¨¡æ¿
                if (templateSection) {
                    templateSection.style.opacity = "1";
                    templateSection.style.pointerEvents = "auto";
                    const templateItems = templateSection.querySelectorAll('.template-item');
                    templateItems.forEach(item => {
                        item.style.cursor = "pointer";
                        item.style.opacity = "1";
                    });
                }
                
                showMessage('ğŸ¤– é—®ç­”æ¨¡å¼å·²å¼€å¯', 1500, 'success');
            } else {
                // å…³é—­é—®ç­”æ¨¡å¼
                contentEditor.placeholder = "åœ¨æ­¤è¾“å…¥è¯¦ç»†å†…å®¹...";
                contentEditor.style.color = "";
                contentEditor.style.fontStyle = "";
                
                // ç¦ç”¨æç¤ºè¯æ¨¡æ¿
                if (templateSection) {
                    templateSection.style.opacity = "0.5";
                    templateSection.style.pointerEvents = "none";
                    const templateItems = templateSection.querySelectorAll('.template-item');
                    templateItems.forEach(item => {
                        item.style.cursor = "not-allowed";
                        item.style.opacity = "0.5";
                    });
                }
                
                showMessage('ğŸ“ å†…å®¹ç¼–è¾‘æ¨¡å¼å·²å¼€å¯', 1500, 'success');
            }
        }
        
        // æ‹·è´å†…å®¹æ¡†å†…å®¹
        function copyContentFromEditor(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('âŒ æ‰¾ä¸åˆ°å†…å®¹æ¡†', 2000, 'error');
                return;
            }
            
            if (contentEditor.value.trim() === '') {
                showMessage('âš ï¸ å†…å®¹æ¡†ä¸ºç©ºï¼Œæ— å†…å®¹å¯æ‹·è´', 2000, 'warning');
                return;
            }
            
            try {
                // ä½¿ç”¨ç°ä»£APIè¿›è¡Œæ‹·è´
                navigator.clipboard.writeText(contentEditor.value).then(() => {
                    showMessage('ğŸ“‹ å†…å®¹å·²æ‹·è´åˆ°å‰ªè´´æ¿', 1500, 'success');
                }).catch(() => {
                    // é™çº§æ–¹æ¡ˆ
                    contentEditor.select();
                    document.execCommand('copy');
                    showMessage('ğŸ“‹ å†…å®¹å·²æ‹·è´åˆ°å‰ªè´´æ¿', 1500, 'success');
                });
            } catch (error) {
                showMessage('âŒ æ‹·è´å¤±è´¥ï¼š' + error.message, 2000, 'error');
            }
        }
        
        // ç²˜è´´åˆ°å†…å®¹æ¡†
        function pasteContentToEditor(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('âŒ æ‰¾ä¸åˆ°å†…å®¹æ¡†', 2000, 'error');
                return;
            }
            
            try {
                // ä½¿ç”¨ç°ä»£APIè¿›è¡Œç²˜è´´
                navigator.clipboard.readText().then(text => {
                    if (text.trim() === '') {
                        showMessage('âš ï¸ å‰ªè´´æ¿ä¸ºç©º', 2000, 'warning');
                        return;
                    }
                    
                    contentEditor.value = text;
                    contentEditor.focus();
                    showMessage('ğŸ“‹ å†…å®¹å·²ç²˜è´´', 1500, 'success');
                }).catch(() => {
                    // å¦‚æœæ²¡æœ‰æƒé™ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨ç²˜è´´
                    contentEditor.focus();
                    showMessage('ğŸ’¡ è¯·ä½¿ç”¨ Ctrl+V æ‰‹åŠ¨ç²˜è´´', 2000, 'info');
                });
            } catch (error) {
                showMessage('âŒ ç²˜è´´å¤±è´¥ï¼š' + error.message, 2000, 'error');
            }
        }
        
        // === ä¼šè¯ç®¡ç†ç³»ç»Ÿ ===
        let sessionDatabase = {};
        
        // ä¼šè¯æ•°æ®ç»“æ„
        function createSessionBlock(nodeId, content, type = 'note') {
            const sessionId = generateSessionId();
            const timestamp = new Date().toISOString();
            
            // æå–æ ‡é¢˜
            let title = '';
            if (type === 'note') {
                // ç¬”è®°æ¨¡å¼ï¼šå–å‰20ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜
                title = content.replace(/\n/g, ' ').substring(0, 20).trim();
                if (title.length < content.length) title += '...';
            } else if (type === 'interaction') {
                // é—®ç­”æ¨¡å¼ï¼šæå–é—®é¢˜ä½œä¸ºæ ‡é¢˜
                const lines = content.split('\n');
                const questionLine = lines.find(line => line.trim().startsWith('Q:') || line.trim().startsWith('é—®:'));
                if (questionLine) {
                    title = questionLine.replace(/^(Q:|é—®:)\s*/, '').substring(0, 30).trim();
                    if (title.length < questionLine.length) title += '...';
                } else {
                    title = content.substring(0, 20).trim() + '...';
                }
            }
            
            // æå–æ ‡ç­¾ï¼ˆä¼šè¯çº§æ ‡ç­¾æ¥è‡ªæ ‡ç­¾ç»„å†…çš„æ ‡ç­¾ï¼‰
            const tags = extractTagsFromContent(content);
            
            return {
                id: sessionId,
                type: type,
                title: title || 'æœªå‘½åä¼šè¯',
                content: content,
                timestamp: timestamp,
                modified: timestamp,
                tags: tags,
                isFavorited: false,
                nodeId: nodeId,
                metadata: {
                    author: projectInfo.author || 'NodeMind',
                    wordCount: content.length,
                    version: '1.0.0'
                }
            };
        }
        
        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ä»å†…å®¹ä¸­æå–æ ‡ç­¾
        function extractTagsFromContent(content) {
            const tagRegex = /#([^\s#]+)/g;
            const tags = [];
            let match;
            
            while ((match = tagRegex.exec(content)) !== null) {
                const tag = match[1];
                if (!tags.includes(tag)) {
                    tags.push(tag);
                }
            }
            
            return tags;
        }
        
        // åˆå§‹åŒ–èŠ‚ç‚¹çš„ä¼šè¯å®¹å™¨
        function initializeNodeSessions(nodeId) {
            if (!sessionDatabase[nodeId]) {
                sessionDatabase[nodeId] = {
                    nodeId: nodeId,
                    sessions: [],
                    activeSessionId: null,
                    lastModified: new Date().toISOString()
                };
            }
        }
        
        // æ·»åŠ ä¼šè¯åˆ°èŠ‚ç‚¹
        function addSessionToNode(nodeId, content, type = 'note') {
            
            initializeNodeSessions(nodeId);
            
            const sessionBlock = createSessionBlock(nodeId, content, type);
            sessionDatabase[nodeId].sessions.unshift(sessionBlock); // æ–°ä¼šè¯åœ¨å‰
            sessionDatabase[nodeId].lastModified = new Date().toISOString();
            
            // è‡ªåŠ¨è®¾ç½®ä¸ºæ´»è·ƒä¼šè¯
            sessionDatabase[nodeId].activeSessionId = sessionBlock.id;
            
            
            // æ›´æ–°UI
            updateSessionsList(nodeId);
            saveSessionData();
            
            return sessionBlock;
        }
        
        // è·å–èŠ‚ç‚¹çš„æ‰€æœ‰ä¼šè¯
        function getNodeSessions(nodeId) {
            initializeNodeSessions(nodeId);
            return sessionDatabase[nodeId].sessions || [];
        }
        
        // è·å–æ´»è·ƒä¼šè¯
        function getActiveSession(nodeId) {
            const nodeSessions = sessionDatabase[nodeId];
            if (!nodeSessions || !nodeSessions.activeSessionId) return null;
            
            return nodeSessions.sessions.find(s => s.id === nodeSessions.activeSessionId);
        }
        
        // è®¾ç½®æ´»è·ƒä¼šè¯
        function setActiveSession(nodeId, sessionId) {
            initializeNodeSessions(nodeId);
            sessionDatabase[nodeId].activeSessionId = sessionId;
            
            // æ›´æ–°å†…å®¹ç¼–è¾‘å™¨ - æ˜¾ç¤ºå®Œæ•´ä¼šè¯ä¿¡æ¯
            const session = sessionDatabase[nodeId].sessions.find(s => s.id === sessionId);
            if (session) {
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    // æ„å»ºå®Œæ•´çš„ä¼šè¯ä¿¡æ¯æ˜¾ç¤º
                    const sessionInfo = buildSessionDisplayContent(session);
                    contentEditor.value = sessionInfo;
                }
            }
            
            updateSessionsList(nodeId);
            saveSessionData();
        }
        
        // æ„å»ºä¼šè¯æ˜¾ç¤ºå†…å®¹ï¼ˆåŒ…å«æ‰€æœ‰å…ƒä¿¡æ¯ï¼‰
        function buildSessionDisplayContent(session) {
            const lines = [];
            
            // ä¼šè¯æ ‡é¢˜å’Œç±»å‹
            const typeText = session.type === 'interaction' ? 'é—®ç­”ä¼šè¯' : 'ç¬”è®°ä¼šè¯';
            lines.push(`# ${session.title}`);
            lines.push('');
            
            // å…ƒä¿¡æ¯åŒºåŸŸ
            lines.push('## ğŸ“‹ ä¼šè¯ä¿¡æ¯');
            lines.push(`**ç±»å‹**: ${typeText} ${session.type === 'interaction' ? 'ğŸ¤–' : 'ğŸ“'}`);
            lines.push(`**åˆ›å»ºæ—¶é—´**: ${formatDetailedTime(session.timestamp)}`);
            lines.push(`**ä¿®æ”¹æ—¶é—´**: ${formatDetailedTime(session.modified)}`);
            lines.push(`**æ”¶è—çŠ¶æ€**: ${session.isFavorited ? 'â­ å·²æ”¶è—' : 'â˜† æœªæ”¶è—'}`);
            lines.push(`**å­—æ•°ç»Ÿè®¡**: ${session.content.length} å­—ç¬¦`);
            
            // æ ‡ç­¾ä¿¡æ¯
            if (session.tags && session.tags.length > 0) {
                lines.push(`**æ ‡ç­¾**: ${session.tags.map(tag => `#${tag}`).join(' ')}`);
            } else {
                lines.push(`**æ ‡ç­¾**: æ— `);
            }
            
            // ä½œè€…ä¿¡æ¯
            if (session.metadata && session.metadata.author) {
                lines.push(`**ä½œè€…**: ${session.metadata.author}`);
            }
            
            lines.push('');
            lines.push('---');
            lines.push('');
            
            // ä¼šè¯å†…å®¹
            lines.push('## ğŸ“ ä¼šè¯å†…å®¹');
            lines.push('');
            lines.push(session.content);
            
            return lines.join('\n');
        }
        
        // æ ¼å¼åŒ–è¯¦ç»†æ—¶é—´
        function formatDetailedTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // æ›´æ–°ä¼šè¯åˆ—è¡¨UI
        function updateSessionsList(nodeId) {
            if (!nodeId) return;
            
            const sessionsContainer = document.querySelector('.sessions-container');
            if (!sessionsContainer) return;
            
            const sessions = getNodeSessions(nodeId);
            const activeSessionId = sessionDatabase[nodeId]?.activeSessionId;
            
            
            if (sessions.length === 0) {
                sessionsContainer.innerHTML = `
                    <div class="session-empty">
                        <div class="session-empty-icon">ğŸ’­</div>
                        <div class="session-empty-text">æš‚æ— ä¼šè¯è®°å½•</div>
                        <div class="session-empty-hint">åœ¨å†…å®¹ç¼–è¾‘å™¨ä¸­è¾“å…¥å†…å®¹å¹¶æäº¤åï¼Œä¼šè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´é™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedSessions = [...sessions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sessionsContainer.innerHTML = sortedSessions.map(session => {
                const isActive = session.id === activeSessionId;
                const timeStr = formatSessionTime(session.timestamp);
                const typeIcon = session.type === 'interaction' ? 'ğŸ¤–' : 'ğŸ“';
                const tagsHtml = session.tags && session.tags.length > 0 
                    ? `<div class="session-tags">${session.tags.map(tag => `<span class="session-tag">#${tag}</span>`).join('')}</div>`
                    : '';
                
                return `
                    <div class="session-item ${isActive ? 'active' : ''}" 
                         onclick="handleSessionClick('${session.id}', '${nodeId}')"
                         data-session-id="${session.id}">
                        <div class="session-header">
                            <div class="session-title">${typeIcon} ${session.title}</div>
                            <div class="session-actions">
                                <button class="session-favorite-btn" onclick="toggleSessionFavorite('${session.id}', '${nodeId}', event)" title="${session.isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—ä¼šè¯'}">${session.isFavorited ? 'â­' : 'â˜†'}</button>
                                <button class="session-delete-btn" onclick="deleteSession('${session.id}', '${nodeId}', event)" title="åˆ é™¤ä¼šè¯">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="session-time">${timeStr}</div>
                        ${tagsHtml}
                    </div>
                `;
            }).join('');
        }
        
        // æ ¼å¼åŒ–ä¼šè¯æ—¶é—´
        function formatSessionTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays < 7) {
                return diffDays + 'å¤©å‰';
            } else {
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            }
        }
        
        // å¤„ç†ä¼šè¯ç‚¹å‡»
        function handleSessionClick(sessionId, nodeId) {
            setActiveSession(nodeId, sessionId);
        }
        
        // åˆ‡æ¢ä¼šè¯æ”¶è—çŠ¶æ€
        function toggleSessionFavorite(sessionId, nodeId, event) {
            if (event) event.stopPropagation();
            
            const nodeSessions = sessionDatabase[nodeId];
            if (!nodeSessions) return;
            
            const session = nodeSessions.sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // åˆ‡æ¢æ”¶è—çŠ¶æ€
            session.isFavorited = !session.isFavorited;
            session.modified = new Date().toISOString();
            
            
            // æ›´æ–°UIå’Œä¿å­˜æ•°æ®
            updateSessionsList(nodeId);
            saveSessionData();
        }
        
        // åˆ é™¤ä¼šè¯
        function deleteSession(sessionId, nodeId, event) {
            if (event) event.stopPropagation();
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) return;
            
            const nodeSessions = sessionDatabase[nodeId];
            if (!nodeSessions) return;
            
            const sessionIndex = nodeSessions.sessions.findIndex(s => s.id === sessionId);
            if (sessionIndex === -1) return;
            
            const session = nodeSessions.sessions[sessionIndex];
            nodeSessions.sessions.splice(sessionIndex, 1);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯æ´»è·ƒä¼šè¯ï¼Œæ¸…é™¤æ´»è·ƒçŠ¶æ€æˆ–åˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯
            if (nodeSessions.activeSessionId === sessionId) {
                if (nodeSessions.sessions.length > 0) {
                    nodeSessions.activeSessionId = nodeSessions.sessions[0].id;
                    setActiveSession(nodeId, nodeSessions.sessions[0].id);
                } else {
                    nodeSessions.activeSessionId = null;
                    // æ¸…ç©ºå†…å®¹ç¼–è¾‘å™¨æˆ–æ˜¾ç¤ºèŠ‚ç‚¹åŸå§‹å†…å®¹
                    const contentEditor = document.getElementById('content-editor');
                    if (contentEditor && nodeDatabase[nodeId]) {
                        contentEditor.value = nodeDatabase[nodeId].content || '';
                    }
                }
            }
            
            updateSessionsList(nodeId);
            saveSessionData();
        }
        
        // ä¿å­˜ä¼šè¯æ•°æ®
        function saveSessionData() {
            try {
                localStorage.setItem(STORAGE_KEYS.SESSION_DATABASE, JSON.stringify(sessionDatabase));
            } catch (error) {
                console.error('âŒ [ä¼šè¯ç³»ç»Ÿ] ä¿å­˜ä¼šè¯æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ä¼šè¯æ•°æ®
        function loadSessionData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.SESSION_DATABASE);
                if (savedData) {
                    sessionDatabase = JSON.parse(savedData);
                } else {
                    sessionDatabase = {};
                }
            } catch (error) {
                console.error('âŒ [ä¼šè¯ç³»ç»Ÿ] åŠ è½½ä¼šè¯æ•°æ®å¤±è´¥:', error);
                sessionDatabase = {};
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¼šè¯æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadSessionData();
        });
        
        // === UIåˆ†å‰²å™¨åŠŸèƒ½å·²æ¨¡å—åŒ–åˆ° Splitter ç»„ä»¶ ===
        
        // === å³ä¾§é¢æ¿åˆ†å‰²å™¨åŠŸèƒ½å·²æ¨¡å—åŒ–åˆ° Splitter ç»„ä»¶ ===
        
        // æ›´æ–°é¡¹ç›®ä¿¡æ¯é¡µé¢çš„èŠ‚ç‚¹ä½œè€…ä¿¡æ¯
        function updateProjectInfoNodeAuthor(authorValue) {
            const authorInput = document.getElementById('project-node-author');
            if (authorInput) {
                authorInput.value = authorValue || '';
            }
        }
        
        // ä»é¡¹ç›®ä¿¡æ¯é¡µé¢æ›´æ–°å½“å‰èŠ‚ç‚¹çš„ä½œè€…ä¿¡æ¯
        function updateCurrentNodeAuthor(authorValue) {
            if (selectedNodeId) {
                updateNodeAuthor(selectedNodeId, authorValue);
            }
        }
        
        // === æ ¡å‡†åŠŸèƒ½æ¨¡å— - ç‹¬ç«‹æ¨¡å—ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½ ===
        
        // æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ - åŸºäºæ–‡æ¡£è®¾è®¡
        var templateManager = {
            templates: {
                'è‡ªç„¶æ¨¡å¼': {
                    versions: [
                        {
                            name: 'é»˜è®¤æ¨¡æ¿',
                            prefix: 'ä½ å¥½ï¼Œæˆ‘éœ€è¦ä½ çš„å¸®åŠ©ã€‚',
                            suffix: 'è¯·è¯¦ç»†å›ç­”ï¼Œè°¢è°¢ã€‚'
                        },
                        {
                            name: 'å‹å¥½æ¨¡å¼',
                            prefix: 'å¸Œæœ›èƒ½å¾—åˆ°ä½ çš„ä¸“ä¸šå»ºè®®ï¼š',
                            suffix: 'éå¸¸æ„Ÿè°¢ä½ çš„å¸®åŠ©ï¼'
                        }
                    ]
                },
                'æŠ€æœ¯æ¨¡å¼': {
                    versions: [
                        {
                            name: 'ä»£ç åˆ†æ',
                            prefix: 'è¯·åˆ†æä»¥ä¸‹æŠ€æœ¯é—®é¢˜ï¼š',
                            suffix: 'è¯·æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆå’Œä»£ç ç¤ºä¾‹ã€‚'
                        },
                        {
                            name: 'æ¶æ„è®¾è®¡',
                            prefix: 'éœ€è¦è¿›è¡Œç³»ç»Ÿæ¶æ„è®¾è®¡ï¼š',
                            suffix: 'è¯·è€ƒè™‘å¯æ‰©å±•æ€§å’Œæ€§èƒ½ä¼˜åŒ–ã€‚'
                        }
                    ]
                },
                'åˆ›æ„æ¨¡å¼': {
                    versions: [
                        {
                            name: 'å¤´è„‘é£æš´',
                            prefix: 'è®©æˆ‘ä»¬ä¸€èµ·æ€è€ƒåˆ›æ–°æ–¹æ¡ˆï¼š',
                            suffix: 'æœŸå¾…å¬åˆ°ä½ çš„åˆ›æ„æƒ³æ³•ï¼'
                        },
                        {
                            name: 'æ–¹æ¡ˆä¼˜åŒ–',
                            prefix: 'å½“å‰æ–¹æ¡ˆéœ€è¦æ”¹è¿›ï¼š',
                            suffix: 'è¯·æä¾›å¤šä¸ªä¼˜åŒ–å»ºè®®ã€‚'
                        }
                    ]
                }
            },
            currentScene: '',
            currentVersion: '',
            
            getScenes: function() {
                return Object.keys(this.templates);
            },
            
            getVersions: function(scene) {
                if (scene && this.templates[scene]) {
                    return this.templates[scene].versions.map(v => v.name);
                }
                return [];
            },
            
            getTemplate: function(scene, version) {
                if (scene && version && this.templates[scene]) {
                    return this.templates[scene].versions.find(v => v.name === version);
                }
                return null;
            }
        };
        
        // === æ ¡å‡†ç³»ç»Ÿ - åŸºäºinjectionå·¥å…·å®Œæ•´å®ç° ===
        
        function performCalibration() {
            alert('æ ¡å‡†åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨');
        }
        
        // === å‘½ä»¤æ³¨å…¥åŠŸèƒ½å·²æ¨¡å—åŒ–åˆ° InjectionService ===
        
        // === æ¨¡æ¿ç®¡ç†åŠŸèƒ½å·²æ¨¡å—åŒ–åˆ° TemplateService ===
        
        // === openTemplateManager å‡½æ•°å·²æ¨¡å—åŒ–åˆ° TemplateService ===

        // åˆå§‹åŒ–æ¨¡æ¿ç®¡ç†å™¨å†…å®¹
        function initializeTemplateManagerContent() {
            try {
                const modalBody = document.querySelector('#template-manager-container .modal-body');
                if (!modalBody) return;

                // å°è¯•ä½¿ç”¨å®Œæ•´æ¨¡æ¿ç®¡ç†å™¨ç³»ç»Ÿ
                if (typeof window.TemplateManagerEntry !== 'undefined') {
                    window.TemplateManagerEntry.initialize();
                } else {
                    // åŸºäºinjectionæç¤ºè¯æ¨¡æ¿ç³»ç»Ÿçš„å¡ç‰‡å¼æ¨¡æ¿åˆ—è¡¨
                    modalBody.innerHTML = `
                        <div style="padding: 20px;">
                            <!-- æ–°å¢æ¨¡æ¿æŒ‰é”® -->
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button onclick="addNewTemplate()" class="add-template-btn" style="padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s ease;">
                                    â• æ–°å¢æ¨¡æ¿
                                </button>
                            </div>
                            
                            <!-- æ¨¡å—åŒ–å¼ºåˆ¶è¯´æ˜ -->
                            <div style="margin-bottom: 20px; padding: 12px; background: linear-gradient(90deg, #e8f5e8, #f0f8f0); border-left: 4px solid #28a745; border-radius: 6px;">
                                <h4 style="margin: 0 0 8px 0; color: #155724; font-size: 16px;">ğŸ—ï¸ æ¨¡å—åŒ–å¼ºåˆ¶çº¦æŸ</h4>
                                <p style="margin: 0; color: #155724; font-size: 14px; line-height: 1.4;">
                                    <strong>æ‰€æœ‰æ¨¡æ¿éƒ½è‡ªåŠ¨åŒ…å«æ¨¡å—åŒ–å¼€å‘è§„èŒƒï¼</strong><br>
                                    æ— éœ€å•ç‹¬é€‰æ‹©ï¼Œæ¯ä¸ªæ¨¡æ¿ä½¿ç”¨æ—¶éƒ½ä¼šå¼ºåˆ¶æ·»åŠ æ¨¡å—åŒ–çº¦æŸå‰ç¼€å’Œæ£€æŸ¥æ¸…å•åç¼€ã€‚
                                </p>
                            </div>
                            
                            <!-- æ¨¡æ¿åˆ†ç±»æ ‡ç­¾ -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #495057; font-size: 18px;">ğŸ“‹ æ¨¡æ¿åˆ†ç±»æ ‡ç­¾ï¼š</h4>
                                <div id="template-filter-tags" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <button class="filter-tag active" data-category="all" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        ğŸ·ï¸ å…¨éƒ¨
                                    </button>
                                    <button class="filter-tag" data-category="natural" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        ğŸ—£ï¸ è‡ªç„¶æ¨¡å¼
                                    </button>
                                    <button class="filter-tag" data-category="code" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        ğŸ’» ä»£ç ç±»
                                    </button>
                                    <button class="filter-tag" data-category="log" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        ğŸ“ æ—¥å¿—ç±»
                                    </button>
                                    <button class="filter-tag" data-category="feature" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        âœ¨ æ–°åŠŸèƒ½ç±»
                                    </button>
                                </div>
                            </div>
                            
                            <!-- æ¨¡æ¿å¡ç‰‡å®¹å™¨ -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                
                                <!-- è‡ªç„¶æ¨¡å¼ -->
                                <div class="template-card" data-category="natural" data-template-id="è‡ªç„¶æ¨¡å¼" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">ğŸ—£ï¸ è‡ªç„¶æ¨¡å¼</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('è‡ªç„¶æ¨¡å¼'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('è‡ªç„¶æ¨¡å¼'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('è‡ªç„¶æ¨¡å¼'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">å¸¸è§„å¯¹è¯æ¨¡å¼ï¼ŒæŒ‡å‘é¡¹ç›®æ—¥å¿—æ–‡æ¡£</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>å‰ç¼€ï¼š</strong>"æ—¥å¿—"ä¸€èˆ¬æ˜¯æŒ‡{é¡¹ç›®åç§°}-log.mdæ–‡æ¡£
                                    </div>
                                </div>

                                <!-- ä»£ç è‡ªæŸ¥ -->
                                <div class="template-card" data-category="code" data-template-id="ä»£ç è‡ªæŸ¥" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">ğŸ” ä»£ç è‡ªæŸ¥</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('ä»£ç è‡ªæŸ¥'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('ä»£ç è‡ªæŸ¥'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('ä»£ç è‡ªæŸ¥'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">ä»£ç è´¨é‡æ£€æŸ¥å’Œé—®é¢˜æ’æŸ¥</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>å‰ç¼€ï¼š</strong>ä¸»è¦åŠŸèƒ½ç‚¹ï¼Œæ˜¯å¦æœ‰é‡å¤çš„å®ç°é€»è¾‘ï¼Œè·¯å¾„é”™è¯¯æ£€æŸ¥...
                                    </div>
                                </div>

                                <!-- ä¿®æ”¹ä»£ç  -->
                                <div class="template-card" data-category="code" data-template-id="ä¿®æ”¹ä»£ç " style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">âš¡ ä¿®æ”¹ä»£ç </h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('ä¿®æ”¹ä»£ç '); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('ä¿®æ”¹ä»£ç '); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('ä¿®æ”¹ä»£ç '); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">åŒ…å«å®Œæ•´çš„ä»£ç å¤–ç§‘æ‰‹æœ¯åè®®</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>åç¼€ï¼š</strong>ã€ä»£ç ä¿®æ”¹å¤–ç§‘æ‰‹æœ¯åè®®ã€‘âš¡ï¸ ä¸¥è°¨çš„ä»£ç å¤–ç§‘åŒ»ç”Ÿè§„èŒƒ...
                                    </div>
                                </div>

                                <!-- ä¸ç”Ÿæ•ˆ -->
                                <div class="template-card" data-category="code" data-template-id="ä¸ç”Ÿæ•ˆ" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('ä¸ç”Ÿæ•ˆ')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">âŒ ä¸ç”Ÿæ•ˆ</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('ä¸ç”Ÿæ•ˆ'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('ä¸ç”Ÿæ•ˆ'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('ä¸ç”Ÿæ•ˆ'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">ä»£ç ä¿®æ”¹ä¸ç”Ÿæ•ˆé—®é¢˜è¯Šæ–­</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>åç¼€ï¼š</strong>ä¿®æ”¹ä»£ç æ²¡æœ‰ç”Ÿæ•ˆçš„6ä¸ªå¸¸è§åŸå› åˆ†æ...
                                    </div>
                                </div>

                                <!-- æ—¥å¿—-ä¿®æ”¹ä»£ç  -->
                                <div class="template-card" data-category="log" data-template-id="æ—¥å¿—-ä¿®æ”¹ä»£ç " style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('æ—¥å¿—-ä¿®æ”¹ä»£ç ')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">ğŸ“ æ—¥å¿—-ä¿®æ”¹ä»£ç </h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('æ—¥å¿—-ä¿®æ”¹ä»£ç '); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('æ—¥å¿—-ä¿®æ”¹ä»£ç '); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('æ—¥å¿—-ä¿®æ”¹ä»£ç '); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">ç»“åˆä»£ç å¤–ç§‘æ‰‹æœ¯åè®®å’Œå·¥ä½œæ—¥å¿—è®°å½•</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>åŠŸèƒ½ï¼š</strong>ä¿®æ”¹è§„èŒƒ + æ—¥å¿—æ ¼å¼è¦æ±‚
                                    </div>
                                </div>

                                <!-- æ—¥å¿—-ä¸ç”Ÿæ•ˆ -->
                                <div class="template-card" data-category="log" data-template-id="æ—¥å¿—-ä¸ç”Ÿæ•ˆ" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('æ—¥å¿—-ä¸ç”Ÿæ•ˆ')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">ğŸ“‹ æ—¥å¿—-ä¸ç”Ÿæ•ˆ</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('æ—¥å¿—-ä¸ç”Ÿæ•ˆ'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('æ—¥å¿—-ä¸ç”Ÿæ•ˆ'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('æ—¥å¿—-ä¸ç”Ÿæ•ˆ'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">ç»“åˆä»£ç ä¸ç”Ÿæ•ˆè¯Šæ–­å’Œå·¥ä½œæ—¥å¿—è®°å½•</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>åŠŸèƒ½ï¼š</strong>é—®é¢˜è¯Šæ–­ + æ—¥å¿—è®°å½•
                                    </div>
                                </div>

                                <!-- æ—¥å¿—-æ–°åŠŸèƒ½ -->
                                <div class="template-card" data-category="log" data-template-id="æ—¥å¿—-æ–°åŠŸèƒ½" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('æ—¥å¿—-æ–°åŠŸèƒ½')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">ğŸš€ æ—¥å¿—-æ–°åŠŸèƒ½</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('æ—¥å¿—-æ–°åŠŸèƒ½'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('æ—¥å¿—-æ–°åŠŸèƒ½'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('æ—¥å¿—-æ–°åŠŸèƒ½'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">æœ€å°åŒ–ä»£ç å®ç°åŸåˆ™ï¼Œæ–°åŠŸèƒ½å¼€å‘</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>å‰ç¼€ï¼š</strong>è®¤çœŸå›ç­”é—®é¢˜<br>
                                        <strong>åç¼€ï¼š</strong>éµå¾ªæœ€å°åŒ–ä»£ç å®ç°åŸåˆ™
                                    </div>
                                </div>

                                <!-- æ–°åŠŸèƒ½ -->
                                <div class="template-card" data-category="feature" data-template-id="æ–°åŠŸèƒ½" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('æ–°åŠŸèƒ½')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">âœ¨ æ–°åŠŸèƒ½</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('æ–°åŠŸèƒ½'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="é€‰æ‹©æ­¤æ¨¡æ¿">âœ“</button>
                                            <button onclick="editTemplate('æ–°åŠŸèƒ½'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                                            <button onclick="deleteTemplate('æ–°åŠŸèƒ½'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">éµå¾ªæœ€å°åŒ–ä»£ç å®ç°åŸåˆ™çš„æ–°åŠŸèƒ½å¼€å‘</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>å‰ç¼€ï¼š</strong>éµå¾ªæœ€å°åŒ–ä»£ç å®ç°åŸåˆ™ã€‚ä¸å¾—ä»»æ„å¢åŠ æŒ‡ä»¤ä»¥å¤–çš„åŠŸèƒ½
                                    </div>
                                </div>

                            </div>
                            
                            <!-- åº•éƒ¨åŠŸèƒ½åŒº -->
                            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e9ecef; text-align: center;">
                                <p style="margin: 0 0 8px 0; color: #6c757d; font-size: 14px;">ğŸ’¡ åŸºäºinjectionæç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ - æ”¯æŒå‰ç¼€/åç¼€æ¨¡æ¿å’Œå˜é‡æ›¿æ¢</p>
                                <p style="margin: 0 0 12px 0; color: #28a745; font-size: 13px; font-weight: 600;">ğŸ—ï¸ æ‰€æœ‰æ¨¡æ¿è‡ªåŠ¨åŒ…å«å¼ºåˆ¶æ¨¡å—åŒ–å¼€å‘è§„èŒƒ - ç¡®ä¿ä»£ç æ¶æ„ä¸€è‡´æ€§</p>
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button onclick="importTemplates()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“¥ å¯¼å…¥æ¨¡æ¿</button>
                                    <button onclick="exportTemplates()" style="padding: 8px 16px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“¤ å¯¼å‡ºæ¨¡æ¿</button>
                                    <button onclick="initializeTemplateManagerContent()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ”„ åˆ·æ–°</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ ·å¼å·²ç§»è‡³ assets/css/template-styles.css -->
                    `;
                }
            } catch (error) {
                console.error('âŒ æ¨¡æ¿ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // ç»‘å®šæ¨¡æ¿ç®¡ç†å™¨äº‹ä»¶
        function bindTemplateManagerEvents() {
            // è¿”å›æŒ‰é”®
            const backButton = document.getElementById('template_manager_back_button');
            if (backButton) {
                backButton.onclick = closeTemplateManager;
            }

            // å…³é—­æŒ‰é”®
            const closeButton = document.getElementById('template_manager_close_button');
            if (closeButton) {
                closeButton.onclick = closeTemplateManager;
            }

            // èƒŒæ™¯ç‚¹å‡»å…³é—­
            const backdrop = document.getElementById('template_manager_backdrop');
            if (backdrop) {
                backdrop.onclick = closeTemplateManager;
            }

            // ESCé”®å…³é—­
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const container = document.getElementById('template-manager-container');
                    const editModal = document.getElementById('template-edit-modal');
                    
                    if (editModal && editModal.style.display !== 'none') {
                        closeTemplateEditModal();
                    } else if (container && container.style.display !== 'none') {
                        closeTemplateManager();
                    }
                }
            });
        }

        // å…³é—­æ¨¡æ¿ç®¡ç†å™¨
        function closeTemplateManager() {
            const templateManagerContainer = document.getElementById('template-manager-container');
            if (templateManagerContainer) {
                templateManagerContainer.style.display = 'none';
            }
        }

        // å…¨å±€å˜é‡å­˜å‚¨æ¨¡æ¿æ•°æ®  
        // let selectedTemplates = []; // å·²è¿ç§»åˆ°æ¨¡æ¿é€‰æ‹©æœåŠ¡ä¸­ç®¡ç†
        
        // å…¨å±€å¼ºåˆ¶æ¨¡å—åŒ–å‰ç¼€ - æ‰€æœ‰æ¨¡æ¿éƒ½å°†è‡ªåŠ¨åŒ…å«æ­¤çº¦æŸ
        const GLOBAL_MODULAR_PREFIX = `ğŸ—ï¸ ã€NodeMindå¼ºåˆ¶æ¨¡å—åŒ–å¼€å‘è§„èŒƒã€‘

ğŸ“‹ **é¡¹ç›®æ¶æ„è¦æ±‚**ï¼š
- é¡¹ç›®å·²å®Œæˆæ¨¡å—åŒ–è§£è€¦ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªæ—¢å®šæ¶æ„
- ç¦æ­¢åœ¨index.htmlä¸­æ·»åŠ å†…è”JavaScriptä»£ç 
- æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»æ”¾å…¥å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ä¸­

ğŸ“ **æ¨¡å—åŒ–ç›®å½•ç»“æ„**ï¼š
\`\`\`
src/
â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”‚   â”œâ”€â”€ mindmap_service.js    # æ€ç»´å¯¼å›¾æ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ node_service.js       # èŠ‚ç‚¹ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ tag_service.js        # æ ‡ç­¾ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ storage_service.js    # æ•°æ®å­˜å‚¨æœåŠ¡
â”‚   â”œâ”€â”€ project_service.js    # é¡¹ç›®ä¿¡æ¯æœåŠ¡
â”‚   â””â”€â”€ template_service.js   # æ¨¡æ¿ç®¡ç†æœåŠ¡
â”œâ”€â”€ controllers/       # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ ui_controller.js      # UIæ§åˆ¶å™¨
â”‚   â””â”€â”€ context_menu_controller.js # èœå•æ§åˆ¶å™¨
â”œâ”€â”€ ui/components/     # UIç»„ä»¶å±‚
â”‚   â”œâ”€â”€ node_details_ui.js    # èŠ‚ç‚¹è¯¦æƒ…ç»„ä»¶
â”‚   â”œâ”€â”€ project_info_ui.js    # é¡¹ç›®ä¿¡æ¯ç»„ä»¶
â”‚   â””â”€â”€ md_browser_ui.js      # MDæµè§ˆå™¨ç»„ä»¶
â”œâ”€â”€ utils/             # å·¥å…·å±‚
â”‚   â””â”€â”€ utils.js              # é€šç”¨å·¥å…·å‡½æ•°
â”œâ”€â”€ event_bus.js       # äº‹ä»¶æ€»çº¿ï¼ˆç»Ÿä¸€é€šä¿¡ï¼‰
â”œâ”€â”€ state.js          # çŠ¶æ€ç®¡ç†
â””â”€â”€ app.js            # åº”ç”¨å…¥å£
\`\`\`

âš¡ **å¼ºåˆ¶è¦æ±‚**ï¼š
1. **æ–°åŠŸèƒ½æ¨¡å—å½’å±**ï¼šæ˜ç¡®æŒ‡å®šåŠŸèƒ½åº”æ”¾å…¥å“ªä¸ªå…·ä½“æ¨¡å—æ–‡ä»¶
2. **é¿å…é‡å¤å®ç°**ï¼šæ£€æŸ¥ç°æœ‰æ¨¡å—ï¼Œå¤ç”¨å·²æœ‰åŠŸèƒ½ï¼Œåˆ é™¤é‡å¤ä»£ç 
3. **äº‹ä»¶æ€»çº¿é€šä¿¡**ï¼šæ¨¡å—é—´é€šä¿¡å¿…é¡»ä½¿ç”¨src/event_bus.js
4. **ç»Ÿä¸€å·¥å…·å‡½æ•°**ï¼šä½¿ç”¨src/utils/utils.jsä¸­çš„showMessageç­‰å‡½æ•°
5. **çŠ¶æ€ç®¡ç†é›†ä¸­**ï¼šä½¿ç”¨src/services/state.jsç®¡ç†åº”ç”¨çŠ¶æ€

ğŸš« **ä¸¥ç¦è¡Œä¸º**ï¼š
- âŒ åœ¨index.htmlä¸­å†™å†…è”JavaScript
- âŒ åˆ›å»ºé‡å¤çš„å·¥å…·å‡½æ•°ï¼ˆå¦‚showMessageï¼‰
- âŒ ç»•è¿‡æ¨¡å—åŒ–ç›´æ¥æ“ä½œDOM
- âŒ å¿½ç•¥ç°æœ‰çš„æœåŠ¡å±‚æ¥å£

ğŸ“ **ä»£ç å®ç°è¦æ±‚**ï¼š

`;

        // å…¨å±€å¼ºåˆ¶æ¨¡å—åŒ–åç¼€ - æ‰€æœ‰æ¨¡æ¿éƒ½å°†è‡ªåŠ¨åŒ…å«æ­¤æ£€æŸ¥æ¸…å•
        const GLOBAL_MODULAR_SUFFIX = `

ğŸ” **æ¨¡å—åŒ–æ£€æŸ¥æ¸…å•**ï¼š
- [ ] åŠŸèƒ½å·²æ”¾å…¥æ­£ç¡®çš„æ¨¡å—æ–‡ä»¶
- [ ] ä½¿ç”¨äº†ç»Ÿä¸€çš„äº‹ä»¶æ€»çº¿é€šä¿¡
- [ ] å¤ç”¨äº†ç°æœ‰çš„å·¥å…·å‡½æ•°
- [ ] éµå¾ªäº†å•ä¸€èŒè´£åŸåˆ™
- [ ] é¿å…äº†ä»£ç é‡å¤
- [ ] æ›´æ–°äº†ç›¸å…³çš„å¯¼å…¥å¯¼å‡º

ğŸ“‹ **å˜æ›´æŠ¥å‘Šæ ¼å¼**ï¼š
\`\`\`diff
# æ¨¡å—åŒ–å˜æ›´æŠ¥å‘Š
## ä¿®æ”¹æ–‡ä»¶ï¼šsrc/services/[æ¨¡å—å].js
+ æ–°å¢åŠŸèƒ½ï¼š[å…·ä½“åŠŸèƒ½æè¿°]
+ å¤ç”¨ç»„ä»¶ï¼š[ä½¿ç”¨çš„ç°æœ‰æ¨¡å—]
+ äº‹ä»¶é€šä¿¡ï¼š[ä½¿ç”¨çš„äº‹ä»¶ç±»å‹]
## æ¶æ„åˆè§„æ€§ï¼šâœ… å®Œå…¨ç¬¦åˆæ¨¡å—åŒ–è§„èŒƒ
\`\`\`

âš ï¸ **é‡è¦æé†’**ï¼šæœ¬é¡¹ç›®å·²å®Œæˆæ¨¡å—åŒ–æ¶æ„ï¼Œä»»ä½•è¿åæ¨¡å—åŒ–åŸåˆ™çš„ä»£ç éƒ½å°†å¯¼è‡´æ¶æ„é€€åŒ–ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸Šè§„èŒƒï¼`;

        window.templateData = {
            'è‡ªç„¶æ¨¡å¼': {
                name: 'ğŸ—£ï¸ è‡ªç„¶æ¨¡å¼',
                description: 'å¸¸è§„å¯¹è¯æ¨¡å¼ï¼Œä¸“æ³¨é¡¹ç›®æ—¥å¿—æ–‡æ¡£è®°å½•',
                category: 'natural',
                prefix: `ğŸ“‹ **å·¥ä½œæ—¥å¿—æ¨¡å¼**ï¼š
- å½“å‰é¡¹ç›®çš„"æ—¥å¿—"ç‰¹æŒ‡ï¼š{é¡¹ç›®åç§°}-log.md æ–‡æ¡£
- è¯·åŸºäºé¡¹ç›®ä¸Šä¸‹æ–‡è¿›è¡Œå¯¹è¯ï¼Œå‚è€ƒå·²æœ‰çš„å·¥ä½œè®°å½•
- ä¼˜å…ˆæŸ¥é˜…ç°æœ‰æ—¥å¿—å†…å®¹ï¼Œä¿æŒå·¥ä½œè¿ç»­æ€§`,
                suffix: `
ğŸ’¡ **è®°å½•è¦æ±‚**ï¼š
- å¦‚æœ‰é‡è¦å‘ç°æˆ–å†³ç­–ï¼Œå»ºè®®è®°å½•åˆ°é¡¹ç›®æ—¥å¿—ä¸­
- ä¿æŒå·¥ä½œè®°å½•çš„å®Œæ•´æ€§å’Œå¯è¿½æº¯æ€§`
            },
            'ä»£ç è‡ªæŸ¥': {
                name: 'ğŸ” ä»£ç è‡ªæŸ¥',
                description: 'ç³»ç»Ÿæ€§ä»£ç è´¨é‡æ£€æŸ¥å’Œé—®é¢˜æ’æŸ¥',
                category: 'code',
                prefix: `ğŸ” **ä»£ç è´¨é‡è‡ªæŸ¥æ¸…å•**ï¼š
1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šæ£€æŸ¥ä¸»è¦åŠŸèƒ½ç‚¹æ˜¯å¦å®Œæ•´å®ç°
2. **é€»è¾‘é‡å¤**ï¼šè¯†åˆ«é‡å¤çš„å®ç°é€»è¾‘ï¼Œæå‡ºåˆå¹¶å»ºè®®  
3. **è·¯å¾„æ­£ç¡®æ€§**ï¼šéªŒè¯æ–‡ä»¶è·¯å¾„ã€å¯¼å…¥è·¯å¾„çš„å‡†ç¡®æ€§
4. **ä¾èµ–å…³ç³»**ï¼šæ£€æŸ¥æ¨¡å—é—´ä¾èµ–æ˜¯å¦åˆç†
5. **æ€§èƒ½é—®é¢˜**ï¼šè¯†åˆ«æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆ
6. **å®‰å…¨éšæ‚£**ï¼šæ£€æŸ¥å¸¸è§çš„å®‰å…¨é—®é¢˜`,
                suffix: `
ğŸ“Š **è¾“å‡ºæ ¼å¼**ï¼š
- âœ… æ­£å¸¸é¡¹ç›®ï¼šåˆ—å‡ºæ£€æŸ¥é€šè¿‡çš„é¡¹ç›®
- âš ï¸ éœ€è¦æ³¨æ„ï¼šåˆ—å‡ºæ½œåœ¨é£é™©ç‚¹
- âŒ ä¸¥é‡é—®é¢˜ï¼šåˆ—å‡ºå¿…é¡»ä¿®å¤çš„é—®é¢˜
- ğŸ’¡ ä¼˜åŒ–å»ºè®®ï¼šæä¾›å…·ä½“çš„æ”¹è¿›æ–¹æ¡ˆ`
            },
            'ä¿®æ”¹ä»£ç ': {
                name: 'âš¡ ä¿®æ”¹ä»£ç ',
                description: 'éµå¾ªä»£ç å¤–ç§‘æ‰‹æœ¯åè®®çš„ç²¾ç¡®ä¿®æ”¹',
                category: 'code',
                prefix: `âš¡ **ä»£ç å¤–ç§‘æ‰‹æœ¯åè®®å¯åŠ¨**ï¼š
1. **æœ¯å‰è¯Šæ–­**ï¼šè¯¦ç»†åˆ†æç°æœ‰ä»£ç ç»“æ„å’Œé—®é¢˜æ ¹å› 
2. **æ‰‹æœ¯æ–¹æ¡ˆ**ï¼šåˆ¶å®šæœ€å°åŒ–å½±å“çš„ä¿®æ”¹ç­–ç•¥
3. **é£é™©è¯„ä¼°**ï¼šè¯†åˆ«ä¿®æ”¹å¯èƒ½å½±å“çš„å…¶ä»–æ¨¡å—
4. **å¤‡ä»½æ£€æŸ¥**ï¼šç¡®è®¤é‡è¦ä»£ç çš„å¤‡ä»½å’Œå›æ»šæ–¹æ¡ˆ`,
                suffix: `
ğŸ¥ **ä»£ç å¤–ç§‘æ‰‹æœ¯åè®®**ï¼š
- **ç²¾å‡†å®šä½**ï¼šåªä¿®æ”¹å¿…è¦çš„ä»£ç è¡Œï¼Œé¿å…å¤§èŒƒå›´æ”¹åŠ¨
- **å½±å“è¯„ä¼°**ï¼šè¯´æ˜ä¿®æ”¹å¯¹å…¶ä»–æ¨¡å—çš„æ½œåœ¨å½±å“
- **æµ‹è¯•ç­–ç•¥**ï¼šæä¾›éªŒè¯ä¿®æ”¹æ­£ç¡®æ€§çš„æµ‹è¯•æ–¹æ³•
- **å›æ»šæ–¹æ¡ˆ**ï¼šå¦‚ä¿®æ”¹å‡ºç°é—®é¢˜ï¼Œæä¾›å¿«é€Ÿå›æ»šæ­¥éª¤
- **æ–‡æ¡£æ›´æ–°**ï¼šåŒæ­¥æ›´æ–°ç›¸å…³æ³¨é‡Šå’Œæ–‡æ¡£

âš ï¸ **ä¸¥è°¨åŸåˆ™**ï¼šå®å¯å¤šæ¬¡å°ä¿®æ”¹ï¼Œä¹Ÿä¸è¦ä¸€æ¬¡å¤§æ”¹åŠ¨ï¼`
            },
            'ä¸ç”Ÿæ•ˆ': {
                name: 'âŒ ä¸ç”Ÿæ•ˆ',
                description: 'ä»£ç ä¿®æ”¹ä¸ç”Ÿæ•ˆçš„ç³»ç»Ÿæ€§è¯Šæ–­',
                category: 'code',
                prefix: `âŒ **ä»£ç ä¸ç”Ÿæ•ˆè¯Šæ–­å¯åŠ¨**ï¼š
è¯·æŒ‰ç…§ä»¥ä¸‹6ä¸ªç»´åº¦ç³»ç»Ÿæ’æŸ¥é—®é¢˜ï¼š`,
                suffix: `
ğŸ”§ **ä»£ç ä¸ç”Ÿæ•ˆçš„6ä¸ªå¸¸è§åŸå› **ï¼š
1. **ç¼“å­˜é—®é¢˜**ï¼šæµè§ˆå™¨ç¼“å­˜ã€æ¨¡å—ç¼“å­˜æœªæ¸…ç†
2. **è·¯å¾„é”™è¯¯**ï¼šæ–‡ä»¶è·¯å¾„ã€å¯¼å…¥è·¯å¾„ä¸æ­£ç¡®
3. **è¯­æ³•é”™è¯¯**ï¼šä»£ç å­˜åœ¨è¯­æ³•é”™è¯¯é˜»æ­¢æ‰§è¡Œ
4. **ä½œç”¨åŸŸé—®é¢˜**ï¼šå˜é‡ä½œç”¨åŸŸã€å‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡é”™è¯¯
5. **å¼‚æ­¥é—®é¢˜**ï¼šå¼‚æ­¥ä»£ç æ‰§è¡Œæ—¶åºé—®é¢˜
6. **ä¾èµ–ç¼ºå¤±**ï¼šç¼ºå°‘å¿…è¦çš„ä¾èµ–æˆ–æ¨¡å—æœªæ­£ç¡®åŠ è½½

ğŸ¯ **è¯Šæ–­æ­¥éª¤**ï¼š
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
- éªŒè¯æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¡®åŠ è½½
- ç¡®è®¤ä»£ç æ˜¯å¦åœ¨æ­£ç¡®çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­
- æ£€æŸ¥ç›¸å…³ä¾èµ–æ˜¯å¦æ­£å¸¸å·¥ä½œ
- ä½¿ç”¨æ–­ç‚¹æˆ–console.logç¡®è®¤ä»£ç æ‰§è¡Œæµç¨‹`
            },
            'æ—¥å¿—-ä¿®æ”¹ä»£ç ': {
                name: 'ğŸ“ æ—¥å¿—-ä¿®æ”¹ä»£ç ',
                description: 'ç»“åˆå·¥ä½œæ—¥å¿—è®°å½•çš„ä»£ç ä¿®æ”¹æµç¨‹',
                category: 'log',
                prefix: `ğŸ“ **æ—¥å¿—è®°å½• + ä»£ç ä¿®æ”¹æ¨¡å¼**ï¼š
- å°†ä¿®æ”¹è¿‡ç¨‹å’Œç»“æœè¯¦ç»†è®°å½•åˆ°å·¥ä½œæ—¥å¿—
- éµå¾ªä»£ç å¤–ç§‘æ‰‹æœ¯åè®®è¿›è¡Œç²¾ç¡®ä¿®æ”¹
- ç¡®ä¿ä¿®æ”¹çš„å¯è¿½æº¯æ€§å’Œå¯å›æ»šæ€§`,
                suffix: `
ğŸ“‹ **æ—¥å¿—è®°å½•æ ¼å¼**ï¼š
\`\`\`markdown
## ä»£ç ä¿®æ”¹è®°å½• - [æ—¶é—´]
### ä¿®æ”¹ç›®æ ‡ï¼š[å…·ä½“è¦è§£å†³çš„é—®é¢˜]
### ä¿®æ”¹æ–‡ä»¶ï¼š[æ¶‰åŠçš„æ–‡ä»¶åˆ—è¡¨]
### ä¿®æ”¹å†…å®¹ï¼š[å…·ä½“çš„ä¿®æ”¹ç‚¹]
### æµ‹è¯•éªŒè¯ï¼š[éªŒè¯ä¿®æ”¹æ­£ç¡®æ€§çš„æ–¹æ³•]
### å½±å“è¯„ä¼°ï¼š[å¯¹å…¶ä»–æ¨¡å—çš„å½±å“]
### å¤‡æ³¨ï¼š[å…¶ä»–é‡è¦ä¿¡æ¯]
\`\`\`

ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šæ¯æ¬¡ä¿®æ”¹éƒ½è¦è®°å½•ï¼Œä¾¿äºåç»­é—®é¢˜è¿½æº¯`
            },
            'æ—¥å¿—-ä¸ç”Ÿæ•ˆ': {
                name: 'ğŸ“‹ æ—¥å¿—-ä¸ç”Ÿæ•ˆ',
                description: 'ç»“åˆå·¥ä½œæ—¥å¿—çš„é—®é¢˜è¯Šæ–­å’Œè§£å†³è®°å½•',
                category: 'log',
                prefix: `ğŸ“‹ **é—®é¢˜è¯Šæ–­ + æ—¥å¿—è®°å½•æ¨¡å¼**ï¼š
- ç³»ç»Ÿæ€§è¯Šæ–­ä»£ç ä¸ç”Ÿæ•ˆçš„åŸå› 
- è¯¦ç»†è®°å½•æ’æŸ¥è¿‡ç¨‹å’Œè§£å†³æ–¹æ¡ˆ
- å»ºç«‹é—®é¢˜è§£å†³çš„çŸ¥è¯†åº“`,
                suffix: `
ğŸ“ **é—®é¢˜è¯Šæ–­æ—¥å¿—æ ¼å¼**ï¼š
\`\`\`markdown
## é—®é¢˜è¯Šæ–­è®°å½• - [æ—¶é—´]
### é—®é¢˜æè¿°ï¼š[å…·ä½“çš„ä¸ç”Ÿæ•ˆç°è±¡]
### æ’æŸ¥è¿‡ç¨‹ï¼š
1. [æ£€æŸ¥é¡¹1] - [ç»“æœ]
2. [æ£€æŸ¥é¡¹2] - [ç»“æœ]
3. [æ£€æŸ¥é¡¹3] - [ç»“æœ]
### æ ¹å› åˆ†æï¼š[é—®é¢˜çš„æ ¹æœ¬åŸå› ]
### è§£å†³æ–¹æ¡ˆï¼š[å…·ä½“çš„è§£å†³æ­¥éª¤]
### éªŒè¯ç»“æœï¼š[ä¿®å¤åçš„éªŒè¯æƒ…å†µ]
### é¢„é˜²æªæ–½ï¼š[é¿å…ç±»ä¼¼é—®é¢˜çš„å»ºè®®]
\`\`\`

ğŸ¯ **ç»éªŒç§¯ç´¯**ï¼šæ¯æ¬¡è§£å†³çš„é—®é¢˜éƒ½æ˜¯å®è´µçš„ç»éªŒè´¢å¯Œ`
            },
            'æ—¥å¿—-æ–°åŠŸèƒ½': {
                name: 'ğŸš€ æ—¥å¿—-æ–°åŠŸèƒ½',
                description: 'éµå¾ªæœ€å°åŒ–åŸåˆ™çš„æ–°åŠŸèƒ½å¼€å‘è®°å½•',
                category: 'log',
                prefix: `ğŸš€ **æ–°åŠŸèƒ½å¼€å‘ + æ—¥å¿—è®°å½•æ¨¡å¼**ï¼š
- éµå¾ªæœ€å°åŒ–ä»£ç å®ç°åŸåˆ™
- è¯¦ç»†è®°å½•å¼€å‘è¿‡ç¨‹å’Œè®¾è®¡å†³ç­–
- ç¡®ä¿åŠŸèƒ½çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§`,
                suffix: `
ğŸ“‹ **æ–°åŠŸèƒ½å¼€å‘æ—¥å¿—æ ¼å¼**ï¼š
\`\`\`markdown
## æ–°åŠŸèƒ½å¼€å‘è®°å½• - [æ—¶é—´]
### åŠŸèƒ½éœ€æ±‚ï¼š[å…·ä½“çš„åŠŸèƒ½æè¿°]
### è®¾è®¡æ–¹æ¡ˆï¼š[æŠ€æœ¯å®ç°æ–¹æ¡ˆ]
### æœ€å°åŒ–åŸåˆ™ï¼š[å¦‚ä½•éµå¾ªæœ€å°åŒ–å®ç°]
### å¼€å‘è¿›åº¦ï¼š
- [x] [å®Œæˆçš„ä»»åŠ¡]
- [ ] [å¾…å®Œæˆçš„ä»»åŠ¡]
### æµ‹è¯•è®¡åˆ’ï¼š[åŠŸèƒ½éªŒè¯æ–¹æ³•]
### æ–‡æ¡£æ›´æ–°ï¼š[ç›¸å…³æ–‡æ¡£çš„æ›´æ–°]
\`\`\`

âš¡ **æœ€å°åŒ–åŸåˆ™**ï¼šåªå®ç°å¿…è¦åŠŸèƒ½ï¼Œé¿å…è¿‡åº¦è®¾è®¡`
            },
            'æ–°åŠŸèƒ½': {
                name: 'âœ¨ æ–°åŠŸèƒ½',
                description: 'ä¸¥æ ¼éµå¾ªæœ€å°åŒ–åŸåˆ™çš„æ–°åŠŸèƒ½å¼€å‘',
                category: 'feature',
                prefix: `âœ¨ **æœ€å°åŒ–æ–°åŠŸèƒ½å¼€å‘æ¨¡å¼**ï¼š
- ä¸¥æ ¼éµå¾ªæœ€å°åŒ–ä»£ç å®ç°åŸåˆ™
- åªå®ç°ç”¨æˆ·æ˜ç¡®è¦æ±‚çš„åŠŸèƒ½ï¼Œä¸æ·»åŠ é¢å¤–ç‰¹æ€§
- ä¼˜å…ˆä½¿ç”¨ç°æœ‰ç»„ä»¶å’Œæ¨¡å—ï¼Œé¿å…é‡å¤é€ è½®å­
- ç¡®ä¿æ–°åŠŸèƒ½ä¸ç°æœ‰æ¶æ„çš„å…¼å®¹æ€§`,
                suffix: `
ğŸ¯ **æœ€å°åŒ–å®ç°æ£€æŸ¥æ¸…å•**ï¼š
- [ ] åŠŸèƒ½éœ€æ±‚æ˜¯å¦æ˜ç¡®ä¸”å¿…è¦
- [ ] æ˜¯å¦å¤ç”¨äº†ç°æœ‰çš„ç»„ä»¶å’ŒæœåŠ¡
- [ ] æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„å¤æ‚æ€§
- [ ] æ˜¯å¦è€ƒè™‘äº†ä¸ç°æœ‰åŠŸèƒ½çš„é›†æˆ
- [ ] æ˜¯å¦æä¾›äº†åŸºæœ¬çš„é”™è¯¯å¤„ç†
- [ ] æ˜¯å¦åŒ…å«äº†å¿…è¦çš„ç”¨æˆ·åé¦ˆ

âš ï¸ **ä¸¥æ ¼çº¦æŸ**ï¼šä¸å¾—ä»»æ„å¢åŠ æŒ‡ä»¤ä»¥å¤–çš„åŠŸèƒ½ï¼Œä¿æŒå®ç°çš„ç²¾ç®€å’Œä¸“æ³¨`
            }
        };

        let currentEditingTemplate = null;

        // æ¨¡æ¿æ“ä½œå‡½æ•°
        function addNewTemplate() {
            currentEditingTemplate = null;
            document.getElementById('template-edit-title').textContent = 'ğŸ“ æ–°å¢æ¨¡æ¿';
            document.getElementById('template-name-input').value = '';
            document.getElementById('template-category-select').value = 'natural';
            document.getElementById('template-prefix-input').value = '';
            document.getElementById('template-suffix-input').value = '';
            document.getElementById('template-description-input').value = '';
            document.getElementById('template-edit-modal').style.display = 'block';
        }

        // æ—§çš„æ¨¡æ¿é€‰æ‹©å‡½æ•° - å·²è¿ç§»åˆ°æ¨¡æ¿é€‰æ‹©æœåŠ¡
        /*
        function toggleTemplateSelection(templateName) {
            // å·²æ›¿æ¢ä¸º templateSelectionService.toggleSelection()
            // ä¿ç•™æ­¤æ³¨é‡Šç”¨äºè®°å½•è¿ç§»
        }
        */

        function editTemplate(templateName) {
            const template = window.templateData[templateName];
            if (!template) {
                showMessage('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                return;
            }
            
            currentEditingTemplate = templateName;
            document.getElementById('template-edit-title').textContent = 'ğŸ“ ç¼–è¾‘æ¨¡æ¿';
            document.getElementById('template-name-input').value = template.name;
            document.getElementById('template-category-select').value = template.category;
            document.getElementById('template-prefix-input').value = template.prefix || '';
            document.getElementById('template-suffix-input').value = template.suffix || '';
            document.getElementById('template-description-input').value = template.description || '';
            document.getElementById('template-edit-modal').style.display = 'block';
        }

        function deleteTemplate(templateName) {
            const template = window.templateData[templateName];
            if (!template) {
                showMessage('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${template.name}" å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼`)) {
                delete window.templateData[templateName];
                showMessage(`ğŸ—‘ï¸ å·²åˆ é™¤æ¨¡æ¿: ${template.name}`, 2000);
                
                // é‡æ–°æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨
                setTimeout(() => {
                    initializeTemplateManagerContent();
                }, 100);
            }
        }

        function closeTemplateEditModal() {
            document.getElementById('template-edit-modal').style.display = 'none';
            currentEditingTemplate = null;
        }

        function saveTemplate() {
            const name = document.getElementById('template-name-input').value.trim();
            const category = document.getElementById('template-category-select').value;
            const prefix = document.getElementById('template-prefix-input').value.trim();
            const suffix = document.getElementById('template-suffix-input').value.trim();
            const description = document.getElementById('template-description-input').value.trim();
            
            if (!name) {
                showMessage('âŒ è¯·è¾“å…¥æ¨¡æ¿åç§°', 'error');
                return;
            }
            
            // å¦‚æœæ˜¯æ–°å¢æ¨¡æ¿ï¼Œç”Ÿæˆå”¯ä¸€ID
            const templateId = currentEditingTemplate || `custom-${Date.now()}`;
            
            window.templateData[templateId] = {
                name: name,
                description: description,
                category: category,
                prefix: prefix,
                suffix: suffix
            };
            
            const isNew = !currentEditingTemplate;
            showMessage(isNew ? 'âœ… æ¨¡æ¿å·²åˆ›å»º' : 'âœ… æ¨¡æ¿å·²æ›´æ–°', 2000);
            
            closeTemplateEditModal();
            
            // é‡æ–°æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨
            setTimeout(() => {
                initializeTemplateManagerContent();
            }, 100);
        }

        function importTemplates() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (typeof importedData === 'object' && importedData !== null) {
                                window.templateData = { ...window.templateData, ...importedData };
                                showMessage('ğŸ“¥ æ¨¡æ¿å¯¼å…¥æˆåŠŸ', 2000);
                                initializeTemplateManagerContent();
                } else {
                                throw new Error('Invalid JSON structure');
                            }
                        } catch (error) {
                            showMessage('âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                            console.error('å¯¼å…¥é”™è¯¯:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportTemplates() {
            try {
                const dataStr = JSON.stringify(window.templateData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `templates_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showMessage('ğŸ“¤ æ¨¡æ¿å·²å¯¼å‡º', 2000);
            } catch (error) {
                showMessage('âŒ å¯¼å‡ºå¤±è´¥', 'error');
                console.error('å¯¼å‡ºé”™è¯¯:', error);
            }
        }

        // æ—§çš„æ¨¡æ¿åˆ—è¡¨æ›´æ–°å‡½æ•° - å·²è¿ç§»åˆ°æ¨¡æ¿é€‰æ‹©æœåŠ¡
        /*
        function updateSelectedTemplatesList() {
            // å·²æ›¿æ¢ä¸º templateSelectionService.updateDisplay()
            // ä¿ç•™æ­¤æ³¨é‡Šç”¨äºè®°å½•è¿ç§»
        }
        */

        // åŒæ­¥æ¨¡æ¿ç®¡ç†å™¨ä¸­çš„é€‰ä¸­çŠ¶æ€æ˜¾ç¤º
        function syncTemplateManagerSelection() {
            // æ¸…é™¤æ‰€æœ‰æ¨¡æ¿å¡ç‰‡çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // ä¸ºå·²é€‰ä¸­çš„æ¨¡æ¿æ·»åŠ é€‰ä¸­çŠ¶æ€
            selectedTemplates.forEach(template => {
                const templateCard = document.querySelector(`[data-template-id="${template.id}"]`);
                if (templateCard) {
                    templateCard.classList.add('selected');
                }
            });
        }

        // ä½¿ç”¨é€‰ä¸­çš„æ¨¡æ¿
        function useSelectedTemplate(templateId) {
            const template = selectedTemplates.find(t => t.id === templateId);
            if (!template) {
                showMessage('æ¨¡æ¿ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // æ„é€ æ³¨å…¥æ–‡æœ¬ - å¼ºåˆ¶åŒ…å«å…¨å±€æ¨¡å—åŒ–çº¦æŸ
            let injectionText = '';
            
            // 1. å…¨å±€æ¨¡å—åŒ–å‰ç¼€ï¼ˆå¼ºåˆ¶ï¼‰
            injectionText += GLOBAL_MODULAR_PREFIX;
            
            // 2. æ¨¡æ¿ç‰¹å®šå‰ç¼€
            if (template.prefix) {
                injectionText += template.prefix;
            }
            
            // 3. åˆ†éš”ç¬¦ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
            if (template.suffix) {
                injectionText += '\n\n';
            }
            
            // 4. æ¨¡æ¿ç‰¹å®šåç¼€
            if (template.suffix) {
                injectionText += template.suffix;
            }
            
            // 5. å…¨å±€æ¨¡å—åŒ–åç¼€ï¼ˆå¼ºåˆ¶ï¼‰
            injectionText += GLOBAL_MODULAR_SUFFIX;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            if (navigator.clipboard && injectionText.trim()) {
                navigator.clipboard.writeText(injectionText).then(() => {
                    showMessage('ğŸ“‹ æ¨¡æ¿å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆå«å¼ºåˆ¶æ¨¡å—åŒ–çº¦æŸï¼‰', 2000);
                }).catch(() => {
                });
            } else if (injectionText.trim()) {
                showMessage('æ¨¡æ¿å†…å®¹å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆå«å¼ºåˆ¶æ¨¡å—åŒ–çº¦æŸï¼‰', 2000);
            }
            
        }

        // ç§»é™¤é€‰ä¸­çš„æ¨¡æ¿
        function removeSelectedTemplate(templateId) {
            const index = selectedTemplates.findIndex(t => t.id === templateId);
            if (index > -1) {
                const template = selectedTemplates[index];
                selectedTemplates.splice(index, 1);
                
                // åŒæ­¥ç§»é™¤æ¨¡æ¿ç®¡ç†å™¨ä¸­çš„é€‰ä¸­çŠ¶æ€
                const templateCard = document.querySelector(`[data-template-id="${templateId}"]`);
                if (templateCard) {
                    templateCard.classList.remove('selected');
                }
                
                showMessage(`ğŸ—‘ï¸ å·²ç§»é™¤æ¨¡æ¿: ${template.name}`, 1500);
                updateSelectedTemplatesList();
            }
        }

        // æ ‡ç­¾è¿‡æ»¤åŠŸèƒ½
        let activeFilters = ['all']; // å½“å‰æ¿€æ´»çš„è¿‡æ»¤å™¨

        function toggleFilterTag(tagElement) {
            const category = tagElement.getAttribute('data-category');
            
            if (category === 'all') {
                // ç‚¹å‡»"å…¨éƒ¨"æ ‡ç­¾
                if (!tagElement.classList.contains('active')) {
                    // æ¸…é™¤æ‰€æœ‰å…¶ä»–æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.filter-tag').forEach(tag => {
                        tag.classList.remove('active');
                        tag.style.background = '#f8f9fa';
                        tag.style.color = '#495057';
                        tag.style.borderColor = '#dee2e6';
                    });
                    
                    // æ¿€æ´»"å…¨éƒ¨"æ ‡ç­¾
                    tagElement.classList.add('active');
                    activeFilters = ['all'];
                    
                    // æ˜¾ç¤ºæ‰€æœ‰æ¨¡æ¿
                    filterTemplates();
                    showMessage('ğŸ·ï¸ æ˜¾ç¤ºå…¨éƒ¨æ¨¡æ¿', 1500);
                }
            } else {
                // ç‚¹å‡»å…·ä½“åˆ†ç±»æ ‡ç­¾
                if (tagElement.classList.contains('active')) {
                    // å–æ¶ˆé€‰æ‹©è¯¥æ ‡ç­¾
                    tagElement.classList.remove('active');
                    tagElement.style.background = '#f8f9fa';
                    tagElement.style.color = '#495057';
                    tagElement.style.borderColor = '#dee2e6';
                    
                    // ä»æ¿€æ´»è¿‡æ»¤å™¨ä¸­ç§»é™¤
                    activeFilters = activeFilters.filter(f => f !== category);
                    
                    // å¦‚æœæ²¡æœ‰ä»»ä½•æ ‡ç­¾æ¿€æ´»ï¼Œæ¿€æ´»"å…¨éƒ¨"
                    if (activeFilters.length === 0 || activeFilters.includes('all')) {
                        const allTag = document.querySelector('.filter-tag[data-category="all"]');
                        allTag.classList.add('active');
                        activeFilters = ['all'];
                    }
                } else {
                    // é€‰æ‹©è¯¥æ ‡ç­¾
                    // å…ˆå–æ¶ˆ"å…¨éƒ¨"æ ‡ç­¾
                    const allTag = document.querySelector('.filter-tag[data-category="all"]');
                    if (allTag.classList.contains('active')) {
                        allTag.classList.remove('active');
                        allTag.style.background = '#f8f9fa';
                        allTag.style.color = '#495057';
                        allTag.style.borderColor = '#dee2e6';
                        activeFilters = [];
                    }
                    
                    // æ¿€æ´»å½“å‰æ ‡ç­¾
                    tagElement.classList.add('active');
                    activeFilters.push(category);
                }
                
                filterTemplates();
                showMessage(`ğŸ·ï¸ å·²é€‰æ‹©: ${getFilterDisplayNames()}`, 1500);
            }
        }

        function filterTemplates() {
            const allCards = document.querySelectorAll('.template-card');
            
            allCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                
                if (activeFilters.includes('all') || activeFilters.includes(cardCategory)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        function getFilterDisplayNames() {
            const nameMap = {
                'all': 'å…¨éƒ¨',
                'natural': 'è‡ªç„¶æ¨¡å¼',
                'code': 'ä»£ç ç±»',
                'log': 'æ—¥å¿—ç±»',
                'feature': 'æ–°åŠŸèƒ½ç±»'
            };
            
            return activeFilters.map(f => nameMap[f]).join(', ');
        }

        // è·å–å½“å‰æ´»è·ƒçš„jsMindå®ä¾‹
        function getCurrentJsMind() {
            return mindmaps[currentMindmap];
        }

        // åˆ‡æ¢æ€ç»´å¯¼å›¾æ ‡ç­¾é¡µ
        function switchMindmapTab(mapId) {
            
            // éšè—æ‰€æœ‰å®¹å™¨å’Œæ ‡ç­¾å†…å®¹
            ['workspace', 'knowledge', 'project'].forEach(id => {
                const container = document.getElementById(`jsmind_container_${id}`);
                const tabContent = document.getElementById(`mindmap-tab-${id}`);
                if (container) container.style.display = 'none';
                if (tabContent) {
                    tabContent.style.display = 'none';
                    tabContent.classList.remove('active');
                }
            });
            
            // æ˜¾ç¤ºç›®æ ‡å®¹å™¨å’Œæ ‡ç­¾å†…å®¹
            const targetContainer = document.getElementById(`jsmind_container_${mapId}`);
            const targetTabContent = document.getElementById(`mindmap-tab-${mapId}`);
            if (targetContainer && targetTabContent) {
                targetContainer.style.display = 'block';
                targetTabContent.style.display = 'block';
                targetTabContent.classList.add('active');
                
                // è°ƒæ•´æ€ç»´å¯¼å›¾å¤§å°å¹¶é‡æ–°å¸ƒå±€
                const instance = mindmaps[mapId];
                if (instance) {
                    setTimeout(() => {
                        instance.resize();
                        // å¯¹äºæ ‡ç­¾ç®¡ç†ï¼Œå¼ºåˆ¶é‡æ–°æ˜¾ç¤ºä»¥ä¿®å¤å¸ƒå±€é—®é¢˜
                        if (mapId === 'workspace') {
                            instance.show(mindmapData.workspace);
                        }
                    }, 100);
                }
            }
            
            // æ›´æ–°æ ‡ç­¾UI
            document.querySelectorAll('.mindmap-tab-button').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`[data-tab="${mapId}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            currentMindmap = mapId;
        }

        // è‡ªåŠ¨ä¿å­˜æ•°æ®
        function autoSaveData() {
            try {
                // ä¿å­˜æ€ç»´å¯¼å›¾æ•°æ®
                const mindmapDataToSave = {
                    workspace: mindmaps.workspace ? mindmaps.workspace.get_data() : mindmapData.workspace,
                    knowledge: mindmaps.knowledge ? mindmaps.knowledge.get_data() : mindmapData.knowledge,
                    project: mindmaps.project ? mindmaps.project.get_data() : mindmapData.project
                };
                
                localStorage.setItem(STORAGE_KEYS.MINDMAP_DATA, JSON.stringify(mindmapDataToSave));
                localStorage.setItem(STORAGE_KEYS.NODE_DATABASE, JSON.stringify(nodeDatabase));
                localStorage.setItem(STORAGE_KEYS.PROJECT_INFO, JSON.stringify(projectInfo));
                localStorage.setItem(STORAGE_KEYS.SELECTED_NODE, selectedNodeId || '');
                
                // *** å…³é”®ä¿®å¤ï¼šåŒæ—¶ä¿å­˜ä¼šè¯æ•°æ® ***
                localStorage.setItem('nodemind_sessions', JSON.stringify(sessionDatabase));
                
                // ä¿å­˜å››ç»„ä»¶æ•°æ®
                saveFourComponentData();
                
                return true;
            } catch (error) {
                console.error('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                showMessage('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥: ' + error.message, 3000);
                return false;
            }
        }
        
        // åŠ è½½ä¿å­˜çš„æ•°æ®
        function loadSavedData() {
            try {
                // åŠ è½½æ€ç»´å¯¼å›¾æ•°æ®
                const savedMindmapData = localStorage.getItem(STORAGE_KEYS.MINDMAP_DATA);
                if (savedMindmapData) {
                    const parsedData = JSON.parse(savedMindmapData);
                    Object.assign(mindmapData, parsedData);
                }
                
                // åŠ è½½èŠ‚ç‚¹æ•°æ®åº“
                const savedNodeDatabase = localStorage.getItem(STORAGE_KEYS.NODE_DATABASE);
                if (savedNodeDatabase) {
                    nodeDatabase = JSON.parse(savedNodeDatabase);
                }
                
                // *** å…³é”®ä¿®å¤ï¼šåŠ è½½ä¼šè¯æ•°æ® ***
                const savedSessionData = localStorage.getItem('nodemind_sessions');
                if (savedSessionData) {
                    sessionDatabase = JSON.parse(savedSessionData);
                } else {
                    sessionDatabase = {};
                }
                
                // åŠ è½½é¡¹ç›®ä¿¡æ¯
                const savedProjectInfo = localStorage.getItem(STORAGE_KEYS.PROJECT_INFO);
                if (savedProjectInfo) {
                    Object.assign(projectInfo, JSON.parse(savedProjectInfo));
                }
                
                // åŠ è½½é€‰ä¸­èŠ‚ç‚¹
                const savedSelectedNode = localStorage.getItem(STORAGE_KEYS.SELECTED_NODE);
                if (savedSelectedNode) {
                    selectedNodeId = savedSelectedNode;
                }
                
                // åŠ è½½å››ç»„ä»¶æ•°æ®
                loadFourComponentData();
                
                // å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ç®¡ç†æ›´æ–°ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
                setTimeout(() => {
                    updateTaskManagement();
                }, 500);
                
                // æ¢å¤å››ç»„ä»¶å…¨å±€çŠ¶æ€
                setTimeout(() => {
                    restoreFourComponentGlobalState();
                }, 600);
                
                return true;
            } catch (error) {
                console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
                return false;
            }
        }
        
        // (é‡å¤çš„ç®€å•ç‰ˆshowMessageå·²åˆ é™¤ - ä¿ç•™æ”¯æŒæ¶ˆæ¯ç±»å‹çš„å®Œæ•´ç‰ˆ)
        
        // è®¾ç½®è‡ªåŠ¨ä¿å­˜
        function setupAutoSave() {
            // å®šæ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
            setInterval(autoSaveData, 30000);
            
            // é¡µé¢å…³é—­å‰ä¿å­˜
            window.addEventListener('beforeunload', function(e) {
                autoSaveData();
            });
            
            // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
            window.addEventListener('blur', function() {
                autoSaveData();
            });
            
        }
        
        // åˆå§‹åŒ–æ ‡ç­¾ç®¡ç†åŠŸèƒ½
        function initializeTagManagement(nodeId) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData) return;
            
            // ç¡®ä¿æ ‡ç­¾æ•°æ®ç»“æ„å­˜åœ¨
            if (!nodeData.tags) {
                nodeData.tags = { categories: [], technical: [], status: [] };
            }
            
            // æŸ¥æ‰¾æ ‡ç­¾å®¹å™¨
            const tagContainer = document.getElementById(`tag-groups-container-${nodeId}`);
            
            if (tagContainer) {
                // ç”Ÿæˆæ ‡ç­¾HTML
                const html = generateTagGroupsHTML();
                tagContainer.innerHTML = html;
                
                // ä¸ºæ‰€æœ‰æ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const insertedTags = tagContainer.querySelectorAll('.tag-item');
                insertedTags.forEach((tagItem) => {
                    tagItem.addEventListener('click', function() {
                        toggleTag(nodeId, this);
                    });
                });
                
                // æ¢å¤å·²é€‰ä¸­çš„æ ‡ç­¾çŠ¶æ€
                restoreTagStates(nodeId);
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©çŠ¶æ€
        function toggleTag(nodeId, tagElement) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData) return;
            
            const tagName = tagElement.dataset.tag;
            const tagGroup = tagElement.dataset.group;
            
            // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            if (tagElement.classList.contains('selected')) {
                // å–æ¶ˆé€‰ä¸­
                tagElement.classList.remove('selected');
                removeTagFromNode(nodeData, tagName, tagGroup);
                showMessage(`ğŸ·ï¸ å·²ç§»é™¤æ ‡ç­¾ï¼š${tagName}`);
            } else {
                // é€‰ä¸­
                tagElement.classList.add('selected');
                addTagToNode(nodeData, tagName, tagGroup);
                showMessage(`ğŸ·ï¸ å·²æ·»åŠ æ ‡ç­¾ï¼š${tagName}`);
            }
            
            // æ›´æ–°ä¿®æ”¹æ—¶é—´
            nodeData.modified = new Date().toISOString();
            
            // è‡ªåŠ¨ä¿å­˜
            setTimeout(autoSaveData, 500);
            
            // æ›´æ–°ä»»åŠ¡ç®¡ç†æ˜¾ç¤º
            updateTaskManagement();
        }
        
        // å°†æ ‡ç­¾æ·»åŠ åˆ°èŠ‚ç‚¹
        function addTagToNode(nodeData, tagName, tagGroup) {
            // æ ¹æ®æ ‡ç­¾ç»„åˆ†ç±»å­˜å‚¨
            let targetArray;
            switch(tagGroup) {
                case 'å¸¸è§„':
                    targetArray = nodeData.tags.status;
                    break;
                case 'AI':
                    targetArray = nodeData.tags.technical;
                    break;
                case 'ç¬”è®°':
                    targetArray = nodeData.tags.categories;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            // é¿å…é‡å¤æ·»åŠ 
            if (!targetArray.includes(tagName)) {
                targetArray.push(tagName);
            }
        }
        
        // ä»èŠ‚ç‚¹ç§»é™¤æ ‡ç­¾
        function removeTagFromNode(nodeData, tagName, tagGroup) {
            // æ ¹æ®æ ‡ç­¾ç»„åˆ†ç±»ç§»é™¤
            let targetArray;
            switch(tagGroup) {
                case 'å¸¸è§„':
                    targetArray = nodeData.tags.status;
                    break;
                case 'AI':
                    targetArray = nodeData.tags.technical;
                    break;
                case 'ç¬”è®°':
                    targetArray = nodeData.tags.categories;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            const index = targetArray.indexOf(tagName);
            if (index > -1) {
                targetArray.splice(index, 1);
            }
        }
        
        // æ¢å¤æ ‡ç­¾é€‰ä¸­çŠ¶æ€
        function restoreTagStates(nodeId) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData || !nodeData.tags) return;
            
            // è·å–æ‰€æœ‰å·²é€‰ä¸­çš„æ ‡ç­¾
            const allSelectedTags = [
                ...nodeData.tags.status,
                ...nodeData.tags.technical,
                ...nodeData.tags.categories
            ];
            
            // æ¢å¤UIä¸­çš„é€‰ä¸­çŠ¶æ€ï¼ˆé™å®šåœ¨å½“å‰èŠ‚ç‚¹çš„æ ‡ç­¾å®¹å™¨å†…ï¼‰
            const tagContainer = document.getElementById(`tag-groups-container-${nodeId}`);
            if (tagContainer) {
                const tagItems = tagContainer.querySelectorAll('.tag-item');
                tagItems.forEach(tagItem => {
                    const tagName = tagItem.dataset.tag;
                    if (allSelectedTags.includes(tagName)) {
                        tagItem.classList.add('selected');
                    }
                });
            }
        }
        
        // è§¦å‘æ–‡ä»¶å¯¼å…¥
        function triggerImportFile() {
            const fileInput = document.getElementById('import_file_input');
            if (fileInput) {
                fileInput.click();
                showMessage('ğŸ“‚ è¯·é€‰æ‹©è¦å¯¼å…¥çš„è„‘å›¾æ–‡ä»¶');
            }
        }
        
        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showMessage('ğŸ“‚ æ­£åœ¨å¯¼å…¥æ–‡ä»¶: ' + file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedData = null;
                    
                    // è§£æJSONæ–‡ä»¶
                    importedData = JSON.parse(content);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´å¯¼å‡ºæ ¼å¼ï¼ˆåŒ…å«nodeDetailsï¼‰
                    if (importedData.mindmap && importedData.nodeDetails) {
                        
                        // æ¢å¤èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æ•°æ®åº“
                        Object.assign(nodeDatabase, importedData.nodeDetails);
                        
                        // ä½¿ç”¨æ€ç»´å¯¼å›¾æ•°æ®
                        importedData = importedData.mindmap;
                    }
                    
                    // éªŒè¯å¯¼å…¥æ•°æ®æ ¼å¼
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('æ— æ•ˆçš„æ–‡ä»¶æ ¼å¼');
                    }
                    
                    // æ£€æŸ¥å¿…è¦çš„æ•°æ®ç»“æ„
                    if (!importedData.data || !importedData.data.id) {
                        throw new Error('æ–‡ä»¶ç¼ºå°‘å¿…è¦çš„æ€ç»´å¯¼å›¾æ•°æ®ç»“æ„');
                    }
                    
                    // æ˜¾ç¤ºå¯¼å…¥çš„æ€ç»´å¯¼å›¾åˆ°é¡¹ç›®ç®¡ç†é¢æ¿
                    const projectMindmap = mindmaps['project'];
                    if (projectMindmap) {
                        projectMindmap.show(importedData);
                        
                        // åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“
                        const rootNode = projectMindmap.get_node(importedData.data.id);
                        if (rootNode) {
                            traverseAndInitNodes(rootNode);
                        }
                        
                        // è‡ªåŠ¨ä¿å­˜å¯¼å…¥çš„æ•°æ®
                        setTimeout(autoSaveData, 500);
                        
                        showMessage('âœ… æ–‡ä»¶å¯¼å…¥æˆåŠŸ: ' + file.name);
                    } else {
                        throw new Error('é¡¹ç›®ç®¡ç†æ€ç»´å¯¼å›¾æœªåˆå§‹åŒ–');
                    }
                    
                } catch (error) {
                    console.error('âŒ æ–‡ä»¶å¯¼å…¥å¤±è´¥:', error);
                    showMessage('âŒ æ–‡ä»¶å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }
        
        // éå†å¹¶åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“
        function traverseAndInitNodes(node) {
            if (!node) return;
            
            // ä¸ºèŠ‚ç‚¹åˆ›å»ºæ•°æ®åº“è®°å½•
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: node.topic,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                };
            }
            
            // é€’å½’å¤„ç†å­èŠ‚ç‚¹
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    traverseAndInitNodes(child);
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            
            // å»¶è¿Ÿåˆå§‹åŒ–ç¡®ä¿DOMå‡†å¤‡å®Œæ¯•
            setTimeout(() => {
                // åŠ è½½ä¿å­˜çš„æ•°æ®
                loadSavedData();
                
                // åˆå§‹åŒ–æ€ç»´å¯¼å›¾
                initMindmaps();
                
                // è®¾ç½®è‡ªåŠ¨ä¿å­˜
                setupAutoSave();
                
                // åˆå§‹åŒ–æ ‡ç­¾ç»„ä»¶ï¼ˆä»æ ‡ç­¾ç®¡ç†è„‘å›¾åŠ è½½ï¼‰
                setTimeout(() => {
                    initializeTagsFromMindmap();
                }, 500); // ç»™è„‘å›¾æ›´å¤šæ—¶é—´å®Œæˆåˆå§‹åŒ–
                
                // ç»‘å®šæ€ç»´å¯¼å›¾æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
                document.getElementById('tab_button_workspace')?.addEventListener('click', () => {
                    switchMindmapTab('workspace');
                    // å»¶è¿Ÿåˆå§‹åŒ–åˆ†ç±»ç®¡ç†ç³»ç»Ÿ
                    setTimeout(() => {
                        if (typeof initializeCategoryManagementSystem === 'function') {
                            initializeCategoryManagementSystem();
                        }
                    }, 300);
                });
                document.getElementById('tab_button_knowledge')?.addEventListener('click', () => switchMindmapTab('knowledge'));
                document.getElementById('tab_button_project')?.addEventListener('click', () => switchMindmapTab('project'));
                
                // ç»‘å®šè¯¦æƒ…é¢æ¿æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
    
                document.getElementById('detail_tab_injection')?.addEventListener('click', () => switchDetailTab('injection'));
                document.getElementById('detail_tab_project')?.addEventListener('click', () => switchDetailTab('project'));
                
                            // ç»‘å®šå·¥å…·æ æŒ‰é’®äº‹ä»¶  
            document.getElementById('show_guide_button')?.addEventListener('click', showUserGuide);
            document.getElementById('export_custom_file_button')?.addEventListener('click', () => {
                // ğŸ”„ ä¿®å¤ä¿å­˜åŠŸèƒ½ï¼šæä¾›æ ¼å¼é€‰æ‹©
                showSaveFormatDialog();
            });
            document.getElementById('import_file_button')?.addEventListener('click', async () => {
                // ç¬¬ä¸‰æ¬¡é‡æ„ï¼šä¸“é—¨ç”¨äºMDå¯¼å…¥ï¼Œä¸é™çº§åˆ°JSONå¯¼å…¥
                try {
                    
                    if (window.importMDDocument) {
                        const result = await window.importMDDocument();
                        if (result && result.success) {
                            showMessage(`âœ… MDæ–‡æ¡£å¯¼å…¥æˆåŠŸ: ${result.nodesCount} ä¸ªèŠ‚ç‚¹`);
                        } else {
                            throw new Error(result.error || 'å¯¼å…¥å¤±è´¥');
                        }
                    } else {
                        throw new Error('MDå¯¼å…¥åŠŸèƒ½æœªåˆå§‹åŒ–');
                    }
                } catch (error) {
                    console.error('âŒ [MDå¯¼å…¥å¤±è´¥]:', error);
                    showMessage(`âŒ MDæ–‡æ¡£å¯¼å…¥å¤±è´¥: ${error.message}`);
                    
                    // ä¸å†é™çº§åˆ°JSONå¯¼å…¥ï¼Œè€Œæ˜¯ç»™ç”¨æˆ·æ˜ç¡®çš„æç¤º
                    const userChoice = confirm('MDæ–‡æ¡£å¯¼å…¥å¤±è´¥ã€‚\n\n' + 
                        'å¯èƒ½åŸå› ï¼š\n' +
                        '1. æ–‡ä»¶æ ¼å¼ä¸ç¬¦åˆNodeMindæ ‡å‡†\n' +
                        '2. éœ€è¦å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œ\n\n' +
                        'æ˜¯å¦æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ï¼Ÿ');
                    
                    if (userChoice) {
                        alert('è§£å†³æ–¹æ¡ˆï¼š\n\n' +
                            '1. ç¡®ä¿é€‰æ‹©çš„æ˜¯MDæ ¼å¼æ–‡ä»¶\n' +
                            '2. å»ºè®®å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼š\n' +
                            '   - è¿è¡Œ: python -m http.server 8080\n' +
                            '   - æˆ–: npx http-server\n' +
                            '   - ç„¶åè®¿é—®: http://localhost:8080\n\n' +
                            '3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„å…·ä½“é”™è¯¯ä¿¡æ¯');
                    }
                }
            });
            document.getElementById('sync_tags_button')?.addEventListener('click', syncTagsFromWorkspace);
                
                // ç»‘å®šæ–‡ä»¶è¾“å…¥äº‹ä»¶
                document.getElementById('import_file_input')?.addEventListener('change', handleFileImport);
                
                // ç»‘å®šå³é”®èœå•äº‹ä»¶
                initializeContextMenu();
                
            }, 100);
        });

        // å³é”®èœå•ç›¸å…³åŠŸèƒ½
        let contextMenuTargetNode = null;
        let contextMenuTargetNodeId = null;
        
        // åˆå§‹åŒ–å³é”®èœå•
        function initializeContextMenu() {
            
            // ç»‘å®šå³é”®èœå•é¡¹ç‚¹å‡»äº‹ä»¶
            document.getElementById('context_menu_focus_node')?.addEventListener('click', focusNodeToWorkspace);
            document.getElementById('context_menu_sync')?.addEventListener('click', handleContextMenuSync);
            document.getElementById('context_menu_hide')?.addEventListener('click', hideContextMenu);
            
            // ç»‘å®šå…¨å±€ç‚¹å‡»äº‹ä»¶éšè—èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#contextMenu')) {
                    hideContextMenu();
                }
            });
            
            // ç»‘å®šæ€ç»´å¯¼å›¾å®¹å™¨çš„å³é”®äº‹ä»¶
            const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        
                        // æŸ¥æ‰¾è¢«å³é”®ç‚¹å‡»çš„èŠ‚ç‚¹
                        let nodeElement = e.target.closest('jmnode');
                        if (!nodeElement) {
                            nodeElement = e.target.closest('[nodeid]');
                        }
                        if (!nodeElement && e.target.hasAttribute('nodeid')) {
                            nodeElement = e.target;
                        }
                        
                        if (nodeElement) {
                            const nodeId = nodeElement.getAttribute('nodeid');
                            const mapId = containerId.replace('jsmind_container_', '');
                            const mindmap = mindmaps[mapId];
                            
                            if (mindmap && nodeId) {
                                const node = mindmap.get_node(nodeId);
                                if (node) {
                                    contextMenuTargetNode = node;
                                    contextMenuTargetNodeId = nodeId;
                                    
                                    // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºåŒæ­¥é€‰é¡¹
                                    const shouldShowSync = shouldShowSyncOption(node);
                                    updateContextMenuVisibility(shouldShowSync);
                                    
                                    showContextMenu(e.pageX, e.pageY);
                                }
                            }
                        }
                    });
                }
            });
            
        }
        
        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';

            // è°ƒæ•´èœå•ä½ç½®é¿å…è¶…å‡ºå±å¹•
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = `${x - rect.width}px`;
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = `${y - rect.height}px`;
            }
        }
        
        // éšè—å³é”®èœå•
        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'none';
            contextMenuTargetNode = null;
            contextMenuTargetNodeId = null;
        }
        
        // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ˜¾ç¤ºåŒæ­¥é€‰é¡¹
        function shouldShowSyncOption(node) {
            if (!node || !node.topic) return false;
            
            const topic = node.topic.toLowerCase();
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯"å½“å‰æ¨¡æ¿åˆ—è¡¨"æˆ–"æ ‡ç­¾ç®¡ç†"èŠ‚ç‚¹
            return topic.includes('å½“å‰æ¨¡æ¿åˆ—è¡¨') || 
                   topic.includes('æ ‡ç­¾ç®¡ç†') ||
                   topic === 'å½“å‰æ¨¡æ¿åˆ—è¡¨' ||
                   topic === 'æ ‡ç­¾ç®¡ç†';
        }
        
        // æ›´æ–°å³é”®èœå•é¡¹çš„å¯è§æ€§
        function updateContextMenuVisibility(showSync) {
            const syncItem = document.getElementById('context_menu_sync');
            const syncDivider = document.getElementById('context_menu_sync_divider');
            
            if (syncItem && syncDivider) {
                if (showSync) {
                    syncItem.style.display = 'block';
                    syncDivider.style.display = 'block';
                } else {
                    syncItem.style.display = 'none';
                    syncDivider.style.display = 'none';
                }
            }
        }
        
        // å¤„ç†å³é”®èœå•åŒæ­¥åŠŸèƒ½
        function handleContextMenuSync() {
            if (!contextMenuTargetNode) {
                hideContextMenu();
                return;
            }
            
            const topic = contextMenuTargetNode.topic.toLowerCase();
            
            if (topic.includes('å½“å‰æ¨¡æ¿åˆ—è¡¨') || topic === 'å½“å‰æ¨¡æ¿åˆ—è¡¨') {
                // æ¨¡æ¿åŒæ­¥
                syncTemplatesFromCurrentList();
            } else if (topic.includes('æ ‡ç­¾ç®¡ç†') || topic === 'æ ‡ç­¾ç®¡ç†') {
                // æ ‡ç­¾åŒæ­¥ï¼ˆè°ƒç”¨ç°æœ‰åŠŸèƒ½ï¼‰
                syncTagsFromWorkspace();
            }
            
            hideContextMenu();
        }
        
        // å°†ç„¦ç‚¹èŠ‚ç‚¹å¤åˆ¶åˆ°ä¸´æ—¶å·¥ä½œåŒº
        function focusNodeToWorkspace() {
            if (!contextMenuTargetNode) {
                hideContextMenu();
                return;
            }

            try {
                // ç®€åŒ–ç‰ˆæœ¬çš„èŠ‚ç‚¹å¤åˆ¶åŠŸèƒ½
                const nodeTree = {
                    id: contextMenuTargetNode.id + '_copy',
                    topic: contextMenuTargetNode.topic,
                    children: contextMenuTargetNode.children || []
                };

                const workspaceData = {
                    meta: { name: `ä¸´æ—¶å·¥ä½œåŒºA - ${contextMenuTargetNode.topic}`, author: "NodeMind", version: "1.0.0" },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.workspace.show(workspaceData);

                const knowledgeData = {
                    meta: { name: `ä¸´æ—¶å·¥ä½œåŒºB - ${contextMenuTargetNode.topic}`, author: "NodeMind", version: "1.0.0" },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.knowledge.show(knowledgeData);

                showMessage(`ğŸ”¬ å·²å°†ç„¦ç‚¹èŠ‚ç‚¹"${contextMenuTargetNode.topic}"å¤åˆ¶åˆ°ä¸´æ—¶å·¥ä½œåŒº`);

                hideContextMenu();

            } catch (error) {
                console.error('âŒ å¤åˆ¶èŠ‚ç‚¹åˆ°ä¸´æ—¶å·¥ä½œåŒºå¤±è´¥:', error);
                showMessage(`âŒ å¤åˆ¶å¤±è´¥: ${error.message}`);
                hideContextMenu();
            }
        }
        
        // ä»"å½“å‰æ¨¡æ¿åˆ—è¡¨"èŠ‚ç‚¹åŒæ­¥æ¨¡æ¿åˆ°å³ä¾§é¢æ¿
        function syncTemplatesFromCurrentList() {
            
            try {
                // æŸ¥æ‰¾"å½“å‰æ¨¡æ¿åˆ—è¡¨"èŠ‚ç‚¹
                let currentTemplateListNode = null;
                
                // åœ¨æ‰€æœ‰æ€ç»´å¯¼å›¾ä¸­æŸ¥æ‰¾
                Object.keys(mindmaps).forEach(mapId => {
                    const mindmap = mindmaps[mapId];
                    if (mindmap) {
                        const data = mindmap.get_data();
                        if (data && data.data) {
                            const foundNode = findNodeByTopic(data.data, 'å½“å‰æ¨¡æ¿åˆ—è¡¨');
                            if (foundNode) {
                                currentTemplateListNode = foundNode;
                            }
                        }
                    }
                });
                
                if (!currentTemplateListNode) {
                    showMessage('âŒ æœªæ‰¾åˆ°"å½“å‰æ¨¡æ¿åˆ—è¡¨"èŠ‚ç‚¹');
                    return;
                }
                
                // è·å–å­èŠ‚ç‚¹ä½œä¸ºæ¨¡æ¿åˆ—è¡¨
                const templateNodes = currentTemplateListNode.children || [];
                
                // æ›´æ–°å³ä¾§é¢æ¿çš„æ¨¡æ¿åˆ—è¡¨
                updateRightPanelTemplateList(templateNodes);
                
                showMessage(`âœ… å·²åŒæ­¥ ${templateNodes.length} ä¸ªæ¨¡æ¿åˆ°å³ä¾§é¢æ¿`);
                
            } catch (error) {
                console.error('âŒ æ¨¡æ¿åŒæ­¥å¤±è´¥:', error);
                showMessage(`âŒ æ¨¡æ¿åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }
        
        // é€’å½’æŸ¥æ‰¾æŒ‡å®šä¸»é¢˜çš„èŠ‚ç‚¹
        function findNodeByTopic(nodeData, targetTopic) {
            if (!nodeData) return null;
            
            // æ£€æŸ¥å½“å‰èŠ‚ç‚¹
            if (nodeData.topic && nodeData.topic.includes(targetTopic)) {
                return nodeData;
            }
            
            // é€’å½’æ£€æŸ¥å­èŠ‚ç‚¹
            if (nodeData.children && Array.isArray(nodeData.children)) {
                for (const child of nodeData.children) {
                    const found = findNodeByTopic(child, targetTopic);
                    if (found) return found;
                }
            }
            
            return null;
        }
        
        // æ›´æ–°å³ä¾§é¢æ¿çš„æ¨¡æ¿åˆ—è¡¨
        function updateRightPanelTemplateList(templateNodes) {
            const templatesContainer = document.querySelector('#inner-tab-templates .templates-container');
            if (!templatesContainer) {
                console.error('âŒ æœªæ‰¾åˆ°å³ä¾§æ¨¡æ¿åˆ—è¡¨å®¹å™¨');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            templatesContainer.innerHTML = '';
            
            // æ·»åŠ åŒæ­¥çš„æ¨¡æ¿
            templateNodes.forEach((templateNode, index) => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                templateItem.setAttribute('data-template-id', templateNode.id || `template_${index}`);
                
                // åˆ›å»ºæ¨¡æ¿é¡¹HTML
                templateItem.innerHTML = `
                    <div class="template-title">${getTemplateIcon(templateNode.topic)} ${templateNode.topic}</div>
                    <div class="template-desc">${getTemplateDescription(templateNode.topic)}</div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                templateItem.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–é¡¹çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.template-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // æ·»åŠ å½“å‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                    templateItem.classList.add('selected');
                    
                    showMessage(`âœ… å·²é€‰ä¸­æ¨¡æ¿: ${templateNode.topic}`);
                });
                
                templatesContainer.appendChild(templateItem);
            });
            
        }
        
        // æ ¹æ®æ¨¡æ¿åç§°è·å–å›¾æ ‡
        function getTemplateIcon(templateName) {
            const iconMap = {
                'è‡ªç„¶æ¨¡å¼': 'ğŸ—£ï¸',
                'ä»£ç è‡ªæŸ¥': 'ğŸ”',
                'ä¿®æ”¹ä»£ç ': 'âš¡',
                'ä¸ç”Ÿæ•ˆ': 'âŒ',
                'æ—¥å¿—-ä¿®æ”¹ä»£ç ': 'ğŸ“',
                'æ–°åŠŸèƒ½': 'âœ¨'
            };
            
            for (const [key, icon] of Object.entries(iconMap)) {
                if (templateName.includes(key)) {
                    return icon;
                }
            }
            
            return 'ğŸ“‹'; // é»˜è®¤å›¾æ ‡
        }
        
        // æ ¹æ®æ¨¡æ¿åç§°è·å–æè¿°
        function getTemplateDescription(templateName) {
            const descMap = {
                'è‡ªç„¶æ¨¡å¼': 'å¸¸è§„å¯¹è¯æ¨¡å¼ï¼ŒæŒ‡å‘é¡¹ç›®æ—¥å¿—æ–‡æ¡£',
                'ä»£ç è‡ªæŸ¥': 'ä»£ç è´¨é‡æ£€æŸ¥å’Œé—®é¢˜æ’æŸ¥',
                'ä¿®æ”¹ä»£ç ': 'åŒ…å«å®Œæ•´çš„ä»£ç å¤–ç§‘æ‰‹æœ¯åè®®',
                'ä¸ç”Ÿæ•ˆ': 'ä»£ç ä¿®æ”¹ä¸ç”Ÿæ•ˆé—®é¢˜è¯Šæ–­',
                'æ—¥å¿—-ä¿®æ”¹ä»£ç ': 'ç»“åˆä»£ç å¤–ç§‘æ‰‹æœ¯åè®®å’Œå·¥ä½œæ—¥å¿—è®°å½•',
                'æ–°åŠŸèƒ½': 'éµå¾ªæœ€å°åŒ–ä»£ç å®ç°åŸåˆ™çš„æ–°åŠŸèƒ½å¼€å‘'
            };
            
            for (const [key, desc] of Object.entries(descMap)) {
                if (templateName.includes(key)) {
                    return desc;
                }
            }
            
            return 'ä»å½“å‰æ¨¡æ¿åˆ—è¡¨åŒæ­¥çš„æ¨¡æ¿'; // é»˜è®¤æè¿°
        }

        // ç»‘å®šè¯¦æƒ…è¾“å…¥äº‹ä»¶
        function bindDetailInputEvents(nodeId) {
            const titleInput = document.getElementById(`node-title-${nodeId}`);
            const contentInput = document.getElementById(`node-content-${nodeId}`);
            const authorInput = document.getElementById(`node-author-${nodeId}`);
            
            // æ ‡é¢˜è¾“å…¥å®æ—¶è”åŠ¨
            if (titleInput) {
                titleInput.addEventListener('input', function() {
                    updateNodeTitle(nodeId, this.value);
                    setTimeout(autoSaveData, 500);
                });
                titleInput.addEventListener('blur', function() {
                    autoSaveData();
                });
            }
            
            // å†…å®¹å’Œä½œè€…è¾“å…¥äº‹ä»¶
            [contentInput, authorInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        setTimeout(autoSaveData, 500);
                    });
                    input.addEventListener('blur', function() {
                        autoSaveData();
                    });
                }
            });
        }

        // æ˜¾ç¤ºä½¿ç”¨æŒ‡å—
        function showUserGuide() {
            var guideContent = `
                <h3>ğŸ“– NodeMind æ“ä½œæŒ‡å—</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <h4>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</h4>
                        <ul>
                            <li>å•å‡»èŠ‚ç‚¹é€‰ä¸­</li>
                            <li>åŒå‡»èŠ‚ç‚¹ç¼–è¾‘å†…å®¹</li>
                            <li>æ‹–æ‹½ç”»å¸ƒç§»åŠ¨è§†å›¾</li>
                            <li>æ»šè½®ç¼©æ”¾æ€ç»´å¯¼å›¾</li>
                        </ul>
                    </div>
                    <div>
                        <h4>âŒ¨ï¸ å¿«æ·é”®æ“ä½œ</h4>
                        <ul>
                            <li>Ctrl+Enter - æ·»åŠ å­èŠ‚ç‚¹</li>
                            <li>Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹</li>
                            <li>F2 - ç¼–è¾‘èŠ‚ç‚¹å†…å®¹</li>
                            <li>Delete - åˆ é™¤èŠ‚ç‚¹</li>
                            <li>Space - å±•å¼€/æ”¶èµ·èŠ‚ç‚¹</li>
                            <li>æ–¹å‘é”® - é€‰æ‹©ç›¸é‚»èŠ‚ç‚¹</li>
                        </ul>
                    </div>
                    <div>
                        <h4>ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</h4>
                        <ul>
                            <li>é€‰ä¸­èŠ‚ç‚¹ååœ¨è¯¦æƒ…é¢æ¿ç®¡ç†æ ‡ç­¾</li>
                            <li>æ”¯æŒå¸¸è§„ã€AIã€ç¬”è®°ä¸‰ç±»æ ‡ç­¾</li>
                            <li>ç‚¹å‡»æ ‡ç­¾é€‰æ‹©/å–æ¶ˆé€‰æ‹©</li>
                            <li>æ ‡ç­¾è‡ªåŠ¨åŒæ­¥åˆ°æ€ç»´å¯¼å›¾</li>
                        </ul>
                    </div>
                    <div>
                        <h4>ğŸ’¾ æ–‡ä»¶æ“ä½œ</h4>
                        <ul>
                            <li>ğŸ’¾ ä¿å­˜ - ä¿å­˜å½“å‰è„‘å›¾åˆ°æœ¬åœ°</li>
                            <li>ğŸ“‚ å¯¼å…¥æ–‡ä»¶ - åŠ è½½æœ¬åœ°è„‘å›¾æ–‡ä»¶</li>
                            <li>âœ¨ æ–°è„‘å›¾ - åˆ›å»ºæ–°çš„æ€ç»´å¯¼å›¾</li>
                            <li>ğŸ”„ æ ‡ç­¾åŒæ­¥ - ä»æ ‡ç­¾ç®¡ç†åŒºè¯»å–æ ‡ç­¾</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;justify-content:center;align-items:center;';
            
            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:white;border-radius:8px;padding:25px;max-width:80%;max-height:80%;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.3);';
            modalContent.innerHTML = guideContent;
            
            var closeButton = document.createElement('button');
            closeButton.textContent = 'å…³é—­';
            closeButton.style.cssText = 'margin-top:20px;padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;';
            closeButton.onclick = function() {
                document.body.removeChild(modal);
            };
            
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            showMessage('ğŸ“– æ˜¾ç¤ºä½¿ç”¨æŒ‡å—');
        }
        
        // ä¿å­˜å½“å‰é¡¹ç›®ç®¡ç†è„‘å›¾åˆ°æœ¬åœ°
        async function saveProjectMindmap() {
            try {
                // è·å–é¡¹ç›®ç®¡ç†é€‰é¡¹å¡çš„æ€ç»´å¯¼å›¾æ•°æ®
                const projectMindmap = mindmaps['project'];
                if (!projectMindmap) {
                    showMessage('âŒ é¡¹ç›®ç®¡ç†è„‘å›¾æœªåˆå§‹åŒ–');
                    return;
                }
                
                const mind_data = projectMindmap.get_data();
                if (!mind_data) {
                    showMessage('âŒ æ— æ•°æ®å¯ä¿å­˜');
                    return;
                }
                
                // æ„å»ºä¿å­˜æ•°æ®ï¼ŒåŒ…å«æ€ç»´å¯¼å›¾å’ŒèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind",
                        export_type: "project_save",
                        tab: "project"
                    }
                };
                
                var dataStr = JSON.stringify(exportData, null, 2);
                var fileName = 'NodeMind-é¡¹ç›®ç®¡ç†-' + new Date().toISOString().slice(0,10) + '.json';
                
                showMessage('ğŸ’¾ æ­£åœ¨ä¿å­˜é¡¹ç›®ç®¡ç†è„‘å›¾...');
                
                // ğŸ”’ å¼ºåˆ¶ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ä¿å­˜ï¼ˆä¸é™çº§åˆ°ä¸‹è½½æ¨¡å¼ï¼‰
                await saveWithFileSystemAPI(dataStr, fileName);
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å¤±è´¥:', error);
                showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // ä½¿ç”¨ç°ä»£æ–‡ä»¶ç³»ç»ŸAPIä¿å­˜
        async function saveWithFileSystemAPI(content, fileName) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'NodeMindæ€ç»´å¯¼å›¾æ–‡ä»¶',
                            accept: {
                                'application/json': ['.json']
                            }
                        }
                    ]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                showMessage('âœ… æ–‡ä»¶å·²æˆåŠŸä¿å­˜åˆ°æŒ‡å®šä½ç½®');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜');
                } else {
                    console.error('âŒ æ–‡ä»¶é€‰æ‹©å™¨ä¿å­˜å¤±è´¥:', error);
                    showMessage('âŒ ä¿å­˜å¤±è´¥: æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒæ–‡ä»¶é€‰æ‹©å™¨ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨');
                }
            }
        }
        
        // ç”Ÿæˆé»˜è®¤æ ‡ç­¾HTMLï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function generateDefaultTagHTML() {
            return `
                <div class="tag-group">
                    <div class="tag-group-title">å¸¸è§„</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-yellow" data-tag="é¡¹ç›®" data-group="å¸¸è§„">é¡¹ç›®</div>
                        <div class="tag-item tag-yellow" data-tag="é‡Œç¨‹ç¢‘" data-group="å¸¸è§„">é‡Œç¨‹ç¢‘</div>
                        <div class="tag-item tag-yellow" data-tag="å®Œæˆ" data-group="å¸¸è§„">å®Œæˆ</div>
                        <div class="tag-item tag-yellow" data-tag="è¿›è¡Œä¸­" data-group="å¸¸è§„">è¿›è¡Œä¸­</div>
                        <div class="tag-item tag-yellow" data-tag="è®¡åˆ’" data-group="å¸¸è§„">è®¡åˆ’</div>
                    </div>
                </div>
                <div class="tag-group">
                    <div class="tag-group-title">AI</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-green" data-tag="è®°å¿†" data-group="AI">è®°å¿†</div>
                        <div class="tag-item tag-green" data-tag="æ³¨æ„åŠ›" data-group="AI">æ³¨æ„åŠ›</div>
                        <div class="tag-item tag-green" data-tag="ç»éªŒ" data-group="AI">ç»éªŒ</div>
                        <div class="tag-item tag-green" data-tag="å¹»è§‰" data-group="AI">å¹»è§‰</div>
                    </div>
                </div>
                <div class="tag-group">
                    <div class="tag-group-title">ç¬”è®°</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-blue" data-tag="è·Ÿè¿›" data-group="ç¬”è®°">è·Ÿè¿›</div>
                        <div class="tag-item tag-blue" data-tag="è®®é¢˜" data-group="ç¬”è®°">è®®é¢˜</div>
                    </div>
                </div>`;
        }

        // ç›´æ¥ä»æ ‡ç­¾ç®¡ç†è„‘å›¾è·å–æ ‡ç­¾æ•°æ®
        function getTagsFromWorkspace() {
            try {
                // è·å–æ ‡ç­¾ç®¡ç†é¢æ¿çš„æ€ç»´å¯¼å›¾
                const workspaceMindmap = mindmaps['workspace'];
                if (!workspaceMindmap) {
                    return getDefaultTagGroups();
                }
                
                const workspaceData = workspaceMindmap.get_data();
                if (!workspaceData || !workspaceData.data) {
                    return getDefaultTagGroups();
                }
                
                // è§£ææ ‡ç­¾ç»“æ„
                const tagStructure = {
                    categories: [],  // å¸¸è§„æ ‡ç­¾
                    technical: [],   // AIæ ‡ç­¾  
                    status: []       // ç¬”è®°æ ‡ç­¾
                };
                
                // éå†æ ‡ç­¾ç®¡ç†è„‘å›¾çš„å­èŠ‚ç‚¹
                if (workspaceData.data.children) {
                    workspaceData.data.children.forEach(node => {
                        const nodeName = node.topic.replace(/[ğŸ“ğŸ”§â­ğŸ·ï¸ğŸ“‹ğŸ’¡ğŸ¤–]/g, '').trim();
                        
                        // åˆ¤æ–­è¿™æ˜¯åˆ†ç»„èŠ‚ç‚¹è¿˜æ˜¯æ ‡ç­¾èŠ‚ç‚¹
                        if (node.children && node.children.length > 0) {
                            // è¿™æ˜¯ä¸€ä¸ªåˆ†ç»„èŠ‚ç‚¹ï¼Œå¤„ç†å…¶å­æ ‡ç­¾
                            let targetArray = null;
                            
                            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯"æ ‡ç­¾ç®¡ç†"æ ¹èŠ‚ç‚¹ï¼Œéœ€è¦æŒ‰å­èŠ‚ç‚¹åç§°åˆ†ç±»
                            if (nodeName === 'æ ‡ç­¾ç®¡ç†') {
                                
                                // éå†æ ‡ç­¾ç®¡ç†çš„å­èŠ‚ç‚¹ï¼ŒæŒ‰åç§°åˆ†ç±»
                                node.children.forEach(childGroup => {
                                    const childName = childGroup.topic.replace(/[ğŸ“ğŸ”§â­ğŸ·ï¸ğŸ“‹ğŸ’¡ğŸ¤–]/g, '').trim();
                                    
                                    let childTargetArray = null;
                                    
                                    if (childName.includes('å¸¸è§„') || childName === 'å¸¸è§„ç»„' || childName === 'å¸¸è§„' || 
                                        childName.includes('åˆ†ç±»') || childName.includes('åŸºç¡€') || childName.includes('é¡¹ç›®')) {
                                        childTargetArray = tagStructure.categories;
                                    } else if (childName.includes('AI') || childName === 'AIç»„' || childName === 'AI' ||
                                              childName.includes('æŠ€æœ¯') || childName.includes('æ™ºèƒ½')) {
                                        childTargetArray = tagStructure.technical;
                                    } else if (childName.includes('ç¬”è®°') || childName === 'ç¬”è®°ç»„' || childName === 'ç¬”è®°' ||
                                              childName.includes('çŠ¶æ€') || childName.includes('è®°å½•')) {
                                        childTargetArray = tagStructure.status;
                                    }
                                    
                                    // æ”¶é›†è¯¥å­ç»„ä¸‹çš„æ ‡ç­¾
                                    if (childTargetArray && childGroup.children) {
                                        childGroup.children.forEach(tagNode => {
                                            const tagName = tagNode.topic.replace(/[ğŸ“ğŸ”§â­ğŸ·ï¸ğŸ“‹ğŸ’¡ğŸ¤–]/g, '').trim();
                                            if (tagName && tagName.length > 0 && !childTargetArray.includes(tagName)) {
                                                childTargetArray.push(tagName);
                                            }
                                        });
                                    }
                                });
                                return; // è·³è¿‡åç»­çš„å¸¸è§„å¤„ç†é€»è¾‘
                            }
                            
                            // å¸¸è§„çš„åˆ†ç»„èŠ‚ç‚¹å¤„ç†é€»è¾‘
                            if (nodeName.includes('å¸¸è§„') || nodeName === 'å¸¸è§„ç»„' || nodeName === 'å¸¸è§„' || 
                                nodeName.includes('åˆ†ç±»') || nodeName.includes('åŸºç¡€') || nodeName.includes('é¡¹ç›®')) {
                                targetArray = tagStructure.categories;
                            } else if (nodeName.includes('AI') || nodeName === 'AIç»„' || nodeName === 'AI' ||
                                      nodeName.includes('æŠ€æœ¯') || nodeName.includes('æ™ºèƒ½')) {
                                targetArray = tagStructure.technical;
                            } else if (nodeName.includes('ç¬”è®°') || nodeName === 'ç¬”è®°ç»„' || nodeName === 'ç¬”è®°' ||
                                      nodeName.includes('çŠ¶æ€') || nodeName.includes('è®°å½•')) {
                                targetArray = tagStructure.status;
                            }
                            
                            // æ”¶é›†è¯¥åˆ†ç»„ä¸‹çš„æ ‡ç­¾
                            if (targetArray) {
                                node.children.forEach(tagNode => {
                                    const tagName = tagNode.topic.replace(/[ğŸ“ğŸ”§â­ğŸ·ï¸ğŸ“‹ğŸ’¡ğŸ¤–]/g, '').trim();
                                    // ç¡®ä¿æ ‡ç­¾åç§°ä¸ä¸ºç©ºä¸”ä¸é‡å¤
                                    if (tagName && tagName.length > 0 && !targetArray.includes(tagName)) {
                                        targetArray.push(tagName);
                                    } else if (!tagName || tagName.length === 0) {
                                    } else {
                                    }
                                });
                            }
                        } else {
                            // è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ ‡ç­¾èŠ‚ç‚¹ï¼Œæš‚æ—¶è·³è¿‡ï¼ˆåªå¤„ç†åˆ†ç»„ä¸‹çš„äºŒçº§èŠ‚ç‚¹ï¼‰
                        }
                    });
                }
                
                
                // å¦‚æœæ‰€æœ‰æ ‡ç­¾ç»„éƒ½ä¸ºç©ºï¼Œè¿”å›é»˜è®¤æ•°æ®
                const totalTags = tagStructure.categories.length + tagStructure.technical.length + tagStructure.status.length;
                if (totalTags === 0) {
                    return getDefaultTagGroups();
                }
                
                return tagStructure;
                
            } catch (error) {
                console.error('âŒ ä»è„‘å›¾è¯»å–æ ‡ç­¾å¤±è´¥:', error);
                return getDefaultTagGroups();
            }
        }
        
        // è·å–é»˜è®¤æ ‡ç­¾åˆ†ç»„
        function getDefaultTagGroups() {
            return {
                categories: ['é¡¹ç›®', 'é‡Œç¨‹ç¢‘', 'å®Œæˆ', 'è¿›è¡Œä¸­', 'è®¡åˆ’'],
                technical: ['è®°å¿†', 'æ³¨æ„åŠ›', 'ç»éªŒ', 'å¹»è§‰'],
                status: ['è·Ÿè¿›', 'è®®é¢˜']
            };
        }
        
        // ç”Ÿæˆæ ‡ç­¾ç»„HTMLï¼ˆä»è„‘å›¾åŒæ­¥æ•°æ®ï¼‰
        function generateTagGroupsHTML() {
            
            // ä»æ ‡ç­¾ç®¡ç†è„‘å›¾è·å–æœ€æ–°æ•°æ®
            const finalTagGroups = getTagsFromWorkspace();
            
            
            try {
                
                let html = '';
                
                // ç”Ÿæˆå¸¸è§„æ ‡ç­¾ç»„
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">å¸¸è§„</div>
                        <div class="tag-group-items">`;
                
                // ä½¿ç”¨æœ€ç»ˆåˆå¹¶çš„æ ‡ç­¾æ•°æ®
                finalTagGroups.categories.forEach(tag => {
                    html += `<div class="tag-item tag-yellow" data-tag="${tag}" data-group="å¸¸è§„">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // ç”ŸæˆAIæ ‡ç­¾ç»„
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">AI</div>
                        <div class="tag-group-items">`;
                
                finalTagGroups.technical.forEach(tag => {
                    html += `<div class="tag-item tag-green" data-tag="${tag}" data-group="AI">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // ç”Ÿæˆç¬”è®°æ ‡ç­¾ç»„
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">ç¬”è®°</div>
                        <div class="tag-group-items">`;
                
                finalTagGroups.status.forEach(tag => {
                    html += `<div class="tag-item tag-blue" data-tag="${tag}" data-group="ç¬”è®°">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // å¦‚æœæ²¡æœ‰ç”Ÿæˆä»»ä½•æ ‡ç­¾ç»„HTMLï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
                if (!html.trim()) {
                    html = `
                        <div class="empty-tags-message">
                            <div class="empty-icon">ğŸ·ï¸</div>
                            <div class="empty-text">æš‚æ— æ ‡ç­¾ç»„</div>
                            <div class="empty-hint">è¯·åœ¨æ ‡ç­¾ç®¡ç†è„‘å›¾ä¸­æ·»åŠ æ ‡ç­¾ç»„å’Œæ ‡ç­¾</div>
                        </div>`;
                }
                
                return html;
                
            } catch (error) {
                console.error('âŒ ç”Ÿæˆæ ‡ç­¾HTMLå¤±è´¥:', error);
                
                // é™çº§ä½¿ç”¨é»˜è®¤æ•°æ®
                const defaultGroups = getDefaultTagGroups();
                let fallbackHtml = '';
                
                // ç”Ÿæˆé»˜è®¤å¸¸è§„æ ‡ç­¾ç»„
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">å¸¸è§„</div>
                        <div class="tag-group-items">`;
                defaultGroups.categories.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-yellow" data-tag="${tag}" data-group="å¸¸è§„">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                // ç”Ÿæˆé»˜è®¤AIæ ‡ç­¾ç»„
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">AI</div>
                        <div class="tag-group-items">`;
                defaultGroups.technical.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-green" data-tag="${tag}" data-group="AI">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                // ç”Ÿæˆé»˜è®¤ç¬”è®°æ ‡ç­¾ç»„
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">ç¬”è®°</div>
                        <div class="tag-group-items">`;
                defaultGroups.status.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-blue" data-tag="${tag}" data-group="ç¬”è®°">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                return fallbackHtml;
            }
        }
        
        // æ·»åŠ æ ‡ç­¾åŠ è½½çŠ¶æ€çš„CSSæ ·å¼
        function addTagLoadingStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .loading-tags-state, .error-tags-state {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 30px 20px;
                    text-align: center;
                    min-height: 120px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 2px dashed #dee2e6;
                }
                
                .loading-icon, .error-icon {
                    font-size: 24px;
                    margin-bottom: 10px;
                }
                
                .loading-icon {
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .loading-text, .error-text {
                    font-size: 14px;
                    color: #6c757d;
                    margin-bottom: 5px;
                    font-weight: 500;
                }
                
                .error-text {
                    color: #dc3545;
                }
                
                .error-detail {
                    font-size: 12px;
                    color: #6c757d;
                    margin-bottom: 15px;
                }
                
                .retry-btn {
                    padding: 6px 12px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background-color 0.2s;
                }
                
                .retry-btn:hover {
                    background: #0056b3;
                }
            `;
            document.head.appendChild(style);
        }
        
        // åˆå§‹åŒ–æ—¶ä»æ ‡ç­¾ç®¡ç†è„‘å›¾åŠ è½½æ ‡ç­¾ç»„ä»¶
        function initializeTagsFromMindmap() {
            
            try {
                // æ·»åŠ å¿…è¦çš„CSSæ ·å¼
                addTagLoadingStyles();
                // ç­‰å¾…è„‘å›¾åˆå§‹åŒ–å®Œæˆ
                const checkMindmapReady = () => {
                    const workspaceMindmap = mindmaps['workspace'];
                    if (!workspaceMindmap) {
                        setTimeout(checkMindmapReady, 100);
                        return;
                    }
                    
                    // è„‘å›¾å·²å°±ç»ªï¼Œå¼€å§‹åŠ è½½æ ‡ç­¾
                    loadTagsFromMindmap();
                };
                
                // å¼€å§‹æ£€æŸ¥è„‘å›¾æ˜¯å¦å°±ç»ª
                checkMindmapReady();
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–æ ‡ç­¾ç»„ä»¶å¤±è´¥:', error);
                showLoadingError();
            }
        }
        
        // ä»è„‘å›¾åŠ è½½æ ‡ç­¾æ•°æ®å¹¶æ›´æ–°UI
        function loadTagsFromMindmap() {
            try {
                
                // è·å–æ ‡ç­¾æ•°æ®
                const tagGroups = getTagsFromWorkspace();
                
                // ç”Ÿæˆæ ‡ç­¾ç»„ä»¶HTML
                const tagsHTML = generateTagGroupsHTML();
                
                // æ›´æ–°æ ‡ç­¾å®¹å™¨
                const tagContainer = document.getElementById('tag-groups');
                if (tagContainer) {
                    tagContainer.innerHTML = tagsHTML;
                    
                    // ç»Ÿè®¡æ ‡ç­¾æ•°é‡
                    const groups = tagContainer.querySelectorAll('.tag-group');
                    let totalTags = 0;
                    groups.forEach(group => {
                        const items = group.querySelectorAll('.tag-item, .tag');
                        totalTags += items.length;
                    });
                    
                    showMessage(`âœ… æ ‡ç­¾ç»„ä»¶åˆå§‹åŒ–å®Œæˆ (${groups.length}ç»„, ${totalTags}ä¸ªæ ‡ç­¾)`);
                } else {
                    throw new Error('æ ‡ç­¾å®¹å™¨ä¸å­˜åœ¨');
                }
                
            } catch (error) {
                console.error('âŒ ä»è„‘å›¾åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
                showLoadingError(error.message);
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½é”™è¯¯çŠ¶æ€
        function showLoadingError(errorMessage = 'æœªçŸ¥é”™è¯¯') {
            const tagContainer = document.getElementById('tag-groups');
            if (tagContainer) {
                tagContainer.innerHTML = `
                    <div class="error-tags-state">
                        <div class="error-icon">âŒ</div>
                        <div class="error-text">æ ‡ç­¾åŠ è½½å¤±è´¥</div>
                        <div class="error-detail">${errorMessage}</div>
                        <button class="retry-btn" onclick="initializeTagsFromMindmap()">ğŸ”„ é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        // å¤„ç†åˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function handleAnalyzeTagData() {
            try {
                
                // æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
                if (typeof analyzeTagComponentDataSource !== 'function') {
                    console.error('âŒ analyzeTagComponentDataSourceå‡½æ•°ä¸å­˜åœ¨');
                    showMessage('âŒ åˆ†æåŠŸèƒ½ä¸å¯ç”¨', 'error');
                    return;
                }
                
                // æ‰§è¡Œåˆ†æ
                analyzeTagComponentDataSource();
                showMessage('âœ… åˆ†æå®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º', 'success');
                
            } catch (error) {
                console.error('âŒ åˆ†ææŒ‰é’®å¤„ç†å¤±è´¥:', error);
                showMessage('âŒ åˆ†æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ ‡ç­¾æ•°æ®æ¥æºåˆ†æå·¥å…·ï¼ˆä¿®å¤ç‰ˆï¼‰
        function analyzeTagComponentDataSource() {
            
            try {
                // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å­˜åœ¨
                
                // æ£€æŸ¥mindmapså…¨å±€å˜é‡
                if (typeof mindmaps === 'undefined') {
                    console.error('âŒ mindmapså…¨å±€å˜é‡æœªå®šä¹‰');
                    return;
                }
                
                // æ£€æŸ¥å…³é”®å‡½æ•°
                const requiredFunctions = ['getTagsFromWorkspace', 'getDefaultTagGroups'];
                for (const funcName of requiredFunctions) {
                    if (typeof window[funcName] !== 'function') {
                        console.error(`âŒ å‡½æ•° ${funcName} ä¸å­˜åœ¨`);
                        return;
                    }
                }
                
                
                // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥é¡µé¢æ˜¾ç¤ºçš„æ ‡ç­¾
                
                const tagContainer = document.getElementById('tag-groups');
                const pageTagData = {};
                
                if (tagContainer) {
                    
                    const groups = tagContainer.querySelectorAll('.tag-group');
                    
                    groups.forEach((group, index) => {
                        const titleElement = group.querySelector('.tag-group-title');
                        const items = group.querySelectorAll('.tag-item, .tag');
                        
                        if (titleElement) {
                            const title = titleElement.textContent.trim();
                            const tags = Array.from(items).map(item => item.textContent.trim());
                            
                            
                            // å­˜å‚¨é¡µé¢æ•°æ®
                            if (title === 'å¸¸è§„') pageTagData.categories = tags;
                            else if (title === 'AI') pageTagData.technical = tags;
                            else if (title === 'ç¬”è®°') pageTagData.status = tags;
                        }
                    });
                } else {
                }
                
                // ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥è„‘å›¾æ•°æ®
                
                const workspace = mindmaps['workspace'];
                let brainMapData = null;
                
                if (workspace) {
                    try {
                        const data = workspace.get_data();
                        if (data && data.data) {
                            brainMapData = data.data;
                            
                            if (brainMapData.children) {
                                brainMapData.children.forEach((node, index) => {
                                    const name = node.topic.replace(/[ğŸ“ğŸ”§â­ğŸ·ï¸ğŸ“‹ğŸ’¡ğŸ¤–]/g, '').trim();
                                    const childCount = node.children ? node.children.length : 0;
                                });
                            }
                        } else {
                        }
                    } catch (dataError) {
                        console.error('âŒ è·å–è„‘å›¾æ•°æ®å¤±è´¥:', dataError);
                    }
                } else {
                }
                
                // ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•å‡½æ•°æ‰§è¡Œ
                
                let functionResult = null;
                let defaultResult = null;
                
                try {
                    functionResult = getTagsFromWorkspace();
                } catch (funcError) {
                    console.error('âŒ getTagsFromWorkspaceæ‰§è¡Œå¤±è´¥:', funcError);
                }
                
                try {
                    defaultResult = getDefaultTagGroups();
                } catch (defaultError) {
                    console.error('âŒ getDefaultTagGroupsæ‰§è¡Œå¤±è´¥:', defaultError);
                }
                
                // ç¬¬å››æ­¥ï¼šæ•°æ®å¯¹æ¯”
                
                const groupNames = { categories: 'å¸¸è§„', technical: 'AI', status: 'ç¬”è®°' };
                
                Object.keys(groupNames).forEach(key => {
                    const displayName = groupNames[key];
                    const pageData = pageTagData[key] || [];
                    const funcData = functionResult ? (functionResult[key] || []) : [];
                    const defData = defaultResult ? (defaultResult[key] || []) : [];
                    
                    
                    // æ¯”è¾ƒä¸€è‡´æ€§
                    const pageVsFunc = JSON.stringify(pageData.sort()) === JSON.stringify(funcData.sort());
                    const funcVsDefault = JSON.stringify(funcData.sort()) === JSON.stringify(defData.sort());
                    
                });
                
                // ç¬¬äº”æ­¥ï¼šé—®é¢˜è¯Šæ–­
                
                if (!workspace) {
                } else if (!brainMapData) {
                } else if (!functionResult) {
                } else {
                }
                
                
            } catch (error) {
                console.error('âŒ åˆ†æå·¥å…·å‡ºé”™:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
            }
        }

        // å•å‘åŒæ­¥ï¼šä»æ ‡ç­¾è„‘å›¾åŒæ­¥æ•°æ®åˆ°æ ‡ç­¾ç»„ä»¶ï¼ˆæ ‡ç­¾è„‘å›¾ä½œä¸ºå”¯ä¸€æ•°æ®æºï¼‰
        // æ³¨æ„ï¼šæ ‡ç­¾ç»„å’Œæ ‡ç­¾åªæ”¯æŒåœ¨æ ‡ç­¾è„‘å›¾ä¸­æ‰‹åŠ¨ä¿®æ”¹ï¼Œä¸æ”¯æŒç¨‹åºè‡ªåŠ¨ä¿®æ”¹
        function syncTagsFromWorkspace() {
            try {
                showMessage('ğŸ”„ æ­£åœ¨ä»æ ‡ç­¾è„‘å›¾åŒæ­¥æ ‡ç­¾æ•°æ®...');
                
                // æ‰§è¡Œæ•°æ®æ¥æºåˆ†æï¼ˆå¦‚æœå‡½æ•°å­˜åœ¨ï¼‰
                if (typeof analyzeTagComponentDataSource === 'function') {
                    try {
                        analyzeTagComponentDataSource();
                    } catch (analysisError) {
                        console.error('âš ï¸ åˆ†æåŠŸèƒ½æ‰§è¡Œå¤±è´¥:', analysisError);
                    }
                }
                
                // 1. ä»æ ‡ç­¾è„‘å›¾è¯»å–æœ€æ–°æ•°æ®
                const tagGroups = getTagsFromWorkspace();
                
                // 2. æ›´æ–°å››ç»„ä»¶ä¸­çš„æ ‡ç­¾ç»„ä»¶ï¼ˆä¸»è¦ç›®æ ‡ï¼‰
                const fourComponentTagsContainer = document.getElementById('tag-groups');
                if (fourComponentTagsContainer) {
                    
                    // ç”Ÿæˆæ–°çš„æ ‡ç­¾ç»„HTML
                    let newTagsHTML = '';
                    
                    // å®šä¹‰æ ‡ç­¾ç»„æ˜ å°„
                    const groupMappings = {
                        'categories': 'å¸¸è§„',
                        'technical': 'AI', 
                        'status': 'ç¬”è®°'
                    };
                    
                    Object.keys(tagGroups).forEach(groupKey => {
                        const tags = tagGroups[groupKey];
                        if (!tags || tags.length === 0) return;
                        
                        const groupDisplayName = groupMappings[groupKey] || groupKey;
                        
                        newTagsHTML += `
                            <div class="tag-group">
                                <div class="tag-group-title">${groupDisplayName}</div>
                                <div class="tag-list" id="${groupKey.toLowerCase()}-tags">`;
                        
                        tags.forEach(tag => {
                            newTagsHTML += `<span class="tag" data-tag="${tag}" data-group="${groupDisplayName}" onclick="fourComponentToggleTag(this)">${tag}</span>`;
                        });
                        
                        newTagsHTML += `
                                </div>
                            </div>`;
                    });
                    
                    // æ›´æ–°æ ‡ç­¾å®¹å™¨å†…å®¹
                    fourComponentTagsContainer.innerHTML = newTagsHTML;
                } else {
                }
                
                // 3. æ›´æ–°èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ä¸­çš„æ ‡ç­¾ç»„ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const allTagContainers = document.querySelectorAll('[id*="tag-groups-container"]');
                
                if (allTagContainers.length > 0) {
                    allTagContainers.forEach((tagContainer, index) => {
                        
                        // ä½¿ç”¨èƒ½æ­£å¸¸å·¥ä½œçš„æ ‡ç­¾ç”Ÿæˆå‡½æ•°
                        tagContainer.innerHTML = generateTagGroupsHTML();
                        
                        // é‡æ–°ç»‘å®šäº‹ä»¶
                        const tagItems = tagContainer.querySelectorAll('.tag-item');
                        tagItems.forEach(tagItem => {
                            tagItem.addEventListener('click', function() {
                                const nodeId = tagContainer.id.replace('tag-groups-container-', '');
                                toggleTag(nodeId, this);
                            });
                        });
                        
                        // æ¢å¤é€‰ä¸­çŠ¶æ€
                        if (selectedNodeId) {
                            restoreTagStates(selectedNodeId);
                        }
                    });
                    
                    showMessage('âœ… æ ‡ç­¾åŒæ­¥å®Œæˆï¼');
                } else {
                    // å¦‚æœå½“å‰æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œå¼ºåˆ¶åˆ·æ–°è¯¦æƒ…é¢æ¿
                    if (selectedNodeId) {
                        const currentMindmapInstance = mindmaps[currentMindmap];
                        if (currentMindmapInstance) {
                            const currentNode = currentMindmapInstance.get_node(selectedNodeId);
                            if (currentNode) {
                                showNodeDetails(currentNode, currentMindmap);
                                showMessage('âœ… è¯¦æƒ…é¢æ¿åˆ·æ–°å®Œæˆï¼');
                            }
                        }
                    } else {
                        showMessage('â„¹ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æŸ¥çœ‹æ ‡ç­¾æ•ˆæœ');
                    }
                }
                
                showMessage('âœ… æ ‡ç­¾åŒæ­¥å®Œæˆï¼æ ‡ç­¾è„‘å›¾æ•°æ®å·²åŒæ­¥åˆ°æ ‡ç­¾ç»„ä»¶');
                
            } catch (error) {
                console.error('âŒ æ ‡ç­¾åŒæ­¥å¤±è´¥:', error);
                showMessage('âŒ æ ‡ç­¾åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }

        // ä»»åŠ¡ç®¡ç†åŠŸèƒ½
        function updateTaskManagement() {
            
            // è·å–å½“å‰æ€ç»´å¯¼å›¾å®ä¾‹
            const currentMindmapInstance = getCurrentJsMind();
            if (!currentMindmapInstance) return;
            
            // è·å–æ‰€æœ‰èŠ‚ç‚¹æ•°æ®
            const mindmapData = currentMindmapInstance.get_data();
            if (!mindmapData || !mindmapData.data) return;
            
            // é€’å½’å¤„ç†æ‰€æœ‰èŠ‚ç‚¹
            processNodeForTaskManagement(mindmapData.data, currentMindmapInstance);
        }
        
        // å¤„ç†å•ä¸ªèŠ‚ç‚¹çš„ä»»åŠ¡ç®¡ç†
        function processNodeForTaskManagement(nodeData, mindmapInstance) {
            if (!nodeData || !nodeData.id) return;
            
            const nodeId = nodeData.id;
            const nodeInfo = nodeDatabase[nodeId];
            
            if (nodeInfo && nodeInfo.tags) {
                // æ£€æŸ¥æ˜¯å¦æœ‰"å®Œæˆ"æ ‡ç­¾
                const isCompleted = nodeInfo.tags.status.includes('å®Œæˆ');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰"é¡¹ç›®"æ ‡ç­¾
                const isProject = nodeInfo.tags.status.includes('é¡¹ç›®');
                
                // å¤„ç†å®ŒæˆèŠ‚ç‚¹çš„è™šåŒ–
                if (isCompleted) {
                    applyCompletedNodeStyle(nodeId, mindmapInstance);
                } else {
                    // å¦‚æœæ²¡æœ‰å®Œæˆæ ‡ç­¾ï¼Œæ¢å¤åŸå§‹æ ·å¼
                    restoreNodeStyle(nodeId, mindmapInstance);
                }
                
                // å¤„ç†é¡¹ç›®èŠ‚ç‚¹çš„è¿›åº¦æ˜¾ç¤º
                if (isProject && nodeData.children && nodeData.children.length > 0) {
                    updateProjectProgress(nodeId, nodeData.children, mindmapInstance);
                } else if (!isProject) {
                    // å¦‚æœæ²¡æœ‰é¡¹ç›®æ ‡ç­¾ï¼Œæ¸…é™¤å¯èƒ½å­˜åœ¨çš„è¿›åº¦æ˜¾ç¤º
                    clearProjectProgress(nodeId, mindmapInstance);
                }
            }
            
            // é€’å½’å¤„ç†å­èŠ‚ç‚¹
            if (nodeData.children) {
                nodeData.children.forEach(child => {
                    processNodeForTaskManagement(child, mindmapInstance);
                });
            }
        }
        
        // åº”ç”¨å®ŒæˆèŠ‚ç‚¹çš„è™šåŒ–æ ·å¼
        function applyCompletedNodeStyle(nodeId, mindmapInstance) {
            try {
                // è®¾ç½®èŠ‚ç‚¹ä¸ºç°è‰²å¹¶é™ä½é€æ˜åº¦
                mindmapInstance.set_node_color(nodeId, '#f0f0f0', '#999999');
                
                // é€šè¿‡DOMæ“ä½œè®¾ç½®é€æ˜åº¦
                setTimeout(() => {
                    const nodeElement = document.querySelector(`[nodeid="${nodeId}"]`);
                    if (nodeElement) {
                        nodeElement.style.opacity = '0.5';
                        nodeElement.style.filter = 'grayscale(50%)';
                    }
                }, 100);
                
            } catch (error) {
                console.error(`âŒ è™šåŒ–èŠ‚ç‚¹å¤±è´¥: ${nodeId}`, error);
            }
        }
        
        // æ›´æ–°é¡¹ç›®è¿›åº¦æ˜¾ç¤º
        function updateProjectProgress(projectNodeId, children, mindmapInstance) {
            try {
                let totalChildren = 0;
                let completedChildren = 0;
                
                // ç»Ÿè®¡å­èŠ‚ç‚¹å®Œæˆæƒ…å†µ
                children.forEach(child => {
                    totalChildren++;
                    const childInfo = nodeDatabase[child.id];
                    if (childInfo && childInfo.tags && childInfo.tags.status.includes('å®Œæˆ')) {
                        completedChildren++;
                    }
                });
                
                // è·å–é¡¹ç›®èŠ‚ç‚¹çš„åŸå§‹æ ‡é¢˜ï¼ˆå»é™¤ä¹‹å‰çš„è¿›åº¦ä¿¡æ¯ï¼‰
                const projectInfo = nodeDatabase[projectNodeId];
                let originalTitle = projectInfo ? projectInfo.title : 'é¡¹ç›®';
                
                // æ¸…ç†æ ‡é¢˜ä¸­å¯èƒ½å­˜åœ¨çš„æ—§è¿›åº¦ä¿¡æ¯
                originalTitle = originalTitle.replace(/ \d+\/\d+$/, '');
                
                // ç”Ÿæˆè¿›åº¦æ˜¾ç¤ºæ–‡æœ¬ï¼ˆå®Œæˆæ•°/æ€»æ•°ï¼‰
                const progressText = ` ${completedChildren}/${totalChildren}`;
                const newTitle = `${originalTitle}${progressText}`;
                
                // æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤º
                mindmapInstance.update_node(projectNodeId, newTitle);
                
                // æ£€æŸ¥é¡¹ç›®æ˜¯å¦å…¨éƒ¨å®Œæˆï¼Œè‡ªåŠ¨æ·»åŠ å®Œæˆæ ‡ç­¾
                if (totalChildren > 0 && completedChildren === totalChildren) {
                    const projectInfo = nodeDatabase[projectNodeId];
                    if (projectInfo && !projectInfo.tags.status.includes('å®Œæˆ')) {
                        projectInfo.tags.status.push('å®Œæˆ');
                        projectInfo.modified = new Date().toISOString();
                        
                        // è§¦å‘ä»»åŠ¡ç®¡ç†æ›´æ–°ä»¥åº”ç”¨è™šåŒ–æ•ˆæœ
                        setTimeout(() => {
                            updateTaskManagement();
                        }, 100);
                    }
                }
                
            } catch (error) {
                console.error(`âŒ æ›´æ–°é¡¹ç›®è¿›åº¦å¤±è´¥: ${projectNodeId}`, error);
            }
        }
        
        // æ¢å¤èŠ‚ç‚¹åŸå§‹æ ·å¼ï¼ˆå½“ç§»é™¤å®Œæˆæ ‡ç­¾æ—¶ï¼‰
        function restoreNodeStyle(nodeId, mindmapInstance) {
            try {
                // æ¢å¤é»˜è®¤é¢œè‰²
                mindmapInstance.set_node_color(nodeId, null, null);
                
                // æ¢å¤DOMæ ·å¼
                setTimeout(() => {
                    const nodeElement = document.querySelector(`[nodeid="${nodeId}"]`);
                    if (nodeElement) {
                        nodeElement.style.opacity = '';
                        nodeElement.style.filter = '';
                    }
                }, 100);
                
            } catch (error) {
                console.error(`âŒ æ¢å¤èŠ‚ç‚¹æ ·å¼å¤±è´¥: ${nodeId}`, error);
            }
        }
        
        // æ¸…é™¤é¡¹ç›®è¿›åº¦æ˜¾ç¤ºï¼ˆå½“ç§»é™¤é¡¹ç›®æ ‡ç­¾æ—¶ï¼‰
        function clearProjectProgress(nodeId, mindmapInstance) {
            try {
                const projectInfo = nodeDatabase[nodeId];
                if (projectInfo) {
                    // æ¸…ç†æ ‡é¢˜ä¸­çš„è¿›åº¦ä¿¡æ¯ï¼Œæ¢å¤åŸå§‹æ ‡é¢˜
                    const originalTitle = projectInfo.title.replace(/ \d+\/\d+$/, '');
                    
                    // æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤ºä¸ºåŸå§‹æ ‡é¢˜
                    mindmapInstance.update_node(nodeId, originalTitle);
                    
                    // åŒæ—¶æ›´æ–°nodeDatabaseä¸­çš„æ ‡é¢˜
                    projectInfo.title = originalTitle;
                    
                }
            } catch (error) {
                console.error(`âŒ æ¸…é™¤é¡¹ç›®è¿›åº¦å¤±è´¥: ${nodeId}`, error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            
            // åˆå§‹åŒ–é¡¹ç›®ä¿¡æ¯ï¼ˆç‹¬ç«‹æ¨¡å—ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½ï¼‰
            initProjectInfo();
            
            // åˆå§‹åŒ–æ¨¡æ¿ç®¡ç†å’Œé€‰æ‹©æœåŠ¡
            setTimeout(() => {
                // åˆå§‹åŒ–æ¨¡æ¿æœåŠ¡
                if (typeof TemplateService !== 'undefined') {
                    TemplateService.initialize();
                    
                    // è·å–æ¨¡æ¿æ•°æ®
                    window.templateData = TemplateService.getTemplateData();
                } else {
                    console.warn('âš ï¸ TemplateService æœªåŠ è½½');
                }
                
                // åˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©æœåŠ¡
                if (typeof TemplateSelectionService !== 'undefined') {
                    if (window.templateData) {
                        window.templateSelectionService = new TemplateSelectionService();
                        window.templateSelectionService.init();
                    } else {
                        console.warn('âš ï¸ templateData å°šæœªåŠ è½½ï¼Œå†æ¬¡å°è¯•...');
                        // å†æ¬¡å°è¯•
                        setTimeout(() => {
                            if (window.templateData) {
                                window.templateSelectionService = new TemplateSelectionService();
                                window.templateSelectionService.init();
                            } else {
                                console.error('âŒ templateData åŠ è½½å¤±è´¥');
                            }
                        }, 500);
                    }
                } else {
                    console.warn('âš ï¸ TemplateSelectionService æœªåŠ è½½');
                }
            }, 100);
            
            // å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ç®¡ç†æ›´æ–°ï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ
            setTimeout(() => {
                updateTaskManagement();
            }, 1000);
            
        });

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒï¼ˆå€Ÿé‰´node_mind_injection_page.htmlï¼‰
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter è§¦å‘æäº¤åŠŸèƒ½
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                
                // è·å–å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const selectedNode = currentMindmapInstance.get_selected_node();
                    if (selectedNode) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å¯æäº¤
                        const contentEditor = document.getElementById(`node-content-${selectedNode.id}`);
                        if (contentEditor && contentEditor.value.trim()) {
                            submitContent(selectedNode.id);
                            showMessage('âŒ¨ï¸ Ctrl+Enter å¿«æ·é”®æäº¤å·²è§¦å‘', 2000, 'info');
                        } else {
                            showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©æœ‰å†…å®¹çš„èŠ‚ç‚¹è¿›è¡Œæäº¤', 2000, 'warning');
                        }
                    } else {
                        showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹', 2000, 'warning');
                    }
                } else {
                    showMessage('âŒ æ€ç»´å¯¼å›¾æœªåˆå§‹åŒ–', 2000, 'error');
                }
            }
            
            // Ctrl + Shift + Enter è§¦å‘ä¼ ç»Ÿå¤åˆ¶æ–¹å¼ï¼ˆå€Ÿé‰´node_mind_injection_page.htmlï¼‰
            else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const selectedNode = currentMindmapInstance.get_selected_node();
                    if (selectedNode) {
                        const contentEditor = document.getElementById(`node-content-${selectedNode.id}`);
                        if (contentEditor && contentEditor.value.trim()) {
                            // æ‰§è¡Œä¼ ç»Ÿå¤åˆ¶ï¼ˆä¸åŒ…å«direct_injectæ ‡è®°ï¼‰
                            traditionalCopyContent(selectedNode.id);
                            showMessage('âŒ¨ï¸ Ctrl+Shift+Enter ä¼ ç»Ÿå¤åˆ¶å·²è§¦å‘', 2000, 'info');
                        } else {
                            showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©æœ‰å†…å®¹çš„èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶', 2000, 'warning');
                        }
                    }
                }
            }
            
            // Ctrl + I æ˜¾ç¤ºæ³¨å…¥åŠŸèƒ½å¸®åŠ©
            else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                showInjectionHelp();
            }
        });

        // (é‡å¤çš„traditionalCopyContentå·²åˆ é™¤ - ä¿ç•™åé¢çš„å®Œæ•´ç‰ˆ)

        // (é‡å¤çš„showInjectionHelpå·²åˆ é™¤ - ä¿ç•™åé¢çš„å®Œæ•´ç‰ˆ)

        // é¡µé¢åŠ è½½å®Œæˆæç¤ºå¿«æ·é”®
        window.addEventListener('load', () => {
        });

    </script>

    <!-- ç›´æ¥èŠ‚ç‚¹ç‚¹å‡»ä¿®å¤ -->
    <script>
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œä¿®å¤
        window.addEventListener('load', function() {
            setTimeout(function() {
                
                // å¼ºåˆ¶ç»‘å®šDOMç‚¹å‡»äº‹ä»¶åˆ°æ‰€æœ‰æ€ç»´å¯¼å›¾å®¹å™¨
                const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
                
                containers.forEach(function(containerId) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        
                        // ç§»é™¤ç°æœ‰äº‹ä»¶ç›‘å¬å™¨
                        container.onclick = null;
                        
                        // æ·»åŠ æ–°çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                        container.addEventListener('click', function(e) {
                            
                            // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„èŠ‚ç‚¹
                            let nodeElement = e.target;
                            let nodeId = null;
                            
                            // å‘ä¸ŠæŸ¥æ‰¾èŠ‚ç‚¹å…ƒç´ 
                            while (nodeElement && nodeElement !== container) {
                                if (nodeElement.hasAttribute && nodeElement.hasAttribute('nodeid')) {
                                    nodeId = nodeElement.getAttribute('nodeid');
                                    break;
                                }
                                if (nodeElement.classList && nodeElement.classList.contains('jmnode')) {
                                    nodeId = nodeElement.getAttribute('nodeid');
                                    break;
                                }
                                nodeElement = nodeElement.parentNode;
                            }
                            
                            if (nodeId) {
                                
                                const mapId = containerId.replace('jsmind_container_', '');
                                
                                // è·å–èŠ‚ç‚¹æ•°æ®
                                if (window.mindmaps && window.mindmaps[mapId]) {
                                    const mindmap = window.mindmaps[mapId];
                                    const node = mindmap.get_node(nodeId);
                                    
                                    if (node) {
                                        
                                        // ç›´æ¥æ›´æ–°è¯¦æƒ…é¢æ¿
                                        forceUpdateNodeDetails(node);
                                    }
                                }
                            }
                        });
                        
                    }
                });
                
                // æ˜¾ç¤ºä¿®å¤å®Œæˆæç¤º
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;font-size:14px;';
                notice.textContent = 'âœ… èŠ‚ç‚¹ç‚¹å‡»ä¿®å¤å·²åº”ç”¨';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 3000);
                
            }, 2000); // ç­‰å¾…2ç§’ç¡®ä¿æ‰€æœ‰å†…å®¹åŠ è½½å®Œæˆ
        });
        
        // å¼ºåˆ¶æ›´æ–°èŠ‚ç‚¹è¯¦æƒ…çš„å‡½æ•°
        function forceUpdateNodeDetails(node) {
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            window.selectedNodeId = node.id;
            const statusElement = document.getElementById('selectedNode');
            if (statusElement) {
                statusElement.textContent = node.topic || 'æ— ';
            }
            
            // ç¡®ä¿èŠ‚ç‚¹æ•°æ®å­˜åœ¨
            if (!window.nodeDatabase) {
                window.nodeDatabase = {};
            }
            
            // åˆ›å»ºæˆ–è·å–èŠ‚ç‚¹æ•°æ®
            const cleanTitle = node.topic.replace(' ğŸ“„', '');
            if (!window.nodeDatabase[node.id]) {
                window.nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    author: 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    sessions: [],
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            const nodeData = window.nodeDatabase[node.id];
            
            // ç¡®ä¿èŠ‚ç‚¹æ•°æ®æœ‰å®Œæ•´ç»“æ„
            if (!nodeData.sessions) nodeData.sessions = [];
            if (!nodeData.tags) nodeData.tags = { categories: [], technical: [], status: [] };
            
            // åˆ‡æ¢åˆ°èŠ‚ç‚¹ä¿¡æ¯æ ‡ç­¾é¡µå¹¶æ›´æ–°å››ç»„ä»¶
            switchToDetailTab();
            updateFourComponentsForNode(node.id);
            
        }
        
        // ä¿å­˜èŠ‚ç‚¹æ•°æ®çš„å‡½æ•°
        function saveNodeData(nodeId) {
            const titleInput = document.getElementById(`node-title-${nodeId}`);
            const contentTextarea = document.getElementById(`node-content-${nodeId}`);
            
            if (titleInput && contentTextarea && window.nodeDatabase && window.nodeDatabase[nodeId]) {
                window.nodeDatabase[nodeId].title = titleInput.value;
                window.nodeDatabase[nodeId].content = contentTextarea.value;
                window.nodeDatabase[nodeId].modified = new Date().toISOString();
                
                // æ˜¾ç¤ºä¿å­˜æç¤º
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = 'ğŸ’¾ æ•°æ®å·²ä¿å­˜';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
                
            }
        }
        
        // ä¼šè¯ç®¡ç†å‡½æ•°
        function addNewSession(nodeId) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId]) {
                return;
            }
            
            const nodeData = window.nodeDatabase[nodeId];
            if (!nodeData.sessions) {
                nodeData.sessions = [];
            }
            
            const newSession = {
                id: Date.now().toString(),
                title: `ä¼šè¯ ${nodeData.sessions.length + 1}`,
                content: '',
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
            
            nodeData.sessions.push(newSession);
            
            // åˆ·æ–°ä¼šè¯åˆ—è¡¨æ˜¾ç¤º
            const sessionList = document.getElementById(`session-list-${nodeId}`);
            if (sessionList) {
                const sessionHtml = `
                    <div class="session-item" onclick="selectSession('${nodeId}', ${nodeData.sessions.length - 1})">
                        <div class="session-header">
                            <span class="session-title">${newSession.title}</span>
                            <span class="session-time">${new Date(newSession.created).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                sessionList.insertAdjacentHTML('beforeend', sessionHtml);
            }
            
        }
        
        function selectSession(nodeId, sessionIndex) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId] || !window.nodeDatabase[nodeId].sessions) {
                return;
            }
            
            const session = window.nodeDatabase[nodeId].sessions[sessionIndex];
            if (session) {
                // è¿™é‡Œå¯ä»¥å®ç°ä¼šè¯å†…å®¹çš„æ˜¾ç¤ºé€»è¾‘
                
                // æ˜¾ç¤ºæç¤º
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#17a2b8;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = `ğŸ“– å·²é€‰æ‹©: ${session.title}`;
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
            }
        }
        
        function viewAllSessions(nodeId) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId] || !window.nodeDatabase[nodeId].sessions) {
                return;
            }
            
            const sessions = window.nodeDatabase[nodeId].sessions;
            
            // æ˜¾ç¤ºæç¤º
            const notice = document.createElement('div');
            notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;';
            notice.textContent = `ğŸ“– å…±æœ‰ ${sessions.length} ä¸ªä¼šè¯`;
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), 2000);
        }
        
        function clearAllSessions(nodeId) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId]) {
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¼šè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                window.nodeDatabase[nodeId].sessions = [];
                
                // åˆ·æ–°ä¼šè¯åˆ—è¡¨æ˜¾ç¤º
                const sessionList = document.getElementById(`session-list-${nodeId}`);
                if (sessionList) {
                    sessionList.innerHTML = `
                        <div class="session-item new-session-btn" onclick="addNewSession('${nodeId}')">
                            <span class="new-session-icon">â•</span>
                            <span class="new-session-text">æ–°å¢ä¼šè¯</span>
                        </div>
                    `;
                }
                
                // æ˜¾ç¤ºæç¤º
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#dc3545;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = 'ğŸ—‘ï¸ æ‰€æœ‰ä¼šè¯å·²æ¸…ç©º';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
                
            }
        }
        
        // (é‡å¤çš„ç®€å•ç‰ˆcopyContentFromEditorå·²åˆ é™¤ - ä¿ç•™åŠŸèƒ½å®Œæ•´ç‰ˆ)
        
        // (é‡å¤çš„ç®€å•ç‰ˆpasteContentToEditorå·²åˆ é™¤ - ä¿ç•™åŠŸèƒ½å®Œæ•´ç‰ˆ)
        
        // (é‡å¤çš„submitContentå‡½æ•°å·²åˆ é™¤ - ä¿ç•™ç¬¬ä¸€ä¸ªå®šä¹‰)
        
        // æ˜¾ç¤ºæ¶ˆæ¯çš„è¾…åŠ©å‡½æ•°
        function showMessage(message, duration = 3000, type = 'info') {
            const notice = document.createElement('div');
            
            let backgroundColor;
            switch (type) {
                case 'success':
                    backgroundColor = '#28a745';
                    break;
                case 'error':
                    backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    backgroundColor = '#ffc107';
                    break;
                default:
                    backgroundColor = '#17a2b8';
            }
            
            notice.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: ${backgroundColor};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                z-index: 9999;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                max-width: 350px;
            `;
            notice.textContent = message;
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), duration);
        }
        
        // ä¼ ç»Ÿå¤åˆ¶åŠŸèƒ½ï¼ˆä¸è§¦å‘ç›´æ¥æ³¨å…¥ï¼‰
        async function traditionalCopyContent(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('âŒ æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            if (!content) {
                showMessage('âŒ è¯·å…ˆè¾“å…¥è¦å¤åˆ¶çš„å†…å®¹', 2000, 'error');
                return;
            }
            
            const nodeData = window.nodeDatabase[nodeId] || {};
            const nodeTitle = nodeData.title || `èŠ‚ç‚¹${nodeId}`;
            
            try {
                // åˆ›å»ºä¼ ç»Ÿå¤åˆ¶çš„JSONåè®®ï¼ˆä¸åŒ…å«direct_injectæ ‡è®°ï¼‰
                const injectionData = {
                    source: 'nodemind',
                    type: 'content-injection',
                    content: content,
                    timestamp: new Date().toISOString(),
                    nodeId: nodeId,
                    nodeTitle: nodeTitle,
                    projectName: 'NodeMind'
                };

                const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;
                await navigator.clipboard.writeText(clipboardContent);

                showMessage('ğŸ“‹ å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·åœ¨injectionå·¥å…·ä¸­ç‚¹å‡»"æ³¨å…¥å‘½ä»¤"', 3000, 'info');

            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                showMessage('âŒ å¤åˆ¶å¤±è´¥ï¼š' + error.message, 3000, 'error');
            }
        }

        // æ˜¾ç¤ºæ³¨å…¥åŠŸèƒ½å¸®åŠ©ä¿¡æ¯
        function showInjectionHelp() {
            const helpContent = `
ğŸ§  NodeMind - ä¸€é”®æ³¨å…¥åˆ°Cursor å¸®åŠ©

ğŸ“‹ å¿«æ·é”®è¯´æ˜ï¼š
â€¢ Ctrl + Enter: ä¸€é”®ç›´æ¥æ³¨å…¥åˆ°Cursor
â€¢ Ctrl + Shift + Enter: ä¼ ç»Ÿæ–¹å¼ï¼ˆä»…å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼‰
â€¢ Ctrl + I: æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ğŸ¯ ä½¿ç”¨æ–¹æ³•ï¼š
1. é€‰æ‹©åŒ…å«å†…å®¹çš„èŠ‚ç‚¹
2. æŒ‰ä¸‹å¿«æ·é”®è¿›è¡Œæ³¨å…¥æˆ–å¤åˆ¶
3. injectionå·¥å…·ä¼šè‡ªåŠ¨æ‰§è¡Œæ³¨å…¥æµç¨‹

ğŸ“ æ³¨å…¥åè®®ï¼š
â€¢ ä½¿ç”¨NODEMIND_INJECTION:JSONæ ¼å¼
â€¢ åŒ…å«èŠ‚ç‚¹IDã€æ ‡é¢˜ã€å†…å®¹å’Œæ—¶é—´æˆ³
â€¢ direct_injectæ ‡è®°åŒºåˆ†ç›´æ¥æ³¨å…¥å’Œä¼ ç»Ÿå¤åˆ¶

ğŸ’¡ å°æç¤ºï¼š
â€¢ ç¡®ä¿injectionå·¥å…·æ­£åœ¨è¿è¡Œ
â€¢ ä¸€é”®æ³¨å…¥éœ€è¦å®Œæˆæ ¡å‡†è®¾ç½®
â€¢ ä¼ ç»Ÿæ–¹å¼éœ€è¦æ‰‹åŠ¨ç‚¹å‡»injectionå·¥å…·ä¸­çš„"æ³¨å…¥å‘½ä»¤"æŒ‰é’®
            `.trim();
            
            // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿalertæ˜¾ç¤ºå¸®åŠ©
            alert(helpContent);
        }

        // è·å–å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹IDï¼ˆä»å…¨å±€çŠ¶æ€æˆ–DOMä¸­è·å–ï¼‰
        function getCurrentSelectedNodeId() {
            // ä¼˜å…ˆä»å…¨å±€çŠ¶æ€è·å–
            if (window.selectedNodeId) {
                return window.selectedNodeId;
            }
            
            // ä»DOMä¸­æŸ¥æ‰¾å½“å‰æ¿€æ´»çš„å†…å®¹ç¼–è¾‘å™¨
            const activeEditor = document.querySelector('textarea[id^="node-content-"]:focus');
            if (activeEditor) {
                const match = activeEditor.id.match(/node-content-(.+)/);
                if (match) {
                    return match[1];
                }
            }
            
            // æŸ¥æ‰¾æœ€è¿‘æ›´æ–°çš„å†…å®¹ç¼–è¾‘å™¨
            const allEditors = document.querySelectorAll('textarea[id^="node-content-"]');
            if (allEditors.length > 0) {
                const lastEditor = allEditors[allEditors.length - 1];
                const match = lastEditor.id.match(/node-content-(.+)/);
                if (match) {
                    return match[1];
                }
            }
            
            return null;
        }

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter è§¦å‘æäº¤åŠŸèƒ½
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                
                const nodeId = getCurrentSelectedNodeId();
                if (nodeId) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å¯æäº¤
                    const contentEditor = document.getElementById(`node-content-${nodeId}`);
                    if (contentEditor && contentEditor.value.trim()) {
                        submitContent(nodeId);
                        showMessage('âŒ¨ï¸ Ctrl+Enter å¿«æ·é”®æäº¤å·²è§¦å‘', 2000, 'info');
                    } else {
                        showMessage('âš ï¸ è¯·å…ˆè¾“å…¥å†…å®¹è¿›è¡Œæäº¤', 2000, 'warning');
                    }
                } else {
                    showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹', 2000, 'warning');
                }
            }
            
            // Ctrl + Shift + Enter è§¦å‘ä¼ ç»Ÿå¤åˆ¶æ–¹å¼
            else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                
                const nodeId = getCurrentSelectedNodeId();
                if (nodeId) {
                    const contentEditor = document.getElementById(`node-content-${nodeId}`);
                    if (contentEditor && contentEditor.value.trim()) {
                        // æ‰§è¡Œä¼ ç»Ÿå¤åˆ¶ï¼ˆä¸åŒ…å«direct_injectæ ‡è®°ï¼‰
                        traditionalCopyContent(nodeId);
                        showMessage('âŒ¨ï¸ Ctrl+Shift+Enter ä¼ ç»Ÿå¤åˆ¶å·²è§¦å‘', 2000, 'info');
                    } else {
                        showMessage('âš ï¸ è¯·å…ˆè¾“å…¥å†…å®¹è¿›è¡Œå¤åˆ¶', 2000, 'warning');
                    }
                } else {
                    showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹', 2000, 'warning');
                }
            }
            
            // Ctrl + I æ˜¾ç¤ºæ³¨å…¥åŠŸèƒ½å¸®åŠ©
            else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                showInjectionHelp();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆæç¤ºå¿«æ·é”®
        window.addEventListener('load', () => {
        });

        // å¯¼å‡ºåˆ°å…¨å±€
        window.forceUpdateNodeDetails = forceUpdateNodeDetails;
        window.saveNodeData = saveNodeData;
        window.addNewSession = addNewSession;
        window.selectSession = selectSession;
        window.viewAllSessions = viewAllSessions;
        window.clearAllSessions = clearAllSessions;

        window.copyContentFromEditor = copyContentFromEditor;
        window.pasteContentToEditor = pasteContentToEditor;
        window.submitContent = submitContent;
        window.showMessage = showMessage;
        window.traditionalCopyContent = traditionalCopyContent;
        window.showInjectionHelp = showInjectionHelp;

        // å››ç»„ä»¶åŠŸèƒ½ä»£ç 
        // å…¨å±€çŠ¶æ€ç®¡ç†
        class GlobalStateManager {
            constructor() {
                this.selectedTags = new Set();
                this.selectedTemplates = [];
                this.qaMode = true;
                this.layoutRatio = 0.6; // å·¦ä¾§é¢æ¿å æ¯”
            }

            // æ ‡ç­¾çŠ¶æ€ç®¡ç†
            toggleTag(tagElement) {
                const tagText = tagElement.textContent;
                if (this.selectedTags.has(tagText)) {
                    this.selectedTags.delete(tagText);
                    tagElement.classList.remove('selected');
                } else {
                    this.selectedTags.add(tagText);
                    tagElement.classList.add('selected');
                }
            }

            // æ¨¡æ¿çŠ¶æ€ç®¡ç†
            addTemplate(template) {
                if (!this.selectedTemplates.find(t => t.name === template.name)) {
                    this.selectedTemplates.push(template);
                    this.renderTemplates();
                }
            }

            removeTemplate(templateName) {
                this.selectedTemplates = this.selectedTemplates.filter(t => t.name !== templateName);
                this.renderTemplates();
            }

            useTemplate(templateName) {
                const template = this.selectedTemplates.find(t => t.name === templateName);
                if (template) {
                    const editor = document.getElementById('content-editor');
                    if (editor) {
                        editor.value = template.content;
                    }
                }
            }

            renderTemplates() {
                const container = document.getElementById('template-list');
                if (!container) return;
                
                // ä»æ¨¡æ¿é€‰æ‹©æœåŠ¡è·å–é€‰ä¸­çš„æ¨¡æ¿
                let selectedTemplates = [];
                if (window.templateSelectionService) {
                    selectedTemplates = window.templateSelectionService.getSelectedTemplates();
                    
                    // åŒæ­¥åˆ°æœ¬åœ°çŠ¶æ€
                    this.selectedTemplates = selectedTemplates.map(template => ({
                        name: template.name || template.title,
                        content: template.prefix || template.content || ''
                    }));
                } else {
                    // å›é€€åˆ°æœ¬åœ°æ¨¡æ¿åˆ—è¡¨
                    selectedTemplates = this.selectedTemplates;
                }
                
                if (selectedTemplates.length === 0) {
                    container.innerHTML = `
                        <div class="empty-template-state">
                            <div class="empty-icon">ğŸ“</div>
                            <div class="empty-text">æš‚æ— é€‰ä¸­æ¨¡æ¿</div>
                            <div class="empty-hint">ç‚¹å‡»"ç®¡ç†"æŒ‰é’®æ·»åŠ æ¨¡æ¿</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = selectedTemplates.map(template => `
                        <div class="template-item">
                            <span class="template-name">${template.name || template.title}</span>
                            <div class="template-actions">
                                <button class="template-btn template-btn-use" onclick="fourComponentUseTemplate('${template.id || template.name}')">ä½¿ç”¨</button>
                                <button class="template-btn template-btn-remove" onclick="fourComponentRemoveTemplate('${template.id || template.name}')">ç§»é™¤</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                // è‡ªåŠ¨ä¿å­˜å››ç»„ä»¶æ•°æ®
                setTimeout(() => saveFourComponentData(), 100);
            }

            reset() {
                this.selectedTags = new Set();
                this.selectedTemplates = [];
                this.qaMode = true;
                this.layoutRatio = 0.6;
            }
        }

        // èŠ‚ç‚¹çŠ¶æ€ç®¡ç†
        class NodeStateManager {
            constructor() {
                this.currentNode = null;
                this.nodeData = {};
            }

            loadNode(nodeId) {
                this.currentNode = nodeId;
                
                // ç¡®ä¿èŠ‚ç‚¹æ•°æ®å­˜åœ¨ï¼Œä½†ä¼˜å…ˆä½¿ç”¨å·²æœ‰æ•°æ®
                if (!this.nodeData[nodeId]) {
                    // å°è¯•ä»ä¸»åº”ç”¨çš„nodeDatabaseè·å–æ•°æ®
                    const mainNodeData = nodeDatabase[nodeId];
                    
                    this.nodeData[nodeId] = {
                        id: nodeId,
                        title: mainNodeData?.title || `èŠ‚ç‚¹ ${nodeId}`,
                        content: mainNodeData?.content || '',
                        createTime: mainNodeData?.created ? new Date(mainNodeData.created).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'),
                        updateTime: mainNodeData?.modified ? new Date(mainNodeData.modified).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN')
                    };
                    
                } else {
                }

                this.updateUI();
            }

            updateUI() {
                if (!this.currentNode) {
                    return;
                }

                const nodeData = this.nodeData[this.currentNode];
                if (!nodeData) {
                    return;
                }
                
                
                // æ›´æ–°æ ‡é¢˜
                const nodeTitleElement = document.getElementById('node-title');
                
                if (nodeTitleElement) {
                    nodeTitleElement.textContent = nodeData.title;
                }
                
                // æ›´æ–°å†…å®¹
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    contentEditor.value = nodeData.content;
                } else {
                }
                
                // æ›´æ–°å…ƒä¿¡æ¯
                const metaInfo = document.getElementById('meta-info');
                if (metaInfo) {
                    metaInfo.textContent = `åˆ›å»ºæ—¶é—´: ${nodeData.createTime} | ä¿®æ”¹æ—¶é—´: ${nodeData.updateTime}`;
                }
                
            }

            updateContent() {
                if (!this.currentNode) return;

                const titleInput = document.getElementById('title-input');
                const contentEditor = document.getElementById('content-editor');
                
                if (titleInput && contentEditor) {
                    const title = titleInput.value;
                    const content = contentEditor.value;
                    
                    // ä½¿ç”¨ä¸“é—¨çš„æ›´æ–°å‡½æ•°ï¼ˆåŒ…å«æ€ç»´å¯¼å›¾åŒæ­¥ï¼‰
                    updateFourComponentNodeTitle(this.currentNode, title);
                    updateFourComponentNodeContent(this.currentNode, content);
                    
                    // æ›´æ–°å…ƒä¿¡æ¯
                    const metaInfo = document.getElementById('meta-info');
                    if (metaInfo) {
                        metaInfo.textContent = `åˆ›å»ºæ—¶é—´: ${this.nodeData[this.currentNode].createTime} | ä¿®æ”¹æ—¶é—´: ${this.nodeData[this.currentNode].updateTime}`;
                    }
                    
                    // è‡ªåŠ¨ä¿å­˜å››ç»„ä»¶æ•°æ®
                    setTimeout(() => saveFourComponentData(), 100);
                }
            }

            async submitContent() {
                if (!this.currentNode) return;

                
                // è·å–å†…å®¹ç¼–è¾‘å™¨
                const contentEditor = document.getElementById('content-editor');
                if (!contentEditor) {
                    console.error('âŒ æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨');
                    return;
                }

                const content = contentEditor.value.trim();
                
                // è·å–èŠ‚ç‚¹ä¿¡æ¯
                const nodeData = this.nodeData[this.currentNode] || {};
                const nodeTitle = (nodeData.title || `èŠ‚ç‚¹${this.currentNode}`).trim();
                
                // æ£€æŸ¥é—®ç­”æ¨¡å¼çŠ¶æ€
                const qaToggle = document.getElementById('qa-mode-toggle');
                const isQAMode = qaToggle ? qaToggle.checked : false;
                
                
                // æ„å»ºæ³¨å…¥å†…å®¹ï¼ˆæ ‡é¢˜+å†…å®¹æ ¼å¼ï¼‰
                let injectionContent = '';
                
                if (nodeTitle && content) {
                    // éƒ½å­˜åœ¨ï¼šä½¿ç”¨ "- æ ‡é¢˜\n- å†…å®¹" æ ¼å¼
                    injectionContent = `- ${nodeTitle}\n- ${content}`;
                } else if (nodeTitle) {
                    // åªæœ‰æ ‡é¢˜ï¼šç›´æ¥ä½¿ç”¨æ ‡é¢˜
                    injectionContent = nodeTitle;
                } else if (content) {
                    // åªæœ‰å†…å®¹ï¼šç›´æ¥ä½¿ç”¨å†…å®¹
                    injectionContent = content;
                } else {
                    // éƒ½æ²¡æœ‰ï¼šæç¤ºé”™è¯¯
                    console.error('âŒ è¯·å…ˆè¾“å…¥æ ‡é¢˜æˆ–å†…å®¹');
                    return;
                }

                try {
                    // åˆ›å»ºä¸€é”®æ³¨å…¥çš„JSONåè®®ï¼ˆå€Ÿé‰´node_mind_injection_page.htmlï¼‰
                    const injectionData = {
                        source: 'nodemind',
                        type: 'content-injection',
                        content: injectionContent,
                        direct_inject: true,  // å…³é”®ï¼šæ ‡è¯†ä¸ºç›´æ¥æ³¨å…¥
                        timestamp: new Date().toISOString(),
                        nodeId: this.currentNode,
                        nodeTitle: nodeTitle,
                        projectName: 'NodeMind'
                    };

                    // æ„å»ºå®Œæ•´çš„å‰ªè´´æ¿å†…å®¹
                    const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    await navigator.clipboard.writeText(clipboardContent);

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    
                    // è·å–æäº¤æŒ‰é’®å¹¶æ›´æ–°çŠ¶æ€
                    const submitButton = document.querySelector('.btn-primary');
                    if (submitButton) {
                        const originalText = submitButton.textContent;
                        submitButton.textContent = 'âœ… æ³¨å…¥å·²è§¦å‘';
                        submitButton.disabled = true;
                        
                        // 2ç§’åæ¢å¤æŒ‰é’®
                        setTimeout(() => {
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                        }, 2000);
                    }

                    // === ä¼šè¯ç³»ç»Ÿé›†æˆ ===
                    // åˆ›å»ºä¼šè¯è®°å½•
                    const sessionType = isQAMode ? 'interaction' : 'note';
                    const sessionContent = content; // ä½¿ç”¨åŸå§‹å†…å®¹ï¼Œä¸åŒ…å«[å·²æ³¨å…¥]æ ‡ç­¾
                    
                    // æ·»åŠ ä¼šè¯åˆ°èŠ‚ç‚¹
                    const newSession = addSessionToNode(this.currentNode, sessionContent, sessionType);

                    // æ¸…ç©ºå†…å®¹ç¼–è¾‘å™¨
                    contentEditor.value = '';
                    
                    // åŒæ­¥æ›´æ–°nodeDataï¼ˆæ¸…ç©ºå†…å®¹ï¼‰
                    if (this.nodeData[this.currentNode]) {
                        this.nodeData[this.currentNode].content = '';
                        this.nodeData[this.currentNode].updateTime = new Date().toLocaleString('zh-CN');
                    }
                    

                    
                    // è®°å½•åˆ°æ—¥å¿—
                    const logEntry = `${new Date().toLocaleString()} - èŠ‚ç‚¹ "${nodeTitle}" æ ‡é¢˜+å†…å®¹å·²æ³¨å…¥åˆ°Cursor`;
                    
                    // è‡ªåŠ¨ä¿å­˜å››ç»„ä»¶æ•°æ®
                    setTimeout(() => saveFourComponentData(), 100);

                } catch (error) {
                    console.error('ä¸€é”®æ³¨å…¥å¤±è´¥:', error);
                }
            }

            reset() {
                this.nodeData = {};
                this.currentNode = null;
            }
        }

        // åˆå§‹åŒ–å››ç»„ä»¶çŠ¶æ€ç®¡ç†å™¨
        const fourComponentGlobalState = new GlobalStateManager();
        const fourComponentNodeState = new NodeStateManager();

        // é—®ç­”æ¨¡å¼åˆ‡æ¢
        function onQAModeChange() {
            const qaToggle = document.getElementById('qa-mode-toggle');
            if (!qaToggle) return;
            
            const qaMode = qaToggle.checked;
            fourComponentGlobalState.qaMode = qaMode;
            
            
            // ğŸ”‘ æ›´æ–°æ‰€æœ‰æäº¤æŒ‰é’®çš„æ–‡æœ¬ï¼Œåæ˜ å½“å‰æ¨¡å¼
            updateSubmitButtonTexts(qaMode);
        }
        
        // æ›´æ–°æäº¤æŒ‰é’®æ–‡æœ¬
        function updateSubmitButtonTexts(isQAMode) {
            // ğŸ”‘ æ›´æ–°å››ç»„ä»¶æäº¤æŒ‰é’®
            const fourComponentButton = document.querySelector('button[onclick="fourComponentSubmitContent()"]');
            if (fourComponentButton && !fourComponentButton.disabled) {
                if (isQAMode) {
                    fourComponentButton.textContent = 'ğŸ¤– æäº¤å‘½ä»¤';
                    fourComponentButton.title = 'é—®ç­”æ¨¡å¼ï¼šå°†å†…å®¹æ³¨å…¥åˆ°Cursorè¿›è¡ŒAIå¯¹è¯';
                } else {
                    fourComponentButton.textContent = 'ğŸ’¾ ä¿å­˜ç¬”è®°';
                    fourComponentButton.title = 'ç¬”è®°æ¨¡å¼ï¼šä¿å­˜å†…å®¹ä¸ºç¬”è®°';
                }
            }
            
            // æ›´æ–°èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ä¸­çš„æäº¤æŒ‰é’®
            const submitButtons = document.querySelectorAll('button[onclick*="submitContent"]');
            submitButtons.forEach(button => {
                if (!button.disabled) { // åªæ›´æ–°æœªç¦ç”¨çš„æŒ‰é’®
                    if (isQAMode) {
                        button.textContent = 'ğŸ¤– æäº¤å‘½ä»¤';
                        button.title = 'é—®ç­”æ¨¡å¼ï¼šå°†å†…å®¹æ³¨å…¥åˆ°Cursorè¿›è¡ŒAIå¯¹è¯';
                    } else {
                        button.textContent = 'ğŸ’¾ ä¿å­˜ç¬”è®°';
                        button.title = 'ç¬”è®°æ¨¡å¼ï¼šä¿å­˜å†…å®¹ä¸ºç¬”è®°';
                    }
                }
            });
            
        }

        // å››ç»„ä»¶ç›¸å…³å‡½æ•°
        function fourComponentUpdateTitle() {
            // æ ‡é¢˜è¾“å…¥æ¡†å·²åˆ é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ä½†ä¸æ‰§è¡Œæ“ä½œ
        }

        function fourComponentCopyContent() {
            const contentEditor = document.getElementById('content-editor');
            if (contentEditor) {
                navigator.clipboard.writeText(contentEditor.value).then(() => {
                });
            }
        }

        function fourComponentPasteContent() {
            navigator.clipboard.readText().then(text => {
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    contentEditor.value = text;
                }
            });
        }

        // å››ç»„ä»¶æäº¤å†…å®¹ï¼ˆæ ¹æ®é—®ç­”æ¨¡å¼å†³å®šï¼šå‘½ä»¤æ³¨å…¥ OR ç¬”è®°ä¿å­˜ï¼‰
        function fourComponentSubmitContent() {
            
            // ğŸ”‘ æ£€æŸ¥é—®ç­”æ¨¡å¼çŠ¶æ€
            const qaToggle = document.getElementById('qa-mode-toggle');
            const isQAMode = qaToggle && qaToggle.checked;
            
            
            // è·å–å†…å®¹ç¼–è¾‘å™¨
            const contentEditor = document.getElementById('content-editor');
            if (!contentEditor) {
                showMessage('âŒ æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            
            if (!content) {
                showMessage('âŒ è¯·å…ˆè¾“å…¥å†…å®¹', 2000, 'error');
                return;
            }
            
            // è·å–å½“å‰èŠ‚ç‚¹IDå’Œæ ‡é¢˜
            const currentNodeId = window.selectedNodeId || fourComponentGlobalState.currentNode;
            let nodeTitle = '';
            
            if (currentNodeId) {
                const nodeData = nodeDatabase[currentNodeId] || {};
                nodeTitle = nodeData.title || `èŠ‚ç‚¹${currentNodeId}`;
            } else {
                nodeTitle = 'å››ç»„ä»¶å†…å®¹';
            }
            
            if (!isQAMode) {
                // ğŸ“ éé—®ç­”æ¨¡å¼ï¼šæ‰§è¡Œç¬”è®°ä¿å­˜ + åˆ›å»ºä¼šè¯
                
                // ä¿å­˜èŠ‚ç‚¹æ•°æ®
                autoSaveData();
                
                // ğŸ”‘ åˆ›å»ºç¬”è®°ä¼šè¯
                if (currentNodeId) {
                    addSessionToNode(currentNodeId, content, 'note');
                } else {
                }
                
                // åœ¨å†…å®¹æœ«å°¾æ·»åŠ ä¿å­˜æ—¶é—´æˆ³
                if (!content.includes('[å·²ä¿å­˜]')) {
                    const timestamp = new Date().toLocaleString();
                    const newContent = content + `\n[å·²ä¿å­˜ ${timestamp}]`;
                    contentEditor.value = newContent;
                    
                }
                
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæ¶ˆæ¯
                showMessage('ğŸ’¾ ç¬”è®°å·²ä¿å­˜å¹¶æ·»åŠ åˆ°ä¼šè¯åˆ—è¡¨', 2000, 'success');
                
                // è®°å½•æ—¥å¿—
                const logEntry = `${new Date().toLocaleString()} - "${nodeTitle}" ç¬”è®°å·²ä¿å­˜`;
                
                return; // ğŸ“ ç¬”è®°æ¨¡å¼åˆ°æ­¤ç»“æŸï¼Œä¸æ‰§è¡Œæ³¨å…¥
            }
            
            // ğŸ¤– é—®ç­”æ¨¡å¼ï¼šæ‰§è¡Œå‘½ä»¤æ³¨å…¥æµç¨‹
            
            // æ„å»ºæ³¨å…¥å†…å®¹
            let injectionContent = '';
            if (nodeTitle && content) {
                injectionContent = `- ${nodeTitle}\n- ${content}`;
            } else {
                injectionContent = content;
            }
            
            try {
                // è·å–æäº¤æŒ‰é’®å¹¶ç«‹å³æ›´æ–°çŠ¶æ€
                const submitButton = document.querySelector('button[onclick="fourComponentSubmitContent()"]');
                const originalText = submitButton ? submitButton.textContent : '';
                
                if (submitButton) {
                    submitButton.textContent = 'â³ å‡†å¤‡æ³¨å…¥...';
                    submitButton.disabled = true;
                }

                // æ˜¾ç¤ºå‡†å¤‡æ³¨å…¥çš„æç¤º
                showMessage('ğŸ¯ å‡†å¤‡æ³¨å…¥ä¸­ï¼Œæ­£åœ¨è®©å‡ºçª—å£ç„¦ç‚¹...', 2000, 'warning');
                
                // å»¶è¿Ÿ500msåè®©æµè§ˆå™¨å¤±å»ç„¦ç‚¹
                setTimeout(() => {
                    try {
                        window.blur();
                    } catch (e) {
                    }
                }, 500);

                // å»¶è¿Ÿ1.5ç§’åæ‰§è¡Œæ³¨å…¥åè®®
                setTimeout(async () => {
                    try {
                        // åˆ›å»ºä¸€é”®æ³¨å…¥çš„JSONåè®®
                        const injectionData = {
                            source: 'nodemind',
                            type: 'content-injection',
                            content: injectionContent,
                            direct_inject: true,
                            timestamp: new Date().toISOString(),
                            nodeId: currentNodeId,
                            nodeTitle: nodeTitle,
                            projectName: 'NodeMind'
                        };

                        // æ„å»ºå®Œæ•´çš„å‰ªè´´æ¿å†…å®¹
                        const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                        // å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè§¦å‘injectionå·¥å…·
                        await navigator.clipboard.writeText(clipboardContent);

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showMessage('ğŸ¯ ä¸€é”®æ³¨å…¥å·²è§¦å‘å¹¶æ·»åŠ åˆ°ä¼šè¯åˆ—è¡¨ï¼injectionå·¥å…·æ­£åœ¨è‡ªåŠ¨æ‰§è¡Œ...', 3000, 'success');

                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        if (submitButton) {
                            submitButton.textContent = 'âœ… æ³¨å…¥å·²è§¦å‘';
                            
                            // 3ç§’åæ¢å¤æŒ‰é’®
                            setTimeout(() => {
                                submitButton.textContent = originalText;
                                submitButton.disabled = false;
                            }, 3000);
                        }

                        // ğŸ”‘ åˆ›å»ºé—®ç­”ä¼šè¯
                        if (currentNodeId) {
                            addSessionToNode(currentNodeId, content, 'interaction');
                        } else {
                        }
                        
                        // åœ¨å†…å®¹æœ«å°¾æ·»åŠ [å·²æ³¨å…¥]æ ‡ç­¾
                        if (!content.includes('[å·²æ³¨å…¥]')) {
                            const newContent = content + '\n[å·²æ³¨å…¥]';
                            contentEditor.value = newContent;
                        }

                        
                        // è®°å½•åˆ°æ—¥å¿—
                        const logEntry = `${new Date().toLocaleString()} - "${nodeTitle}" å†…å®¹å·²æ³¨å…¥åˆ°Cursor`;

                    } catch (innerError) {
                        console.error('å»¶è¿Ÿæ³¨å…¥å¤±è´¥:', innerError);
                        showMessage('âŒ å»¶è¿Ÿæ³¨å…¥å¤±è´¥ï¼š' + innerError.message, 3000, 'error');
                        
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        if (submitButton) {
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                        }
                    }
                }, 1500); // å»¶è¿Ÿ1.5ç§’æ‰§è¡Œ

            } catch (error) {
                console.error('ä¸€é”®æ³¨å…¥å¤±è´¥:', error);
                showMessage('âŒ ä¸€é”®æ³¨å…¥å¤±è´¥ï¼š' + error.message, 3000, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const submitButton = document.querySelector('button[onclick="fourComponentSubmitContent()"]');
                if (submitButton) {
                    submitButton.textContent = submitButton.textContent.includes('â³') ? 'æäº¤' : submitButton.textContent;
                    submitButton.disabled = false;
                }
            }
        }

        function fourComponentToggleTag(tagElement) {
            
            // ğŸ”¥ ç®€åŒ–æ–¹æ¡ˆï¼šç›´æ¥åœ¨èŠ‚ç‚¹å†…å®¹ä¸­æ·»åŠ /ç§»é™¤æ ‡ç­¾
            const currentNodeId = window.selectedNodeId || fourComponentNodeState.currentNode;
            
            
            if (!currentNodeId) {
                alert('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                return;
            }
            
            const tagName = tagElement.dataset.tag;
            const tagGroup = tagElement.dataset.group;
            
            
            
            // è·å–å½“å‰å†…å®¹ç¼–è¾‘å™¨
            const contentEditor = document.getElementById('content-editor');
            
            if (!contentEditor) {
                alert('âŒ æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨');
                return;
            }
            
            let content = contentEditor.value;
            
            const tagString = `#${tagName}`;
            
            // æ£€æŸ¥å½“å‰æ ‡ç­¾çŠ¶æ€
            const isCurrentlySelected = tagElement.classList.contains('selected');
            
            // åˆ‡æ¢æ ‡ç­¾çŠ¶æ€
            if (isCurrentlySelected) {
                // ç§»é™¤æ ‡ç­¾
                tagElement.classList.remove('selected');
                const beforeRemove = content;
                content = content.replace(new RegExp(`\\s*${tagString}\\s*`, 'g'), ' ').trim();
            } else {
                // æ·»åŠ æ ‡ç­¾
                tagElement.classList.add('selected');
                const beforeAdd = content;
                content = content + (content ? ' ' : '') + tagString;
            }
            
            // ç«‹å³æ›´æ–°å†…å®¹ç¼–è¾‘å™¨
            contentEditor.value = content;
            
            // è§¦å‘ä¿å­˜
            if (window.fourComponentContentInputHandler) {
                window.fourComponentContentInputHandler.call(contentEditor);
            } else {
            }
            
            
            // é¢å¤–éªŒè¯ï¼šå†æ¬¡æ£€æŸ¥ç¼–è¾‘å™¨çš„å€¼
            setTimeout(() => {
                const finalContent = document.getElementById('content-editor').value;
            }, 500);
        }

        // ğŸ”¥ ç¬¬ä¸‰æ¬¡é‡æ„ç‰ˆæœ¬ï¼šä»MDå†…å®¹ä¸­æ™ºèƒ½æ¢å¤æ ‡ç­¾çŠ¶æ€
        function restoreFourComponentTagStates(nodeId) {
            if (!nodeId) {
                return;
            }
            
            
            // æ¸…é™¤æ‰€æœ‰æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            
            // ä»å†…å®¹ç¼–è¾‘å™¨è·å–MDå†…å®¹
            const contentEditor = document.getElementById('content-editor');
            if (!contentEditor) {
                return;
            }
            
            const content = contentEditor.value;
            
            // æ™ºèƒ½æå–æ ‡ç­¾ï¼ˆæ”¯æŒ #æ ‡ç­¾ æ ¼å¼ï¼‰
            const tagMatches = content.match(/#[\u4e00-\u9fa5\w]+/g); // æ”¯æŒä¸­æ–‡æ ‡ç­¾
            
            if (tagMatches && tagMatches.length > 0) {
                
                let restoredCount = 0;
                tagMatches.forEach(tagMatch => {
                    const tagName = tagMatch.substring(1); // ç§»é™¤ # ç¬¦å·
                    const tagElement = document.querySelector(`[data-tag="${tagName}"]`);
                    
                    if (tagElement) {
                        tagElement.classList.add('selected');
                        restoredCount++;
                    } else {
                    }
                });
                
            } else {
            }
        }

        // (å·²åˆ é™¤ï¼šnodeDatabaseæ“ä½œå‡½æ•°ï¼Œç¬¦åˆç¬¬ä¸‰æ¬¡é‡æ„"ä¸‡ç‰©çš†MD"ç†å¿µ)
        
        // ä¿å­˜å››ç»„ä»¶æ•°æ®åˆ°localStorage
        function saveFourComponentData() {
            try {
                // ä¿å­˜å››ç»„ä»¶èŠ‚ç‚¹çŠ¶æ€æ•°æ®
                const fourComponentData = {
                    nodeData: fourComponentNodeState.nodeData,
                    currentNode: fourComponentNodeState.currentNode,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.FOUR_COMPONENT_DATA, JSON.stringify(fourComponentData));
                
                // ä¿å­˜å››ç»„ä»¶å…¨å±€çŠ¶æ€
                const fourComponentGlobalData = {
                    qaMode: fourComponentGlobalState.qaMode,
                    selectedTags: Array.from(fourComponentGlobalState.selectedTags), // å°†Setè½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿åºåˆ—åŒ–
                    selectedTemplates: fourComponentGlobalState.selectedTemplates,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE, JSON.stringify(fourComponentGlobalData));
                
                return true;
            } catch (error) {
                console.error('âŒ å››ç»„ä»¶æ•°æ®ä¿å­˜å¤±è´¥:', error);
                return false;
            }
        }

        // ä»localStorageåŠ è½½å››ç»„ä»¶æ•°æ®
        function loadFourComponentData() {
            try {
                // åŠ è½½å››ç»„ä»¶èŠ‚ç‚¹çŠ¶æ€æ•°æ®
                const savedFourComponentData = localStorage.getItem(STORAGE_KEYS.FOUR_COMPONENT_DATA);
                if (savedFourComponentData) {
                    const parsedData = JSON.parse(savedFourComponentData);
                    
                    // æ¢å¤èŠ‚ç‚¹æ•°æ®
                    if (parsedData.nodeData) {
                        fourComponentNodeState.nodeData = parsedData.nodeData;
                        
                        // è¯¦ç»†æ—¥å¿—æ¯ä¸ªèŠ‚ç‚¹çš„å†…å®¹
                        Object.entries(parsedData.nodeData).forEach(([nodeId, data]) => {
                        });
                    }
                    
                } else {
                }
                
                // åŠ è½½å››ç»„ä»¶å…¨å±€çŠ¶æ€
                const savedGlobalState = localStorage.getItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE);
                if (savedGlobalState) {
                    const parsedGlobalData = JSON.parse(savedGlobalState);
                    
                    // æ¢å¤å…¨å±€çŠ¶æ€
                    if (parsedGlobalData.qaMode !== undefined) {
                        fourComponentGlobalState.qaMode = parsedGlobalData.qaMode;
                    }
                    
                    if (parsedGlobalData.selectedTags) {
                        // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºSetï¼›å¦‚æœå·²ç»æ˜¯Setï¼Œç›´æ¥ä½¿ç”¨
                        if (Array.isArray(parsedGlobalData.selectedTags)) {
                            fourComponentGlobalState.selectedTags = new Set(parsedGlobalData.selectedTags);
                        } else {
                            fourComponentGlobalState.selectedTags = new Set(parsedGlobalData.selectedTags);
                        }
                    }
                    
                    if (parsedGlobalData.selectedTemplates) {
                        fourComponentGlobalState.selectedTemplates = parsedGlobalData.selectedTemplates;
                    }
                    
                }
                
                return true;
            } catch (error) {
                console.error('âŒ å››ç»„ä»¶æ•°æ®åŠ è½½å¤±è´¥:', error);
                return false;
            }
        }

        // æ¸…é™¤å››ç»„ä»¶æ•°æ®
        function clearFourComponentData() {
            try {
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_DATA);
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE);
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_SESSIONS);
                
                // é‡ç½®å››ç»„ä»¶çŠ¶æ€
                fourComponentNodeState.reset();
                fourComponentGlobalState.reset();
                
                return true;
            } catch (error) {
                console.error('âŒ å››ç»„ä»¶æ•°æ®æ¸…é™¤å¤±è´¥:', error);
                return false;
            }
        }

        function openFourComponentTemplateManager() {
            
            // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ¨¡æ¿
            const templates = [
                { name: 'ä¼šè®®è®°å½•æ¨¡æ¿', content: '# ä¼šè®®è®°å½•\n\n## æ—¶é—´\n\n## å‚ä¸è€…\n\n## è®®é¢˜\n\n## å†³å®šäº‹é¡¹\n\n## è¡ŒåŠ¨è®¡åˆ’' },
                { name: 'ä»»åŠ¡æ¸…å•æ¨¡æ¿', content: '# ä»»åŠ¡æ¸…å•\n\n## å¾…åŠäº‹é¡¹\n- [ ] ä»»åŠ¡1\n- [ ] ä»»åŠ¡2\n\n## è¿›è¡Œä¸­\n- [ ] ä»»åŠ¡3\n\n## å·²å®Œæˆ\n- [x] ä»»åŠ¡4' }
            ];
            
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
            fourComponentGlobalState.addTemplate(randomTemplate);
        }

        // å½“åˆ‡æ¢åˆ°èŠ‚ç‚¹ä¿¡æ¯é€‰é¡¹å¡æ—¶åˆå§‹åŒ–ä¸‰ç»„ä»¶
        function initializeFourComponents() {
            // æ¢å¤å…¨å±€çŠ¶æ€
            restoreFourComponentGlobalState();
            
        }

        // æ¢å¤å››ç»„ä»¶å…¨å±€çŠ¶æ€
        function restoreFourComponentGlobalState() {
            // æ¢å¤QAæ¨¡å¼çŠ¶æ€
            const qaToggle = document.getElementById('qa-mode-toggle');
            if (qaToggle) {
                qaToggle.checked = fourComponentGlobalState.qaMode;
                onQAModeChange(); // åº”ç”¨çŠ¶æ€
            }
            
            // ğŸ”‘ åˆå§‹åŒ–æŒ‰é’®æ–‡æœ¬ï¼ˆç¡®ä¿é¡µé¢åŠ è½½æ—¶æŒ‰é’®æ˜¾ç¤ºæ­£ç¡®çš„æ–‡æœ¬ï¼‰
            setTimeout(() => {
                updateSubmitButtonTexts(fourComponentGlobalState.qaMode);
            }, 100);
            
            // æ¢å¤é€‰ä¸­çš„æ ‡ç­¾çŠ¶æ€
            if (fourComponentGlobalState.selectedTags && fourComponentGlobalState.selectedTags.size > 0) {
                const tagContainers = document.querySelectorAll('#category-tags, #technical-tags, #status-tags');
                tagContainers.forEach(container => {
                    const tagItems = container.querySelectorAll('.tag');
                    tagItems.forEach(tagItem => {
                        const tagName = tagItem.textContent.trim();
                        if (fourComponentGlobalState.selectedTags.has(tagName)) {
                            tagItem.classList.add('selected');
                        }
                    });
                });
            }
            
        }

        // å½“é€‰æ‹©èŠ‚ç‚¹æ—¶æ›´æ–°å››ç»„ä»¶
        function updateFourComponentsForNode(nodeId) {
            if (!nodeId) return;
            
            
            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šè®¾ç½®å½“å‰èŠ‚ç‚¹ID
            fourComponentNodeState.currentNode = nodeId;
            
            // èŠ‚ç‚¹ä¿¡æ¯é¡µé¢ï¼ˆåŸå‘½ä»¤æ³¨å…¥é€‰é¡¹å¡ï¼‰ç°åœ¨æ˜¯é»˜è®¤é¡µé¢ï¼Œæ— éœ€æ£€æŸ¥
            
            // ä»ä¸»åº”ç”¨è·å–èŠ‚ç‚¹æ•°æ®
            let node = null;
            let cleanTitle = '';
            
            // å°è¯•ä»å½“å‰æ€ç»´å¯¼å›¾è·å–èŠ‚ç‚¹æ•°æ®
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    cleanTitle = node.topic.replace(' ğŸ“„', '');
                }
            }
            
            // ä»nodeDatabaseè·å–æ›´å®Œæ•´çš„æ•°æ®
            const nodeData = nodeDatabase[nodeId] || {};
            
            // å¦‚æœæ²¡æœ‰ä»æ€ç»´å¯¼å›¾è·å–åˆ°æ ‡é¢˜ï¼Œä½¿ç”¨æ•°æ®åº“ä¸­çš„æ ‡é¢˜
            if (!cleanTitle && nodeData.title) {
                cleanTitle = nodeData.title;
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ ‡é¢˜ï¼Œä½¿ç”¨é»˜è®¤æ ‡é¢˜
            if (!cleanTitle) {
                cleanTitle = `èŠ‚ç‚¹ ${nodeId}`;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»localStorageæ¢å¤çš„å››ç»„ä»¶æ•°æ®
            const savedNodeData = fourComponentNodeState.nodeData[nodeId];
            
            // ğŸ”¥ ç¬¬ä¸‰æ¬¡é‡æ„ï¼šä¸‡èƒ½æ•°æ®æ¶æ„çš„æ•°æ®ä¼˜å…ˆçº§
            // 1. nodeDatabaseï¼ˆä¸‡èƒ½æ•°æ®æ¶æ„çš„ä¸»å­˜å‚¨ï¼‰
            // 2. savedNodeDataï¼ˆå››ç»„ä»¶æœ¬åœ°ç¼“å­˜ï¼‰
            // 3. cleanTitleï¼ˆä»æ€ç»´å¯¼å›¾è·å–ï¼‰
            const finalTitle = nodeData.title || savedNodeData?.title || cleanTitle || `èŠ‚ç‚¹ ${nodeId}`;
            const finalContent = nodeData.content || savedNodeData?.content || '';
            
            
            fourComponentNodeState.nodeData[nodeId] = {
                id: nodeId,
                title: finalTitle,
                content: finalContent,
                createTime: savedNodeData?.createTime || (nodeData.created ? new Date(nodeData.created).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN')),
                updateTime: savedNodeData?.updateTime || (nodeData.modified ? new Date(nodeData.modified).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'))
            };
            
            
            // åŠ è½½èŠ‚ç‚¹åˆ°å››ç»„ä»¶
            fourComponentNodeState.loadNode(nodeId);
            
            // ç¡®ä¿UIå…ƒç´ æ˜¾ç¤ºæ­£ç¡®çš„å†…å®¹
            setTimeout(() => {
                const contentEditor = document.getElementById('content-editor');
                
                if (contentEditor && contentEditor.value !== finalContent) {
                    contentEditor.value = finalContent;
                }
            }, 100);
            
            // ç»‘å®šå››ç»„ä»¶çš„è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
            bindFourComponentInputEvents(nodeId);
            
            // æ¢å¤æ ‡ç­¾é€‰ä¸­çŠ¶æ€
            setTimeout(() => {
                restoreFourComponentTagStates(nodeId);
            }, 100);
            
        }

        // ç»‘å®šå››ç»„ä»¶è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
        function bindFourComponentInputEvents(nodeId) {
            const contentEditor = document.getElementById('content-editor');
            
            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
            if (contentEditor) {
                contentEditor.removeEventListener('input', window.fourComponentContentInputHandler);
                contentEditor.removeEventListener('blur', window.fourComponentContentBlurHandler);
            }
            
            // ğŸ”¥ ç¬¬ä¸‰æ¬¡é‡æ„ï¼šä½¿ç”¨ä¸‡èƒ½æ•°æ®æ¶æ„çš„MDç›´å­˜é€»è¾‘
            window.fourComponentContentInputHandler = async function() {
                const content = this.value;
                
                // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®ï¼ˆä¿æŒå®æ—¶å“åº”ï¼‰
                updateFourComponentNodeContent(nodeId, content);
                
                // æ¸…é™¤ä¹‹å‰çš„ä¿å­˜è®¡æ—¶å™¨
                clearTimeout(window.fourComponentMDSaveTimeout);
                
                                        // ğŸ¯ ç¬¬ä¸‰æ¬¡é‡æ„ï¼šç®€åŒ–MDç›´å­˜é€»è¾‘
                        window.fourComponentMDSaveTimeout = setTimeout(async () => {
                            try {
                                // ç›´æ¥æ›´æ–°nodeDatabaseå’ŒlocalStorage
                                if (nodeDatabase[nodeId]) {
                                    nodeDatabase[nodeId].content = content;
                                    nodeDatabase[nodeId].modified = new Date().toISOString();
                                }
                                
                                // ä¿å­˜åˆ°localStorage
                                localStorage.setItem('nodemind_node_database', JSON.stringify(nodeDatabase));
                                
                                
                            } catch (error) {
                                console.error('âŒ [ç¬¬ä¸‰æ¬¡é‡æ„] å››ç»„ä»¶ä¿å­˜å¤±è´¥:', error);
                                
                                // é™çº§ä¿æŠ¤
                                if (window.autoSaveData) {
                                    autoSaveData();
                                }
                            }
                        }, 800);
            };
            
            window.fourComponentContentBlurHandler = function() {
                autoSaveData();
            };
            
            // ç»‘å®šå†…å®¹è¾“å…¥å®æ—¶è”åŠ¨
            if (contentEditor) {
                contentEditor.addEventListener('input', window.fourComponentContentInputHandler);
                contentEditor.addEventListener('blur', window.fourComponentContentBlurHandler);
            }
            
        }

        // æ›´æ–°å››ç»„ä»¶èŠ‚ç‚¹æ ‡é¢˜
        function updateFourComponentNodeTitle(nodeId, title) {
            
            // ç¡®ä¿nodeDatabaseä¸­å­˜åœ¨è¯¥èŠ‚ç‚¹
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: title || `èŠ‚ç‚¹ ${nodeId}`,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            // æ›´æ–°å››ç»„ä»¶æ•°æ®
            if (!fourComponentNodeState.nodeData[nodeId]) {
                fourComponentNodeState.nodeData[nodeId] = {
                    id: nodeId,
                    title: title || `èŠ‚ç‚¹ ${nodeId}`,
                    content: nodeDatabase[nodeId].content || '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            }
            
            fourComponentNodeState.nodeData[nodeId].title = title || `èŠ‚ç‚¹ ${nodeId}`;
            fourComponentNodeState.nodeData[nodeId].updateTime = new Date().toLocaleString('zh-CN');
            
            // åŒæ­¥åˆ°ä¸»åº”ç”¨nodeDatabase
            nodeDatabase[nodeId].title = title || `èŠ‚ç‚¹ ${nodeId}`;
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            
            // åŒæ­¥æ›´æ–°æ€ç»´å¯¼å›¾æ˜¾ç¤º
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                const node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    // ä¿æŒå†…å®¹å›¾æ ‡
                    const hasContent = nodeDatabase[nodeId].content && nodeDatabase[nodeId].content.trim().length > 0;
                    const displayTitle = hasContent ? `${title} ğŸ“„` : title;
                    currentMindmapInstance.update_node(nodeId, displayTitle);
                }
            }
            
            // æ›´æ–°å››ç»„ä»¶çš„æ ‡é¢˜æ˜¾ç¤º
            const nodeTitleElement = document.getElementById('node-title');
            if (nodeTitleElement) {
                nodeTitleElement.textContent = title;
            }
            
            // ç«‹å³ä¿å­˜åˆ°localStorage
            try {
                saveFourComponentData();
            } catch (error) {
                console.error(`âŒ å››ç»„ä»¶æ•°æ®ä¿å­˜å¤±è´¥:`, error);
            }
            
        }

        // æ›´æ–°å››ç»„ä»¶èŠ‚ç‚¹å†…å®¹
        function updateFourComponentNodeContent(nodeId, content) {
            
            // ç¡®ä¿nodeDatabaseä¸­å­˜åœ¨è¯¥èŠ‚ç‚¹
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: `èŠ‚ç‚¹ ${nodeId}`,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            // æ›´æ–°å››ç»„ä»¶æ•°æ®
            if (!fourComponentNodeState.nodeData[nodeId]) {
                fourComponentNodeState.nodeData[nodeId] = {
                    id: nodeId,
                    title: nodeDatabase[nodeId].title || `èŠ‚ç‚¹ ${nodeId}`,
                    content: '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            }
            
            fourComponentNodeState.nodeData[nodeId].content = content || '';
            fourComponentNodeState.nodeData[nodeId].updateTime = new Date().toLocaleString('zh-CN');
            
            // åŒæ­¥åˆ°ä¸»åº”ç”¨nodeDatabase
            nodeDatabase[nodeId].content = content || '';
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            
            // æ›´æ–°èŠ‚ç‚¹æ˜¾ç¤ºå›¾æ ‡
            updateNodeContentIcon(nodeId, content);
            
            // ç«‹å³ä¿å­˜åˆ°localStorage
            try {
                saveFourComponentData();
            } catch (error) {
                console.error(`âŒ å››ç»„ä»¶æ•°æ®ä¿å­˜å¤±è´¥:`, error);
            }
            
        }

        // ç›‘å¬é€‰é¡¹å¡åˆ‡æ¢
        document.addEventListener('click', (e) => {
            if (e.target.id === 'detail_tab_injection' || e.target.getAttribute('data-tab') === 'injection') {
                // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => {
                    initializeFourComponents();
                    // å¦‚æœæœ‰å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹ï¼Œé‡æ–°ç»‘å®šäº‹ä»¶
                    const currentNode = window.selectedNodeId || fourComponentNodeState.currentNode;
                    if (currentNode) {
                        setTimeout(() => {
                            bindFourComponentInputEvents(currentNode);
                        }, 200);
                    }
                }, 100);
            }
        });

        // å¯¼å‡ºå››ç»„ä»¶å‡½æ•°åˆ°å…¨å±€
        window.onQAModeChange = onQAModeChange;
        window.fourComponentUpdateTitle = fourComponentUpdateTitle;
        window.fourComponentCopyContent = fourComponentCopyContent;

        window.fourComponentPasteContent = fourComponentPasteContent;
        window.fourComponentSubmitContent = fourComponentSubmitContent;
        window.fourComponentToggleTag = fourComponentToggleTag;

        window.fourComponentGlobalState = fourComponentGlobalState;
        window.fourComponentNodeState = fourComponentNodeState;
        window.initializeFourComponents = initializeFourComponents;
        window.updateFourComponentsForNode = updateFourComponentsForNode;
        window.bindFourComponentInputEvents = bindFourComponentInputEvents;
        window.updateFourComponentNodeTitle = updateFourComponentNodeTitle;
        window.updateFourComponentNodeContent = updateFourComponentNodeContent;
        window.toggleFourComponentTag = toggleFourComponentTag;
        window.addFourComponentTagToNode = addFourComponentTagToNode;
        window.removeFourComponentTagFromNode = removeFourComponentTagFromNode;
        window.restoreFourComponentTagStates = restoreFourComponentTagStates;
        window.saveFourComponentData = saveFourComponentData;
        window.loadFourComponentData = loadFourComponentData;
        window.clearFourComponentData = clearFourComponentData;
        window.restoreFourComponentGlobalState = restoreFourComponentGlobalState;

        // ğŸ—‚ï¸ ä¸‰å±‚æ¬¡åˆ†ç±»ç®¡ç†ç³»ç»Ÿ
        let categoryMindmap = null;
        let contentMindmap = null;
        let currentSelectedCategory = null;
        
        // åˆ†ç±»æ•°æ®å­˜å‚¨
        const categoryData = {
            categories: {
                "cat_tags": { id: "cat_tags", name: "ğŸ·ï¸ æ ‡ç­¾ç®¡ç†", type: "tags" },
                "cat_templates": { id: "cat_templates", name: "ğŸ“ æ¨¡æ¿ç®¡ç†", type: "templates" },
                "cat_tools": { id: "cat_tools", name: "ğŸ”§ å·¥å…·ç®¡ç†", type: "tools" },
                "cat_data": { id: "cat_data", name: "ğŸ“Š æ•°æ®ç®¡ç†", type: "data" }
            },
            content: {
                tags: {
                    "tag_1": { id: "tag_1", name: "1", group: "å¸¸è§„" },
                    "tag_2": { id: "tag_2", name: "2", group: "å¸¸è§„" },
                    "tag_3": { id: "tag_3", name: "3", group: "å¸¸è§„" },
                    "tag_important": { id: "tag_important", name: "é‡è¦", group: "å¸¸è§„" },
                    "tag_todo": { id: "tag_todo", name: "å¾…åŠ", group: "å¸¸è§„" },
                    "tag_gpt": { id: "tag_gpt", name: "GPT", group: "AI" },
                    "tag_analysis": { id: "tag_analysis", name: "åˆ†æ", group: "AI" },
                    "tag_generate": { id: "tag_generate", name: "ç”Ÿæˆ", group: "AI" },
                    "tag_idea": { id: "tag_idea", name: "æƒ³æ³•", group: "ç¬”è®°" },
                    "tag_plan": { id: "tag_plan", name: "è®¡åˆ’", group: "ç¬”è®°" },
                    "tag_summary": { id: "tag_summary", name: "æ€»ç»“", group: "ç¬”è®°" }
                },
                templates: {},
                tools: {},
                data: {}
            }
        };

        // åˆå§‹åŒ–åˆ†ç±»ç®¡ç†ç³»ç»Ÿ
        function initializeCategoryManagementSystem() {
            
            // åˆå§‹åŒ–åˆ†ç±»è„‘å›¾
            initializeCategoryMindmap();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            setupCategoryEventListeners();
            
        }

        // åˆå§‹åŒ–åˆ†ç±»è„‘å›¾
        function initializeCategoryMindmap() {
            const container = document.getElementById('jsmind_container_categories');
            if (!container) {
                console.error('âŒ æ‰¾ä¸åˆ°åˆ†ç±»è„‘å›¾å®¹å™¨');
                return;
            }

            // æ„å»ºåˆ†ç±»è„‘å›¾æ•°æ®
            const categoryMindmapData = {
                "meta": {
                    "name": "åˆ†ç±»ç®¡ç†",
                    "author": "NodeMind",
                    "version": "1.0"
                },
                "format": "node_tree",
                "data": {
                    "id": "root_categories",
                    "topic": "ğŸ—‚ï¸ åˆ†ç±»ä¸­å¿ƒ",
                    "children": [
                        {
                            "id": "cat_tags",
                            "topic": "ğŸ·ï¸ æ ‡ç­¾ç®¡ç†",
                            "data": { "category_type": "tags" }
                        },
                        {
                            "id": "cat_templates", 
                            "topic": "ğŸ“ æ¨¡æ¿ç®¡ç†",
                            "data": { "category_type": "templates" }
                        },
                        {
                            "id": "cat_tools",
                            "topic": "ğŸ”§ å·¥å…·ç®¡ç†", 
                            "data": { "category_type": "tools" }
                        },
                        {
                            "id": "cat_data",
                            "topic": "ğŸ“Š æ•°æ®ç®¡ç†",
                            "data": { "category_type": "data" }
                        }
                    ]
                }
            };

            // åˆ›å»ºåˆ†ç±»è„‘å›¾å®ä¾‹
            const categoryOptions = {
                container: 'jsmind_container_categories',
                theme: 'primary',
                editable: true,
                shortcut: {
                    enable: true,
                    handles: {},
                    mapping: {
                        addchild: 13, // Enter
                        addbrother: 45, // Insert
                        editnode: 113, // F2
                        delnode: 46, // Delete
                    }
                }
            };

            categoryMindmap = new jsMind(categoryOptions);
            categoryMindmap.show(categoryMindmapData);
            
        }

        // è®¾ç½®åˆ†ç±»äº‹ä»¶ç›‘å¬å™¨
        function setupCategoryEventListeners() {
            if (!categoryMindmap) return;
            
            // ç›‘å¬åˆ†ç±»èŠ‚ç‚¹é€‰æ‹©äº‹ä»¶
            categoryMindmap.add_event_listener(function(type, data) {
                if (type === 4) { // èŠ‚ç‚¹é€‰æ‹©äº‹ä»¶
                    handleCategoryNodeSelect(data.node);
                }
            });
        }

        // å¤„ç†åˆ†ç±»èŠ‚ç‚¹é€‰æ‹©
        function handleCategoryNodeSelect(nodeId) {
            
            const node = categoryMindmap.get_node(nodeId);
            if (!node || !node.data || !node.data.category_type) {
                return;
            }
            
            currentSelectedCategory = node.data.category_type;
            
            // æ›´æ–°å³ä¾§å†…å®¹æ ‡é¢˜
            const titleElement = document.getElementById('content-mindmap-title');
            if (titleElement) {
                titleElement.textContent = `${node.topic} å†…å®¹`;
            }
            
            // å¯ç”¨å³ä¾§æ§åˆ¶æŒ‰é’®
            document.getElementById('add-content-btn').disabled = false;
            document.getElementById('save-content-btn').disabled = false;
            
            // åŠ è½½å¯¹åº”çš„å†…å®¹è„‘å›¾
            loadContentMindmap(currentSelectedCategory);
        }

        // åŠ è½½å†…å®¹è„‘å›¾
        function loadContentMindmap(categoryType) {
            
            const container = document.getElementById('jsmind_container_content');
            if (!container) return;
            
            // æ¸…é™¤ç©ºçŠ¶æ€
            const emptyState = container.querySelector('.empty-content-state');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // æ„å»ºå†…å®¹è„‘å›¾æ•°æ®
            const contentData = buildContentMindmapData(categoryType);
            
            // åˆ›å»ºæˆ–æ›´æ–°å†…å®¹è„‘å›¾
            if (contentMindmap) {
                contentMindmap.show(contentData);
            } else {
                const contentOptions = {
                    container: 'jsmind_container_content',
                    theme: 'greensea',
                    editable: true
                };
                contentMindmap = new jsMind(contentOptions);
                contentMindmap.show(contentData);
            }
            
        }

        // æ„å»ºå†…å®¹è„‘å›¾æ•°æ®
        function buildContentMindmapData(categoryType) {
            const contentItems = categoryData.content[categoryType] || {};
            
            let rootTopic = 'ğŸ“‹ å†…å®¹ç®¡ç†';
            switch(categoryType) {
                case 'tags': rootTopic = 'ğŸ·ï¸ æ ‡ç­¾å†…å®¹'; break;
                case 'templates': rootTopic = 'ğŸ“ æ¨¡æ¿å†…å®¹'; break;
                case 'tools': rootTopic = 'ğŸ”§ å·¥å…·å†…å®¹'; break;
                case 'data': rootTopic = 'ğŸ“Š æ•°æ®å†…å®¹'; break;
            }
            
            const children = Object.values(contentItems).map(item => ({
                id: item.id,
                topic: item.name,
                data: { 
                    item_type: categoryType,
                    group: item.group || 'default'
                }
            }));
            
            return {
                "meta": {
                    "name": `${categoryType}å†…å®¹`,
                    "author": "NodeMind",
                    "version": "1.0"
                },
                "format": "node_tree",
                "data": {
                    "id": `root_${categoryType}`,
                    "topic": rootTopic,
                    "children": children
                }
            };
        }

        // æ–°å¢åˆ†ç±»
        function addNewCategory() {
            const categoryName = prompt('è¯·è¾“å…¥æ–°åˆ†ç±»åç§°:');
            if (!categoryName) return;
            
            const categoryId = 'cat_' + Date.now();
            const categoryType = categoryName.toLowerCase().replace(/\s+/g, '_');
            
            // æ·»åŠ åˆ°åˆ†ç±»æ•°æ®
            categoryData.categories[categoryId] = {
                id: categoryId,
                name: categoryName,
                type: categoryType
            };
            
            // æ·»åŠ åˆ°åˆ†ç±»è„‘å›¾
            categoryMindmap.add_node('root_categories', categoryId, categoryName, {
                category_type: categoryType
            });
            
        }

        // æ–°å¢å†…å®¹é¡¹
        function addNewContentItem() {
            if (!currentSelectedCategory) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç±»');
                return;
            }
            
            const itemName = prompt('è¯·è¾“å…¥å†…å®¹åç§°:');
            if (!itemName) return;
            
            const itemId = currentSelectedCategory + '_' + Date.now();
            
            // æ·»åŠ åˆ°å†…å®¹æ•°æ®
            if (!categoryData.content[currentSelectedCategory]) {
                categoryData.content[currentSelectedCategory] = {};
            }
            
            categoryData.content[currentSelectedCategory][itemId] = {
                id: itemId,
                name: itemName,
                group: 'default'
            };
            
            // æ·»åŠ åˆ°å†…å®¹è„‘å›¾
            contentMindmap.add_node(`root_${currentSelectedCategory}`, itemId, itemName, {
                item_type: currentSelectedCategory,
                group: 'default'
            });
            
        }

        // ä¿å­˜åˆ†ç±»è„‘å›¾
        function saveCategoryMindmap() {
            if (!categoryMindmap) return;
            
            const data = categoryMindmap.get_data();
            localStorage.setItem('nodemind_category_mindmap', JSON.stringify(data));
            localStorage.setItem('nodemind_category_data', JSON.stringify(categoryData));
            
            alert('åˆ†ç±»è„‘å›¾å·²ä¿å­˜');
        }

        // ä¿å­˜å†…å®¹è„‘å›¾
        function saveContentMindmap() {
            if (!contentMindmap || !currentSelectedCategory) return;
            
            const data = contentMindmap.get_data();
            localStorage.setItem(`nodemind_content_${currentSelectedCategory}`, JSON.stringify(data));
            
            alert('å†…å®¹è„‘å›¾å·²ä¿å­˜');
        }

        // åŒæ­¥æ ‡ç­¾æ•°æ®åˆ°æ ‡ç­¾ç»„ä»¶
        function syncTagsToComponents() {
            
            const tagsData = categoryData.content.tags || {};
            const tagContainer = document.getElementById('tag-groups');
            
            if (!tagContainer) {
                return;
            }
            
            // æŒ‰ç»„åˆ†ç±»æ ‡ç­¾
            const tagGroups = {};
            Object.values(tagsData).forEach(tag => {
                const group = tag.group || 'é»˜è®¤';
                if (!tagGroups[group]) {
                    tagGroups[group] = [];
                }
                tagGroups[group].push(tag);
            });
            
            // ç”Ÿæˆæ ‡ç­¾HTML
            let tagsHTML = '';
            Object.entries(tagGroups).forEach(([groupName, tags]) => {
                tagsHTML += `
                    <div class="tag-group">
                        <div class="tag-group-title">${groupName}</div>
                        <div class="tag-group-items">`;
                
                tags.forEach(tag => {
                    tagsHTML += `<span class="tag" data-tag="${tag.name}" data-group="${groupName}" onclick="fourComponentToggleTag(this)">${tag.name}</span>`;
                });
                
                tagsHTML += `</div></div>`;
            });
            
            tagContainer.innerHTML = tagsHTML;
        }

        // æš´éœ²å‡½æ•°åˆ°å…¨å±€
        window.initializeCategoryManagementSystem = initializeCategoryManagementSystem;
        window.addNewCategory = addNewCategory;
        window.addNewContentItem = addNewContentItem;
        window.saveCategoryMindmap = saveCategoryMindmap;
        window.saveContentMindmap = saveContentMindmap;
        window.syncTagsToComponents = syncTagsToComponents;
        
        // ğŸ”¥ ç¬¬ä¸‰æ¬¡é‡æ„æ¶æ„åˆå§‹åŒ–
        let universalDataService = null;
        let smartMDParser = null;
        let uiIntegrationAdapter = null;
        
        // åˆå§‹åŒ–ç¬¬ä¸‰æ¬¡é‡æ„æœåŠ¡
        function initThirdReconstructionArchitecture() {
            
            try {
                // åˆå§‹åŒ–ä¸‡èƒ½æ•°æ®æœåŠ¡
                if (window.UniversalDataService) {
                    universalDataService = new window.UniversalDataService();
                } else {
                    console.warn('âš ï¸ UniversalDataService æœªæ‰¾åˆ°');
                }
                
                // åˆå§‹åŒ–æ™ºèƒ½MDè§£æå™¨
                if (window.SmartMDParser) {
                    smartMDParser = new window.SmartMDParser();
                } else {
                    console.warn('âš ï¸ SmartMDParser æœªæ‰¾åˆ°');
                }
                
                // åˆå§‹åŒ–UIé›†æˆé€‚é…å™¨
                if (window.UIIntegrationAdapter) {
                    uiIntegrationAdapter = new window.UIIntegrationAdapter();
                } else {
                    console.warn('âš ï¸ UIIntegrationAdapter æœªæ‰¾åˆ°');
                }
                
                // å°†æœåŠ¡æš´éœ²åˆ°å…¨å±€
                window.universalDataService = universalDataService;
                window.smartMDParser = smartMDParser;
                window.uiIntegrationAdapter = uiIntegrationAdapter;
                
                
                // å¯ç”¨æ–°æ¶æ„æ ‡è®°
                window.thirdReconstructionEnabled = true;
                
            } catch (error) {
                console.error('âŒ ç¬¬ä¸‰æ¬¡é‡æ„æ¶æ„åˆå§‹åŒ–å¤±è´¥:', error);
                window.thirdReconstructionEnabled = false;
            }
        }
        
        // é¡µé¢åŠ è½½åç«‹å³åˆå§‹åŒ–ç¬¬ä¸‰æ¬¡é‡æ„æ¶æ„
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿ500msç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½å·²åŠ è½½
            setTimeout(initThirdReconstructionArchitecture, 500);
        });
        
        // MDç›´å­˜åŠŸèƒ½
        let mdDirectService = null;
        
        async function initMDDirectService() {
            if (!mdDirectService) {
                
                // ç›´æ¥åˆ›å»ºç®€åŒ–æœåŠ¡ï¼Œæ— ä»»ä½•æ¨¡å—ä¾èµ–
                mdDirectService = {
                    async addMDContent(content, options = {}) {
                        try {
                            
                            // ç›´æ¥æ›´æ–°åˆ°nodeDatabase
                            const nodeId = options.nodeId || 'md_' + Date.now();
                            const lines = content.split('\n');
                            const title = lines[0].replace(/^#+\s*/, '') || 'æœªå‘½å';
                            const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                            
                            if (window.nodeDatabase) {
                                window.nodeDatabase[nodeId] = {
                                    id: nodeId,
                                    title: title,
                                    content: actualContent,
                                    modified: new Date().toISOString(),
                                    ...window.nodeDatabase[nodeId]
                                };
                                
                                // ä¿å­˜åˆ°localStorage
                                localStorage.setItem('nodemind_node_database', JSON.stringify(window.nodeDatabase));
                            }
                            
                            return {
                                success: true,
                                id: nodeId,
                                message: 'MDå†…å®¹å·²ä¿å­˜'
                            };
                        } catch (error) {
                            console.error('MDç›´å­˜å¤±è´¥:', error);
                            return {
                                success: false,
                                error: error.message
                            };
                        }
                    }
                };
                
            }
            return mdDirectService;
        }
        
        function createMockMDDirectService() {
            return {
                async addMDContent(content, options = {}) {
                    
                    // è§£æMDå†…å®¹
                    const lines = content.split('\n');
                    const title = lines[0].replace(/^#+\s*/, '') || 'æœªå‘½å';
                    const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                    
                    // å¦‚æœæŒ‡å®šäº†nodeIdä¸”è¦æ±‚æ›´æ–°ç°æœ‰èŠ‚ç‚¹
                    if (options.nodeId && options.updateExisting) {
                        
                        // æ›´æ–°nodeDatabase
                        if (window.nodeDatabase && window.nodeDatabase[options.nodeId]) {
                            window.nodeDatabase[options.nodeId].title = title;
                            window.nodeDatabase[options.nodeId].content = actualContent;
                            window.nodeDatabase[options.nodeId].modified = new Date().toISOString();
                        }
                        
                        // æ›´æ–°å››ç»„ä»¶æ•°æ®
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData[options.nodeId]) {
                                window.fourComponentNodeState.nodeData[options.nodeId] = {};
                            }
                            window.fourComponentNodeState.nodeData[options.nodeId].title = title;
                            window.fourComponentNodeState.nodeData[options.nodeId].content = actualContent;
                            window.fourComponentNodeState.nodeData[options.nodeId].modified = new Date().toISOString();
                            
                            if (window.saveFourComponentData) {
                                window.saveFourComponentData();
                            }
                        }
                        
                        // è‡ªåŠ¨ä¿å­˜
                        if (window.autoSaveData) {
                            window.autoSaveData();
                        }
                        
                        return {
                            success: true,
                            id: options.nodeId,
                            data: { title, content: actualContent },
                            message: `èŠ‚ç‚¹ ${options.nodeId} å·²é€šè¿‡MDç›´å­˜æ›´æ–°`
                        };
                    } else {
                        // åˆ›å»ºæ–°èŠ‚ç‚¹
                        const nodeId = options.nodeId || 'md_' + Date.now();
                        const nodeData = {
                            id: nodeId,
                            title: title,
                            content: actualContent,
                            tags: [],
                            created: new Date().toISOString(),
                            modified: new Date().toISOString()
                        };
                        
                        // æ·»åŠ åˆ°nodeDatabase
                        if (window.nodeDatabase) {
                            window.nodeDatabase[nodeId] = nodeData;
                        }
                        
                        // æ·»åŠ åˆ°å››ç»„ä»¶æ•°æ®
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData) {
                                window.fourComponentNodeState.nodeData = {};
                            }
                            window.fourComponentNodeState.nodeData[nodeId] = nodeData;
                            
                            if (window.saveFourComponentData) {
                                window.saveFourComponentData();
                            }
                        }
                        
                        // è‡ªåŠ¨ä¿å­˜
                        if (window.autoSaveData) {
                            window.autoSaveData();
                        }
                        
                        return {
                            success: true,
                            id: nodeId,
                            data: nodeData,
                            message: 'MDå†…å®¹å·²æˆåŠŸå­˜å‚¨åˆ°NodeMind'
                        };
                    }
                },
                
                previewMDParsing(content) {
                    const lines = content.split('\n');
                    const title = lines[0].replace(/^#+\s*/, '') || 'æœªå‘½å';
                    const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                    
                    let type = 'note';
                    if (content.includes('ä»»åŠ¡') || content.includes('å®ç°') || content.includes('å¼€å‘')) {
                        type = 'task';
                    } else if (content.includes('æ¨¡æ¿') || content.includes('æ ¼å¼')) {
                        type = 'template';
                    }
                    
                    return {
                        success: true,
                        preview: {
                            title,
                            content: actualContent,
                            type,
                            estimatedSize: content.length
                        }
                    };
                }
            };
        }
        
        async function openMDDirectPanel() {
            await initMDDirectService();
            document.getElementById('md-direct-panel').style.display = 'flex';
        }
        
        function closeMDDirectPanel() {
            document.getElementById('md-direct-panel').style.display = 'none';
        }
        
        async function previewMDContent() {
            const content = document.getElementById('md-input').value;
            if (!content.trim()) {
                alert('è¯·è¾“å…¥MDå†…å®¹');
                return;
            }
            
            const service = await initMDDirectService();
            const result = service.previewMDParsing(content);
            
            document.getElementById('md-result').innerHTML = `
                <h4>ğŸ“‹ è§£æé¢„è§ˆ</h4>
                <div class="preview-item"><strong>æ ‡é¢˜:</strong> ${result.preview.title}</div>
                <div class="preview-item"><strong>ç±»å‹:</strong> ${result.preview.type}</div>
                <div class="preview-item"><strong>å†…å®¹é•¿åº¦:</strong> ${result.preview.estimatedSize} å­—ç¬¦</div>
                <div class="preview-content">
                    <strong>å†…å®¹é¢„è§ˆ:</strong>
                    <pre>${result.preview.content.substring(0, 200)}${result.preview.content.length > 200 ? '...' : ''}</pre>
                </div>
            `;
        }
        
        async function storeMDContent() {
            const content = document.getElementById('md-input').value;
            if (!content.trim()) {
                alert('è¯·è¾“å…¥MDå†…å®¹');
                return;
            }
            
            try {
                const service = await initMDDirectService();
                const result = await service.addMDContent(content);
                
                if (result.success) {
                    document.getElementById('md-result').innerHTML = `
                        <h4>âœ… å­˜å‚¨æˆåŠŸ</h4>
                        <div class="success-item"><strong>èŠ‚ç‚¹ID:</strong> ${result.id}</div>
                        <div class="success-item"><strong>æ ‡é¢˜:</strong> ${result.data.title}</div>
                        <div class="success-item"><strong>çŠ¶æ€:</strong> ${result.message}</div>
                        <div class="success-note">
                            ğŸ’¡ å†…å®¹å·²æˆåŠŸæ·»åŠ åˆ°NodeMindï¼Œæ‰€æœ‰è”åŠ¨æœºåˆ¶æ­£å¸¸å·¥ä½œï¼
                        </div>
                    `;
                    
                    // æ¸…ç©ºè¾“å…¥
                    document.getElementById('md-input').value = '';
                    
                    // åˆ·æ–°ç•Œé¢
                    if (window.refreshMindmapDisplay) {
                        window.refreshMindmapDisplay();
                    }
                } else {
                    throw new Error(result.error || 'å­˜å‚¨å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('md-result').innerHTML = `
                    <h4>âŒ å­˜å‚¨å¤±è´¥</h4>
                    <div class="error-message">${error.message}</div>
                `;
            }
        }
        
        function clearMDPanel() {
            document.getElementById('md-input').value = '';
            document.getElementById('md-result').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç¬¬ä¸‰æ¬¡é‡æ„æ¶æ„
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿ500msç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½å·²åŠ è½½
            setTimeout(initThirdReconstructionArchitecture, 500);
        });
        
        // ğŸ”¥ ç¬¬ä¸‰æ¬¡é‡æ„ï¼šMDæ–‡æ¡£å¯¼å…¥åŠŸèƒ½
        async function importMDDocument() {
            try {
                // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.md,.txt';
                fileInput.style.display = 'none';
                
                return new Promise((resolve, reject) => {
                    fileInput.onchange = async (event) => {
                        const file = event.target.files[0];
                        if (!file) {
                            reject(new Error('æœªé€‰æ‹©æ–‡ä»¶'));
                            return;
                        }
                        
                        
                        try {
                            // è¯»å–æ–‡ä»¶å†…å®¹
                            const content = await file.text();
                            
                            // ä½¿ç”¨ç¬¬ä¸‰æ¬¡é‡æ„çš„ä¸‡èƒ½æ•°æ®æ¶æ„å¤„ç†
                            const result = await processImportedMDDocument(content, file.name);
                            
                            if (result.success) {
                                
                                // åˆ·æ–°ç•Œé¢æ˜¾ç¤º
                                if (window.refreshMindmapDisplay) {
                                    window.refreshMindmapDisplay();
                                }
                                
                                // åˆ‡æ¢åˆ°å››ç»„ä»¶é¢æ¿
                                switchToDetailTab();
                                
                                resolve(result);
                            } else {
                                throw new Error(result.error);
                            }
                            
                        } catch (error) {
                            console.error(`âŒ [MDå¯¼å…¥] å¤„ç†å¤±è´¥:`, error);
                            reject(error);
                        }
                    };
                    
                    // è§¦å‘æ–‡ä»¶é€‰æ‹©
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                });
                
            } catch (error) {
                console.error(`âŒ [MDå¯¼å…¥] åˆå§‹åŒ–å¤±è´¥:`, error);
                throw error;
            }
        }
        
        // ğŸ¯ å¤„ç†å¯¼å…¥çš„MDæ–‡æ¡£ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function processImportedMDDocument(mdContent, fileName) {
            try {
                
                // è§£æMDæ–‡æ¡£ç»“æ„ - ä½¿ç”¨ä¿®å¤ç‰ˆè§£æå™¨
                const parsedNodes = window.parseImportedMDNodes_NEW ? 
                    window.parseImportedMDNodes_NEW(mdContent) : 
                    parseImportedMDNodes_NEW(mdContent);
                
                let importedCount = 0;
                let skippedCount = 0;
                
                // ç¡®ä¿å¿…è¦çš„å…¨å±€æ•°æ®ç»“æ„å­˜åœ¨
                if (!window.nodeDatabase) {
                    window.nodeDatabase = {};
                }
                
                // ç®€åŒ–ç‰ˆæœ¬ï¼šç›´æ¥æ·»åŠ åˆ°nodeDatabaseå’Œå››ç»„ä»¶æ•°æ®
                for (const nodeInfo of parsedNodes) {
                    try {
                        const nodeId = nodeInfo.id || `import_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
                        
                        // åˆ›å»ºèŠ‚ç‚¹æ•°æ®
                        const nodeData = {
                            id: nodeId,
                            title: nodeInfo.title,
                            content: nodeInfo.content || '',
                            tags: nodeInfo.tags || [],
                            author: nodeInfo.author || 'å¯¼å…¥ç”¨æˆ·',
                            priority: nodeInfo.priority || 'medium',
                            status: nodeInfo.status || 'pending',
                            time: {
                                created: new Date().toLocaleString(),
                                modified: new Date().toLocaleString()
                            },
                            importSource: fileName,
                            importTime: new Date().toISOString()
                        };
                        
                        // æ·»åŠ åˆ°nodeDatabase
                        window.nodeDatabase[nodeId] = nodeData;
                        
                        // æ·»åŠ åˆ°å››ç»„ä»¶æ•°æ®
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData) {
                                window.fourComponentNodeState.nodeData = {};
                            }
                            window.fourComponentNodeState.nodeData[nodeId] = nodeData;
                        }
                        
                        importedCount++;
                        
                    } catch (nodeError) {
                        skippedCount++;
                        console.error(`âŒ [èŠ‚ç‚¹å¤±è´¥] ${nodeInfo.id}:`, nodeError);
                    }
                }
                
                // ä¿å­˜æ•°æ®åˆ°localStorage
                try {
                    localStorage.setItem('nodemind_node_database', JSON.stringify(window.nodeDatabase));
                    
                    if (window.fourComponentNodeState) {
                        if (window.saveFourComponentData) {
                            window.saveFourComponentData();
                        }
                    }
                    
                    // è‡ªåŠ¨ä¿å­˜
                    if (window.autoSaveData) {
                        window.autoSaveData();
                    }
                    
                    
                } catch (saveError) {
                    console.warn('âš ï¸ [æ•°æ®ä¿å­˜] ä¿å­˜å¤±è´¥:', saveError);
                }
                
                
                // åˆ·æ–°ç•Œé¢
                setTimeout(() => {
                    if (window.refreshMindmapDisplay) {
                        window.refreshMindmapDisplay();
                    }
                    
                    // è§¦å‘å››ç»„ä»¶åˆ·æ–°
                    if (window.fourComponentsRefresh) {
                        window.fourComponentsRefresh();
                    }
                }, 500);
                
                return {
                    success: true,
                    nodesCount: importedCount,
                    skippedCount: skippedCount,
                    fileName: fileName,
                    message: `æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªèŠ‚ç‚¹`
                };
                
            } catch (error) {
                console.error(`âŒ [MDå¯¼å…¥] å¤„ç†å¤±è´¥:`, error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // ğŸ”¥ æ—§ç‰ˆMDè§£æå™¨å·²è¢«NodeMindæ ‡å‡†è§£æå™¨v2.0æ›¿æ¢
        // æ­¤å‡½æ•°å°†åœ¨é¡µé¢åŠ è½½åè¢«æ–°è§£æå™¨è¦†ç›–
        function parseImportedMDNodes_NEW(mdContent) {
            console.warn('âš ï¸ æ­£åœ¨ä½¿ç”¨æ—§ç‰ˆè§£æå™¨ï¼Œæ–°ç‰ˆè§£æå™¨å°šæœªåˆå§‹åŒ–');
            return [];
        }
        
        // ğŸ² æ—§ç‰ˆèŠ‚ç‚¹å¤„ç†å‡½æ•° - å·²è¢«æ–°è§£æå™¨æ›¿æ¢
        function generateNodeId(title) {
            console.warn('âš ï¸ ä½¿ç”¨æ—§ç‰ˆgenerateNodeIdï¼Œå»ºè®®å‡çº§åˆ°æ–°è§£æå™¨');
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 6);
            const titleHash = title.slice(0, 10).replace(/[^a-zA-Z0-9]/g, '');
            return `node_${titleHash}_${timestamp}_${random}`;
        }

        function processNodeData(node) {
            console.warn('âš ï¸ ä½¿ç”¨æ—§ç‰ˆprocessNodeDataï¼Œå»ºè®®å‡çº§åˆ°æ–°è§£æå™¨');
            if (!node.id) {
                node.id = generateNodeId(node.title);
            }
            if (!node.tags) {
                node.tags = [];
            }
            if (!node.time) {
                node.time = {
                    created: new Date().toLocaleString(),
                    modified: new Date().toLocaleString()
                };
            }
            if (!node.metadata) {
                node.metadata = {};
            }
            return node;
        }
        
        // ğŸ”¥ ç¬¬ä¸‰æ¬¡é‡æ„ï¼šæš´éœ²MDç›´å†™æœºåˆ¶åˆ°å…¨å±€ï¼ˆæ¨¡å—åŒ–ï¼‰
        // MDç›´å†™é¢æ¿æ§åˆ¶
        window.openMDDirectPanel = openMDDirectPanel;
        window.closeMDDirectPanel = closeMDDirectPanel;
        window.previewMDContent = previewMDContent;
        window.storeMDContent = storeMDContent;
        window.clearMDPanel = clearMDPanel;
        
        // MDæ–‡æ¡£å¯¼å…¥å¯¼å‡ºï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
        window.importMDDocument = importMDDocument;
        window.processImportedMDDocument = processImportedMDDocument;
        window.importMDDocumentFromPanel = importMDDocumentFromPanel;
        window.exportToMDDocument = exportToMDDocument;
        window.downloadMDDocument = downloadMDDocument;
        
        // MDè§£æå™¨æ ¸å¿ƒï¼ˆç¬¦åˆç¬¬ä¸‰æ¬¡é‡æ„è§„èŒƒï¼‰
        window.parseImportedMDNodes_NEW = parseImportedMDNodes_NEW;
        window.parseImportedMDNodes_FIXED = parseImportedMDNodes_NEW; // å…¼å®¹æ€§åˆ«å
        window.processNodeData = processNodeData;
        window.generateNodeId = generateNodeId;
        
        // MDç”Ÿæˆå™¨ - NodeMindè·¯å¾„å¼è§£æå™¨
        window.generateNodeMindStandardDocument = generateNodeMindStandardDocument;
        window.NodePathManager = NodePathManager;
        
        // ğŸ”¥ ä»MDé¢æ¿å¯¼å…¥æ–‡ä»¶
        async function importMDDocumentFromPanel() {
            try {
                
                const result = await importMDDocument();
                
                // åœ¨é¢æ¿ä¸­æ˜¾ç¤ºç»“æœ
                document.getElementById('md-result').innerHTML = `
                    <h4>âœ… å¯¼å…¥æˆåŠŸ</h4>
                    <div class="success-item"><strong>æ–‡ä»¶å</strong>: ${result.fileName}</div>
                    <div class="success-item"><strong>å¯¼å…¥èŠ‚ç‚¹æ•°</strong>: ${result.nodesCount}</div>
                    <div class="success-item"><strong>è·³è¿‡èŠ‚ç‚¹æ•°</strong>: ${result.skippedCount || 0}</div>
                    <div class="success-item"><strong>çŠ¶æ€</strong>: ${result.message}</div>
                    <div class="success-note">
                        ğŸ‰ æ–‡æ¡£å·²æˆåŠŸå¯¼å…¥åˆ°ç¬¬ä¸‰æ¬¡é‡æ„çš„ä¸‡èƒ½æ•°æ®æ¶æ„ï¼
                        <br>ğŸ’¡ åˆ‡æ¢åˆ°å››ç»„ä»¶é¢æ¿æŸ¥çœ‹å¯¼å…¥çš„èŠ‚ç‚¹å†…å®¹
                    </div>
                `;
                
                // è‡ªåŠ¨å…³é—­é¢æ¿å¹¶åˆ‡æ¢åˆ°å››ç»„ä»¶
                setTimeout(() => {
                    closeMDDirectPanel();
                    // åˆ‡æ¢åˆ°èŠ‚ç‚¹ä¿¡æ¯æ ‡ç­¾é¡µ
                    const injectionTab = document.getElementById('detail_tab_injection');
                    if (injectionTab) {
                        injectionTab.click();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('âŒ [MDé¢æ¿] å¯¼å…¥å¤±è´¥:', error);
                
                document.getElementById('md-result').innerHTML = `
                    <h4>âŒ å¯¼å…¥å¤±è´¥</h4>
                    <div class="error-message">${error.message}</div>
                    <div class="error-note">
                        ğŸ’¡ è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿æ˜¯ç¬¦åˆNodeMindæ ‡å‡†çš„MDæ–‡æ¡£
                    </div>
                `;
            }
        }
        
        // ğŸš€ NodeMindæ ‡å‡†è§£æå™¨ï¼šæŒ‰ç…§é¡¹ç›®å…ƒæ•°æ®ç»“æ„é‡æ„
        async function exportToMDDocument() {
            try {
                
                // è·å–å®Œæ•´çš„NodeMindæ•°æ®æ¶æ„
                const nodeDatabase = await getNodeDatabase();
                const sessionDatabase = await getSessionDatabase();
                const mindmapData = await getMindmapDataWithHierarchy();
                const fourComponentData = await getFourComponentData();
                
                const projectInfo = {
                    name: 'å½“å‰NodeMindé¡¹ç›®',
                    description: 'åŸºäºNodeMindçš„æ€ç»´å¯¼å›¾é¡¹ç›®',
                    author: 'NodeMindç”¨æˆ·',
                    version: '1.0.0'
                };
                
                // ä½¿ç”¨æ–°çš„è·¯å¾„å¼è§£æå™¨ç”ŸæˆMDæ–‡æ¡£
                const mdContent = generateNodeMindStandardDocument(
                    nodeDatabase, 
                    sessionDatabase, 
                    mindmapData, 
                    fourComponentData, 
                    projectInfo
                );
                
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `NodeMind_Export_${new Date().toISOString().split('T')[0]}.md`;
                
                // ä¿å­˜MDæ–‡æ¡£
                await downloadMDDocument(mdContent, fileName);
                
                
                return {
                    success: true,
                    fileName: fileName,
                    contentLength: mdContent.length
                };
                
            } catch (error) {
                console.error('âŒ [NodeMindæ ‡å‡†è§£æå™¨] å¯¼å‡ºå¤±è´¥:', error);
                throw error;
            }
        }
        
        // ğŸ†” IDæ ‡å‡†åŒ–ç®¡ç†å™¨ - é¡¹ç›®æ‹¼éŸ³å‰äº”å­—ç¬¦ + è‡ªç„¶é€’å¢ç¼–å·
        class NodeIdManager {
            static projectPrefixCache = new Map();
            static nodeCounters = new Map();
            
            /**
             * ä¸­æ–‡è½¬æ‹¼éŸ³ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
             * @param {string} chinese - ä¸­æ–‡å­—ç¬¦ä¸²
             * @returns {string} æ‹¼éŸ³å­—ç¬¦ä¸²
             */
            static chineseToPinyin(chinese) {
                const pinyinMap = {
                    'é¡¹': 'xiang', 'ç›®': 'mu', 'ç®¡': 'guan', 'ç†': 'li', 'æ€': 'si', 'ç»´': 'wei', 
                    'å¯¼': 'dao', 'å›¾': 'tu', 'ç³»': 'xi', 'ç»Ÿ': 'tong', 'è„‘': 'nao', 'å›¾': 'tu',
                    'ä¼š': 'hui', 'è¯': 'hua', 'ç¬”': 'bi', 'è®°': 'ji', 'ä»»': 'ren', 'åŠ¡': 'wu',
                    'è®¡': 'ji', 'åˆ’': 'hua', 'æ–¹': 'fang', 'æ¡ˆ': 'an', 'è®¾': 'she', 'è®¡': 'ji',
                    'å¼€': 'kai', 'å‘': 'fa', 'æµ‹': 'ce', 'è¯•': 'shi', 'éƒ¨': 'bu', 'ç½²': 'shu',
                    'å­¦': 'xue', 'ä¹ ': 'xi', 'ç ”': 'yan', 'ç©¶': 'jiu', 'æ–‡': 'wen', 'æ¡£': 'dang',
                    'çŸ¥': 'zhi', 'è¯†': 'shi', 'åº“': 'ku', 'æ•°': 'shu', 'æ®': 'ju', 'åˆ†': 'fen',
                    'æ': 'xi', 'æŠ¥': 'bao', 'å‘Š': 'gao', 'æµ': 'liu', 'ç¨‹': 'cheng', 'ä¸š': 'ye',
                    'æ ‡': 'biao', 'ç­¾': 'qian', 'èŠ‚': 'jie', 'ç‚¹': 'dian', 'å†…': 'nei', 'å®¹': 'rong'
                };
                
                let pinyin = '';
                for (let char of chinese) {
                    if (pinyinMap[char]) {
                        pinyin += pinyinMap[char];
                    } else if (/[a-zA-Z0-9]/.test(char)) {
                        pinyin += char.toLowerCase();
                    }
                }
                return pinyin;
            }
            
            /**
             * è·å–é¡¹ç›®å‰ç¼€ï¼ˆæ‹¼éŸ³å‰5å­—ç¬¦ï¼‰
             * @param {string} projectName - é¡¹ç›®åç§°
             * @returns {string} æ ‡å‡†åŒ–å‰ç¼€
             */
            static getProjectPrefix(projectName) {
                if (this.projectPrefixCache.has(projectName)) {
                    return this.projectPrefixCache.get(projectName);
                }
                
                // æå–ä¸­æ–‡å’Œè‹±æ–‡æ··åˆåç§°çš„æ‹¼éŸ³
                const pinyin = this.chineseToPinyin(projectName);
                const prefix = pinyin.substring(0, 5).padEnd(5, 'x'); // ä¸è¶³5ä½ç”¨xè¡¥é½
                
                this.projectPrefixCache.set(projectName, prefix);
                
                return prefix;
            }
            
            /**
             * ç”Ÿæˆæ ‡å‡†åŒ–èŠ‚ç‚¹ID
             * @param {string} projectName - é¡¹ç›®åç§°
             * @returns {string} æ ‡å‡†åŒ–IDï¼ˆå¦‚ï¼šnodem1, nodem2, nodem123ï¼‰
             */
            static generateNodeId(projectName = 'NodeMindé¡¹ç›®') {
                const prefix = this.getProjectPrefix(projectName);
                
                // è·å–æˆ–åˆå§‹åŒ–è®¡æ•°å™¨
                if (!this.nodeCounters.has(prefix)) {
                    this.nodeCounters.set(prefix, 0);
                }
                
                // é€’å¢è®¡æ•°å™¨
                let counter = this.nodeCounters.get(prefix) + 1;
                this.nodeCounters.set(prefix, counter);
                
                // ç”ŸæˆIDï¼šå‰ç¼€ + è‡ªç„¶é€’å¢ç¼–å·ï¼ˆä¸é™ä½æ•°ï¼‰
                const nodeId = `${prefix}${counter}`;
                
                return nodeId;
            }
            
            /**
             * éªŒè¯IDæ ¼å¼æ˜¯å¦ç¬¦åˆæ ‡å‡†
             * @param {string} nodeId - èŠ‚ç‚¹ID
             * @returns {boolean} æ˜¯å¦ç¬¦åˆæ ‡å‡†
             */
            static isStandardId(nodeId) {
                // æ ‡å‡†æ ¼å¼ï¼š5å­—ç¬¦å‰ç¼€ + ä¸é™ä½æ•°çš„æ•°å­—
                const standardPattern = /^[a-z]{5}\d+$/;
                return standardPattern.test(nodeId);
            }
            
            /**
             * ä»æ ‡å‡†IDæå–é¡¹ç›®å‰ç¼€
             * @param {string} nodeId - æ ‡å‡†èŠ‚ç‚¹ID
             * @returns {string} é¡¹ç›®å‰ç¼€
             */
            static extractProjectPrefix(nodeId) {
                if (this.isStandardId(nodeId)) {
                    return nodeId.substring(0, 5);
                }
                return null;
            }
            
            /**
             * ä»æ ‡å‡†IDæå–ç¼–å·
             * @param {string} nodeId - æ ‡å‡†èŠ‚ç‚¹ID  
             * @returns {number} èŠ‚ç‚¹ç¼–å·
             */
            static extractNodeNumber(nodeId) {
                if (this.isStandardId(nodeId)) {
                    return parseInt(nodeId.substring(5), 10);
                }
                return null;
            }
            
            /**
             * é‡ç½®è®¡æ•°å™¨ï¼ˆç”¨äºæµ‹è¯•æˆ–é‡æ–°å¼€å§‹ï¼‰
             * @param {string} projectName - é¡¹ç›®åç§°
             */
            static resetCounter(projectName) {
                const prefix = this.getProjectPrefix(projectName);
                this.nodeCounters.set(prefix, 0);
            }
            
            /**
             * è·å–é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
             * @param {string} projectName - é¡¹ç›®åç§°
             * @returns {object} ç»Ÿè®¡ä¿¡æ¯
             */
            static getProjectStats(projectName) {
                const prefix = this.getProjectPrefix(projectName);
                const count = this.nodeCounters.get(prefix) || 0;
                
                return {
                    projectName,
                    prefix,
                    nodeCount: count,
                    nextId: `${prefix}${count + 1}`
                };
            }
        }

        // ğŸ¯ NodePathManager - è·¯å¾„å¼èŠ‚ç‚¹å…³ç³»ç®¡ç†å™¨
        class NodePathManager {
            /**
             * ä»è·¯å¾„è·å–èŠ‚ç‚¹å±‚çº§
             */
            static getLevel(path) {
                return path.split('/').length - 1; // å‡å»è„‘å›¾IDéƒ¨åˆ†
            }
            
            /**
             * ä»è·¯å¾„è·å–çˆ¶èŠ‚ç‚¹ID
             */
            static getParentId(path) {
                const parts = path.split('/');
                return parts.length > 2 ? parts[parts.length - 2] : null;
            }
            
            /**
             * ä»è·¯å¾„è·å–è„‘å›¾ID
             */
            static getMapId(path) {
                return path.split('/')[0];
            }
            
            /**
             * ä»è·¯å¾„è·å–èŠ‚ç‚¹ID
             */
            static getNodeId(path) {
                const parts = path.split('/');
                return parts[parts.length - 1];
            }
            
            /**
             * æ„å»ºå­èŠ‚ç‚¹è·¯å¾„
             */
            static buildChildPath(parentPath, childId) {
                return `${parentPath}/${childId}`;
            }
            
            /**
             * è·å–è·¯å¾„çš„æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ID
             */
            static getAncestors(path) {
                const parts = path.split('/');
                return parts.slice(1, -1); // å»æ‰è„‘å›¾IDå’Œå½“å‰èŠ‚ç‚¹ID
            }
            
            /**
             * æ£€æŸ¥æ˜¯å¦ä¸ºæ ¹èŠ‚ç‚¹
             */
            static isRoot(path) {
                return path.split('/').length === 2;
            }
            
            /**
             * è·å–å­èŠ‚ç‚¹è·¯å¾„åˆ—è¡¨
             */
            static getChildren(parentPath, allPaths) {
                return allPaths.filter(path => 
                    path.startsWith(parentPath + '/') && 
                    path.split('/').length === parentPath.split('/').length + 1
                );
            }
        }

        // ğŸ¯ æ•°æ®è·å–å‡½æ•° - æŒ‰ç…§NodeMindæ ‡å‡†æ¶æ„
        async function getNodeDatabase() {
            try {
                // ä»localStorageè·å–nodeDatabase
                const storedNodeDB = localStorage.getItem('nodemind_node_database');
                let nodeDatabase = storedNodeDB ? JSON.parse(storedNodeDB) : {};
                
                // åŒæ­¥è„‘å›¾æ•°æ®åˆ°nodeDatabaseï¼Œç¡®ä¿è·¯å¾„ä¿¡æ¯å®Œæ•´
                const mindmapData = await getMindmapDataWithHierarchy();
                nodeDatabase = await syncMindmapDataWithNodeDatabase(mindmapData, nodeDatabase);
                
                return nodeDatabase;
            } catch (error) {
                console.error('è·å–nodeDatabaseå¤±è´¥:', error);
                return {};
            }
        }

        async function getSessionDatabase() {
            try {
                const storedSessionDB = localStorage.getItem('nodemind_session_database');
                return storedSessionDB ? JSON.parse(storedSessionDB) : {};
            } catch (error) {
                console.error('è·å–sessionDatabaseå¤±è´¥:', error);
                return {};
            }
        }

        async function getMindmapDataWithHierarchy() {
            try {
                const storedMindmapData = localStorage.getItem('nodemind_mindmap_data');
                return storedMindmapData ? JSON.parse(storedMindmapData) : {};
            } catch (error) {
                console.error('è·å–mindmapDataå¤±è´¥:', error);
                return {};
            }
        }

        async function getFourComponentData() {
            try {
                const storedFourComponentData = localStorage.getItem('nodemind_four_component_data');
                return storedFourComponentData ? JSON.parse(storedFourComponentData) : {};
            } catch (error) {
                console.error('è·å–fourComponentDataå¤±è´¥:', error);
                return {};
            }
        }

        // ğŸ”„ å¢å¼ºçš„æ•°æ®åŒæ­¥å‡½æ•°ï¼šç¡®ä¿è·¯å¾„ä¿¡æ¯å®Œæ•´ä¸”æ­£ç¡®
        async function syncMindmapDataWithNodeDatabaseEnhanced(mindmapData, nodeDatabase) {
            
            let syncCount = 0;
            let newCount = 0;
            let pathUpdateCount = 0;
            let relationUpdateCount = 0;
            
            // éå†æ‰€æœ‰æ€ç»´å¯¼å›¾
            Object.keys(mindmapData).forEach(mapId => {
                const mapData = mindmapData[mapId];
                if (mapData && mapData.data) {
                    // é€’å½’éå†èŠ‚ç‚¹ï¼Œç”Ÿæˆå®Œæ•´çš„è·¯å¾„ä¿¡æ¯
                    traverseAndSyncNode(mapData.data, mapId, `${mapId}/${mapData.data.id}`, null);
                }
            });
            
            function traverseAndSyncNode(nodeData, mapId, nodePath, parentId) {
                const nodeId = nodeData.id;
                const cleanTitle = nodeData.topic ? nodeData.topic.replace(' ğŸ“„', '') : 'æœªå‘½åèŠ‚ç‚¹';
                
                // ç¡®ä¿nodeDatabaseä¸­å­˜åœ¨å¯¹åº”è®°å½•
                if (!nodeDatabase[nodeId]) {
                    // åˆ›å»ºæ–°çš„èŠ‚ç‚¹è®°å½•
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: cleanTitle,
                        topic: cleanTitle,
                        content: '',
                        sessions: [],
                        author: 'NodeMind',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        tags: { categories: [], technical: [], status: [] }
                    };
                    newCount++;
                } else {
                    // æ›´æ–°ç°æœ‰èŠ‚ç‚¹çš„æ ‡é¢˜
                    if (nodeDatabase[nodeId].title !== cleanTitle) {
                        nodeDatabase[nodeId].title = cleanTitle;
                        nodeDatabase[nodeId].topic = cleanTitle;
                        nodeDatabase[nodeId].modified = new Date().toISOString();
                    }
                    syncCount++;
                }
                
                // ğŸ”‘ å…³é”®ï¼šæ›´æ–°è·¯å¾„ä¿¡æ¯ï¼ˆå¿…é¡»æœ‰ï¼‰
                const oldPath = nodeDatabase[nodeId].path;
                nodeDatabase[nodeId].path = nodePath;
                nodeDatabase[nodeId].mapId = mapId;
                nodeDatabase[nodeId].level = NodePathManager.getLevel(nodePath);
                
                if (oldPath !== nodePath) {
                    pathUpdateCount++;
                }
                
                // ğŸ”‘ å…³é”®ï¼šæ›´æ–°å…³ç³»ä¿¡æ¯ï¼ˆå¿…é¡»æœ‰ï¼‰
                const childrenIds = nodeData.children ? 
                    nodeData.children.map(child => child.id) : 
                    [];
                
                const oldRelations = nodeDatabase[nodeId].relations;
                nodeDatabase[nodeId].relations = {
                    parent: parentId,
                    children: childrenIds
                };
                
                if (!oldRelations || oldRelations.parent !== parentId || 
                    JSON.stringify(oldRelations.children) !== JSON.stringify(childrenIds)) {
                    relationUpdateCount++;
                }
                
                // æ›´æ–°å…¶ä»–å…ƒæ•°æ®
                if (nodeData.direction) {
                    nodeDatabase[nodeId].direction = nodeData.direction;
                }
                if (nodeData.expanded !== undefined) {
                    nodeDatabase[nodeId].expanded = nodeData.expanded;
                }
                
                // é€’å½’å¤„ç†å­èŠ‚ç‚¹
                if (nodeData.children) {
                    nodeData.children.forEach(child => {
                        const childPath = NodePathManager.buildChildPath(nodePath, child.id);
                        traverseAndSyncNode(child, mapId, childPath, nodeId);
                    });
                }
            }
            
            
            // ä¿å­˜åŒæ­¥åçš„æ•°æ®åˆ°localStorage
            try {
                localStorage.setItem('nodemind_node_database', JSON.stringify(nodeDatabase));
            } catch (error) {
                console.error('âŒ [æ•°æ®æŒä¹…åŒ–] ä¿å­˜å¤±è´¥:', error);
            }
            
            return nodeDatabase;
        }

        // ğŸ¯ æ•°æ®èåˆå‡½æ•°ï¼šç¡®ä¿jsMindä¸nodeDatabaseåŒæ­¥å¹¶ç”Ÿæˆè·¯å¾„ä¿¡æ¯ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
        async function syncMindmapDataWithNodeDatabase(mindmapData, nodeDatabase) {
            
            // éå†æ‰€æœ‰æ€ç»´å¯¼å›¾
            Object.keys(mindmapData).forEach(mapId => {
                const mapData = mindmapData[mapId];
                if (mapData && mapData.data) {
                    // é€’å½’éå†èŠ‚ç‚¹ï¼Œç”Ÿæˆè·¯å¾„ä¿¡æ¯
                    traverseAndSyncNode(mapData.data, mapId, `${mapId}/${mapData.data.id}`);
                }
            });
            
            function traverseAndSyncNode(nodeData, mapId, nodePath) {
                const nodeId = nodeData.id;
                
                // ç¡®ä¿nodeDatabaseä¸­å­˜åœ¨å¯¹åº”è®°å½•
                if (!nodeDatabase[nodeId]) {
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: nodeData.topic || 'æœªå‘½åèŠ‚ç‚¹',
                        topic: nodeData.topic || 'æœªå‘½åèŠ‚ç‚¹',
                        content: '',
                        sessions: [],
                        author: 'NodeMind',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        tags: { categories: [], technical: [], status: [] }
                    };
                }
                
                // æ›´æ–°è·¯å¾„ä¿¡æ¯
                nodeDatabase[nodeId].path = nodePath;
                nodeDatabase[nodeId].mapId = mapId;
                nodeDatabase[nodeId].level = NodePathManager.getLevel(nodePath);
                
                // æ›´æ–°å…³ç³»ä¿¡æ¯
                const parentId = NodePathManager.getParentId(nodePath);
                const childrenPaths = nodeData.children ? 
                    nodeData.children.map(child => NodePathManager.buildChildPath(nodePath, child.id)) : 
                    [];
                const childrenIds = nodeData.children ? 
                    nodeData.children.map(child => child.id) : 
                    [];
                
                nodeDatabase[nodeId].relations = {
                    parent: parentId,
                    children: childrenIds
                };
                
                // æ›´æ–°å…¶ä»–å…ƒæ•°æ®
                if (nodeData.direction) {
                    nodeDatabase[nodeId].direction = nodeData.direction;
                }
                
                // é€’å½’å¤„ç†å­èŠ‚ç‚¹
                if (nodeData.children) {
                    nodeData.children.forEach(child => {
                        const childPath = NodePathManager.buildChildPath(nodePath, child.id);
                        traverseAndSyncNode(child, mapId, childPath);
                    });
                }
            }
            
            return nodeDatabase;
        }

        // ğŸš€ NodeMindæ ‡å‡†MDæ–‡æ¡£ç”Ÿæˆå™¨ - æŒ‰ç…§é¡¹ç›®å…ƒæ•°æ®ç»“æ„é‡æ„ï¼ˆé›†æˆIDæ ‡å‡†åŒ–ï¼‰
        function generateNodeMindStandardDocument(nodeDatabase, sessionDatabase, mindmapData, fourComponentData, projectInfo) {
            const lines = [];
            const currentTime = new Date().toLocaleString();
            const isoTime = new Date().toISOString();
            const projectName = projectInfo.name || 'NodeMindé¡¹ç›®';
            
            // ğŸ“„ æ–‡æ¡£å¤´éƒ¨ï¼ˆNodeMindè·¯å¾„å¼æ ‡å‡†æ ¼å¼ï¼‰
            lines.push(`# ${projectName}`);
            lines.push('');
            lines.push(`> ğŸ“ **NodeMindè·¯å¾„å¼æ ‡å‡†MDæ–‡æ¡£** - æ”¯æŒå®Œæ•´è„‘å›¾æ¢å¤ï¼ŒåŒ…å«è·¯å¾„å…³ç³»å’Œä¼šè¯æ•°æ®`);
            lines.push(`> ğŸ†” **IDæ ‡å‡†åŒ–è§„åˆ™**: ${NodeIdManager.getProjectPrefix(projectName)}x (é¡¹ç›®æ‹¼éŸ³å‰ç¼€ + è‡ªç„¶é€’å¢ç¼–å·)`);
            lines.push('');
            
            // ğŸ“‹ é¡¹ç›®å…ƒä¿¡æ¯
            lines.push(`## ğŸ“‹ é¡¹ç›®ä¿¡æ¯`);
            lines.push('');
            lines.push(`| å±æ€§ | å€¼ |`);
            lines.push(`|------|-----|`);
            lines.push(`| é¡¹ç›®åç§° | ${projectName} |`);
            lines.push(`| é¡¹ç›®æè¿° | ${projectInfo.description || 'åŸºäºNodeMindçš„æ€ç»´å¯¼å›¾é¡¹ç›®'} |`);
            lines.push(`| ä½œè€… | ${projectInfo.author || 'NodeMindç”¨æˆ·'} |`);
            lines.push(`| ç‰ˆæœ¬ | ${projectInfo.version || '1.0.0'} |`);
            lines.push(`| IDå‰ç¼€ | ${NodeIdManager.getProjectPrefix(projectName)} |`);
            lines.push(`| IDæ ¼å¼ | ${NodeIdManager.getProjectPrefix(projectName)}1, ${NodeIdManager.getProjectPrefix(projectName)}2, ... |`);
            lines.push(`| æ•°æ®æ ¼å¼ | NodeMindè·¯å¾„å¼æ¶æ„ v2.0 + IDæ ‡å‡†åŒ– |`);
            lines.push(`| è§£æå™¨ç‰ˆæœ¬ | è·¯å¾„å¼èŠ‚ç‚¹å…³ç³»ç®¡ç†å™¨ + IDæ ‡å‡†åŒ–ç®¡ç†å™¨ |`);
            lines.push(`| å¯¼å‡ºæ—¶é—´ | ${currentTime} |`);
            lines.push(`| ISOæ—¶é—´æˆ³ | ${isoTime} |`);
            lines.push('');
            
            // ğŸ“Š å®Œæ•´ç»Ÿè®¡ä¿¡æ¯
            const totalNodes = Object.keys(nodeDatabase).length;
            const fourComponentNodes = Object.keys(fourComponentData || {}).length;
            const sessionNodes = Object.keys(sessionDatabase || {}).length;
            const totalSessions = Object.values(sessionDatabase || {}).reduce((sum, nodeSession) => 
                sum + (nodeSession.sessions ? nodeSession.sessions.length : 0), 0);
            
            // è„‘å›¾ç»Ÿè®¡
            const mindmapStats = {};
            Object.keys(mindmapData || {}).forEach(mapId => {
                const mapData = mindmapData[mapId];
                if (mapData && mapData.data) {
                    mindmapStats[mapId] = countNodesInMap(mapData.data);
                }
            });
            
            lines.push(`## ğŸ“Š æ•°æ®ç»Ÿè®¡`);
            lines.push('');
            lines.push(`### ğŸ”¢ èŠ‚ç‚¹ç»Ÿè®¡`);
            lines.push('');
            lines.push(`| ç»Ÿè®¡é¡¹ | æ•°é‡ |`);
            lines.push(`|--------|------|`);
            lines.push(`| æ€»èŠ‚ç‚¹æ•° | ${totalNodes} |`);
            lines.push(`| å››ç»„ä»¶èŠ‚ç‚¹ | ${fourComponentNodes} |`);
            lines.push(`| æœ‰ä¼šè¯èŠ‚ç‚¹ | ${sessionNodes} |`);
            lines.push(`| æ€»ä¼šè¯æ•° | ${totalSessions} |`);
            lines.push('');
            
            lines.push(`### ğŸ—ºï¸ è„‘å›¾ç»Ÿè®¡`);
            lines.push('');
            lines.push(`| è„‘å›¾ID | èŠ‚ç‚¹æ•°é‡ | è„‘å›¾åç§° |`);
            lines.push(`|--------|----------|----------|`);
            Object.keys(mindmapStats).forEach(mapId => {
                const mapData = mindmapData[mapId];
                const mapName = mapData?.meta?.name || 'æœªå‘½åè„‘å›¾';
                lines.push(`| ${mapId} | ${mindmapStats[mapId]} | ${mapName} |`);
            });
            lines.push('');
            lines.push('---');
            lines.push('');
            
            // ğŸ—‚ï¸ èŠ‚ç‚¹æ•°æ®ï¼ˆæŒ‰è·¯å¾„å±‚æ¬¡æ’åºï¼‰
            lines.push(`## ğŸ—‚ï¸ èŠ‚ç‚¹æ•°æ®`);
            lines.push('');
            lines.push(`> é‡‡ç”¨è·¯å¾„å¼èŠ‚ç‚¹å…³ç³»è¡¨è¾¾ï¼Œæ”¯æŒå®Œæ•´è„‘å›¾ç»“æ„æ¢å¤`);
            lines.push('');
            
            // æŒ‰è·¯å¾„æ’åºï¼Œä¿æŒå±‚æ¬¡ç»“æ„
            const sortedNodes = Object.entries(nodeDatabase).sort(([aId, aData], [bId, bData]) => {
                const pathA = aData.path || `unknown/${aId}`;
                const pathB = bData.path || `unknown/${bId}`;
                return pathA.localeCompare(pathB);
            });
            
            // æŒ‰è„‘å›¾åˆ†ç»„
            const nodesByMap = {};
            sortedNodes.forEach(([nodeId, nodeData]) => {
                const mapId = nodeData.mapId || 'unknown';
                if (!nodesByMap[mapId]) {
                    nodesByMap[mapId] = [];
                }
                nodesByMap[mapId].push([nodeId, nodeData]);
            });
            
            // ç”Ÿæˆæ¯ä¸ªè„‘å›¾çš„èŠ‚ç‚¹æ•°æ®
            Object.keys(nodesByMap).forEach(mapId => {
                const mapData = mindmapData[mapId];
                const mapName = mapData?.meta?.name || 'æœªå‘½åè„‘å›¾';
                
                lines.push(`### ğŸ—ºï¸ è„‘å›¾: ${mapName} (${mapId})`);
                lines.push('');
                
                nodesByMap[mapId].forEach(([nodeId, nodeData]) => {
                    // èŠ‚ç‚¹æ ‡é¢˜ï¼ˆå±‚æ¬¡åŒ–æ˜¾ç¤ºï¼‰
                    const level = Math.max(4, Math.min(nodeData.level + 3, 6)); // ä»####å¼€å§‹ï¼Œæœ€å¤š######
                    const headerPrefix = '#'.repeat(level);
                    const nodeTitle = (nodeData.title || nodeData.topic || 'æœªå‘½åèŠ‚ç‚¹').replace(/[#\n\r]/g, '');
                    
                    lines.push(`${headerPrefix} ${nodeTitle}`);
                    lines.push('');
                    
                    // èŠ‚ç‚¹å…ƒæ•°æ®ï¼ˆè·¯å¾„å¼ï¼‰
                    lines.push(`**èŠ‚ç‚¹å…ƒæ•°æ®**:`);
                    lines.push('');
                    // ğŸ”’ å›ºå®šå¿…é¡»æœ‰çš„æ ¸å¿ƒä¿¡æ¯è¡¨æ ¼ï¼ˆIDã€æ ‡é¢˜+å†…å®¹ã€èŠ‚ç‚¹å…³ç³»è·¯å¾„ã€æ—¶é—´æˆ³ï¼‰
                    lines.push('**æ ¸å¿ƒä¿¡æ¯**:');
                    lines.push('');
                    lines.push(`| å±æ€§ | å€¼ |`);
                    lines.push(`|------|-----|`);
                    lines.push(`| èŠ‚ç‚¹ID | \`${nodeId}\` |`);
                    
                    // IDæ ‡å‡†åŒ–æ£€æŸ¥
                    const isStandardId = NodeIdManager.isStandardId(nodeId);
                    if (isStandardId) {
                        const idPrefix = NodeIdManager.extractProjectPrefix(nodeId);
                        const idNumber = NodeIdManager.extractNodeNumber(nodeId);
                        lines.push(`| IDæ ¼å¼ | âœ… æ ‡å‡† (${idPrefix}-${idNumber}) |`);
                    } else {
                        lines.push(`| IDæ ¼å¼ | âš ï¸ éæ ‡å‡†æ ¼å¼ |`);
                    }
                    
                    // ğŸ”’ èŠ‚ç‚¹å…³ç³»è·¯å¾„ï¼ˆå›ºå®šå¿…é¡»æœ‰ï¼Œå§‹ç»ˆæ˜¾ç¤ºï¼‰
                    const parentId = nodeData.relations?.parent || null;
                    const childrenIds = nodeData.relations?.children || [];
                    
                    // çˆ¶å­å…³ç³»ä¿¡æ¯
                    if (parentId) {
                        lines.push(`| çˆ¶èŠ‚ç‚¹ | \`${parentId}\` |`);
                    } else {
                        lines.push(`| çˆ¶èŠ‚ç‚¹ | æ— ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰ |`);
                    }
                    
                    if (childrenIds.length > 0) {
                        lines.push(`| å­èŠ‚ç‚¹ | ${childrenIds.map(id => `\`${id}\``).join(', ')} |`);
                        lines.push(`| å­èŠ‚ç‚¹æ•° | ${childrenIds.length} |`);
                    } else {
                        lines.push(`| å­èŠ‚ç‚¹ | æ—  |`);
                        lines.push(`| å­èŠ‚ç‚¹æ•° | 0 |`);
                    }
                    
                    // è·¯å¾„å…³ç³»ä¿¡æ¯
                    lines.push(`| èŠ‚ç‚¹è·¯å¾„ | \`${nodeData.path || 'æœªå®šä¹‰è·¯å¾„'}\` |`);
                    lines.push(`| èŠ‚ç‚¹å±‚çº§ | ${nodeData.level || 'æœªå®šä¹‰'} |`);
                    lines.push(`| æ‰€å±è„‘å›¾ | ${nodeData.mapId || 'æœªå®šä¹‰'} |`);
                    lines.push(`| æ–¹å‘ | ${nodeData.direction || 'æœªå®šä¹‰'} |`);
                    
                    // ğŸ”’ æ—¶é—´æˆ³ï¼ˆå›ºå®šå¿…é¡»æœ‰ï¼Œå§‹ç»ˆæ˜¾ç¤ºï¼‰
                    lines.push(`| åˆ›å»ºæ—¶é—´ | ${nodeData.created || 'æœªå®šä¹‰'} |`);
                    lines.push(`| ä¿®æ”¹æ—¶é—´ | ${nodeData.modified || 'æœªå®šä¹‰'} |`);
                    
                    lines.push('');
                    
                    // ğŸ“ å¯é€‰éƒ¨åˆ†ï¼ˆæœ‰å€¼æ‰æ˜¾ç¤ºï¼‰
                    
                    // æ ‡ç­¾ç³»ç»Ÿï¼ˆå¦‚æœæœ‰ï¼‰
                    if (nodeData.tags) {
                        const allTags = [
                            ...(nodeData.tags.categories || []).map(tag => `#${tag}(åˆ†ç±»)`),
                            ...(nodeData.tags.technical || []).map(tag => `#${tag}(æŠ€æœ¯)`),
                            ...(nodeData.tags.status || []).map(tag => `#${tag}(çŠ¶æ€)`),
                            ...(nodeData.tags.custom || []).map(tag => `#${tag}(è‡ªå®šä¹‰)`)
                        ];
                        
                        if (allTags.length > 0) {
                            lines.push('**æ ‡ç­¾åˆ†ç±»**:');
                            lines.push('');
                            lines.push(allTags.join(' '));
                            lines.push('');
                        }
                    }
                    
                    // å±•å¼€çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (nodeData.expanded !== undefined) {
                        lines.push('**å±•å¼€çŠ¶æ€**:');
                        lines.push('');
                        lines.push(`- å­èŠ‚ç‚¹å±•å¼€: ${nodeData.expanded ? 'âœ… å·²å±•å¼€' : 'âŒ å·²æŠ˜å '}`);
                        lines.push('');
                    }
                    
                    // ä½œè€…ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ä¸”éé»˜è®¤ï¼‰
                    if (nodeData.author && nodeData.author !== 'NodeMind') {
                        lines.push('**ä½œè€…ä¿¡æ¯**:');
                        lines.push('');
                        lines.push(`- ä½œè€…: ${nodeData.author}`);
                        lines.push('');
                    }
                    
                    // ğŸ”’ èŠ‚ç‚¹å†…å®¹ï¼ˆå›ºå®šå¿…é¡»æœ‰ï¼‰
                    lines.push('**èŠ‚ç‚¹å†…å®¹**:');
                    lines.push('');
                    if (nodeData.content && nodeData.content.trim()) {
                        lines.push('```text');
                        lines.push(nodeData.content.trim());
                        lines.push('```');
                    } else {
                        lines.push('*æš‚æ— å†…å®¹*');
                    }
                    lines.push('');
                    
                    // ä¼šè¯æ•°æ®ï¼ˆé‡è¦æ–°å¢ï¼‰
                    const nodeSessions = sessionDatabase[nodeId];
                    if (nodeSessions && nodeSessions.sessions && nodeSessions.sessions.length > 0) {
                        lines.push('**ä¼šè¯è®°å½•**:');
                        lines.push('');
                        lines.push(`| ä¼šè¯ID | æ ‡é¢˜ | ç±»å‹ | åˆ›å»ºæ—¶é—´ |`);
                        lines.push(`|--------|------|------|----------|`);
                        
                        nodeSessions.sessions.forEach(session => {
                            lines.push(`| \`${session.id}\` | ${session.title || 'æ— æ ‡é¢˜'} | ${session.type || 'note'} | ${session.timestamp || 'æœªçŸ¥'} |`);
                        });
                        lines.push('');
                        
                        // è¯¦ç»†ä¼šè¯å†…å®¹
                        nodeSessions.sessions.forEach((session, index) => {
                            lines.push(`**ä¼šè¯ ${index + 1}: ${session.title || 'æ— æ ‡é¢˜'}**`);
                            lines.push('');
                            if (session.content && session.content.trim()) {
                                lines.push('```text');
                                lines.push(session.content.trim());
                                lines.push('```');
                            } else {
                                lines.push('*æš‚æ— ä¼šè¯å†…å®¹*');
                            }
                            lines.push('');
                        });
                    } else {
                        lines.push('**ä¼šè¯è®°å½•**: *æš‚æ— ä¼šè¯*');
                        lines.push('');
                    }
                    
                    // åˆ†éš”çº¿
                    lines.push('---');
                    lines.push('');
                });
            });
            
            // ğŸ“‹ å¯¼å…¥æŒ‡å—ï¼ˆæ›´æ–°ç‰ˆï¼‰
            lines.push('## ğŸ’¡ å¯¼å…¥æŒ‡å—');
            lines.push('');
            lines.push('### ğŸ”„ å¦‚ä½•å¯¼å…¥æ­¤æ–‡æ¡£');
            lines.push('');
            lines.push('1. **æ‰“å¼€NodeMindåº”ç”¨**');
            lines.push('2. **ç‚¹å‡»"å¯¼å…¥MDæ–‡æ¡£"æŒ‰é’®**');
            lines.push('3. **é€‰æ‹©æ­¤MDæ–‡ä»¶**');
            lines.push('4. **ç³»ç»Ÿå°†è‡ªåŠ¨è§£æè·¯å¾„å…³ç³»å¹¶æ¢å¤æ‰€æœ‰æ•°æ®**');
            lines.push('');
            lines.push('### âœ… æ”¯æŒçš„æ•°æ®æ¢å¤');
            lines.push('');
            lines.push('- âœ… **è·¯å¾„å¼èŠ‚ç‚¹å…³ç³»**: å®Œæ•´ä¿æŒçˆ¶å­å…³ç³»å’Œå±‚æ¬¡ç»“æ„');
            lines.push('- âœ… **å¤šè„‘å›¾æ•°æ®**: æ”¯æŒå¤šä¸ªæ€ç»´å¯¼å›¾çš„å®Œæ•´æ¢å¤');
            lines.push('- âœ… **ä¼šè¯ç³»ç»Ÿ**: èŠ‚ç‚¹å…³è”çš„æ‰€æœ‰ä¼šè¯è®°å½•');
            lines.push('- âœ… **å››ç»„ä»¶æ•°æ®**: èŠ‚ç‚¹è¯¦æƒ…é¢æ¿çš„å®Œæ•´çŠ¶æ€');
            lines.push('- âœ… **æ ‡ç­¾ç³»ç»Ÿ**: åˆ†ç±»ã€æŠ€æœ¯ã€çŠ¶æ€æ ‡ç­¾çš„å®Œæ•´åˆ†ç±»');
            lines.push('- âœ… **å…ƒæ•°æ®**: åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ã€ä½œè€…ä¿¡æ¯');
            lines.push('');
            lines.push('### ğŸ› ï¸ æ ¼å¼è§„èŒƒ');
            lines.push('');
            lines.push('- **æ–‡æ¡£æ ¼å¼**: NodeMindè·¯å¾„å¼æ ‡å‡† v2.0');
            lines.push('- **è·¯å¾„æ ¼å¼**: `mapId/nodeId/nodeId/...`');
            lines.push('- **ç¼–ç æ ¼å¼**: UTF-8');
            lines.push('- **æ¢è¡Œç¬¦**: æ ‡å‡†LFæ ¼å¼');
            lines.push('- **è§£æå™¨**: NodePathManagerè·¯å¾„å¼å…³ç³»ç®¡ç†å™¨');
            lines.push('');
            lines.push(`---`);
            lines.push('');
            lines.push(`**æ–‡æ¡£ç”Ÿæˆä¿¡æ¯**:`);
            lines.push(`- ç”Ÿæˆæ—¶é—´: ${currentTime}`);
            lines.push(`- æ ¼å¼ç‰ˆæœ¬: NodeMindè·¯å¾„å¼æ ‡å‡† v2.0`);
            lines.push(`- æºæ•°æ®: nodeDatabase (${totalNodes} ä¸ªèŠ‚ç‚¹), sessionDatabase (${totalSessions} ä¸ªä¼šè¯)`);
            lines.push(`- å¯¼å‡ºå·¥å…·: NodeMindè·¯å¾„å¼è§£æå™¨`);
            lines.push(`- æ¶æ„: å¤šå±‚æ•°æ®æ¶æ„ + è·¯å¾„å¼å…³ç³»ç®¡ç†`);
            
            return lines.join('\n');
        }

        // ğŸ“Š è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—è„‘å›¾ä¸­çš„èŠ‚ç‚¹æ•°é‡
        function countNodesInMap(nodeData) {
            if (!nodeData) return 0;
            
            let count = 1; // å½“å‰èŠ‚ç‚¹
            if (nodeData.children) {
                nodeData.children.forEach(child => {
                    count += countNodesInMap(child);
                });
            }
            return count;
        }
        
        // ğŸ¯ ä¿å­˜æ ¼å¼é€‰æ‹©å¯¹è¯æ¡† - ä¸è§£æå™¨ä¸€è‡´çš„ç‰ˆæœ¬
        function showSaveFormatDialog() {
            const dialog = confirm(
                'è¯·é€‰æ‹©ä¿å­˜æ ¼å¼ï¼š\n\n' +
                'ğŸ“Š ç‚¹å‡»"ç¡®å®š"ï¼šä¿å­˜ä¸ºJSONæ ¼å¼ï¼ˆåŒ…å«å®Œæ•´è„‘å›¾æ•°æ®ï¼‰\n' +
                'ğŸ“ ç‚¹å‡»"å–æ¶ˆ"ï¼šä¿å­˜ä¸ºMDæ ¼å¼ï¼ˆNodeMindè·¯å¾„å¼æ ‡å‡†ï¼Œå®Œç¾å¤ç°ï¼‰\n\n' +
                'ğŸ’¡ å»ºè®®ï¼š\n' +
                '- JSONæ ¼å¼ï¼šé€‚åˆå¤‡ä»½å’Œæ•°æ®äº¤æ¢\n' +
                '- MDæ ¼å¼ï¼šç¬¦åˆNodeMindè§£æå™¨æ ‡å‡†ï¼Œæ”¯æŒå®Œæ•´è„‘å›¾æ¢å¤\n' +
                '- MDæ ¼å¼åŒ…å«ï¼šèŠ‚ç‚¹å…³ç³»è·¯å¾„ã€ä¼šè¯æ•°æ®ã€å››ç»„ä»¶çŠ¶æ€ã€æ ‡ç­¾ç³»ç»Ÿ'
            );
            
            if (dialog) {
                // ç”¨æˆ·é€‰æ‹©JSONæ ¼å¼
                saveProjectMindmap();
            } else {
                // ç”¨æˆ·é€‰æ‹©MDæ ¼å¼ - ä½¿ç”¨æ ‡å‡†è§£æå™¨
                exportToMDDocumentWithStandardParser();
            }
        }

        // ğŸš€ ä½¿ç”¨NodeMindæ ‡å‡†è§£æå™¨å¯¼å‡ºMDæ–‡æ¡£ - ä¿è¯å®Œç¾å¤ç°
        async function exportToMDDocumentWithStandardParser() {
            try {
                showMessage('ğŸ”„ æ­£åœ¨ç”ŸæˆNodeMindæ ‡å‡†MDæ–‡æ¡£...', 3000);
                
                // ğŸ”„ ç¬¬ä¸€æ­¥ï¼šæ•°æ®å®Œæ•´æ€§æ£€æŸ¥ä¸åŒæ­¥
                
                // è·å–å®Œæ•´çš„NodeMindæ•°æ®æ¶æ„
                let nodeDatabase = await getNodeDatabase();
                const sessionDatabase = await getSessionDatabase();
                let mindmapData = await getMindmapDataWithHierarchy();
                const fourComponentData = await getFourComponentData();
                
                // å¼ºåˆ¶æ•°æ®åŒæ­¥ï¼Œç¡®ä¿è·¯å¾„ä¿¡æ¯å®Œæ•´
                nodeDatabase = await syncMindmapDataWithNodeDatabaseEnhanced(mindmapData, nodeDatabase);
                
                // éªŒè¯å…³é”®æ•°æ®å®Œæ•´æ€§
                const nodeCount = Object.keys(nodeDatabase).length;
                const sessionCount = Object.keys(sessionDatabase).length;
                const mindmapCount = Object.keys(mindmapData).length;
                
                
                if (nodeCount === 0) {
                    throw new Error('æ²¡æœ‰å¯ä¿å­˜çš„èŠ‚ç‚¹æ•°æ®');
                }
                
                // ğŸ”„ ç¬¬äºŒæ­¥ï¼šè·¯å¾„å…³ç³»éªŒè¯
                let pathValidationCount = 0;
                let relationValidationCount = 0;
                
                Object.values(nodeDatabase).forEach(node => {
                    if (node.path) pathValidationCount++;
                    if (node.relations) relationValidationCount++;
                });
                
                
                // ğŸ”„ ç¬¬ä¸‰æ­¥ï¼šé¡¹ç›®ä¿¡æ¯å‡†å¤‡
                const projectInfo = {
                    name: 'å½“å‰NodeMindé¡¹ç›®',
                    description: 'åŸºäºNodeMindè·¯å¾„å¼æ¶æ„çš„æ€ç»´å¯¼å›¾é¡¹ç›®ï¼Œæ”¯æŒå®Œæ•´è„‘å›¾æ¢å¤',
                    author: 'NodeMindç”¨æˆ·',
                    version: '2.0.0',
                    exportTime: new Date().toISOString(),
                    dataFormat: 'NodeMindè·¯å¾„å¼æ ‡å‡† v2.0 + IDæ ‡å‡†åŒ–',
                    parserVersion: 'è·¯å¾„å¼èŠ‚ç‚¹å…³ç³»ç®¡ç†å™¨ + IDæ ‡å‡†åŒ–ç®¡ç†å™¨'
                };
                
                // ğŸ”„ ç¬¬å››æ­¥ï¼šç”Ÿæˆæ ‡å‡†MDæ–‡æ¡£
                const mdContent = generateNodeMindStandardDocument(
                    nodeDatabase, 
                    sessionDatabase, 
                    mindmapData, 
                    fourComponentData, 
                    projectInfo
                );
                
                // éªŒè¯ç”Ÿæˆçš„å†…å®¹
                if (!mdContent || mdContent.length < 100) {
                    throw new Error('ç”Ÿæˆçš„MDæ–‡æ¡£å†…å®¹å¼‚å¸¸');
                }
                
                
                // ğŸ”„ ç¬¬äº”æ­¥ï¼šæ–‡ä»¶åç”Ÿæˆ
                const timestamp = new Date().toISOString().split('T')[0];
                const fileName = `NodeMind_æ ‡å‡†å¯¼å‡º_${timestamp}.md`;
                
                
                // ğŸ”„ ç¬¬å…­æ­¥ï¼šä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ
                await saveStandardMDDocument(mdContent, fileName);
                
                // ğŸ”„ ç¬¬ä¸ƒæ­¥ï¼šéªŒè¯ä¿å­˜ç»“æœ
                showMessage(`âœ… NodeMindæ ‡å‡†MDæ–‡æ¡£å·²å¯¼å‡º: ${fileName}`, 4000, 'success');
                
                // è¿”å›å¯¼å‡ºç»“æœ
                return {
                    success: true,
                    fileName: fileName,
                    contentLength: mdContent.length,
                    nodeCount: nodeCount,
                    sessionCount: sessionCount,
                    mindmapCount: mindmapCount,
                    pathValidationCount: pathValidationCount,
                    relationValidationCount: relationValidationCount
                };
                
            } catch (error) {
                console.error('âŒ [NodeMindæ ‡å‡†è§£æå™¨] å¯¼å‡ºå¤±è´¥:', error);
                showMessage(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 5000, 'error');
                throw error;
            }
        }

        // ğŸ“¥ ä¿å­˜NodeMindæ ‡å‡†MDæ–‡æ¡£ - å¼ºåˆ¶ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨
        async function saveStandardMDDocument(content, fileName) {
            try {
                
                // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
                if (!window.showSaveFilePicker) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶é€‰æ‹©å™¨APIï¼Œè¯·ä½¿ç”¨Chrome 86+æˆ–Edge 86+');
                }
                
                // ğŸ”’ å¼ºåˆ¶ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ä¿å­˜ï¼ˆä¸é™çº§åˆ°ä¸‹è½½æ¨¡å¼ï¼‰
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'NodeMindæ ‡å‡†MDæ–‡æ¡£',
                            accept: {
                                'text/markdown': ['.md'],
                                'text/plain': ['.md', '.txt']
                            }
                        }
                    ]
                });
                
                // å†™å…¥æ–‡ä»¶
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                showMessage('âœ… NodeMindæ ‡å‡†MDæ–‡æ¡£å·²æˆåŠŸä¿å­˜åˆ°æŒ‡å®šä½ç½®', 3000, 'success');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜', 2000);
                } else {
                    console.error('âŒ [æ–‡ä»¶ä¿å­˜] ä¿å­˜å¤±è´¥:', error);
                    showMessage(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 4000, 'error');
                    throw error;
                }
            }
        }

        // ğŸ“¥ ä¿å­˜MDæ–‡æ¡£ - å¼ºåˆ¶ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
        async function downloadMDDocument(content, fileName) {
            try {
                // ğŸ”’ å¼ºåˆ¶ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ä¿å­˜ï¼ˆä¸é™çº§åˆ°ä¸‹è½½æ¨¡å¼ï¼‰
                    await saveWithFileSystemAPIMD(content, fileName);
            } catch (error) {
                console.error('âŒ MDæ–‡æ¡£ä¿å­˜å¤±è´¥:', error);
                if (error.name === 'AbortError') {
                    showMessage('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜');
                } else {
                    showMessage('âŒ ä¿å­˜å¤±è´¥: æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒæ–‡ä»¶é€‰æ‹©å™¨ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨');
                }
            }
        }
        
        // ä½¿ç”¨ç°ä»£æ–‡ä»¶ç³»ç»ŸAPIä¿å­˜MDæ–‡æ¡£
        async function saveWithFileSystemAPIMD(content, fileName) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'Markdownæ–‡æ¡£',
                            accept: {
                                'text/markdown': ['.md'],
                                'text/plain': ['.md', '.txt']
                            }
                        }
                    ]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                showMessage('âœ… MDæ–‡æ¡£å·²æˆåŠŸä¿å­˜åˆ°æŒ‡å®šä½ç½®');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜');
                } else {
                    console.error('âŒ MDæ–‡ä»¶é€‰æ‹©å™¨ä¿å­˜å¤±è´¥:', error);
                    throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å¤„ç†
                }
            }
        }
        
        // æš´éœ²å¿…è¦çš„å…¨å±€å‡½æ•°
        window.initThirdReconstructionArchitecture = initThirdReconstructionArchitecture;

        // ğŸš€ é›†æˆæ–°çš„NodeMindæ ‡å‡†è§£æå™¨ v2.0
        let standardParser = null;
        
        // åˆå§‹åŒ–æ–°è§£æå™¨
        function initStandardParser() {
            try {
                if (window.NodeMindStandardParser) {
                    standardParser = new window.NodeMindStandardParser();
                    
                    // æ›¿æ¢æ—§çš„è§£æå‡½æ•°
                    window.parseImportedMDNodes_NEW = async function(mdContent) {
                        const result = await standardParser.parseMDToNodeMind(mdContent);
                        
                        // è½¬æ¢ä¸ºå…¼å®¹æ—§æ ¼å¼çš„èŠ‚ç‚¹æ•°ç»„
                        const nodes = Object.values(result.nodeDatabase).map(node => ({
                            id: node.id,
                            title: node.title,
                            content: node.content,
                            level: node.level,
                            path: node.path,
                            tags: Object.values(node.tags || {}).flat(),
                            author: node.author,
                            priority: 'medium',
                            status: 'pending',
                            time: {
                                created: node.created,
                                modified: node.modified
                            },
                            metadata: node.metadata
                        }));
                        
                        return nodes;
                    };
                    
                    // æ›¿æ¢æ—§çš„ç”Ÿæˆå‡½æ•°
                    window.generateNodeMindStandardDocument = function(nodeDatabase, sessionDatabase, mindmapData, fourComponentData, projectInfo) {
                        return standardParser.generateStandardMD(nodeDatabase, sessionDatabase, mindmapData, projectInfo);
                    };
                    
                    return true;
                } else {
                    console.warn('âš ï¸ [NodeMindæ ‡å‡†è§£æå™¨] è§£æå™¨æ–‡ä»¶æœªåŠ è½½');
                    return false;
                }
            } catch (error) {
                console.error('âŒ [NodeMindæ ‡å‡†è§£æå™¨] åˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ–°è§£æå™¨
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const success = initStandardParser();
                if (success) {
                } else {
                    console.warn('âš ï¸ [NodeMind v2.0] è§£æå™¨åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ç»§ç»­ä½¿ç”¨æ—§ç‰ˆè§£æå™¨');
                }
            }, 1000);
        });
        
        // æš´éœ²æ–°è§£æå™¨åˆ°å…¨å±€
        window.standardParser = standardParser;
        window.initStandardParser = initStandardParser;
        
    </script>
</body>
</html> 