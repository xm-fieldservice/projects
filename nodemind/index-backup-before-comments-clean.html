<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsMind 本地版演示</title>
    <link type="text/css" rel="stylesheet" href="node_modules/jsmind/style/jsmind.css" />
    <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <!-- 外部样式文件 -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/template-styles.css">
    
    <!-- NodeMind 核心脚本 -->
    <script src="src/services/nodemind_standard_parser.js"></script>
</head>

<body>
    <!-- 外部JavaScript文件 -->
    <script src="assets/js/app.js"></script>
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #6c757d;
            font-weight: 500;
        }
        
        .log-app {
            color: #007bff;
            font-weight: 500;
        }
        
        .log-command {
            color: #495057;
            margin-top: 2px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .calibration-info {
            margin-top: 15px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }
        
        .status-calibrating {
            color: #ff9800;
            font-weight: 500;
        }
        
        .status-calibrated {
            color: #4caf50;
            font-weight: 500;
        }
        
        .status-uncalibrated {
            color: #f44336;
            font-weight: 500;
        }
        
        /* 标签管理组件样式 */
        .tags-management-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .tags-management-title {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tag-groups-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* 节点信息选项卡中的标签组样式优化 */
        #tab-injection .tags-management-section .tag-group {
            margin-bottom: 0;
            padding: 12px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        
        #tab-injection .tags-management-section .tag-group-title {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
        
        #tab-injection .tags-management-section .tag-group-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        #tab-injection .tags-management-section .tag-item {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            border: 1px solid transparent;
        }
        
        #tab-injection .tags-management-section .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 拷贝粘贴按钮样式 */
        .btn-copy, .btn-paste {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-copy:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .btn-paste:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        /* 分割线样式 */
        .detail-splitter {
            width: 4px;
            background: #dee2e6;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }
        
        .detail-splitter:hover {
            background: #007bff;
        }
        
        .side-panel-splitter {
            height: 4px;
            background: #dee2e6;
            cursor: row-resize;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }
        
        .side-panel-splitter:hover {
            background: #007bff;
        }
        
        /* 详情工作区布局 */
        .detail-workspace {
            display: flex;
            height: 100%;
            gap: 0;
        }
        
        .detail-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
        }
        
        .detail-side-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
        }
        
        .section-header {
            padding: 12px 15px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .section-header h4 {
            margin: 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* AI输入区域样式 */
        .ai-interaction-section {
            margin-top: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .ai-input-area {
            padding: 15px;
        }
        
        .ai-input {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
            background: white;
        }
        
        .ai-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .ai-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .content-editor {
            min-height: 200px;
        }
        
        /* 标题区域和元信息样式 */
        .title-section {
            margin-bottom: 15px;
        }
        
        .title-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            background: white;
        }
        
        .title-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .node-meta-section {
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6c757d;
        }
        
        .meta-time {
            font-weight: 500;
        }
        
        .content-editor-section {
            margin-bottom: 15px;
        }
        
        .tags-section {
            margin-bottom: 15px;
        }
        
        .tags-label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: block;
        }
        
        /* 模板列表样式 */
        .template-list {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }
        
        /* 消息提示动画 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* 新的节点信息面板布局样式 */
        .detail-workspace {
            display: flex;
            height: 100%;
            gap: 0;
            background: #f8f9fa;
        }
        
        .detail-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
            overflow-y: auto;
            min-width: 0;
        }
        
        .detail-splitter {
            width: 4px;
            background: #dee2e6;
            cursor: col-resize;
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        .detail-splitter:hover {
            background: #007bff;
        }
        
        .detail-splitter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: #adb5bd;
            border-radius: 1px;
        }
        
        .detail-side-panel {
            width: 300px;
            min-width: 200px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
        }
        
        /* 标题区域 */
        .title-section {
            margin-bottom: 8px;
        }
        
        .title-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            background: #ffffff;
            transition: border-color 0.2s ease;
        }
        
        .title-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        /* 节点元信息区域 */
        .node-meta-section {
            margin-bottom: 16px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .meta-row label {
            font-weight: 600;
            color: #495057;
            min-width: 40px;
        }
        
        .meta-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: #ffffff;
        }
        
        .meta-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .meta-time {
            color: #6c757d;
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* 内容编辑区域 */
        .content-editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        
        .editor-header {
            margin-bottom: 8px;
        }
        
        .editor-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .content-editor {
            flex: 1;
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            background: #ffffff;
            resize: vertical;
            min-height: 300px; /* 增加最小高度 */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            transition: border-color 0.2s ease;
        }
        
        .content-editor.expanded {
            min-height: 450px; /* 扩展后的高度 */
        }
        
        .content-editor:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        /* 内容头部区域 */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
        .content-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* 问答开关样式 */
        .qa-switch-container {
            display: flex;
            align-items: center;
        }
        
        .qa-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .qa-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .qa-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: #ccc;
            border-radius: 24px;
            transition: 0.3s;
            margin-right: 8px;
        }
        
        .qa-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .qa-switch input:checked + .qa-slider {
            background-color: #007bff;
        }
        
        .qa-switch input:checked + .qa-slider:before {
            transform: translateX(20px);
        }
        
        .qa-label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }
        
        /* AI交互区域 */
        .ai-interaction-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
        }
        
        .ai-input-area {
            margin-bottom: 12px;
        }
        
        .ai-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            background: #ffffff;
        }
        
        .ai-input:disabled {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .ai-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        
        .btn-save, .btn-submit {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-save:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-submit {
            background: #007bff;
            color: white;
        }
        
        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .ai-agent-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .agent-selector {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: #ffffff;
        }
        
        .agent-selector:disabled {
            background: #e9ecef;
            color: #6c757d;
        }
        
        /* 标签区域 */
        .tags-section {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
        }
        
        .tags-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .tags-label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
        
        /* 项目信息页面样式 */
        .node-info-panel {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .node-info-panel h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }
        
        /* 项目按钮容器样式 */
        .basic-info-panel .project-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        /* 校准功能样式 - 仅影响项目信息面板 */
        .basic-info-panel .calibrate-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .basic-info-panel .calibrate-btn:hover {
            background: #0056b3;
        }
        
        /* 提示词模板按钮样式 */
        .template-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .template-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .template-button:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .basic-info-panel .status-calibrated {
            color: #28a745;
            font-weight: 600;
        }
        
        .basic-info-panel .status-uncalibrated {
            color: #000000;
            font-weight: 600;
        }
        
        .basic-info-panel .status-calibrating {
            color: #ffc107;
            font-weight: 600;
        }
        
        .basic-info-panel .calibration-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #dee2e6;
        }
        
        /* 命令注入测试框样式 */
        .basic-info-panel .command-injection-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #dee2e6;
        }
        
        .basic-info-panel .command-injection-section h4 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .basic-info-panel .injection-input-area {
            margin-bottom: 12px;
        }
        
        .basic-info-panel .injection-input-area label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
        }
        
        .basic-info-panel .injection-input-area textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        
        .basic-info-panel .injection-input-area textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .basic-info-panel .injection-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .basic-info-panel .inject-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .basic-info-panel .inject-btn:hover {
            background: #c82333;
        }
        
        .basic-info-panel .inject-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .basic-info-panel .clear-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .basic-info-panel .clear-btn:hover {
            background: #5a6268;
        }
        
        .basic-info-panel .injection-status {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .basic-info-panel .injection-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .basic-info-panel .injection-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* 整合控制栏样式 */
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 12px;
        }
        
        .toggle-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            user-select: none;
        }
        
        .toggle-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        
        .toggle-label {
            font-weight: 500;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .button-group .btn {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .button-group .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .button-group .btn-secondary:hover {
            background: #545b62;
        }
        
        .button-group .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .button-group .btn-primary:hover {
            background: #0056b3;
        }
        
        .button-group .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .button-group .btn-info:hover {
            background: #138496;
        }
        
        /* 全屏模式样式 */
        .content-section.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background: white !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        }
        
        .content-section.fullscreen .content-editor {
            height: calc(100vh - 120px) !important;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .content-section.fullscreen .controls-row {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding: 12px 0;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        /* 调试模式内容样式 */
        .content-editor.debug-mode {
            font-family: 'Consolas', 'Monaco', monospace !important;
            font-size: 12px !important;
            line-height: 1.4 !important;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .content-editor.normal-mode {
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            background: white;
        }

        /* 右侧面板各区域 */
        .session-list-section {
            height: 60%; /* 默认占据60%高度 */
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 100px; /* 最小高度限制 */
            overflow: hidden;
        }
        
        .template-section {
            flex: 1; /* 占据剩余空间 */
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 80px; /* 最小高度限制 */
            overflow: hidden;
        }
        
        /* 右侧面板内部分割线 */
        .side-panel-splitter {
            height: 4px;
            background: #dee2e6;
            cursor: row-resize;
            position: relative;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        
        .side-panel-splitter:hover {
            background: #007bff;
        }
        
        .side-panel-splitter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 2px;
            background: #adb5bd;
            border-radius: 1px;
        }
        
        .section-header {
            margin-bottom: 12px;
            flex-shrink: 0; /* 标题不收缩 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }
        
        .view-mode-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
        }
        
        .view-mode-btn:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1; /* 占据剩余空间 */
            overflow-y: auto; /* 内容过多时滚动 */
            min-height: 0; /* 允许收缩 */
        }
        
        .template-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0; /* 列表项不收缩 */
        }
        
        .template-item:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .detail-side-panel {
                width: 250px;
                min-width: 200px;
            }
        }
        
        @media (max-width: 900px) {
            .detail-workspace {
                flex-direction: column;
            }
            
            .detail-splitter {
                display: none;
            }
            
            .detail-side-panel {
                width: 100%;
                max-height: 300px;
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
        }

        /* 四组件布局样式 */
        .detail-workspace {
            display: flex;
            flex-direction: column;
            height: 800px;
            font-family: inherit;
        }

        /* 标题区域 */
        .title-area {
            background: #fafafa;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .qa-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qa-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .qa-toggle label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .title-content {
            flex: 1;
        }

        .node-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
            line-height: 1.4;
        }

        /* 主内容区域 */
        .main-content-area {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* 固定选项卡框架宽度 - 不自动调节 */
        .details-panel {
            width: 800px !important; /* 固定宽度，不使用 clamp 函数 */
            min-width: 800px !important;
            max-width: 800px !important;
            flex-shrink: 0 !important;
        }
        
        /* 固定选项卡标签按钮宽度 - 不使用弹性布局 */
        .tab-button {
            flex: none !important; /* 取消弹性布局 */
            width: 400px !important; /* 固定宽度，总宽度800px的一半 */
            min-width: 400px !important;
            max-width: 400px !important;
        }
        
        /* 确保选项卡头部不使用flex的自动分配 */
        .tab-header {
            display: flex !important;
            width: 800px !important; /* 与选项卡框架宽度一致 */
        }

        /* 组件A: 内容编辑器 */
        .content-section {
            flex: 0 0 auto;
            max-height: 280px;
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .content-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .content-controls {
            display: flex;
            gap: 8px;
        }

        .title-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .content-editor {
            height: 150px;
            max-height: 180px;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .meta-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        /* 组件B: 三标签页组件 */
        .tags-section {
            padding: 0;
            background: #f9f9f9;
            border: 3px solid #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 400px;
            margin-top: 190px;
        }

        /* 内部标签页头部 */
        .inner-tab-header {
            display: flex;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .inner-tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
            position: relative;
        }

        .inner-tab-button:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .inner-tab-button.active {
            background: #fff;
            color: #007bff;
            font-weight: 600;
        }

        .inner-tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #007bff;
        }

        /* 内部标签页内容容器 */
        .inner-tab-content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .inner-tab-content {
            display: none;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .inner-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* 会话列表样式 */
        .sessions-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .session-item {
            padding: 12px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .session-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
            transform: translateY(-1px);
        }

        .session-item.active {
            background-color: #e7f3ff;
            border-color: #007bff;
            border-width: 2px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .session-title {
            font-weight: 500;
            color: #333;
            flex: 1;
            margin-right: 8px;
            line-height: 1.4;
        }

        .session-actions {
            display: flex;
            gap: 4px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .session-item:hover .session-actions {
            opacity: 1;
        }

        .session-favorite-btn,
        .session-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .session-favorite-btn:hover {
            background-color: #ffc107;
            color: white;
        }

        .session-delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }

        .session-time {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .session-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .session-tag {
            background-color: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .session-empty {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .session-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .session-empty-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .session-empty-hint {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        /* 模板列表样式 */
        .templates-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .template-item {
            padding: 12px 16px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-item:hover {
            border-color: #28a745;
            box-shadow: 0 2px 4px rgba(40,167,69,0.1);
        }

        .template-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }

        .template-desc {
            font-size: 12px;
            color: #6c757d;
        }
        
        .template-item.selected {
            border-color: #28a745;
            border-width: 2px;
            background: #f8fff9;
            box-shadow: 0 2px 8px rgba(40,167,69,0.2);
        }

        .tags-header {
            margin-bottom: 15px;
        }

        .tags-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .tag-group {
            margin-bottom: 15px;
        }

        .tag-group-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            padding: 4px 8px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tag.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content-area {
                flex-direction: column;
            }
        }

        /* 节点选中高亮样式 */
        .jmnode-selected {
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.6) !important;
            border: 2px solid #007bff !important;
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        /* 移除了节点选择反馈动画相关样式 */

        /* 选项卡切换动画增强 */
        .details-panel .tab-content {
            transition: all 0.3s ease;
        }

        .details-panel .tab-content.active {
            animation: slideInFromRight 0.3s ease-out;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 节点信息标签页按钮高亮 */
        .details-panel .tab-button.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* 移除了标签页切换反馈动画相关样式 */
        
        /* 节点信息面板主容器标注 - 浅蓝色边框 */
        #injection-info-content {
            border: 3px solid #87CEEB;
            box-shadow: 0 0 10px rgba(135, 206, 235, 0.3);
            padding-bottom: 200px;
        }

        /* 左侧面板样式 */
        .left-panel, #left-panel {
            /* 移除了红色边框 */
        }

      </style>
      
      <!-- 🔥 第三次重构核心模块 - 万能数据架构 -->
      <script src="3rd_reconstruction/src/core/universal_data_service.js"></script>
      <script src="3rd_reconstruction/src/core/smart_md_parser.js"></script>
      <script src="3rd_reconstruction/src/adapters/ui_integration_adapter.js"></script>
      <script src="3rd_reconstruction/src/services/tag_service_replacement.js"></script>
      
      <!-- 架构守护工具 - 实时监控模块化规范 -->
      <!-- <script src="src/utils/architecture_guard.js" type="module"></script> -->
      
      <!-- 数据结构统一与染色系统 -->
      <script src="src/services/data_structure_unifier.js"></script>
      <script src="src/services/unified_node_styling_service.js"></script>
      <script src="fix_data_structure_and_coloring.js"></script>
      
      <!-- 可视化修复服务 -->
      <script src="src/services/visual_repair_service.js"></script>
      
      <!-- 模板管理服务 -->
      <script src="src/services/template_service.js"></script>
      <script src="src/services/template_selection_service.js"></script>
      <link rel="stylesheet" href="src/styles/template_selection.css">
      
      <!-- 节点事件处理器 - 替换内联事件 -->
      <script type="module">
        import { 
          handleNodeContentChange,
          handleNodeTitleChange,
          handleQAModeChange,
          handleProjectAuthorChange
        } from './src/services/node_service.js';
        
        // 立即暴露函数到全局作用域
        window.handleNodeContentChange = handleNodeContentChange;
        window.handleNodeTitleChange = handleNodeTitleChange;
        window.handleQAModeChange = handleQAModeChange;
        window.handleProjectAuthorChange = handleProjectAuthorChange;
        
        // 🔧 节点事件监听器初始化（紧急修复缺失函数）
        function initializeNodeEventListeners() {
            
            try {
                // 核心工具栏按钮事件绑定
                const buttons = [
                    'show_guide_button',
                    'export_custom_file_button', 
                    'import_file_button',
                    'create_new_mindmap_button',
                    'sync_tags_button',
                    'extensionToggleBtn',
                    'panelToggleBtn'
                ];
                
                buttons.forEach(buttonId => {
                    const btn = document.getElementById(buttonId);
                    if (btn && !btn.onclick && !btn.hasEventListener) {
                        btn.hasEventListener = true; // 标记已绑定
                    }
                });
                
                // 标签页按钮事件绑定
                const tabButtons = [
                    'tab_button_workspace',
                    'tab_button_knowledge', 
                    'tab_button_project',
                    'detail_tab_injection',
                    'detail_tab_project'
                ];
                
                tabButtons.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab && !tab.hasEventListener) {
                        tab.hasEventListener = true;
                    }
                });
                
                // 四组件相关事件初始化
                if (window.initializeFourComponentEvents && typeof window.initializeFourComponentEvents === 'function') {
                    window.initializeFourComponentEvents();
                }
                
                // 节点点击事件绑定
                if (window.bindNodeEvents && typeof window.bindNodeEvents === 'function') {
                    window.bindNodeEvents();
                }
                
                
            } catch (error) {
                console.error('❌ 节点事件监听器初始化失败:', error);
            }
        }

        // 初始化函数
        function initModularEvents() {
          initializeNodeEventListeners();
        }
        
        // 多重初始化策略
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initModularEvents);
        } else {
          // DOM已经加载完成，立即执行
          initModularEvents();
        }

        // 简化的标签页切换功能
        function initInnerTabSwitching() {
            
            // 清除可能存在的旧事件监听器
            const innerTabButtons = document.querySelectorAll('.inner-tab-button');
            const innerTabContents = document.querySelectorAll('.inner-tab-content');
            
            
            // 列出所有找到的元素
            innerTabButtons.forEach((btn, i) => {
            });
            
            innerTabContents.forEach((content, i) => {
            });

            if (innerTabButtons.length === 0 || innerTabContents.length === 0) {
                console.warn('⚠️ [标签页] 未找到标签页元素');
                return;
            }

            // 使用onclick直接绑定，避免addEventListener冲突
            innerTabButtons.forEach((button, index) => {
                const tabName = button.getAttribute('data-tab');
                
                // 移除旧的事件处理器
                button.onclick = null;
                
                // 绑定新的点击事件
                button.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 移除所有按钮的active类
                    innerTabButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // 隐藏所有内容
                    innerTabContents.forEach(content => content.classList.remove('active'));
                    
                    // 激活点击的按钮
                    this.classList.add('active');
                    
                    // 显示对应的内容
                    const targetContent = document.getElementById(`inner-tab-${tabName}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                };
            });
            
        }

        // 单一初始化策略
        
        // 简化的事件绑定函数
        function bindTabEvents() {
            const buttons = document.querySelectorAll('.inner-tab-button');
            
            buttons.forEach((button) => {
                const tabName = button.getAttribute('data-tab');
                
                button.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 切换逻辑
                    buttons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.inner-tab-content').forEach(content => content.classList.remove('active'));
                    
                    this.classList.add('active');
                    const targetContent = document.getElementById(`inner-tab-${tabName}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                };
            });
        }

        // 初始化策略
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initInnerTabSwitching();
                bindTabEvents();
            }, 100);
        });

      </script>
      <script src="md-parser-fixed.js"></script>
      
</head>
<body>

    <div class="container">
        <div class="header">
            <!-- 保留区域备用 -->
        </div>
        
        <div class="toolbar">
            <input type="file" id="import_file_input" accept=".json,.jm,.mm" style="display: none;">
            
            <div class="toolbar-left">
                <button id="show_guide_button" class="btn btn-primary" style="background: #007bff; border: 2px solid #0056b3; font-size: 16px; font-weight: 600; padding: 12px 24px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); transition: all 0.3s ease;">
                    📚 使用指南
                </button>
                <button id="export_custom_file_button" class="btn btn-info">
                    💾 保存文件
                </button>
                <button id="import_file_button" class="btn btn-success">
                    📂 导入MD文档
                </button>
                <button id="create_new_mindmap_button" class="btn btn-warning">
                    ✨ 新脑图
                </button>
                <button id="sync_tags_button" class="btn btn-secondary">
                    🔄 标签同步
                </button>
                <button onclick="handleAnalyzeTagData()" class="btn btn-info">
                    🔍 分析标签数据
                </button>
                <button onclick="testTagSync()" class="btn btn-info">
                    🧪 测试标签
                </button>
                <button onclick="visualRepairService.triggerCheck()" class="btn btn-warning">
                    🛠️ 修复检查
                </button>
                <button onclick="openMDDirectPanel()" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                    📝 MD直存
                </button>

            </div>
            
            <div class="toolbar-right">
                <button class="btn btn-info" id="extensionToggleBtn">
                    ◀ 折叠扩展区
                </button>
                <button class="btn btn-secondary" id="panelToggleBtn">
                    📋 隐藏详情面板
                </button>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="mindmap-container">
                <div class="mindmap-tab-container">
                    <div class="mindmap-tab-header">
                        <button id="tab_button_workspace" class="mindmap-tab-button" data-tab="workspace">
                            🏷️ 标签管理
                        </button>
                        <button id="tab_button_knowledge" class="mindmap-tab-button" data-tab="knowledge">
                            📋 临时工作区B
                        </button>
                        <button id="tab_button_project" class="mindmap-tab-button active" data-tab="project">
                            🚀 项目管理
                        </button>
                    </div>
                    
                    <div id="mindmap-tab-workspace" class="mindmap-tab-content">
                        <div id="jsmind_container_workspace" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <div id="mindmap-tab-knowledge" class="mindmap-tab-content">
                        <div id="jsmind_container_knowledge" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <div id="mindmap-tab-project" class="mindmap-tab-content active">
                        <div id="jsmind_container_project" class="jsmind-tab-canvas"></div>
                    </div>
                </div>
            </div>
            
            <div class="details-panel">
                <div class="tab-container">
                    <div class="tab-header">
                        <button id="detail_tab_injection" class="tab-button active" data-tab="injection">
                            📄 节点信息
                        </button>
                        <button id="detail_tab_project" class="tab-button" data-tab="project">
                            📋 项目信息
                        </button>
                    </div>
                    
                    <div id="tab-injection" class="tab-content active">
                        <div id="injection-info-content">
                            <!-- 四组件布局主体 -->
                            <div class="detail-workspace" id="detail-workspace">
                                <!-- 标题区域（动态调整） -->
                                <div class="title-area" id="title-area">
                                    <div class="title-content">
                                        <h3 class="node-title" id="node-title">点击思维导图中的节点查看节点信息</h3>
                                    </div>
                                </div>
                                
                                <!-- 主内容区域 -->
                                <div class="main-content-area" id="main-content-area">
                                    <!-- 左侧面板 -->
                                    <div class="left-panel" id="left-panel">
                                        <!-- 组件A: 内容编辑器（节点联动） -->
                                        <div class="content-section" id="content-section">
                                            <div class="content-header">
                                                <div class="content-controls">
                                                    <!-- 整合的控制栏 -->
                                                    <div class="controls-row">
                                                        <div class="toggle-group">
                                                            <label class="toggle-item">
                                                                <input type="checkbox" id="qa-mode-toggle" checked onchange="onQAModeChange()">
                                                                <span class="toggle-label">问答模式</span>
                                                            </label>
                                                            <label class="toggle-item">
                                                                <input type="checkbox" id="debug-mode-toggle" onchange="onDebugModeChange()">
                                                                <span class="toggle-label">调试</span>
                                                            </label>
                                                        </div>
                                                        <div class="button-group">
                                                            <button class="btn btn-info" onclick="testDebugFunction()" title="测试调试功能">🧪 测试</button>
                                                            <button class="btn btn-secondary" onclick="toggleFullscreen()" title="全屏模式">🔍 全屏</button>
                                                            <button class="btn btn-primary" onclick="fourComponentSubmitContent()">✅ 提交</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <textarea class="content-editor" id="content-editor" 
                                                      placeholder="在这里编辑节点内容..."></textarea>
                                            <div class="meta-info" id="meta-info">
                                                创建时间: -- | 修改时间: --
                                            </div>
                                        </div>
                                        
                                                                <!-- 组件B: 三标签页组件（标签组件、会话列表、模板列表） -->
                        <div class="tags-section" id="tags-section">
                            <!-- 标签页头部 -->
                            <div class="inner-tab-header">
                                <button class="inner-tab-button active" data-tab="tags" onclick="console.log('开始执行标签组件点击'); try { if(typeof switchTabDirect === 'function') { console.log('switchTabDirect函数存在，开始调用'); switchTabDirect('tags'); } else { console.error('switchTabDirect函数不存在！'); } } catch(e) { console.error('执行switchTabDirect时出错:', e); }">🏷️ 标签组件</button>
                                <button class="inner-tab-button" data-tab="sessions" onclick="console.log('开始执行会话列表点击'); try { if(typeof switchTabDirect === 'function') { console.log('switchTabDirect函数存在，开始调用'); switchTabDirect('sessions'); } else { console.error('switchTabDirect函数不存在！'); } } catch(e) { console.error('执行switchTabDirect时出错:', e); }">📋 会话列表</button>
                                <button class="inner-tab-button" data-tab="templates" onclick="console.log('开始执行模板列表点击'); try { if(typeof switchTabDirect === 'function') { console.log('switchTabDirect函数存在，开始调用'); switchTabDirect('templates'); } else { console.error('switchTabDirect函数不存在！'); } } catch(e) { console.error('执行switchTabDirect时出错:', e); }">📄 模板列表</button>
                            </div>
                            
                            <!-- 标签页内容 -->
                            <div class="inner-tab-content-container">
                                <!-- 标签组件页面 -->
                                <div id="inner-tab-tags" class="inner-tab-content active">
                                    <div class="tag-groups-container" id="tag-groups">
                                        <!-- 标签组件将在初始化时从标签管理脑图动态加载 -->
                                        <div class="loading-tags-state">
                                            <div class="loading-icon">🔄</div>
                                            <div class="loading-text">正在从标签管理脑图加载标签...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 会话列表页面 -->
                                <div id="inner-tab-sessions" class="inner-tab-content">
                                    <div class="sessions-container">
                                        <div class="session-item">
                                            <div class="session-title">💬 项目讨论会话</div>
                                            <div class="session-time">2024-01-15 14:30</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">🔧 技术方案讨论</div>
                                            <div class="session-time">2024-01-15 10:15</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">📋 需求分析会话</div>
                                            <div class="session-time">2024-01-14 16:45</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">🎨 UI设计讨论</div>
                                            <div class="session-time">2024-01-14 11:20</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">🚀 功能优化会话</div>
                                            <div class="session-time">2024-01-13 15:30</div>
                                        </div>
                                        <div class="session-item">
                                            <div class="session-title">📊 数据分析讨论</div>
                                            <div class="session-time">2024-01-13 09:45</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 模板列表页面 -->
                                <div id="inner-tab-templates" class="inner-tab-content">
                                    <div class="templates-container">
                                        <div class="template-item">
                                            <div class="template-title">📝 笔记模板</div>
                                            <div class="template-desc">用于日常笔记记录</div>
                                        </div>
                                        <div class="template-item">
                                            <div class="template-title">💡 想法模板</div>
                                            <div class="template-desc">用于记录创意想法</div>
                                        </div>
                                        <div class="template-item">
                                            <div class="template-title">📋 任务模板</div>
                                            <div class="template-desc">用于任务管理</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-project" class="tab-content">
                        <div id="project-info-content">
                            <div class="basic-info-panel">
                                <h4>📋 项目基本信息</h4>
                                <div class="project-buttons">
                                    <button class="calibrate-btn" onclick="performCalibration()">校准</button>
                                </div>
                                <div class="info-item">
                                    <label>项目名称:</label>
                                    <span id="project-name-display">NodeMind 思维导图</span>
                                </div>
                                <div class="info-item">
                                    <label>项目路径:</label>
                                    <span id="project-path-display">未设置</span>
                                </div>
                                <div class="info-item">
                                    <label>版本:</label>
                                    <span>1.0.0</span>
                                </div>
                                <div class="info-item">
                                    <label>作者:</label>
                                    <span>NodeMind Team</span>
                                </div>
                                <div class="info-item">
                                    <label>描述:</label>
                                    <span>基于jsMind的思维导图应用</span>
                                </div>
                                <div class="calibration-info" id="calibration-info" style="display: none;">
                                    <div class="info-item">
                                        <label>应用名称:</label>
                                        <span id="app-name-display">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>状态:</label>
                                        <span id="calibration-status" class="status-uncalibrated">未校准</span>
                                    </div>
                                    <div class="info-item">
                                        <label>输入框坐标:</label>
                                        <span id="input-coordinates">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>屏幕信息:</label>
                                        <span id="screen-info">-</span>
                                    </div>
                                </div>
                                <div class="command-injection-section" id="command-injection-section">
                                    <h4>💉 命令注入测试框</h4>
                                    <div class="template-selection">
                                        <label>模板场景:</label>
                                        <select id="template-scene-select" onchange="onTemplateSceneChanged()">
                                            <option value="">选择场景...</option>
                                            <option value="自然模式">自然模式</option>
                                            <option value="技术模式">技术模式</option>
                                            <option value="创意模式">创意模式</option>
                                        </select>
                                        <label>模板版本:</label>
                                        <select id="template-version-select" onchange="onTemplateVersionChanged()">
                                            <option value="">选择版本...</option>
                                        </select>
                                    </div>
                                    <div class="injection-input-area">
                                        <label for="command-input">命令内容:</label>
                                        <textarea id="command-input" placeholder="请输入要注入的命令..." rows="3"></textarea>
                                    </div>
                                    <div class="injection-buttons">
                                        <button class="inject-btn" onclick="injectCommand()" disabled>注入命令</button>
                                        <button class="clear-btn" onclick="clearCommandInput()">清空</button>
                                        <button class="template-test-btn" onclick="testTemplate()">测试模板</button>
                                    </div>
                                    <div class="injection-status" id="injection-status">
                                        <span>请先完成校准才能使用命令注入功能</span>
                                    </div>
                                    <div class="injection-log-section">
                                        <h5>📝 注入日志 <button class="log-export-btn" onclick="exportInjectionLogs()">导出日志</button></h5>
                                        <div class="log-display" id="injection-log-display">
                                            <div class="log-empty">暂无注入记录</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>jsMind 本地版本已加载</span>
            </div>
            <div class="status-item">
                当前主题: <span id="currentTheme">primary</span>
            </div>
            <div class="status-item">
                选中节点: <span id="selectedNode">无</span>
            </div>
        </div>
    </div>

    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="context_menu_focus_node">🔬 单独显示到临时工作区</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context_menu_sync" style="display: none;">🔄 同步</div>
        <div class="context-menu-divider" id="context_menu_sync_divider" style="display: none;"></div>
        <div class="context-menu-item" id="context_menu_hide">❌ 取消</div>
    </div>

    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.js"></script>
    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.draggable-node.js"></script>
    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.screenshot.js"></script>

    <!-- 🚀 激活模块化架构 -->
            <!-- <script type="module" src="src/app.js"></script> -->
    
    <!-- 
    修改履历 - 提示词模板功能恢复 (2024)
    1. 删除重复的"提示词模板"h4标题，改为单一按钮入口
    2. 修复模板管理器空白页问题，添加内容初始化函数
    3. 修复返回按键不管用问题，添加完整事件绑定
    4. 引入template-manager.bundle.js支持完整模板管理器
    5. 添加降级机制确保基本功能可用
    修改位置：index.html.2059-2069, 1110-1126, 3725-3840, 1620
    -->
    <script>
        // 直接切换函数（最优先定义，确保内联事件可以调用）
        window.switchTabDirect = function(tabName) {
            
            // 移除所有按钮的active类
            document.querySelectorAll('.inner-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 隐藏所有内容
            document.querySelectorAll('.inner-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活点击的按钮
            const clickedButton = document.querySelector(`.inner-tab-button[data-tab="${tabName}"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                console.error('❌ 找不到目标按钮:', tabName);
            }
            
            // 显示对应的内容
            const targetId = `inner-tab-${tabName}`;
            const targetContent = document.getElementById(targetId);
            
            if (targetContent) {
                targetContent.classList.add('active');
            } else {
                console.error('❌ 找不到目标内容:', targetId);
                // 列出所有可用的inner-tab ID
                document.querySelectorAll('[id*="inner-tab"]').forEach(el => {
                });
            }
            
        };

        // 简化的思维导图初始化 - 基于工作版本jsmind-project.html
        
        // 思维导图数据配置
        var mindmapData = {
            workspace: {
                meta: { name: "标签管理", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "workspace_root",
                    topic: "🏷️ 标签管理",
                    children: [
                        {
                            id: "tag_group_normal", 
                            topic: "常规组", 
                            direction: "right",
                            children: [
                                { id: "tag_project", topic: "项目", isTag: true, tagGroup: "常规" },
                                { id: "tag_milestone", topic: "里程碑", isTag: true, tagGroup: "常规" },
                                { id: "tag_completed", topic: "完成", isTag: true, tagGroup: "常规" },
                                { id: "tag_inprogress", topic: "进行中", isTag: true, tagGroup: "常规" },
                                { id: "tag_planned", topic: "计划", isTag: true, tagGroup: "常规" }
                            ]
                        },
                        {
                            id: "tag_group_ai", 
                            topic: "AI组", 
                            direction: "left",
                            children: [
                                { id: "tag_memory", topic: "记忆", isTag: true, tagGroup: "AI" },
                                { id: "tag_attention", topic: "注意力", isTag: true, tagGroup: "AI" },
                                { id: "tag_experience", topic: "经验", isTag: true, tagGroup: "AI" },
                                { id: "tag_hallucination", topic: "幻觉", isTag: true, tagGroup: "AI" }
                            ]
                        },
                        {
                            id: "tag_group_notes", 
                            topic: "笔记组", 
                            direction: "left",
                            children: [
                                { id: "tag_followup", topic: "跟进", isTag: true, tagGroup: "笔记" },
                                { id: "tag_issue", topic: "议题", isTag: true, tagGroup: "笔记" }
                            ]
                        }
                    ]
                }
            },
            knowledge: {
                meta: { name: "临时工作区B", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "knowledge_root",
                    topic: "📋 临时工作区B",
                    children: []
                }
            },
            project: {
                meta: { name: "项目管理", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "project_root",
                    topic: "🚀 项目管理",
                    children: [
                        { id: "pj_1", topic: "需求分析", direction: "right" },
                        { id: "pj_2", topic: "设计阶段", direction: "right" },
                        { id: "pj_3", topic: "开发实施", direction: "left" },
                        { id: "pj_4", topic: "测试部署", direction: "left" },
                        {
                            id: "current_template_list",
                            topic: "当前模板列表",
                            direction: "right",
                            children: [
                                { id: "tmpl_1", topic: "自然模式" },
                                { id: "tmpl_2", topic: "代码自查" },
                                { id: "tmpl_3", topic: "修改代码" },
                                { id: "tmpl_4", topic: "不生效" },
                                { id: "tmpl_5", topic: "日志-修改代码" },
                                { id: "tmpl_6", topic: "新功能" }
                            ]
                        }
                    ]
                }
            }
        };

        // 基础配置
        var baseOptions = {
            editable: true,
            theme: 'primary',
            view: { engine: 'canvas', hmargin: 150, vmargin: 80, line_width: 2, line_color: '#566' },
            layout: { hspace: 40, vspace: 30, pspace: 15 },
            shortcut: { enable: true, handles: {}, mapping: { addchild: 4096 + 13, addbrother: 13, editnode: 113, delnode: 46, toggle: 32, left: 37, up: 38, right: 39, down: 40 } },
            default_direction: 'right'
        };

        // 全局变量
        var mindmaps = {};
        var currentMindmap = 'project';
        var selectedNodeId = null;
        var nodeDatabase = {}; // 节点详细信息数据库
        var lastSavedFilePath = null; // 文件保存路径
        
        // 项目信息
        var projectInfo = {
            name: '未设置',
            path: '未设置',
            description: '未设置',
            author: '未设置',
            version: '1.0.0'
        };
        
        // 存储键名配置
        var STORAGE_KEYS = {
            MINDMAP_DATA: 'nodemind_mindmap_data',
            NODE_DATABASE: 'nodemind_node_database',
            SESSION_DATABASE: 'nodemind_session_database',
            CURRENT_THEME: 'nodemind_current_theme',
            DRAG_ENABLED: 'nodemind_drag_enabled',
            SELECTED_NODE: 'nodemind_selected_node',
            VIEW_DATA: 'nodemind_view_data',
            LAST_SAVED_PATH: 'nodemind_last_saved_path',
            PROJECT_INFO: 'nodemind_project_info',
            FOUR_COMPONENT_DATA: 'nodemind_four_component_data',
            FOUR_COMPONENT_GLOBAL_STATE: 'nodemind_four_component_global_state',
            FOUR_COMPONENT_SESSIONS: 'nodemind_four_component_sessions'
        };

        // 初始化思维导图
        function initMindmaps() {
            
            // 创建工作空间脑图
            mindmaps.workspace = new jsMind({ ...baseOptions, container: 'jsmind_container_workspace' });
            mindmaps.workspace.show(mindmapData.workspace);
            
            // 创建知识库脑图
            mindmaps.knowledge = new jsMind({ ...baseOptions, container: 'jsmind_container_knowledge' });
            mindmaps.knowledge.show(mindmapData.knowledge);
            
            // 创建项目管理脑图
            mindmaps.project = new jsMind({ ...baseOptions, container: 'jsmind_container_project' });
            mindmaps.project.show(mindmapData.project);

            // 启用拖拽功能
            Object.values(mindmaps).forEach((mindmap, index) => {
                try {
                    if (typeof mindmap.enable_draggable_node === 'function') {
                        mindmap.enable_draggable_node();
                    }
                } catch (dragError) {
                }
            });
            
            // *** 关键修复：数据融合 - 确保jsMind节点与nodeDatabase同步 ***
            syncMindmapDataWithNodeDatabase();
            
            
            // 绑定节点选择事件
            bindNodeEvents();
        }
        
        // 数据融合函数：确保jsMind中的所有节点在nodeDatabase中都有对应记录
        function syncMindmapDataWithNodeDatabase() {
            
            let syncCount = 0;
            let newCount = 0;
            
            // 遍历所有思维导图
            Object.keys(mindmaps).forEach(mapId => {
                const mindmap = mindmaps[mapId];
                if (mindmap) {
                    
                    // 获取该脑图的数据
                    const mapData = mindmap.get_data();
                    if (mapData && mapData.data) {
                        // 递归遍历所有节点
                        traverseAndSyncNode(mapData.data);
                    }
                }
            });
            
            // 遍历节点并同步到nodeDatabase
            function traverseAndSyncNode(nodeData) {
                if (!nodeData || !nodeData.id) return;
                
                const nodeId = nodeData.id;
                const cleanTitle = nodeData.topic ? nodeData.topic.replace(' 📄', '') : '未命名节点';
                
                // 检查nodeDatabase中是否存在该节点
                if (!nodeDatabase[nodeId]) {
                    // 创建新的节点记录
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: cleanTitle,
                        content: '',
                        sessions: [], // 新增会话数据
                        author: projectInfo.author || 'NodeMind',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        tags: { categories: [], technical: [], status: [] }
                    };
                    newCount++;
                } else {
                    // 确保现有节点数据结构完整
                    const existingNode = nodeDatabase[nodeId];
                    
                    // 更新标题（如果节点标题在脑图中被修改）
                    if (existingNode.title !== cleanTitle) {
                        existingNode.title = cleanTitle;
                        existingNode.modified = new Date().toISOString();
                    }
                    
                    // 确保必要字段存在
                    if (!existingNode.sessions) existingNode.sessions = [];
                    if (!existingNode.tags) existingNode.tags = { categories: [], technical: [], status: [] };
                    if (!existingNode.author) existingNode.author = projectInfo.author || 'NodeMind';
                    if (!existingNode.created) existingNode.created = new Date().toISOString();
                    if (!existingNode.modified) existingNode.modified = new Date().toISOString();
                    
                    syncCount++;
                }
                
                // 递归处理子节点
                if (nodeData.children && Array.isArray(nodeData.children)) {
                    nodeData.children.forEach(childNode => {
                        traverseAndSyncNode(childNode);
                    });
                }
            }
            
            
            // 保存融合后的数据
            setTimeout(autoSaveData, 100);
        }
        
        // 绑定节点事件
        function bindNodeEvents() {
            
            Object.keys(mindmaps).forEach(mapId => {
                const mindmap = mindmaps[mapId];
                if (mindmap) {
                    // 绑定节点选择事件  
                    mindmap.add_event_listener(function(type, data) {
                        // 兼容不同版本的事件类型
                        if (type === 'select' || type === 1 || (jsMind.event_type && type === jsMind.event_type.select)) {
                            handleNodeSelect(data.node, mapId);
                        } else if (type === 'edit' || type === 2 || (jsMind.event_type && type === jsMind.event_type.edit)) {
                            handleNodeEdit(data.node, mapId);
                        }
                    });
                } else {
                }
            });
            
            
            // 备用方案：直接绑定 DOM 点击事件
            setTimeout(() => {
                const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.addEventListener('click', function(e) {
                            
                            // 查找被点击的节点（支持多种节点元素）
                            let nodeElement = e.target.closest('jmnode');
                            if (!nodeElement) {
                                nodeElement = e.target.closest('[nodeid]');
                            }
                            if (!nodeElement && e.target.hasAttribute('nodeid')) {
                                nodeElement = e.target;
                            }
                            
                            if (nodeElement) {
                                const nodeId = nodeElement.getAttribute('nodeid');
                                const mapId = containerId.replace('jsmind_container_', '');
                                const mindmap = mindmaps[mapId];
                                
                                
                                if (mindmap && nodeId) {
                                    const node = mindmap.get_node(nodeId);
                                    if (node) {
                                        handleNodeSelect(node, mapId);
                                    } else {
                                    }
                                } else {
                                }
                            } else {
                            }
                        });
                    } else {
                    }
                });
                
                // 额外的全局点击监听器
                document.addEventListener('click', function(e) {
                    // 检查是否点击了jsmind节点
                    if (e.target.tagName === 'jmnode' || e.target.closest('jmnode')) {
                        
                        let nodeElement = e.target.tagName === 'jmnode' ? e.target : e.target.closest('jmnode');
                        const nodeId = nodeElement.getAttribute('nodeid');
                        
                        if (nodeId) {
                            
                            // 查找对应的思维导图
                            let mapId = null;
                            const containers = ['workspace', 'knowledge', 'project'];
                            
                            for (const containerId of containers) {
                                const container = document.getElementById(`jsmind_container_${containerId}`);
                                if (container && container.contains(nodeElement)) {
                                    mapId = containerId;
                                    break;
                                }
                            }
                            
                            if (mapId && mindmaps[mapId]) {
                                const node = mindmaps[mapId].get_node(nodeId);
                                if (node) {
                                    handleNodeSelect(node, mapId);
                                }
                            }
                        }
                    }
                });
                
            }, 1000);
        }
        
        // 处理节点选择
        function handleNodeSelect(node, mapId) {
            if (!node) {
                return;
            }
            
            
            // 设置全局变量
            selectedNodeId = node.id;
            currentMindmap = mapId;
            
            // 确保全局变量被正确设置
            window.selectedNodeId = node.id;
            window.currentMindmap = mapId;
            
            
            // 添加视觉反馈：高亮显示选中的节点
            try {
                highlightSelectedNode(node.id, mapId);
            } catch (error) {
            }
            
            // 更新状态显示
            const statusElement = document.getElementById('selectedNode');
            if (statusElement) {
                statusElement.textContent = node.topic || '无';
            }
            
            // === 会话系统集成 ===
            // 更新会话列表显示当前节点的会话
            try {
                updateSessionsList(node.id);
            } catch (error) {
            }
            
            // 显示节点详细信息
            try {
                showNodeDetails(node);
            } catch (error) {
            }
            
        }
        
        // 高亮显示选中的节点（简化版，无动画）
        function highlightSelectedNode(nodeId, mapId) {
            // 移除之前的高亮
            document.querySelectorAll('.jmnode-selected').forEach(el => {
                el.classList.remove('jmnode-selected');
            });
            
            // 高亮当前选中的节点（仅静态高亮，无动画）
            const container = document.getElementById(`jsmind_container_${mapId}`);
            if (container) {
                const nodeElement = container.querySelector(`jmnode[nodeid="${nodeId}"]`);
                if (nodeElement) {
                    nodeElement.classList.add('jmnode-selected');
                }
            }
        }
        
        // 显示节点选择反馈动画（已禁用）
        function showNodeSelectionFeedback(node) {
            // 功能已禁用 - 不显示节点选择反馈动画
            return;
        }
        
        // 简化的节点编辑处理 - 使用MD直存逻辑
        async function handleNodeEdit(node, mapId) {
            if (!node) return;
            
            
            // 获取纯净的标题
            const cleanTitle = node.topic.replace(' 📄', '');
            
            // 立即更新nodeDatabase（确保数据持久化）
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            } else {
                nodeDatabase[node.id].title = cleanTitle;
                nodeDatabase[node.id].modified = new Date().toISOString();
            }
            
            // 同步更新四组件数据
            if (!fourComponentNodeState.nodeData[node.id]) {
                fourComponentNodeState.nodeData[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: nodeDatabase[node.id].content || '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            } else {
                fourComponentNodeState.nodeData[node.id].title = cleanTitle;
                fourComponentNodeState.nodeData[node.id].updateTime = new Date().toLocaleString('zh-CN');
            }
            
            // 立即保存到localStorage
            saveFourComponentData();
            autoSaveData();
            
            // 使用MD直存服务的简洁逻辑（异步处理）
            try {
                const service = await initMDDirectService();
                
                // 构造MD格式内容
                const existingData = nodeDatabase[node.id];
                const mdContent = `# ${cleanTitle}\n\n${existingData?.content || ''}`;
                
                // 使用MD直存逻辑更新
                const result = await service.addMDContent(mdContent, {
                    nodeId: node.id,
                    updateExisting: true
                });
                
                if (result.success) {
                }
            } catch (error) {
                console.error('❌ MD直存同步失败:', error);
                // 数据已经保存到nodeDatabase，不影响持久化
            }
            
            // 如果当前正在显示该节点，刷新显示
            if (selectedNodeId === node.id || fourComponentNodeState.currentNode === node.id) {
                updateFourComponentsForNode(node.id);
            }
            
            // 关键修复：立即更新思维导图显示
            const mindmap = mindmaps[mapId];
            if (mindmap) {
                // 检查节点是否有内容，决定是否显示内容图标
                const hasContent = nodeDatabase[node.id].content && nodeDatabase[node.id].content.trim().length > 0;
                const displayTitle = hasContent ? `${cleanTitle} 📄` : cleanTitle;
                
                // 更新思维导图中的节点显示
                mindmap.update_node(node.id, displayTitle);
            }
        }
        
        // 简化的节点详情显示 - 使用MD直存逻辑
        async function showNodeDetails(node) {
            if (!node) {
                return;
            }
            
            
            // 简化的当前内容保存 - 使用MD直存逻辑
            const currentNodeId = fourComponentNodeState.currentNode;
            if (currentNodeId && currentNodeId !== node.id) {
                await saveCurrentNodeContentViaMD(currentNodeId);
            }
            
            // 获取纯净的标题
            const cleanTitle = node.topic.replace(' 📄', '');
            
            // 确保节点数据存在（使用简化逻辑）
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            } else {
                // 同步标题
                nodeDatabase[node.id].title = cleanTitle;
            }
            
            // 🔥 关键修复：设置当前节点ID
            fourComponentNodeState.currentNode = node.id;
            
            // 切换到节点信息标签页
            switchToDetailTab();
            
            // 更新四组件显示
            updateFourComponentsForNode(node.id);
        }
        
        // 第三次重构：简化节点内容保存
        async function saveCurrentNodeContentViaMD(nodeId) {
            if (!nodeId) return;
            
            
            try {
                const contentEditor = document.getElementById('content-editor');
                
                if (contentEditor && nodeDatabase[nodeId]) {
                    nodeDatabase[nodeId].content = contentEditor.value || '';
                    nodeDatabase[nodeId].modified = new Date().toISOString();
                    
                    // 保存到localStorage
                    localStorage.setItem('nodemind_node_database', JSON.stringify(nodeDatabase));
                    
                }
            } catch (error) {
                console.error('❌ [第三次重构] 节点保存失败:', error);
            }
        }
        
        // 清理其他标签页的内容，防止内容混淆
        function clearOtherTabContents() {
            // 不再重置injection内容，因为它现在是节点信息页面
            
            // 重置项目信息标签页内容（保持校准功能）
            const projectContent = document.getElementById('project-info-content');
            if (projectContent) {
                projectContent.innerHTML = `
                    <div class="basic-info-panel">
                        <h4>📋 项目基本信息</h4>
                        <div class="project-buttons">
                            <button class="calibrate-btn" onclick="performCalibration()">校准</button>
                        </div>
                        <div class="info-item">
                            <label>项目名称:</label>
                            <span id="project-name-display">NodeMind 思维导图</span>
                        </div>
                        <div class="info-item">
                            <label>项目路径:</label>
                            <span id="project-path-display">未设置</span>
                        </div>
                        <div class="info-item">
                            <label>版本:</label>
                            <span>1.0.0</span>
                        </div>
                        <div class="info-item">
                            <label>作者:</label>
                            <span>NodeMind Team</span>
                        </div>
                        <div class="info-item">
                            <label>描述:</label>
                            <span>基于jsMind的思维导图应用</span>
                        </div>
                        <div class="calibration-info" id="calibration-info" style="display: none;">
                            <div class="info-item">
                                <label>应用名称:</label>
                                <span id="app-name-display">-</span>
                            </div>
                            <div class="info-item">
                                <label>状态:</label>
                                <span id="calibration-status" class="status-uncalibrated">未校准</span>
                            </div>
                            <div class="info-item">
                                <label>输入框坐标:</label>
                                <span id="input-coordinates">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="node-info-panel">
                        <h4>📝 当前节点信息</h4>
                        <div class="info-item">
                            <label>节点作者:</label>
                            <input type="text" id="project-node-author" class="meta-input" 
                                   value="" placeholder="输入作者信息">
                        </div>
                    </div>
                `;
                // 重新初始化项目信息
                initProjectInfo();
            }
        }
        
        // 切换到节点信息标签页
        function switchToDetailTab() {
            switchDetailTab('injection');
        }
        
        // 切换详情面板标签页（改进版本，添加更严格的检查和动画效果）
        function switchDetailTab(tabId) {
            
            // 移除了切换动画提示
            
            // 移除所有详情面板标签页的active状态
            document.querySelectorAll('.details-panel .tab-button').forEach(btn => {
                btn.classList.remove('active');
                // 移除之前的高亮效果
                btn.style.transform = '';
                btn.style.boxShadow = '';
            });
            
            document.querySelectorAll('.details-panel .tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none'; // 强制隐藏
            });
            
            // 激活指定的标签页
            const tabButton = document.getElementById(`detail_tab_${tabId}`);
            const tabContent = document.getElementById(`tab-${tabId}`);
            
            if (tabButton && tabContent) {
                tabButton.classList.add('active');
                tabContent.classList.add('active');
                tabContent.style.display = 'block'; // 强制显示
                
                // 移除了按钮闪烁效果
                
                
                // 确保切换后内容正确显示
                setTimeout(() => {
                    // 清理任何可能残留的表单内容
                    clearNodeFormFromTab(tabContent);
                    
                    // 如果是节点信息标签页，确保四组件正确初始化
                    if (tabId === 'injection') {
                        initializeFourComponents();
                        
                        // 如果有当前选中的节点，立即更新
                        if (selectedNodeId) {
                            updateFourComponentsForNode(selectedNodeId);
                        }
                    }
                }, 100);
            } else {
            }
        }
        
        // 显示标签页切换反馈（已禁用）
        function showTabSwitchFeedback(tabId) {
            // 功能已禁用 - 不显示标签页切换反馈
            return;
        }
        
        // 从指定标签页清理节点表单内容（防止内容泄露到其他标签页）
        function clearNodeFormFromTab(tabElement) {
            if (!tabElement) return;
            
            const forms = tabElement.querySelectorAll('.node-detail-form');
            forms.forEach(form => {
                if (tabElement.id !== 'tab-injection') {
                    // 如果不是节点信息标签页，移除任何节点表单
                    form.remove();
                }
            });
        }
        
        // 更新节点标题
        function updateNodeTitle(nodeId, title) {
            if (nodeDatabase[nodeId]) {
                nodeDatabase[nodeId].title = title;
                nodeDatabase[nodeId].modified = new Date().toISOString();
                
                // 同步更新思维导图显示
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const node = currentMindmapInstance.get_node(nodeId);
                    if (node) {
                        // 保持内容图标
                        const hasContent = nodeDatabase[nodeId].content && nodeDatabase[nodeId].content.trim().length > 0;
                        const displayTitle = hasContent ? `${title} 📄` : title;
                        currentMindmapInstance.update_node(nodeId, displayTitle);
                    }
                }
                
                // *** 添加自动保存 ***
                setTimeout(autoSaveData, 200);
            }
        }
        
        // 更新节点内容
        function updateNodeContent(nodeId, content) {
            
            // 确保节点数据存在
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: '未命名节点',
                    content: '',
                    sessions: [],
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            // 更新节点内容
            nodeDatabase[nodeId].content = content || '';
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            // 解析内容更新会话数据
            parseContentToSessions(nodeId, content);
            
            // 更新节点显示图标
            updateNodeContentIcon(nodeId, content);
            
            // 触发自动保存
            setTimeout(autoSaveData, 200);
            
        }
        
        // 从完整MD内容解析回会话数据
        function parseContentToSessions(nodeId, content) {
            initializeNodeSessions(nodeId);
            
            // *** 修复会话被意外清除的BUG ***
            if (!content || content.trim() === '') {
                // 🔒 保护现有会话：内容为空时不自动清空会话
                // 只有在明确的删除操作时才清空，而不是因为内容临时为空
                
                // 如果没有任何会话，就不需要做任何处理
                if (sessionDatabase[nodeId].sessions.length === 0) {
                    return;
                }
                
                // 保留现有会话，只重新渲染列表（不清空数据）
                const sessionListContainer = document.getElementById(`session-list-${nodeId}`);
                if (sessionListContainer) {
                    renderSessionList(nodeId);
                }
                
                return;
            }
            
            // 按标题分割内容
            const sections = content.split(/^# /m).filter(section => section.trim());
            const sessions = [];
            
            sections.forEach((section, index) => {
                const lines = section.trim().split('\n');
                const title = lines[0].trim();
                const sessionContent = lines.slice(1).join('\n').trim();
                
                // 查找现有会话或创建新会话
                let existingSession = sessionDatabase[nodeId].sessions.find(s => s.title === title);
                
                if (existingSession) {
                    // 更新现有会话
                    existingSession.content = sessionContent;
                    existingSession.lastModified = new Date().toISOString();
                    sessions.push(existingSession);
                } else {
                    // 创建新会话
                    const newSession = {
                        id: `session-${nodeId}-${Date.now()}-${index}`,
                        title: title,
                        content: sessionContent,
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };
                    sessions.push(newSession);
                }
            });
            
            // 更新会话数据
            sessionDatabase[nodeId].sessions = sessions;
            
            // 重新渲染会话列表
            const sessionListContainer = document.getElementById(`session-list-${nodeId}`);
            if (sessionListContainer) {
                renderSessionList(nodeId);
            }
            
            // 保存到本地存储
            saveSessionData();
        }
        
        // 更新节点作者
        function updateNodeAuthor(nodeId, author) {
            if (nodeDatabase[nodeId]) {
                nodeDatabase[nodeId].author = author;
                nodeDatabase[nodeId].modified = new Date().toISOString();
            }
        }
        
        // 更新节点内容图标
        function updateNodeContentIcon(nodeId, content) {
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                const node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    const hasContent = content && content.trim().length > 0;
                    const originalTopic = nodeDatabase[nodeId].title || node.topic;
                    const newTopic = hasContent ? `${originalTopic} 📄` : originalTopic.replace(' 📄', '');
                    
                    if (node.topic !== newTopic) {
                        currentMindmapInstance.update_node(nodeId, newTopic);
                    }
                }
            }
        }
        
        // 保存节点详情
        function saveNodeDetails(nodeId) {
            autoSaveData();
            showMessage('💾 节点详情已保存', 1500);
        }
        
        // 提交内容（根据问答模式决定：命令注入 OR 笔记保存）
        async function submitContent(nodeId) {
            
            // 获取内容编辑器
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容编辑器', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            
            // 获取节点信息
            const nodeData = nodeDatabase[nodeId] || {};
            const nodeTitle = (nodeData.title || `节点${nodeId}`).trim();
            
            // 🔑 检查问答模式状态
            const qaToggle = document.getElementById('qa-mode-toggle');
            const isQAMode = qaToggle && qaToggle.checked;
            
            
            if (!isQAMode) {
                // 📝 非问答模式：执行笔记保存
                
                if (!nodeTitle && !content) {
                    showMessage('❌ 请先输入标题或内容', 2000, 'error');
                    return;
                }
                
                // 保存节点数据
                autoSaveData();
                
                // 在内容末尾添加保存时间戳
                if (content && !content.includes('[已保存]')) {
                    const timestamp = new Date().toLocaleString();
                    const newContent = content + `\n[已保存 ${timestamp}]`;
                    contentEditor.value = newContent;
                    
                    // 保存到nodeDatabase
                    if (nodeDatabase[nodeId]) {
                        nodeDatabase[nodeId].content = newContent;
                    }
                    
                }
                
                // 显示保存成功消息
                showMessage('💾 笔记已保存', 2000, 'success');
                
                // 记录日志
                const logEntry = `${new Date().toLocaleString()} - 节点 "${nodeTitle}" 笔记已保存`;
                
                return; // 📝 笔记模式到此结束，不执行注入
            }
            
            // 🤖 问答模式：执行命令注入流程
            
            // 构建注入内容（标题+内容格式）
            let injectionContent = '';
            
            if (nodeTitle && content) {
                // 都存在：使用 "- 标题\n- 内容" 格式
                injectionContent = `- ${nodeTitle}\n- ${content}`;
            } else if (nodeTitle) {
                // 只有标题：直接使用标题
                injectionContent = nodeTitle;
            } else if (content) {
                // 只有内容：直接使用内容
                injectionContent = content;
            } else {
                // 都没有：提示错误
                showMessage('❌ 请先输入标题或内容', 2000, 'error');
                return;
            }
            
            try {
                // 获取提交按钮并立即更新状态
                const submitButton = document.querySelector(`button[onclick="submitContent('${nodeId}')"]`);
                const originalText = submitButton ? submitButton.textContent : '';
                
                if (submitButton) {
                    submitButton.textContent = '⏳ 准备注入...';
                    submitButton.disabled = true;
                }

                // 显示准备注入的提示
                showMessage('🎯 准备注入中，正在让出窗口焦点...', 2000, 'warning');
                
                // 延迟500ms后让浏览器失去焦点
                setTimeout(() => {
                    try {
                        // 让当前窗口失去焦点，为injection工具让路
                        window.blur();
                    } catch (e) {
                    }
                }, 500);

                // 延迟1.5秒后执行注入协议
                setTimeout(async () => {
                    try {
                        // 创建一键注入的JSON协议
                const injectionData = {
                    source: 'nodemind',
                    type: 'content-injection',
                    content: injectionContent,
                    direct_inject: true,  // 关键：标识为直接注入
                    timestamp: new Date().toISOString(),
                    nodeId: nodeId,
                    nodeTitle: nodeTitle,
                    projectName: 'NodeMind'
                };

                // 构建完整的剪贴板内容
                const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                        // 复制到剪贴板，触发injection工具
                await navigator.clipboard.writeText(clipboardContent);

                // 显示成功消息
                        showMessage('🎯 一键注入已触发！injection工具正在自动执行...', 3000, 'success');
                
                        // 更新按钮状态
                if (submitButton) {
                    submitButton.textContent = '✅ 注入已触发';
                    
                            // 3秒后恢复按钮
                    setTimeout(() => {
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                            }, 3000);
                }

                // 在内容末尾添加[已注入]标签
                if (content && !content.includes('[已注入]')) {
                    const newContent = content + '\n[已注入]';
                    contentEditor.value = newContent;
                    
                    // 保存到nodeDatabase
                    if (nodeDatabase[nodeId]) {
                        nodeDatabase[nodeId].content = newContent;
                    }
                    
                }

                
                // 记录到日志
                const logEntry = `${new Date().toLocaleString()} - 节点 "${nodeTitle}" 标题+内容已注入到Cursor`;

                    } catch (innerError) {
                        console.error('延迟注入失败:', innerError);
                        showMessage('❌ 延迟注入失败：' + innerError.message, 3000, 'error');
                        
                        // 恢复按钮状态
                        if (submitButton) {
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                        }
                    }
                }, 1500); // 延迟1.5秒执行

            } catch (error) {
                console.error('一键注入失败:', error);
                showMessage('❌ 一键注入失败：' + error.message, 3000, 'error');
                
                // 恢复按钮状态
                const submitButton = document.querySelector(`button[onclick="submitContent('${nodeId}')"]`);
                if (submitButton) {
                    submitButton.textContent = submitButton.textContent.includes('⏳') ? '提交' : submitButton.textContent;
                    submitButton.disabled = false;
                }
            }
        }
        
        // 切换问答模式
        function toggleQAMode(nodeId, isQAMode) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            const templateSection = document.getElementById(`template-section-${nodeId}`);
            
            if (!contentEditor) {
                console.error('找不到内容编辑器');
                return;
            }
            
            if (isQAMode) {
                // 开启问答模式
                contentEditor.placeholder = "AI交互，指令，提问，提示词输入区。一次问答或者指令-回复，算是一";
                contentEditor.style.color = "#6c757d";
                contentEditor.style.fontStyle = "italic";
                
                // 激活提示词模板
                if (templateSection) {
                    templateSection.style.opacity = "1";
                    templateSection.style.pointerEvents = "auto";
                    const templateItems = templateSection.querySelectorAll('.template-item');
                    templateItems.forEach(item => {
                        item.style.cursor = "pointer";
                        item.style.opacity = "1";
                    });
                }
                
                showMessage('🤖 问答模式已开启', 1500, 'success');
            } else {
                // 关闭问答模式
                contentEditor.placeholder = "在此输入详细内容...";
                contentEditor.style.color = "";
                contentEditor.style.fontStyle = "";
                
                // 禁用提示词模板
                if (templateSection) {
                    templateSection.style.opacity = "0.5";
                    templateSection.style.pointerEvents = "none";
                    const templateItems = templateSection.querySelectorAll('.template-item');
                    templateItems.forEach(item => {
                        item.style.cursor = "not-allowed";
                        item.style.opacity = "0.5";
                    });
                }
                
                showMessage('📝 内容编辑模式已开启', 1500, 'success');
            }
        }
        
        // 拷贝内容框内容
        function copyContentFromEditor(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容框', 2000, 'error');
                return;
            }
            
            if (contentEditor.value.trim() === '') {
                showMessage('⚠️ 内容框为空，无内容可拷贝', 2000, 'warning');
                return;
            }
            
            try {
                // 使用现代API进行拷贝
                navigator.clipboard.writeText(contentEditor.value).then(() => {
                    showMessage('📋 内容已拷贝到剪贴板', 1500, 'success');
                }).catch(() => {
                    // 降级方案
                    contentEditor.select();
                    document.execCommand('copy');
                    showMessage('📋 内容已拷贝到剪贴板', 1500, 'success');
                });
            } catch (error) {
                showMessage('❌ 拷贝失败：' + error.message, 2000, 'error');
            }
        }
        
        // 粘贴到内容框
        function pasteContentToEditor(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容框', 2000, 'error');
                return;
            }
            
            try {
                // 使用现代API进行粘贴
                navigator.clipboard.readText().then(text => {
                    if (text.trim() === '') {
                        showMessage('⚠️ 剪贴板为空', 2000, 'warning');
                        return;
                    }
                    
                    contentEditor.value = text;
                    contentEditor.focus();
                    showMessage('📋 内容已粘贴', 1500, 'success');
                }).catch(() => {
                    // 如果没有权限，提示用户手动粘贴
                    contentEditor.focus();
                    showMessage('💡 请使用 Ctrl+V 手动粘贴', 2000, 'info');
                });
            } catch (error) {
                showMessage('❌ 粘贴失败：' + error.message, 2000, 'error');
            }
        }
        
        // === 会话管理系统 ===
        let sessionDatabase = {};
        
        // 会话数据结构
        function createSessionBlock(nodeId, content, type = 'note') {
            const sessionId = generateSessionId();
            const timestamp = new Date().toISOString();
            
            // 提取标题
            let title = '';
            if (type === 'note') {
                // 笔记模式：取前20个字符作为标题
                title = content.replace(/\n/g, ' ').substring(0, 20).trim();
                if (title.length < content.length) title += '...';
            } else if (type === 'interaction') {
                // 问答模式：提取问题作为标题
                const lines = content.split('\n');
                const questionLine = lines.find(line => line.trim().startsWith('Q:') || line.trim().startsWith('问:'));
                if (questionLine) {
                    title = questionLine.replace(/^(Q:|问:)\s*/, '').substring(0, 30).trim();
                    if (title.length < questionLine.length) title += '...';
                } else {
                    title = content.substring(0, 20).trim() + '...';
                }
            }
            
            // 提取标签（会话级标签来自标签组内的标签）
            const tags = extractTagsFromContent(content);
            
            return {
                id: sessionId,
                type: type,
                title: title || '未命名会话',
                content: content,
                timestamp: timestamp,
                modified: timestamp,
                tags: tags,
                isFavorited: false,
                nodeId: nodeId,
                metadata: {
                    author: projectInfo.author || 'NodeMind',
                    wordCount: content.length,
                    version: '1.0.0'
                }
            };
        }
        
        // 生成会话ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // 从内容中提取标签
        function extractTagsFromContent(content) {
            const tagRegex = /#([^\s#]+)/g;
            const tags = [];
            let match;
            
            while ((match = tagRegex.exec(content)) !== null) {
                const tag = match[1];
                if (!tags.includes(tag)) {
                    tags.push(tag);
                }
            }
            
            return tags;
        }
        
        // 初始化节点的会话容器
        function initializeNodeSessions(nodeId) {
            if (!sessionDatabase[nodeId]) {
                sessionDatabase[nodeId] = {
                    nodeId: nodeId,
                    sessions: [],
                    activeSessionId: null,
                    lastModified: new Date().toISOString()
                };
            }
        }
        
        // 添加会话到节点
        function addSessionToNode(nodeId, content, type = 'note') {
            
            initializeNodeSessions(nodeId);
            
            const sessionBlock = createSessionBlock(nodeId, content, type);
            sessionDatabase[nodeId].sessions.unshift(sessionBlock); // 新会话在前
            sessionDatabase[nodeId].lastModified = new Date().toISOString();
            
            // 自动设置为活跃会话
            sessionDatabase[nodeId].activeSessionId = sessionBlock.id;
            
            
            // 更新UI
            updateSessionsList(nodeId);
            saveSessionData();
            
            return sessionBlock;
        }
        
        // 获取节点的所有会话
        function getNodeSessions(nodeId) {
            initializeNodeSessions(nodeId);
            return sessionDatabase[nodeId].sessions || [];
        }
        
        // 获取活跃会话
        function getActiveSession(nodeId) {
            const nodeSessions = sessionDatabase[nodeId];
            if (!nodeSessions || !nodeSessions.activeSessionId) return null;
            
            return nodeSessions.sessions.find(s => s.id === nodeSessions.activeSessionId);
        }
        
        // 设置活跃会话
        function setActiveSession(nodeId, sessionId) {
            initializeNodeSessions(nodeId);
            sessionDatabase[nodeId].activeSessionId = sessionId;
            
            // 更新内容编辑器 - 显示完整会话信息
            const session = sessionDatabase[nodeId].sessions.find(s => s.id === sessionId);
            if (session) {
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    // 构建完整的会话信息显示
                    const sessionInfo = buildSessionDisplayContent(session);
                    contentEditor.value = sessionInfo;
                }
            }
            
            updateSessionsList(nodeId);
            saveSessionData();
        }
        
        // 构建会话显示内容（包含所有元信息）
        function buildSessionDisplayContent(session) {
            const lines = [];
            
            // 会话标题和类型
            const typeText = session.type === 'interaction' ? '问答会话' : '笔记会话';
            lines.push(`# ${session.title}`);
            lines.push('');
            
            // 元信息区域
            lines.push('## 📋 会话信息');
            lines.push(`**类型**: ${typeText} ${session.type === 'interaction' ? '🤖' : '📝'}`);
            lines.push(`**创建时间**: ${formatDetailedTime(session.timestamp)}`);
            lines.push(`**修改时间**: ${formatDetailedTime(session.modified)}`);
            lines.push(`**收藏状态**: ${session.isFavorited ? '⭐ 已收藏' : '☆ 未收藏'}`);
            lines.push(`**字数统计**: ${session.content.length} 字符`);
            
            // 标签信息
            if (session.tags && session.tags.length > 0) {
                lines.push(`**标签**: ${session.tags.map(tag => `#${tag}`).join(' ')}`);
            } else {
                lines.push(`**标签**: 无`);
            }
            
            // 作者信息
            if (session.metadata && session.metadata.author) {
                lines.push(`**作者**: ${session.metadata.author}`);
            }
            
            lines.push('');
            lines.push('---');
            lines.push('');
            
            // 会话内容
            lines.push('## 📝 会话内容');
            lines.push('');
            lines.push(session.content);
            
            return lines.join('\n');
        }
        
        // 格式化详细时间
        function formatDetailedTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // 更新会话列表UI
        function updateSessionsList(nodeId) {
            if (!nodeId) return;
            
            const sessionsContainer = document.querySelector('.sessions-container');
            if (!sessionsContainer) return;
            
            const sessions = getNodeSessions(nodeId);
            const activeSessionId = sessionDatabase[nodeId]?.activeSessionId;
            
            
            if (sessions.length === 0) {
                sessionsContainer.innerHTML = `
                    <div class="session-empty">
                        <div class="session-empty-icon">💭</div>
                        <div class="session-empty-text">暂无会话记录</div>
                        <div class="session-empty-hint">在内容编辑器中输入内容并提交后，会话将显示在这里</div>
                    </div>
                `;
                return;
            }
            
            // 按时间降序排列（最新的在前）
            const sortedSessions = [...sessions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sessionsContainer.innerHTML = sortedSessions.map(session => {
                const isActive = session.id === activeSessionId;
                const timeStr = formatSessionTime(session.timestamp);
                const typeIcon = session.type === 'interaction' ? '🤖' : '📝';
                const tagsHtml = session.tags && session.tags.length > 0 
                    ? `<div class="session-tags">${session.tags.map(tag => `<span class="session-tag">#${tag}</span>`).join('')}</div>`
                    : '';
                
                return `
                    <div class="session-item ${isActive ? 'active' : ''}" 
                         onclick="handleSessionClick('${session.id}', '${nodeId}')"
                         data-session-id="${session.id}">
                        <div class="session-header">
                            <div class="session-title">${typeIcon} ${session.title}</div>
                            <div class="session-actions">
                                <button class="session-favorite-btn" onclick="toggleSessionFavorite('${session.id}', '${nodeId}', event)" title="${session.isFavorited ? '取消收藏' : '收藏会话'}">${session.isFavorited ? '⭐' : '☆'}</button>
                                <button class="session-delete-btn" onclick="deleteSession('${session.id}', '${nodeId}', event)" title="删除会话">🗑️</button>
                            </div>
                        </div>
                        <div class="session-time">${timeStr}</div>
                        ${tagsHtml}
                    </div>
                `;
            }).join('');
        }
        
        // 格式化会话时间
        function formatSessionTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return '昨天 ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays < 7) {
                return diffDays + '天前';
            } else {
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
            }
        }
        
        // 处理会话点击
        function handleSessionClick(sessionId, nodeId) {
            setActiveSession(nodeId, sessionId);
        }
        
        // 切换会话收藏状态
        function toggleSessionFavorite(sessionId, nodeId, event) {
            if (event) event.stopPropagation();
            
            const nodeSessions = sessionDatabase[nodeId];
            if (!nodeSessions) return;
            
            const session = nodeSessions.sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            // 切换收藏状态
            session.isFavorited = !session.isFavorited;
            session.modified = new Date().toISOString();
            
            
            // 更新UI和保存数据
            updateSessionsList(nodeId);
            saveSessionData();
        }
        
        // 删除会话
        function deleteSession(sessionId, nodeId, event) {
            if (event) event.stopPropagation();
            
            if (!confirm('确定要删除这个会话吗？')) return;
            
            const nodeSessions = sessionDatabase[nodeId];
            if (!nodeSessions) return;
            
            const sessionIndex = nodeSessions.sessions.findIndex(s => s.id === sessionId);
            if (sessionIndex === -1) return;
            
            const session = nodeSessions.sessions[sessionIndex];
            nodeSessions.sessions.splice(sessionIndex, 1);
            
            // 如果删除的是活跃会话，清除活跃状态或切换到其他会话
            if (nodeSessions.activeSessionId === sessionId) {
                if (nodeSessions.sessions.length > 0) {
                    nodeSessions.activeSessionId = nodeSessions.sessions[0].id;
                    setActiveSession(nodeId, nodeSessions.sessions[0].id);
                } else {
                    nodeSessions.activeSessionId = null;
                    // 清空内容编辑器或显示节点原始内容
                    const contentEditor = document.getElementById('content-editor');
                    if (contentEditor && nodeDatabase[nodeId]) {
                        contentEditor.value = nodeDatabase[nodeId].content || '';
                    }
                }
            }
            
            updateSessionsList(nodeId);
            saveSessionData();
        }
        
        // 保存会话数据
        function saveSessionData() {
            try {
                localStorage.setItem(STORAGE_KEYS.SESSION_DATABASE, JSON.stringify(sessionDatabase));
            } catch (error) {
                console.error('❌ [会话系统] 保存会话数据失败:', error);
            }
        }
        
        // 加载会话数据
        function loadSessionData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEYS.SESSION_DATABASE);
                if (savedData) {
                    sessionDatabase = JSON.parse(savedData);
                } else {
                    sessionDatabase = {};
                }
            } catch (error) {
                console.error('❌ [会话系统] 加载会话数据失败:', error);
                sessionDatabase = {};
            }
        }
        
        // 页面加载时初始化会话数据
        document.addEventListener('DOMContentLoaded', function() {
            loadSessionData();
        });
        
        // === UI分割器功能已模块化到 Splitter 组件 ===
        
        // === 右侧面板分割器功能已模块化到 Splitter 组件 ===
        
        // 更新项目信息页面的节点作者信息
        function updateProjectInfoNodeAuthor(authorValue) {
            const authorInput = document.getElementById('project-node-author');
            if (authorInput) {
                authorInput.value = authorValue || '';
            }
        }
        
        // 从项目信息页面更新当前节点的作者信息
        function updateCurrentNodeAuthor(authorValue) {
            if (selectedNodeId) {
                updateNodeAuthor(selectedNodeId, authorValue);
            }
        }
        
        // === 校准功能模块 - 独立模块，不影响其他功能 ===
        
        // 模板管理系统 - 基于文档设计
        var templateManager = {
            templates: {
                '自然模式': {
                    versions: [
                        {
                            name: '默认模板',
                            prefix: '你好，我需要你的帮助。',
                            suffix: '请详细回答，谢谢。'
                        },
                        {
                            name: '友好模式',
                            prefix: '希望能得到你的专业建议：',
                            suffix: '非常感谢你的帮助！'
                        }
                    ]
                },
                '技术模式': {
                    versions: [
                        {
                            name: '代码分析',
                            prefix: '请分析以下技术问题：',
                            suffix: '请提供具体的解决方案和代码示例。'
                        },
                        {
                            name: '架构设计',
                            prefix: '需要进行系统架构设计：',
                            suffix: '请考虑可扩展性和性能优化。'
                        }
                    ]
                },
                '创意模式': {
                    versions: [
                        {
                            name: '头脑风暴',
                            prefix: '让我们一起思考创新方案：',
                            suffix: '期待听到你的创意想法！'
                        },
                        {
                            name: '方案优化',
                            prefix: '当前方案需要改进：',
                            suffix: '请提供多个优化建议。'
                        }
                    ]
                }
            },
            currentScene: '',
            currentVersion: '',
            
            getScenes: function() {
                return Object.keys(this.templates);
            },
            
            getVersions: function(scene) {
                if (scene && this.templates[scene]) {
                    return this.templates[scene].versions.map(v => v.name);
                }
                return [];
            },
            
            getTemplate: function(scene, version) {
                if (scene && version && this.templates[scene]) {
                    return this.templates[scene].versions.find(v => v.name === version);
                }
                return null;
            }
        };
        
        // === 校准系统 - 基于injection工具完整实现 ===
        
        function performCalibration() {
            alert('校准功能暂时不可用');
        }
        
        // === 命令注入功能已模块化到 InjectionService ===
        
        // === 模板管理功能已模块化到 TemplateService ===
        
        // === openTemplateManager 函数已模块化到 TemplateService ===

        // 初始化模板管理器内容
        function initializeTemplateManagerContent() {
            try {
                const modalBody = document.querySelector('#template-manager-container .modal-body');
                if (!modalBody) return;

                // 尝试使用完整模板管理器系统
                if (typeof window.TemplateManagerEntry !== 'undefined') {
                    window.TemplateManagerEntry.initialize();
                } else {
                    // 基于injection提示词模板系统的卡片式模板列表
                    modalBody.innerHTML = `
                        <div style="padding: 20px;">
                            <!-- 新增模板按键 -->
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button onclick="addNewTemplate()" class="add-template-btn" style="padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s ease;">
                                    ➕ 新增模板
                                </button>
                            </div>
                            
                            <!-- 模块化强制说明 -->
                            <div style="margin-bottom: 20px; padding: 12px; background: linear-gradient(90deg, #e8f5e8, #f0f8f0); border-left: 4px solid #28a745; border-radius: 6px;">
                                <h4 style="margin: 0 0 8px 0; color: #155724; font-size: 16px;">🏗️ 模块化强制约束</h4>
                                <p style="margin: 0; color: #155724; font-size: 14px; line-height: 1.4;">
                                    <strong>所有模板都自动包含模块化开发规范！</strong><br>
                                    无需单独选择，每个模板使用时都会强制添加模块化约束前缀和检查清单后缀。
                                </p>
                            </div>
                            
                            <!-- 模板分类标签 -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #495057; font-size: 18px;">📋 模板分类标签：</h4>
                                <div id="template-filter-tags" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <button class="filter-tag active" data-category="all" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        🏷️ 全部
                                    </button>
                                    <button class="filter-tag" data-category="natural" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        🗣️ 自然模式
                                    </button>
                                    <button class="filter-tag" data-category="code" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        💻 代码类
                                    </button>
                                    <button class="filter-tag" data-category="log" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        📝 日志类
                                    </button>
                                    <button class="filter-tag" data-category="feature" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        ✨ 新功能类
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 模板卡片容器 -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                
                                <!-- 自然模式 -->
                                <div class="template-card" data-category="natural" data-template-id="自然模式" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">🗣️ 自然模式</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('自然模式'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('自然模式'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('自然模式'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">常规对话模式，指向项目日志文档</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>"日志"一般是指{项目名称}-log.md文档
                                    </div>
                                </div>

                                <!-- 代码自查 -->
                                <div class="template-card" data-category="code" data-template-id="代码自查" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">🔍 代码自查</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('代码自查'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('代码自查'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('代码自查'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">代码质量检查和问题排查</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>主要功能点，是否有重复的实现逻辑，路径错误检查...
                                    </div>
                                </div>

                                <!-- 修改代码 -->
                                <div class="template-card" data-category="code" data-template-id="修改代码" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">⚡ 修改代码</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">包含完整的代码外科手术协议</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>后缀：</strong>【代码修改外科手术协议】⚡️ 严谨的代码外科医生规范...
                                    </div>
                                </div>

                                <!-- 不生效 -->
                                <div class="template-card" data-category="code" data-template-id="不生效" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('不生效')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">❌ 不生效</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">代码修改不生效问题诊断</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>后缀：</strong>修改代码没有生效的6个常见原因分析...
                                    </div>
                                </div>

                                <!-- 日志-修改代码 -->
                                <div class="template-card" data-category="log" data-template-id="日志-修改代码" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('日志-修改代码')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">📝 日志-修改代码</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('日志-修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('日志-修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('日志-修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">结合代码外科手术协议和工作日志记录</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>功能：</strong>修改规范 + 日志格式要求
                                    </div>
                                </div>

                                <!-- 日志-不生效 -->
                                <div class="template-card" data-category="log" data-template-id="日志-不生效" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('日志-不生效')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">📋 日志-不生效</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('日志-不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('日志-不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('日志-不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">结合代码不生效诊断和工作日志记录</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>功能：</strong>问题诊断 + 日志记录
                                    </div>
                                </div>

                                <!-- 日志-新功能 -->
                                <div class="template-card" data-category="log" data-template-id="日志-新功能" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('日志-新功能')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">🚀 日志-新功能</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('日志-新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('日志-新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('日志-新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">最小化代码实现原则，新功能开发</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>认真回答问题<br>
                                        <strong>后缀：</strong>遵循最小化代码实现原则
                                    </div>
                                </div>

                                <!-- 新功能 -->
                                <div class="template-card" data-category="feature" data-template-id="新功能" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('新功能')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">✨ 新功能</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">遵循最小化代码实现原则的新功能开发</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>遵循最小化代码实现原则。不得任意增加指令以外的功能
                                    </div>
                                </div>

                            </div>
                            
                            <!-- 底部功能区 -->
                            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e9ecef; text-align: center;">
                                <p style="margin: 0 0 8px 0; color: #6c757d; font-size: 14px;">💡 基于injection提示词模板系统 - 支持前缀/后缀模板和变量替换</p>
                                <p style="margin: 0 0 12px 0; color: #28a745; font-size: 13px; font-weight: 600;">🏗️ 所有模板自动包含强制模块化开发规范 - 确保代码架构一致性</p>
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button onclick="importTemplates()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">📥 导入模板</button>
                                    <button onclick="exportTemplates()" style="padding: 8px 16px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer;">📤 导出模板</button>
                                    <button onclick="initializeTemplateManagerContent()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">🔄 刷新</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 样式已移至 assets/css/template-styles.css -->
                    `;
                }
            } catch (error) {
                console.error('❌ 模板管理器初始化失败:', error);
            }
        }

        // 绑定模板管理器事件
        function bindTemplateManagerEvents() {
            // 返回按键
            const backButton = document.getElementById('template_manager_back_button');
            if (backButton) {
                backButton.onclick = closeTemplateManager;
            }

            // 关闭按键
            const closeButton = document.getElementById('template_manager_close_button');
            if (closeButton) {
                closeButton.onclick = closeTemplateManager;
            }

            // 背景点击关闭
            const backdrop = document.getElementById('template_manager_backdrop');
            if (backdrop) {
                backdrop.onclick = closeTemplateManager;
            }

            // ESC键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const container = document.getElementById('template-manager-container');
                    const editModal = document.getElementById('template-edit-modal');
                    
                    if (editModal && editModal.style.display !== 'none') {
                        closeTemplateEditModal();
                    } else if (container && container.style.display !== 'none') {
                        closeTemplateManager();
                    }
                }
            });
        }

        // 关闭模板管理器
        function closeTemplateManager() {
            const templateManagerContainer = document.getElementById('template-manager-container');
            if (templateManagerContainer) {
                templateManagerContainer.style.display = 'none';
            }
        }

        // 全局变量存储模板数据  
        // let selectedTemplates = []; // 已迁移到模板选择服务中管理
        
        // 全局强制模块化前缀 - 所有模板都将自动包含此约束
        const GLOBAL_MODULAR_PREFIX = `🏗️ 【NodeMind强制模块化开发规范】

📋 **项目架构要求**：
- 项目已完成模块化解耦，必须严格遵循既定架构
- 禁止在index.html中添加内联JavaScript代码
- 所有新功能必须放入对应的模块文件中

📁 **模块化目录结构**：
\`\`\`
src/
├── services/          # 业务逻辑服务层
│   ├── mindmap_service.js    # 思维导图核心服务
│   ├── node_service.js       # 节点管理服务
│   ├── tag_service.js        # 标签管理服务
│   ├── storage_service.js    # 数据存储服务
│   ├── project_service.js    # 项目信息服务
│   └── template_service.js   # 模板管理服务
├── controllers/       # 控制器层
│   ├── ui_controller.js      # UI控制器
│   └── context_menu_controller.js # 菜单控制器
├── ui/components/     # UI组件层
│   ├── node_details_ui.js    # 节点详情组件
│   ├── project_info_ui.js    # 项目信息组件
│   └── md_browser_ui.js      # MD浏览器组件
├── utils/             # 工具层
│   └── utils.js              # 通用工具函数
├── event_bus.js       # 事件总线（统一通信）
├── state.js          # 状态管理
└── app.js            # 应用入口
\`\`\`

⚡ **强制要求**：
1. **新功能模块归属**：明确指定功能应放入哪个具体模块文件
2. **避免重复实现**：检查现有模块，复用已有功能，删除重复代码
3. **事件总线通信**：模块间通信必须使用src/event_bus.js
4. **统一工具函数**：使用src/utils/utils.js中的showMessage等函数
5. **状态管理集中**：使用src/services/state.js管理应用状态

🚫 **严禁行为**：
- ❌ 在index.html中写内联JavaScript
- ❌ 创建重复的工具函数（如showMessage）
- ❌ 绕过模块化直接操作DOM
- ❌ 忽略现有的服务层接口

📝 **代码实现要求**：

`;

        // 全局强制模块化后缀 - 所有模板都将自动包含此检查清单
        const GLOBAL_MODULAR_SUFFIX = `

🔍 **模块化检查清单**：
- [ ] 功能已放入正确的模块文件
- [ ] 使用了统一的事件总线通信
- [ ] 复用了现有的工具函数
- [ ] 遵循了单一职责原则
- [ ] 避免了代码重复
- [ ] 更新了相关的导入导出

📋 **变更报告格式**：
\`\`\`diff
# 模块化变更报告
## 修改文件：src/services/[模块名].js
+ 新增功能：[具体功能描述]
+ 复用组件：[使用的现有模块]
+ 事件通信：[使用的事件类型]
## 架构合规性：✅ 完全符合模块化规范
\`\`\`

⚠️ **重要提醒**：本项目已完成模块化架构，任何违反模块化原则的代码都将导致架构退化，必须严格遵循以上规范！`;

        window.templateData = {
            '自然模式': {
                name: '🗣️ 自然模式',
                description: '常规对话模式，专注项目日志文档记录',
                category: 'natural',
                prefix: `📋 **工作日志模式**：
- 当前项目的"日志"特指：{项目名称}-log.md 文档
- 请基于项目上下文进行对话，参考已有的工作记录
- 优先查阅现有日志内容，保持工作连续性`,
                suffix: `
💡 **记录要求**：
- 如有重要发现或决策，建议记录到项目日志中
- 保持工作记录的完整性和可追溯性`
            },
            '代码自查': {
                name: '🔍 代码自查',
                description: '系统性代码质量检查和问题排查',
                category: 'code',
                prefix: `🔍 **代码质量自查清单**：
1. **功能完整性**：检查主要功能点是否完整实现
2. **逻辑重复**：识别重复的实现逻辑，提出合并建议  
3. **路径正确性**：验证文件路径、导入路径的准确性
4. **依赖关系**：检查模块间依赖是否合理
5. **性能问题**：识别潜在的性能瓶颈
6. **安全隐患**：检查常见的安全问题`,
                suffix: `
📊 **输出格式**：
- ✅ 正常项目：列出检查通过的项目
- ⚠️ 需要注意：列出潜在风险点
- ❌ 严重问题：列出必须修复的问题
- 💡 优化建议：提供具体的改进方案`
            },
            '修改代码': {
                name: '⚡ 修改代码',
                description: '遵循代码外科手术协议的精确修改',
                category: 'code',
                prefix: `⚡ **代码外科手术协议启动**：
1. **术前诊断**：详细分析现有代码结构和问题根因
2. **手术方案**：制定最小化影响的修改策略
3. **风险评估**：识别修改可能影响的其他模块
4. **备份检查**：确认重要代码的备份和回滚方案`,
                suffix: `
🏥 **代码外科手术协议**：
- **精准定位**：只修改必要的代码行，避免大范围改动
- **影响评估**：说明修改对其他模块的潜在影响
- **测试策略**：提供验证修改正确性的测试方法
- **回滚方案**：如修改出现问题，提供快速回滚步骤
- **文档更新**：同步更新相关注释和文档

⚠️ **严谨原则**：宁可多次小修改，也不要一次大改动！`
            },
            '不生效': {
                name: '❌ 不生效',
                description: '代码修改不生效的系统性诊断',
                category: 'code',
                prefix: `❌ **代码不生效诊断启动**：
请按照以下6个维度系统排查问题：`,
                suffix: `
🔧 **代码不生效的6个常见原因**：
1. **缓存问题**：浏览器缓存、模块缓存未清理
2. **路径错误**：文件路径、导入路径不正确
3. **语法错误**：代码存在语法错误阻止执行
4. **作用域问题**：变量作用域、函数调用上下文错误
5. **异步问题**：异步代码执行时序问题
6. **依赖缺失**：缺少必要的依赖或模块未正确加载

🎯 **诊断步骤**：
- 检查浏览器控制台是否有错误信息
- 验证文件是否被正确加载
- 确认代码是否在正确的执行上下文中
- 检查相关依赖是否正常工作
- 使用断点或console.log确认代码执行流程`
            },
            '日志-修改代码': {
                name: '📝 日志-修改代码',
                description: '结合工作日志记录的代码修改流程',
                category: 'log',
                prefix: `📝 **日志记录 + 代码修改模式**：
- 将修改过程和结果详细记录到工作日志
- 遵循代码外科手术协议进行精确修改
- 确保修改的可追溯性和可回滚性`,
                suffix: `
📋 **日志记录格式**：
\`\`\`markdown
## 代码修改记录 - [时间]
### 修改目标：[具体要解决的问题]
### 修改文件：[涉及的文件列表]
### 修改内容：[具体的修改点]
### 测试验证：[验证修改正确性的方法]
### 影响评估：[对其他模块的影响]
### 备注：[其他重要信息]
\`\`\`

💡 **最佳实践**：每次修改都要记录，便于后续问题追溯`
            },
            '日志-不生效': {
                name: '📋 日志-不生效',
                description: '结合工作日志的问题诊断和解决记录',
                category: 'log',
                prefix: `📋 **问题诊断 + 日志记录模式**：
- 系统性诊断代码不生效的原因
- 详细记录排查过程和解决方案
- 建立问题解决的知识库`,
                suffix: `
📝 **问题诊断日志格式**：
\`\`\`markdown
## 问题诊断记录 - [时间]
### 问题描述：[具体的不生效现象]
### 排查过程：
1. [检查项1] - [结果]
2. [检查项2] - [结果]
3. [检查项3] - [结果]
### 根因分析：[问题的根本原因]
### 解决方案：[具体的解决步骤]
### 验证结果：[修复后的验证情况]
### 预防措施：[避免类似问题的建议]
\`\`\`

🎯 **经验积累**：每次解决的问题都是宝贵的经验财富`
            },
            '日志-新功能': {
                name: '🚀 日志-新功能',
                description: '遵循最小化原则的新功能开发记录',
                category: 'log',
                prefix: `🚀 **新功能开发 + 日志记录模式**：
- 遵循最小化代码实现原则
- 详细记录开发过程和设计决策
- 确保功能的可维护性和可扩展性`,
                suffix: `
📋 **新功能开发日志格式**：
\`\`\`markdown
## 新功能开发记录 - [时间]
### 功能需求：[具体的功能描述]
### 设计方案：[技术实现方案]
### 最小化原则：[如何遵循最小化实现]
### 开发进度：
- [x] [完成的任务]
- [ ] [待完成的任务]
### 测试计划：[功能验证方法]
### 文档更新：[相关文档的更新]
\`\`\`

⚡ **最小化原则**：只实现必要功能，避免过度设计`
            },
            '新功能': {
                name: '✨ 新功能',
                description: '严格遵循最小化原则的新功能开发',
                category: 'feature',
                prefix: `✨ **最小化新功能开发模式**：
- 严格遵循最小化代码实现原则
- 只实现用户明确要求的功能，不添加额外特性
- 优先使用现有组件和模块，避免重复造轮子
- 确保新功能与现有架构的兼容性`,
                suffix: `
🎯 **最小化实现检查清单**：
- [ ] 功能需求是否明确且必要
- [ ] 是否复用了现有的组件和服务
- [ ] 是否避免了不必要的复杂性
- [ ] 是否考虑了与现有功能的集成
- [ ] 是否提供了基本的错误处理
- [ ] 是否包含了必要的用户反馈

⚠️ **严格约束**：不得任意增加指令以外的功能，保持实现的精简和专注`
            }
        };

        let currentEditingTemplate = null;

        // 模板操作函数
        function addNewTemplate() {
            currentEditingTemplate = null;
            document.getElementById('template-edit-title').textContent = '📝 新增模板';
            document.getElementById('template-name-input').value = '';
            document.getElementById('template-category-select').value = 'natural';
            document.getElementById('template-prefix-input').value = '';
            document.getElementById('template-suffix-input').value = '';
            document.getElementById('template-description-input').value = '';
            document.getElementById('template-edit-modal').style.display = 'block';
        }

        // 旧的模板选择函数 - 已迁移到模板选择服务
        /*
        function toggleTemplateSelection(templateName) {
            // 已替换为 templateSelectionService.toggleSelection()
            // 保留此注释用于记录迁移
        }
        */

        function editTemplate(templateName) {
            const template = window.templateData[templateName];
            if (!template) {
                showMessage('模板不存在', 'error');
                return;
            }
            
            currentEditingTemplate = templateName;
            document.getElementById('template-edit-title').textContent = '📝 编辑模板';
            document.getElementById('template-name-input').value = template.name;
            document.getElementById('template-category-select').value = template.category;
            document.getElementById('template-prefix-input').value = template.prefix || '';
            document.getElementById('template-suffix-input').value = template.suffix || '';
            document.getElementById('template-description-input').value = template.description || '';
            document.getElementById('template-edit-modal').style.display = 'block';
        }

        function deleteTemplate(templateName) {
            const template = window.templateData[templateName];
            if (!template) {
                showMessage('模板不存在', 'error');
                return;
            }
            
            if (confirm(`确定要删除模板 "${template.name}" 吗？\n\n删除后将无法恢复！`)) {
                delete window.templateData[templateName];
                showMessage(`🗑️ 已删除模板: ${template.name}`, 2000);
                
                // 重新渲染模板列表
                setTimeout(() => {
                    initializeTemplateManagerContent();
                }, 100);
            }
        }

        function closeTemplateEditModal() {
            document.getElementById('template-edit-modal').style.display = 'none';
            currentEditingTemplate = null;
        }

        function saveTemplate() {
            const name = document.getElementById('template-name-input').value.trim();
            const category = document.getElementById('template-category-select').value;
            const prefix = document.getElementById('template-prefix-input').value.trim();
            const suffix = document.getElementById('template-suffix-input').value.trim();
            const description = document.getElementById('template-description-input').value.trim();
            
            if (!name) {
                showMessage('❌ 请输入模板名称', 'error');
                return;
            }
            
            // 如果是新增模板，生成唯一ID
            const templateId = currentEditingTemplate || `custom-${Date.now()}`;
            
            window.templateData[templateId] = {
                name: name,
                description: description,
                category: category,
                prefix: prefix,
                suffix: suffix
            };
            
            const isNew = !currentEditingTemplate;
            showMessage(isNew ? '✅ 模板已创建' : '✅ 模板已更新', 2000);
            
            closeTemplateEditModal();
            
            // 重新渲染模板列表
            setTimeout(() => {
                initializeTemplateManagerContent();
            }, 100);
        }

        function importTemplates() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (typeof importedData === 'object' && importedData !== null) {
                                window.templateData = { ...window.templateData, ...importedData };
                                showMessage('📥 模板导入成功', 2000);
                                initializeTemplateManagerContent();
                } else {
                                throw new Error('Invalid JSON structure');
                            }
                        } catch (error) {
                            showMessage('❌ 导入失败：文件格式错误', 'error');
                            console.error('导入错误:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportTemplates() {
            try {
                const dataStr = JSON.stringify(window.templateData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `templates_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showMessage('📤 模板已导出', 2000);
            } catch (error) {
                showMessage('❌ 导出失败', 'error');
                console.error('导出错误:', error);
            }
        }

        // 旧的模板列表更新函数 - 已迁移到模板选择服务
        /*
        function updateSelectedTemplatesList() {
            // 已替换为 templateSelectionService.updateDisplay()
            // 保留此注释用于记录迁移
        }
        */

        // 同步模板管理器中的选中状态显示
        function syncTemplateManagerSelection() {
            // 清除所有模板卡片的选中状态
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 为已选中的模板添加选中状态
            selectedTemplates.forEach(template => {
                const templateCard = document.querySelector(`[data-template-id="${template.id}"]`);
                if (templateCard) {
                    templateCard.classList.add('selected');
                }
            });
        }

        // 使用选中的模板
        function useSelectedTemplate(templateId) {
            const template = selectedTemplates.find(t => t.id === templateId);
            if (!template) {
                showMessage('模板不存在', 'error');
                return;
            }
            
            // 构造注入文本 - 强制包含全局模块化约束
            let injectionText = '';
            
            // 1. 全局模块化前缀（强制）
            injectionText += GLOBAL_MODULAR_PREFIX;
            
            // 2. 模板特定前缀
            if (template.prefix) {
                injectionText += template.prefix;
            }
            
            // 3. 分隔符（如果有内容）
            if (template.suffix) {
                injectionText += '\n\n';
            }
            
            // 4. 模板特定后缀
            if (template.suffix) {
                injectionText += template.suffix;
            }
            
            // 5. 全局模块化后缀（强制）
            injectionText += GLOBAL_MODULAR_SUFFIX;
            
            // 复制到剪贴板
            if (navigator.clipboard && injectionText.trim()) {
                navigator.clipboard.writeText(injectionText).then(() => {
                    showMessage('📋 模板内容已复制到剪贴板（含强制模块化约束）', 2000);
                }).catch(() => {
                });
            } else if (injectionText.trim()) {
                showMessage('模板内容已输出到控制台（含强制模块化约束）', 2000);
            }
            
        }

        // 移除选中的模板
        function removeSelectedTemplate(templateId) {
            const index = selectedTemplates.findIndex(t => t.id === templateId);
            if (index > -1) {
                const template = selectedTemplates[index];
                selectedTemplates.splice(index, 1);
                
                // 同步移除模板管理器中的选中状态
                const templateCard = document.querySelector(`[data-template-id="${templateId}"]`);
                if (templateCard) {
                    templateCard.classList.remove('selected');
                }
                
                showMessage(`🗑️ 已移除模板: ${template.name}`, 1500);
                updateSelectedTemplatesList();
            }
        }

        // 标签过滤功能
        let activeFilters = ['all']; // 当前激活的过滤器

        function toggleFilterTag(tagElement) {
            const category = tagElement.getAttribute('data-category');
            
            if (category === 'all') {
                // 点击"全部"标签
                if (!tagElement.classList.contains('active')) {
                    // 清除所有其他标签的激活状态
                    document.querySelectorAll('.filter-tag').forEach(tag => {
                        tag.classList.remove('active');
                        tag.style.background = '#f8f9fa';
                        tag.style.color = '#495057';
                        tag.style.borderColor = '#dee2e6';
                    });
                    
                    // 激活"全部"标签
                    tagElement.classList.add('active');
                    activeFilters = ['all'];
                    
                    // 显示所有模板
                    filterTemplates();
                    showMessage('🏷️ 显示全部模板', 1500);
                }
            } else {
                // 点击具体分类标签
                if (tagElement.classList.contains('active')) {
                    // 取消选择该标签
                    tagElement.classList.remove('active');
                    tagElement.style.background = '#f8f9fa';
                    tagElement.style.color = '#495057';
                    tagElement.style.borderColor = '#dee2e6';
                    
                    // 从激活过滤器中移除
                    activeFilters = activeFilters.filter(f => f !== category);
                    
                    // 如果没有任何标签激活，激活"全部"
                    if (activeFilters.length === 0 || activeFilters.includes('all')) {
                        const allTag = document.querySelector('.filter-tag[data-category="all"]');
                        allTag.classList.add('active');
                        activeFilters = ['all'];
                    }
                } else {
                    // 选择该标签
                    // 先取消"全部"标签
                    const allTag = document.querySelector('.filter-tag[data-category="all"]');
                    if (allTag.classList.contains('active')) {
                        allTag.classList.remove('active');
                        allTag.style.background = '#f8f9fa';
                        allTag.style.color = '#495057';
                        allTag.style.borderColor = '#dee2e6';
                        activeFilters = [];
                    }
                    
                    // 激活当前标签
                    tagElement.classList.add('active');
                    activeFilters.push(category);
                }
                
                filterTemplates();
                showMessage(`🏷️ 已选择: ${getFilterDisplayNames()}`, 1500);
            }
        }

        function filterTemplates() {
            const allCards = document.querySelectorAll('.template-card');
            
            allCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                
                if (activeFilters.includes('all') || activeFilters.includes(cardCategory)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        function getFilterDisplayNames() {
            const nameMap = {
                'all': '全部',
                'natural': '自然模式',
                'code': '代码类',
                'log': '日志类',
                'feature': '新功能类'
            };
            
            return activeFilters.map(f => nameMap[f]).join(', ');
        }

        // 获取当前活跃的jsMind实例
        function getCurrentJsMind() {
            return mindmaps[currentMindmap];
        }

        // 切换思维导图标签页
        function switchMindmapTab(mapId) {
            
            // 隐藏所有容器和标签内容
            ['workspace', 'knowledge', 'project'].forEach(id => {
                const container = document.getElementById(`jsmind_container_${id}`);
                const tabContent = document.getElementById(`mindmap-tab-${id}`);
                if (container) container.style.display = 'none';
                if (tabContent) {
                    tabContent.style.display = 'none';
                    tabContent.classList.remove('active');
                }
            });
            
            // 显示目标容器和标签内容
            const targetContainer = document.getElementById(`jsmind_container_${mapId}`);
            const targetTabContent = document.getElementById(`mindmap-tab-${mapId}`);
            if (targetContainer && targetTabContent) {
                targetContainer.style.display = 'block';
                targetTabContent.style.display = 'block';
                targetTabContent.classList.add('active');
                
                // 调整思维导图大小并重新布局
                const instance = mindmaps[mapId];
                if (instance) {
                    setTimeout(() => {
                        instance.resize();
                        // 对于标签管理，强制重新显示以修复布局问题
                        if (mapId === 'workspace') {
                            instance.show(mindmapData.workspace);
                        }
                    }, 100);
                }
            }
            
            // 更新标签UI
            document.querySelectorAll('.mindmap-tab-button').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`[data-tab="${mapId}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            currentMindmap = mapId;
        }

        // 自动保存数据
        function autoSaveData() {
            try {
                // 保存思维导图数据
                const mindmapDataToSave = {
                    workspace: mindmaps.workspace ? mindmaps.workspace.get_data() : mindmapData.workspace,
                    knowledge: mindmaps.knowledge ? mindmaps.knowledge.get_data() : mindmapData.knowledge,
                    project: mindmaps.project ? mindmaps.project.get_data() : mindmapData.project
                };
                
                localStorage.setItem(STORAGE_KEYS.MINDMAP_DATA, JSON.stringify(mindmapDataToSave));
                localStorage.setItem(STORAGE_KEYS.NODE_DATABASE, JSON.stringify(nodeDatabase));
                localStorage.setItem(STORAGE_KEYS.PROJECT_INFO, JSON.stringify(projectInfo));
                localStorage.setItem(STORAGE_KEYS.SELECTED_NODE, selectedNodeId || '');
                
                // *** 关键修复：同时保存会话数据 ***
                localStorage.setItem('nodemind_sessions', JSON.stringify(sessionDatabase));
                
                // 保存四组件数据
                saveFourComponentData();
                
                return true;
            } catch (error) {
                console.error('❌ 自动保存失败:', error);
                showMessage('❌ 自动保存失败: ' + error.message, 3000);
                return false;
            }
        }
        
        // 加载保存的数据
        function loadSavedData() {
            try {
                // 加载思维导图数据
                const savedMindmapData = localStorage.getItem(STORAGE_KEYS.MINDMAP_DATA);
                if (savedMindmapData) {
                    const parsedData = JSON.parse(savedMindmapData);
                    Object.assign(mindmapData, parsedData);
                }
                
                // 加载节点数据库
                const savedNodeDatabase = localStorage.getItem(STORAGE_KEYS.NODE_DATABASE);
                if (savedNodeDatabase) {
                    nodeDatabase = JSON.parse(savedNodeDatabase);
                }
                
                // *** 关键修复：加载会话数据 ***
                const savedSessionData = localStorage.getItem('nodemind_sessions');
                if (savedSessionData) {
                    sessionDatabase = JSON.parse(savedSessionData);
                } else {
                    sessionDatabase = {};
                }
                
                // 加载项目信息
                const savedProjectInfo = localStorage.getItem(STORAGE_KEYS.PROJECT_INFO);
                if (savedProjectInfo) {
                    Object.assign(projectInfo, JSON.parse(savedProjectInfo));
                }
                
                // 加载选中节点
                const savedSelectedNode = localStorage.getItem(STORAGE_KEYS.SELECTED_NODE);
                if (savedSelectedNode) {
                    selectedNodeId = savedSelectedNode;
                }
                
                // 加载四组件数据
                loadFourComponentData();
                
                // 延迟执行任务管理更新，确保数据加载完成
                setTimeout(() => {
                    updateTaskManagement();
                }, 500);
                
                // 恢复四组件全局状态
                setTimeout(() => {
                    restoreFourComponentGlobalState();
                }, 600);
                
                return true;
            } catch (error) {
                console.error('❌ 数据加载失败:', error);
                return false;
            }
        }
        
        // (重复的简单版showMessage已删除 - 保留支持消息类型的完整版)
        
        // 设置自动保存
        function setupAutoSave() {
            // 定时自动保存（每30秒）
            setInterval(autoSaveData, 30000);
            
            // 页面关闭前保存
            window.addEventListener('beforeunload', function(e) {
                autoSaveData();
            });
            
            // 页面失去焦点时保存
            window.addEventListener('blur', function() {
                autoSaveData();
            });
            
        }
        
        // 初始化标签管理功能
        function initializeTagManagement(nodeId) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData) return;
            
            // 确保标签数据结构存在
            if (!nodeData.tags) {
                nodeData.tags = { categories: [], technical: [], status: [] };
            }
            
            // 查找标签容器
            const tagContainer = document.getElementById(`tag-groups-container-${nodeId}`);
            
            if (tagContainer) {
                // 生成标签HTML
                const html = generateTagGroupsHTML();
                tagContainer.innerHTML = html;
                
                // 为所有标签添加点击事件
                const insertedTags = tagContainer.querySelectorAll('.tag-item');
                insertedTags.forEach((tagItem) => {
                    tagItem.addEventListener('click', function() {
                        toggleTag(nodeId, this);
                    });
                });
                
                // 恢复已选中的标签状态
                restoreTagStates(nodeId);
            }
        }
        
        // 切换标签选择状态
        function toggleTag(nodeId, tagElement) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData) return;
            
            const tagName = tagElement.dataset.tag;
            const tagGroup = tagElement.dataset.group;
            
            // 切换选中状态
            if (tagElement.classList.contains('selected')) {
                // 取消选中
                tagElement.classList.remove('selected');
                removeTagFromNode(nodeData, tagName, tagGroup);
                showMessage(`🏷️ 已移除标签：${tagName}`);
            } else {
                // 选中
                tagElement.classList.add('selected');
                addTagToNode(nodeData, tagName, tagGroup);
                showMessage(`🏷️ 已添加标签：${tagName}`);
            }
            
            // 更新修改时间
            nodeData.modified = new Date().toISOString();
            
            // 自动保存
            setTimeout(autoSaveData, 500);
            
            // 更新任务管理显示
            updateTaskManagement();
        }
        
        // 将标签添加到节点
        function addTagToNode(nodeData, tagName, tagGroup) {
            // 根据标签组分类存储
            let targetArray;
            switch(tagGroup) {
                case '常规':
                    targetArray = nodeData.tags.status;
                    break;
                case 'AI':
                    targetArray = nodeData.tags.technical;
                    break;
                case '笔记':
                    targetArray = nodeData.tags.categories;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            // 避免重复添加
            if (!targetArray.includes(tagName)) {
                targetArray.push(tagName);
            }
        }
        
        // 从节点移除标签
        function removeTagFromNode(nodeData, tagName, tagGroup) {
            // 根据标签组分类移除
            let targetArray;
            switch(tagGroup) {
                case '常规':
                    targetArray = nodeData.tags.status;
                    break;
                case 'AI':
                    targetArray = nodeData.tags.technical;
                    break;
                case '笔记':
                    targetArray = nodeData.tags.categories;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            const index = targetArray.indexOf(tagName);
            if (index > -1) {
                targetArray.splice(index, 1);
            }
        }
        
        // 恢复标签选中状态
        function restoreTagStates(nodeId) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData || !nodeData.tags) return;
            
            // 获取所有已选中的标签
            const allSelectedTags = [
                ...nodeData.tags.status,
                ...nodeData.tags.technical,
                ...nodeData.tags.categories
            ];
            
            // 恢复UI中的选中状态（限定在当前节点的标签容器内）
            const tagContainer = document.getElementById(`tag-groups-container-${nodeId}`);
            if (tagContainer) {
                const tagItems = tagContainer.querySelectorAll('.tag-item');
                tagItems.forEach(tagItem => {
                    const tagName = tagItem.dataset.tag;
                    if (allSelectedTags.includes(tagName)) {
                        tagItem.classList.add('selected');
                    }
                });
            }
        }
        
        // 触发文件导入
        function triggerImportFile() {
            const fileInput = document.getElementById('import_file_input');
            if (fileInput) {
                fileInput.click();
                showMessage('📂 请选择要导入的脑图文件');
            }
        }
        
        // 处理文件导入
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showMessage('📂 正在导入文件: ' + file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedData = null;
                    
                    // 解析JSON文件
                    importedData = JSON.parse(content);
                    
                    // 检查是否是完整导出格式（包含nodeDetails）
                    if (importedData.mindmap && importedData.nodeDetails) {
                        
                        // 恢复节点详细信息数据库
                        Object.assign(nodeDatabase, importedData.nodeDetails);
                        
                        // 使用思维导图数据
                        importedData = importedData.mindmap;
                    }
                    
                    // 验证导入数据格式
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('无效的文件格式');
                    }
                    
                    // 检查必要的数据结构
                    if (!importedData.data || !importedData.data.id) {
                        throw new Error('文件缺少必要的思维导图数据结构');
                    }
                    
                    // 显示导入的思维导图到项目管理面板
                    const projectMindmap = mindmaps['project'];
                    if (projectMindmap) {
                        projectMindmap.show(importedData);
                        
                        // 初始化节点数据库
                        const rootNode = projectMindmap.get_node(importedData.data.id);
                        if (rootNode) {
                            traverseAndInitNodes(rootNode);
                        }
                        
                        // 自动保存导入的数据
                        setTimeout(autoSaveData, 500);
                        
                        showMessage('✅ 文件导入成功: ' + file.name);
                    } else {
                        throw new Error('项目管理思维导图未初始化');
                    }
                    
                } catch (error) {
                    console.error('❌ 文件导入失败:', error);
                    showMessage('❌ 文件导入失败: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // 清空文件输入，允许重复选择同一文件
            event.target.value = '';
        }
        
        // 遍历并初始化节点数据库
        function traverseAndInitNodes(node) {
            if (!node) return;
            
            // 为节点创建数据库记录
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: node.topic,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                };
            }
            
            // 递归处理子节点
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    traverseAndInitNodes(child);
                });
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            
            // 延迟初始化确保DOM准备完毕
            setTimeout(() => {
                // 加载保存的数据
                loadSavedData();
                
                // 初始化思维导图
                initMindmaps();
                
                // 设置自动保存
                setupAutoSave();
                
                // 初始化标签组件（从标签管理脑图加载）
                setTimeout(() => {
                    initializeTagsFromMindmap();
                }, 500); // 给脑图更多时间完成初始化
                
                // 绑定思维导图标签页切换事件
                document.getElementById('tab_button_workspace')?.addEventListener('click', () => {
                    switchMindmapTab('workspace');
                    // 延迟初始化分类管理系统
                    setTimeout(() => {
                        if (typeof initializeCategoryManagementSystem === 'function') {
                            initializeCategoryManagementSystem();
                        }
                    }, 300);
                });
                document.getElementById('tab_button_knowledge')?.addEventListener('click', () => switchMindmapTab('knowledge'));
                document.getElementById('tab_button_project')?.addEventListener('click', () => switchMindmapTab('project'));
                
                // 绑定详情面板标签页切换事件
    
                document.getElementById('detail_tab_injection')?.addEventListener('click', () => switchDetailTab('injection'));
                document.getElementById('detail_tab_project')?.addEventListener('click', () => switchDetailTab('project'));
                
                            // 绑定工具栏按钮事件  
            document.getElementById('show_guide_button')?.addEventListener('click', showUserGuide);
            document.getElementById('export_custom_file_button')?.addEventListener('click', () => {
                // 🔄 修复保存功能：提供格式选择
                showSaveFormatDialog();
            });
            document.getElementById('import_file_button')?.addEventListener('click', async () => {
                // 第三次重构：专门用于MD导入，不降级到JSON导入
                try {
                    
                    if (window.importMDDocument) {
                        const result = await window.importMDDocument();
                        if (result && result.success) {
                            showMessage(`✅ MD文档导入成功: ${result.nodesCount} 个节点`);
                        } else {
                            throw new Error(result.error || '导入失败');
                        }
                    } else {
                        throw new Error('MD导入功能未初始化');
                    }
                } catch (error) {
                    console.error('❌ [MD导入失败]:', error);
                    showMessage(`❌ MD文档导入失败: ${error.message}`);
                    
                    // 不再降级到JSON导入，而是给用户明确的提示
                    const userChoice = confirm('MD文档导入失败。\n\n' + 
                        '可能原因：\n' +
                        '1. 文件格式不符合NodeMind标准\n' +
                        '2. 需要启动本地服务器运行\n\n' +
                        '是否查看帮助信息？');
                    
                    if (userChoice) {
                        alert('解决方案：\n\n' +
                            '1. 确保选择的是MD格式文件\n' +
                            '2. 建议启动本地服务器：\n' +
                            '   - 运行: python -m http.server 8080\n' +
                            '   - 或: npx http-server\n' +
                            '   - 然后访问: http://localhost:8080\n\n' +
                            '3. 检查浏览器控制台的具体错误信息');
                    }
                }
            });
            document.getElementById('sync_tags_button')?.addEventListener('click', syncTagsFromWorkspace);
                
                // 绑定文件输入事件
                document.getElementById('import_file_input')?.addEventListener('change', handleFileImport);
                
                // 绑定右键菜单事件
                initializeContextMenu();
                
            }, 100);
        });

        // 右键菜单相关功能
        let contextMenuTargetNode = null;
        let contextMenuTargetNodeId = null;
        
        // 初始化右键菜单
        function initializeContextMenu() {
            
            // 绑定右键菜单项点击事件
            document.getElementById('context_menu_focus_node')?.addEventListener('click', focusNodeToWorkspace);
            document.getElementById('context_menu_sync')?.addEventListener('click', handleContextMenuSync);
            document.getElementById('context_menu_hide')?.addEventListener('click', hideContextMenu);
            
            // 绑定全局点击事件隐藏菜单
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#contextMenu')) {
                    hideContextMenu();
                }
            });
            
            // 绑定思维导图容器的右键事件
            const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        
                        // 查找被右键点击的节点
                        let nodeElement = e.target.closest('jmnode');
                        if (!nodeElement) {
                            nodeElement = e.target.closest('[nodeid]');
                        }
                        if (!nodeElement && e.target.hasAttribute('nodeid')) {
                            nodeElement = e.target;
                        }
                        
                        if (nodeElement) {
                            const nodeId = nodeElement.getAttribute('nodeid');
                            const mapId = containerId.replace('jsmind_container_', '');
                            const mindmap = mindmaps[mapId];
                            
                            if (mindmap && nodeId) {
                                const node = mindmap.get_node(nodeId);
                                if (node) {
                                    contextMenuTargetNode = node;
                                    contextMenuTargetNodeId = nodeId;
                                    
                                    // 检查是否应该显示同步选项
                                    const shouldShowSync = shouldShowSyncOption(node);
                                    updateContextMenuVisibility(shouldShowSync);
                                    
                                    showContextMenu(e.pageX, e.pageY);
                                }
                            }
                        }
                    });
                }
            });
            
        }
        
        // 显示右键菜单
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';

            // 调整菜单位置避免超出屏幕
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = `${x - rect.width}px`;
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = `${y - rect.height}px`;
            }
        }
        
        // 隐藏右键菜单
        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'none';
            contextMenuTargetNode = null;
            contextMenuTargetNodeId = null;
        }
        
        // 判断是否应该显示同步选项
        function shouldShowSyncOption(node) {
            if (!node || !node.topic) return false;
            
            const topic = node.topic.toLowerCase();
            
            // 检查是否是"当前模板列表"或"标签管理"节点
            return topic.includes('当前模板列表') || 
                   topic.includes('标签管理') ||
                   topic === '当前模板列表' ||
                   topic === '标签管理';
        }
        
        // 更新右键菜单项的可见性
        function updateContextMenuVisibility(showSync) {
            const syncItem = document.getElementById('context_menu_sync');
            const syncDivider = document.getElementById('context_menu_sync_divider');
            
            if (syncItem && syncDivider) {
                if (showSync) {
                    syncItem.style.display = 'block';
                    syncDivider.style.display = 'block';
                } else {
                    syncItem.style.display = 'none';
                    syncDivider.style.display = 'none';
                }
            }
        }
        
        // 处理右键菜单同步功能
        function handleContextMenuSync() {
            if (!contextMenuTargetNode) {
                hideContextMenu();
                return;
            }
            
            const topic = contextMenuTargetNode.topic.toLowerCase();
            
            if (topic.includes('当前模板列表') || topic === '当前模板列表') {
                // 模板同步
                syncTemplatesFromCurrentList();
            } else if (topic.includes('标签管理') || topic === '标签管理') {
                // 标签同步（调用现有功能）
                syncTagsFromWorkspace();
            }
            
            hideContextMenu();
        }
        
        // 将焦点节点复制到临时工作区
        function focusNodeToWorkspace() {
            if (!contextMenuTargetNode) {
                hideContextMenu();
                return;
            }

            try {
                // 简化版本的节点复制功能
                const nodeTree = {
                    id: contextMenuTargetNode.id + '_copy',
                    topic: contextMenuTargetNode.topic,
                    children: contextMenuTargetNode.children || []
                };

                const workspaceData = {
                    meta: { name: `临时工作区A - ${contextMenuTargetNode.topic}`, author: "NodeMind", version: "1.0.0" },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.workspace.show(workspaceData);

                const knowledgeData = {
                    meta: { name: `临时工作区B - ${contextMenuTargetNode.topic}`, author: "NodeMind", version: "1.0.0" },
                    format: "node_tree",
                    data: nodeTree
                };
                mindmaps.knowledge.show(knowledgeData);

                showMessage(`🔬 已将焦点节点"${contextMenuTargetNode.topic}"复制到临时工作区`);

                hideContextMenu();

            } catch (error) {
                console.error('❌ 复制节点到临时工作区失败:', error);
                showMessage(`❌ 复制失败: ${error.message}`);
                hideContextMenu();
            }
        }
        
        // 从"当前模板列表"节点同步模板到右侧面板
        function syncTemplatesFromCurrentList() {
            
            try {
                // 查找"当前模板列表"节点
                let currentTemplateListNode = null;
                
                // 在所有思维导图中查找
                Object.keys(mindmaps).forEach(mapId => {
                    const mindmap = mindmaps[mapId];
                    if (mindmap) {
                        const data = mindmap.get_data();
                        if (data && data.data) {
                            const foundNode = findNodeByTopic(data.data, '当前模板列表');
                            if (foundNode) {
                                currentTemplateListNode = foundNode;
                            }
                        }
                    }
                });
                
                if (!currentTemplateListNode) {
                    showMessage('❌ 未找到"当前模板列表"节点');
                    return;
                }
                
                // 获取子节点作为模板列表
                const templateNodes = currentTemplateListNode.children || [];
                
                // 更新右侧面板的模板列表
                updateRightPanelTemplateList(templateNodes);
                
                showMessage(`✅ 已同步 ${templateNodes.length} 个模板到右侧面板`);
                
            } catch (error) {
                console.error('❌ 模板同步失败:', error);
                showMessage(`❌ 模板同步失败: ${error.message}`);
            }
        }
        
        // 递归查找指定主题的节点
        function findNodeByTopic(nodeData, targetTopic) {
            if (!nodeData) return null;
            
            // 检查当前节点
            if (nodeData.topic && nodeData.topic.includes(targetTopic)) {
                return nodeData;
            }
            
            // 递归检查子节点
            if (nodeData.children && Array.isArray(nodeData.children)) {
                for (const child of nodeData.children) {
                    const found = findNodeByTopic(child, targetTopic);
                    if (found) return found;
                }
            }
            
            return null;
        }
        
        // 更新右侧面板的模板列表
        function updateRightPanelTemplateList(templateNodes) {
            const templatesContainer = document.querySelector('#inner-tab-templates .templates-container');
            if (!templatesContainer) {
                console.error('❌ 未找到右侧模板列表容器');
                return;
            }
            
            // 清空现有内容
            templatesContainer.innerHTML = '';
            
            // 添加同步的模板
            templateNodes.forEach((templateNode, index) => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                templateItem.setAttribute('data-template-id', templateNode.id || `template_${index}`);
                
                // 创建模板项HTML
                templateItem.innerHTML = `
                    <div class="template-title">${getTemplateIcon(templateNode.topic)} ${templateNode.topic}</div>
                    <div class="template-desc">${getTemplateDescription(templateNode.topic)}</div>
                `;
                
                // 添加点击事件
                templateItem.addEventListener('click', () => {
                    // 移除其他项的选中状态
                    document.querySelectorAll('.template-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // 添加当前项的选中状态
                    templateItem.classList.add('selected');
                    
                    showMessage(`✅ 已选中模板: ${templateNode.topic}`);
                });
                
                templatesContainer.appendChild(templateItem);
            });
            
        }
        
        // 根据模板名称获取图标
        function getTemplateIcon(templateName) {
            const iconMap = {
                '自然模式': '🗣️',
                '代码自查': '🔍',
                '修改代码': '⚡',
                '不生效': '❌',
                '日志-修改代码': '📝',
                '新功能': '✨'
            };
            
            for (const [key, icon] of Object.entries(iconMap)) {
                if (templateName.includes(key)) {
                    return icon;
                }
            }
            
            return '📋'; // 默认图标
        }
        
        // 根据模板名称获取描述
        function getTemplateDescription(templateName) {
            const descMap = {
                '自然模式': '常规对话模式，指向项目日志文档',
                '代码自查': '代码质量检查和问题排查',
                '修改代码': '包含完整的代码外科手术协议',
                '不生效': '代码修改不生效问题诊断',
                '日志-修改代码': '结合代码外科手术协议和工作日志记录',
                '新功能': '遵循最小化代码实现原则的新功能开发'
            };
            
            for (const [key, desc] of Object.entries(descMap)) {
                if (templateName.includes(key)) {
                    return desc;
                }
            }
            
            return '从当前模板列表同步的模板'; // 默认描述
        }

        // 绑定详情输入事件
        function bindDetailInputEvents(nodeId) {
            const titleInput = document.getElementById(`node-title-${nodeId}`);
            const contentInput = document.getElementById(`node-content-${nodeId}`);
            const authorInput = document.getElementById(`node-author-${nodeId}`);
            
            // 标题输入实时联动
            if (titleInput) {
                titleInput.addEventListener('input', function() {
                    updateNodeTitle(nodeId, this.value);
                    setTimeout(autoSaveData, 500);
                });
                titleInput.addEventListener('blur', function() {
                    autoSaveData();
                });
            }
            
            // 内容和作者输入事件
            [contentInput, authorInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        setTimeout(autoSaveData, 500);
                    });
                    input.addEventListener('blur', function() {
                        autoSaveData();
                    });
                }
            });
        }

        // 显示使用指南
        function showUserGuide() {
            var guideContent = `
                <h3>📖 NodeMind 操作指南</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <h4>🖱️ 鼠标操作</h4>
                        <ul>
                            <li>单击节点选中</li>
                            <li>双击节点编辑内容</li>
                            <li>拖拽画布移动视图</li>
                            <li>滚轮缩放思维导图</li>
                        </ul>
                    </div>
                    <div>
                        <h4>⌨️ 快捷键操作</h4>
                        <ul>
                            <li>Ctrl+Enter - 添加子节点</li>
                            <li>Enter - 添加兄弟节点</li>
                            <li>F2 - 编辑节点内容</li>
                            <li>Delete - 删除节点</li>
                            <li>Space - 展开/收起节点</li>
                            <li>方向键 - 选择相邻节点</li>
                        </ul>
                    </div>
                    <div>
                        <h4>🏷️ 标签管理</h4>
                        <ul>
                            <li>选中节点后在详情面板管理标签</li>
                            <li>支持常规、AI、笔记三类标签</li>
                            <li>点击标签选择/取消选择</li>
                            <li>标签自动同步到思维导图</li>
                        </ul>
                    </div>
                    <div>
                        <h4>💾 文件操作</h4>
                        <ul>
                            <li>💾 保存 - 保存当前脑图到本地</li>
                            <li>📂 导入文件 - 加载本地脑图文件</li>
                            <li>✨ 新脑图 - 创建新的思维导图</li>
                            <li>🔄 标签同步 - 从标签管理区读取标签</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // 创建模态对话框
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;justify-content:center;align-items:center;';
            
            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:white;border-radius:8px;padding:25px;max-width:80%;max-height:80%;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.3);';
            modalContent.innerHTML = guideContent;
            
            var closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.cssText = 'margin-top:20px;padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;';
            closeButton.onclick = function() {
                document.body.removeChild(modal);
            };
            
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            showMessage('📖 显示使用指南');
        }
        
        // 保存当前项目管理脑图到本地
        async function saveProjectMindmap() {
            try {
                // 获取项目管理选项卡的思维导图数据
                const projectMindmap = mindmaps['project'];
                if (!projectMindmap) {
                    showMessage('❌ 项目管理脑图未初始化');
                    return;
                }
                
                const mind_data = projectMindmap.get_data();
                if (!mind_data) {
                    showMessage('❌ 无数据可保存');
                    return;
                }
                
                // 构建保存数据，包含思维导图和节点详细信息
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind",
                        export_type: "project_save",
                        tab: "project"
                    }
                };
                
                var dataStr = JSON.stringify(exportData, null, 2);
                var fileName = 'NodeMind-项目管理-' + new Date().toISOString().slice(0,10) + '.json';
                
                showMessage('💾 正在保存项目管理脑图...');
                
                // 🔒 强制使用文件选择器保存（不降级到下载模式）
                await saveWithFileSystemAPI(dataStr, fileName);
                
            } catch (error) {
                console.error('❌ 保存失败:', error);
                showMessage('❌ 保存失败: ' + error.message);
            }
        }
        
        // 使用现代文件系统API保存
        async function saveWithFileSystemAPI(content, fileName) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'NodeMind思维导图文件',
                            accept: {
                                'application/json': ['.json']
                            }
                        }
                    ]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                showMessage('✅ 文件已成功保存到指定位置');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('🚫 用户取消了文件保存');
                } else {
                    console.error('❌ 文件选择器保存失败:', error);
                    showMessage('❌ 保存失败: 您的浏览器可能不支持文件选择器，请使用Chrome或Edge浏览器');
                }
            }
        }
        
        // 生成默认标签HTML（备用方案）
        function generateDefaultTagHTML() {
            return `
                <div class="tag-group">
                    <div class="tag-group-title">常规</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-yellow" data-tag="项目" data-group="常规">项目</div>
                        <div class="tag-item tag-yellow" data-tag="里程碑" data-group="常规">里程碑</div>
                        <div class="tag-item tag-yellow" data-tag="完成" data-group="常规">完成</div>
                        <div class="tag-item tag-yellow" data-tag="进行中" data-group="常规">进行中</div>
                        <div class="tag-item tag-yellow" data-tag="计划" data-group="常规">计划</div>
                    </div>
                </div>
                <div class="tag-group">
                    <div class="tag-group-title">AI</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-green" data-tag="记忆" data-group="AI">记忆</div>
                        <div class="tag-item tag-green" data-tag="注意力" data-group="AI">注意力</div>
                        <div class="tag-item tag-green" data-tag="经验" data-group="AI">经验</div>
                        <div class="tag-item tag-green" data-tag="幻觉" data-group="AI">幻觉</div>
                    </div>
                </div>
                <div class="tag-group">
                    <div class="tag-group-title">笔记</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-blue" data-tag="跟进" data-group="笔记">跟进</div>
                        <div class="tag-item tag-blue" data-tag="议题" data-group="笔记">议题</div>
                    </div>
                </div>`;
        }

        // 直接从标签管理脑图获取标签数据
        function getTagsFromWorkspace() {
            try {
                // 获取标签管理面板的思维导图
                const workspaceMindmap = mindmaps['workspace'];
                if (!workspaceMindmap) {
                    return getDefaultTagGroups();
                }
                
                const workspaceData = workspaceMindmap.get_data();
                if (!workspaceData || !workspaceData.data) {
                    return getDefaultTagGroups();
                }
                
                // 解析标签结构
                const tagStructure = {
                    categories: [],  // 常规标签
                    technical: [],   // AI标签  
                    status: []       // 笔记标签
                };
                
                // 遍历标签管理脑图的子节点
                if (workspaceData.data.children) {
                    workspaceData.data.children.forEach(node => {
                        const nodeName = node.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                        
                        // 判断这是分组节点还是标签节点
                        if (node.children && node.children.length > 0) {
                            // 这是一个分组节点，处理其子标签
                            let targetArray = null;
                            
                            // 特殊处理：如果是"标签管理"根节点，需要按子节点名称分类
                            if (nodeName === '标签管理') {
                                
                                // 遍历标签管理的子节点，按名称分类
                                node.children.forEach(childGroup => {
                                    const childName = childGroup.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                    
                                    let childTargetArray = null;
                                    
                                    if (childName.includes('常规') || childName === '常规组' || childName === '常规' || 
                                        childName.includes('分类') || childName.includes('基础') || childName.includes('项目')) {
                                        childTargetArray = tagStructure.categories;
                                    } else if (childName.includes('AI') || childName === 'AI组' || childName === 'AI' ||
                                              childName.includes('技术') || childName.includes('智能')) {
                                        childTargetArray = tagStructure.technical;
                                    } else if (childName.includes('笔记') || childName === '笔记组' || childName === '笔记' ||
                                              childName.includes('状态') || childName.includes('记录')) {
                                        childTargetArray = tagStructure.status;
                                    }
                                    
                                    // 收集该子组下的标签
                                    if (childTargetArray && childGroup.children) {
                                        childGroup.children.forEach(tagNode => {
                                            const tagName = tagNode.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                            if (tagName && tagName.length > 0 && !childTargetArray.includes(tagName)) {
                                                childTargetArray.push(tagName);
                                            }
                                        });
                                    }
                                });
                                return; // 跳过后续的常规处理逻辑
                            }
                            
                            // 常规的分组节点处理逻辑
                            if (nodeName.includes('常规') || nodeName === '常规组' || nodeName === '常规' || 
                                nodeName.includes('分类') || nodeName.includes('基础') || nodeName.includes('项目')) {
                                targetArray = tagStructure.categories;
                            } else if (nodeName.includes('AI') || nodeName === 'AI组' || nodeName === 'AI' ||
                                      nodeName.includes('技术') || nodeName.includes('智能')) {
                                targetArray = tagStructure.technical;
                            } else if (nodeName.includes('笔记') || nodeName === '笔记组' || nodeName === '笔记' ||
                                      nodeName.includes('状态') || nodeName.includes('记录')) {
                                targetArray = tagStructure.status;
                            }
                            
                            // 收集该分组下的标签
                            if (targetArray) {
                                node.children.forEach(tagNode => {
                                    const tagName = tagNode.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                    // 确保标签名称不为空且不重复
                                    if (tagName && tagName.length > 0 && !targetArray.includes(tagName)) {
                                        targetArray.push(tagName);
                                    } else if (!tagName || tagName.length === 0) {
                                    } else {
                                    }
                                });
                            }
                        } else {
                            // 这是一个独立的标签节点，暂时跳过（只处理分组下的二级节点）
                        }
                    });
                }
                
                
                // 如果所有标签组都为空，返回默认数据
                const totalTags = tagStructure.categories.length + tagStructure.technical.length + tagStructure.status.length;
                if (totalTags === 0) {
                    return getDefaultTagGroups();
                }
                
                return tagStructure;
                
            } catch (error) {
                console.error('❌ 从脑图读取标签失败:', error);
                return getDefaultTagGroups();
            }
        }
        
        // 获取默认标签分组
        function getDefaultTagGroups() {
            return {
                categories: ['项目', '里程碑', '完成', '进行中', '计划'],
                technical: ['记忆', '注意力', '经验', '幻觉'],
                status: ['跟进', '议题']
            };
        }
        
        // 生成标签组HTML（从脑图同步数据）
        function generateTagGroupsHTML() {
            
            // 从标签管理脑图获取最新数据
            const finalTagGroups = getTagsFromWorkspace();
            
            
            try {
                
                let html = '';
                
                // 生成常规标签组
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">常规</div>
                        <div class="tag-group-items">`;
                
                // 使用最终合并的标签数据
                finalTagGroups.categories.forEach(tag => {
                    html += `<div class="tag-item tag-yellow" data-tag="${tag}" data-group="常规">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // 生成AI标签组
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">AI</div>
                        <div class="tag-group-items">`;
                
                finalTagGroups.technical.forEach(tag => {
                    html += `<div class="tag-item tag-green" data-tag="${tag}" data-group="AI">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // 生成笔记标签组
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">笔记</div>
                        <div class="tag-group-items">`;
                
                finalTagGroups.status.forEach(tag => {
                    html += `<div class="tag-item tag-blue" data-tag="${tag}" data-group="笔记">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // 如果没有生成任何标签组HTML，显示空状态提示
                if (!html.trim()) {
                    html = `
                        <div class="empty-tags-message">
                            <div class="empty-icon">🏷️</div>
                            <div class="empty-text">暂无标签组</div>
                            <div class="empty-hint">请在标签管理脑图中添加标签组和标签</div>
                        </div>`;
                }
                
                return html;
                
            } catch (error) {
                console.error('❌ 生成标签HTML失败:', error);
                
                // 降级使用默认数据
                const defaultGroups = getDefaultTagGroups();
                let fallbackHtml = '';
                
                // 生成默认常规标签组
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">常规</div>
                        <div class="tag-group-items">`;
                defaultGroups.categories.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-yellow" data-tag="${tag}" data-group="常规">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                // 生成默认AI标签组
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">AI</div>
                        <div class="tag-group-items">`;
                defaultGroups.technical.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-green" data-tag="${tag}" data-group="AI">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                // 生成默认笔记标签组
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">笔记</div>
                        <div class="tag-group-items">`;
                defaultGroups.status.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-blue" data-tag="${tag}" data-group="笔记">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                return fallbackHtml;
            }
        }
        
        // 添加标签加载状态的CSS样式
        function addTagLoadingStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .loading-tags-state, .error-tags-state {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 30px 20px;
                    text-align: center;
                    min-height: 120px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 2px dashed #dee2e6;
                }
                
                .loading-icon, .error-icon {
                    font-size: 24px;
                    margin-bottom: 10px;
                }
                
                .loading-icon {
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .loading-text, .error-text {
                    font-size: 14px;
                    color: #6c757d;
                    margin-bottom: 5px;
                    font-weight: 500;
                }
                
                .error-text {
                    color: #dc3545;
                }
                
                .error-detail {
                    font-size: 12px;
                    color: #6c757d;
                    margin-bottom: 15px;
                }
                
                .retry-btn {
                    padding: 6px 12px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background-color 0.2s;
                }
                
                .retry-btn:hover {
                    background: #0056b3;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 初始化时从标签管理脑图加载标签组件
        function initializeTagsFromMindmap() {
            
            try {
                // 添加必要的CSS样式
                addTagLoadingStyles();
                // 等待脑图初始化完成
                const checkMindmapReady = () => {
                    const workspaceMindmap = mindmaps['workspace'];
                    if (!workspaceMindmap) {
                        setTimeout(checkMindmapReady, 100);
                        return;
                    }
                    
                    // 脑图已就绪，开始加载标签
                    loadTagsFromMindmap();
                };
                
                // 开始检查脑图是否就绪
                checkMindmapReady();
                
            } catch (error) {
                console.error('❌ 初始化标签组件失败:', error);
                showLoadingError();
            }
        }
        
        // 从脑图加载标签数据并更新UI
        function loadTagsFromMindmap() {
            try {
                
                // 获取标签数据
                const tagGroups = getTagsFromWorkspace();
                
                // 生成标签组件HTML
                const tagsHTML = generateTagGroupsHTML();
                
                // 更新标签容器
                const tagContainer = document.getElementById('tag-groups');
                if (tagContainer) {
                    tagContainer.innerHTML = tagsHTML;
                    
                    // 统计标签数量
                    const groups = tagContainer.querySelectorAll('.tag-group');
                    let totalTags = 0;
                    groups.forEach(group => {
                        const items = group.querySelectorAll('.tag-item, .tag');
                        totalTags += items.length;
                    });
                    
                    showMessage(`✅ 标签组件初始化完成 (${groups.length}组, ${totalTags}个标签)`);
                } else {
                    throw new Error('标签容器不存在');
                }
                
            } catch (error) {
                console.error('❌ 从脑图加载标签失败:', error);
                showLoadingError(error.message);
            }
        }
        
        // 显示加载错误状态
        function showLoadingError(errorMessage = '未知错误') {
            const tagContainer = document.getElementById('tag-groups');
            if (tagContainer) {
                tagContainer.innerHTML = `
                    <div class="error-tags-state">
                        <div class="error-icon">❌</div>
                        <div class="error-text">标签加载失败</div>
                        <div class="error-detail">${errorMessage}</div>
                        <button class="retry-btn" onclick="initializeTagsFromMindmap()">🔄 重试</button>
                    </div>
                `;
            }
        }
        
        // 处理分析按钮点击事件
        function handleAnalyzeTagData() {
            try {
                
                // 检查函数是否存在
                if (typeof analyzeTagComponentDataSource !== 'function') {
                    console.error('❌ analyzeTagComponentDataSource函数不存在');
                    showMessage('❌ 分析功能不可用', 'error');
                    return;
                }
                
                // 执行分析
                analyzeTagComponentDataSource();
                showMessage('✅ 分析完成，请查看控制台输出', 'success');
                
            } catch (error) {
                console.error('❌ 分析按钮处理失败:', error);
                showMessage('❌ 分析失败: ' + error.message, 'error');
            }
        }
        
        // 标签数据来源分析工具（修复版）
        function analyzeTagComponentDataSource() {
            
            try {
                // 安全检查：确保所有依赖都存在
                
                // 检查mindmaps全局变量
                if (typeof mindmaps === 'undefined') {
                    console.error('❌ mindmaps全局变量未定义');
                    return;
                }
                
                // 检查关键函数
                const requiredFunctions = ['getTagsFromWorkspace', 'getDefaultTagGroups'];
                for (const funcName of requiredFunctions) {
                    if (typeof window[funcName] !== 'function') {
                        console.error(`❌ 函数 ${funcName} 不存在`);
                        return;
                    }
                }
                
                
                // 第一步：检查页面显示的标签
                
                const tagContainer = document.getElementById('tag-groups');
                const pageTagData = {};
                
                if (tagContainer) {
                    
                    const groups = tagContainer.querySelectorAll('.tag-group');
                    
                    groups.forEach((group, index) => {
                        const titleElement = group.querySelector('.tag-group-title');
                        const items = group.querySelectorAll('.tag-item, .tag');
                        
                        if (titleElement) {
                            const title = titleElement.textContent.trim();
                            const tags = Array.from(items).map(item => item.textContent.trim());
                            
                            
                            // 存储页面数据
                            if (title === '常规') pageTagData.categories = tags;
                            else if (title === 'AI') pageTagData.technical = tags;
                            else if (title === '笔记') pageTagData.status = tags;
                        }
                    });
                } else {
                }
                
                // 第二步：检查脑图数据
                
                const workspace = mindmaps['workspace'];
                let brainMapData = null;
                
                if (workspace) {
                    try {
                        const data = workspace.get_data();
                        if (data && data.data) {
                            brainMapData = data.data;
                            
                            if (brainMapData.children) {
                                brainMapData.children.forEach((node, index) => {
                                    const name = node.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                    const childCount = node.children ? node.children.length : 0;
                                });
                            }
                        } else {
                        }
                    } catch (dataError) {
                        console.error('❌ 获取脑图数据失败:', dataError);
                    }
                } else {
                }
                
                // 第三步：测试函数执行
                
                let functionResult = null;
                let defaultResult = null;
                
                try {
                    functionResult = getTagsFromWorkspace();
                } catch (funcError) {
                    console.error('❌ getTagsFromWorkspace执行失败:', funcError);
                }
                
                try {
                    defaultResult = getDefaultTagGroups();
                } catch (defaultError) {
                    console.error('❌ getDefaultTagGroups执行失败:', defaultError);
                }
                
                // 第四步：数据对比
                
                const groupNames = { categories: '常规', technical: 'AI', status: '笔记' };
                
                Object.keys(groupNames).forEach(key => {
                    const displayName = groupNames[key];
                    const pageData = pageTagData[key] || [];
                    const funcData = functionResult ? (functionResult[key] || []) : [];
                    const defData = defaultResult ? (defaultResult[key] || []) : [];
                    
                    
                    // 比较一致性
                    const pageVsFunc = JSON.stringify(pageData.sort()) === JSON.stringify(funcData.sort());
                    const funcVsDefault = JSON.stringify(funcData.sort()) === JSON.stringify(defData.sort());
                    
                });
                
                // 第五步：问题诊断
                
                if (!workspace) {
                } else if (!brainMapData) {
                } else if (!functionResult) {
                } else {
                }
                
                
            } catch (error) {
                console.error('❌ 分析工具出错:', error);
                console.error('错误堆栈:', error.stack);
            }
        }

        // 单向同步：从标签脑图同步数据到标签组件（标签脑图作为唯一数据源）
        // 注意：标签组和标签只支持在标签脑图中手动修改，不支持程序自动修改
        function syncTagsFromWorkspace() {
            try {
                showMessage('🔄 正在从标签脑图同步标签数据...');
                
                // 执行数据来源分析（如果函数存在）
                if (typeof analyzeTagComponentDataSource === 'function') {
                    try {
                        analyzeTagComponentDataSource();
                    } catch (analysisError) {
                        console.error('⚠️ 分析功能执行失败:', analysisError);
                    }
                }
                
                // 1. 从标签脑图读取最新数据
                const tagGroups = getTagsFromWorkspace();
                
                // 2. 更新四组件中的标签组件（主要目标）
                const fourComponentTagsContainer = document.getElementById('tag-groups');
                if (fourComponentTagsContainer) {
                    
                    // 生成新的标签组HTML
                    let newTagsHTML = '';
                    
                    // 定义标签组映射
                    const groupMappings = {
                        'categories': '常规',
                        'technical': 'AI', 
                        'status': '笔记'
                    };
                    
                    Object.keys(tagGroups).forEach(groupKey => {
                        const tags = tagGroups[groupKey];
                        if (!tags || tags.length === 0) return;
                        
                        const groupDisplayName = groupMappings[groupKey] || groupKey;
                        
                        newTagsHTML += `
                            <div class="tag-group">
                                <div class="tag-group-title">${groupDisplayName}</div>
                                <div class="tag-list" id="${groupKey.toLowerCase()}-tags">`;
                        
                        tags.forEach(tag => {
                            newTagsHTML += `<span class="tag" data-tag="${tag}" data-group="${groupDisplayName}" onclick="fourComponentToggleTag(this)">${tag}</span>`;
                        });
                        
                        newTagsHTML += `
                                </div>
                            </div>`;
                    });
                    
                    // 更新标签容器内容
                    fourComponentTagsContainer.innerHTML = newTagsHTML;
                } else {
                }
                
                // 3. 更新节点详情面板中的标签组件（如果存在）
                const allTagContainers = document.querySelectorAll('[id*="tag-groups-container"]');
                
                if (allTagContainers.length > 0) {
                    allTagContainers.forEach((tagContainer, index) => {
                        
                        // 使用能正常工作的标签生成函数
                        tagContainer.innerHTML = generateTagGroupsHTML();
                        
                        // 重新绑定事件
                        const tagItems = tagContainer.querySelectorAll('.tag-item');
                        tagItems.forEach(tagItem => {
                            tagItem.addEventListener('click', function() {
                                const nodeId = tagContainer.id.replace('tag-groups-container-', '');
                                toggleTag(nodeId, this);
                            });
                        });
                        
                        // 恢复选中状态
                        if (selectedNodeId) {
                            restoreTagStates(selectedNodeId);
                        }
                    });
                    
                    showMessage('✅ 标签同步完成！');
                } else {
                    // 如果当前有选中节点，强制刷新详情面板
                    if (selectedNodeId) {
                        const currentMindmapInstance = mindmaps[currentMindmap];
                        if (currentMindmapInstance) {
                            const currentNode = currentMindmapInstance.get_node(selectedNodeId);
                            if (currentNode) {
                                showNodeDetails(currentNode, currentMindmap);
                                showMessage('✅ 详情面板刷新完成！');
                            }
                        }
                    } else {
                        showMessage('ℹ️ 请先选择一个节点查看标签效果');
                    }
                }
                
                showMessage('✅ 标签同步完成！标签脑图数据已同步到标签组件');
                
            } catch (error) {
                console.error('❌ 标签同步失败:', error);
                showMessage('❌ 标签同步失败: ' + error.message);
            }
        }

        // 任务管理功能
        function updateTaskManagement() {
            
            // 获取当前思维导图实例
            const currentMindmapInstance = getCurrentJsMind();
            if (!currentMindmapInstance) return;
            
            // 获取所有节点数据
            const mindmapData = currentMindmapInstance.get_data();
            if (!mindmapData || !mindmapData.data) return;
            
            // 递归处理所有节点
            processNodeForTaskManagement(mindmapData.data, currentMindmapInstance);
        }
        
        // 处理单个节点的任务管理
        function processNodeForTaskManagement(nodeData, mindmapInstance) {
            if (!nodeData || !nodeData.id) return;
            
            const nodeId = nodeData.id;
            const nodeInfo = nodeDatabase[nodeId];
            
            if (nodeInfo && nodeInfo.tags) {
                // 检查是否有"完成"标签
                const isCompleted = nodeInfo.tags.status.includes('完成');
                
                // 检查是否有"项目"标签
                const isProject = nodeInfo.tags.status.includes('项目');
                
                // 处理完成节点的虚化
                if (isCompleted) {
                    applyCompletedNodeStyle(nodeId, mindmapInstance);
                } else {
                    // 如果没有完成标签，恢复原始样式
                    restoreNodeStyle(nodeId, mindmapInstance);
                }
                
                // 处理项目节点的进度显示
                if (isProject && nodeData.children && nodeData.children.length > 0) {
                    updateProjectProgress(nodeId, nodeData.children, mindmapInstance);
                } else if (!isProject) {
                    // 如果没有项目标签，清除可能存在的进度显示
                    clearProjectProgress(nodeId, mindmapInstance);
                }
            }
            
            // 递归处理子节点
            if (nodeData.children) {
                nodeData.children.forEach(child => {
                    processNodeForTaskManagement(child, mindmapInstance);
                });
            }
        }
        
        // 应用完成节点的虚化样式
        function applyCompletedNodeStyle(nodeId, mindmapInstance) {
            try {
                // 设置节点为灰色并降低透明度
                mindmapInstance.set_node_color(nodeId, '#f0f0f0', '#999999');
                
                // 通过DOM操作设置透明度
                setTimeout(() => {
                    const nodeElement = document.querySelector(`[nodeid="${nodeId}"]`);
                    if (nodeElement) {
                        nodeElement.style.opacity = '0.5';
                        nodeElement.style.filter = 'grayscale(50%)';
                    }
                }, 100);
                
            } catch (error) {
                console.error(`❌ 虚化节点失败: ${nodeId}`, error);
            }
        }
        
        // 更新项目进度显示
        function updateProjectProgress(projectNodeId, children, mindmapInstance) {
            try {
                let totalChildren = 0;
                let completedChildren = 0;
                
                // 统计子节点完成情况
                children.forEach(child => {
                    totalChildren++;
                    const childInfo = nodeDatabase[child.id];
                    if (childInfo && childInfo.tags && childInfo.tags.status.includes('完成')) {
                        completedChildren++;
                    }
                });
                
                // 获取项目节点的原始标题（去除之前的进度信息）
                const projectInfo = nodeDatabase[projectNodeId];
                let originalTitle = projectInfo ? projectInfo.title : '项目';
                
                // 清理标题中可能存在的旧进度信息
                originalTitle = originalTitle.replace(/ \d+\/\d+$/, '');
                
                // 生成进度显示文本（完成数/总数）
                const progressText = ` ${completedChildren}/${totalChildren}`;
                const newTitle = `${originalTitle}${progressText}`;
                
                // 更新节点显示
                mindmapInstance.update_node(projectNodeId, newTitle);
                
                // 检查项目是否全部完成，自动添加完成标签
                if (totalChildren > 0 && completedChildren === totalChildren) {
                    const projectInfo = nodeDatabase[projectNodeId];
                    if (projectInfo && !projectInfo.tags.status.includes('完成')) {
                        projectInfo.tags.status.push('完成');
                        projectInfo.modified = new Date().toISOString();
                        
                        // 触发任务管理更新以应用虚化效果
                        setTimeout(() => {
                            updateTaskManagement();
                        }, 100);
                    }
                }
                
            } catch (error) {
                console.error(`❌ 更新项目进度失败: ${projectNodeId}`, error);
            }
        }
        
        // 恢复节点原始样式（当移除完成标签时）
        function restoreNodeStyle(nodeId, mindmapInstance) {
            try {
                // 恢复默认颜色
                mindmapInstance.set_node_color(nodeId, null, null);
                
                // 恢复DOM样式
                setTimeout(() => {
                    const nodeElement = document.querySelector(`[nodeid="${nodeId}"]`);
                    if (nodeElement) {
                        nodeElement.style.opacity = '';
                        nodeElement.style.filter = '';
                    }
                }, 100);
                
            } catch (error) {
                console.error(`❌ 恢复节点样式失败: ${nodeId}`, error);
            }
        }
        
        // 清除项目进度显示（当移除项目标签时）
        function clearProjectProgress(nodeId, mindmapInstance) {
            try {
                const projectInfo = nodeDatabase[nodeId];
                if (projectInfo) {
                    // 清理标题中的进度信息，恢复原始标题
                    const originalTitle = projectInfo.title.replace(/ \d+\/\d+$/, '');
                    
                    // 更新节点显示为原始标题
                    mindmapInstance.update_node(nodeId, originalTitle);
                    
                    // 同时更新nodeDatabase中的标题
                    projectInfo.title = originalTitle;
                    
                }
            } catch (error) {
                console.error(`❌ 清除项目进度失败: ${nodeId}`, error);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            
            // 初始化项目信息（独立模块，不影响其他功能）
            initProjectInfo();
            
            // 初始化模板管理和选择服务
            setTimeout(() => {
                // 初始化模板服务
                if (typeof TemplateService !== 'undefined') {
                    TemplateService.initialize();
                    
                    // 获取模板数据
                    window.templateData = TemplateService.getTemplateData();
                } else {
                    console.warn('⚠️ TemplateService 未加载');
                }
                
                // 初始化模板选择服务
                if (typeof TemplateSelectionService !== 'undefined') {
                    if (window.templateData) {
                        window.templateSelectionService = new TemplateSelectionService();
                        window.templateSelectionService.init();
                    } else {
                        console.warn('⚠️ templateData 尚未加载，再次尝试...');
                        // 再次尝试
                        setTimeout(() => {
                            if (window.templateData) {
                                window.templateSelectionService = new TemplateSelectionService();
                                window.templateSelectionService.init();
                            } else {
                                console.error('❌ templateData 加载失败');
                            }
                        }, 500);
                    }
                } else {
                    console.warn('⚠️ TemplateSelectionService 未加载');
                }
            }, 100);
            
            // 延迟执行任务管理更新，确保所有数据加载完成
            setTimeout(() => {
                updateTaskManagement();
            }, 1000);
            
        });

        // 添加键盘快捷键支持（借鉴node_mind_injection_page.html）
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter 触发提交功能
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                
                // 获取当前选中的节点
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const selectedNode = currentMindmapInstance.get_selected_node();
                    if (selectedNode) {
                        // 检查是否有内容可提交
                        const contentEditor = document.getElementById(`node-content-${selectedNode.id}`);
                        if (contentEditor && contentEditor.value.trim()) {
                            submitContent(selectedNode.id);
                            showMessage('⌨️ Ctrl+Enter 快捷键提交已触发', 2000, 'info');
                        } else {
                            showMessage('⚠️ 请先选择有内容的节点进行提交', 2000, 'warning');
                        }
                    } else {
                        showMessage('⚠️ 请先选择一个节点', 2000, 'warning');
                    }
                } else {
                    showMessage('❌ 思维导图未初始化', 2000, 'error');
                }
            }
            
            // Ctrl + Shift + Enter 触发传统复制方式（借鉴node_mind_injection_page.html）
            else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const selectedNode = currentMindmapInstance.get_selected_node();
                    if (selectedNode) {
                        const contentEditor = document.getElementById(`node-content-${selectedNode.id}`);
                        if (contentEditor && contentEditor.value.trim()) {
                            // 执行传统复制（不包含direct_inject标记）
                            traditionalCopyContent(selectedNode.id);
                            showMessage('⌨️ Ctrl+Shift+Enter 传统复制已触发', 2000, 'info');
                        } else {
                            showMessage('⚠️ 请先选择有内容的节点进行复制', 2000, 'warning');
                        }
                    }
                }
            }
            
            // Ctrl + I 显示注入功能帮助
            else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                showInjectionHelp();
            }
        });

        // (重复的traditionalCopyContent已删除 - 保留后面的完整版)

        // (重复的showInjectionHelp已删除 - 保留后面的完整版)

        // 页面加载完成提示快捷键
        window.addEventListener('load', () => {
        });

    </script>

    <!-- 直接节点点击修复 -->
    <script>
        
        // 等待页面加载完成后执行修复
        window.addEventListener('load', function() {
            setTimeout(function() {
                
                // 强制绑定DOM点击事件到所有思维导图容器
                const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
                
                containers.forEach(function(containerId) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        
                        // 移除现有事件监听器
                        container.onclick = null;
                        
                        // 添加新的点击事件监听器
                        container.addEventListener('click', function(e) {
                            
                            // 查找被点击的节点
                            let nodeElement = e.target;
                            let nodeId = null;
                            
                            // 向上查找节点元素
                            while (nodeElement && nodeElement !== container) {
                                if (nodeElement.hasAttribute && nodeElement.hasAttribute('nodeid')) {
                                    nodeId = nodeElement.getAttribute('nodeid');
                                    break;
                                }
                                if (nodeElement.classList && nodeElement.classList.contains('jmnode')) {
                                    nodeId = nodeElement.getAttribute('nodeid');
                                    break;
                                }
                                nodeElement = nodeElement.parentNode;
                            }
                            
                            if (nodeId) {
                                
                                const mapId = containerId.replace('jsmind_container_', '');
                                
                                // 获取节点数据
                                if (window.mindmaps && window.mindmaps[mapId]) {
                                    const mindmap = window.mindmaps[mapId];
                                    const node = mindmap.get_node(nodeId);
                                    
                                    if (node) {
                                        
                                        // 直接更新详情面板
                                        forceUpdateNodeDetails(node);
                                    }
                                }
                            }
                        });
                        
                    }
                });
                
                // 显示修复完成提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;font-size:14px;';
                notice.textContent = '✅ 节点点击修复已应用';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 3000);
                
            }, 2000); // 等待2秒确保所有内容加载完成
        });
        
        // 强制更新节点详情的函数
        function forceUpdateNodeDetails(node) {
            
            // 更新选中状态
            window.selectedNodeId = node.id;
            const statusElement = document.getElementById('selectedNode');
            if (statusElement) {
                statusElement.textContent = node.topic || '无';
            }
            
            // 确保节点数据存在
            if (!window.nodeDatabase) {
                window.nodeDatabase = {};
            }
            
            // 创建或获取节点数据
            const cleanTitle = node.topic.replace(' 📄', '');
            if (!window.nodeDatabase[node.id]) {
                window.nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    author: 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    sessions: [],
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            const nodeData = window.nodeDatabase[node.id];
            
            // 确保节点数据有完整结构
            if (!nodeData.sessions) nodeData.sessions = [];
            if (!nodeData.tags) nodeData.tags = { categories: [], technical: [], status: [] };
            
            // 切换到节点信息标签页并更新四组件
            switchToDetailTab();
            updateFourComponentsForNode(node.id);
            
        }
        
        // 保存节点数据的函数
        function saveNodeData(nodeId) {
            const titleInput = document.getElementById(`node-title-${nodeId}`);
            const contentTextarea = document.getElementById(`node-content-${nodeId}`);
            
            if (titleInput && contentTextarea && window.nodeDatabase && window.nodeDatabase[nodeId]) {
                window.nodeDatabase[nodeId].title = titleInput.value;
                window.nodeDatabase[nodeId].content = contentTextarea.value;
                window.nodeDatabase[nodeId].modified = new Date().toISOString();
                
                // 显示保存提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = '💾 数据已保存';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
                
            }
        }
        
        // 会话管理函数
        function addNewSession(nodeId) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId]) {
                return;
            }
            
            const nodeData = window.nodeDatabase[nodeId];
            if (!nodeData.sessions) {
                nodeData.sessions = [];
            }
            
            const newSession = {
                id: Date.now().toString(),
                title: `会话 ${nodeData.sessions.length + 1}`,
                content: '',
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
            
            nodeData.sessions.push(newSession);
            
            // 刷新会话列表显示
            const sessionList = document.getElementById(`session-list-${nodeId}`);
            if (sessionList) {
                const sessionHtml = `
                    <div class="session-item" onclick="selectSession('${nodeId}', ${nodeData.sessions.length - 1})">
                        <div class="session-header">
                            <span class="session-title">${newSession.title}</span>
                            <span class="session-time">${new Date(newSession.created).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                sessionList.insertAdjacentHTML('beforeend', sessionHtml);
            }
            
        }
        
        function selectSession(nodeId, sessionIndex) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId] || !window.nodeDatabase[nodeId].sessions) {
                return;
            }
            
            const session = window.nodeDatabase[nodeId].sessions[sessionIndex];
            if (session) {
                // 这里可以实现会话内容的显示逻辑
                
                // 显示提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#17a2b8;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = `📖 已选择: ${session.title}`;
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
            }
        }
        
        function viewAllSessions(nodeId) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId] || !window.nodeDatabase[nodeId].sessions) {
                return;
            }
            
            const sessions = window.nodeDatabase[nodeId].sessions;
            
            // 显示提示
            const notice = document.createElement('div');
            notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;';
            notice.textContent = `📖 共有 ${sessions.length} 个会话`;
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), 2000);
        }
        
        function clearAllSessions(nodeId) {
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId]) {
                return;
            }
            
            if (confirm('确定要清空所有会话吗？此操作不可撤销。')) {
                window.nodeDatabase[nodeId].sessions = [];
                
                // 刷新会话列表显示
                const sessionList = document.getElementById(`session-list-${nodeId}`);
                if (sessionList) {
                    sessionList.innerHTML = `
                        <div class="session-item new-session-btn" onclick="addNewSession('${nodeId}')">
                            <span class="new-session-icon">➕</span>
                            <span class="new-session-text">新增会话</span>
                        </div>
                    `;
                }
                
                // 显示提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#dc3545;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = '🗑️ 所有会话已清空';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
                
            }
        }
        
        // (重复的简单版copyContentFromEditor已删除 - 保留功能完整版)
        
        // (重复的简单版pasteContentToEditor已删除 - 保留功能完整版)
        
        // (重复的submitContent函数已删除 - 保留第一个定义)
        
        // 显示消息的辅助函数
        function showMessage(message, duration = 3000, type = 'info') {
            const notice = document.createElement('div');
            
            let backgroundColor;
            switch (type) {
                case 'success':
                    backgroundColor = '#28a745';
                    break;
                case 'error':
                    backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    backgroundColor = '#ffc107';
                    break;
                default:
                    backgroundColor = '#17a2b8';
            }
            
            notice.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: ${backgroundColor};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                z-index: 9999;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                max-width: 350px;
            `;
            notice.textContent = message;
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), duration);
        }
        
        // 传统复制功能（不触发直接注入）
        async function traditionalCopyContent(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容编辑器', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            if (!content) {
                showMessage('❌ 请先输入要复制的内容', 2000, 'error');
                return;
            }
            
            const nodeData = window.nodeDatabase[nodeId] || {};
            const nodeTitle = nodeData.title || `节点${nodeId}`;
            
            try {
                // 创建传统复制的JSON协议（不包含direct_inject标记）
                const injectionData = {
                    source: 'nodemind',
                    type: 'content-injection',
                    content: content,
                    timestamp: new Date().toISOString(),
                    nodeId: nodeId,
                    nodeTitle: nodeTitle,
                    projectName: 'NodeMind'
                };

                const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;
                await navigator.clipboard.writeText(clipboardContent);

                showMessage('📋 内容已复制到剪贴板，请在injection工具中点击"注入命令"', 3000, 'info');

            } catch (error) {
                console.error('复制失败:', error);
                showMessage('❌ 复制失败：' + error.message, 3000, 'error');
            }
        }

        // 显示注入功能帮助信息
        function showInjectionHelp() {
            const helpContent = `
🧠 NodeMind - 一键注入到Cursor 帮助

📋 快捷键说明：
• Ctrl + Enter: 一键直接注入到Cursor
• Ctrl + Shift + Enter: 传统方式（仅复制到剪贴板）
• Ctrl + I: 显示此帮助信息

🎯 使用方法：
1. 选择包含内容的节点
2. 按下快捷键进行注入或复制
3. injection工具会自动执行注入流程

📝 注入协议：
• 使用NODEMIND_INJECTION:JSON格式
• 包含节点ID、标题、内容和时间戳
• direct_inject标记区分直接注入和传统复制

💡 小提示：
• 确保injection工具正在运行
• 一键注入需要完成校准设置
• 传统方式需要手动点击injection工具中的"注入命令"按钮
            `.trim();
            
            // 使用浏览器原生alert显示帮助
            alert(helpContent);
        }

        // 获取当前选中的节点ID（从全局状态或DOM中获取）
        function getCurrentSelectedNodeId() {
            // 优先从全局状态获取
            if (window.selectedNodeId) {
                return window.selectedNodeId;
            }
            
            // 从DOM中查找当前激活的内容编辑器
            const activeEditor = document.querySelector('textarea[id^="node-content-"]:focus');
            if (activeEditor) {
                const match = activeEditor.id.match(/node-content-(.+)/);
                if (match) {
                    return match[1];
                }
            }
            
            // 查找最近更新的内容编辑器
            const allEditors = document.querySelectorAll('textarea[id^="node-content-"]');
            if (allEditors.length > 0) {
                const lastEditor = allEditors[allEditors.length - 1];
                const match = lastEditor.id.match(/node-content-(.+)/);
                if (match) {
                    return match[1];
                }
            }
            
            return null;
        }

        // 键盘快捷键支持
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter 触发提交功能
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                
                const nodeId = getCurrentSelectedNodeId();
                if (nodeId) {
                    // 检查是否有内容可提交
                    const contentEditor = document.getElementById(`node-content-${nodeId}`);
                    if (contentEditor && contentEditor.value.trim()) {
                        submitContent(nodeId);
                        showMessage('⌨️ Ctrl+Enter 快捷键提交已触发', 2000, 'info');
                    } else {
                        showMessage('⚠️ 请先输入内容进行提交', 2000, 'warning');
                    }
                } else {
                    showMessage('⚠️ 请先选择一个节点', 2000, 'warning');
                }
            }
            
            // Ctrl + Shift + Enter 触发传统复制方式
            else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                
                const nodeId = getCurrentSelectedNodeId();
                if (nodeId) {
                    const contentEditor = document.getElementById(`node-content-${nodeId}`);
                    if (contentEditor && contentEditor.value.trim()) {
                        // 执行传统复制（不包含direct_inject标记）
                        traditionalCopyContent(nodeId);
                        showMessage('⌨️ Ctrl+Shift+Enter 传统复制已触发', 2000, 'info');
                    } else {
                        showMessage('⚠️ 请先输入内容进行复制', 2000, 'warning');
                    }
                } else {
                    showMessage('⚠️ 请先选择一个节点', 2000, 'warning');
                }
            }
            
            // Ctrl + I 显示注入功能帮助
            else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                showInjectionHelp();
            }
        });

        // 页面加载完成提示快捷键
        window.addEventListener('load', () => {
        });

        // 导出到全局
        window.forceUpdateNodeDetails = forceUpdateNodeDetails;
        window.saveNodeData = saveNodeData;
        window.addNewSession = addNewSession;
        window.selectSession = selectSession;
        window.viewAllSessions = viewAllSessions;
        window.clearAllSessions = clearAllSessions;

        window.copyContentFromEditor = copyContentFromEditor;
        window.pasteContentToEditor = pasteContentToEditor;
        window.submitContent = submitContent;
        window.showMessage = showMessage;
        window.traditionalCopyContent = traditionalCopyContent;
        window.showInjectionHelp = showInjectionHelp;

        // 四组件功能代码
        // 全局状态管理
        class GlobalStateManager {
            constructor() {
                this.selectedTags = new Set();
                this.selectedTemplates = [];
                this.qaMode = true;
                this.layoutRatio = 0.6; // 左侧面板占比
            }

            // 标签状态管理
            toggleTag(tagElement) {
                const tagText = tagElement.textContent;
                if (this.selectedTags.has(tagText)) {
                    this.selectedTags.delete(tagText);
                    tagElement.classList.remove('selected');
                } else {
                    this.selectedTags.add(tagText);
                    tagElement.classList.add('selected');
                }
            }

            // 模板状态管理
            addTemplate(template) {
                if (!this.selectedTemplates.find(t => t.name === template.name)) {
                    this.selectedTemplates.push(template);
                    this.renderTemplates();
                }
            }

            removeTemplate(templateName) {
                this.selectedTemplates = this.selectedTemplates.filter(t => t.name !== templateName);
                this.renderTemplates();
            }

            useTemplate(templateName) {
                const template = this.selectedTemplates.find(t => t.name === templateName);
                if (template) {
                    const editor = document.getElementById('content-editor');
                    if (editor) {
                        editor.value = template.content;
                    }
                }
            }

            renderTemplates() {
                const container = document.getElementById('template-list');
                if (!container) return;
                
                // 从模板选择服务获取选中的模板
                let selectedTemplates = [];
                if (window.templateSelectionService) {
                    selectedTemplates = window.templateSelectionService.getSelectedTemplates();
                    
                    // 同步到本地状态
                    this.selectedTemplates = selectedTemplates.map(template => ({
                        name: template.name || template.title,
                        content: template.prefix || template.content || ''
                    }));
                } else {
                    // 回退到本地模板列表
                    selectedTemplates = this.selectedTemplates;
                }
                
                if (selectedTemplates.length === 0) {
                    container.innerHTML = `
                        <div class="empty-template-state">
                            <div class="empty-icon">📝</div>
                            <div class="empty-text">暂无选中模板</div>
                            <div class="empty-hint">点击"管理"按钮添加模板</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = selectedTemplates.map(template => `
                        <div class="template-item">
                            <span class="template-name">${template.name || template.title}</span>
                            <div class="template-actions">
                                <button class="template-btn template-btn-use" onclick="fourComponentUseTemplate('${template.id || template.name}')">使用</button>
                                <button class="template-btn template-btn-remove" onclick="fourComponentRemoveTemplate('${template.id || template.name}')">移除</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                // 自动保存四组件数据
                setTimeout(() => saveFourComponentData(), 100);
            }

            reset() {
                this.selectedTags = new Set();
                this.selectedTemplates = [];
                this.qaMode = true;
                this.layoutRatio = 0.6;
            }
        }

        // 节点状态管理
        class NodeStateManager {
            constructor() {
                this.currentNode = null;
                this.nodeData = {};
            }

            loadNode(nodeId) {
                this.currentNode = nodeId;
                
                // 确保节点数据存在，但优先使用已有数据
                if (!this.nodeData[nodeId]) {
                    // 尝试从主应用的nodeDatabase获取数据
                    const mainNodeData = nodeDatabase[nodeId];
                    
                    this.nodeData[nodeId] = {
                        id: nodeId,
                        title: mainNodeData?.title || `节点 ${nodeId}`,
                        content: mainNodeData?.content || '',
                        createTime: mainNodeData?.created ? new Date(mainNodeData.created).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'),
                        updateTime: mainNodeData?.modified ? new Date(mainNodeData.modified).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN')
                    };
                    
                } else {
                }

                this.updateUI();
            }

            updateUI() {
                if (!this.currentNode) {
                    return;
                }

                const nodeData = this.nodeData[this.currentNode];
                if (!nodeData) {
                    return;
                }
                
                
                // 更新标题
                const nodeTitleElement = document.getElementById('node-title');
                
                if (nodeTitleElement) {
                    nodeTitleElement.textContent = nodeData.title;
                }
                
                // 更新内容
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    contentEditor.value = nodeData.content;
                } else {
                }
                
                // 更新元信息
                const metaInfo = document.getElementById('meta-info');
                if (metaInfo) {
                    metaInfo.textContent = `创建时间: ${nodeData.createTime} | 修改时间: ${nodeData.updateTime}`;
                }
                
            }

            updateContent() {
                if (!this.currentNode) return;

                const titleInput = document.getElementById('title-input');
                const contentEditor = document.getElementById('content-editor');
                
                if (titleInput && contentEditor) {
                    const title = titleInput.value;
                    const content = contentEditor.value;
                    
                    // 使用专门的更新函数（包含思维导图同步）
                    updateFourComponentNodeTitle(this.currentNode, title);
                    updateFourComponentNodeContent(this.currentNode, content);
                    
                    // 更新元信息
                    const metaInfo = document.getElementById('meta-info');
                    if (metaInfo) {
                        metaInfo.textContent = `创建时间: ${this.nodeData[this.currentNode].createTime} | 修改时间: ${this.nodeData[this.currentNode].updateTime}`;
                    }
                    
                    // 自动保存四组件数据
                    setTimeout(() => saveFourComponentData(), 100);
                }
            }

            async submitContent() {
                if (!this.currentNode) return;

                
                // 获取内容编辑器
                const contentEditor = document.getElementById('content-editor');
                if (!contentEditor) {
                    console.error('❌ 找不到内容编辑器');
                    return;
                }

                const content = contentEditor.value.trim();
                
                // 获取节点信息
                const nodeData = this.nodeData[this.currentNode] || {};
                const nodeTitle = (nodeData.title || `节点${this.currentNode}`).trim();
                
                // 检查问答模式状态
                const qaToggle = document.getElementById('qa-mode-toggle');
                const isQAMode = qaToggle ? qaToggle.checked : false;
                
                
                // 构建注入内容（标题+内容格式）
                let injectionContent = '';
                
                if (nodeTitle && content) {
                    // 都存在：使用 "- 标题\n- 内容" 格式
                    injectionContent = `- ${nodeTitle}\n- ${content}`;
                } else if (nodeTitle) {
                    // 只有标题：直接使用标题
                    injectionContent = nodeTitle;
                } else if (content) {
                    // 只有内容：直接使用内容
                    injectionContent = content;
                } else {
                    // 都没有：提示错误
                    console.error('❌ 请先输入标题或内容');
                    return;
                }

                try {
                    // 创建一键注入的JSON协议（借鉴node_mind_injection_page.html）
                    const injectionData = {
                        source: 'nodemind',
                        type: 'content-injection',
                        content: injectionContent,
                        direct_inject: true,  // 关键：标识为直接注入
                        timestamp: new Date().toISOString(),
                        nodeId: this.currentNode,
                        nodeTitle: nodeTitle,
                        projectName: 'NodeMind'
                    };

                    // 构建完整的剪贴板内容
                    const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                    // 复制到剪贴板
                    await navigator.clipboard.writeText(clipboardContent);

                    // 显示成功消息
                    
                    // 获取提交按钮并更新状态
                    const submitButton = document.querySelector('.btn-primary');
                    if (submitButton) {
                        const originalText = submitButton.textContent;
                        submitButton.textContent = '✅ 注入已触发';
                        submitButton.disabled = true;
                        
                        // 2秒后恢复按钮
                        setTimeout(() => {
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                        }, 2000);
                    }

                    // === 会话系统集成 ===
                    // 创建会话记录
                    const sessionType = isQAMode ? 'interaction' : 'note';
                    const sessionContent = content; // 使用原始内容，不包含[已注入]标签
                    
                    // 添加会话到节点
                    const newSession = addSessionToNode(this.currentNode, sessionContent, sessionType);

                    // 清空内容编辑器
                    contentEditor.value = '';
                    
                    // 同步更新nodeData（清空内容）
                    if (this.nodeData[this.currentNode]) {
                        this.nodeData[this.currentNode].content = '';
                        this.nodeData[this.currentNode].updateTime = new Date().toLocaleString('zh-CN');
                    }
                    

                    
                    // 记录到日志
                    const logEntry = `${new Date().toLocaleString()} - 节点 "${nodeTitle}" 标题+内容已注入到Cursor`;
                    
                    // 自动保存四组件数据
                    setTimeout(() => saveFourComponentData(), 100);

                } catch (error) {
                    console.error('一键注入失败:', error);
                }
            }

            reset() {
                this.nodeData = {};
                this.currentNode = null;
            }
        }

        // 初始化四组件状态管理器
        const fourComponentGlobalState = new GlobalStateManager();
        const fourComponentNodeState = new NodeStateManager();

        // 问答模式切换
        function onQAModeChange() {
            const qaToggle = document.getElementById('qa-mode-toggle');
            if (!qaToggle) return;
            
            const qaMode = qaToggle.checked;
            fourComponentGlobalState.qaMode = qaMode;
            
            
            // 🔑 更新所有提交按钮的文本，反映当前模式
            updateSubmitButtonTexts(qaMode);
        }
        
        // 更新提交按钮文本
        function updateSubmitButtonTexts(isQAMode) {
            // 🔑 更新四组件提交按钮
            const fourComponentButton = document.querySelector('button[onclick="fourComponentSubmitContent()"]');
            if (fourComponentButton && !fourComponentButton.disabled) {
                if (isQAMode) {
                    fourComponentButton.textContent = '🤖 提交命令';
                    fourComponentButton.title = '问答模式：将内容注入到Cursor进行AI对话';
                } else {
                    fourComponentButton.textContent = '💾 保存笔记';
                    fourComponentButton.title = '笔记模式：保存内容为笔记';
                }
            }
            
            // 更新节点详情面板中的提交按钮
            const submitButtons = document.querySelectorAll('button[onclick*="submitContent"]');
            submitButtons.forEach(button => {
                if (!button.disabled) { // 只更新未禁用的按钮
                    if (isQAMode) {
                        button.textContent = '🤖 提交命令';
                        button.title = '问答模式：将内容注入到Cursor进行AI对话';
                    } else {
                        button.textContent = '💾 保存笔记';
                        button.title = '笔记模式：保存内容为笔记';
                    }
                }
            });
            
        }

        // 四组件相关函数
        function fourComponentUpdateTitle() {
            // 标题输入框已删除，此函数保留但不执行操作
        }

        function fourComponentCopyContent() {
            const contentEditor = document.getElementById('content-editor');
            if (contentEditor) {
                navigator.clipboard.writeText(contentEditor.value).then(() => {
                });
            }
        }

        function fourComponentPasteContent() {
            navigator.clipboard.readText().then(text => {
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    contentEditor.value = text;
                }
            });
        }

        // 四组件提交内容（根据问答模式决定：命令注入 OR 笔记保存）
        function fourComponentSubmitContent() {
            
            // 🔑 检查问答模式状态
            const qaToggle = document.getElementById('qa-mode-toggle');
            const isQAMode = qaToggle && qaToggle.checked;
            
            
            // 获取内容编辑器
            const contentEditor = document.getElementById('content-editor');
            if (!contentEditor) {
                showMessage('❌ 找不到内容编辑器', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            
            if (!content) {
                showMessage('❌ 请先输入内容', 2000, 'error');
                return;
            }
            
            // 获取当前节点ID和标题
            const currentNodeId = window.selectedNodeId || fourComponentGlobalState.currentNode;
            let nodeTitle = '';
            
            if (currentNodeId) {
                const nodeData = nodeDatabase[currentNodeId] || {};
                nodeTitle = nodeData.title || `节点${currentNodeId}`;
            } else {
                nodeTitle = '四组件内容';
            }
            
            if (!isQAMode) {
                // 📝 非问答模式：执行笔记保存 + 创建会话
                
                // 保存节点数据
                autoSaveData();
                
                // 🔑 创建笔记会话
                if (currentNodeId) {
                    addSessionToNode(currentNodeId, content, 'note');
                } else {
                }
                
                // 在内容末尾添加保存时间戳
                if (!content.includes('[已保存]')) {
                    const timestamp = new Date().toLocaleString();
                    const newContent = content + `\n[已保存 ${timestamp}]`;
                    contentEditor.value = newContent;
                    
                }
                
                // 显示保存成功消息
                showMessage('💾 笔记已保存并添加到会话列表', 2000, 'success');
                
                // 记录日志
                const logEntry = `${new Date().toLocaleString()} - "${nodeTitle}" 笔记已保存`;
                
                return; // 📝 笔记模式到此结束，不执行注入
            }
            
            // 🤖 问答模式：执行命令注入流程
            
            // 构建注入内容
            let injectionContent = '';
            if (nodeTitle && content) {
                injectionContent = `- ${nodeTitle}\n- ${content}`;
            } else {
                injectionContent = content;
            }
            
            try {
                // 获取提交按钮并立即更新状态
                const submitButton = document.querySelector('button[onclick="fourComponentSubmitContent()"]');
                const originalText = submitButton ? submitButton.textContent : '';
                
                if (submitButton) {
                    submitButton.textContent = '⏳ 准备注入...';
                    submitButton.disabled = true;
                }

                // 显示准备注入的提示
                showMessage('🎯 准备注入中，正在让出窗口焦点...', 2000, 'warning');
                
                // 延迟500ms后让浏览器失去焦点
                setTimeout(() => {
                    try {
                        window.blur();
                    } catch (e) {
                    }
                }, 500);

                // 延迟1.5秒后执行注入协议
                setTimeout(async () => {
                    try {
                        // 创建一键注入的JSON协议
                        const injectionData = {
                            source: 'nodemind',
                            type: 'content-injection',
                            content: injectionContent,
                            direct_inject: true,
                            timestamp: new Date().toISOString(),
                            nodeId: currentNodeId,
                            nodeTitle: nodeTitle,
                            projectName: 'NodeMind'
                        };

                        // 构建完整的剪贴板内容
                        const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                        // 复制到剪贴板，触发injection工具
                        await navigator.clipboard.writeText(clipboardContent);

                        // 显示成功消息
                        showMessage('🎯 一键注入已触发并添加到会话列表！injection工具正在自动执行...', 3000, 'success');

                        // 更新按钮状态
                        if (submitButton) {
                            submitButton.textContent = '✅ 注入已触发';
                            
                            // 3秒后恢复按钮
                            setTimeout(() => {
                                submitButton.textContent = originalText;
                                submitButton.disabled = false;
                            }, 3000);
                        }

                        // 🔑 创建问答会话
                        if (currentNodeId) {
                            addSessionToNode(currentNodeId, content, 'interaction');
                        } else {
                        }
                        
                        // 在内容末尾添加[已注入]标签
                        if (!content.includes('[已注入]')) {
                            const newContent = content + '\n[已注入]';
                            contentEditor.value = newContent;
                        }

                        
                        // 记录到日志
                        const logEntry = `${new Date().toLocaleString()} - "${nodeTitle}" 内容已注入到Cursor`;

                    } catch (innerError) {
                        console.error('延迟注入失败:', innerError);
                        showMessage('❌ 延迟注入失败：' + innerError.message, 3000, 'error');
                        
                        // 恢复按钮状态
                        if (submitButton) {
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                        }
                    }
                }, 1500); // 延迟1.5秒执行

            } catch (error) {
                console.error('一键注入失败:', error);
                showMessage('❌ 一键注入失败：' + error.message, 3000, 'error');
                
                // 恢复按钮状态
                const submitButton = document.querySelector('button[onclick="fourComponentSubmitContent()"]');
                if (submitButton) {
                    submitButton.textContent = submitButton.textContent.includes('⏳') ? '提交' : submitButton.textContent;
                    submitButton.disabled = false;
                }
            }
        }

        function fourComponentToggleTag(tagElement) {
            
            // 🔥 简化方案：直接在节点内容中添加/移除标签
            const currentNodeId = window.selectedNodeId || fourComponentNodeState.currentNode;
            
            
            if (!currentNodeId) {
                alert('❌ 请先选择一个节点');
                return;
            }
            
            const tagName = tagElement.dataset.tag;
            const tagGroup = tagElement.dataset.group;
            
            
            
            // 获取当前内容编辑器
            const contentEditor = document.getElementById('content-editor');
            
            if (!contentEditor) {
                alert('❌ 找不到内容编辑器');
                return;
            }
            
            let content = contentEditor.value;
            
            const tagString = `#${tagName}`;
            
            // 检查当前标签状态
            const isCurrentlySelected = tagElement.classList.contains('selected');
            
            // 切换标签状态
            if (isCurrentlySelected) {
                // 移除标签
                tagElement.classList.remove('selected');
                const beforeRemove = content;
                content = content.replace(new RegExp(`\\s*${tagString}\\s*`, 'g'), ' ').trim();
            } else {
                // 添加标签
                tagElement.classList.add('selected');
                const beforeAdd = content;
                content = content + (content ? ' ' : '') + tagString;
            }
            
            // 立即更新内容编辑器
            contentEditor.value = content;
            
            // 触发保存
            if (window.fourComponentContentInputHandler) {
                window.fourComponentContentInputHandler.call(contentEditor);
            } else {
            }
            
            
            // 额外验证：再次检查编辑器的值
            setTimeout(() => {
                const finalContent = document.getElementById('content-editor').value;
            }, 500);
        }

        // 🔥 第三次重构版本：从MD内容中智能恢复标签状态
        function restoreFourComponentTagStates(nodeId) {
            if (!nodeId) {
                return;
            }
            
            
            // 清除所有标签的选中状态
            document.querySelectorAll('.tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            
            // 从内容编辑器获取MD内容
            const contentEditor = document.getElementById('content-editor');
            if (!contentEditor) {
                return;
            }
            
            const content = contentEditor.value;
            
            // 智能提取标签（支持 #标签 格式）
            const tagMatches = content.match(/#[\u4e00-\u9fa5\w]+/g); // 支持中文标签
            
            if (tagMatches && tagMatches.length > 0) {
                
                let restoredCount = 0;
                tagMatches.forEach(tagMatch => {
                    const tagName = tagMatch.substring(1); // 移除 # 符号
                    const tagElement = document.querySelector(`[data-tag="${tagName}"]`);
                    
                    if (tagElement) {
                        tagElement.classList.add('selected');
                        restoredCount++;
                    } else {
                    }
                });
                
            } else {
            }
        }

        // (已删除：nodeDatabase操作函数，符合第三次重构"万物皆MD"理念)
        
        // 保存四组件数据到localStorage
        function saveFourComponentData() {
            try {
                // 保存四组件节点状态数据
                const fourComponentData = {
                    nodeData: fourComponentNodeState.nodeData,
                    currentNode: fourComponentNodeState.currentNode,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.FOUR_COMPONENT_DATA, JSON.stringify(fourComponentData));
                
                // 保存四组件全局状态
                const fourComponentGlobalData = {
                    qaMode: fourComponentGlobalState.qaMode,
                    selectedTags: Array.from(fourComponentGlobalState.selectedTags), // 将Set转换为数组以便序列化
                    selectedTemplates: fourComponentGlobalState.selectedTemplates,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE, JSON.stringify(fourComponentGlobalData));
                
                return true;
            } catch (error) {
                console.error('❌ 四组件数据保存失败:', error);
                return false;
            }
        }

        // 从localStorage加载四组件数据
        function loadFourComponentData() {
            try {
                // 加载四组件节点状态数据
                const savedFourComponentData = localStorage.getItem(STORAGE_KEYS.FOUR_COMPONENT_DATA);
                if (savedFourComponentData) {
                    const parsedData = JSON.parse(savedFourComponentData);
                    
                    // 恢复节点数据
                    if (parsedData.nodeData) {
                        fourComponentNodeState.nodeData = parsedData.nodeData;
                        
                        // 详细日志每个节点的内容
                        Object.entries(parsedData.nodeData).forEach(([nodeId, data]) => {
                        });
                    }
                    
                } else {
                }
                
                // 加载四组件全局状态
                const savedGlobalState = localStorage.getItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE);
                if (savedGlobalState) {
                    const parsedGlobalData = JSON.parse(savedGlobalState);
                    
                    // 恢复全局状态
                    if (parsedGlobalData.qaMode !== undefined) {
                        fourComponentGlobalState.qaMode = parsedGlobalData.qaMode;
                    }
                    
                    if (parsedGlobalData.selectedTags) {
                        // 如果是数组，转换为Set；如果已经是Set，直接使用
                        if (Array.isArray(parsedGlobalData.selectedTags)) {
                            fourComponentGlobalState.selectedTags = new Set(parsedGlobalData.selectedTags);
                        } else {
                            fourComponentGlobalState.selectedTags = new Set(parsedGlobalData.selectedTags);
                        }
                    }
                    
                    if (parsedGlobalData.selectedTemplates) {
                        fourComponentGlobalState.selectedTemplates = parsedGlobalData.selectedTemplates;
                    }
                    
                }
                
                return true;
            } catch (error) {
                console.error('❌ 四组件数据加载失败:', error);
                return false;
            }
        }

        // 清除四组件数据
        function clearFourComponentData() {
            try {
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_DATA);
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE);
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_SESSIONS);
                
                // 重置四组件状态
                fourComponentNodeState.reset();
                fourComponentGlobalState.reset();
                
                return true;
            } catch (error) {
                console.error('❌ 四组件数据清除失败:', error);
                return false;
            }
        }

        function openFourComponentTemplateManager() {
            
            // 添加一些示例模板
            const templates = [
                { name: '会议记录模板', content: '# 会议记录\n\n## 时间\n\n## 参与者\n\n## 议题\n\n## 决定事项\n\n## 行动计划' },
                { name: '任务清单模板', content: '# 任务清单\n\n## 待办事项\n- [ ] 任务1\n- [ ] 任务2\n\n## 进行中\n- [ ] 任务3\n\n## 已完成\n- [x] 任务4' }
            ];
            
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
            fourComponentGlobalState.addTemplate(randomTemplate);
        }

        // 当切换到节点信息选项卡时初始化三组件
        function initializeFourComponents() {
            // 恢复全局状态
            restoreFourComponentGlobalState();
            
        }

        // 恢复四组件全局状态
        function restoreFourComponentGlobalState() {
            // 恢复QA模式状态
            const qaToggle = document.getElementById('qa-mode-toggle');
            if (qaToggle) {
                qaToggle.checked = fourComponentGlobalState.qaMode;
                onQAModeChange(); // 应用状态
            }
            
            // 🔑 初始化按钮文本（确保页面加载时按钮显示正确的文本）
            setTimeout(() => {
                updateSubmitButtonTexts(fourComponentGlobalState.qaMode);
            }, 100);
            
            // 恢复选中的标签状态
            if (fourComponentGlobalState.selectedTags && fourComponentGlobalState.selectedTags.size > 0) {
                const tagContainers = document.querySelectorAll('#category-tags, #technical-tags, #status-tags');
                tagContainers.forEach(container => {
                    const tagItems = container.querySelectorAll('.tag');
                    tagItems.forEach(tagItem => {
                        const tagName = tagItem.textContent.trim();
                        if (fourComponentGlobalState.selectedTags.has(tagName)) {
                            tagItem.classList.add('selected');
                        }
                    });
                });
            }
            
        }

        // 当选择节点时更新四组件
        function updateFourComponentsForNode(nodeId) {
            if (!nodeId) return;
            
            
            // 🔥 关键修复：设置当前节点ID
            fourComponentNodeState.currentNode = nodeId;
            
            // 节点信息页面（原命令注入选项卡）现在是默认页面，无需检查
            
            // 从主应用获取节点数据
            let node = null;
            let cleanTitle = '';
            
            // 尝试从当前思维导图获取节点数据
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    cleanTitle = node.topic.replace(' 📄', '');
                }
            }
            
            // 从nodeDatabase获取更完整的数据
            const nodeData = nodeDatabase[nodeId] || {};
            
            // 如果没有从思维导图获取到标题，使用数据库中的标题
            if (!cleanTitle && nodeData.title) {
                cleanTitle = nodeData.title;
            }
            
            // 如果还是没有标题，使用默认标题
            if (!cleanTitle) {
                cleanTitle = `节点 ${nodeId}`;
            }
            
            // 检查是否有从localStorage恢复的四组件数据
            const savedNodeData = fourComponentNodeState.nodeData[nodeId];
            
            // 🔥 第三次重构：万能数据架构的数据优先级
            // 1. nodeDatabase（万能数据架构的主存储）
            // 2. savedNodeData（四组件本地缓存）
            // 3. cleanTitle（从思维导图获取）
            const finalTitle = nodeData.title || savedNodeData?.title || cleanTitle || `节点 ${nodeId}`;
            const finalContent = nodeData.content || savedNodeData?.content || '';
            
            
            fourComponentNodeState.nodeData[nodeId] = {
                id: nodeId,
                title: finalTitle,
                content: finalContent,
                createTime: savedNodeData?.createTime || (nodeData.created ? new Date(nodeData.created).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN')),
                updateTime: savedNodeData?.updateTime || (nodeData.modified ? new Date(nodeData.modified).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'))
            };
            
            
            // 加载节点到四组件
            fourComponentNodeState.loadNode(nodeId);
            
            // 确保UI元素显示正确的内容
            setTimeout(() => {
                const contentEditor = document.getElementById('content-editor');
                
                if (contentEditor && contentEditor.value !== finalContent) {
                    contentEditor.value = finalContent;
                }
            }, 100);
            
            // 绑定四组件的输入事件监听器
            bindFourComponentInputEvents(nodeId);
            
            // 恢复标签选中状态
            setTimeout(() => {
                restoreFourComponentTagStates(nodeId);
            }, 100);
            
        }

        // 绑定四组件输入事件监听器
        function bindFourComponentInputEvents(nodeId) {
            const contentEditor = document.getElementById('content-editor');
            
            // 移除之前的事件监听器（避免重复绑定）
            if (contentEditor) {
                contentEditor.removeEventListener('input', window.fourComponentContentInputHandler);
                contentEditor.removeEventListener('blur', window.fourComponentContentBlurHandler);
            }
            
            // 🔥 第三次重构：使用万能数据架构的MD直存逻辑
            window.fourComponentContentInputHandler = async function() {
                const content = this.value;
                
                // 立即更新本地数据（保持实时响应）
                updateFourComponentNodeContent(nodeId, content);
                
                // 清除之前的保存计时器
                clearTimeout(window.fourComponentMDSaveTimeout);
                
                                        // 🎯 第三次重构：简化MD直存逻辑
                        window.fourComponentMDSaveTimeout = setTimeout(async () => {
                            try {
                                // 直接更新nodeDatabase和localStorage
                                if (nodeDatabase[nodeId]) {
                                    nodeDatabase[nodeId].content = content;
                                    nodeDatabase[nodeId].modified = new Date().toISOString();
                                }
                                
                                // 保存到localStorage
                                localStorage.setItem('nodemind_node_database', JSON.stringify(nodeDatabase));
                                
                                
                            } catch (error) {
                                console.error('❌ [第三次重构] 四组件保存失败:', error);
                                
                                // 降级保护
                                if (window.autoSaveData) {
                                    autoSaveData();
                                }
                            }
                        }, 800);
            };
            
            window.fourComponentContentBlurHandler = function() {
                autoSaveData();
            };
            
            // 绑定内容输入实时联动
            if (contentEditor) {
                contentEditor.addEventListener('input', window.fourComponentContentInputHandler);
                contentEditor.addEventListener('blur', window.fourComponentContentBlurHandler);
            }
            
        }

        // 更新四组件节点标题
        function updateFourComponentNodeTitle(nodeId, title) {
            
            // 确保nodeDatabase中存在该节点
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: title || `节点 ${nodeId}`,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            // 更新四组件数据
            if (!fourComponentNodeState.nodeData[nodeId]) {
                fourComponentNodeState.nodeData[nodeId] = {
                    id: nodeId,
                    title: title || `节点 ${nodeId}`,
                    content: nodeDatabase[nodeId].content || '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            }
            
            fourComponentNodeState.nodeData[nodeId].title = title || `节点 ${nodeId}`;
            fourComponentNodeState.nodeData[nodeId].updateTime = new Date().toLocaleString('zh-CN');
            
            // 同步到主应用nodeDatabase
            nodeDatabase[nodeId].title = title || `节点 ${nodeId}`;
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            
            // 同步更新思维导图显示
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                const node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    // 保持内容图标
                    const hasContent = nodeDatabase[nodeId].content && nodeDatabase[nodeId].content.trim().length > 0;
                    const displayTitle = hasContent ? `${title} 📄` : title;
                    currentMindmapInstance.update_node(nodeId, displayTitle);
                }
            }
            
            // 更新四组件的标题显示
            const nodeTitleElement = document.getElementById('node-title');
            if (nodeTitleElement) {
                nodeTitleElement.textContent = title;
            }
            
            // 立即保存到localStorage
            try {
                saveFourComponentData();
            } catch (error) {
                console.error(`❌ 四组件数据保存失败:`, error);
            }
            
        }

        // 更新四组件节点内容
        function updateFourComponentNodeContent(nodeId, content) {
            
            // 确保nodeDatabase中存在该节点
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: `节点 ${nodeId}`,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            // 更新四组件数据
            if (!fourComponentNodeState.nodeData[nodeId]) {
                fourComponentNodeState.nodeData[nodeId] = {
                    id: nodeId,
                    title: nodeDatabase[nodeId].title || `节点 ${nodeId}`,
                    content: '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            }
            
            fourComponentNodeState.nodeData[nodeId].content = content || '';
            fourComponentNodeState.nodeData[nodeId].updateTime = new Date().toLocaleString('zh-CN');
            
            // 同步到主应用nodeDatabase
            nodeDatabase[nodeId].content = content || '';
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            
            // 更新节点显示图标
            updateNodeContentIcon(nodeId, content);
            
            // 立即保存到localStorage
            try {
                saveFourComponentData();
            } catch (error) {
                console.error(`❌ 四组件数据保存失败:`, error);
            }
            
        }

        // 监听选项卡切换
        document.addEventListener('click', (e) => {
            if (e.target.id === 'detail_tab_injection' || e.target.getAttribute('data-tab') === 'injection') {
                // 延迟初始化，确保DOM已渲染
                setTimeout(() => {
                    initializeFourComponents();
                    // 如果有当前选中的节点，重新绑定事件
                    const currentNode = window.selectedNodeId || fourComponentNodeState.currentNode;
                    if (currentNode) {
                        setTimeout(() => {
                            bindFourComponentInputEvents(currentNode);
                        }, 200);
                    }
                }, 100);
            }
        });

        // 导出四组件函数到全局
        window.onQAModeChange = onQAModeChange;
        window.fourComponentUpdateTitle = fourComponentUpdateTitle;
        window.fourComponentCopyContent = fourComponentCopyContent;

        window.fourComponentPasteContent = fourComponentPasteContent;
        window.fourComponentSubmitContent = fourComponentSubmitContent;
        window.fourComponentToggleTag = fourComponentToggleTag;

        window.fourComponentGlobalState = fourComponentGlobalState;
        window.fourComponentNodeState = fourComponentNodeState;
        window.initializeFourComponents = initializeFourComponents;
        window.updateFourComponentsForNode = updateFourComponentsForNode;
        window.bindFourComponentInputEvents = bindFourComponentInputEvents;
        window.updateFourComponentNodeTitle = updateFourComponentNodeTitle;
        window.updateFourComponentNodeContent = updateFourComponentNodeContent;
        window.toggleFourComponentTag = toggleFourComponentTag;
        window.addFourComponentTagToNode = addFourComponentTagToNode;
        window.removeFourComponentTagFromNode = removeFourComponentTagFromNode;
        window.restoreFourComponentTagStates = restoreFourComponentTagStates;
        window.saveFourComponentData = saveFourComponentData;
        window.loadFourComponentData = loadFourComponentData;
        window.clearFourComponentData = clearFourComponentData;
        window.restoreFourComponentGlobalState = restoreFourComponentGlobalState;

        // 🗂️ 三层次分类管理系统
        let categoryMindmap = null;
        let contentMindmap = null;
        let currentSelectedCategory = null;
        
        // 分类数据存储
        const categoryData = {
            categories: {
                "cat_tags": { id: "cat_tags", name: "🏷️ 标签管理", type: "tags" },
                "cat_templates": { id: "cat_templates", name: "📝 模板管理", type: "templates" },
                "cat_tools": { id: "cat_tools", name: "🔧 工具管理", type: "tools" },
                "cat_data": { id: "cat_data", name: "📊 数据管理", type: "data" }
            },
            content: {
                tags: {
                    "tag_1": { id: "tag_1", name: "1", group: "常规" },
                    "tag_2": { id: "tag_2", name: "2", group: "常规" },
                    "tag_3": { id: "tag_3", name: "3", group: "常规" },
                    "tag_important": { id: "tag_important", name: "重要", group: "常规" },
                    "tag_todo": { id: "tag_todo", name: "待办", group: "常规" },
                    "tag_gpt": { id: "tag_gpt", name: "GPT", group: "AI" },
                    "tag_analysis": { id: "tag_analysis", name: "分析", group: "AI" },
                    "tag_generate": { id: "tag_generate", name: "生成", group: "AI" },
                    "tag_idea": { id: "tag_idea", name: "想法", group: "笔记" },
                    "tag_plan": { id: "tag_plan", name: "计划", group: "笔记" },
                    "tag_summary": { id: "tag_summary", name: "总结", group: "笔记" }
                },
                templates: {},
                tools: {},
                data: {}
            }
        };

        // 初始化分类管理系统
        function initializeCategoryManagementSystem() {
            
            // 初始化分类脑图
            initializeCategoryMindmap();
            
            // 绑定事件监听器
            setupCategoryEventListeners();
            
        }

        // 初始化分类脑图
        function initializeCategoryMindmap() {
            const container = document.getElementById('jsmind_container_categories');
            if (!container) {
                console.error('❌ 找不到分类脑图容器');
                return;
            }

            // 构建分类脑图数据
            const categoryMindmapData = {
                "meta": {
                    "name": "分类管理",
                    "author": "NodeMind",
                    "version": "1.0"
                },
                "format": "node_tree",
                "data": {
                    "id": "root_categories",
                    "topic": "🗂️ 分类中心",
                    "children": [
                        {
                            "id": "cat_tags",
                            "topic": "🏷️ 标签管理",
                            "data": { "category_type": "tags" }
                        },
                        {
                            "id": "cat_templates", 
                            "topic": "📝 模板管理",
                            "data": { "category_type": "templates" }
                        },
                        {
                            "id": "cat_tools",
                            "topic": "🔧 工具管理", 
                            "data": { "category_type": "tools" }
                        },
                        {
                            "id": "cat_data",
                            "topic": "📊 数据管理",
                            "data": { "category_type": "data" }
                        }
                    ]
                }
            };

            // 创建分类脑图实例
            const categoryOptions = {
                container: 'jsmind_container_categories',
                theme: 'primary',
                editable: true,
                shortcut: {
                    enable: true,
                    handles: {},
                    mapping: {
                        addchild: 13, // Enter
                        addbrother: 45, // Insert
                        editnode: 113, // F2
                        delnode: 46, // Delete
                    }
                }
            };

            categoryMindmap = new jsMind(categoryOptions);
            categoryMindmap.show(categoryMindmapData);
            
        }

        // 设置分类事件监听器
        function setupCategoryEventListeners() {
            if (!categoryMindmap) return;
            
            // 监听分类节点选择事件
            categoryMindmap.add_event_listener(function(type, data) {
                if (type === 4) { // 节点选择事件
                    handleCategoryNodeSelect(data.node);
                }
            });
        }

        // 处理分类节点选择
        function handleCategoryNodeSelect(nodeId) {
            
            const node = categoryMindmap.get_node(nodeId);
            if (!node || !node.data || !node.data.category_type) {
                return;
            }
            
            currentSelectedCategory = node.data.category_type;
            
            // 更新右侧内容标题
            const titleElement = document.getElementById('content-mindmap-title');
            if (titleElement) {
                titleElement.textContent = `${node.topic} 内容`;
            }
            
            // 启用右侧控制按钮
            document.getElementById('add-content-btn').disabled = false;
            document.getElementById('save-content-btn').disabled = false;
            
            // 加载对应的内容脑图
            loadContentMindmap(currentSelectedCategory);
        }

        // 加载内容脑图
        function loadContentMindmap(categoryType) {
            
            const container = document.getElementById('jsmind_container_content');
            if (!container) return;
            
            // 清除空状态
            const emptyState = container.querySelector('.empty-content-state');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // 构建内容脑图数据
            const contentData = buildContentMindmapData(categoryType);
            
            // 创建或更新内容脑图
            if (contentMindmap) {
                contentMindmap.show(contentData);
            } else {
                const contentOptions = {
                    container: 'jsmind_container_content',
                    theme: 'greensea',
                    editable: true
                };
                contentMindmap = new jsMind(contentOptions);
                contentMindmap.show(contentData);
            }
            
        }

        // 构建内容脑图数据
        function buildContentMindmapData(categoryType) {
            const contentItems = categoryData.content[categoryType] || {};
            
            let rootTopic = '📋 内容管理';
            switch(categoryType) {
                case 'tags': rootTopic = '🏷️ 标签内容'; break;
                case 'templates': rootTopic = '📝 模板内容'; break;
                case 'tools': rootTopic = '🔧 工具内容'; break;
                case 'data': rootTopic = '📊 数据内容'; break;
            }
            
            const children = Object.values(contentItems).map(item => ({
                id: item.id,
                topic: item.name,
                data: { 
                    item_type: categoryType,
                    group: item.group || 'default'
                }
            }));
            
            return {
                "meta": {
                    "name": `${categoryType}内容`,
                    "author": "NodeMind",
                    "version": "1.0"
                },
                "format": "node_tree",
                "data": {
                    "id": `root_${categoryType}`,
                    "topic": rootTopic,
                    "children": children
                }
            };
        }

        // 新增分类
        function addNewCategory() {
            const categoryName = prompt('请输入新分类名称:');
            if (!categoryName) return;
            
            const categoryId = 'cat_' + Date.now();
            const categoryType = categoryName.toLowerCase().replace(/\s+/g, '_');
            
            // 添加到分类数据
            categoryData.categories[categoryId] = {
                id: categoryId,
                name: categoryName,
                type: categoryType
            };
            
            // 添加到分类脑图
            categoryMindmap.add_node('root_categories', categoryId, categoryName, {
                category_type: categoryType
            });
            
        }

        // 新增内容项
        function addNewContentItem() {
            if (!currentSelectedCategory) {
                alert('请先选择一个分类');
                return;
            }
            
            const itemName = prompt('请输入内容名称:');
            if (!itemName) return;
            
            const itemId = currentSelectedCategory + '_' + Date.now();
            
            // 添加到内容数据
            if (!categoryData.content[currentSelectedCategory]) {
                categoryData.content[currentSelectedCategory] = {};
            }
            
            categoryData.content[currentSelectedCategory][itemId] = {
                id: itemId,
                name: itemName,
                group: 'default'
            };
            
            // 添加到内容脑图
            contentMindmap.add_node(`root_${currentSelectedCategory}`, itemId, itemName, {
                item_type: currentSelectedCategory,
                group: 'default'
            });
            
        }

        // 保存分类脑图
        function saveCategoryMindmap() {
            if (!categoryMindmap) return;
            
            const data = categoryMindmap.get_data();
            localStorage.setItem('nodemind_category_mindmap', JSON.stringify(data));
            localStorage.setItem('nodemind_category_data', JSON.stringify(categoryData));
            
            alert('分类脑图已保存');
        }

        // 保存内容脑图
        function saveContentMindmap() {
            if (!contentMindmap || !currentSelectedCategory) return;
            
            const data = contentMindmap.get_data();
            localStorage.setItem(`nodemind_content_${currentSelectedCategory}`, JSON.stringify(data));
            
            alert('内容脑图已保存');
        }

        // 同步标签数据到标签组件
        function syncTagsToComponents() {
            
            const tagsData = categoryData.content.tags || {};
            const tagContainer = document.getElementById('tag-groups');
            
            if (!tagContainer) {
                return;
            }
            
            // 按组分类标签
            const tagGroups = {};
            Object.values(tagsData).forEach(tag => {
                const group = tag.group || '默认';
                if (!tagGroups[group]) {
                    tagGroups[group] = [];
                }
                tagGroups[group].push(tag);
            });
            
            // 生成标签HTML
            let tagsHTML = '';
            Object.entries(tagGroups).forEach(([groupName, tags]) => {
                tagsHTML += `
                    <div class="tag-group">
                        <div class="tag-group-title">${groupName}</div>
                        <div class="tag-group-items">`;
                
                tags.forEach(tag => {
                    tagsHTML += `<span class="tag" data-tag="${tag.name}" data-group="${groupName}" onclick="fourComponentToggleTag(this)">${tag.name}</span>`;
                });
                
                tagsHTML += `</div></div>`;
            });
            
            tagContainer.innerHTML = tagsHTML;
        }

        // 暴露函数到全局
        window.initializeCategoryManagementSystem = initializeCategoryManagementSystem;
        window.addNewCategory = addNewCategory;
        window.addNewContentItem = addNewContentItem;
        window.saveCategoryMindmap = saveCategoryMindmap;
        window.saveContentMindmap = saveContentMindmap;
        window.syncTagsToComponents = syncTagsToComponents;
        
        // 🔥 第三次重构架构初始化
        let universalDataService = null;
        let smartMDParser = null;
        let uiIntegrationAdapter = null;
        
        // 初始化第三次重构服务
        function initThirdReconstructionArchitecture() {
            
            try {
                // 初始化万能数据服务
                if (window.UniversalDataService) {
                    universalDataService = new window.UniversalDataService();
                } else {
                    console.warn('⚠️ UniversalDataService 未找到');
                }
                
                // 初始化智能MD解析器
                if (window.SmartMDParser) {
                    smartMDParser = new window.SmartMDParser();
                } else {
                    console.warn('⚠️ SmartMDParser 未找到');
                }
                
                // 初始化UI集成适配器
                if (window.UIIntegrationAdapter) {
                    uiIntegrationAdapter = new window.UIIntegrationAdapter();
                } else {
                    console.warn('⚠️ UIIntegrationAdapter 未找到');
                }
                
                // 将服务暴露到全局
                window.universalDataService = universalDataService;
                window.smartMDParser = smartMDParser;
                window.uiIntegrationAdapter = uiIntegrationAdapter;
                
                
                // 启用新架构标记
                window.thirdReconstructionEnabled = true;
                
            } catch (error) {
                console.error('❌ 第三次重构架构初始化失败:', error);
                window.thirdReconstructionEnabled = false;
            }
        }
        
        // 页面加载后立即初始化第三次重构架构
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟500ms确保所有脚本都已加载
            setTimeout(initThirdReconstructionArchitecture, 500);
        });
        
        // MD直存功能
        let mdDirectService = null;
        
        async function initMDDirectService() {
            if (!mdDirectService) {
                
                // 直接创建简化服务，无任何模块依赖
                mdDirectService = {
                    async addMDContent(content, options = {}) {
                        try {
                            
                            // 直接更新到nodeDatabase
                            const nodeId = options.nodeId || 'md_' + Date.now();
                            const lines = content.split('\n');
                            const title = lines[0].replace(/^#+\s*/, '') || '未命名';
                            const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                            
                            if (window.nodeDatabase) {
                                window.nodeDatabase[nodeId] = {
                                    id: nodeId,
                                    title: title,
                                    content: actualContent,
                                    modified: new Date().toISOString(),
                                    ...window.nodeDatabase[nodeId]
                                };
                                
                                // 保存到localStorage
                                localStorage.setItem('nodemind_node_database', JSON.stringify(window.nodeDatabase));
                            }
                            
                            return {
                                success: true,
                                id: nodeId,
                                message: 'MD内容已保存'
                            };
                        } catch (error) {
                            console.error('MD直存失败:', error);
                            return {
                                success: false,
                                error: error.message
                            };
                        }
                    }
                };
                
            }
            return mdDirectService;
        }
        
        function createMockMDDirectService() {
            return {
                async addMDContent(content, options = {}) {
                    
                    // 解析MD内容
                    const lines = content.split('\n');
                    const title = lines[0].replace(/^#+\s*/, '') || '未命名';
                    const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                    
                    // 如果指定了nodeId且要求更新现有节点
                    if (options.nodeId && options.updateExisting) {
                        
                        // 更新nodeDatabase
                        if (window.nodeDatabase && window.nodeDatabase[options.nodeId]) {
                            window.nodeDatabase[options.nodeId].title = title;
                            window.nodeDatabase[options.nodeId].content = actualContent;
                            window.nodeDatabase[options.nodeId].modified = new Date().toISOString();
                        }
                        
                        // 更新四组件数据
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData[options.nodeId]) {
                                window.fourComponentNodeState.nodeData[options.nodeId] = {};
                            }
                            window.fourComponentNodeState.nodeData[options.nodeId].title = title;
                            window.fourComponentNodeState.nodeData[options.nodeId].content = actualContent;
                            window.fourComponentNodeState.nodeData[options.nodeId].modified = new Date().toISOString();
                            
                            if (window.saveFourComponentData) {
                                window.saveFourComponentData();
                            }
                        }
                        
                        // 自动保存
                        if (window.autoSaveData) {
                            window.autoSaveData();
                        }
                        
                        return {
                            success: true,
                            id: options.nodeId,
                            data: { title, content: actualContent },
                            message: `节点 ${options.nodeId} 已通过MD直存更新`
                        };
                    } else {
                        // 创建新节点
                        const nodeId = options.nodeId || 'md_' + Date.now();
                        const nodeData = {
                            id: nodeId,
                            title: title,
                            content: actualContent,
                            tags: [],
                            created: new Date().toISOString(),
                            modified: new Date().toISOString()
                        };
                        
                        // 添加到nodeDatabase
                        if (window.nodeDatabase) {
                            window.nodeDatabase[nodeId] = nodeData;
                        }
                        
                        // 添加到四组件数据
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData) {
                                window.fourComponentNodeState.nodeData = {};
                            }
                            window.fourComponentNodeState.nodeData[nodeId] = nodeData;
                            
                            if (window.saveFourComponentData) {
                                window.saveFourComponentData();
                            }
                        }
                        
                        // 自动保存
                        if (window.autoSaveData) {
                            window.autoSaveData();
                        }
                        
                        return {
                            success: true,
                            id: nodeId,
                            data: nodeData,
                            message: 'MD内容已成功存储到NodeMind'
                        };
                    }
                },
                
                previewMDParsing(content) {
                    const lines = content.split('\n');
                    const title = lines[0].replace(/^#+\s*/, '') || '未命名';
                    const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                    
                    let type = 'note';
                    if (content.includes('任务') || content.includes('实现') || content.includes('开发')) {
                        type = 'task';
                    } else if (content.includes('模板') || content.includes('格式')) {
                        type = 'template';
                    }
                    
                    return {
                        success: true,
                        preview: {
                            title,
                            content: actualContent,
                            type,
                            estimatedSize: content.length
                        }
                    };
                }
            };
        }
        
        async function openMDDirectPanel() {
            await initMDDirectService();
            document.getElementById('md-direct-panel').style.display = 'flex';
        }
        
        function closeMDDirectPanel() {
            document.getElementById('md-direct-panel').style.display = 'none';
        }
        
        async function previewMDContent() {
            const content = document.getElementById('md-input').value;
            if (!content.trim()) {
                alert('请输入MD内容');
                return;
            }
            
            const service = await initMDDirectService();
            const result = service.previewMDParsing(content);
            
            document.getElementById('md-result').innerHTML = `
                <h4>📋 解析预览</h4>
                <div class="preview-item"><strong>标题:</strong> ${result.preview.title}</div>
                <div class="preview-item"><strong>类型:</strong> ${result.preview.type}</div>
                <div class="preview-item"><strong>内容长度:</strong> ${result.preview.estimatedSize} 字符</div>
                <div class="preview-content">
                    <strong>内容预览:</strong>
                    <pre>${result.preview.content.substring(0, 200)}${result.preview.content.length > 200 ? '...' : ''}</pre>
                </div>
            `;
        }
        
        async function storeMDContent() {
            const content = document.getElementById('md-input').value;
            if (!content.trim()) {
                alert('请输入MD内容');
                return;
            }
            
            try {
                const service = await initMDDirectService();
                const result = await service.addMDContent(content);
                
                if (result.success) {
                    document.getElementById('md-result').innerHTML = `
                        <h4>✅ 存储成功</h4>
                        <div class="success-item"><strong>节点ID:</strong> ${result.id}</div>
                        <div class="success-item"><strong>标题:</strong> ${result.data.title}</div>
                        <div class="success-item"><strong>状态:</strong> ${result.message}</div>
                        <div class="success-note">
                            💡 内容已成功添加到NodeMind，所有联动机制正常工作！
                        </div>
                    `;
                    
                    // 清空输入
                    document.getElementById('md-input').value = '';
                    
                    // 刷新界面
                    if (window.refreshMindmapDisplay) {
                        window.refreshMindmapDisplay();
                    }
                } else {
                    throw new Error(result.error || '存储失败');
                }
            } catch (error) {
                document.getElementById('md-result').innerHTML = `
                    <h4>❌ 存储失败</h4>
                    <div class="error-message">${error.message}</div>
                `;
            }
        }
        
        function clearMDPanel() {
            document.getElementById('md-input').value = '';
            document.getElementById('md-result').innerHTML = '';
        }
        
        // 页面加载完成后初始化第三次重构架构
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟500ms确保所有脚本都已加载
            setTimeout(initThirdReconstructionArchitecture, 500);
        });
        
        // 🔥 第三次重构：MD文档导入功能
        async function importMDDocument() {
            try {
                // 创建文件输入元素
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.md,.txt';
                fileInput.style.display = 'none';
                
                return new Promise((resolve, reject) => {
                    fileInput.onchange = async (event) => {
                        const file = event.target.files[0];
                        if (!file) {
                            reject(new Error('未选择文件'));
                            return;
                        }
                        
                        
                        try {
                            // 读取文件内容
                            const content = await file.text();
                            
                            // 使用第三次重构的万能数据架构处理
                            const result = await processImportedMDDocument(content, file.name);
                            
                            if (result.success) {
                                
                                // 刷新界面显示
                                if (window.refreshMindmapDisplay) {
                                    window.refreshMindmapDisplay();
                                }
                                
                                // 切换到四组件面板
                                switchToDetailTab();
                                
                                resolve(result);
                            } else {
                                throw new Error(result.error);
                            }
                            
                        } catch (error) {
                            console.error(`❌ [MD导入] 处理失败:`, error);
                            reject(error);
                        }
                    };
                    
                    // 触发文件选择
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                });
                
            } catch (error) {
                console.error(`❌ [MD导入] 初始化失败:`, error);
                throw error;
            }
        }
        
        // 🎯 处理导入的MD文档（简化版本）
        async function processImportedMDDocument(mdContent, fileName) {
            try {
                
                // 解析MD文档结构 - 使用修复版解析器
                const parsedNodes = window.parseImportedMDNodes_NEW ? 
                    window.parseImportedMDNodes_NEW(mdContent) : 
                    parseImportedMDNodes_NEW(mdContent);
                
                let importedCount = 0;
                let skippedCount = 0;
                
                // 确保必要的全局数据结构存在
                if (!window.nodeDatabase) {
                    window.nodeDatabase = {};
                }
                
                // 简化版本：直接添加到nodeDatabase和四组件数据
                for (const nodeInfo of parsedNodes) {
                    try {
                        const nodeId = nodeInfo.id || `import_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
                        
                        // 创建节点数据
                        const nodeData = {
                            id: nodeId,
                            title: nodeInfo.title,
                            content: nodeInfo.content || '',
                            tags: nodeInfo.tags || [],
                            author: nodeInfo.author || '导入用户',
                            priority: nodeInfo.priority || 'medium',
                            status: nodeInfo.status || 'pending',
                            time: {
                                created: new Date().toLocaleString(),
                                modified: new Date().toLocaleString()
                            },
                            importSource: fileName,
                            importTime: new Date().toISOString()
                        };
                        
                        // 添加到nodeDatabase
                        window.nodeDatabase[nodeId] = nodeData;
                        
                        // 添加到四组件数据
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData) {
                                window.fourComponentNodeState.nodeData = {};
                            }
                            window.fourComponentNodeState.nodeData[nodeId] = nodeData;
                        }
                        
                        importedCount++;
                        
                    } catch (nodeError) {
                        skippedCount++;
                        console.error(`❌ [节点失败] ${nodeInfo.id}:`, nodeError);
                    }
                }
                
                // 保存数据到localStorage
                try {
                    localStorage.setItem('nodemind_node_database', JSON.stringify(window.nodeDatabase));
                    
                    if (window.fourComponentNodeState) {
                        if (window.saveFourComponentData) {
                            window.saveFourComponentData();
                        }
                    }
                    
                    // 自动保存
                    if (window.autoSaveData) {
                        window.autoSaveData();
                    }
                    
                    
                } catch (saveError) {
                    console.warn('⚠️ [数据保存] 保存失败:', saveError);
                }
                
                
                // 刷新界面
                setTimeout(() => {
                    if (window.refreshMindmapDisplay) {
                        window.refreshMindmapDisplay();
                    }
                    
                    // 触发四组件刷新
                    if (window.fourComponentsRefresh) {
                        window.fourComponentsRefresh();
                    }
                }, 500);
                
                return {
                    success: true,
                    nodesCount: importedCount,
                    skippedCount: skippedCount,
                    fileName: fileName,
                    message: `成功导入 ${importedCount} 个节点`
                };
                
            } catch (error) {
                console.error(`❌ [MD导入] 处理失败:`, error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // 🔥 旧版MD解析器已被NodeMind标准解析器v2.0替换
        // 此函数将在页面加载后被新解析器覆盖
        function parseImportedMDNodes_NEW(mdContent) {
            console.warn('⚠️ 正在使用旧版解析器，新版解析器尚未初始化');
            return [];
        }
        
        // 🎲 旧版节点处理函数 - 已被新解析器替换
        function generateNodeId(title) {
            console.warn('⚠️ 使用旧版generateNodeId，建议升级到新解析器');
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 6);
            const titleHash = title.slice(0, 10).replace(/[^a-zA-Z0-9]/g, '');
            return `node_${titleHash}_${timestamp}_${random}`;
        }

        function processNodeData(node) {
            console.warn('⚠️ 使用旧版processNodeData，建议升级到新解析器');
            if (!node.id) {
                node.id = generateNodeId(node.title);
            }
            if (!node.tags) {
                node.tags = [];
            }
            if (!node.time) {
                node.time = {
                    created: new Date().toLocaleString(),
                    modified: new Date().toLocaleString()
                };
            }
            if (!node.metadata) {
                node.metadata = {};
            }
            return node;
        }
        
        // 🔥 第三次重构：暴露MD直写机制到全局（模块化）
        // MD直写面板控制
        window.openMDDirectPanel = openMDDirectPanel;
        window.closeMDDirectPanel = closeMDDirectPanel;
        window.previewMDContent = previewMDContent;
        window.storeMDContent = storeMDContent;
        window.clearMDPanel = clearMDPanel;
        
        // MD文档导入导出（核心功能）
        window.importMDDocument = importMDDocument;
        window.processImportedMDDocument = processImportedMDDocument;
        window.importMDDocumentFromPanel = importMDDocumentFromPanel;
        window.exportToMDDocument = exportToMDDocument;
        window.downloadMDDocument = downloadMDDocument;
        
        // MD解析器核心（符合第三次重构规范）
        window.parseImportedMDNodes_NEW = parseImportedMDNodes_NEW;
        window.parseImportedMDNodes_FIXED = parseImportedMDNodes_NEW; // 兼容性别名
        window.processNodeData = processNodeData;
        window.generateNodeId = generateNodeId;
        
        // MD生成器 - NodeMind路径式解析器
        window.generateNodeMindStandardDocument = generateNodeMindStandardDocument;
        window.NodePathManager = NodePathManager;
        
        // 🔥 从MD面板导入文件
        async function importMDDocumentFromPanel() {
            try {
                
                const result = await importMDDocument();
                
                // 在面板中显示结果
                document.getElementById('md-result').innerHTML = `
                    <h4>✅ 导入成功</h4>
                    <div class="success-item"><strong>文件名</strong>: ${result.fileName}</div>
                    <div class="success-item"><strong>导入节点数</strong>: ${result.nodesCount}</div>
                    <div class="success-item"><strong>跳过节点数</strong>: ${result.skippedCount || 0}</div>
                    <div class="success-item"><strong>状态</strong>: ${result.message}</div>
                    <div class="success-note">
                        🎉 文档已成功导入到第三次重构的万能数据架构！
                        <br>💡 切换到四组件面板查看导入的节点内容
                    </div>
                `;
                
                // 自动关闭面板并切换到四组件
                setTimeout(() => {
                    closeMDDirectPanel();
                    // 切换到节点信息标签页
                    const injectionTab = document.getElementById('detail_tab_injection');
                    if (injectionTab) {
                        injectionTab.click();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('❌ [MD面板] 导入失败:', error);
                
                document.getElementById('md-result').innerHTML = `
                    <h4>❌ 导入失败</h4>
                    <div class="error-message">${error.message}</div>
                    <div class="error-note">
                        💡 请检查文件格式是否正确，确保是符合NodeMind标准的MD文档
                    </div>
                `;
            }
        }
        
        // 🚀 NodeMind标准解析器：按照项目元数据结构重构
        async function exportToMDDocument() {
            try {
                
                // 获取完整的NodeMind数据架构
                const nodeDatabase = await getNodeDatabase();
                const sessionDatabase = await getSessionDatabase();
                const mindmapData = await getMindmapDataWithHierarchy();
                const fourComponentData = await getFourComponentData();
                
                const projectInfo = {
                    name: '当前NodeMind项目',
                    description: '基于NodeMind的思维导图项目',
                    author: 'NodeMind用户',
                    version: '1.0.0'
                };
                
                // 使用新的路径式解析器生成MD文档
                const mdContent = generateNodeMindStandardDocument(
                    nodeDatabase, 
                    sessionDatabase, 
                    mindmapData, 
                    fourComponentData, 
                    projectInfo
                );
                
                
                // 生成文件名
                const fileName = `NodeMind_Export_${new Date().toISOString().split('T')[0]}.md`;
                
                // 保存MD文档
                await downloadMDDocument(mdContent, fileName);
                
                
                return {
                    success: true,
                    fileName: fileName,
                    contentLength: mdContent.length
                };
                
            } catch (error) {
                console.error('❌ [NodeMind标准解析器] 导出失败:', error);
                throw error;
            }
        }
        
        // 🆔 ID标准化管理器 - 项目拼音前五字符 + 自然递增编号
        class NodeIdManager {
            static projectPrefixCache = new Map();
            static nodeCounters = new Map();
            
            /**
             * 中文转拼音（简化版本）
             * @param {string} chinese - 中文字符串
             * @returns {string} 拼音字符串
             */
            static chineseToPinyin(chinese) {
                const pinyinMap = {
                    '项': 'xiang', '目': 'mu', '管': 'guan', '理': 'li', '思': 'si', '维': 'wei', 
                    '导': 'dao', '图': 'tu', '系': 'xi', '统': 'tong', '脑': 'nao', '图': 'tu',
                    '会': 'hui', '话': 'hua', '笔': 'bi', '记': 'ji', '任': 'ren', '务': 'wu',
                    '计': 'ji', '划': 'hua', '方': 'fang', '案': 'an', '设': 'she', '计': 'ji',
                    '开': 'kai', '发': 'fa', '测': 'ce', '试': 'shi', '部': 'bu', '署': 'shu',
                    '学': 'xue', '习': 'xi', '研': 'yan', '究': 'jiu', '文': 'wen', '档': 'dang',
                    '知': 'zhi', '识': 'shi', '库': 'ku', '数': 'shu', '据': 'ju', '分': 'fen',
                    '析': 'xi', '报': 'bao', '告': 'gao', '流': 'liu', '程': 'cheng', '业': 'ye',
                    '标': 'biao', '签': 'qian', '节': 'jie', '点': 'dian', '内': 'nei', '容': 'rong'
                };
                
                let pinyin = '';
                for (let char of chinese) {
                    if (pinyinMap[char]) {
                        pinyin += pinyinMap[char];
                    } else if (/[a-zA-Z0-9]/.test(char)) {
                        pinyin += char.toLowerCase();
                    }
                }
                return pinyin;
            }
            
            /**
             * 获取项目前缀（拼音前5字符）
             * @param {string} projectName - 项目名称
             * @returns {string} 标准化前缀
             */
            static getProjectPrefix(projectName) {
                if (this.projectPrefixCache.has(projectName)) {
                    return this.projectPrefixCache.get(projectName);
                }
                
                // 提取中文和英文混合名称的拼音
                const pinyin = this.chineseToPinyin(projectName);
                const prefix = pinyin.substring(0, 5).padEnd(5, 'x'); // 不足5位用x补齐
                
                this.projectPrefixCache.set(projectName, prefix);
                
                return prefix;
            }
            
            /**
             * 生成标准化节点ID
             * @param {string} projectName - 项目名称
             * @returns {string} 标准化ID（如：nodem1, nodem2, nodem123）
             */
            static generateNodeId(projectName = 'NodeMind项目') {
                const prefix = this.getProjectPrefix(projectName);
                
                // 获取或初始化计数器
                if (!this.nodeCounters.has(prefix)) {
                    this.nodeCounters.set(prefix, 0);
                }
                
                // 递增计数器
                let counter = this.nodeCounters.get(prefix) + 1;
                this.nodeCounters.set(prefix, counter);
                
                // 生成ID：前缀 + 自然递增编号（不限位数）
                const nodeId = `${prefix}${counter}`;
                
                return nodeId;
            }
            
            /**
             * 验证ID格式是否符合标准
             * @param {string} nodeId - 节点ID
             * @returns {boolean} 是否符合标准
             */
            static isStandardId(nodeId) {
                // 标准格式：5字符前缀 + 不限位数的数字
                const standardPattern = /^[a-z]{5}\d+$/;
                return standardPattern.test(nodeId);
            }
            
            /**
             * 从标准ID提取项目前缀
             * @param {string} nodeId - 标准节点ID
             * @returns {string} 项目前缀
             */
            static extractProjectPrefix(nodeId) {
                if (this.isStandardId(nodeId)) {
                    return nodeId.substring(0, 5);
                }
                return null;
            }
            
            /**
             * 从标准ID提取编号
             * @param {string} nodeId - 标准节点ID  
             * @returns {number} 节点编号
             */
            static extractNodeNumber(nodeId) {
                if (this.isStandardId(nodeId)) {
                    return parseInt(nodeId.substring(5), 10);
                }
                return null;
            }
            
            /**
             * 重置计数器（用于测试或重新开始）
             * @param {string} projectName - 项目名称
             */
            static resetCounter(projectName) {
                const prefix = this.getProjectPrefix(projectName);
                this.nodeCounters.set(prefix, 0);
            }
            
            /**
             * 获取项目统计信息
             * @param {string} projectName - 项目名称
             * @returns {object} 统计信息
             */
            static getProjectStats(projectName) {
                const prefix = this.getProjectPrefix(projectName);
                const count = this.nodeCounters.get(prefix) || 0;
                
                return {
                    projectName,
                    prefix,
                    nodeCount: count,
                    nextId: `${prefix}${count + 1}`
                };
            }
        }

        // 🎯 NodePathManager - 路径式节点关系管理器
        class NodePathManager {
            /**
             * 从路径获取节点层级
             */
            static getLevel(path) {
                return path.split('/').length - 1; // 减去脑图ID部分
            }
            
            /**
             * 从路径获取父节点ID
             */
            static getParentId(path) {
                const parts = path.split('/');
                return parts.length > 2 ? parts[parts.length - 2] : null;
            }
            
            /**
             * 从路径获取脑图ID
             */
            static getMapId(path) {
                return path.split('/')[0];
            }
            
            /**
             * 从路径获取节点ID
             */
            static getNodeId(path) {
                const parts = path.split('/');
                return parts[parts.length - 1];
            }
            
            /**
             * 构建子节点路径
             */
            static buildChildPath(parentPath, childId) {
                return `${parentPath}/${childId}`;
            }
            
            /**
             * 获取路径的所有祖先节点ID
             */
            static getAncestors(path) {
                const parts = path.split('/');
                return parts.slice(1, -1); // 去掉脑图ID和当前节点ID
            }
            
            /**
             * 检查是否为根节点
             */
            static isRoot(path) {
                return path.split('/').length === 2;
            }
            
            /**
             * 获取子节点路径列表
             */
            static getChildren(parentPath, allPaths) {
                return allPaths.filter(path => 
                    path.startsWith(parentPath + '/') && 
                    path.split('/').length === parentPath.split('/').length + 1
                );
            }
        }

        // 🎯 数据获取函数 - 按照NodeMind标准架构
        async function getNodeDatabase() {
            try {
                // 从localStorage获取nodeDatabase
                const storedNodeDB = localStorage.getItem('nodemind_node_database');
                let nodeDatabase = storedNodeDB ? JSON.parse(storedNodeDB) : {};
                
                // 同步脑图数据到nodeDatabase，确保路径信息完整
                const mindmapData = await getMindmapDataWithHierarchy();
                nodeDatabase = await syncMindmapDataWithNodeDatabase(mindmapData, nodeDatabase);
                
                return nodeDatabase;
            } catch (error) {
                console.error('获取nodeDatabase失败:', error);
                return {};
            }
        }

        async function getSessionDatabase() {
            try {
                const storedSessionDB = localStorage.getItem('nodemind_session_database');
                return storedSessionDB ? JSON.parse(storedSessionDB) : {};
            } catch (error) {
                console.error('获取sessionDatabase失败:', error);
                return {};
            }
        }

        async function getMindmapDataWithHierarchy() {
            try {
                const storedMindmapData = localStorage.getItem('nodemind_mindmap_data');
                return storedMindmapData ? JSON.parse(storedMindmapData) : {};
            } catch (error) {
                console.error('获取mindmapData失败:', error);
                return {};
            }
        }

        async function getFourComponentData() {
            try {
                const storedFourComponentData = localStorage.getItem('nodemind_four_component_data');
                return storedFourComponentData ? JSON.parse(storedFourComponentData) : {};
            } catch (error) {
                console.error('获取fourComponentData失败:', error);
                return {};
            }
        }

        // 🔄 增强的数据同步函数：确保路径信息完整且正确
        async function syncMindmapDataWithNodeDatabaseEnhanced(mindmapData, nodeDatabase) {
            
            let syncCount = 0;
            let newCount = 0;
            let pathUpdateCount = 0;
            let relationUpdateCount = 0;
            
            // 遍历所有思维导图
            Object.keys(mindmapData).forEach(mapId => {
                const mapData = mindmapData[mapId];
                if (mapData && mapData.data) {
                    // 递归遍历节点，生成完整的路径信息
                    traverseAndSyncNode(mapData.data, mapId, `${mapId}/${mapData.data.id}`, null);
                }
            });
            
            function traverseAndSyncNode(nodeData, mapId, nodePath, parentId) {
                const nodeId = nodeData.id;
                const cleanTitle = nodeData.topic ? nodeData.topic.replace(' 📄', '') : '未命名节点';
                
                // 确保nodeDatabase中存在对应记录
                if (!nodeDatabase[nodeId]) {
                    // 创建新的节点记录
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: cleanTitle,
                        topic: cleanTitle,
                        content: '',
                        sessions: [],
                        author: 'NodeMind',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        tags: { categories: [], technical: [], status: [] }
                    };
                    newCount++;
                } else {
                    // 更新现有节点的标题
                    if (nodeDatabase[nodeId].title !== cleanTitle) {
                        nodeDatabase[nodeId].title = cleanTitle;
                        nodeDatabase[nodeId].topic = cleanTitle;
                        nodeDatabase[nodeId].modified = new Date().toISOString();
                    }
                    syncCount++;
                }
                
                // 🔑 关键：更新路径信息（必须有）
                const oldPath = nodeDatabase[nodeId].path;
                nodeDatabase[nodeId].path = nodePath;
                nodeDatabase[nodeId].mapId = mapId;
                nodeDatabase[nodeId].level = NodePathManager.getLevel(nodePath);
                
                if (oldPath !== nodePath) {
                    pathUpdateCount++;
                }
                
                // 🔑 关键：更新关系信息（必须有）
                const childrenIds = nodeData.children ? 
                    nodeData.children.map(child => child.id) : 
                    [];
                
                const oldRelations = nodeDatabase[nodeId].relations;
                nodeDatabase[nodeId].relations = {
                    parent: parentId,
                    children: childrenIds
                };
                
                if (!oldRelations || oldRelations.parent !== parentId || 
                    JSON.stringify(oldRelations.children) !== JSON.stringify(childrenIds)) {
                    relationUpdateCount++;
                }
                
                // 更新其他元数据
                if (nodeData.direction) {
                    nodeDatabase[nodeId].direction = nodeData.direction;
                }
                if (nodeData.expanded !== undefined) {
                    nodeDatabase[nodeId].expanded = nodeData.expanded;
                }
                
                // 递归处理子节点
                if (nodeData.children) {
                    nodeData.children.forEach(child => {
                        const childPath = NodePathManager.buildChildPath(nodePath, child.id);
                        traverseAndSyncNode(child, mapId, childPath, nodeId);
                    });
                }
            }
            
            
            // 保存同步后的数据到localStorage
            try {
                localStorage.setItem('nodemind_node_database', JSON.stringify(nodeDatabase));
            } catch (error) {
                console.error('❌ [数据持久化] 保存失败:', error);
            }
            
            return nodeDatabase;
        }

        // 🎯 数据融合函数：确保jsMind与nodeDatabase同步并生成路径信息（兼容旧版本）
        async function syncMindmapDataWithNodeDatabase(mindmapData, nodeDatabase) {
            
            // 遍历所有思维导图
            Object.keys(mindmapData).forEach(mapId => {
                const mapData = mindmapData[mapId];
                if (mapData && mapData.data) {
                    // 递归遍历节点，生成路径信息
                    traverseAndSyncNode(mapData.data, mapId, `${mapId}/${mapData.data.id}`);
                }
            });
            
            function traverseAndSyncNode(nodeData, mapId, nodePath) {
                const nodeId = nodeData.id;
                
                // 确保nodeDatabase中存在对应记录
                if (!nodeDatabase[nodeId]) {
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: nodeData.topic || '未命名节点',
                        topic: nodeData.topic || '未命名节点',
                        content: '',
                        sessions: [],
                        author: 'NodeMind',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        tags: { categories: [], technical: [], status: [] }
                    };
                }
                
                // 更新路径信息
                nodeDatabase[nodeId].path = nodePath;
                nodeDatabase[nodeId].mapId = mapId;
                nodeDatabase[nodeId].level = NodePathManager.getLevel(nodePath);
                
                // 更新关系信息
                const parentId = NodePathManager.getParentId(nodePath);
                const childrenPaths = nodeData.children ? 
                    nodeData.children.map(child => NodePathManager.buildChildPath(nodePath, child.id)) : 
                    [];
                const childrenIds = nodeData.children ? 
                    nodeData.children.map(child => child.id) : 
                    [];
                
                nodeDatabase[nodeId].relations = {
                    parent: parentId,
                    children: childrenIds
                };
                
                // 更新其他元数据
                if (nodeData.direction) {
                    nodeDatabase[nodeId].direction = nodeData.direction;
                }
                
                // 递归处理子节点
                if (nodeData.children) {
                    nodeData.children.forEach(child => {
                        const childPath = NodePathManager.buildChildPath(nodePath, child.id);
                        traverseAndSyncNode(child, mapId, childPath);
                    });
                }
            }
            
            return nodeDatabase;
        }

        // 🚀 NodeMind标准MD文档生成器 - 按照项目元数据结构重构（集成ID标准化）
        function generateNodeMindStandardDocument(nodeDatabase, sessionDatabase, mindmapData, fourComponentData, projectInfo) {
            const lines = [];
            const currentTime = new Date().toLocaleString();
            const isoTime = new Date().toISOString();
            const projectName = projectInfo.name || 'NodeMind项目';
            
            // 📄 文档头部（NodeMind路径式标准格式）
            lines.push(`# ${projectName}`);
            lines.push('');
            lines.push(`> 📝 **NodeMind路径式标准MD文档** - 支持完整脑图恢复，包含路径关系和会话数据`);
            lines.push(`> 🆔 **ID标准化规则**: ${NodeIdManager.getProjectPrefix(projectName)}x (项目拼音前缀 + 自然递增编号)`);
            lines.push('');
            
            // 📋 项目元信息
            lines.push(`## 📋 项目信息`);
            lines.push('');
            lines.push(`| 属性 | 值 |`);
            lines.push(`|------|-----|`);
            lines.push(`| 项目名称 | ${projectName} |`);
            lines.push(`| 项目描述 | ${projectInfo.description || '基于NodeMind的思维导图项目'} |`);
            lines.push(`| 作者 | ${projectInfo.author || 'NodeMind用户'} |`);
            lines.push(`| 版本 | ${projectInfo.version || '1.0.0'} |`);
            lines.push(`| ID前缀 | ${NodeIdManager.getProjectPrefix(projectName)} |`);
            lines.push(`| ID格式 | ${NodeIdManager.getProjectPrefix(projectName)}1, ${NodeIdManager.getProjectPrefix(projectName)}2, ... |`);
            lines.push(`| 数据格式 | NodeMind路径式架构 v2.0 + ID标准化 |`);
            lines.push(`| 解析器版本 | 路径式节点关系管理器 + ID标准化管理器 |`);
            lines.push(`| 导出时间 | ${currentTime} |`);
            lines.push(`| ISO时间戳 | ${isoTime} |`);
            lines.push('');
            
            // 📊 完整统计信息
            const totalNodes = Object.keys(nodeDatabase).length;
            const fourComponentNodes = Object.keys(fourComponentData || {}).length;
            const sessionNodes = Object.keys(sessionDatabase || {}).length;
            const totalSessions = Object.values(sessionDatabase || {}).reduce((sum, nodeSession) => 
                sum + (nodeSession.sessions ? nodeSession.sessions.length : 0), 0);
            
            // 脑图统计
            const mindmapStats = {};
            Object.keys(mindmapData || {}).forEach(mapId => {
                const mapData = mindmapData[mapId];
                if (mapData && mapData.data) {
                    mindmapStats[mapId] = countNodesInMap(mapData.data);
                }
            });
            
            lines.push(`## 📊 数据统计`);
            lines.push('');
            lines.push(`### 🔢 节点统计`);
            lines.push('');
            lines.push(`| 统计项 | 数量 |`);
            lines.push(`|--------|------|`);
            lines.push(`| 总节点数 | ${totalNodes} |`);
            lines.push(`| 四组件节点 | ${fourComponentNodes} |`);
            lines.push(`| 有会话节点 | ${sessionNodes} |`);
            lines.push(`| 总会话数 | ${totalSessions} |`);
            lines.push('');
            
            lines.push(`### 🗺️ 脑图统计`);
            lines.push('');
            lines.push(`| 脑图ID | 节点数量 | 脑图名称 |`);
            lines.push(`|--------|----------|----------|`);
            Object.keys(mindmapStats).forEach(mapId => {
                const mapData = mindmapData[mapId];
                const mapName = mapData?.meta?.name || '未命名脑图';
                lines.push(`| ${mapId} | ${mindmapStats[mapId]} | ${mapName} |`);
            });
            lines.push('');
            lines.push('---');
            lines.push('');
            
            // 🗂️ 节点数据（按路径层次排序）
            lines.push(`## 🗂️ 节点数据`);
            lines.push('');
            lines.push(`> 采用路径式节点关系表达，支持完整脑图结构恢复`);
            lines.push('');
            
            // 按路径排序，保持层次结构
            const sortedNodes = Object.entries(nodeDatabase).sort(([aId, aData], [bId, bData]) => {
                const pathA = aData.path || `unknown/${aId}`;
                const pathB = bData.path || `unknown/${bId}`;
                return pathA.localeCompare(pathB);
            });
            
            // 按脑图分组
            const nodesByMap = {};
            sortedNodes.forEach(([nodeId, nodeData]) => {
                const mapId = nodeData.mapId || 'unknown';
                if (!nodesByMap[mapId]) {
                    nodesByMap[mapId] = [];
                }
                nodesByMap[mapId].push([nodeId, nodeData]);
            });
            
            // 生成每个脑图的节点数据
            Object.keys(nodesByMap).forEach(mapId => {
                const mapData = mindmapData[mapId];
                const mapName = mapData?.meta?.name || '未命名脑图';
                
                lines.push(`### 🗺️ 脑图: ${mapName} (${mapId})`);
                lines.push('');
                
                nodesByMap[mapId].forEach(([nodeId, nodeData]) => {
                    // 节点标题（层次化显示）
                    const level = Math.max(4, Math.min(nodeData.level + 3, 6)); // 从####开始，最多######
                    const headerPrefix = '#'.repeat(level);
                    const nodeTitle = (nodeData.title || nodeData.topic || '未命名节点').replace(/[#\n\r]/g, '');
                    
                    lines.push(`${headerPrefix} ${nodeTitle}`);
                    lines.push('');
                    
                    // 节点元数据（路径式）
                    lines.push(`**节点元数据**:`);
                    lines.push('');
                    // 🔒 固定必须有的核心信息表格（ID、标题+内容、节点关系路径、时间戳）
                    lines.push('**核心信息**:');
                    lines.push('');
                    lines.push(`| 属性 | 值 |`);
                    lines.push(`|------|-----|`);
                    lines.push(`| 节点ID | \`${nodeId}\` |`);
                    
                    // ID标准化检查
                    const isStandardId = NodeIdManager.isStandardId(nodeId);
                    if (isStandardId) {
                        const idPrefix = NodeIdManager.extractProjectPrefix(nodeId);
                        const idNumber = NodeIdManager.extractNodeNumber(nodeId);
                        lines.push(`| ID格式 | ✅ 标准 (${idPrefix}-${idNumber}) |`);
                    } else {
                        lines.push(`| ID格式 | ⚠️ 非标准格式 |`);
                    }
                    
                    // 🔒 节点关系路径（固定必须有，始终显示）
                    const parentId = nodeData.relations?.parent || null;
                    const childrenIds = nodeData.relations?.children || [];
                    
                    // 父子关系信息
                    if (parentId) {
                        lines.push(`| 父节点 | \`${parentId}\` |`);
                    } else {
                        lines.push(`| 父节点 | 无（根节点） |`);
                    }
                    
                    if (childrenIds.length > 0) {
                        lines.push(`| 子节点 | ${childrenIds.map(id => `\`${id}\``).join(', ')} |`);
                        lines.push(`| 子节点数 | ${childrenIds.length} |`);
                    } else {
                        lines.push(`| 子节点 | 无 |`);
                        lines.push(`| 子节点数 | 0 |`);
                    }
                    
                    // 路径关系信息
                    lines.push(`| 节点路径 | \`${nodeData.path || '未定义路径'}\` |`);
                    lines.push(`| 节点层级 | ${nodeData.level || '未定义'} |`);
                    lines.push(`| 所属脑图 | ${nodeData.mapId || '未定义'} |`);
                    lines.push(`| 方向 | ${nodeData.direction || '未定义'} |`);
                    
                    // 🔒 时间戳（固定必须有，始终显示）
                    lines.push(`| 创建时间 | ${nodeData.created || '未定义'} |`);
                    lines.push(`| 修改时间 | ${nodeData.modified || '未定义'} |`);
                    
                    lines.push('');
                    
                    // 📝 可选部分（有值才显示）
                    
                    // 标签系统（如果有）
                    if (nodeData.tags) {
                        const allTags = [
                            ...(nodeData.tags.categories || []).map(tag => `#${tag}(分类)`),
                            ...(nodeData.tags.technical || []).map(tag => `#${tag}(技术)`),
                            ...(nodeData.tags.status || []).map(tag => `#${tag}(状态)`),
                            ...(nodeData.tags.custom || []).map(tag => `#${tag}(自定义)`)
                        ];
                        
                        if (allTags.length > 0) {
                            lines.push('**标签分类**:');
                            lines.push('');
                            lines.push(allTags.join(' '));
                            lines.push('');
                        }
                    }
                    
                    // 展开状态（如果有）
                    if (nodeData.expanded !== undefined) {
                        lines.push('**展开状态**:');
                        lines.push('');
                        lines.push(`- 子节点展开: ${nodeData.expanded ? '✅ 已展开' : '❌ 已折叠'}`);
                        lines.push('');
                    }
                    
                    // 作者信息（如果有且非默认）
                    if (nodeData.author && nodeData.author !== 'NodeMind') {
                        lines.push('**作者信息**:');
                        lines.push('');
                        lines.push(`- 作者: ${nodeData.author}`);
                        lines.push('');
                    }
                    
                    // 🔒 节点内容（固定必须有）
                    lines.push('**节点内容**:');
                    lines.push('');
                    if (nodeData.content && nodeData.content.trim()) {
                        lines.push('```text');
                        lines.push(nodeData.content.trim());
                        lines.push('```');
                    } else {
                        lines.push('*暂无内容*');
                    }
                    lines.push('');
                    
                    // 会话数据（重要新增）
                    const nodeSessions = sessionDatabase[nodeId];
                    if (nodeSessions && nodeSessions.sessions && nodeSessions.sessions.length > 0) {
                        lines.push('**会话记录**:');
                        lines.push('');
                        lines.push(`| 会话ID | 标题 | 类型 | 创建时间 |`);
                        lines.push(`|--------|------|------|----------|`);
                        
                        nodeSessions.sessions.forEach(session => {
                            lines.push(`| \`${session.id}\` | ${session.title || '无标题'} | ${session.type || 'note'} | ${session.timestamp || '未知'} |`);
                        });
                        lines.push('');
                        
                        // 详细会话内容
                        nodeSessions.sessions.forEach((session, index) => {
                            lines.push(`**会话 ${index + 1}: ${session.title || '无标题'}**`);
                            lines.push('');
                            if (session.content && session.content.trim()) {
                                lines.push('```text');
                                lines.push(session.content.trim());
                                lines.push('```');
                            } else {
                                lines.push('*暂无会话内容*');
                            }
                            lines.push('');
                        });
                    } else {
                        lines.push('**会话记录**: *暂无会话*');
                        lines.push('');
                    }
                    
                    // 分隔线
                    lines.push('---');
                    lines.push('');
                });
            });
            
            // 📋 导入指南（更新版）
            lines.push('## 💡 导入指南');
            lines.push('');
            lines.push('### 🔄 如何导入此文档');
            lines.push('');
            lines.push('1. **打开NodeMind应用**');
            lines.push('2. **点击"导入MD文档"按钮**');
            lines.push('3. **选择此MD文件**');
            lines.push('4. **系统将自动解析路径关系并恢复所有数据**');
            lines.push('');
            lines.push('### ✅ 支持的数据恢复');
            lines.push('');
            lines.push('- ✅ **路径式节点关系**: 完整保持父子关系和层次结构');
            lines.push('- ✅ **多脑图数据**: 支持多个思维导图的完整恢复');
            lines.push('- ✅ **会话系统**: 节点关联的所有会话记录');
            lines.push('- ✅ **四组件数据**: 节点详情面板的完整状态');
            lines.push('- ✅ **标签系统**: 分类、技术、状态标签的完整分类');
            lines.push('- ✅ **元数据**: 创建时间、修改时间、作者信息');
            lines.push('');
            lines.push('### 🛠️ 格式规范');
            lines.push('');
            lines.push('- **文档格式**: NodeMind路径式标准 v2.0');
            lines.push('- **路径格式**: `mapId/nodeId/nodeId/...`');
            lines.push('- **编码格式**: UTF-8');
            lines.push('- **换行符**: 标准LF格式');
            lines.push('- **解析器**: NodePathManager路径式关系管理器');
            lines.push('');
            lines.push(`---`);
            lines.push('');
            lines.push(`**文档生成信息**:`);
            lines.push(`- 生成时间: ${currentTime}`);
            lines.push(`- 格式版本: NodeMind路径式标准 v2.0`);
            lines.push(`- 源数据: nodeDatabase (${totalNodes} 个节点), sessionDatabase (${totalSessions} 个会话)`);
            lines.push(`- 导出工具: NodeMind路径式解析器`);
            lines.push(`- 架构: 多层数据架构 + 路径式关系管理`);
            
            return lines.join('\n');
        }

        // 📊 辅助函数：计算脑图中的节点数量
        function countNodesInMap(nodeData) {
            if (!nodeData) return 0;
            
            let count = 1; // 当前节点
            if (nodeData.children) {
                nodeData.children.forEach(child => {
                    count += countNodesInMap(child);
                });
            }
            return count;
        }
        
        // 🎯 保存格式选择对话框 - 与解析器一致的版本
        function showSaveFormatDialog() {
            const dialog = confirm(
                '请选择保存格式：\n\n' +
                '📊 点击"确定"：保存为JSON格式（包含完整脑图数据）\n' +
                '📝 点击"取消"：保存为MD格式（NodeMind路径式标准，完美复现）\n\n' +
                '💡 建议：\n' +
                '- JSON格式：适合备份和数据交换\n' +
                '- MD格式：符合NodeMind解析器标准，支持完整脑图恢复\n' +
                '- MD格式包含：节点关系路径、会话数据、四组件状态、标签系统'
            );
            
            if (dialog) {
                // 用户选择JSON格式
                saveProjectMindmap();
            } else {
                // 用户选择MD格式 - 使用标准解析器
                exportToMDDocumentWithStandardParser();
            }
        }

        // 🚀 使用NodeMind标准解析器导出MD文档 - 保证完美复现
        async function exportToMDDocumentWithStandardParser() {
            try {
                showMessage('🔄 正在生成NodeMind标准MD文档...', 3000);
                
                // 🔄 第一步：数据完整性检查与同步
                
                // 获取完整的NodeMind数据架构
                let nodeDatabase = await getNodeDatabase();
                const sessionDatabase = await getSessionDatabase();
                let mindmapData = await getMindmapDataWithHierarchy();
                const fourComponentData = await getFourComponentData();
                
                // 强制数据同步，确保路径信息完整
                nodeDatabase = await syncMindmapDataWithNodeDatabaseEnhanced(mindmapData, nodeDatabase);
                
                // 验证关键数据完整性
                const nodeCount = Object.keys(nodeDatabase).length;
                const sessionCount = Object.keys(sessionDatabase).length;
                const mindmapCount = Object.keys(mindmapData).length;
                
                
                if (nodeCount === 0) {
                    throw new Error('没有可保存的节点数据');
                }
                
                // 🔄 第二步：路径关系验证
                let pathValidationCount = 0;
                let relationValidationCount = 0;
                
                Object.values(nodeDatabase).forEach(node => {
                    if (node.path) pathValidationCount++;
                    if (node.relations) relationValidationCount++;
                });
                
                
                // 🔄 第三步：项目信息准备
                const projectInfo = {
                    name: '当前NodeMind项目',
                    description: '基于NodeMind路径式架构的思维导图项目，支持完整脑图恢复',
                    author: 'NodeMind用户',
                    version: '2.0.0',
                    exportTime: new Date().toISOString(),
                    dataFormat: 'NodeMind路径式标准 v2.0 + ID标准化',
                    parserVersion: '路径式节点关系管理器 + ID标准化管理器'
                };
                
                // 🔄 第四步：生成标准MD文档
                const mdContent = generateNodeMindStandardDocument(
                    nodeDatabase, 
                    sessionDatabase, 
                    mindmapData, 
                    fourComponentData, 
                    projectInfo
                );
                
                // 验证生成的内容
                if (!mdContent || mdContent.length < 100) {
                    throw new Error('生成的MD文档内容异常');
                }
                
                
                // 🔄 第五步：文件名生成
                const timestamp = new Date().toISOString().split('T')[0];
                const fileName = `NodeMind_标准导出_${timestamp}.md`;
                
                
                // 🔄 第六步：保存到文件系统
                await saveStandardMDDocument(mdContent, fileName);
                
                // 🔄 第七步：验证保存结果
                showMessage(`✅ NodeMind标准MD文档已导出: ${fileName}`, 4000, 'success');
                
                // 返回导出结果
                return {
                    success: true,
                    fileName: fileName,
                    contentLength: mdContent.length,
                    nodeCount: nodeCount,
                    sessionCount: sessionCount,
                    mindmapCount: mindmapCount,
                    pathValidationCount: pathValidationCount,
                    relationValidationCount: relationValidationCount
                };
                
            } catch (error) {
                console.error('❌ [NodeMind标准解析器] 导出失败:', error);
                showMessage(`❌ 导出失败: ${error.message}`, 5000, 'error');
                throw error;
            }
        }

        // 📥 保存NodeMind标准MD文档 - 强制使用文件选择器
        async function saveStandardMDDocument(content, fileName) {
            try {
                
                // 检查浏览器兼容性
                if (!window.showSaveFilePicker) {
                    throw new Error('您的浏览器不支持文件选择器API，请使用Chrome 86+或Edge 86+');
                }
                
                // 🔒 强制使用文件选择器保存（不降级到下载模式）
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'NodeMind标准MD文档',
                            accept: {
                                'text/markdown': ['.md'],
                                'text/plain': ['.md', '.txt']
                            }
                        }
                    ]
                });
                
                // 写入文件
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                showMessage('✅ NodeMind标准MD文档已成功保存到指定位置', 3000, 'success');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('🚫 用户取消了文件保存', 2000);
                } else {
                    console.error('❌ [文件保存] 保存失败:', error);
                    showMessage(`❌ 保存失败: ${error.message}`, 4000, 'error');
                    throw error;
                }
            }
        }

        // 📥 保存MD文档 - 强制使用文件选择器（兼容旧版本）
        async function downloadMDDocument(content, fileName) {
            try {
                // 🔒 强制使用文件选择器保存（不降级到下载模式）
                    await saveWithFileSystemAPIMD(content, fileName);
            } catch (error) {
                console.error('❌ MD文档保存失败:', error);
                if (error.name === 'AbortError') {
                    showMessage('🚫 用户取消了文件保存');
                } else {
                    showMessage('❌ 保存失败: 您的浏览器可能不支持文件选择器，请使用Chrome或Edge浏览器');
                }
            }
        }
        
        // 使用现代文件系统API保存MD文档
        async function saveWithFileSystemAPIMD(content, fileName) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'Markdown文档',
                            accept: {
                                'text/markdown': ['.md'],
                                'text/plain': ['.md', '.txt']
                            }
                        }
                    ]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                showMessage('✅ MD文档已成功保存到指定位置');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('🚫 用户取消了文件保存');
                } else {
                    console.error('❌ MD文件选择器保存失败:', error);
                    throw error; // 重新抛出错误以便上层处理
                }
            }
        }
        
        // 暴露必要的全局函数
        window.initThirdReconstructionArchitecture = initThirdReconstructionArchitecture;

        // 🚀 集成新的NodeMind标准解析器 v2.0
        let standardParser = null;
        
        // 初始化新解析器
        function initStandardParser() {
            try {
                if (window.NodeMindStandardParser) {
                    standardParser = new window.NodeMindStandardParser();
                    
                    // 替换旧的解析函数
                    window.parseImportedMDNodes_NEW = async function(mdContent) {
                        const result = await standardParser.parseMDToNodeMind(mdContent);
                        
                        // 转换为兼容旧格式的节点数组
                        const nodes = Object.values(result.nodeDatabase).map(node => ({
                            id: node.id,
                            title: node.title,
                            content: node.content,
                            level: node.level,
                            path: node.path,
                            tags: Object.values(node.tags || {}).flat(),
                            author: node.author,
                            priority: 'medium',
                            status: 'pending',
                            time: {
                                created: node.created,
                                modified: node.modified
                            },
                            metadata: node.metadata
                        }));
                        
                        return nodes;
                    };
                    
                    // 替换旧的生成函数
                    window.generateNodeMindStandardDocument = function(nodeDatabase, sessionDatabase, mindmapData, fourComponentData, projectInfo) {
                        return standardParser.generateStandardMD(nodeDatabase, sessionDatabase, mindmapData, projectInfo);
                    };
                    
                    return true;
                } else {
                    console.warn('⚠️ [NodeMind标准解析器] 解析器文件未加载');
                    return false;
                }
            } catch (error) {
                console.error('❌ [NodeMind标准解析器] 初始化失败:', error);
                return false;
            }
        }
        
        // 页面加载完成后初始化新解析器
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const success = initStandardParser();
                if (success) {
                } else {
                    console.warn('⚠️ [NodeMind v2.0] 解析器初始化失败，将继续使用旧版解析器');
                }
            }, 1000);
        });
        
        // 暴露新解析器到全局
        window.standardParser = standardParser;
        window.initStandardParser = initStandardParser;
        
    </script>
</body>
</html> 