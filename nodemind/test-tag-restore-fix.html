<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ‡ç­¾æ¢å¤ä¿®å¤æµ‹è¯• - ç¬¬ä¸‰æ¬¡é‡æ„ç‰ˆæœ¬</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            border: 2px solid #e0e0e0;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #content-editor {
            width: 100%;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        .tag-groups {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .tag-group {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            min-width: 200px;
        }
        .tag-group-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }
        .tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 3px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .tag:hover {
            background: #dee2e6;
            transform: translateY(-1px);
        }
        .tag.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ·ï¸ æ ‡ç­¾æ¢å¤ä¿®å¤æµ‹è¯• - ç¬¬ä¸‰æ¬¡é‡æ„ç‰ˆæœ¬</h1>
        
        <div class="status">
            <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯æ ‡ç­¾çŠ¶æ€åœ¨åˆ‡æ¢èŠ‚ç‚¹åèƒ½æ­£ç¡®æ¢å¤æ˜¾ç¤º<br>
            <strong>ä¿®å¤æ–¹æ¡ˆï¼š</strong>åˆ é™¤nodeDatabaseæ“ä½œé€»è¾‘ï¼Œåªä»MDå†…å®¹ä¸­è¯»å–å’Œæ¢å¤æ ‡ç­¾<br>
            <strong>ç¬¦åˆç¬¬ä¸‰æ¬¡é‡æ„ç†å¿µï¼š</strong>ä¸‡ç‰©çš†MDï¼Œæ ‡ç­¾å³æ–‡æœ¬
        </div>

        <div class="test-section">
            <h3>ğŸ“ 1. å†…å®¹ç¼–è¾‘å™¨ï¼ˆæ¨¡æ‹Ÿå››ç»„ä»¶ï¼‰</h3>
            <textarea id="content-editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥å†…å®¹å’Œæ ‡ç­¾ï¼Œå¦‚ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å†…å®¹ #æƒ³æ³• #å‰ç«¯ #å¾…åŠ">è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•èŠ‚ç‚¹ #æƒ³æ³• #å‰ç«¯ #å¾…åŠ</textarea>
        </div>

        <div class="test-section">
            <h3>ğŸ·ï¸ 2. æ ‡ç­¾ç»„ï¼ˆç‚¹å‡»å¯æ·»åŠ /ç§»é™¤æ ‡ç­¾ï¼‰</h3>
            <div id="tag-groups" class="tag-groups">
                <div class="tag-group">
                    <div class="tag-group-title">ğŸ“‚ åˆ†ç±»æ ‡ç­¾</div>
                    <div class="tag-group-items">
                        <span class="tag" data-tag="æƒ³æ³•" data-group="åˆ†ç±»æ ‡ç­¾">æƒ³æ³•</span>
                        <span class="tag" data-tag="è®¡åˆ’" data-group="åˆ†ç±»æ ‡ç­¾">è®¡åˆ’</span>
                        <span class="tag" data-tag="ç¬”è®°" data-group="åˆ†ç±»æ ‡ç­¾">ç¬”è®°</span>
                        <span class="tag" data-tag="æ€»ç»“" data-group="åˆ†ç±»æ ‡ç­¾">æ€»ç»“</span>
                        <span class="tag" data-tag="é—®é¢˜" data-group="åˆ†ç±»æ ‡ç­¾">é—®é¢˜</span>
                        <span class="tag" data-tag="æ–¹æ¡ˆ" data-group="åˆ†ç±»æ ‡ç­¾">æ–¹æ¡ˆ</span>
                    </div>
                </div>
                
                <div class="tag-group">
                    <div class="tag-group-title">âš™ï¸ æŠ€æœ¯æ ‡ç­¾</div>
                    <div class="tag-group-items">
                        <span class="tag" data-tag="å‰ç«¯" data-group="æŠ€æœ¯æ ‡ç­¾">å‰ç«¯</span>
                        <span class="tag" data-tag="åç«¯" data-group="æŠ€æœ¯æ ‡ç­¾">åç«¯</span>
                        <span class="tag" data-tag="æ•°æ®åº“" data-group="æŠ€æœ¯æ ‡ç­¾">æ•°æ®åº“</span>
                        <span class="tag" data-tag="API" data-group="æŠ€æœ¯æ ‡ç­¾">API</span>
                        <span class="tag" data-tag="ç®—æ³•" data-group="æŠ€æœ¯æ ‡ç­¾">ç®—æ³•</span>
                        <span class="tag" data-tag="æ¶æ„" data-group="æŠ€æœ¯æ ‡ç­¾">æ¶æ„</span>
                    </div>
                </div>
                
                <div class="tag-group">
                    <div class="tag-group-title">ğŸ“Š çŠ¶æ€æ ‡ç­¾</div>
                    <div class="tag-group-items">
                        <span class="tag" data-tag="å¾…åŠ" data-group="çŠ¶æ€æ ‡ç­¾">å¾…åŠ</span>
                        <span class="tag" data-tag="è¿›è¡Œä¸­" data-group="çŠ¶æ€æ ‡ç­¾">è¿›è¡Œä¸­</span>
                        <span class="tag" data-tag="å·²å®Œæˆ" data-group="çŠ¶æ€æ ‡ç­¾">å·²å®Œæˆ</span>
                        <span class="tag" data-tag="å·²éªŒè¯" data-group="çŠ¶æ€æ ‡ç­¾">å·²éªŒè¯</span>
                        <span class="tag" data-tag="æš‚åœ" data-group="çŠ¶æ€æ ‡ç­¾">æš‚åœ</span>
                        <span class="tag" data-tag="å–æ¶ˆ" data-group="çŠ¶æ€æ ‡ç­¾">å–æ¶ˆ</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª 3. æµ‹è¯•æ“ä½œ</h3>
            <button class="button" onclick="testScenario1()">æµ‹è¯•åœºæ™¯1ï¼šåŸºç¡€æ ‡ç­¾åˆ‡æ¢</button>
            <button class="button" onclick="testScenario2()">æµ‹è¯•åœºæ™¯2ï¼šæ¨¡æ‹ŸèŠ‚ç‚¹åˆ‡æ¢</button>
            <button class="button" onclick="testScenario3()">æµ‹è¯•åœºæ™¯3ï¼šå¤æ‚æ ‡ç­¾ç»„åˆ</button>
            <button class="button" onclick="manualRestore()">æ‰‹åŠ¨æ¢å¤æ ‡ç­¾</button>
            <button class="button" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ 4. æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸèŠ‚ç‚¹ID
        let currentNodeId = 'test-node-1';
        
        // æµ‹è¯•æ—¥å¿—
        function log(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // ç¬¬ä¸‰æ¬¡é‡æ„ç‰ˆæœ¬ï¼šæ ‡ç­¾åˆ‡æ¢ï¼ˆåªæ“ä½œå†…å®¹ï¼‰
        function fourComponentToggleTag(tagElement) {
            const tagName = tagElement.dataset.tag;
            const tagGroup = tagElement.dataset.group;
            
            log(`ğŸ·ï¸ æ ‡ç­¾æ“ä½œ: ${tagName} (${tagGroup})`);
            
            const contentEditor = document.getElementById('content-editor');
            if (!contentEditor) {
                log('âŒ æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨');
                return;
            }
            
            let content = contentEditor.value;
            const tagString = `#${tagName}`;
            
            // åˆ‡æ¢æ ‡ç­¾çŠ¶æ€
            if (tagElement.classList.contains('selected')) {
                // ç§»é™¤æ ‡ç­¾
                tagElement.classList.remove('selected');
                content = content.replace(new RegExp(`\\s*${tagString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*`, 'g'), ' ').trim();
                log(`ğŸ—‘ï¸ å·²ç§»é™¤æ ‡ç­¾ï¼š${tagName}`);
            } else {
                // æ·»åŠ æ ‡ç­¾
                tagElement.classList.add('selected');
                content = content + (content ? ' ' : '') + tagString;
                log(`âœ… å·²æ·»åŠ æ ‡ç­¾ï¼š${tagName}`);
            }
            
            // ç«‹å³æ›´æ–°å†…å®¹ç¼–è¾‘å™¨
            contentEditor.value = content;
            log(`ğŸ“ å†…å®¹å·²æ›´æ–°: ${content}`);
        }

        // ç¬¬ä¸‰æ¬¡é‡æ„ç‰ˆæœ¬ï¼šä»MDå†…å®¹ä¸­æ™ºèƒ½æ¢å¤æ ‡ç­¾çŠ¶æ€
        function restoreFourComponentTagStates(nodeId) {
            if (!nodeId) {
                log('âš ï¸ restoreFourComponentTagStates: ç¼ºå°‘èŠ‚ç‚¹ID');
                return;
            }
            
            log(`ğŸ”„ [ç¬¬ä¸‰æ¬¡é‡æ„] æ¢å¤æ ‡ç­¾çŠ¶æ€: ${nodeId}`);
            
            // æ¸…é™¤æ‰€æœ‰æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            
            // ä»å†…å®¹ç¼–è¾‘å™¨è·å–MDå†…å®¹
            const contentEditor = document.getElementById('content-editor');
            if (!contentEditor) {
                log('âš ï¸ æ‰¾ä¸åˆ°å†…å®¹ç¼–è¾‘å™¨ï¼Œæ— æ³•æ¢å¤æ ‡ç­¾çŠ¶æ€');
                return;
            }
            
            const content = contentEditor.value;
            log(`ğŸ“‹ åˆ†æMDå†…å®¹ä¸­çš„æ ‡ç­¾: "${content.substring(0, 50)}..."`);
            
            // æ™ºèƒ½æå–æ ‡ç­¾ï¼ˆæ”¯æŒ #æ ‡ç­¾ æ ¼å¼ï¼‰
            const tagMatches = content.match(/#[\u4e00-\u9fa5\w]+/g); // æ”¯æŒä¸­æ–‡æ ‡ç­¾
            
            if (tagMatches && tagMatches.length > 0) {
                log(`ğŸ·ï¸ å‘ç° ${tagMatches.length} ä¸ªæ ‡ç­¾: ${tagMatches.join(', ')}`);
                
                let restoredCount = 0;
                tagMatches.forEach(tagMatch => {
                    const tagName = tagMatch.substring(1); // ç§»é™¤ # ç¬¦å·
                    const tagElement = document.querySelector(`[data-tag="${tagName}"]`);
                    
                    if (tagElement) {
                        tagElement.classList.add('selected');
                        restoredCount++;
                        log(`âœ… æ¢å¤æ ‡ç­¾: ${tagName}`);
                    } else {
                        log(`âš ï¸ æ ‡ç­¾ä¸åœ¨å½“å‰æ ‡ç­¾ç»„ä¸­: ${tagName}`);
                    }
                });
                
                log(`âœ… [ç¬¬ä¸‰æ¬¡é‡æ„] æ ‡ç­¾æ¢å¤å®Œæˆ: ${nodeId}, æˆåŠŸæ¢å¤ ${restoredCount}/${tagMatches.length} ä¸ªæ ‡ç­¾`);
            } else {
                log(`â„¹ï¸ MDå†…å®¹ä¸­æ²¡æœ‰å‘ç°æ ‡ç­¾: ${nodeId}`);
            }
        }

        // æµ‹è¯•åœºæ™¯1ï¼šåŸºç¡€æ ‡ç­¾åˆ‡æ¢
        function testScenario1() {
            log('\nğŸ§ª === æµ‹è¯•åœºæ™¯1ï¼šåŸºç¡€æ ‡ç­¾åˆ‡æ¢ ===');
            
            // 1. æ¸…é™¤å½“å‰çŠ¶æ€
            document.getElementById('content-editor').value = 'è¿™æ˜¯æµ‹è¯•å†…å®¹';
            document.querySelectorAll('.tag').forEach(tag => tag.classList.remove('selected'));
            
            // 2. æ‰‹åŠ¨ç‚¹å‡»å‡ ä¸ªæ ‡ç­¾
            log('ğŸ“ æ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»æ ‡ç­¾...');
            const tags = ['æƒ³æ³•', 'å‰ç«¯', 'å¾…åŠ'];
            tags.forEach(tagName => {
                const tagElement = document.querySelector(`[data-tag="${tagName}"]`);
                if (tagElement) {
                    fourComponentToggleTag(tagElement);
                }
            });
            
            // 3. æ¢å¤æ ‡ç­¾çŠ¶æ€
            setTimeout(() => {
                log('ğŸ”„ æ¨¡æ‹ŸèŠ‚ç‚¹åˆ‡æ¢åæ¢å¤æ ‡ç­¾...');
                restoreFourComponentTagStates(currentNodeId);
            }, 1000);
        }

        // æµ‹è¯•åœºæ™¯2ï¼šæ¨¡æ‹ŸèŠ‚ç‚¹åˆ‡æ¢
        function testScenario2() {
            log('\nğŸ§ª === æµ‹è¯•åœºæ™¯2ï¼šæ¨¡æ‹ŸèŠ‚ç‚¹åˆ‡æ¢ ===');
            
            // 1. è®¾ç½®åˆå§‹çŠ¶æ€
            document.getElementById('content-editor').value = 'é¡¹ç›®è®¡åˆ’ #è®¡åˆ’ #æ¶æ„ #è¿›è¡Œä¸­';
            restoreFourComponentTagStates('node-1');
            
            setTimeout(() => {
                // 2. åˆ‡æ¢åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹
                log('ğŸ”„ åˆ‡æ¢åˆ°èŠ‚ç‚¹2...');
                document.getElementById('content-editor').value = 'å‰ç«¯å¼€å‘ä»»åŠ¡ #å‰ç«¯ #API #å¾…åŠ';
                restoreFourComponentTagStates('node-2');
                
                setTimeout(() => {
                    // 3. åˆ‡æ¢å›åŸèŠ‚ç‚¹
                    log('ğŸ”„ åˆ‡æ¢å›èŠ‚ç‚¹1...');
                    document.getElementById('content-editor').value = 'é¡¹ç›®è®¡åˆ’ #è®¡åˆ’ #æ¶æ„ #è¿›è¡Œä¸­';
                    restoreFourComponentTagStates('node-1');
                }, 1500);
            }, 1500);
        }

        // æµ‹è¯•åœºæ™¯3ï¼šå¤æ‚æ ‡ç­¾ç»„åˆ
        function testScenario3() {
            log('\nğŸ§ª === æµ‹è¯•åœºæ™¯3ï¼šå¤æ‚æ ‡ç­¾ç»„åˆ ===');
            
            const complexContent = `# å¤æ‚é¡¹ç›®è®¾è®¡æ–‡æ¡£

è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šç§æ ‡ç­¾çš„å¤æ‚å†…å®¹ç¤ºä¾‹ã€‚

## é¡¹ç›®æ¦‚è¿°
è¿™ä¸ªé¡¹ç›®éœ€è¦ #å‰ç«¯ #åç«¯ #æ•°æ®åº“ çš„å…¨æ ˆå¼€å‘ã€‚

## å½“å‰çŠ¶æ€
é¡¹ç›®ç›®å‰æ˜¯ #è¿›è¡Œä¸­ çŠ¶æ€ï¼Œéœ€è¦ #æƒ³æ³• å’Œ #æ–¹æ¡ˆã€‚

## æŠ€æœ¯æ ˆ
ä½¿ç”¨ #ç®—æ³• å’Œ #æ¶æ„ è®¾è®¡ã€‚`;

            document.getElementById('content-editor').value = complexContent;
            log('ğŸ“ è®¾ç½®å¤æ‚å†…å®¹ï¼ŒåŒ…å«å¤šä¸ªæ ‡ç­¾');
            
            setTimeout(() => {
                restoreFourComponentTagStates('complex-node');
            }, 500);
        }

        // æ‰‹åŠ¨æ¢å¤æ ‡ç­¾
        function manualRestore() {
            log('\nğŸ”„ === æ‰‹åŠ¨æ¢å¤æ ‡ç­¾çŠ¶æ€ ===');
            restoreFourComponentTagStates(currentNodeId);
        }

        // æ¸…é™¤æ‰€æœ‰
        function clearAll() {
            log('\nğŸ—‘ï¸ === æ¸…é™¤æ‰€æœ‰çŠ¶æ€ ===');
            document.getElementById('content-editor').value = '';
            document.querySelectorAll('.tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            log('âœ… å·²æ¸…é™¤æ‰€æœ‰å†…å®¹å’Œæ ‡ç­¾çŠ¶æ€');
        }

        // ç»‘å®šæ ‡ç­¾ç‚¹å‡»äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    fourComponentToggleTag(this);
                });
            });
            
            // åˆå§‹æ¢å¤
            log('ğŸš€ é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œæ¢å¤åˆå§‹æ ‡ç­¾çŠ¶æ€');
            restoreFourComponentTagStates(currentNodeId);
        });
    </script>
</body>
</html> 