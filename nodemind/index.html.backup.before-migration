<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsMind 本地版演示</title>
    <link type="text/css" rel="stylesheet" href="node_modules/jsmind/style/jsmind.css" />
    <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <style>
        :root{--header-footer-height:160px;--panel-width:50vw;--min-panel-width:600px;--max-panel-width:800px;--tab-component-width:25vw;--tab-min-width:280px;--tab-max-width:380px}body{margin:0;padding:20px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;box-sizing:border-box}.container{max-width:95vw;margin:0 auto;background:white;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.15);overflow:hidden;height:calc(100vh - 40px);display:flex;flex-direction:column}.header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:white;padding:5px;text-align:center;min-height:20px}.header h1{margin:0 0 10px 0;font-size:28px;font-weight:600}.header .subtitle{font-size:16px;opacity:0.9;margin:0 0 15px 0}.feature-highlight{background:rgba(255,255,255,0.1);padding:12px 18px;border-radius:8px;margin-top:15px;font-size:14px;font-weight:500}.toolbar-left{display:flex;align-items:center;gap:10px;flex:1;justify-content:center}.toolbar-right{display:flex;align-items:center;gap:10px}.toolbar{background:#f8f9fa;padding:20px;border-bottom:2px solid #dee2e6;display:flex;align-items:center;justify-content:space-between;gap:20px}.btn{background:#007bff;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease;display:flex;align-items:center;gap:4px}.btn:hover{background:#0056b3;transform:translateY(-1px)}.btn-success{background:#28a745}.btn-success:hover{background:#1e7e34}.btn-danger{background:#dc3545}.btn-danger:hover{background:#c82333}.btn-warning{background:#ffc107;color:#212529}.btn-warning:hover{background:#e0a800}.btn-secondary{background:#6c757d}.btn-secondary:hover{background:#545b62}.btn-info{background:#17a2b8}.btn-info:hover{background:#138496}#jsmind_container{flex:1;height:100%;background:#f8f9fa;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.1)}.main-layout{display:flex;flex:1;gap:20px;margin:20px;transition:all 0.3s ease;min-height:0;overflow:hidden}.main-layout.panel-hidden .details-panel{display:none}.main-layout.panel-hidden .mindmap-container{width:100%}.details-panel{width:clamp(var(--min-panel-width),var(--panel-width),var(--max-panel-width));background:rgba(255,255,255,0.95);border-radius:8px;border:1px solid #e3f2fd;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;flex-shrink:0;height:100%;display:flex;flex-direction:row;gap:0}.details-panel-left{width:clamp(var(--tab-min-width),var(--tab-component-width),var(--tab-max-width));display:flex;flex-direction:column;flex-shrink:0}.details-panel-right{flex:1;background:rgba(248,249,250,0.5);border-left:1px solid #e9ecef;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#6c757d;font-size:14px;padding:20px;transition:all 0.3s ease;overflow:hidden}.details-panel-right.collapsed,.details-panel.extension-collapsed .details-panel-right{width:0;min-width:0;padding:0;border-left:none}.extension-content{display:none;height:100%;overflow-y:auto}.extension-content.active{display:block}.extension-tags-container{padding:20px}.extension-tags-container .tag-group{margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #e9ecef}.extension-tags-container .tag-group:last-child{border-bottom:none;margin-bottom:0}.extension-tags-container .tag-group-title{margin:0 0 10px 0;color:#495057;font-size:14px;font-weight:600}.extension-module{display:none;width:100%;height:100%;overflow:hidden}.extension-module.active{display:block}.input-group{margin-bottom:15px}.input-group label{display:block;margin-bottom:5px;color:#495057;font-weight:500}.input-group input,.input-group textarea{width:100%;padding:8px 12px;border:1px solid #ced4da;border-radius:4px;box-sizing:border-box;transition:border-color 0.2s}.input-group input:focus,.input-group textarea:focus{outline:none;border-color:#80bdff;box-shadow:0 0 0 0.2rem rgba(0,123,255,0.25)}.template-list-container{border:1px solid #dee2e6;border-radius:4px;height:200px;overflow-y:auto;background:#fff}.template-item{padding:10px 15px;border-bottom:1px solid #e9ecef;cursor:pointer;transition:background-color 0.2s}.template-item:last-child{border-bottom:none}.template-item:hover{background-color:#f8f9fa}.template-item.selected{background-color:#007bff;color:white;font-weight:bold}.template-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:15px}.module-header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:1px solid #e9ecef;background:rgba(255,255,255,0.8);border-radius:8px 8px 0 0}.module-title{margin:0;color:#495057;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}.module-icon{font-size:18px}.btn-sm{padding:6px 12px;font-size:12px;border-radius:4px}.module-content{padding:20px}.quick-templates{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}.template-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:white;border:1px solid #dee2e6;border-radius:6px;cursor:pointer;transition:all 0.2s;font-size:13px}.template-item:hover{background:#f8f9fa;border-color:#007bff;transform:translateY(-1px)}.template-icon{font-size:14px}.template-name{font-weight:500;color:#495057}.template-search{margin-top:15px}.template-search input{width:100%;padding:8px 12px;border:1px solid #ced4da;border-radius:4px;font-size:13px;outline:none}.template-search input:focus{border-color:#007bff;box-shadow:0 0 0 2px rgba(0,123,255,0.25)}.template-manager-modal{position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;display:flex;align-items:center;justify-content:center}.template-manager-modal *{box-sizing:border-box}.modal-backdrop{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);backdrop-filter:blur(2px)}.modal-content-wrapper{position:relative;width:90%;max-width:1200px;height:80%;background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);display:flex;flex-direction:column;overflow:hidden}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 30px;border-bottom:1px solid #e9ecef;background:#f8f9fa;flex-shrink:0}.modal-header-left{display:flex;align-items:center;gap:15px}.back-btn{background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;display:flex;align-items:center;gap:5px}.back-btn:hover{background:#545b62;transform:translateX(-2px)}.modal-header h3{margin:0;color:#495057;font-size:20px;font-weight:600}.close-btn{background:none;border:none;font-size:24px;color:#6c757d;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s}.close-btn:hover{background:#e9ecef;color:#495057}.modal-body{flex:1;overflow:hidden}.project-info-section{padding:20px;background:rgba(248,249,250,0.5);border-radius:8px;border:1px solid #e9ecef}.project-info-section .section-title{margin:0 0 15px 0;color:#495057;font-size:16px;font-weight:600;text-align:center;padding-bottom:10px;border-bottom:1px solid #e9ecef}.project-info-section .info-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f3f4}.project-info-section .info-row:last-of-type{border-bottom:none}.project-info-section .info-label{font-size:14px;font-weight:500;color:#6c757d;min-width:80px}.project-info-section .info-value{font-size:14px;color:#495057;font-weight:400;text-align:right;flex:1;margin-left:10px;word-break:break-all}.details-header{background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);color:white;padding:15px 20px;border-radius:8px 8px 0 0;font-weight:600;font-size:16px}.details-content{padding:20px;flex:1;overflow-y:auto;min-height:0}.mindmap-container{flex:1;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;box-shadow:0 2px 12px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-direction:column}.placeholder-content{text-align:center;color:#6c757d;padding:40px 20px;border:2px dashed #dee2e6;border-radius:6px;background:#f8f9fa;margin-bottom:20px}.placeholder-content .icon{font-size:48px;margin-bottom:15px;opacity:0.5}.placeholder-content .title{font-size:18px;font-weight:600;margin-bottom:8px}.placeholder-content .subtitle{font-size:14px;opacity:0.7}.main-content{margin:20px 0}.node-info-panel{background:#f8f9fa;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);height:fit-content;max-height:650px;overflow-y:auto}.panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #dee2e6;background:#e9ecef;border-radius:8px 8px 0 0}.panel-header h3{margin:0;font-size:16px;color:#495057}.close-btn{background:none;border:none;font-size:20px;color:#6c757d;cursor:pointer}.close-btn:hover{color:#343a40}.panel-content{padding:10px 0}.help-item.node-details .panel-content{max-height:400px;overflow-y:auto;padding:10px 0}.help-item.node-details .node-detail-form{margin-top:10px}.placeholder{color:#586069;font-style:italic;text-align:center;padding:15px 0}.node-info-item{margin-bottom:12px}.node-info-item label{display:block;font-weight:600;font-size:13px;color:#495057;margin-bottom:4px}.node-info-item .value{font-size:14px;word-break:break-word}.node-info-item .tag-list{display:flex;flex-wrap:wrap;gap:5px}.node-info-item .tag{background:#e9ecef;color:#495057;padding:3px 8px;border-radius:4px;font-size:12px}.node-path{font-size:12px;color:#6c757d;margin-bottom:15px;padding-bottom:10px;border-bottom:1px dashed #dee2e6}.node-path span{color:#007bff}.node-detail-form{display:flex;flex-direction:column;gap:8px;height:100%}#tab-detail .node-detail-form{gap:6px}.form-input,.form-textarea{width:100%;padding:8px 12px;border:1px solid #dee2e6;border-radius:4px;font-size:14px;color:#495057;transition:border-color 0.2s ease}.form-input:focus,.form-textarea:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 0.2rem rgba(0,123,255,.25)}.form-textarea{resize:vertical;min-height:80px}.form-actions{display:flex;justify-content:flex-start;gap:10px;margin-top:15px}.form-btn{padding:8px 16px;border:1px solid #dee2e6;border-radius:4px;background:#f8f9fa;color:#495057;font-size:14px;cursor:pointer;transition:all 0.2s ease}.form-btn:hover{background:#e9ecef}.form-btn-primary{background:#007bff;color:white;border-color:#007bff}.form-btn-primary:hover{background:#0069d9;border-color:#0062cc}.tags-container{display:flex;flex-direction:column;gap:8px}.tags-list{display:flex;flex-wrap:wrap;gap:5px}.tag{background:#e9ecef;color:#495057;padding:3px 8px;border-radius:4px;font-size:12px;display:inline-flex;align-items:center;gap:5px}.tag a{color:#6c757d;text-decoration:none;font-weight:bold}.tag a:hover{color:#dc3545}.tag-input{padding:5px 10px;border:1px solid #dee2e6;border-radius:4px;font-size:12px;width:100%}.relation-info,.time-info{background:#f8f9fa;padding:10px;border-radius:4px;font-size:13px;line-height:1.5}.drag-hint{background:linear-gradient(135deg,#fff3cd 0%,#ffeaa7 100%);border:1px solid #ffeaa7;color:#856404;padding:15px;margin:20px;border-radius:8px;text-align:center;font-weight:500}.drag-hint strong{color:#d63384}.status{background:linear-gradient(135deg,#343a40 0%,#495057 100%);color:white;padding:12px 20px;font-size:13px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}.status-item{display:flex;align-items:center;gap:8px}.status-indicator{width:8px;height:8px;border-radius:50%;background:#28a745}.help{padding:25px;background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%)}.help h3{margin:0 0 20px 0;color:#1565c0;font-size:18px;font-weight:600}.help-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}.help-item{background:rgba(255,255,255,0.9);padding:18px;border-radius:8px;border-left:4px solid}.help-item.mouse{border-left-color:#007bff}.help-item.keyboard{border-left-color:#28a745}.help-item.drag{border-left-color:#fd7e14}.help-item.features{border-left-color:#6f42c1}.help-item h4{margin:0 0 12px 0;color:#2c3e50;font-size:15px;font-weight:600}.help-item ul{margin:0;padding-left:20px;font-size:13px;line-height:1.6}.help-item li{margin:6px 0}@media (max-width:768px){.toolbar{padding:15px;gap:8px}.btn{padding:8px 14px;font-size:13px}.main-layout{flex-direction:column;height:auto;gap:15px;margin:15px}.details-panel{width:100%;order:2;height:auto;max-height:50vh;flex-direction:column}.details-panel-left{width:100%}.details-panel-right{width:100%;height:100px;border-left:none;border-top:1px solid #e9ecef}.details-panel.extension-collapsed .details-panel-right{height:0;padding:0;border-top:none}.mindmap-container{order:1;height:calc(50vh - 60px);min-height:300px}#jsmind_container{height:calc(50vh - 60px);min-height:300px}}.mindmap-tab-container{height:100%;display:flex;flex-direction:column;background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden}.mindmap-tab-header{display:flex;background:#f8f9fa;border-bottom:1px solid #dee2e6;flex-shrink:0}.mindmap-tab-button{flex:1;padding:12px 15px;background:none;border:none;cursor:pointer;font-size:14px;font-weight:500;color:#6c757d;transition:all 0.3s ease;position:relative;border-right:1px solid #dee2e6}.mindmap-tab-button:last-child{border-right:none}.mindmap-tab-button:hover{background:#e9ecef;color:#495057}.mindmap-tab-button.active{background:white;color:#007bff;font-weight:600}.mindmap-tab-button.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:#007bff}.mindmap-tab-content{display:none;flex:1;position:relative;overflow:hidden}.mindmap-tab-content.active{display:block}.jsmind-tab-canvas{width:100%;height:100%;position:absolute;top:0;left:0}.context-menu{position:fixed;background:white;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.2);padding:5px 0;z-index:10000;display:none}.context-menu-item{padding:8px 16px;cursor:pointer;font-size:14px;color:#333;white-space:nowrap}.context-menu-item:hover{background:#f0f0f0}.context-menu-divider{height:1px;background:#eee;margin:5px 0}.tab-container{background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden;height:100%;display:flex;flex-direction:column}.tab-header{display:flex;background:#f8f9fa;border-bottom:1px solid #dee2e6;flex-shrink:0}.tab-button{flex:1;padding:12px 15px;background:none;border:none;cursor:pointer;font-size:14px;font-weight:500;color:#6c757d;transition:all 0.3s ease;position:relative;border-right:1px solid #dee2e6}.tab-button:last-child{border-right:none}.tab-button:hover{background:#e9ecef;color:#495057}.tab-button.active{background:white;color:#007bff;font-weight:600}.tab-button.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:#007bff}.tab-content{display:none;padding:20px;flex:1;overflow-y:auto}.tab-content.active{display:block}.tab-pane h4{margin:0 0 15px 0;color:#495057;font-size:16px;font-weight:600}.info-row{display:flex;margin-bottom:12px;align-items:flex-start}.info-label{min-width:80px;font-weight:600;color:#6c757d;font-size:13px;margin-right:10px;flex-shrink:0}.info-value{flex:1;font-size:14px;color:#495057;word-break:break-word}.form-group{margin-bottom:8px}#tab-detail .form-group{margin-bottom:6px}#tab-detail .form-group:last-child{margin-bottom:0}.form-label{display:block;font-weight:600;color:#495057;font-size:13px;margin-bottom:6px}.form-input{width:100%;padding:8px 12px;border:1px solid #ced4da;border-radius:4px;font-size:14px;box-sizing:border-box}.form-textarea{width:100%;padding:8px 12px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-height:200px;resize:vertical;box-sizing:border-box}#tab-detail .form-textarea{min-height:150px;flex:1}.detail-header{position:relative;margin-bottom:15px}.author-input-small{position:absolute;top:0;right:0;width:150px;padding:4px 8px;border:1px solid #ced4da;border-radius:4px;font-size:12px;background:#f8f9fa}.tag-input-group{display:flex;gap:8px;margin-bottom:8px}.tag-input{flex:1;padding:6px 10px;border:1px solid #ced4da;border-radius:4px;font-size:13px}.tag-add-btn{padding:6px 12px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px}.tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}.tag-item{background:#e9ecef;color:#495057;padding:4px 8px;border-radius:12px;font-size:12px;display:flex;align-items:center;gap:4px}.tag-remove{background:none;border:none;color:#6c757d;cursor:pointer;font-size:14px;padding:0;margin-left:4px}.tag-remove:hover{background-color:#dc3545;color:white;border-radius:50%}.status-tags-container{display:flex;flex-wrap:wrap;gap:8px;padding:15px;border:1px solid #e0e0e0;border-radius:8px;background-color:#fafafa}.status-tag-item{padding:8px 16px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;border:2px solid transparent;background-color:#f8f9fa;color:#495057}.status-tag-item:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}.status-tag-item.active{color:white;border-color:transparent;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}.status-tag-item:nth-child(1){background-color:#ffc107;color:#212529}.status-tag-item:nth-child(1).active{background-color:#ffb300;box-shadow:0 4px 12px rgba(255,193,7,0.4)}.status-tag-item:nth-child(2){background-color:#17a2b8;color:white}.status-tag-item:nth-child(2).active{background-color:#138496;box-shadow:0 4px 12px rgba(23,162,184,0.4)}.status-tag-item:nth-child(3){background-color:#28a745;color:white}.status-tag-item:nth-child(3).active{background-color:#218838;box-shadow:0 4px 12px rgba(40,167,69,0.4)}.status-tag-item:nth-child(4){background-color:#007bff;color:white}.status-tag-item:nth-child(4).active{background-color:#0056b3;box-shadow:0 4px 12px rgba(0,123,255,0.4)}.status-tag-item:nth-child(5){background-color:#6c757d;color:white}.status-tag-item:nth-child(5).active{background-color:#545b62;box-shadow:0 4px 12px rgba(108,117,125,0.4)}.empty-state-small{color:#999;font-size:14px;padding:10px;text-align:center;border:1px dashed #ddd;border-radius:4px;background-color:#f9f9f9}.form-actions{display:flex;gap:10px;margin-top:20px;padding-top:15px;border-top:1px solid #dee2e6}.btn-primary{padding:8px 16px;background:#007bff;color:white;border:1px solid #007bff;border-radius:4px;cursor:pointer;font-size:14px}.btn-secondary{padding:8px 16px;background:#6c757d;color:white;border:1px solid #6c757d;border-radius:4px;cursor:pointer;font-size:14px}.history-item{padding:12px;border-left:3px solid #007bff;background:#f8f9fa;margin-bottom:10px;border-radius:0 4px 4px 0}.history-time{font-size:12px;color:#6c757d;margin-bottom:4px}.history-action{font-weight:600;color:#495057;margin-bottom:2px}.history-detail{font-size:13px;color:#6c757d}.empty-state{text-align:center;padding:40px 20px;color:#6c757d}.empty-state .icon{font-size:48px;margin-bottom:15px;opacity:0.5}.path-breadcrumb{background:#f8f9fa;padding:8px 12px;border-radius:4px;font-size:12px;color:#6c757d;margin-bottom:15px}.path-breadcrumb .path-separator{margin:0 8px;color:#adb5bd}.path-breadcrumb .path-node{color:#007bff;font-weight:500}.tag-group{margin-bottom:12px;padding:10px;background:#ffffff;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}.tag-group-title{margin:0 0 8px 0;color:#333;font-size:14px;font-weight:600}#tab-detail .tag-group{margin-bottom:8px;padding:8px}#tab-detail .tag-group:last-child{margin-bottom:0}#tab-detail .tag-group-title{margin:0 0 6px 0;font-size:13px}.tag-group-items{display:flex;flex-wrap:wrap;gap:8px}.tag-item{padding:4px 12px;border-radius:16px;font-size:13px;cursor:pointer;transition:all 0.2s ease;user-select:none}.tag-yellow{background:#fff3dc;color:#d48806}.tag-yellow:hover{background:#ffd591}.tag-green{background:#e6f7e6;color:#389e0d}.tag-green:hover{background:#b7eb8f}.tag-blue{background:#e6f4ff;color:#1677ff}.tag-blue:hover{background:#91caff}#tags-management-content{padding:15px;height:100%;overflow-y:auto}.tag-yellow.selected{background:#ffa940;color:#ffffff}.tag-green.selected{background:#52c41a;color:#ffffff}.tag-blue.selected{background:#1677ff;color:#ffffff}jmnode,jmnodes jmnode,jmnodes.theme-primary jmnode,jmnodes.theme-success jmnode,jmnodes.theme-warning jmnode,jmnodes.theme-danger jmnode,jmnodes.theme-info jmnode,jmnodes.theme-greensea jmnode,jmnodes.theme-nephritis jmnode,jmnodes.theme-belizehole jmnode,jmnodes.theme-wisteria jmnode,jmnodes.theme-asphalt jmnode,jmnodes.theme-orange jmnode,jmnodes.theme-pumpkin jmnode,jmnodes.theme-pomegranate jmnode,jmnodes.theme-clouds jmnode,jmnodes.theme-asbestos jmnode,jmnodes.theme-nephrite jmnode{background-color:#f5f5f5!important;color:#333!important}jmnode:hover,jmnodes jmnode:hover,jmnodes.theme-primary jmnode:hover,jmnodes.theme-success jmnode:hover,jmnodes.theme-warning jmnode:hover,jmnodes.theme-danger jmnode:hover,jmnodes.theme-info jmnode:hover,jmnodes.theme-greensea jmnode:hover,jmnodes.theme-nephritis jmnode:hover,jmnodes.theme-belizehole jmnode:hover,jmnodes.theme-wisteria jmnode:hover,jmnodes.theme-asphalt jmnode:hover,jmnodes.theme-orange jmnode:hover,jmnodes.theme-pumpkin jmnode:hover,jmnodes.theme-pomegranate jmnode:hover,jmnodes.theme-clouds jmnode:hover,jmnodes.theme-asbestos jmnode:hover,jmnodes.theme-nephrite jmnode:hover{background-color:#e8e8e8!important;color:#333!important}jmnode.selected,jmnodes jmnode.selected,jmnodes.theme-primary jmnode.selected,jmnodes.theme-success jmnode.selected,jmnodes.theme-warning jmnode.selected,jmnodes.theme-danger jmnode.selected,jmnodes.theme-info jmnode.selected,jmnodes.theme-greensea jmnode.selected,jmnodes.theme-nephritis jmnode.selected,jmnodes.theme-belizehole jmnode.selected,jmnodes.theme-wisteria jmnode.selected,jmnodes.theme-asphalt jmnode.selected,jmnodes.theme-orange jmnode.selected,jmnodes.theme-pumpkin jmnode.selected,jmnodes.theme-pomegranate jmnode.selected,jmnodes.theme-clouds jmnode.selected,jmnodes.theme-asbestos jmnode.selected,jmnodes.theme-nephrite jmnode.selected{background-color:#d0d0d0!important;color:#333!important}.node-content{display:flex;flex-direction:column;gap:8px}.node-title{font-size:14px;color:#333;margin:0}.node-tags{display:flex;flex-wrap:wrap;gap:4px}.node-tag{padding:2px 8px;border-radius:12px;font-size:12px;line-height:1.4}.node-tag.yellow{background:#fff3dc;color:#d48806}.node-tag.green{background:#e6f7e6;color:#389e0d}.node-tag.blue{background:#e6f4ff;color:#1677ff}.md-browser-container{height:100%;display:flex;flex-direction:column;background:white}.md-browser-header{padding:15px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;background:#f8f9fa}.md-browser-title{margin:0;color:#495057;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}.md-browser-controls{display:flex;gap:8px}.md-browser-content{flex:1;position:relative;overflow:hidden}.md-content-panel{position:absolute;top:0;left:0;right:0;bottom:0;display:none}.md-content-panel.active{display:block}.md-textarea{width:100%;height:100%;border:none;outline:none;padding:20px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;font-size:14px;line-height:1.6;resize:none;background:#fafafa}.md-preview-content{height:100%;overflow-y:auto;padding:20px;background:white}.md-preview-content h1,.md-preview-content h2,.md-preview-content h3,.md-preview-content h4,.md-preview-content h5,.md-preview-content h6{color:#333;margin-top:0;margin-bottom:16px}.md-preview-content h1{font-size:2em;border-bottom:1px solid #eaecef;padding-bottom:10px}.md-preview-content h2{font-size:1.5em;border-bottom:1px solid #eaecef;padding-bottom:8px}.md-preview-content h3{font-size:1.25em}.md-preview-content p{margin-bottom:16px;line-height:1.6}.md-preview-content ul,.md-preview-content ol{margin-bottom:16px;padding-left:2em}.md-preview-content li{margin-bottom:4px}.md-preview-content pre{background:#f6f8fa;border-radius:6px;padding:16px;overflow-x:auto;margin-bottom:16px}.md-preview-content code{background:#f6f8fa;padding:2px 4px;border-radius:3px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;font-size:85%}.md-preview-content blockquote{border-left:4px solid #dfe2e5;padding-left:16px;margin-left:0;color:#6a737d;margin-bottom:16px}.md-preview-content hr{border:none;height:1px;background:#e1e4e8;margin:24px 0}.md-browser-footer{padding:10px 15px;border-top:1px solid #e9ecef;background:#f8f9fa;font-size:12px}.md-status-info{display:flex;gap:20px;color:#6c757d}.tags-container{margin-top:5px}#tab-detail .tags-container{margin-top:3px}#tab-detail{height:100%;display:flex;flex-direction:column}#tab-detail #detail-info-content{height:100%;display:flex;flex-direction:column}#tab-detail .form-group:nth-child(2){flex:1;display:flex;flex-direction:column}#tab-detail .form-group:nth-child(2) .form-textarea{flex:1;min-height:100px}
        
        /* 消息提示动画 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* 节点详情表单样式 */
        .node-detail-form {
            padding: 20px;
        }
        
        .node-detail-form .form-group {
            margin-bottom: 15px;
        }
        
        .node-detail-form .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        .node-detail-form .form-input,
        .node-detail-form .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .node-detail-form .form-input:focus,
        .node-detail-form .form-textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .node-detail-form .readonly {
            color: #6c757d;
            font-size: 14px;
            font-style: italic;
        }
        
        .node-detail-form .form-actions {
            margin-top: 20px;
            text-align: center;
        }
        
        .node-detail-form .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .node-detail-form .btn-primary:hover {
            background: #0056b3;
        }
        
        /* 基本信息面板样式 */
        .basic-info-panel {
            padding: 20px;
        }
        
        .basic-info-panel h4 {
            margin: 0 0 20px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .basic-info-panel .info-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        
        .basic-info-panel .info-item label {
            min-width: 80px;
            font-weight: 500;
            color: #6c757d;
            font-size: 14px;
        }
        
        .basic-info-panel .info-item span {
            color: #495057;
            font-size: 14px;
        }
        
        /* 命令注入面板样式增强 */
        .command-injection-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .template-selection {
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 80px 1fr 80px 1fr;
            gap: 8px;
            align-items: center;
        }
        
        .template-selection label {
            font-size: 13px;
            font-weight: 500;
            color: #495057;
        }
        
        .template-selection select {
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }
        
        .injection-input-area {
            margin-bottom: 12px;
        }
        
        .injection-input-area label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
        }
        
        .injection-input-area textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
            resize: vertical;
        }
        
        .injection-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .injection-buttons button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .inject-btn {
            background: #28a745;
            color: white;
        }
        
        .inject-btn:enabled:hover {
            background: #218838;
        }
        
        .inject-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* 模板管理器样式 */
        .template-manager-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .template-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
            flex-shrink: 0;
        }
        
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-box input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        
        .search-btn {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .toolbar-right {
            display: flex;
            gap: 10px;
        }
        
        .template-categories {
            padding: 10px 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            flex-shrink: 0;
        }
        
        .category-tabs {
            display: flex;
            gap: 10px;
        }
        
        .category-tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.2s;
        }
        
        .category-tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .category-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .template-grid {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            align-content: start;
        }
        
        .template-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .template-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
            transform: translateY(-2px);
        }
        
        .template-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.25);
        }
        
        .template-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .template-icon {
            font-size: 18px;
            margin-right: 8px;
        }
        
        .template-name {
            font-weight: 600;
            color: #495057;
            font-size: 15px;
            flex: 1;
        }
        
        .template-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .template-card:hover .template-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        .action-btn.select-btn {
            background: #28a745;
            color: white;
            font-weight: bold;
        }
        
        .action-btn.select-btn:hover {
            background: #218838;
            color: white;
        }
        
        .template-description {
            color: #6c757d;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .template-category {
            font-size: 12px;
            color: #007bff;
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .inject-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .clear-btn {
            background: #6c757d;
            color: white;
        }
        
        .clear-btn:hover {
            background: #545b62;
        }
        
        .template-test-btn {
            background: #17a2b8;
            color: white;
        }
        
        .template-test-btn:hover {
            background: #138496;
        }
        
        .injection-status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        .injection-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .injection-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .injection-status.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .injection-log-section h5 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-export-btn {
            padding: 4px 8px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .log-export-btn:hover {
            background: #0056b3;
        }
        
        .log-display {
            max-height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
        }
        
        .log-empty {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .log-entry {
            padding: 6px 8px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 12px;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-timestamp {
            color: #6c757d;
            font-weight: 500;
        }
        
        .log-app {
            color: #007bff;
            font-weight: 500;
        }
        
        .log-command {
            color: #495057;
            margin-top: 2px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .calibration-info {
            margin-top: 15px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }
        
        .status-calibrating {
            color: #ff9800;
            font-weight: 500;
        }
        
        .status-calibrated {
            color: #4caf50;
            font-weight: 500;
        }
        
        .status-uncalibrated {
            color: #f44336;
            font-weight: 500;
        }
        
        
        /* 标签管理组件样式 */
        .tags-management-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .tags-management-title {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tag-groups-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* 节点信息选项卡中的标签组样式优化 */
        #tab-injection .tags-management-section .tag-group {
            margin-bottom: 0;
            padding: 12px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        
        #tab-injection .tags-management-section .tag-group-title {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
        
        #tab-injection .tags-management-section .tag-group-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        #tab-injection .tags-management-section .tag-item {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            border: 1px solid transparent;
        }
        
        #tab-injection .tags-management-section .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* 拷贝粘贴按钮样式 */
        .btn-copy, .btn-paste {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-copy:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .btn-paste:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        /* 会话列表样式 */
        .session-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .session-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .session-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .new-session-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: 2px dashed transparent;
            text-align: center;
            font-weight: 500;
        }
        
        .new-session-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ca085 100%);
            border-color: rgba(255,255,255,0.3);
        }
        
        .new-session-icon {
            font-size: 16px;
            margin-right: 8px;
        }
        
        .session-item.conversation {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #495057;
        }
        
        .session-item.conversation:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .session-item.conversation.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        
        .session-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .session-content-preview {
            font-size: 12px;
            color: #6c757d;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .session-item.conversation.active .session-content-preview {
            color: rgba(255,255,255,0.8);
        }
        
        /* 分割线样式 */
        .detail-splitter {
            width: 4px;
            background: #dee2e6;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }
        
        .detail-splitter:hover {
            background: #007bff;
        }
        
        .side-panel-splitter {
            height: 4px;
            background: #dee2e6;
            cursor: row-resize;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }
        
        .side-panel-splitter:hover {
            background: #007bff;
        }
        
        /* 详情工作区布局 */
        .detail-workspace {
            display: flex;
            height: 100%;
            gap: 0;
        }
        
        .detail-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
        }
        
        .detail-side-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
        }
        
        .session-list-section,
        .template-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .section-header {
            padding: 12px 15px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }
        
        .section-header h4 {
            margin: 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* AI输入区域样式 */
        .ai-interaction-section {
            margin-top: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .ai-input-area {
            padding: 15px;
        }
        
        .ai-input {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
            background: white;
        }
        
        .ai-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .ai-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .content-editor {
            min-height: 200px;
        }
        
        /* 标题区域和元信息样式 */
        .title-section {
            margin-bottom: 15px;
        }
        
        .title-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            background: white;
        }
        
        .title-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .node-meta-section {
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6c757d;
        }
        
        .meta-time {
            font-weight: 500;
        }
        
        .content-editor-section {
            margin-bottom: 15px;
        }
        
        .tags-section {
            margin-bottom: 15px;
        }
        
        .tags-label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: block;
        }
        
        /* 模板列表样式 */
        .template-list {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }
        
        .template-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .template-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
            transform: translateY(-1px);
        }
        
        .template-item:last-child {
            margin-bottom: 0;
        }
        
        /* 选中模板列表样式 */
        .template-section .section-header {
            padding: 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px 6px 0 0;
        }
        
        .template-section .section-header h4 {
            margin: 0;
            font-size: 14px;
            color: #495057;
            font-weight: 600;
        }
        
        .template-manager-btn {
            padding: 4px 8px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .template-manager-btn:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
        
        .selected-templates-list {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
        }
        
        .empty-template-state {
            text-align: center;
            padding: 20px 10px;
            color: #6c757d;
        }
        
        .empty-template-state .empty-icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.5;
        }
        
        .empty-template-state .empty-text {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .empty-template-state .empty-hint {
            font-size: 12px;
            opacity: 0.7;
            line-height: 1.4;
        }
        
        .selected-template-item {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .selected-template-item:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .selected-template-item:last-child {
            margin-bottom: 0;
        }
        
        .selected-template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .selected-template-name {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }
        
        .selected-template-actions {
            display: flex;
            gap: 4px;
        }
        
        .selected-template-btn {
            padding: 2px 6px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
        }
        
        .selected-template-btn:hover {
            background: #5a6268;
        }
        
        .selected-template-btn.use-btn {
            background: #28a745;
        }
        
        .selected-template-btn.use-btn:hover {
            background: #218838;
        }
        
        .selected-template-btn.remove-btn {
            background: #dc3545;
        }
        
        .selected-template-btn.remove-btn:hover {
            background: #c82333;
        }
        
        .selected-template-preview {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.3;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 消息提示动画 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* 新的节点信息面板布局样式 */
        .detail-workspace {
            display: flex;
            height: 100%;
            gap: 0;
            background: #f8f9fa;
        }
        
        .detail-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
            overflow-y: auto;
            min-width: 0;
        }
        
        .detail-splitter {
            width: 4px;
            background: #dee2e6;
            cursor: col-resize;
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        .detail-splitter:hover {
            background: #007bff;
        }
        
        .detail-splitter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: #adb5bd;
            border-radius: 1px;
        }
        
        .detail-side-panel {
            width: 300px;
            min-width: 200px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
        }
        
        /* 标题区域 */
        .title-section {
            margin-bottom: 8px;
        }
        
        .title-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            background: #ffffff;
            transition: border-color 0.2s ease;
        }
        
        .title-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        /* 节点元信息区域 */
        .node-meta-section {
            margin-bottom: 16px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .meta-row label {
            font-weight: 600;
            color: #495057;
            min-width: 40px;
        }
        
        .meta-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: #ffffff;
        }
        
        .meta-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .meta-time {
            color: #6c757d;
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* 内容编辑区域 */
        .content-editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        
        .editor-header {
            margin-bottom: 8px;
        }
        
        .editor-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .content-editor {
            flex: 1;
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            background: #ffffff;
            resize: vertical;
            min-height: 300px; /* 增加最小高度 */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            transition: border-color 0.2s ease;
        }
        
        .content-editor.expanded {
            min-height: 450px; /* 扩展后的高度 */
        }
        
        .content-editor:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        /* 内容头部区域 */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        
        .content-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* 问答开关样式 */
        .qa-switch-container {
            display: flex;
            align-items: center;
        }
        
        .qa-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .qa-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .qa-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: #ccc;
            border-radius: 24px;
            transition: 0.3s;
            margin-right: 8px;
        }
        
        .qa-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .qa-switch input:checked + .qa-slider {
            background-color: #007bff;
        }
        
        .qa-switch input:checked + .qa-slider:before {
            transform: translateX(20px);
        }
        
        .qa-label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }
        
        /* AI交互区域 */
        .ai-interaction-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
        }
        
        .ai-input-area {
            margin-bottom: 12px;
        }
        
        .ai-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            background: #ffffff;
        }
        
        .ai-input:disabled {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .ai-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        
        .btn-save, .btn-submit {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-save:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-submit {
            background: #007bff;
            color: white;
        }
        
        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .ai-agent-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .agent-selector {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: #ffffff;
        }
        
        .agent-selector:disabled {
            background: #e9ecef;
            color: #6c757d;
        }
        
        /* 标签区域 */
        .tags-section {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
        }
        
        .tags-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .tags-label {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
        
        /* 项目信息页面样式 */
        .node-info-panel {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .node-info-panel h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }
        
        /* 项目按钮容器样式 */
        .basic-info-panel .project-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        /* 校准功能样式 - 仅影响项目信息面板 */
        .basic-info-panel .calibrate-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .basic-info-panel .calibrate-btn:hover {
            background: #0056b3;
        }
        
        /* 提示词模板管理按钮样式 */
        .basic-info-panel .template-manager-btn {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .basic-info-panel .template-manager-btn:hover {
            background: #218838;
        }

        /* 提示词模板按钮样式 */
        .template-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .template-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .template-button:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .basic-info-panel .status-calibrated {
            color: #28a745;
            font-weight: 600;
        }
        
        .basic-info-panel .status-uncalibrated {
            color: #000000;
            font-weight: 600;
        }
        
        .basic-info-panel .status-calibrating {
            color: #ffc107;
            font-weight: 600;
        }
        
        .basic-info-panel .calibration-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #dee2e6;
        }
        

        
        /* 命令注入测试框样式 */
        .basic-info-panel .command-injection-section {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #dee2e6;
        }
        
        .basic-info-panel .command-injection-section h4 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 16px;
        }
        
        .basic-info-panel .injection-input-area {
            margin-bottom: 12px;
        }
        
        .basic-info-panel .injection-input-area label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
        }
        
        .basic-info-panel .injection-input-area textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        
        .basic-info-panel .injection-input-area textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .basic-info-panel .injection-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .basic-info-panel .inject-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .basic-info-panel .inject-btn:hover {
            background: #c82333;
        }
        
        .basic-info-panel .inject-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .basic-info-panel .clear-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .basic-info-panel .clear-btn:hover {
            background: #5a6268;
        }
        
        .basic-info-panel .injection-status {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .basic-info-panel .injection-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .basic-info-panel .injection-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* 右侧面板各区域 */
        .session-list-section {
            height: 60%; /* 默认占据60%高度 */
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 100px; /* 最小高度限制 */
            overflow: hidden;
        }
        
        .template-section {
            flex: 1; /* 占据剩余空间 */
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 80px; /* 最小高度限制 */
            overflow: hidden;
        }
        
        /* 右侧面板内部分割线 */
        .side-panel-splitter {
            height: 4px;
            background: #dee2e6;
            cursor: row-resize;
            position: relative;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        
        .side-panel-splitter:hover {
            background: #007bff;
        }
        
        .side-panel-splitter::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 2px;
            background: #adb5bd;
            border-radius: 1px;
        }
        
        .section-header {
            margin-bottom: 12px;
            flex-shrink: 0; /* 标题不收缩 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }
        
        .view-mode-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
        }
        
        .view-mode-btn:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .session-list,
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1; /* 占据剩余空间 */
            overflow-y: auto; /* 内容过多时滚动 */
            min-height: 0; /* 允许收缩 */
        }
        
        .session-item,
        .template-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0; /* 列表项不收缩 */
        }
        
        .session-item:hover,
        .template-item:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }
        

        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .detail-side-panel {
                width: 250px;
                min-width: 200px;
            }
        }
        
        @media (max-width: 900px) {
            .detail-workspace {
                flex-direction: column;
            }
            
            .detail-splitter {
                display: none;
            }
            
            .detail-side-panel {
                width: 100%;
                max-height: 300px;
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
        }

        /* 四组件布局样式 */
        .detail-workspace {
            display: flex;
            flex-direction: column;
            height: 800px;
            font-family: inherit;
        }

        /* 标题区域 */
        .title-area {
            background: #fafafa;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .qa-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qa-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .qa-toggle label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .title-content {
            flex: 1;
        }

        .node-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
            line-height: 1.4;
        }

        /* 主内容区域 */
        .main-content-area {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e5e5e5;
            transition: all 0.3s ease;
        }

        .right-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .right-panel.hidden {
            display: none !important;
        }
        
        .main-splitter.hidden {
            display: none !important;
        }
        
        /* 固定选项卡框架宽度 - 不自动调节 */
        .details-panel {
            width: 800px !important; /* 固定宽度，不使用 clamp 函数 */
            min-width: 800px !important;
            max-width: 800px !important;
            flex-shrink: 0 !important;
        }
        
        /* 右侧面板折叠时的样式 */
        .main-content-area.qa-mode-off .right-panel {
            width: 0 !important;
            min-width: 0 !important;
            max-width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden !important;
            border: none !important;
            opacity: 0 !important;
        }
        
        /* 左侧面板扩展填充 */
        .main-content-area.qa-mode-off .left-panel {
            flex: 1 !important;
            width: 100% !important;
            max-width: none !important;
            border-right: none !important;
        }
        
        /* 隐藏分割线 */
        .main-content-area.qa-mode-off .main-splitter {
            display: none !important;
        }
        
        /* 固定选项卡标签按钮宽度 - 不使用弹性布局 */
        .tab-button {
            flex: none !important; /* 取消弹性布局 */
            width: 400px !important; /* 固定宽度，总宽度800px的一半 */
            min-width: 400px !important;
            max-width: 400px !important;
        }
        
        /* 确保选项卡头部不使用flex的自动分配 */
        .tab-header {
            display: flex !important;
            width: 800px !important; /* 与选项卡框架宽度一致 */
        }
        
        /* 问答模式关闭时，左侧面板填充整个空间 */
        .main-content-area.qa-mode-off .left-panel {
            flex: 1 !important;
            width: 100% !important;
            border-right: none !important;
            max-width: none !important;
        }

        .main-splitter {
            width: 4px;
            background: #e5e5e5;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .main-splitter:hover {
            background: #007bff;
        }

        .main-splitter.hidden {
            display: none;
        }

        /* 组件A: 内容编辑器 */
        .content-section {
            flex: 1;
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .content-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .content-controls {
            display: flex;
            gap: 8px;
        }

        .title-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .content-editor {
            flex: 1;
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        .meta-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        /* 组件B: 标签组件 */
        .tags-section {
            padding: 20px;
            background: #f9f9f9;
        }

        .tags-header {
            margin-bottom: 15px;
        }

        .tags-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .tag-group {
            margin-bottom: 15px;
        }

        .tag-group-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            padding: 4px 8px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tag.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 组件C: 会话列表 */
        .session-section {
            flex: 1;
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .session-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .session-controls {
            display: flex;
            gap: 8px;
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
        }

        .session-item {
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .session-item:hover {
            border-color: #007bff;
            transform: translateX(2px);
        }

        .session-item.selected {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .session-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-title {
            font-weight: 500;
            color: #333;
        }

        .session-time {
            font-size: 11px;
            color: #666;
        }

        .session-preview {
            margin-top: 6px;
            font-size: 12px;
            color: #666;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .new-session-btn {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            text-align: center;
            color: #666;
            font-weight: 500;
        }

        .new-session-btn:hover {
            border-color: #007bff;
            color: #007bff;
            background: #f8f9ff;
        }

        /* 组件D: 模板列表 */
        .template-section {
            padding: 20px;
            background: #f9f9f9;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .template-header h4 {
            font-size: 16px;
            color: #333;
            margin: 0;
        }

        .selected-templates-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .template-item {
            padding: 10px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-name {
            font-weight: 500;
            color: #333;
        }

        .template-actions {
            display: flex;
            gap: 4px;
        }

        .template-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .template-btn-use {
            background: #28a745;
            color: white;
        }

        .template-btn-remove {
            background: #dc3545;
            color: white;
        }

        .empty-template-state {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .empty-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .empty-text {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .empty-hint {
            font-size: 12px;
        }

        /* 右侧面板分割线 */
        .right-splitter {
            height: 4px;
            background: #e5e5e5;
            cursor: row-resize;
            transition: background 0.2s;
        }

        .right-splitter:hover {
            background: #007bff;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content-area {
                flex-direction: column;
            }
            
            .right-panel {
                width: 100%;
            }
            
            .main-splitter {
                display: none;
            }
        }

        /* 节点选中高亮样式 */
        .jmnode-selected {
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.6) !important;
            border: 2px solid #007bff !important;
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        /* 移除了节点选择反馈动画相关样式 */

        /* 选项卡切换动画增强 */
        .details-panel .tab-content {
            transition: all 0.3s ease;
        }

        .details-panel .tab-content.active {
            animation: slideInFromRight 0.3s ease-out;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 节点信息标签页按钮高亮 */
        .details-panel .tab-button.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* 移除了标签页切换反馈动画相关样式 */
        
      </style>
      
      <!-- 架构守护工具 - 实时监控模块化规范 -->
      <script src="src/utils/architecture_guard.js" type="module"></script>
      
      <!-- 数据结构统一与染色系统 -->
      <script src="src/services/data_structure_unifier.js"></script>
      <script src="src/services/unified_node_styling_service.js"></script>
      <script src="fix_data_structure_and_coloring.js"></script>
      
      <!-- 可视化修复服务 -->
      <script src="src/services/visual_repair_service.js"></script>
      
      <!-- 模板管理服务 -->
      <script src="src/services/template_service.js"></script>
      <script src="src/services/template_selection_service.js"></script>
      <link rel="stylesheet" href="src/styles/template_selection.css">
      
      <!-- 节点事件处理器 - 替换内联事件 -->
      <script type="module">
        import { 
          initializeNodeEventListeners,
          handleNodeContentChange,
          handleNodeTitleChange,
          handleQAModeChange,
          handleProjectAuthorChange
        } from './src/services/node_service.js';
        
        // 立即暴露函数到全局作用域
        console.log('🚀 立即暴露模块化函数到全局作用域...');
        window.handleNodeContentChange = handleNodeContentChange;
        window.handleNodeTitleChange = handleNodeTitleChange;
        window.handleQAModeChange = handleQAModeChange;
        window.handleProjectAuthorChange = handleProjectAuthorChange;
        console.log('✅ 函数已暴露:', typeof window.handleNodeContentChange);
        
        // 初始化函数
        function initModularEvents() {
          console.log('🔧 初始化模块化事件监听器...');
          initializeNodeEventListeners();
          console.log('✅ 事件监听器初始化完成');
        }
        
        // 多重初始化策略
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initModularEvents);
        } else {
          // DOM已经加载完成，立即执行
          initModularEvents();
        }
        
        // 同时在window.onload时再次确保
        window.addEventListener('load', function() {
          console.log('🔄 window.onload - 再次确保函数可用');
          console.log('   handleNodeContentChange:', typeof window.handleNodeContentChange);
        });
      </script>
</head>
<body>


    <div class="container">
        <div class="header">
            <!-- 保留区域备用 -->
        </div>
        
        <div class="toolbar">
            <input type="file" id="import_file_input" accept=".json,.jm,.mm" style="display: none;">
            
            <div class="toolbar-left">
                <button id="show_guide_button" class="btn btn-primary" style="background: #007bff; border: 2px solid #0056b3; font-size: 16px; font-weight: 600; padding: 12px 24px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); transition: all 0.3s ease;">
                    📚 使用指南
                </button>
                <button id="export_custom_file_button" class="btn btn-info">
                    💾 保存
                </button>
                <button id="import_file_button" class="btn btn-success">
                    📂 导入文件
                </button>
                <button id="create_new_mindmap_button" class="btn btn-warning">
                    ✨ 新脑图
                </button>
                <button id="sync_tags_button" class="btn btn-secondary">
                    🔄 标签同步
                </button>
                <button onclick="handleAnalyzeTagData()" class="btn btn-info">
                    🔍 分析标签数据
                </button>
                <button onclick="testTagSync()" class="btn btn-info">
                    🧪 测试标签
                </button>
                <button onclick="visualRepairService.triggerCheck()" class="btn btn-warning">
                    🛠️ 修复检查
                </button>
                <button onclick="openMDDirectPanel()" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                    📝 MD直存
                </button>

            </div>
            
            <div class="toolbar-right">
                <button class="btn btn-info" id="extensionToggleBtn">
                    ◀ 折叠扩展区
                </button>
                <button class="btn btn-secondary" id="panelToggleBtn">
                    📋 隐藏详情面板
                </button>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="mindmap-container">
                <div class="mindmap-tab-container">
                    <div class="mindmap-tab-header">
                        <button id="tab_button_workspace" class="mindmap-tab-button" data-tab="workspace">
                            🏷️ 标签管理
                        </button>
                        <button id="tab_button_knowledge" class="mindmap-tab-button" data-tab="knowledge">
                            📋 临时工作区B
                        </button>
                        <button id="tab_button_project" class="mindmap-tab-button active" data-tab="project">
                            🚀 项目管理
                        </button>
                    </div>
                    
                    <div id="mindmap-tab-workspace" class="mindmap-tab-content">
                        <div id="jsmind_container_workspace" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <div id="mindmap-tab-knowledge" class="mindmap-tab-content">
                        <div id="jsmind_container_knowledge" class="jsmind-tab-canvas"></div>
                    </div>
                    
                    <div id="mindmap-tab-project" class="mindmap-tab-content active">
                        <div id="jsmind_container_project" class="jsmind-tab-canvas"></div>
                    </div>
                </div>
            </div>
            
            <div class="details-panel">
                <div class="tab-container">
                    <div class="tab-header">
                        <button id="detail_tab_injection" class="tab-button active" data-tab="injection">
                            📄 节点信息
                        </button>
                        <button id="detail_tab_project" class="tab-button" data-tab="project">
                            📋 项目信息
                        </button>
                    </div>
                    
                    <div id="tab-injection" class="tab-content active">
                        <div id="injection-info-content">
                            <!-- 四组件布局主体 -->
                            <div class="detail-workspace" id="detail-workspace">
                                <!-- 标题区域（动态调整） -->
                                <div class="title-area" id="title-area">
                                    <div class="qa-toggle">
                                        <input type="checkbox" id="qa-mode-toggle" checked onchange="onQAModeChange()">
                                        <label for="qa-mode-toggle">问答模式</label>
                                    </div>
                                    <div class="title-content">
                                        <h3 class="node-title" id="node-title">点击思维导图中的节点查看节点信息</h3>
                                    </div>
                                </div>
                                
                                <!-- 主内容区域 -->
                                <div class="main-content-area" id="main-content-area">
                                    <!-- 左侧面板 -->
                                    <div class="left-panel" id="left-panel">
                                        <!-- 组件A: 内容编辑器（节点联动） -->
                                        <div class="content-section" id="content-section">
                                            <div class="content-header">
                                                <div class="content-controls">
                                                    <button class="btn btn-primary" onclick="fourComponentSubmitContent()">✅ 提交</button>
                                                </div>
                                            </div>

                                            <textarea class="content-editor" id="content-editor" 
                                                      placeholder="在这里编辑节点内容..."></textarea>
                                            <div class="meta-info" id="meta-info">
                                                创建时间: -- | 修改时间: --
                                            </div>
                                        </div>
                                        
                                        <!-- 组件B: 标签组件（全局状态） -->
                                        <div class="tags-section" id="tags-section">
                                            <div class="tags-header">
                                                <h4>🏷️ 标签组件（全局状态）</h4>
                                            </div>
                                            <div class="tag-groups-container" id="tag-groups">
                                                <!-- 标签组件将在初始化时从标签管理脑图动态加载 -->
                                                <div class="loading-tags-state">
                                                    <div class="loading-icon">🔄</div>
                                                    <div class="loading-text">正在从标签管理脑图加载标签...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 分割线（可拖拽调整） -->
                                    <div class="main-splitter" id="main-splitter"></div>
                                    
                                    <!-- 右侧面板（可折叠） -->
                                    <div class="right-panel" id="right-panel">
                                        <!-- 组件C: 会话列表（节点联动） -->
                                        <div class="session-section" id="session-section">
                                            <div class="session-header">
                                                <h4>💬 会话列表（节点联动）</h4>
                                                <div class="session-controls">
                                                    <button class="btn" onclick="fourComponentViewAllSessions()">📖 查看全部</button>
                                                    <button class="btn" onclick="fourComponentClearSessions()">🗑️ 清空</button>
                                                </div>
                                            </div>
                                            <div class="session-list" id="session-list">
                                                <div class="session-item new-session-btn" onclick="fourComponentAddNewSession()">
                                                    <div class="session-title">➕ 新增会话</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 右侧面板分割线 -->
                                        <div class="right-splitter" id="right-splitter"></div>
                                        
                                        <!-- 组件D: 模板列表（全局状态） -->
                                        <div class="template-section" id="template-section">
                                            <div class="template-header">
                                                <h4>📋 模板列表（全局状态）</h4>
                                                <button class="template-manager-btn" onclick="openTemplateManager()">
                                                    ⚙️ 管理
                                                </button>
                                            </div>
                                            <div class="selected-templates-list" id="template-list">
                                                <div class="empty-template-state">
                                                    <div class="empty-icon">📝</div>
                                                    <div class="empty-text">暂无选中模板</div>
                                                    <div class="empty-hint">点击"管理"按钮添加模板</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-project" class="tab-content">
                        <div id="project-info-content">
                            <div class="basic-info-panel">
                                <h4>📋 项目基本信息</h4>
                                <div class="project-buttons">
                                    <button class="calibrate-btn" onclick="performCalibration()">校准</button>
                                    <button class="template-manager-btn" onclick="openTemplateManager()">提示词模板管理</button>
                                </div>
                                <div class="info-item">
                                    <label>项目名称:</label>
                                    <span id="project-name-display">NodeMind 思维导图</span>
                                </div>
                                <div class="info-item">
                                    <label>项目路径:</label>
                                    <span id="project-path-display">未设置</span>
                                </div>
                                <div class="info-item">
                                    <label>版本:</label>
                                    <span>1.0.0</span>
                                </div>
                                <div class="info-item">
                                    <label>作者:</label>
                                    <span>NodeMind Team</span>
                                </div>
                                <div class="info-item">
                                    <label>描述:</label>
                                    <span>基于jsMind的思维导图应用</span>
                                </div>
                                <div class="calibration-info" id="calibration-info" style="display: none;">
                                    <div class="info-item">
                                        <label>应用名称:</label>
                                        <span id="app-name-display">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>状态:</label>
                                        <span id="calibration-status" class="status-uncalibrated">未校准</span>
                                    </div>
                                    <div class="info-item">
                                        <label>输入框坐标:</label>
                                        <span id="input-coordinates">-</span>
                                    </div>
                                    <div class="info-item">
                                        <label>屏幕信息:</label>
                                        <span id="screen-info">-</span>
                                    </div>
                                </div>
                                <div class="command-injection-section" id="command-injection-section">
                                    <h4>💉 命令注入测试框</h4>
                                    <div class="template-selection">
                                        <label>模板场景:</label>
                                        <select id="template-scene-select" onchange="onTemplateSceneChanged()">
                                            <option value="">选择场景...</option>
                                            <option value="自然模式">自然模式</option>
                                            <option value="技术模式">技术模式</option>
                                            <option value="创意模式">创意模式</option>
                                        </select>
                                        <label>模板版本:</label>
                                        <select id="template-version-select" onchange="onTemplateVersionChanged()">
                                            <option value="">选择版本...</option>
                                        </select>
                                    </div>
                                    <div class="injection-input-area">
                                        <label for="command-input">命令内容:</label>
                                        <textarea id="command-input" placeholder="请输入要注入的命令..." rows="3"></textarea>
                                    </div>
                                    <div class="injection-buttons">
                                        <button class="inject-btn" onclick="injectCommand()" disabled>注入命令</button>
                                        <button class="clear-btn" onclick="clearCommandInput()">清空</button>
                                        <button class="template-test-btn" onclick="testTemplate()">测试模板</button>
                                    </div>
                                    <div class="injection-status" id="injection-status">
                                        <span>请先完成校准才能使用命令注入功能</span>
                                    </div>
                                    <div class="injection-log-section">
                                        <h5>📝 注入日志 <button class="log-export-btn" onclick="exportInjectionLogs()">导出日志</button></h5>
                                        <div class="log-display" id="injection-log-display">
                                            <div class="log-empty">暂无注入记录</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>jsMind 本地版本已加载</span>
            </div>
            <div class="status-item">
                当前主题: <span id="currentTheme">primary</span>
            </div>
            <div class="status-item">
                选中节点: <span id="selectedNode">无</span>
            </div>
        </div>
    </div>

    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="context_menu_focus_node">🔬 单独显示到临时工作区</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context_menu_hide">❌ 取消</div>
    </div>

    <div id="template-manager-container" class="template-manager-modal" style="display: none;">
        <div class="modal-backdrop" id="template_manager_backdrop"></div>
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <div class="modal-header-left">
                    <button type="button" class="back-btn" id="template_manager_back_button" title="返回上级页面">← 返回</button>
                    <h3>📝 提示词模板管理器</h3>
                </div>
                <button type="button" class="close-btn" id="template_manager_close_button">×</button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>

    <!-- 模板编辑弹窗 -->
    <div id="template-edit-modal" class="template-manager-modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeTemplateEditModal()"></div>
        <div class="modal-content-wrapper" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h3 id="template-edit-title">📝 编辑模板</h3>
                </div>
                <button type="button" class="close-btn" onclick="closeTemplateEditModal()">×</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="template-edit-form" onsubmit="event.preventDefault(); saveTemplate();">
                    <!-- 模板名称 -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">模板名称:</label>
                        <input type="text" id="template-name-input" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;" placeholder="请输入模板名称" required>
                    </div>
                    
                    <!-- 模板分类 -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">模板分类:</label>
                        <select id="template-category-select" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                                                    <option value="natural">🗣️ 自然模式</option>
                        <option value="code">💻 代码类</option>
                        <option value="log">📝 日志类</option>
                        <option value="feature">✨ 新功能类</option>
                        </select>
                    </div>
                    
                    <!-- 前缀模板 -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">前缀模板:</label>
                        <textarea id="template-prefix-input" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; min-height: 80px; resize: vertical;" placeholder="在用户输入前添加的内容（支持{项目名称}变量）"></textarea>
                    </div>
                    
                    <!-- 后缀模板 -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">后缀模板:</label>
                        <textarea id="template-suffix-input" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; min-height: 80px; resize: vertical;" placeholder="在用户输入后添加的内容"></textarea>
                    </div>
                    
                    <!-- 模板描述 -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">模板描述:</label>
                        <input type="text" id="template-description-input" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;" placeholder="简要描述模板用途">
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" onclick="closeTemplateEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">取消</button>
                        <button type="submit" style="padding: 10px 20px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">保存模板</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.js"></script>
    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.draggable-node.js"></script>
    <script type="text/javascript" src="node_modules/jsmind/js-legacy/jsmind.screenshot.js"></script>
    <script type="text/javascript" src="src/ui/template-manager.bundle.js"></script>
    
    <!-- 🚀 激活模块化架构 -->
    <script type="module" src="src/app.js"></script>
    
    <!-- 
    修改履历 - 提示词模板功能恢复 (2024)
    1. 删除重复的"提示词模板"h4标题，改为单一按钮入口
    2. 修复模板管理器空白页问题，添加内容初始化函数
    3. 修复返回按键不管用问题，添加完整事件绑定
    4. 引入template-manager.bundle.js支持完整模板管理器
    5. 添加降级机制确保基本功能可用
    修改位置：index.html.2059-2069, 1110-1126, 3725-3840, 1620
    -->
    <script>
        // 简化的思维导图初始化 - 基于工作版本jsmind-project.html
        
        // 思维导图数据配置
        var mindmapData = {
            workspace: {
                meta: { name: "标签管理", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "workspace_root",
                    topic: "🏷️ 标签管理",
                    children: [
                        {
                            id: "tag_group_normal", 
                            topic: "常规组", 
                            direction: "right",
                            children: [
                                { id: "tag_project", topic: "项目", isTag: true, tagGroup: "常规" },
                                { id: "tag_milestone", topic: "里程碑", isTag: true, tagGroup: "常规" },
                                { id: "tag_completed", topic: "完成", isTag: true, tagGroup: "常规" },
                                { id: "tag_inprogress", topic: "进行中", isTag: true, tagGroup: "常规" },
                                { id: "tag_planned", topic: "计划", isTag: true, tagGroup: "常规" }
                            ]
                        },
                        {
                            id: "tag_group_ai", 
                            topic: "AI组", 
                            direction: "left",
                            children: [
                                { id: "tag_memory", topic: "记忆", isTag: true, tagGroup: "AI" },
                                { id: "tag_attention", topic: "注意力", isTag: true, tagGroup: "AI" },
                                { id: "tag_experience", topic: "经验", isTag: true, tagGroup: "AI" },
                                { id: "tag_hallucination", topic: "幻觉", isTag: true, tagGroup: "AI" }
                            ]
                        },
                        {
                            id: "tag_group_notes", 
                            topic: "笔记组", 
                            direction: "left",
                            children: [
                                { id: "tag_followup", topic: "跟进", isTag: true, tagGroup: "笔记" },
                                { id: "tag_issue", topic: "议题", isTag: true, tagGroup: "笔记" }
                            ]
                        }
                    ]
                }
            },
            knowledge: {
                meta: { name: "临时工作区B", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "knowledge_root",
                    topic: "📋 临时工作区B",
                    children: []
                }
            },
            project: {
                meta: { name: "项目管理", author: "NodeMind", version: "1.0.0" },
                format: "node_tree",
                data: {
                    id: "project_root",
                    topic: "🚀 项目管理",
                    children: [
                        { id: "pj_1", topic: "需求分析", direction: "right" },
                        { id: "pj_2", topic: "设计阶段", direction: "right" },
                        { id: "pj_3", topic: "开发实施", direction: "left" },
                        { id: "pj_4", topic: "测试部署", direction: "left" }
                    ]
                }
            }
        };

        // 基础配置
        var baseOptions = {
            editable: true,
            theme: 'primary',
            view: { engine: 'canvas', hmargin: 150, vmargin: 80, line_width: 2, line_color: '#566' },
            layout: { hspace: 40, vspace: 30, pspace: 15 },
            shortcut: { enable: true, handles: {}, mapping: { addchild: 4096 + 13, addbrother: 13, editnode: 113, delnode: 46, toggle: 32, left: 37, up: 38, right: 39, down: 40 } },
            default_direction: 'right'
        };

        // 全局变量
        var mindmaps = {};
        var currentMindmap = 'project';
        var selectedNodeId = null;
        var nodeDatabase = {}; // 节点详细信息数据库
        var lastSavedFilePath = null; // 文件保存路径
        
        // 项目信息
        var projectInfo = {
            name: '未设置',
            path: '未设置',
            description: '未设置',
            author: '未设置',
            version: '1.0.0'
        };
        
        // 存储键名配置
        var STORAGE_KEYS = {
            MINDMAP_DATA: 'nodemind_mindmap_data',
            NODE_DATABASE: 'nodemind_node_database',
            CURRENT_THEME: 'nodemind_current_theme',
            DRAG_ENABLED: 'nodemind_drag_enabled',
            SELECTED_NODE: 'nodemind_selected_node',
            VIEW_DATA: 'nodemind_view_data',
            LAST_SAVED_PATH: 'nodemind_last_saved_path',
            PROJECT_INFO: 'nodemind_project_info',
            FOUR_COMPONENT_DATA: 'nodemind_four_component_data',
            FOUR_COMPONENT_GLOBAL_STATE: 'nodemind_four_component_global_state',
            FOUR_COMPONENT_SESSIONS: 'nodemind_four_component_sessions'
        };

        // 初始化思维导图
        function initMindmaps() {
            console.log('🧠 初始化思维导图...');
            
            // 创建工作空间脑图
            mindmaps.workspace = new jsMind({ ...baseOptions, container: 'jsmind_container_workspace' });
            mindmaps.workspace.show(mindmapData.workspace);
            
            // 创建知识库脑图
            mindmaps.knowledge = new jsMind({ ...baseOptions, container: 'jsmind_container_knowledge' });
            mindmaps.knowledge.show(mindmapData.knowledge);
            
            // 创建项目管理脑图
            mindmaps.project = new jsMind({ ...baseOptions, container: 'jsmind_container_project' });
            mindmaps.project.show(mindmapData.project);

            // 启用拖拽功能
            Object.values(mindmaps).forEach((mindmap, index) => {
                try {
                    if (typeof mindmap.enable_draggable_node === 'function') {
                        mindmap.enable_draggable_node();
                        console.log(`✅ 脑图${index + 1}拖拽功能已启用`);
                    }
                } catch (dragError) {
                    console.log(`⚠️ 脑图${index + 1}拖拽功能启用失败:`, dragError.message);
                }
            });
            
            // *** 关键修复：数据融合 - 确保jsMind节点与nodeDatabase同步 ***
            console.log('🔄 开始数据融合...');
            syncMindmapDataWithNodeDatabase();
            
            console.log('✅ 思维导图初始化完成');
            
            // 绑定节点选择事件
            bindNodeEvents();
        }
        
        // 数据融合函数：确保jsMind中的所有节点在nodeDatabase中都有对应记录
        function syncMindmapDataWithNodeDatabase() {
            console.log('🔗 执行数据融合...');
            
            let syncCount = 0;
            let newCount = 0;
            
            // 遍历所有思维导图
            Object.keys(mindmaps).forEach(mapId => {
                const mindmap = mindmaps[mapId];
                if (mindmap) {
                    console.log(`🔍 融合脑图: ${mapId}`);
                    
                    // 获取该脑图的数据
                    const mapData = mindmap.get_data();
                    if (mapData && mapData.data) {
                        // 递归遍历所有节点
                        traverseAndSyncNode(mapData.data);
                    }
                }
            });
            
            // 遍历节点并同步到nodeDatabase
            function traverseAndSyncNode(nodeData) {
                if (!nodeData || !nodeData.id) return;
                
                const nodeId = nodeData.id;
                const cleanTitle = nodeData.topic ? nodeData.topic.replace(' 📄', '') : '未命名节点';
                
                // 检查nodeDatabase中是否存在该节点
                if (!nodeDatabase[nodeId]) {
                    // 创建新的节点记录
                    nodeDatabase[nodeId] = {
                        id: nodeId,
                        title: cleanTitle,
                        content: '',
                        sessions: [], // 新增会话数据
                        author: projectInfo.author || 'NodeMind',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        tags: { categories: [], technical: [], status: [] }
                    };
                    newCount++;
                    console.log(`📝 创建节点记录: ${cleanTitle} (${nodeId})`);
                } else {
                    // 确保现有节点数据结构完整
                    const existingNode = nodeDatabase[nodeId];
                    
                    // 更新标题（如果节点标题在脑图中被修改）
                    if (existingNode.title !== cleanTitle) {
                        existingNode.title = cleanTitle;
                        existingNode.modified = new Date().toISOString();
                    }
                    
                    // 确保必要字段存在
                    if (!existingNode.sessions) existingNode.sessions = [];
                    if (!existingNode.tags) existingNode.tags = { categories: [], technical: [], status: [] };
                    if (!existingNode.author) existingNode.author = projectInfo.author || 'NodeMind';
                    if (!existingNode.created) existingNode.created = new Date().toISOString();
                    if (!existingNode.modified) existingNode.modified = new Date().toISOString();
                    
                    syncCount++;
                    console.log(`🔄 同步节点记录: ${cleanTitle} (${nodeId})`);
                }
                
                // 递归处理子节点
                if (nodeData.children && Array.isArray(nodeData.children)) {
                    nodeData.children.forEach(childNode => {
                        traverseAndSyncNode(childNode);
                    });
                }
            }
            
            console.log(`✅ 数据融合完成: 同步${syncCount}个节点，新建${newCount}个节点`);
            
            // 保存融合后的数据
            setTimeout(autoSaveData, 100);
        }
        
        // 绑定节点事件
        function bindNodeEvents() {
            console.log('🔗 开始绑定节点事件...');
            
            Object.keys(mindmaps).forEach(mapId => {
                const mindmap = mindmaps[mapId];
                if (mindmap) {
                    console.log(`🔗 绑定 ${mapId} 脑图事件`);
                    // 绑定节点选择事件  
                    mindmap.add_event_listener(function(type, data) {
                        console.log(`📡 接收到事件: ${type}, 数据:`, data);
                        // 兼容不同版本的事件类型
                        if (type === 'select' || type === 1 || (jsMind.event_type && type === jsMind.event_type.select)) {
                            handleNodeSelect(data.node, mapId);
                        } else if (type === 'edit' || type === 2 || (jsMind.event_type && type === jsMind.event_type.edit)) {
                            handleNodeEdit(data.node, mapId);
                        }
                    });
                } else {
                    console.log(`❌ ${mapId} 脑图不存在`);
                }
            });
            
            console.log('✅ 节点事件绑定完成');
            
            // 备用方案：直接绑定 DOM 点击事件
            setTimeout(() => {
                console.log('🔄 设置备用点击事件监听器...');
                const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        console.log(`✅ 为 ${containerId} 绑定备用点击事件`);
                        container.addEventListener('click', function(e) {
                            console.log('🖱️ 备用点击事件触发:', e.target);
                            
                            // 查找被点击的节点（支持多种节点元素）
                            let nodeElement = e.target.closest('jmnode');
                            if (!nodeElement) {
                                nodeElement = e.target.closest('[nodeid]');
                            }
                            if (!nodeElement && e.target.hasAttribute('nodeid')) {
                                nodeElement = e.target;
                            }
                            
                            if (nodeElement) {
                                const nodeId = nodeElement.getAttribute('nodeid');
                                const mapId = containerId.replace('jsmind_container_', '');
                                const mindmap = mindmaps[mapId];
                                
                                console.log(`🎯 找到节点: ${nodeId} 在 ${mapId}`);
                                
                                if (mindmap && nodeId) {
                                    const node = mindmap.get_node(nodeId);
                                    if (node) {
                                        console.log('🎯 备用方案：节点选中:', node.topic);
                                        handleNodeSelect(node, mapId);
                                    } else {
                                        console.log('❌ 无法获取节点对象:', nodeId);
                                    }
                                } else {
                                    console.log('❌ 思维导图或节点ID无效:', mapId, nodeId);
                                }
                            } else {
                                console.log('ℹ️ 点击的不是节点元素');
                            }
                        });
                    } else {
                        console.log(`❌ 容器不存在: ${containerId}`);
                    }
                });
                
                // 额外的全局点击监听器
                document.addEventListener('click', function(e) {
                    // 检查是否点击了jsmind节点
                    if (e.target.tagName === 'jmnode' || e.target.closest('jmnode')) {
                        console.log('🌐 全局节点点击检测:', e.target);
                        
                        let nodeElement = e.target.tagName === 'jmnode' ? e.target : e.target.closest('jmnode');
                        const nodeId = nodeElement.getAttribute('nodeid');
                        
                        if (nodeId) {
                            console.log(`🌐 全局检测到节点点击: ${nodeId}`);
                            
                            // 查找对应的思维导图
                            let mapId = null;
                            const containers = ['workspace', 'knowledge', 'project'];
                            
                            for (const containerId of containers) {
                                const container = document.getElementById(`jsmind_container_${containerId}`);
                                if (container && container.contains(nodeElement)) {
                                    mapId = containerId;
                                    break;
                                }
                            }
                            
                            if (mapId && mindmaps[mapId]) {
                                const node = mindmaps[mapId].get_node(nodeId);
                                if (node) {
                                    console.log('🌐 全局方案：节点选中:', node.topic);
                                    handleNodeSelect(node, mapId);
                                }
                            }
                        }
                    }
                });
                
                console.log('✅ 备用和全局点击事件监听器设置完成');
            }, 1000);
        }
        
        // 处理节点选择
        function handleNodeSelect(node, mapId) {
            if (!node) {
                console.log('❌ handleNodeSelect: 节点为空');
                return;
            }
            
            console.log(`🎯 节点选中: ${node.topic} (${node.id}) 在 ${mapId}`);
            
            // 设置全局变量
            selectedNodeId = node.id;
            currentMindmap = mapId;
            
            // 确保全局变量被正确设置
            window.selectedNodeId = node.id;
            window.currentMindmap = mapId;
            
            console.log(`📝 设置全局变量: selectedNodeId=${selectedNodeId}, currentMindmap=${currentMindmap}`);
            
            // 添加视觉反馈：高亮显示选中的节点
            try {
                highlightSelectedNode(node.id, mapId);
                console.log(`✅ 节点高亮完成: ${node.id}`);
            } catch (error) {
                console.log(`❌ 节点高亮失败:`, error);
            }
            
            // 更新状态显示
            const statusElement = document.getElementById('selectedNode');
            if (statusElement) {
                statusElement.textContent = node.topic || '无';
                console.log(`✅ 状态显示已更新: ${node.topic}`);
            }
            
            // 显示节点详细信息
            try {
                showNodeDetails(node);
                console.log(`✅ 节点详情显示完成`);
            } catch (error) {
                console.log(`❌ 节点详情显示失败:`, error);
            }
            
            console.log(`🎉 节点选择处理完成: ${node.topic} (${node.id})`);
        }
        
        // 高亮显示选中的节点（简化版，无动画）
        function highlightSelectedNode(nodeId, mapId) {
            // 移除之前的高亮
            document.querySelectorAll('.jmnode-selected').forEach(el => {
                el.classList.remove('jmnode-selected');
            });
            
            // 高亮当前选中的节点（仅静态高亮，无动画）
            const container = document.getElementById(`jsmind_container_${mapId}`);
            if (container) {
                const nodeElement = container.querySelector(`jmnode[nodeid="${nodeId}"]`);
                if (nodeElement) {
                    nodeElement.classList.add('jmnode-selected');
                }
            }
        }
        
        // 显示节点选择反馈动画（已禁用）
        function showNodeSelectionFeedback(node) {
            // 功能已禁用 - 不显示节点选择反馈动画
            return;
        }
        
        // 简化的节点编辑处理 - 使用MD直存逻辑
        async function handleNodeEdit(node, mapId) {
            if (!node) return;
            
            console.log(`📝 节点编辑: ${node.topic} (${node.id})`);
            
            // 获取纯净的标题
            const cleanTitle = node.topic.replace(' 📄', '');
            
            // 立即更新nodeDatabase（确保数据持久化）
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            } else {
                nodeDatabase[node.id].title = cleanTitle;
                nodeDatabase[node.id].modified = new Date().toISOString();
            }
            
            // 同步更新四组件数据
            if (!fourComponentNodeState.nodeData[node.id]) {
                fourComponentNodeState.nodeData[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: nodeDatabase[node.id].content || '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            } else {
                fourComponentNodeState.nodeData[node.id].title = cleanTitle;
                fourComponentNodeState.nodeData[node.id].updateTime = new Date().toLocaleString('zh-CN');
            }
            
            // 立即保存到localStorage
            saveFourComponentData();
            autoSaveData();
            console.log(`💾 节点标题已立即保存: ${cleanTitle}`);
            
            // 使用MD直存服务的简洁逻辑（异步处理）
            try {
                const service = await initMDDirectService();
                
                // 构造MD格式内容
                const existingData = nodeDatabase[node.id];
                const mdContent = `# ${cleanTitle}\n\n${existingData?.content || ''}`;
                
                // 使用MD直存逻辑更新
                const result = await service.addMDContent(mdContent, {
                    nodeId: node.id,
                    updateExisting: true
                });
                
                if (result.success) {
                    console.log(`✅ MD直存同步成功: ${cleanTitle}`);
                }
            } catch (error) {
                console.error('❌ MD直存同步失败:', error);
                // 数据已经保存到nodeDatabase，不影响持久化
            }
            
            // 如果当前正在显示该节点，刷新显示
            if (selectedNodeId === node.id || fourComponentNodeState.currentNode === node.id) {
                updateFourComponentsForNode(node.id);
            }
            
            // 关键修复：立即更新思维导图显示
            const mindmap = mindmaps[mapId];
            if (mindmap) {
                // 检查节点是否有内容，决定是否显示内容图标
                const hasContent = nodeDatabase[node.id].content && nodeDatabase[node.id].content.trim().length > 0;
                const displayTitle = hasContent ? `${cleanTitle} 📄` : cleanTitle;
                
                // 更新思维导图中的节点显示
                mindmap.update_node(node.id, displayTitle);
                console.log(`🔄 思维导图显示已更新: ${displayTitle}`);
            }
        }
        
        // 简化的节点详情显示 - 使用MD直存逻辑
        async function showNodeDetails(node) {
            if (!node) {
                console.log('❌ showNodeDetails: 节点为空');
                return;
            }
            
            console.log(`📝 显示节点详情: ${node.topic} (${node.id})`);
            
            // 简化的当前内容保存 - 使用MD直存逻辑
            const currentNodeId = fourComponentNodeState.currentNode;
            if (currentNodeId && currentNodeId !== node.id) {
                await saveCurrentNodeContentViaMD(currentNodeId);
            }
            
            // 获取纯净的标题
            const cleanTitle = node.topic.replace(' 📄', '');
            
            // 确保节点数据存在（使用简化逻辑）
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
                console.log(`📂 创建新节点数据: ${node.id}`);
            } else {
                // 同步标题
                nodeDatabase[node.id].title = cleanTitle;
            }
            
            // 切换到节点信息标签页
            switchToDetailTab();
            
            // 更新四组件显示
            updateFourComponentsForNode(node.id);
        }
        
        // 使用MD直存逻辑保存当前节点内容
        async function saveCurrentNodeContentViaMD(nodeId) {
            if (!nodeId) return;
            
            console.log(`💾 使用MD直存逻辑保存节点: ${nodeId}`);
            
            try {
                const contentEditor = document.getElementById('content-editor');
                const titleElement = document.getElementById('node-title') || 
                                   document.querySelector('#title-area .node-title');
                
                if (contentEditor) {
                    const content = contentEditor.value;
                    const title = nodeDatabase[nodeId]?.title || '未命名';
                    
                    // 构造MD格式内容
                    const mdContent = `# ${title}\n\n${content}`;
                    
                    // 使用MD直存服务保存
                    const service = await initMDDirectService();
                    const result = await service.addMDContent(mdContent, {
                        nodeId: nodeId,
                        updateExisting: true
                    });
                    
                    if (result.success) {
                        console.log(`✅ MD直存保存成功: ${nodeId}`);
                    }
                }
            } catch (error) {
                console.error('❌ MD直存保存失败:', error);
                
                // 降级到简单保存
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor && nodeDatabase[nodeId]) {
                    nodeDatabase[nodeId].content = contentEditor.value;
                    nodeDatabase[nodeId].modified = new Date().toISOString();
                    autoSaveData();
                }
            }
        }
        
        // 清理其他标签页的内容，防止内容混淆
        function clearOtherTabContents() {
            // 不再重置injection内容，因为它现在是节点信息页面
            
            // 重置项目信息标签页内容（保持校准功能）
            const projectContent = document.getElementById('project-info-content');
            if (projectContent) {
                projectContent.innerHTML = `
                    <div class="basic-info-panel">
                        <h4>📋 项目基本信息</h4>
                        <div class="project-buttons">
                            <button class="calibrate-btn" onclick="performCalibration()">校准</button>
                            <button class="template-manager-btn" onclick="openTemplateManager()">提示词模板管理</button>
                        </div>
                        <div class="info-item">
                            <label>项目名称:</label>
                            <span id="project-name-display">NodeMind 思维导图</span>
                        </div>
                        <div class="info-item">
                            <label>项目路径:</label>
                            <span id="project-path-display">未设置</span>
                        </div>
                        <div class="info-item">
                            <label>版本:</label>
                            <span>1.0.0</span>
                        </div>
                        <div class="info-item">
                            <label>作者:</label>
                            <span>NodeMind Team</span>
                        </div>
                        <div class="info-item">
                            <label>描述:</label>
                            <span>基于jsMind的思维导图应用</span>
                        </div>
                        <div class="calibration-info" id="calibration-info" style="display: none;">
                            <div class="info-item">
                                <label>应用名称:</label>
                                <span id="app-name-display">-</span>
                            </div>
                            <div class="info-item">
                                <label>状态:</label>
                                <span id="calibration-status" class="status-uncalibrated">未校准</span>
                            </div>
                            <div class="info-item">
                                <label>输入框坐标:</label>
                                <span id="input-coordinates">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="node-info-panel">
                        <h4>📝 当前节点信息</h4>
                        <div class="info-item">
                            <label>节点作者:</label>
                            <input type="text" id="project-node-author" class="meta-input" 
                                   value="" placeholder="输入作者信息">
                        </div>
                    </div>
                `;
                // 重新初始化项目信息
                initProjectInfo();
            }
        }
        
        // 切换到节点信息标签页
        function switchToDetailTab() {
            switchDetailTab('injection');
        }
        
        // 切换详情面板标签页（改进版本，添加更严格的检查和动画效果）
        function switchDetailTab(tabId) {
            console.log(`🔄 切换到详情面板标签页: ${tabId}`);
            
            // 移除了切换动画提示
            
            // 移除所有详情面板标签页的active状态
            document.querySelectorAll('.details-panel .tab-button').forEach(btn => {
                btn.classList.remove('active');
                // 移除之前的高亮效果
                btn.style.transform = '';
                btn.style.boxShadow = '';
            });
            
            document.querySelectorAll('.details-panel .tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none'; // 强制隐藏
            });
            
            // 激活指定的标签页
            const tabButton = document.getElementById(`detail_tab_${tabId}`);
            const tabContent = document.getElementById(`tab-${tabId}`);
            
            if (tabButton && tabContent) {
                tabButton.classList.add('active');
                tabContent.classList.add('active');
                tabContent.style.display = 'block'; // 强制显示
                
                // 移除了按钮闪烁效果
                
                console.log(`✅ 成功切换到详情面板标签页: ${tabId}`);
                
                // 确保切换后内容正确显示
                setTimeout(() => {
                    // 清理任何可能残留的表单内容
                    clearNodeFormFromTab(tabContent);
                    
                    // 如果是节点信息标签页，确保四组件正确初始化
                    if (tabId === 'injection') {
                        initializeFourComponents();
                        
                        // 如果有当前选中的节点，立即更新
                        if (selectedNodeId) {
                            updateFourComponentsForNode(selectedNodeId);
                        }
                    }
                }, 100);
            } else {
                console.log(`❌ 找不到标签页元素: detail_tab_${tabId} 或 tab-${tabId}`);
            }
        }
        
        // 显示标签页切换反馈（已禁用）
        function showTabSwitchFeedback(tabId) {
            // 功能已禁用 - 不显示标签页切换反馈
            return;
        }
        
        // 从指定标签页清理节点表单内容（防止内容泄露到其他标签页）
        function clearNodeFormFromTab(tabElement) {
            if (!tabElement) return;
            
            const forms = tabElement.querySelectorAll('.node-detail-form');
            forms.forEach(form => {
                if (tabElement.id !== 'tab-injection') {
                    // 如果不是节点信息标签页，移除任何节点表单
                    console.log(`🧹 从 ${tabElement.id} 清理节点表单`);
                    form.remove();
                }
            });
        }
        
        // 更新节点标题
        function updateNodeTitle(nodeId, title) {
            if (nodeDatabase[nodeId]) {
                nodeDatabase[nodeId].title = title;
                nodeDatabase[nodeId].modified = new Date().toISOString();
                
                // 同步更新思维导图显示
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const node = currentMindmapInstance.get_node(nodeId);
                    if (node) {
                        // 保持内容图标
                        const hasContent = nodeDatabase[nodeId].content && nodeDatabase[nodeId].content.trim().length > 0;
                        const displayTitle = hasContent ? `${title} 📄` : title;
                        currentMindmapInstance.update_node(nodeId, displayTitle);
                    }
                }
                
                // *** 添加自动保存 ***
                setTimeout(autoSaveData, 200);
            }
        }
        
        // 更新节点内容
        function updateNodeContent(nodeId, content) {
            console.log(`📝 更新节点内容: ${nodeId}`, content ? `长度${content.length}` : '空内容');
            
            // 确保节点数据存在
            if (!nodeDatabase[nodeId]) {
                console.log(`⚠️ 节点数据不存在，正在创建: ${nodeId}`);
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: '未命名节点',
                    content: '',
                    sessions: [],
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            // 更新节点内容
            nodeDatabase[nodeId].content = content || '';
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            // 解析内容更新会话数据
            parseContentToSessions(nodeId, content);
            
            // 更新节点显示图标
            updateNodeContentIcon(nodeId, content);
            
            // 触发自动保存
            setTimeout(autoSaveData, 200);
            
            console.log(`✅ 节点内容已更新: ${nodeId}`);
        }
        
        // 从完整MD内容解析回会话数据
        function parseContentToSessions(nodeId, content) {
            initializeNodeSessions(nodeId);
            
            // *** 修复会话被意外清除的BUG ***
            if (!content || content.trim() === '') {
                // 🔒 保护现有会话：内容为空时不自动清空会话
                // 只有在明确的删除操作时才清空，而不是因为内容临时为空
                console.log(`📝 内容为空，但保留现有会话: ${nodeId}`);
                
                // 如果没有任何会话，就不需要做任何处理
                if (sessionDatabase[nodeId].sessions.length === 0) {
                    console.log(`💡 没有现有会话，无需处理: ${nodeId}`);
                    return;
                }
                
                // 保留现有会话，只重新渲染列表（不清空数据）
                const sessionListContainer = document.getElementById(`session-list-${nodeId}`);
                if (sessionListContainer) {
                    renderSessionList(nodeId);
                }
                
                console.log(`✅ 已保护 ${sessionDatabase[nodeId].sessions.length} 个现有会话`);
                return;
            }
            
            // 按标题分割内容
            const sections = content.split(/^# /m).filter(section => section.trim());
            const sessions = [];
            
            sections.forEach((section, index) => {
                const lines = section.trim().split('\n');
                const title = lines[0].trim();
                const sessionContent = lines.slice(1).join('\n').trim();
                
                // 查找现有会话或创建新会话
                let existingSession = sessionDatabase[nodeId].sessions.find(s => s.title === title);
                
                if (existingSession) {
                    // 更新现有会话
                    existingSession.content = sessionContent;
                    existingSession.lastModified = new Date().toISOString();
                    sessions.push(existingSession);
                } else {
                    // 创建新会话
                    const newSession = {
                        id: `session-${nodeId}-${Date.now()}-${index}`,
                        title: title,
                        content: sessionContent,
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };
                    sessions.push(newSession);
                }
            });
            
            // 更新会话数据
            sessionDatabase[nodeId].sessions = sessions;
            
            // 重新渲染会话列表
            const sessionListContainer = document.getElementById(`session-list-${nodeId}`);
            if (sessionListContainer) {
                renderSessionList(nodeId);
            }
            
            // 保存到本地存储
            saveSessionData();
        }
        
        // 更新节点作者
        function updateNodeAuthor(nodeId, author) {
            if (nodeDatabase[nodeId]) {
                nodeDatabase[nodeId].author = author;
                nodeDatabase[nodeId].modified = new Date().toISOString();
            }
        }
        
        // 更新节点内容图标
        function updateNodeContentIcon(nodeId, content) {
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                const node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    const hasContent = content && content.trim().length > 0;
                    const originalTopic = nodeDatabase[nodeId].title || node.topic;
                    const newTopic = hasContent ? `${originalTopic} 📄` : originalTopic.replace(' 📄', '');
                    
                    if (node.topic !== newTopic) {
                        currentMindmapInstance.update_node(nodeId, newTopic);
                    }
                }
            }
        }
        
        // 保存节点详情
        function saveNodeDetails(nodeId) {
            autoSaveData();
            showMessage('💾 节点详情已保存', 1500);
        }
        
        // 提交内容（一键注入到Cursor功能）
        async function submitContent(nodeId) {
            console.log(`🚀 开始提交内容: ${nodeId}`);
            
            // 获取内容编辑器
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容编辑器', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            
            // 获取节点信息
            const nodeData = nodeDatabase[nodeId] || {};
            const nodeTitle = (nodeData.title || `节点${nodeId}`).trim();
            
            // 构建注入内容（标题+内容格式）
            let injectionContent = '';
            
            if (nodeTitle && content) {
                // 都存在：使用 "- 标题\n- 内容" 格式
                injectionContent = `- ${nodeTitle}\n- ${content}`;
            } else if (nodeTitle) {
                // 只有标题：直接使用标题
                injectionContent = nodeTitle;
            } else if (content) {
                // 只有内容：直接使用内容
                injectionContent = content;
            } else {
                // 都没有：提示错误
                showMessage('❌ 请先输入标题或内容', 2000, 'error');
                return;
            }
            
            try {
                // 创建一键注入的JSON协议（借鉴node_mind_injection_page.html）
                const injectionData = {
                    source: 'nodemind',
                    type: 'content-injection',
                    content: injectionContent,
                    direct_inject: true,  // 关键：标识为直接注入
                    timestamp: new Date().toISOString(),
                    nodeId: nodeId,
                    nodeTitle: nodeTitle,
                    projectName: 'NodeMind'
                };

                // 构建完整的剪贴板内容
                const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                // 复制到剪贴板
                await navigator.clipboard.writeText(clipboardContent);

                // 显示成功消息
                showMessage('🎯 一键注入已触发！injection工具正在自动执行注入流程...', 3000, 'success');
                
                // 获取提交按钮并更新状态
                const submitButton = document.querySelector(`button[onclick="submitContent('${nodeId}')"]`);
                if (submitButton) {
                    const originalText = submitButton.textContent;
                    submitButton.textContent = '✅ 注入已触发';
                    submitButton.disabled = true;
                    
                    // 2秒后恢复按钮
                    setTimeout(() => {
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                    }, 2000);
                }

                // 在内容末尾添加[已注入]标签
                if (content && !content.includes('[已注入]')) {
                    const newContent = content + '\n[已注入]';
                    contentEditor.value = newContent;
                    
                    // 保存到nodeDatabase
                    if (nodeDatabase[nodeId]) {
                        nodeDatabase[nodeId].content = newContent;
                    }
                    
                    console.log('✅ 已添加[已注入]标签到内容');
                }

                console.log('🎯 一键注入协议已发送:', injectionData);
                
                // 记录到日志
                const logEntry = `${new Date().toLocaleString()} - 节点 "${nodeTitle}" 标题+内容已注入到Cursor`;
                console.log(logEntry);

            } catch (error) {
                console.error('一键注入失败:', error);
                showMessage('❌ 一键注入失败：' + error.message, 3000, 'error');
            }
        }
        
        // 切换问答模式
        function toggleQAMode(nodeId, isQAMode) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            const templateSection = document.getElementById(`template-section-${nodeId}`);
            
            if (!contentEditor) {
                console.error('找不到内容编辑器');
                return;
            }
            
            if (isQAMode) {
                // 开启问答模式
                contentEditor.placeholder = "AI交互，指令，提问，提示词输入区。一次问答或者指令-回复，算是一";
                contentEditor.style.color = "#6c757d";
                contentEditor.style.fontStyle = "italic";
                
                // 激活提示词模板
                if (templateSection) {
                    templateSection.style.opacity = "1";
                    templateSection.style.pointerEvents = "auto";
                    const templateItems = templateSection.querySelectorAll('.template-item');
                    templateItems.forEach(item => {
                        item.style.cursor = "pointer";
                        item.style.opacity = "1";
                    });
                }
                
                console.log(`✅ 问答模式已开启: ${nodeId}`);
                showMessage('🤖 问答模式已开启', 1500, 'success');
            } else {
                // 关闭问答模式
                contentEditor.placeholder = "在此输入详细内容...";
                contentEditor.style.color = "";
                contentEditor.style.fontStyle = "";
                
                // 禁用提示词模板
                if (templateSection) {
                    templateSection.style.opacity = "0.5";
                    templateSection.style.pointerEvents = "none";
                    const templateItems = templateSection.querySelectorAll('.template-item');
                    templateItems.forEach(item => {
                        item.style.cursor = "not-allowed";
                        item.style.opacity = "0.5";
                    });
                }
                
                console.log(`✅ 问答模式已关闭: ${nodeId}`);
                showMessage('📝 内容编辑模式已开启', 1500, 'success');
            }
        }
        
        // 拷贝内容框内容
        function copyContentFromEditor(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容框', 2000, 'error');
                return;
            }
            
            if (contentEditor.value.trim() === '') {
                showMessage('⚠️ 内容框为空，无内容可拷贝', 2000, 'warning');
                return;
            }
            
            try {
                // 使用现代API进行拷贝
                navigator.clipboard.writeText(contentEditor.value).then(() => {
                    showMessage('📋 内容已拷贝到剪贴板', 1500, 'success');
                }).catch(() => {
                    // 降级方案
                    contentEditor.select();
                    document.execCommand('copy');
                    showMessage('📋 内容已拷贝到剪贴板', 1500, 'success');
                });
            } catch (error) {
                showMessage('❌ 拷贝失败：' + error.message, 2000, 'error');
            }
        }
        
        // 粘贴到内容框
        function pasteContentToEditor(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容框', 2000, 'error');
                return;
            }
            
            try {
                // 使用现代API进行粘贴
                navigator.clipboard.readText().then(text => {
                    if (text.trim() === '') {
                        showMessage('⚠️ 剪贴板为空', 2000, 'warning');
                        return;
                    }
                    
                    contentEditor.value = text;
                    contentEditor.focus();
                    showMessage('📋 内容已粘贴', 1500, 'success');
                }).catch(() => {
                    // 如果没有权限，提示用户手动粘贴
                    contentEditor.focus();
                    showMessage('💡 请使用 Ctrl+V 手动粘贴', 2000, 'info');
                });
            } catch (error) {
                showMessage('❌ 粘贴失败：' + error.message, 2000, 'error');
            }
        }
        
        // === 会话管理功能已模块化到 SessionService ===
        // 保留必要的全局变量和初始化代码
        let sessionDatabase = {};
        
        // 页面加载时初始化会话数据
        document.addEventListener('DOMContentLoaded', function() {
            // 会话数据加载由 SessionService 处理
        });
        
        // === UI分割器功能已模块化到 Splitter 组件 ===
        
        // === 右侧面板分割器功能已模块化到 Splitter 组件 ===
        
        // 更新项目信息页面的节点作者信息
        function updateProjectInfoNodeAuthor(authorValue) {
            const authorInput = document.getElementById('project-node-author');
            if (authorInput) {
                authorInput.value = authorValue || '';
            }
        }
        
        // 从项目信息页面更新当前节点的作者信息
        function updateCurrentNodeAuthor(authorValue) {
            if (selectedNodeId) {
                updateNodeAuthor(selectedNodeId, authorValue);
            }
        }
        
        // === 校准功能模块 - 独立模块，不影响其他功能 ===
        
        // 模板管理系统 - 基于文档设计
        var templateManager = {
            templates: {
                '自然模式': {
                    versions: [
                        {
                            name: '默认模板',
                            prefix: '你好，我需要你的帮助。',
                            suffix: '请详细回答，谢谢。'
                        },
                        {
                            name: '友好模式',
                            prefix: '希望能得到你的专业建议：',
                            suffix: '非常感谢你的帮助！'
                        }
                    ]
                },
                '技术模式': {
                    versions: [
                        {
                            name: '代码分析',
                            prefix: '请分析以下技术问题：',
                            suffix: '请提供具体的解决方案和代码示例。'
                        },
                        {
                            name: '架构设计',
                            prefix: '需要进行系统架构设计：',
                            suffix: '请考虑可扩展性和性能优化。'
                        }
                    ]
                },
                '创意模式': {
                    versions: [
                        {
                            name: '头脑风暴',
                            prefix: '让我们一起思考创新方案：',
                            suffix: '期待听到你的创意想法！'
                        },
                        {
                            name: '方案优化',
                            prefix: '当前方案需要改进：',
                            suffix: '请提供多个优化建议。'
                        }
                    ]
                }
            },
            currentScene: '',
            currentVersion: '',
            
            getScenes: function() {
                return Object.keys(this.templates);
            },
            
            getVersions: function(scene) {
                if (scene && this.templates[scene]) {
                    return this.templates[scene].versions.map(v => v.name);
                }
                return [];
            },
            
            getTemplate: function(scene, version) {
                if (scene && version && this.templates[scene]) {
                    return this.templates[scene].versions.find(v => v.name === version);
                }
                return null;
            }
        };
        
        // === 校准系统 - 基于injection工具完整实现 ===
        
        function performCalibration() {
            console.log('🎯 校准功能已禁用');
            alert('校准功能暂时不可用');
        }
        

        

        

        

        

        

        

        

        

        

        

        
        // === 命令注入功能已模块化到 InjectionService ===
        
        // === 模板管理功能已模块化到 TemplateService ===
        
        // === openTemplateManager 函数已模块化到 TemplateService ===

        // 初始化模板管理器内容
        function initializeTemplateManagerContent() {
            try {
                const modalBody = document.querySelector('#template-manager-container .modal-body');
                if (!modalBody) return;

                // 尝试使用完整模板管理器系统
                if (typeof window.TemplateManagerEntry !== 'undefined') {
                    console.log('🎯 使用完整模板管理器系统');
                    window.TemplateManagerEntry.initialize();
                } else {
                    console.log('🎯 加载injection提示词模板系统');
                    // 基于injection提示词模板系统的卡片式模板列表
                    modalBody.innerHTML = `
                        <div style="padding: 20px;">
                            <!-- 新增模板按键 -->
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button onclick="addNewTemplate()" class="add-template-btn" style="padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s ease;">
                                    ➕ 新增模板
                                </button>
                            </div>
                            
                            <!-- 模块化强制说明 -->
                            <div style="margin-bottom: 20px; padding: 12px; background: linear-gradient(90deg, #e8f5e8, #f0f8f0); border-left: 4px solid #28a745; border-radius: 6px;">
                                <h4 style="margin: 0 0 8px 0; color: #155724; font-size: 16px;">🏗️ 模块化强制约束</h4>
                                <p style="margin: 0; color: #155724; font-size: 14px; line-height: 1.4;">
                                    <strong>所有模板都自动包含模块化开发规范！</strong><br>
                                    无需单独选择，每个模板使用时都会强制添加模块化约束前缀和检查清单后缀。
                                </p>
                            </div>
                            
                            <!-- 模板分类标签 -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #495057; font-size: 18px;">📋 模板分类标签：</h4>
                                <div id="template-filter-tags" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <button class="filter-tag active" data-category="all" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        🏷️ 全部
                                    </button>
                                    <button class="filter-tag" data-category="natural" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        🗣️ 自然模式
                                    </button>
                                    <button class="filter-tag" data-category="code" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        💻 代码类
                                    </button>
                                    <button class="filter-tag" data-category="log" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        📝 日志类
                                    </button>
                                    <button class="filter-tag" data-category="feature" onclick="toggleFilterTag(this)" style="padding: 6px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                                        ✨ 新功能类
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 模板卡片容器 -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                
                                <!-- 自然模式 -->
                                <div class="template-card" data-category="natural" data-template-id="自然模式" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">🗣️ 自然模式</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('自然模式'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('自然模式'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('自然模式'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">常规对话模式，指向项目日志文档</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>"日志"一般是指{项目名称}-log.md文档
                                    </div>
                                </div>

                                <!-- 代码自查 -->
                                <div class="template-card" data-category="code" data-template-id="代码自查" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">🔍 代码自查</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('代码自查'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('代码自查'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('代码自查'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">代码质量检查和问题排查</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>主要功能点，是否有重复的实现逻辑，路径错误检查...
                                    </div>
                                </div>

                                <!-- 修改代码 -->
                                <div class="template-card" data-category="code" data-template-id="修改代码" style="padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">⚡ 修改代码</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">包含完整的代码外科手术协议</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>后缀：</strong>【代码修改外科手术协议】⚡️ 严谨的代码外科医生规范...
                                    </div>
                                </div>

                                <!-- 不生效 -->
                                <div class="template-card" data-category="code" data-template-id="不生效" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('不生效')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">❌ 不生效</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">代码修改不生效问题诊断</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>后缀：</strong>修改代码没有生效的6个常见原因分析...
                                    </div>
                                </div>

                                <!-- 日志-修改代码 -->
                                <div class="template-card" data-category="log" data-template-id="日志-修改代码" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('日志-修改代码')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">📝 日志-修改代码</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('日志-修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('日志-修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('日志-修改代码'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">结合代码外科手术协议和工作日志记录</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>功能：</strong>修改规范 + 日志格式要求
                                    </div>
                                </div>

                                <!-- 日志-不生效 -->
                                <div class="template-card" data-category="log" data-template-id="日志-不生效" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('日志-不生效')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">📋 日志-不生效</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('日志-不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('日志-不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('日志-不生效'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">结合代码不生效诊断和工作日志记录</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>功能：</strong>问题诊断 + 日志记录
                                    </div>
                                </div>

                                <!-- 日志-新功能 -->
                                <div class="template-card" data-category="log" data-template-id="日志-新功能" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('日志-新功能')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">🚀 日志-新功能</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('日志-新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('日志-新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('日志-新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">最小化代码实现原则，新功能开发</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>认真回答问题<br>
                                        <strong>后缀：</strong>遵循最小化代码实现原则
                                    </div>
                                </div>

                                <!-- 新功能 -->
                                <div class="template-card" data-category="feature" data-template-id="新功能" style="padding: 16px; border-radius: 8px; cursor: pointer;" ondblclick="toggleTemplateSelection('新功能')">
                                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px; font-weight: 600;">✨ 新功能</h4>
                                        <div style="display: flex; gap: 4px; margin-left: auto;">
                                            <button onclick="toggleTemplateSelection('新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="选择此模板">✓</button>
                                            <button onclick="editTemplate('新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️</button>
                                            <button onclick="deleteTemplate('新功能'); event.stopPropagation();" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️</button>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.4;">遵循最小化代码实现原则的新功能开发</p>
                                    <div class="template-preview" style="padding: 8px; border-radius: 6px; font-size: 12px;">
                                        <strong>前缀：</strong>遵循最小化代码实现原则。不得任意增加指令以外的功能
                                    </div>
                                </div>



                            </div>
                            
                            <!-- 底部功能区 -->
                            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e9ecef; text-align: center;">
                                <p style="margin: 0 0 8px 0; color: #6c757d; font-size: 14px;">💡 基于injection提示词模板系统 - 支持前缀/后缀模板和变量替换</p>
                                <p style="margin: 0 0 12px 0; color: #28a745; font-size: 13px; font-weight: 600;">🏗️ 所有模板自动包含强制模块化开发规范 - 确保代码架构一致性</p>
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button onclick="importTemplates()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">📥 导入模板</button>
                                    <button onclick="exportTemplates()" style="padding: 8px 16px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer;">📤 导出模板</button>
                                    <button onclick="initializeTemplateManagerContent()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">🔄 刷新</button>
                                </div>
                            </div>
                        </div>
                        
                        <style>
                        /* 现代工程风格 - 浅色系配色 */
                        .template-card {
                            border: 1px solid #e8ecef !important;
                            background: #ffffff !important;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
                            transition: all 0.2s ease !important;
                        }
                        .template-card:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
                            border-color: #6c757d !important;
                        }
                        .template-card.hidden {
                            display: none !important;
                        }
                        .template-card.selected {
                            border-color: #28a745 !important;
                            border-width: 2px !important;
                            box-shadow: 0 2px 8px rgba(40,167,69,0.2) !important;
                        }
                        .template-card.selected:hover {
                            border-color: #218838 !important;
                            box-shadow: 0 4px 12px rgba(40,167,69,0.3) !important;
                        }
                        .template-card h4 {
                            color: #495057 !important;
                        }
                        .template-card p {
                            color: #6c757d !important;
                        }
                        .template-card .template-preview {
                            background: #f8f9fa !important;
                            border: 1px solid #e9ecef !important;
                            color: #495057 !important;
                        }
                        
                        /* 过滤标签 - 浅色系 */
                        .filter-tag {
                            background: #f8f9fa !important;
                            color: #495057 !important;
                            border: 1px solid #dee2e6 !important;
                            transition: all 0.2s ease !important;
                        }
                        .filter-tag.active {
                            background: #e9ecef !important;
                            color: #212529 !important;
                            border-color: #adb5bd !important;
                            font-weight: 600 !important;
                        }
                        .filter-tag:hover {
                            background: #e9ecef !important;
                            color: #212529 !important;
                            border-color: #adb5bd !important;
                        }
                        
                        /* 按钮优化 - 浅色系 */
                        .template-card button {
                            transition: all 0.2s ease !important;
                        }
                        .template-card button:hover {
                            transform: scale(1.05);
                        }
                        
                        /* 新增模板按钮 */
                        .add-template-btn {
                            background: #28a745 !important;
                            border: none !important;
                            color: white !important;
                            box-shadow: 0 2px 4px rgba(40,167,69,0.2) !important;
                        }
                        .add-template-btn:hover {
                            background: #218838 !important;
                            transform: translateY(-1px);
                            box-shadow: 0 4px 8px rgba(40,167,69,0.3) !important;
                        }
                        </style>
                    `;
                }
            } catch (error) {
                console.error('❌ 模板管理器初始化失败:', error);
            }
        }

        // 绑定模板管理器事件
        function bindTemplateManagerEvents() {
            // 返回按键
            const backButton = document.getElementById('template_manager_back_button');
            if (backButton) {
                backButton.onclick = closeTemplateManager;
            }

            // 关闭按键
            const closeButton = document.getElementById('template_manager_close_button');
            if (closeButton) {
                closeButton.onclick = closeTemplateManager;
            }

            // 背景点击关闭
            const backdrop = document.getElementById('template_manager_backdrop');
            if (backdrop) {
                backdrop.onclick = closeTemplateManager;
            }

            // ESC键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const container = document.getElementById('template-manager-container');
                    const editModal = document.getElementById('template-edit-modal');
                    
                    if (editModal && editModal.style.display !== 'none') {
                        closeTemplateEditModal();
                    } else if (container && container.style.display !== 'none') {
                        closeTemplateManager();
                    }
                }
            });
        }

        // 关闭模板管理器
        function closeTemplateManager() {
            const templateManagerContainer = document.getElementById('template-manager-container');
            if (templateManagerContainer) {
                templateManagerContainer.style.display = 'none';
                console.log('✅ 提示词模板管理器已关闭');
            }
        }

        // 全局变量存储模板数据  
        // let selectedTemplates = []; // 已迁移到模板选择服务中管理
        
        // 全局强制模块化前缀 - 所有模板都将自动包含此约束
        const GLOBAL_MODULAR_PREFIX = `🏗️ 【NodeMind强制模块化开发规范】

📋 **项目架构要求**：
- 项目已完成模块化解耦，必须严格遵循既定架构
- 禁止在index.html中添加内联JavaScript代码
- 所有新功能必须放入对应的模块文件中

📁 **模块化目录结构**：
\`\`\`
src/
├── services/          # 业务逻辑服务层
│   ├── mindmap_service.js    # 思维导图核心服务
│   ├── node_service.js       # 节点管理服务
│   ├── tag_service.js        # 标签管理服务
│   ├── storage_service.js    # 数据存储服务
│   ├── project_service.js    # 项目信息服务
│   └── template_service.js   # 模板管理服务
├── controllers/       # 控制器层
│   ├── ui_controller.js      # UI控制器
│   └── context_menu_controller.js # 菜单控制器
├── ui/components/     # UI组件层
│   ├── node_details_ui.js    # 节点详情组件
│   ├── project_info_ui.js    # 项目信息组件
│   └── md_browser_ui.js      # MD浏览器组件
├── utils/             # 工具层
│   └── utils.js              # 通用工具函数
├── event_bus.js       # 事件总线（统一通信）
├── state.js          # 状态管理
└── app.js            # 应用入口
\`\`\`

⚡ **强制要求**：
1. **新功能模块归属**：明确指定功能应放入哪个具体模块文件
2. **避免重复实现**：检查现有模块，复用已有功能，删除重复代码
3. **事件总线通信**：模块间通信必须使用src/event_bus.js
4. **统一工具函数**：使用src/utils/utils.js中的showMessage等函数
5. **状态管理集中**：使用src/services/state.js管理应用状态

🚫 **严禁行为**：
- ❌ 在index.html中写内联JavaScript
- ❌ 创建重复的工具函数（如showMessage）
- ❌ 绕过模块化直接操作DOM
- ❌ 忽略现有的服务层接口

📝 **代码实现要求**：

`;

        // 全局强制模块化后缀 - 所有模板都将自动包含此检查清单
        const GLOBAL_MODULAR_SUFFIX = `

🔍 **模块化检查清单**：
- [ ] 功能已放入正确的模块文件
- [ ] 使用了统一的事件总线通信
- [ ] 复用了现有的工具函数
- [ ] 遵循了单一职责原则
- [ ] 避免了代码重复
- [ ] 更新了相关的导入导出

📋 **变更报告格式**：
\`\`\`diff
# 模块化变更报告
## 修改文件：src/services/[模块名].js
+ 新增功能：[具体功能描述]
+ 复用组件：[使用的现有模块]
+ 事件通信：[使用的事件类型]
## 架构合规性：✅ 完全符合模块化规范
\`\`\`

⚠️ **重要提醒**：本项目已完成模块化架构，任何违反模块化原则的代码都将导致架构退化，必须严格遵循以上规范！`;

        window.templateData = {
            '自然模式': {
                name: '🗣️ 自然模式',
                description: '常规对话模式，专注项目日志文档记录',
                category: 'natural',
                prefix: `📋 **工作日志模式**：
- 当前项目的"日志"特指：{项目名称}-log.md 文档
- 请基于项目上下文进行对话，参考已有的工作记录
- 优先查阅现有日志内容，保持工作连续性`,
                suffix: `
💡 **记录要求**：
- 如有重要发现或决策，建议记录到项目日志中
- 保持工作记录的完整性和可追溯性`
            },
            '代码自查': {
                name: '🔍 代码自查',
                description: '系统性代码质量检查和问题排查',
                category: 'code',
                prefix: `🔍 **代码质量自查清单**：
1. **功能完整性**：检查主要功能点是否完整实现
2. **逻辑重复**：识别重复的实现逻辑，提出合并建议  
3. **路径正确性**：验证文件路径、导入路径的准确性
4. **依赖关系**：检查模块间依赖是否合理
5. **性能问题**：识别潜在的性能瓶颈
6. **安全隐患**：检查常见的安全问题`,
                suffix: `
📊 **输出格式**：
- ✅ 正常项目：列出检查通过的项目
- ⚠️ 需要注意：列出潜在风险点
- ❌ 严重问题：列出必须修复的问题
- 💡 优化建议：提供具体的改进方案`
            },
            '修改代码': {
                name: '⚡ 修改代码',
                description: '遵循代码外科手术协议的精确修改',
                category: 'code',
                prefix: `⚡ **代码外科手术协议启动**：
1. **术前诊断**：详细分析现有代码结构和问题根因
2. **手术方案**：制定最小化影响的修改策略
3. **风险评估**：识别修改可能影响的其他模块
4. **备份检查**：确认重要代码的备份和回滚方案`,
                suffix: `
🏥 **代码外科手术协议**：
- **精准定位**：只修改必要的代码行，避免大范围改动
- **影响评估**：说明修改对其他模块的潜在影响
- **测试策略**：提供验证修改正确性的测试方法
- **回滚方案**：如修改出现问题，提供快速回滚步骤
- **文档更新**：同步更新相关注释和文档

⚠️ **严谨原则**：宁可多次小修改，也不要一次大改动！`
            },
            '不生效': {
                name: '❌ 不生效',
                description: '代码修改不生效的系统性诊断',
                category: 'code',
                prefix: `❌ **代码不生效诊断启动**：
请按照以下6个维度系统排查问题：`,
                suffix: `
🔧 **代码不生效的6个常见原因**：
1. **缓存问题**：浏览器缓存、模块缓存未清理
2. **路径错误**：文件路径、导入路径不正确
3. **语法错误**：代码存在语法错误阻止执行
4. **作用域问题**：变量作用域、函数调用上下文错误
5. **异步问题**：异步代码执行时序问题
6. **依赖缺失**：缺少必要的依赖或模块未正确加载

🎯 **诊断步骤**：
- 检查浏览器控制台是否有错误信息
- 验证文件是否被正确加载
- 确认代码是否在正确的执行上下文中
- 检查相关依赖是否正常工作
- 使用断点或console.log确认代码执行流程`
            },
            '日志-修改代码': {
                name: '📝 日志-修改代码',
                description: '结合工作日志记录的代码修改流程',
                category: 'log',
                prefix: `📝 **日志记录 + 代码修改模式**：
- 将修改过程和结果详细记录到工作日志
- 遵循代码外科手术协议进行精确修改
- 确保修改的可追溯性和可回滚性`,
                suffix: `
📋 **日志记录格式**：
\`\`\`markdown
## 代码修改记录 - [时间]
### 修改目标：[具体要解决的问题]
### 修改文件：[涉及的文件列表]
### 修改内容：[具体的修改点]
### 测试验证：[验证修改正确性的方法]
### 影响评估：[对其他模块的影响]
### 备注：[其他重要信息]
\`\`\`

💡 **最佳实践**：每次修改都要记录，便于后续问题追溯`
            },
            '日志-不生效': {
                name: '📋 日志-不生效',
                description: '结合工作日志的问题诊断和解决记录',
                category: 'log',
                prefix: `📋 **问题诊断 + 日志记录模式**：
- 系统性诊断代码不生效的原因
- 详细记录排查过程和解决方案
- 建立问题解决的知识库`,
                suffix: `
📝 **问题诊断日志格式**：
\`\`\`markdown
## 问题诊断记录 - [时间]
### 问题描述：[具体的不生效现象]
### 排查过程：
1. [检查项1] - [结果]
2. [检查项2] - [结果]
3. [检查项3] - [结果]
### 根因分析：[问题的根本原因]
### 解决方案：[具体的解决步骤]
### 验证结果：[修复后的验证情况]
### 预防措施：[避免类似问题的建议]
\`\`\`

🎯 **经验积累**：每次解决的问题都是宝贵的经验财富`
            },
            '日志-新功能': {
                name: '🚀 日志-新功能',
                description: '遵循最小化原则的新功能开发记录',
                category: 'log',
                prefix: `🚀 **新功能开发 + 日志记录模式**：
- 遵循最小化代码实现原则
- 详细记录开发过程和设计决策
- 确保功能的可维护性和可扩展性`,
                suffix: `
📋 **新功能开发日志格式**：
\`\`\`markdown
## 新功能开发记录 - [时间]
### 功能需求：[具体的功能描述]
### 设计方案：[技术实现方案]
### 最小化原则：[如何遵循最小化实现]
### 开发进度：
- [x] [完成的任务]
- [ ] [待完成的任务]
### 测试计划：[功能验证方法]
### 文档更新：[相关文档的更新]
\`\`\`

⚡ **最小化原则**：只实现必要功能，避免过度设计`
            },
            '新功能': {
                name: '✨ 新功能',
                description: '严格遵循最小化原则的新功能开发',
                category: 'feature',
                prefix: `✨ **最小化新功能开发模式**：
- 严格遵循最小化代码实现原则
- 只实现用户明确要求的功能，不添加额外特性
- 优先使用现有组件和模块，避免重复造轮子
- 确保新功能与现有架构的兼容性`,
                suffix: `
🎯 **最小化实现检查清单**：
- [ ] 功能需求是否明确且必要
- [ ] 是否复用了现有的组件和服务
- [ ] 是否避免了不必要的复杂性
- [ ] 是否考虑了与现有功能的集成
- [ ] 是否提供了基本的错误处理
- [ ] 是否包含了必要的用户反馈

⚠️ **严格约束**：不得任意增加指令以外的功能，保持实现的精简和专注`
            }
        };

        let currentEditingTemplate = null;

        // 模板操作函数
        function addNewTemplate() {
            currentEditingTemplate = null;
            document.getElementById('template-edit-title').textContent = '📝 新增模板';
            document.getElementById('template-name-input').value = '';
            document.getElementById('template-category-select').value = 'natural';
            document.getElementById('template-prefix-input').value = '';
            document.getElementById('template-suffix-input').value = '';
            document.getElementById('template-description-input').value = '';
            document.getElementById('template-edit-modal').style.display = 'block';
            console.log('🎯 打开新增模板编辑器');
        }

        // 旧的模板选择函数 - 已迁移到模板选择服务
        /*
        function toggleTemplateSelection(templateName) {
            // 已替换为 templateSelectionService.toggleSelection()
            // 保留此注释用于记录迁移
        }
        */

        function editTemplate(templateName) {
            const template = window.templateData[templateName];
            if (!template) {
                showMessage('模板不存在', 'error');
                return;
            }
            
            currentEditingTemplate = templateName;
            document.getElementById('template-edit-title').textContent = '📝 编辑模板';
            document.getElementById('template-name-input').value = template.name;
            document.getElementById('template-category-select').value = template.category;
            document.getElementById('template-prefix-input').value = template.prefix || '';
            document.getElementById('template-suffix-input').value = template.suffix || '';
            document.getElementById('template-description-input').value = template.description || '';
            document.getElementById('template-edit-modal').style.display = 'block';
            console.log('✏️ 打开编辑模板:', templateName);
        }

        function deleteTemplate(templateName) {
            const template = window.templateData[templateName];
            if (!template) {
                showMessage('模板不存在', 'error');
                return;
            }
            
            if (confirm(`确定要删除模板 "${template.name}" 吗？\n\n删除后将无法恢复！`)) {
                delete window.templateData[templateName];
                showMessage(`🗑️ 已删除模板: ${template.name}`, 2000);
                console.log('🗑️ 删除模板:', templateName);
                
                // 重新渲染模板列表
                setTimeout(() => {
                    initializeTemplateManagerContent();
                }, 100);
            }
        }

        function closeTemplateEditModal() {
            document.getElementById('template-edit-modal').style.display = 'none';
            currentEditingTemplate = null;
            console.log('❌ 关闭模板编辑器');
        }

        function saveTemplate() {
            const name = document.getElementById('template-name-input').value.trim();
            const category = document.getElementById('template-category-select').value;
            const prefix = document.getElementById('template-prefix-input').value.trim();
            const suffix = document.getElementById('template-suffix-input').value.trim();
            const description = document.getElementById('template-description-input').value.trim();
            
            if (!name) {
                showMessage('❌ 请输入模板名称', 'error');
                return;
            }
            
            // 如果是新增模板，生成唯一ID
            const templateId = currentEditingTemplate || `custom-${Date.now()}`;
            
            window.templateData[templateId] = {
                name: name,
                description: description,
                category: category,
                prefix: prefix,
                suffix: suffix
            };
            
            const isNew = !currentEditingTemplate;
            showMessage(isNew ? '✅ 模板已创建' : '✅ 模板已更新', 2000);
            console.log(isNew ? '✅ 创建模板:' : '✅ 更新模板:', templateId, templateData[templateId]);
            
            closeTemplateEditModal();
            
            // 重新渲染模板列表
            setTimeout(() => {
                initializeTemplateManagerContent();
            }, 100);
        }

        function importTemplates() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (typeof importedData === 'object' && importedData !== null) {
                                window.templateData = { ...window.templateData, ...importedData };
                                showMessage('📥 模板导入成功', 2000);
                                console.log('📥 导入模板数据:', importedData);
                                initializeTemplateManagerContent();
                } else {
                                throw new Error('Invalid JSON structure');
                            }
                        } catch (error) {
                            showMessage('❌ 导入失败：文件格式错误', 'error');
                            console.error('导入错误:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
            console.log('📥 开始导入模板');
        }

        function exportTemplates() {
            try {
                const dataStr = JSON.stringify(window.templateData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `templates_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showMessage('📤 模板已导出', 2000);
                console.log('📤 导出模板数据:', window.templateData);
            } catch (error) {
                showMessage('❌ 导出失败', 'error');
                console.error('导出错误:', error);
            }
        }

        // 旧的模板列表更新函数 - 已迁移到模板选择服务
        /*
        function updateSelectedTemplatesList() {
            // 已替换为 templateSelectionService.updateDisplay()
            // 保留此注释用于记录迁移
        }
        */

        // 同步模板管理器中的选中状态显示
        function syncTemplateManagerSelection() {
            // 清除所有模板卡片的选中状态
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 为已选中的模板添加选中状态
            selectedTemplates.forEach(template => {
                const templateCard = document.querySelector(`[data-template-id="${template.id}"]`);
                if (templateCard) {
                    templateCard.classList.add('selected');
                }
            });
        }

        // 使用选中的模板
        function useSelectedTemplate(templateId) {
            const template = selectedTemplates.find(t => t.id === templateId);
            if (!template) {
                showMessage('模板不存在', 'error');
                return;
            }
            
            // 构造注入文本 - 强制包含全局模块化约束
            let injectionText = '';
            
            // 1. 全局模块化前缀（强制）
            injectionText += GLOBAL_MODULAR_PREFIX;
            
            // 2. 模板特定前缀
            if (template.prefix) {
                injectionText += template.prefix;
            }
            
            // 3. 分隔符（如果有内容）
            if (template.suffix) {
                injectionText += '\n\n';
            }
            
            // 4. 模板特定后缀
            if (template.suffix) {
                injectionText += template.suffix;
            }
            
            // 5. 全局模块化后缀（强制）
            injectionText += GLOBAL_MODULAR_SUFFIX;
            
            // 复制到剪贴板
            if (navigator.clipboard && injectionText.trim()) {
                navigator.clipboard.writeText(injectionText).then(() => {
                    showMessage('📋 模板内容已复制到剪贴板（含强制模块化约束）', 2000);
                }).catch(() => {
                    console.log('模板内容:', injectionText);
                });
            } else if (injectionText.trim()) {
                console.log('模板内容:', injectionText);
                showMessage('模板内容已输出到控制台（含强制模块化约束）', 2000);
            }
            
            console.log('🎯 使用模板:', template.name, '✅ 已自动包含模块化约束');
        }

        // 移除选中的模板
        function removeSelectedTemplate(templateId) {
            const index = selectedTemplates.findIndex(t => t.id === templateId);
            if (index > -1) {
                const template = selectedTemplates[index];
                selectedTemplates.splice(index, 1);
                
                // 同步移除模板管理器中的选中状态
                const templateCard = document.querySelector(`[data-template-id="${templateId}"]`);
                if (templateCard) {
                    templateCard.classList.remove('selected');
                }
                
                showMessage(`🗑️ 已移除模板: ${template.name}`, 1500);
                updateSelectedTemplatesList();
                console.log('🗑️ 移除选中模板:', template.name);
            }
        }

        // 标签过滤功能
        let activeFilters = ['all']; // 当前激活的过滤器

        function toggleFilterTag(tagElement) {
            const category = tagElement.getAttribute('data-category');
            
            if (category === 'all') {
                // 点击"全部"标签
                if (!tagElement.classList.contains('active')) {
                    // 清除所有其他标签的激活状态
                    document.querySelectorAll('.filter-tag').forEach(tag => {
                        tag.classList.remove('active');
                        tag.style.background = '#f8f9fa';
                        tag.style.color = '#495057';
                        tag.style.borderColor = '#dee2e6';
                    });
                    
                    // 激活"全部"标签
                    tagElement.classList.add('active');
                    activeFilters = ['all'];
                    
                    // 显示所有模板
                    filterTemplates();
                    console.log('🏷️ 选择全部模板');
                    showMessage('🏷️ 显示全部模板', 1500);
                }
            } else {
                // 点击具体分类标签
                if (tagElement.classList.contains('active')) {
                    // 取消选择该标签
                    tagElement.classList.remove('active');
                    tagElement.style.background = '#f8f9fa';
                    tagElement.style.color = '#495057';
                    tagElement.style.borderColor = '#dee2e6';
                    
                    // 从激活过滤器中移除
                    activeFilters = activeFilters.filter(f => f !== category);
                    
                    // 如果没有任何标签激活，激活"全部"
                    if (activeFilters.length === 0 || activeFilters.includes('all')) {
                        const allTag = document.querySelector('.filter-tag[data-category="all"]');
                        allTag.classList.add('active');
                        activeFilters = ['all'];
                    }
                } else {
                    // 选择该标签
                    // 先取消"全部"标签
                    const allTag = document.querySelector('.filter-tag[data-category="all"]');
                    if (allTag.classList.contains('active')) {
                        allTag.classList.remove('active');
                        allTag.style.background = '#f8f9fa';
                        allTag.style.color = '#495057';
                        allTag.style.borderColor = '#dee2e6';
                        activeFilters = [];
                    }
                    
                    // 激活当前标签
                    tagElement.classList.add('active');
                    activeFilters.push(category);
                }
                
                filterTemplates();
                console.log('🏷️ 过滤标签:', activeFilters);
                showMessage(`🏷️ 已选择: ${getFilterDisplayNames()}`, 1500);
            }
        }

        function filterTemplates() {
            const allCards = document.querySelectorAll('.template-card');
            
            allCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                
                if (activeFilters.includes('all') || activeFilters.includes(cardCategory)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        function getFilterDisplayNames() {
            const nameMap = {
                'all': '全部',
                'natural': '自然模式',
                'code': '代码类',
                'log': '日志类',
                'feature': '新功能类'
            };
            
            return activeFilters.map(f => nameMap[f]).join(', ');
        }

        // 获取当前活跃的jsMind实例
        function getCurrentJsMind() {
            return mindmaps[currentMindmap];
        }

        // 切换思维导图标签页
        function switchMindmapTab(mapId) {
            console.log(`切换到思维导图: ${mapId}`);
            
            // 隐藏所有容器和标签内容
            ['workspace', 'knowledge', 'project'].forEach(id => {
                const container = document.getElementById(`jsmind_container_${id}`);
                const tabContent = document.getElementById(`mindmap-tab-${id}`);
                if (container) container.style.display = 'none';
                if (tabContent) {
                    tabContent.style.display = 'none';
                    tabContent.classList.remove('active');
                }
            });
            
            // 显示目标容器和标签内容
            const targetContainer = document.getElementById(`jsmind_container_${mapId}`);
            const targetTabContent = document.getElementById(`mindmap-tab-${mapId}`);
            if (targetContainer && targetTabContent) {
                targetContainer.style.display = 'block';
                targetTabContent.style.display = 'block';
                targetTabContent.classList.add('active');
                
                // 调整思维导图大小并重新布局
                const instance = mindmaps[mapId];
                if (instance) {
                    setTimeout(() => {
                        instance.resize();
                        // 对于标签管理，强制重新显示以修复布局问题
                        if (mapId === 'workspace') {
                            instance.show(mindmapData.workspace);
                        }
                    }, 100);
                }
            }
            
            // 更新标签UI
            document.querySelectorAll('.mindmap-tab-button').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`[data-tab="${mapId}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            currentMindmap = mapId;
            console.log(`✅ 已切换到思维导图: ${mapId}`);
        }

        // 自动保存数据
        function autoSaveData() {
            try {
                // 保存思维导图数据
                const mindmapDataToSave = {
                    workspace: mindmaps.workspace ? mindmaps.workspace.get_data() : mindmapData.workspace,
                    knowledge: mindmaps.knowledge ? mindmaps.knowledge.get_data() : mindmapData.knowledge,
                    project: mindmaps.project ? mindmaps.project.get_data() : mindmapData.project
                };
                
                localStorage.setItem(STORAGE_KEYS.MINDMAP_DATA, JSON.stringify(mindmapDataToSave));
                localStorage.setItem(STORAGE_KEYS.NODE_DATABASE, JSON.stringify(nodeDatabase));
                localStorage.setItem(STORAGE_KEYS.PROJECT_INFO, JSON.stringify(projectInfo));
                localStorage.setItem(STORAGE_KEYS.SELECTED_NODE, selectedNodeId || '');
                
                // *** 关键修复：同时保存会话数据 ***
                localStorage.setItem('nodemind_sessions', JSON.stringify(sessionDatabase));
                
                // 保存四组件数据
                saveFourComponentData();
                
                console.log('💾 自动保存完成');
                return true;
            } catch (error) {
                console.error('❌ 自动保存失败:', error);
                showMessage('❌ 自动保存失败: ' + error.message, 3000);
                return false;
            }
        }
        
        // 加载保存的数据
        function loadSavedData() {
            try {
                // 加载思维导图数据
                const savedMindmapData = localStorage.getItem(STORAGE_KEYS.MINDMAP_DATA);
                if (savedMindmapData) {
                    const parsedData = JSON.parse(savedMindmapData);
                    Object.assign(mindmapData, parsedData);
                    console.log('📂 思维导图数据已加载');
                }
                
                // 加载节点数据库
                const savedNodeDatabase = localStorage.getItem(STORAGE_KEYS.NODE_DATABASE);
                if (savedNodeDatabase) {
                    nodeDatabase = JSON.parse(savedNodeDatabase);
                    console.log('📂 节点数据库已加载');
                }
                
                // *** 关键修复：加载会话数据 ***
                const savedSessionData = localStorage.getItem('nodemind_sessions');
                if (savedSessionData) {
                    sessionDatabase = JSON.parse(savedSessionData);
                    console.log('📂 会话数据已加载');
                } else {
                    sessionDatabase = {};
                    console.log('📂 初始化空会话数据库');
                }
                
                // 加载项目信息
                const savedProjectInfo = localStorage.getItem(STORAGE_KEYS.PROJECT_INFO);
                if (savedProjectInfo) {
                    Object.assign(projectInfo, JSON.parse(savedProjectInfo));
                    console.log('📂 项目信息已加载');
                }
                
                // 加载选中节点
                const savedSelectedNode = localStorage.getItem(STORAGE_KEYS.SELECTED_NODE);
                if (savedSelectedNode) {
                    selectedNodeId = savedSelectedNode;
                }
                
                // 加载四组件数据
                loadFourComponentData();
                
                // 延迟执行任务管理更新，确保数据加载完成
                setTimeout(() => {
                    updateTaskManagement();
                }, 500);
                
                // 恢复四组件全局状态
                setTimeout(() => {
                    restoreFourComponentGlobalState();
                    console.log('✅ 四组件全局状态已恢复');
                }, 600);
                
                return true;
            } catch (error) {
                console.error('❌ 数据加载失败:', error);
                return false;
            }
        }
        
        // (重复的简单版showMessage已删除 - 保留支持消息类型的完整版)
        
        // 设置自动保存
        function setupAutoSave() {
            // 定时自动保存（每30秒）
            setInterval(autoSaveData, 30000);
            
            // 页面关闭前保存
            window.addEventListener('beforeunload', function(e) {
                autoSaveData();
            });
            
            // 页面失去焦点时保存
            window.addEventListener('blur', function() {
                autoSaveData();
            });
            
            console.log('🔄 自动保存系统已启动');
        }
        
        // 初始化标签管理功能（强制测试版本）
        function initializeTagManagement(nodeId) {
            console.log(`🏷️ [强制测试] 开始初始化标签管理: ${nodeId}`);
            
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData) {
                console.log(`❌ [强制测试] 节点数据不存在: ${nodeId}`);
                return;
            }
            
            // 确保标签数据结构存在
            if (!nodeData.tags) {
                nodeData.tags = { categories: [], technical: [], status: [] };
                console.log(`🔧 [强制测试] 创建标签数据结构: ${nodeId}`);
            }
            
            // 查找标签容器
            const tagContainer = document.getElementById(`tag-groups-container-${nodeId}`);
            console.log(`🔍 [强制测试] 查找标签容器: tag-groups-container-${nodeId}`, tagContainer);
            
            if (tagContainer) {
                console.log(`✅ [强制测试] 找到标签容器，开始生成HTML`);
                
                // 使用强制测试版本的标签生成函数
                const html = generateTagGroupsHTML();
                console.log(`🔧 [强制测试] 生成的HTML长度: ${html.length}`);
                console.log(`🔧 [强制测试] HTML内容预览:`, html.substring(0, 200));
                
                tagContainer.innerHTML = html;
                console.log(`✅ [强制测试] HTML已插入到容器中`);
                
                // 验证插入结果
                const insertedTags = tagContainer.querySelectorAll('.tag-item');
                console.log(`🔍 [强制测试] 插入后找到的标签数量: ${insertedTags.length}`);
                
                // 为所有标签添加点击事件
                insertedTags.forEach((tagItem, index) => {
                    console.log(`🔗 [强制测试] 绑定第${index + 1}个标签事件: ${tagItem.textContent}`);
                    tagItem.addEventListener('click', function() {
                        toggleTag(nodeId, this);
                    });
                });
                
                // 恢复已选中的标签状态
                restoreTagStates(nodeId);
                console.log(`✅ [强制测试] 标签管理初始化完成`);
            } else {
                console.log(`❌ [强制测试] 未找到标签容器: tag-groups-container-${nodeId}`);
                
                // 列出所有可能的标签容器
                const allContainers = document.querySelectorAll('[id*="tag-groups-container"]');
                console.log(`🔍 [强制测试] 页面中所有标签容器:`, Array.from(allContainers).map(c => c.id));
            }
        }
        
        // 切换标签选择状态
        function toggleTag(nodeId, tagElement) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData) return;
            
            const tagName = tagElement.dataset.tag;
            const tagGroup = tagElement.dataset.group;
            
            // 切换选中状态
            if (tagElement.classList.contains('selected')) {
                // 取消选中
                tagElement.classList.remove('selected');
                removeTagFromNode(nodeData, tagName, tagGroup);
                showMessage(`🏷️ 已移除标签：${tagName}`);
            } else {
                // 选中
                tagElement.classList.add('selected');
                addTagToNode(nodeData, tagName, tagGroup);
                showMessage(`🏷️ 已添加标签：${tagName}`);
            }
            
            // 更新修改时间
            nodeData.modified = new Date().toISOString();
            
            // 自动保存
            setTimeout(autoSaveData, 500);
            
            // 更新任务管理显示
            updateTaskManagement();
        }
        
        // 将标签添加到节点
        function addTagToNode(nodeData, tagName, tagGroup) {
            // 根据标签组分类存储
            let targetArray;
            switch(tagGroup) {
                case '常规':
                    targetArray = nodeData.tags.status;
                    break;
                case 'AI':
                    targetArray = nodeData.tags.technical;
                    break;
                case '笔记':
                    targetArray = nodeData.tags.categories;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            // 避免重复添加
            if (!targetArray.includes(tagName)) {
                targetArray.push(tagName);
            }
        }
        
        // 从节点移除标签
        function removeTagFromNode(nodeData, tagName, tagGroup) {
            // 根据标签组分类移除
            let targetArray;
            switch(tagGroup) {
                case '常规':
                    targetArray = nodeData.tags.status;
                    break;
                case 'AI':
                    targetArray = nodeData.tags.technical;
                    break;
                case '笔记':
                    targetArray = nodeData.tags.categories;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            const index = targetArray.indexOf(tagName);
            if (index > -1) {
                targetArray.splice(index, 1);
            }
        }
        
        // 恢复标签选中状态
        function restoreTagStates(nodeId) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData || !nodeData.tags) return;
            
            // 获取所有已选中的标签
            const allSelectedTags = [
                ...nodeData.tags.status,
                ...nodeData.tags.technical,
                ...nodeData.tags.categories
            ];
            
            // 恢复UI中的选中状态（限定在当前节点的标签容器内）
            const tagContainer = document.getElementById(`tag-groups-container-${nodeId}`);
            if (tagContainer) {
                const tagItems = tagContainer.querySelectorAll('.tag-item');
                tagItems.forEach(tagItem => {
                    const tagName = tagItem.dataset.tag;
                    if (allSelectedTags.includes(tagName)) {
                        tagItem.classList.add('selected');
                    }
                });
            }
        }
        
        // 测试详情面板功能
        function testDetailPanel() {
            console.log('🧪 开始测试详情面板功能...');
            const testNode = {
                id: 'test_node_' + Date.now(),
                topic: '测试节点 - ' + new Date().toLocaleTimeString()
            };
            handleNodeSelect(testNode, 'project');
        }
        
        // 测试标签同步功能
        function testTagSync() {
            console.log('🏷️ 开始测试标签同步功能...');
            
            // 1. 检查脑图数据
            console.log('📋 步骤1: 检查脑图数据');
            const workspaceMindmap = mindmaps['workspace'];
            if (!workspaceMindmap) {
                console.error('❌ 标签管理脑图未初始化');
                showMessage('❌ 标签管理脑图未初始化');
                return;
            }
            
            const workspaceData = workspaceMindmap.get_data();
            console.log('✅ 脑图数据:', workspaceData);
            console.log('🔍 脑图完整结构:', JSON.stringify(workspaceData, null, 2));
            
            // 2. 详细检查子节点
            console.log('📋 步骤2: 详细检查子节点');
            if (workspaceData && workspaceData.data && workspaceData.data.children) {
                console.log('🔍 子节点数量:', workspaceData.data.children.length);
                workspaceData.data.children.forEach((node, index) => {
                    console.log(`🔍 子节点 ${index + 1}:`, {
                        id: node.id,
                        topic: node.topic,
                        hasChildren: node.children ? node.children.length : 0,
                        children: node.children
                    });
                });
            }
            
            // 3. 测试数据解析
            console.log('📋 步骤3: 测试数据解析');
            const tagGroups = getTagsFromWorkspace();
            console.log('✅ 解析结果:', tagGroups);
            
            // 4. 测试HTML生成
            console.log('📋 步骤4: 测试HTML生成');
            const html = generateTagGroupsHTML();
            console.log('✅ HTML长度:', html.length);
            console.log('✅ HTML内容预览:', html.substring(0, 500) + '...');
            
            // 5. 检查当前标签容器
            console.log('📋 步骤5: 检查当前标签容器');
            const allTagContainers = document.querySelectorAll('[id*="tag-groups-container"]');
            console.log('🔍 找到标签容器数量:', allTagContainers.length);
            allTagContainers.forEach((container, index) => {
                console.log(`🔍 容器 ${index + 1}:`, {
                    id: container.id,
                    innerHTML: container.innerHTML.substring(0, 100) + '...'
                });
            });
            
            // 6. 强制刷新标签组件
            console.log('📋 步骤6: 强制刷新标签组件');
            syncTagsFromWorkspace();
            
            showMessage('🏷️ 标签同步测试完成，请查看控制台日志');
        }
        
        // 触发文件导入
        function triggerImportFile() {
            const fileInput = document.getElementById('import_file_input');
            if (fileInput) {
                fileInput.click();
                showMessage('📂 请选择要导入的脑图文件');
            }
        }
        
        // 处理文件导入
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('📂 开始导入文件:', file.name);
            showMessage('📂 正在导入文件: ' + file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let importedData = null;
                    
                    // 解析JSON文件
                    importedData = JSON.parse(content);
                    console.log('📋 检测到JSON格式文件');
                    
                    // 检查是否是完整导出格式（包含nodeDetails）
                    if (importedData.mindmap && importedData.nodeDetails) {
                        console.log('📋 检测到完整导出格式，包含节点详细信息');
                        
                        // 恢复节点详细信息数据库
                        Object.assign(nodeDatabase, importedData.nodeDetails);
                        
                        // 使用思维导图数据
                        importedData = importedData.mindmap;
                    }
                    
                    // 验证导入数据格式
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('无效的文件格式');
                    }
                    
                    // 检查必要的数据结构
                    if (!importedData.data || !importedData.data.id) {
                        throw new Error('文件缺少必要的思维导图数据结构');
                    }
                    
                    // 显示导入的思维导图到项目管理面板
                    const projectMindmap = mindmaps['project'];
                    if (projectMindmap) {
                        projectMindmap.show(importedData);
                        
                        // 初始化节点数据库
                        const rootNode = projectMindmap.get_node(importedData.data.id);
                        if (rootNode) {
                            traverseAndInitNodes(rootNode);
                        }
                        
                        // 自动保存导入的数据
                        setTimeout(autoSaveData, 500);
                        
                        showMessage('✅ 文件导入成功: ' + file.name);
                        console.log('✅ 文件导入完成:', file.name);
                    } else {
                        throw new Error('项目管理思维导图未初始化');
                    }
                    
                } catch (error) {
                    console.error('❌ 文件导入失败:', error);
                    showMessage('❌ 文件导入失败: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // 清空文件输入，允许重复选择同一文件
            event.target.value = '';
        }
        
        // 遍历并初始化节点数据库
        function traverseAndInitNodes(node) {
            if (!node) return;
            
            // 为节点创建数据库记录
            if (!nodeDatabase[node.id]) {
                nodeDatabase[node.id] = {
                    id: node.id,
                    title: node.topic,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                };
            }
            
            // 递归处理子节点
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    traverseAndInitNodes(child);
                });
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            console.log('🚀 NodeMind应用启动...');
            
            // 延迟初始化确保DOM准备完毕
            setTimeout(() => {
                // 加载保存的数据
                loadSavedData();
                
                // 初始化思维导图
                initMindmaps();
                
                // 设置自动保存
                setupAutoSave();
                
                // 初始化标签组件（从标签管理脑图加载）
                console.log('🏷️ 开始初始化标签组件...');
                setTimeout(() => {
                    initializeTagsFromMindmap();
                }, 500); // 给脑图更多时间完成初始化
                
                // 绑定思维导图标签页切换事件
                document.getElementById('tab_button_workspace')?.addEventListener('click', () => switchMindmapTab('workspace'));
                document.getElementById('tab_button_knowledge')?.addEventListener('click', () => switchMindmapTab('knowledge'));
                document.getElementById('tab_button_project')?.addEventListener('click', () => switchMindmapTab('project'));
                
                // 绑定详情面板标签页切换事件
    
                document.getElementById('detail_tab_injection')?.addEventListener('click', () => switchDetailTab('injection'));
                document.getElementById('detail_tab_project')?.addEventListener('click', () => switchDetailTab('project'));
                
                // 绑定工具栏按钮事件
                document.getElementById('show_guide_button')?.addEventListener('click', showUserGuide);
                document.getElementById('export_custom_file_button')?.addEventListener('click', saveProjectMindmap);
                document.getElementById('import_file_button')?.addEventListener('click', triggerImportFile);
                document.getElementById('sync_tags_button')?.addEventListener('click', syncTagsFromWorkspace);
                
                // 绑定文件输入事件
                document.getElementById('import_file_input')?.addEventListener('change', handleFileImport);
                
                console.log('✅ NodeMind应用启动完成！');
            }, 100);
        });

        // 绑定详情输入事件
        function bindDetailInputEvents(nodeId) {
            const titleInput = document.getElementById(`node-title-${nodeId}`);
            const contentInput = document.getElementById(`node-content-${nodeId}`);
            const authorInput = document.getElementById(`node-author-${nodeId}`);
            
            // 标题输入实时联动
            if (titleInput) {
                titleInput.addEventListener('input', function() {
                    updateNodeTitle(nodeId, this.value);
                    setTimeout(autoSaveData, 500);
                });
                titleInput.addEventListener('blur', function() {
                    autoSaveData();
                });
            }
            
            // 内容和作者输入事件
            [contentInput, authorInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        setTimeout(autoSaveData, 500);
                    });
                    input.addEventListener('blur', function() {
                        autoSaveData();
                    });
                }
            });
        }

        // 显示使用指南
        function showUserGuide() {
            var guideContent = `
                <h3>📖 NodeMind 操作指南</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <h4>🖱️ 鼠标操作</h4>
                        <ul>
                            <li>单击节点选中</li>
                            <li>双击节点编辑内容</li>
                            <li>拖拽画布移动视图</li>
                            <li>滚轮缩放思维导图</li>
                        </ul>
                    </div>
                    <div>
                        <h4>⌨️ 快捷键操作</h4>
                        <ul>
                            <li>Ctrl+Enter - 添加子节点</li>
                            <li>Enter - 添加兄弟节点</li>
                            <li>F2 - 编辑节点内容</li>
                            <li>Delete - 删除节点</li>
                            <li>Space - 展开/收起节点</li>
                            <li>方向键 - 选择相邻节点</li>
                        </ul>
                    </div>
                    <div>
                        <h4>🏷️ 标签管理</h4>
                        <ul>
                            <li>选中节点后在详情面板管理标签</li>
                            <li>支持常规、AI、笔记三类标签</li>
                            <li>点击标签选择/取消选择</li>
                            <li>标签自动同步到思维导图</li>
                        </ul>
                    </div>
                    <div>
                        <h4>💾 文件操作</h4>
                        <ul>
                            <li>💾 保存 - 保存当前脑图到本地</li>
                            <li>📂 导入文件 - 加载本地脑图文件</li>
                            <li>✨ 新脑图 - 创建新的思维导图</li>
                            <li>🔄 标签同步 - 从标签管理区读取标签</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // 创建模态对话框
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;justify-content:center;align-items:center;';
            
            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:white;border-radius:8px;padding:25px;max-width:80%;max-height:80%;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.3);';
            modalContent.innerHTML = guideContent;
            
            var closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.cssText = 'margin-top:20px;padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;';
            closeButton.onclick = function() {
                document.body.removeChild(modal);
            };
            
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            showMessage('📖 显示使用指南');
        }
        
        // 保存当前项目管理脑图到本地
        function saveProjectMindmap() {
            try {
                // 获取项目管理选项卡的思维导图数据
                const projectMindmap = mindmaps['project'];
                if (!projectMindmap) {
                    showMessage('❌ 项目管理脑图未初始化');
                    return;
                }
                
                const mind_data = projectMindmap.get_data();
                if (!mind_data) {
                    showMessage('❌ 无数据可保存');
                    return;
                }
                
                // 构建保存数据，包含思维导图和节点详细信息
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind",
                        export_type: "project_save",
                        tab: "project"
                    }
                };
                
                var dataStr = JSON.stringify(exportData, null, 2);
                var fileName = 'NodeMind-项目管理-' + new Date().toISOString().slice(0,10) + '.json';
                
                console.log('💾 准备保存项目管理脑图:', fileName);
                showMessage('💾 正在保存项目管理脑图...');
                
                // 检查浏览器支持的保存方式
                if (window.showSaveFilePicker) {
                    // 现代浏览器：使用文件系统访问API
                    saveWithFileSystemAPI(dataStr, fileName);
                } else {
                    // 传统浏览器：使用下载方式
                    saveWithDownload(dataStr, fileName);
                }
                
            } catch (error) {
                console.error('❌ 保存失败:', error);
                showMessage('❌ 保存失败: ' + error.message);
            }
        }
        
        // 使用现代文件系统API保存
        async function saveWithFileSystemAPI(content, fileName) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'NodeMind思维导图文件',
                            accept: {
                                'application/json': ['.json']
                            }
                        }
                    ]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                showMessage('✅ 文件已成功保存到指定位置');
                console.log('✅ 文件保存成功:', fileName);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('🚫 用户取消了文件保存');
                } else {
                    console.error('文件系统API保存失败，回退到下载方式:', error);
                    saveWithDownload(content, fileName);
                }
            }
        }
        
        // 使用传统下载方式保存
        function saveWithDownload(content, fileName) {
            try {
                const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const downloadLink = document.createElement('a');
                
                downloadLink.href = url;
                downloadLink.download = fileName;
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                setTimeout(function() {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showMessage('✅ 文件下载已开始: ' + fileName);
                console.log('✅ 文件下载成功:', fileName);
                
            } catch (error) {
                console.error('下载方式也失败:', error);
                showMessage('❌ 文件保存失败: ' + error.message);
            }
        }
        
        // 【已删除】generateTagGroupsHTMLFromWorkspace函数 - 存在兼容性问题，已改用generateTagGroupsHTML
        
        // 生成默认标签HTML（备用方案）
        function generateDefaultTagHTML() {
            return `
                <div class="tag-group">
                    <div class="tag-group-title">常规</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-yellow" data-tag="项目" data-group="常规">项目</div>
                        <div class="tag-item tag-yellow" data-tag="里程碑" data-group="常规">里程碑</div>
                        <div class="tag-item tag-yellow" data-tag="完成" data-group="常规">完成</div>
                        <div class="tag-item tag-yellow" data-tag="进行中" data-group="常规">进行中</div>
                        <div class="tag-item tag-yellow" data-tag="计划" data-group="常规">计划</div>
                    </div>
                </div>
                <div class="tag-group">
                    <div class="tag-group-title">AI</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-green" data-tag="记忆" data-group="AI">记忆</div>
                        <div class="tag-item tag-green" data-tag="注意力" data-group="AI">注意力</div>
                        <div class="tag-item tag-green" data-tag="经验" data-group="AI">经验</div>
                        <div class="tag-item tag-green" data-tag="幻觉" data-group="AI">幻觉</div>
                    </div>
                </div>
                <div class="tag-group">
                    <div class="tag-group-title">笔记</div>
                    <div class="tag-group-items">
                        <div class="tag-item tag-blue" data-tag="跟进" data-group="笔记">跟进</div>
                        <div class="tag-item tag-blue" data-tag="议题" data-group="笔记">议题</div>
                    </div>
                </div>`;
        }

        // 直接从标签管理脑图获取标签数据
        function getTagsFromWorkspace() {
            try {
                // 获取标签管理面板的思维导图
                const workspaceMindmap = mindmaps['workspace'];
                if (!workspaceMindmap) {
                    console.log('⚠️ 标签管理面板未初始化，使用默认数据');
                    return getDefaultTagGroups();
                }
                
                const workspaceData = workspaceMindmap.get_data();
                if (!workspaceData || !workspaceData.data) {
                    console.log('⚠️ 标签管理面板无数据，使用默认数据');
                    return getDefaultTagGroups();
                }
                
                // 解析标签结构
                const tagStructure = {
                    categories: [],  // 常规标签
                    technical: [],   // AI标签  
                    status: []       // 笔记标签
                };
                
                // 遍历标签管理脑图的子节点
                if (workspaceData.data.children) {
                    console.log('🔍 脑图子节点数量:', workspaceData.data.children.length);
                    workspaceData.data.children.forEach(node => {
                        const nodeName = node.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                        console.log(`🔍 处理节点: "${nodeName}", 有子节点: ${node.children ? node.children.length : 0}`);
                        
                        // 判断这是分组节点还是标签节点
                        if (node.children && node.children.length > 0) {
                            // 这是一个分组节点，处理其子标签
                            let targetArray = null;
                            
                            // 特殊处理：如果是"标签管理"根节点，需要按子节点名称分类
                            if (nodeName === '标签管理') {
                                console.log(`🎯 发现标签管理根节点，按子节点分类处理`);
                                
                                // 遍历标签管理的子节点，按名称分类
                                node.children.forEach(childGroup => {
                                    const childName = childGroup.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                    console.log(`🔍 处理标签管理子组: "${childName}", 有子节点: ${childGroup.children ? childGroup.children.length : 0}`);
                                    
                                    let childTargetArray = null;
                                    
                                    if (childName.includes('常规') || childName === '常规组' || childName === '常规' || 
                                        childName.includes('分类') || childName.includes('基础') || childName.includes('项目')) {
                                        childTargetArray = tagStructure.categories;
                                        console.log(`✅ ${childName} 映射到 categories (常规标签)`);
                                    } else if (childName.includes('AI') || childName === 'AI组' || childName === 'AI' ||
                                              childName.includes('技术') || childName.includes('智能')) {
                                        childTargetArray = tagStructure.technical;
                                        console.log(`✅ ${childName} 映射到 technical (AI标签)`);
                                    } else if (childName.includes('笔记') || childName === '笔记组' || childName === '笔记' ||
                                              childName.includes('状态') || childName.includes('记录')) {
                                        childTargetArray = tagStructure.status;
                                        console.log(`✅ ${childName} 映射到 status (笔记标签)`);
                                    }
                                    
                                    // 收集该子组下的标签
                                    if (childTargetArray && childGroup.children) {
                                        console.log(`🔍 开始收集 ${childName} 下的标签...`);
                                        childGroup.children.forEach(tagNode => {
                                            const tagName = tagNode.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                            console.log(`  📌 发现标签: "${tagName}"`);
                                            if (tagName && tagName.length > 0 && !childTargetArray.includes(tagName)) {
                                                childTargetArray.push(tagName);
                                                console.log(`  ✅ 添加标签: "${tagName}" 到 ${childName}`);
                                            }
                                        });
                                    }
                                });
                                return; // 跳过后续的常规处理逻辑
                            }
                            
                            // 常规的分组节点处理逻辑
                            if (nodeName.includes('常规') || nodeName === '常规组' || nodeName === '常规' || 
                                nodeName.includes('分类') || nodeName.includes('基础') || nodeName.includes('项目')) {
                                targetArray = tagStructure.categories;
                                console.log(`✅ ${nodeName} 映射到 categories (常规标签)`);
                            } else if (nodeName.includes('AI') || nodeName === 'AI组' || nodeName === 'AI' ||
                                      nodeName.includes('技术') || nodeName.includes('智能')) {
                                targetArray = tagStructure.technical;
                                console.log(`✅ ${nodeName} 映射到 technical (AI标签)`);
                            } else if (nodeName.includes('笔记') || nodeName === '笔记组' || nodeName === '笔记' ||
                                      nodeName.includes('状态') || nodeName.includes('记录')) {
                                targetArray = tagStructure.status;
                                console.log(`✅ ${nodeName} 映射到 status (笔记标签)`);
                            }
                            
                            // 收集该分组下的标签
                            if (targetArray) {
                                console.log(`🔍 开始收集 ${nodeName} 下的标签...`);
                                node.children.forEach(tagNode => {
                                    const tagName = tagNode.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                    console.log(`  📌 发现标签: "${tagName}"`);
                                    // 确保标签名称不为空且不重复
                                    if (tagName && tagName.length > 0 && !targetArray.includes(tagName)) {
                                        targetArray.push(tagName);
                                        console.log(`  ✅ 添加标签: "${tagName}" 到 ${nodeName}`);
                                    } else if (!tagName || tagName.length === 0) {
                                        console.log(`  ⚠️ 跳过空标签节点`);
                                    } else {
                                        console.log(`  ⚠️ 跳过重复标签: "${tagName}"`);
                                    }
                                });
                                console.log(`🔍 ${nodeName} 最终标签:`, targetArray);
                            }
                        } else {
                            // 这是一个独立的标签节点，暂时跳过（只处理分组下的二级节点）
                            console.log(`⚠️ 跳过独立节点: "${nodeName}" (只处理分组下的二级节点)`);
                        }
                    });
                }
                
                console.log('🎯 最终标签结构:', tagStructure);
                console.log('📊 标签统计:');
                console.log('  - 常规标签:', tagStructure.categories.length, '个');
                console.log('  - AI标签:', tagStructure.technical.length, '个');
                console.log('  - 笔记标签:', tagStructure.status.length, '个');
                
                // 如果所有标签组都为空，返回默认数据
                const totalTags = tagStructure.categories.length + tagStructure.technical.length + tagStructure.status.length;
                if (totalTags === 0) {
                    console.log('⚠️ 脑图中未找到任何标签，使用默认数据');
                    return getDefaultTagGroups();
                }
                
                return tagStructure;
                
            } catch (error) {
                console.error('❌ 从脑图读取标签失败:', error);
                return getDefaultTagGroups();
            }
        }
        
        // 获取默认标签分组
        function getDefaultTagGroups() {
            return {
                categories: ['项目', '里程碑', '完成', '进行中', '计划'],
                technical: ['记忆', '注意力', '经验', '幻觉'],
                status: ['跟进', '议题']
            };
        }
        
        // 生成标签组HTML（从脑图同步数据）
        function generateTagGroupsHTML() {
            console.log('🎯 开始生成标签组HTML（从脑图同步）...');
            
            // 从标签管理脑图获取最新数据
            const finalTagGroups = getTagsFromWorkspace();
            
            console.log('🔧 使用脑图同步的标签数据:', finalTagGroups);
            
            try {
                
                let html = '';
                
                // 生成常规标签组
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">常规</div>
                        <div class="tag-group-items">`;
                
                // 使用最终合并的标签数据
                console.log('🔍 常规标签数据检查:', finalTagGroups.categories);
                finalTagGroups.categories.forEach(tag => {
                    html += `<div class="tag-item tag-yellow" data-tag="${tag}" data-group="常规">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // 生成AI标签组
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">AI</div>
                        <div class="tag-group-items">`;
                
                console.log('🔍 AI标签数据检查:', finalTagGroups.technical);
                finalTagGroups.technical.forEach(tag => {
                    html += `<div class="tag-item tag-green" data-tag="${tag}" data-group="AI">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // 生成笔记标签组
                html += `
                    <div class="tag-group">
                        <div class="tag-group-title">笔记</div>
                        <div class="tag-group-items">`;
                
                console.log('🔍 笔记标签数据检查:', finalTagGroups.status);
                finalTagGroups.status.forEach(tag => {
                    html += `<div class="tag-item tag-blue" data-tag="${tag}" data-group="笔记">${tag}</div>`;
                });
                
                html += `
                        </div>
                    </div>`;
                
                // 如果没有生成任何标签组HTML，显示空状态提示
                if (!html.trim()) {
                    html = `
                        <div class="empty-tags-message">
                            <div class="empty-icon">🏷️</div>
                            <div class="empty-text">暂无标签组</div>
                            <div class="empty-hint">请在标签管理脑图中添加标签组和标签</div>
                        </div>`;
                    console.log('⚠️ 没有可用标签组，显示空状态提示');
                }
                
                return html;
                
            } catch (error) {
                console.error('❌ 生成标签HTML失败:', error);
                
                // 降级使用默认数据
                const defaultGroups = getDefaultTagGroups();
                let fallbackHtml = '';
                
                // 生成默认常规标签组
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">常规</div>
                        <div class="tag-group-items">`;
                defaultGroups.categories.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-yellow" data-tag="${tag}" data-group="常规">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                // 生成默认AI标签组
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">AI</div>
                        <div class="tag-group-items">`;
                defaultGroups.technical.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-green" data-tag="${tag}" data-group="AI">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                // 生成默认笔记标签组
                fallbackHtml += `
                    <div class="tag-group">
                        <div class="tag-group-title">笔记</div>
                        <div class="tag-group-items">`;
                defaultGroups.status.forEach(tag => {
                    fallbackHtml += `<div class="tag-item tag-blue" data-tag="${tag}" data-group="笔记">${tag}</div>`;
                });
                fallbackHtml += `</div></div>`;
                
                console.log('✅ 使用默认数据生成标签HTML');
                return fallbackHtml;
            }
        }
        
        // 添加标签加载状态的CSS样式
        function addTagLoadingStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .loading-tags-state, .error-tags-state {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 30px 20px;
                    text-align: center;
                    min-height: 120px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 2px dashed #dee2e6;
                }
                
                .loading-icon, .error-icon {
                    font-size: 24px;
                    margin-bottom: 10px;
                }
                
                .loading-icon {
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .loading-text, .error-text {
                    font-size: 14px;
                    color: #6c757d;
                    margin-bottom: 5px;
                    font-weight: 500;
                }
                
                .error-text {
                    color: #dc3545;
                }
                
                .error-detail {
                    font-size: 12px;
                    color: #6c757d;
                    margin-bottom: 15px;
                }
                
                .retry-btn {
                    padding: 6px 12px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: background-color 0.2s;
                }
                
                .retry-btn:hover {
                    background: #0056b3;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 初始化时从标签管理脑图加载标签组件
        function initializeTagsFromMindmap() {
            console.log('🏷️ 开始从标签管理脑图初始化标签组件...');
            
            try {
                // 添加必要的CSS样式
                addTagLoadingStyles();
                // 等待脑图初始化完成
                const checkMindmapReady = () => {
                    const workspaceMindmap = mindmaps['workspace'];
                    if (!workspaceMindmap) {
                        console.log('⏳ 等待标签管理脑图初始化...');
                        setTimeout(checkMindmapReady, 100);
                        return;
                    }
                    
                    // 脑图已就绪，开始加载标签
                    console.log('✅ 标签管理脑图已就绪，开始加载标签数据');
                    loadTagsFromMindmap();
                };
                
                // 开始检查脑图是否就绪
                checkMindmapReady();
                
            } catch (error) {
                console.error('❌ 初始化标签组件失败:', error);
                showLoadingError();
            }
        }
        
        // 从脑图加载标签数据并更新UI
        function loadTagsFromMindmap() {
            try {
                console.log('📋 从标签管理脑图获取标签数据...');
                
                // 获取标签数据
                const tagGroups = getTagsFromWorkspace();
                console.log('📊 获取到标签数据:', tagGroups);
                
                // 生成标签组件HTML
                const tagsHTML = generateTagGroupsHTML();
                console.log('🏗️ 生成标签HTML, 长度:', tagsHTML.length);
                
                // 更新标签容器
                const tagContainer = document.getElementById('tag-groups');
                if (tagContainer) {
                    tagContainer.innerHTML = tagsHTML;
                    console.log('✅ 标签组件初始化完成');
                    
                    // 统计标签数量
                    const groups = tagContainer.querySelectorAll('.tag-group');
                    let totalTags = 0;
                    groups.forEach(group => {
                        const items = group.querySelectorAll('.tag-item, .tag');
                        totalTags += items.length;
                    });
                    
                    console.log(`📊 标签加载统计: ${groups.length}个组, 共${totalTags}个标签`);
                    showMessage(`✅ 标签组件初始化完成 (${groups.length}组, ${totalTags}个标签)`);
                } else {
                    throw new Error('标签容器不存在');
                }
                
            } catch (error) {
                console.error('❌ 从脑图加载标签失败:', error);
                showLoadingError(error.message);
            }
        }
        
        // 显示加载错误状态
        function showLoadingError(errorMessage = '未知错误') {
            const tagContainer = document.getElementById('tag-groups');
            if (tagContainer) {
                tagContainer.innerHTML = `
                    <div class="error-tags-state">
                        <div class="error-icon">❌</div>
                        <div class="error-text">标签加载失败</div>
                        <div class="error-detail">${errorMessage}</div>
                        <button class="retry-btn" onclick="initializeTagsFromMindmap()">🔄 重试</button>
                    </div>
                `;
            }
        }
        
        // 处理分析按钮点击事件
        function handleAnalyzeTagData() {
            try {
                console.log('🔍 用户点击了分析标签数据按钮');
                
                // 检查函数是否存在
                if (typeof analyzeTagComponentDataSource !== 'function') {
                    console.error('❌ analyzeTagComponentDataSource函数不存在');
                    showMessage('❌ 分析功能不可用', 'error');
                    return;
                }
                
                // 执行分析
                analyzeTagComponentDataSource();
                showMessage('✅ 分析完成，请查看控制台输出', 'success');
                
            } catch (error) {
                console.error('❌ 分析按钮处理失败:', error);
                showMessage('❌ 分析失败: ' + error.message, 'error');
            }
        }
        
        // 标签数据来源分析工具（修复版）
        function analyzeTagComponentDataSource() {
            console.log('🔍 标签数据来源分析工具');
            console.log('==========================================');
            
            try {
                // 安全检查：确保所有依赖都存在
                console.log('\n🔧 安全检查：验证系统状态');
                console.log('--------------------------------------------');
                
                // 检查mindmaps全局变量
                if (typeof mindmaps === 'undefined') {
                    console.error('❌ mindmaps全局变量未定义');
                    return;
                }
                
                // 检查关键函数
                const requiredFunctions = ['getTagsFromWorkspace', 'getDefaultTagGroups'];
                for (const funcName of requiredFunctions) {
                    if (typeof window[funcName] !== 'function') {
                        console.error(`❌ 函数 ${funcName} 不存在`);
                        return;
                    }
                }
                
                console.log('✅ 系统状态检查通过');
                
                // 第一步：检查页面显示的标签
                console.log('\n📱 第一步：检查页面标签显示');
                console.log('--------------------------------------------');
                
                const tagContainer = document.getElementById('tag-groups');
                const pageTagData = {};
                
                if (tagContainer) {
                    console.log('✅ 找到标签容器');
                    
                    const groups = tagContainer.querySelectorAll('.tag-group');
                    console.log(`📊 标签组数量: ${groups.length}`);
                    
                    groups.forEach((group, index) => {
                        const titleElement = group.querySelector('.tag-group-title');
                        const items = group.querySelectorAll('.tag-item, .tag');
                        
                        if (titleElement) {
                            const title = titleElement.textContent.trim();
                            const tags = Array.from(items).map(item => item.textContent.trim());
                            
                            console.log(`  标签组 ${index + 1}: "${title}" (${tags.length}个标签)`);
                            console.log(`    标签: [${tags.join(', ')}]`);
                            
                            // 存储页面数据
                            if (title === '常规') pageTagData.categories = tags;
                            else if (title === 'AI') pageTagData.technical = tags;
                            else if (title === '笔记') pageTagData.status = tags;
                        }
                    });
                } else {
                    console.log('❌ 未找到标签容器 #tag-groups');
                }
                
                // 第二步：检查脑图数据
                console.log('\n🧠 第二步：检查脑图数据');
                console.log('--------------------------------------------');
                
                const workspace = mindmaps['workspace'];
                let brainMapData = null;
                
                if (workspace) {
                    console.log('✅ workspace脑图存在');
                    try {
                        const data = workspace.get_data();
                        if (data && data.data) {
                            brainMapData = data.data;
                            console.log(`📊 根节点: "${brainMapData.topic}"`);
                            console.log(`📊 子节点数量: ${brainMapData.children ? brainMapData.children.length : 0}`);
                            
                            if (brainMapData.children) {
                                brainMapData.children.forEach((node, index) => {
                                    const name = node.topic.replace(/[📝🔧⭐🏷️📋💡🤖]/g, '').trim();
                                    const childCount = node.children ? node.children.length : 0;
                                    console.log(`  ${index + 1}. "${name}" (${childCount}个子节点)`);
                                });
                            }
                        } else {
                            console.log('⚠️ 脑图数据为空');
                        }
                    } catch (dataError) {
                        console.error('❌ 获取脑图数据失败:', dataError);
                    }
                } else {
                    console.log('❌ workspace脑图不存在');
                }
                
                // 第三步：测试函数执行
                console.log('\n⚙️ 第三步：测试核心函数');
                console.log('--------------------------------------------');
                
                let functionResult = null;
                let defaultResult = null;
                
                try {
                    console.log('🔄 执行getTagsFromWorkspace()...');
                    functionResult = getTagsFromWorkspace();
                    console.log('📊 函数返回:', functionResult);
                } catch (funcError) {
                    console.error('❌ getTagsFromWorkspace执行失败:', funcError);
                }
                
                try {
                    console.log('🔄 执行getDefaultTagGroups()...');
                    defaultResult = getDefaultTagGroups();
                    console.log('📊 默认数据:', defaultResult);
                } catch (defaultError) {
                    console.error('❌ getDefaultTagGroups执行失败:', defaultError);
                }
                
                // 第四步：数据对比
                console.log('\n🔍 第四步：数据对比分析');
                console.log('--------------------------------------------');
                
                const groupNames = { categories: '常规', technical: 'AI', status: '笔记' };
                
                Object.keys(groupNames).forEach(key => {
                    const displayName = groupNames[key];
                    const pageData = pageTagData[key] || [];
                    const funcData = functionResult ? (functionResult[key] || []) : [];
                    const defData = defaultResult ? (defaultResult[key] || []) : [];
                    
                    console.log(`\n${displayName}组 (${key}):`);
                    console.log(`  页面显示: [${pageData.join(', ')}]`);
                    console.log(`  函数返回: [${funcData.join(', ')}]`);
                    console.log(`  默认数据: [${defData.join(', ')}]`);
                    
                    // 比较一致性
                    const pageVsFunc = JSON.stringify(pageData.sort()) === JSON.stringify(funcData.sort());
                    const funcVsDefault = JSON.stringify(funcData.sort()) === JSON.stringify(defData.sort());
                    
                    console.log(`  页面vs函数: ${pageVsFunc ? '✅ 一致' : '❌ 不一致'}`);
                    console.log(`  函数vs默认: ${funcVsDefault ? '⚠️ 使用默认' : '✅ 使用脑图'}`);
                });
                
                // 第五步：问题诊断
                console.log('\n🎯 第五步：问题诊断');
                console.log('--------------------------------------------');
                
                if (!workspace) {
                    console.log('❌ 根本问题：workspace脑图未初始化');
                    console.log('💡 建议：检查脑图加载过程');
                } else if (!brainMapData) {
                    console.log('❌ 根本问题：脑图数据为空');
                    console.log('💡 建议：检查脑图数据结构');
                } else if (!functionResult) {
                    console.log('❌ 根本问题：getTagsFromWorkspace函数失败');
                    console.log('💡 建议：检查函数逻辑和错误处理');
                } else {
                    console.log('✅ 数据获取正常');
                    console.log('💡 如果页面显示不正确，检查DOM更新过程');
                }
                
                console.log('\n✅ 分析完成');
                
            } catch (error) {
                console.error('❌ 分析工具出错:', error);
                console.error('错误堆栈:', error.stack);
            }
        }

        
        // 单向同步：从标签脑图同步数据到标签组件（标签脑图作为唯一数据源）
        // 注意：标签组和标签只支持在标签脑图中手动修改，不支持程序自动修改
        function syncTagsFromWorkspace() {
            try {
                showMessage('🔄 正在从标签脑图同步标签数据...');
                console.log('🔄 开始单向标签同步（标签脑图 → 标签组件）');
                
                // 执行数据来源分析（如果函数存在）
                if (typeof analyzeTagComponentDataSource === 'function') {
                    try {
                        analyzeTagComponentDataSource();
                    } catch (analysisError) {
                        console.error('⚠️ 分析功能执行失败:', analysisError);
                    }
                }
                
                // 1. 从标签脑图读取最新数据
                const tagGroups = getTagsFromWorkspace();
                console.log('📋 读取到的标签组数据:', tagGroups);
                
                // 2. 更新四组件中的标签组件（主要目标）
                const fourComponentTagsContainer = document.getElementById('tag-groups');
                if (fourComponentTagsContainer) {
                    console.log('🎯 找到四组件标签容器，开始更新...');
                    
                    // 生成新的标签组HTML
                    let newTagsHTML = '';
                    
                    // 定义标签组映射
                    const groupMappings = {
                        'categories': '常规',
                        'technical': 'AI', 
                        'status': '笔记'
                    };
                    
                    Object.keys(tagGroups).forEach(groupKey => {
                        const tags = tagGroups[groupKey];
                        if (!tags || tags.length === 0) return;
                        
                        const groupDisplayName = groupMappings[groupKey] || groupKey;
                        
                        newTagsHTML += `
                            <div class="tag-group">
                                <div class="tag-group-title">${groupDisplayName}</div>
                                <div class="tag-list" id="${groupKey.toLowerCase()}-tags">`;
                        
                        tags.forEach(tag => {
                            newTagsHTML += `<span class="tag" data-tag="${tag}" data-group="${groupDisplayName}" onclick="fourComponentToggleTag(this)">${tag}</span>`;
                        });
                        
                        newTagsHTML += `
                                </div>
                            </div>`;
                    });
                    
                    // 更新标签容器内容
                    fourComponentTagsContainer.innerHTML = newTagsHTML;
                    console.log('✅ 四组件标签组件已更新');
                } else {
                    console.log('⚠️ 未找到四组件标签容器');
                }
                
                // 3. 更新节点详情面板中的标签组件（如果存在）
                const allTagContainers = document.querySelectorAll('[id*="tag-groups-container"]');
                console.log('🔍 找到详情面板标签容器数量:', allTagContainers.length);
                
                if (allTagContainers.length > 0) {
                    allTagContainers.forEach((tagContainer, index) => {
                        console.log(`🔄 刷新标签容器 ${index + 1}:`, tagContainer.id);
                        
                        // 使用能正常工作的标签生成函数
                        tagContainer.innerHTML = generateTagGroupsHTML();
                        
                        // 重新绑定事件
                        const tagItems = tagContainer.querySelectorAll('.tag-item');
                        tagItems.forEach(tagItem => {
                            tagItem.addEventListener('click', function() {
                                const nodeId = tagContainer.id.replace('tag-groups-container-', '');
                                toggleTag(nodeId, this);
                            });
                        });
                        
                        // 恢复选中状态
                        if (selectedNodeId) {
                            restoreTagStates(selectedNodeId);
                        }
                    });
                    
                    showMessage('✅ 标签同步完成！');
                    console.log('✅ 已刷新所有详情面板标签组件');
                } else {
                    console.log('⚠️ 未找到标签容器，可能当前没有打开详细描述面板');
                    // 如果当前有选中节点，强制刷新详情面板
                    if (selectedNodeId) {
                        console.log('🔄 强制刷新当前选中节点的详情面板...');
                        const currentMindmapInstance = mindmaps[currentMindmap];
                        if (currentMindmapInstance) {
                            const currentNode = currentMindmapInstance.get_node(selectedNodeId);
                            if (currentNode) {
                                showNodeDetails(currentNode, currentMindmap);
                                showMessage('✅ 详情面板刷新完成！');
                                console.log('✅ 已强制刷新详情面板');
                            }
                        }
                    } else {
                        showMessage('ℹ️ 请先选择一个节点查看标签效果');
                    }
                }
                
                showMessage('✅ 标签同步完成！标签脑图数据已同步到标签组件');
                console.log('✅ 单向标签同步操作完成（标签脑图 → 标签组件）');
                
            } catch (error) {
                console.error('❌ 标签同步失败:', error);
                showMessage('❌ 标签同步失败: ' + error.message);
            }
        }

        // 任务管理功能
        function updateTaskManagement() {
            console.log('🎯 更新任务管理显示...');
            
            // 获取当前思维导图实例
            const currentMindmapInstance = getCurrentJsMind();
            if (!currentMindmapInstance) return;
            
            // 获取所有节点数据
            const mindmapData = currentMindmapInstance.get_data();
            if (!mindmapData || !mindmapData.data) return;
            
            // 递归处理所有节点
            processNodeForTaskManagement(mindmapData.data, currentMindmapInstance);
        }
        
        // 处理单个节点的任务管理
        function processNodeForTaskManagement(nodeData, mindmapInstance) {
            if (!nodeData || !nodeData.id) return;
            
            const nodeId = nodeData.id;
            const nodeInfo = nodeDatabase[nodeId];
            
            if (nodeInfo && nodeInfo.tags) {
                // 检查是否有"完成"标签
                const isCompleted = nodeInfo.tags.status.includes('完成');
                
                // 检查是否有"项目"标签
                const isProject = nodeInfo.tags.status.includes('项目');
                
                // 处理完成节点的虚化
                if (isCompleted) {
                    applyCompletedNodeStyle(nodeId, mindmapInstance);
                } else {
                    // 如果没有完成标签，恢复原始样式
                    restoreNodeStyle(nodeId, mindmapInstance);
                }
                
                // 处理项目节点的进度显示
                if (isProject && nodeData.children && nodeData.children.length > 0) {
                    updateProjectProgress(nodeId, nodeData.children, mindmapInstance);
                } else if (!isProject) {
                    // 如果没有项目标签，清除可能存在的进度显示
                    clearProjectProgress(nodeId, mindmapInstance);
                }
            }
            
            // 递归处理子节点
            if (nodeData.children) {
                nodeData.children.forEach(child => {
                    processNodeForTaskManagement(child, mindmapInstance);
                });
            }
        }
        
        // 应用完成节点的虚化样式
        function applyCompletedNodeStyle(nodeId, mindmapInstance) {
            try {
                // 设置节点为灰色并降低透明度
                mindmapInstance.set_node_color(nodeId, '#f0f0f0', '#999999');
                
                // 通过DOM操作设置透明度
                setTimeout(() => {
                    const nodeElement = document.querySelector(`[nodeid="${nodeId}"]`);
                    if (nodeElement) {
                        nodeElement.style.opacity = '0.5';
                        nodeElement.style.filter = 'grayscale(50%)';
                    }
                }, 100);
                
                console.log(`✅ 已虚化完成节点: ${nodeId}`);
            } catch (error) {
                console.error(`❌ 虚化节点失败: ${nodeId}`, error);
            }
        }
        
        // 更新项目进度显示
        function updateProjectProgress(projectNodeId, children, mindmapInstance) {
            try {
                let totalChildren = 0;
                let completedChildren = 0;
                
                // 统计子节点完成情况
                children.forEach(child => {
                    totalChildren++;
                    const childInfo = nodeDatabase[child.id];
                    if (childInfo && childInfo.tags && childInfo.tags.status.includes('完成')) {
                        completedChildren++;
                    }
                });
                
                // 获取项目节点的原始标题（去除之前的进度信息）
                const projectInfo = nodeDatabase[projectNodeId];
                let originalTitle = projectInfo ? projectInfo.title : '项目';
                
                // 清理标题中可能存在的旧进度信息
                originalTitle = originalTitle.replace(/ \d+\/\d+$/, '');
                
                // 生成进度显示文本（完成数/总数）
                const progressText = ` ${completedChildren}/${totalChildren}`;
                const newTitle = `${originalTitle}${progressText}`;
                
                // 更新节点显示
                mindmapInstance.update_node(projectNodeId, newTitle);
                
                // 检查项目是否全部完成，自动添加完成标签
                if (totalChildren > 0 && completedChildren === totalChildren) {
                    const projectInfo = nodeDatabase[projectNodeId];
                    if (projectInfo && !projectInfo.tags.status.includes('完成')) {
                        projectInfo.tags.status.push('完成');
                        projectInfo.modified = new Date().toISOString();
                        console.log(`🎉 项目全部完成，自动添加完成标签: ${originalTitle}`);
                        
                        // 触发任务管理更新以应用虚化效果
                        setTimeout(() => {
                            updateTaskManagement();
                        }, 100);
                    }
                }
                
                console.log(`📊 项目进度已更新: ${originalTitle} -> ${progressText}`);
            } catch (error) {
                console.error(`❌ 更新项目进度失败: ${projectNodeId}`, error);
            }
        }
        
        // 恢复节点原始样式（当移除完成标签时）
        function restoreNodeStyle(nodeId, mindmapInstance) {
            try {
                // 恢复默认颜色
                mindmapInstance.set_node_color(nodeId, null, null);
                
                // 恢复DOM样式
                setTimeout(() => {
                    const nodeElement = document.querySelector(`[nodeid="${nodeId}"]`);
                    if (nodeElement) {
                        nodeElement.style.opacity = '';
                        nodeElement.style.filter = '';
                    }
                }, 100);
                
                console.log(`✅ 已恢复节点样式: ${nodeId}`);
            } catch (error) {
                console.error(`❌ 恢复节点样式失败: ${nodeId}`, error);
            }
        }
        
        // 清除项目进度显示（当移除项目标签时）
        function clearProjectProgress(nodeId, mindmapInstance) {
            try {
                const projectInfo = nodeDatabase[nodeId];
                if (projectInfo) {
                    // 清理标题中的进度信息，恢复原始标题
                    const originalTitle = projectInfo.title.replace(/ \d+\/\d+$/, '');
                    
                    // 更新节点显示为原始标题
                    mindmapInstance.update_node(nodeId, originalTitle);
                    
                    // 同时更新nodeDatabase中的标题
                    projectInfo.title = originalTitle;
                    
                    console.log(`✅ 已清除项目进度显示: ${nodeId}`);
                }
            } catch (error) {
                console.error(`❌ 清除项目进度失败: ${nodeId}`, error);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 NodeMind系统启动');
            
            // 初始化项目信息（独立模块，不影响其他功能）
            initProjectInfo();
            
            // 初始化模板管理和选择服务
            setTimeout(() => {
                // 初始化模板服务
                if (typeof TemplateService !== 'undefined') {
                    TemplateService.initialize();
                    console.log('✅ 模板管理服务已初始化');
                    
                    // 获取模板数据
                    window.templateData = TemplateService.getTemplateData();
                    console.log('📋 模板数据已加载:', Object.keys(window.templateData).length, '个');
                } else {
                    console.warn('⚠️ TemplateService 未加载');
                }
                
                // 初始化模板选择服务
                if (typeof TemplateSelectionService !== 'undefined') {
                    if (window.templateData) {
                        window.templateSelectionService = new TemplateSelectionService();
                        window.templateSelectionService.init();
                        console.log('✅ 模板选择服务已初始化');
                        console.log('📋 可用模板:', Object.keys(window.templateData).length, '个');
                    } else {
                        console.warn('⚠️ templateData 尚未加载，再次尝试...');
                        // 再次尝试
                        setTimeout(() => {
                            if (window.templateData) {
                                window.templateSelectionService = new TemplateSelectionService();
                                window.templateSelectionService.init();
                                console.log('✅ 模板选择服务延迟初始化成功');
                            } else {
                                console.error('❌ templateData 加载失败');
                            }
                        }, 500);
                    }
                } else {
                    console.warn('⚠️ TemplateSelectionService 未加载');
                }
            }, 100);
            
            // 延迟执行任务管理更新，确保所有数据加载完成
            setTimeout(() => {
                updateTaskManagement();
            }, 1000);
            
            console.log('✅ NodeMind系统初始化完成');
        });

        // 添加键盘快捷键支持（借鉴node_mind_injection_page.html）
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter 触发提交功能
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                
                // 获取当前选中的节点
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const selectedNode = currentMindmapInstance.get_selected_node();
                    if (selectedNode) {
                        // 检查是否有内容可提交
                        const contentEditor = document.getElementById(`node-content-${selectedNode.id}`);
                        if (contentEditor && contentEditor.value.trim()) {
                            console.log('⌨️ 触发快捷键提交:', selectedNode.id);
                            submitContent(selectedNode.id);
                            showMessage('⌨️ Ctrl+Enter 快捷键提交已触发', 2000, 'info');
                        } else {
                            showMessage('⚠️ 请先选择有内容的节点进行提交', 2000, 'warning');
                        }
                    } else {
                        showMessage('⚠️ 请先选择一个节点', 2000, 'warning');
                    }
                } else {
                    showMessage('❌ 思维导图未初始化', 2000, 'error');
                }
            }
            
            // Ctrl + Shift + Enter 触发传统复制方式（借鉴node_mind_injection_page.html）
            else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                
                const currentMindmapInstance = getCurrentJsMind();
                if (currentMindmapInstance) {
                    const selectedNode = currentMindmapInstance.get_selected_node();
                    if (selectedNode) {
                        const contentEditor = document.getElementById(`node-content-${selectedNode.id}`);
                        if (contentEditor && contentEditor.value.trim()) {
                            // 执行传统复制（不包含direct_inject标记）
                            traditionalCopyContent(selectedNode.id);
                            showMessage('⌨️ Ctrl+Shift+Enter 传统复制已触发', 2000, 'info');
                        } else {
                            showMessage('⚠️ 请先选择有内容的节点进行复制', 2000, 'warning');
                        }
                    }
                }
            }
            
            // Ctrl + I 显示注入功能帮助
            else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                showInjectionHelp();
            }
        });

        // (重复的traditionalCopyContent已删除 - 保留后面的完整版)

        // (重复的showInjectionHelp已删除 - 保留后面的完整版)

        // 页面加载完成提示快捷键
        window.addEventListener('load', () => {
            console.log('🧠 NodeMind注入功能已加载');
            console.log('💡 快捷键：');
            console.log('   Ctrl + Enter: 一键注入到Cursor');
            console.log('   Ctrl + Shift + Enter: 传统复制方式');
            console.log('   Ctrl + I: 显示帮助信息');
        });

    </script>

    <!-- 直接节点点击修复 -->
    <script>
        console.log('🔧 开始直接修复节点点击功能...');
        
        // 等待页面加载完成后执行修复
        window.addEventListener('load', function() {
            setTimeout(function() {
                console.log('🚀 执行节点点击修复...');
                
                // 强制绑定DOM点击事件到所有思维导图容器
                const containers = ['jsmind_container_workspace', 'jsmind_container_knowledge', 'jsmind_container_project'];
                
                containers.forEach(function(containerId) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        console.log('🔗 绑定点击事件到:', containerId);
                        
                        // 移除现有事件监听器
                        container.onclick = null;
                        
                        // 添加新的点击事件监听器
                        container.addEventListener('click', function(e) {
                            console.log('🖱️ 容器点击事件触发:', e.target);
                            
                            // 查找被点击的节点
                            let nodeElement = e.target;
                            let nodeId = null;
                            
                            // 向上查找节点元素
                            while (nodeElement && nodeElement !== container) {
                                if (nodeElement.hasAttribute && nodeElement.hasAttribute('nodeid')) {
                                    nodeId = nodeElement.getAttribute('nodeid');
                                    break;
                                }
                                if (nodeElement.classList && nodeElement.classList.contains('jmnode')) {
                                    nodeId = nodeElement.getAttribute('nodeid');
                                    break;
                                }
                                nodeElement = nodeElement.parentNode;
                            }
                            
                            if (nodeId) {
                                console.log('🎯 找到节点ID:', nodeId);
                                
                                const mapId = containerId.replace('jsmind_container_', '');
                                
                                // 获取节点数据
                                if (window.mindmaps && window.mindmaps[mapId]) {
                                    const mindmap = window.mindmaps[mapId];
                                    const node = mindmap.get_node(nodeId);
                                    
                                    if (node) {
                                        console.log('✅ 获取到节点数据:', node.topic);
                                        
                                        // 直接更新详情面板
                                        forceUpdateNodeDetails(node);
                                    }
                                }
                            }
                        });
                        
                        console.log('✅ 点击事件绑定完成:', containerId);
                    }
                });
                
                // 显示修复完成提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;font-size:14px;';
                notice.textContent = '✅ 节点点击修复已应用';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 3000);
                
            }, 2000); // 等待2秒确保所有内容加载完成
        });
        
        // 强制更新节点详情的函数
        function forceUpdateNodeDetails(node) {
            console.log('🔧 强制更新节点详情:', node.topic);
            
            // 更新选中状态
            window.selectedNodeId = node.id;
            const statusElement = document.getElementById('selectedNode');
            if (statusElement) {
                statusElement.textContent = node.topic || '无';
            }
            
            // 确保节点数据存在
            if (!window.nodeDatabase) {
                window.nodeDatabase = {};
            }
            
            // 创建或获取节点数据
            const cleanTitle = node.topic.replace(' 📄', '');
            if (!window.nodeDatabase[node.id]) {
                window.nodeDatabase[node.id] = {
                    id: node.id,
                    title: cleanTitle,
                    content: '',
                    author: 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    sessions: [],
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            const nodeData = window.nodeDatabase[node.id];
            
            // 确保节点数据有完整结构
            if (!nodeData.sessions) nodeData.sessions = [];
            if (!nodeData.tags) nodeData.tags = { categories: [], technical: [], status: [] };
            
            // 切换到节点信息标签页并更新四组件
            switchToDetailTab();
            updateFourComponentsForNode(node.id);
            
            console.log('✅ 节点详情已更新到四组件系统');
        }
        
        // 保存节点数据的函数
        function saveNodeData(nodeId) {
            const titleInput = document.getElementById(`node-title-${nodeId}`);
            const contentTextarea = document.getElementById(`node-content-${nodeId}`);
            
            if (titleInput && contentTextarea && window.nodeDatabase && window.nodeDatabase[nodeId]) {
                window.nodeDatabase[nodeId].title = titleInput.value;
                window.nodeDatabase[nodeId].content = contentTextarea.value;
                window.nodeDatabase[nodeId].modified = new Date().toISOString();
                
                // 显示保存提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = '💾 数据已保存';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
                
                console.log('💾 节点数据已保存:', nodeId);
            }
        }
        
        // 会话管理函数
        function addNewSession(nodeId) {
            console.log('➕ 添加新会话:', nodeId);
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId]) {
                console.log('❌ 节点数据不存在');
                return;
            }
            
            const nodeData = window.nodeDatabase[nodeId];
            if (!nodeData.sessions) {
                nodeData.sessions = [];
            }
            
            const newSession = {
                id: Date.now().toString(),
                title: `会话 ${nodeData.sessions.length + 1}`,
                content: '',
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
            
            nodeData.sessions.push(newSession);
            
            // 刷新会话列表显示
            const sessionList = document.getElementById(`session-list-${nodeId}`);
            if (sessionList) {
                const sessionHtml = `
                    <div class="session-item" onclick="selectSession('${nodeId}', ${nodeData.sessions.length - 1})">
                        <div class="session-header">
                            <span class="session-title">${newSession.title}</span>
                            <span class="session-time">${new Date(newSession.created).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                sessionList.insertAdjacentHTML('beforeend', sessionHtml);
            }
            
            console.log('✅ 新会话已添加');
        }
        
        function selectSession(nodeId, sessionIndex) {
            console.log('📖 选择会话:', nodeId, sessionIndex);
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId] || !window.nodeDatabase[nodeId].sessions) {
                return;
            }
            
            const session = window.nodeDatabase[nodeId].sessions[sessionIndex];
            if (session) {
                // 这里可以实现会话内容的显示逻辑
                console.log('会话内容:', session);
                
                // 显示提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#17a2b8;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = `📖 已选择: ${session.title}`;
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
            }
        }
        
        function viewAllSessions(nodeId) {
            console.log('📖 查看所有会话:', nodeId);
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId] || !window.nodeDatabase[nodeId].sessions) {
                return;
            }
            
            const sessions = window.nodeDatabase[nodeId].sessions;
            console.log('所有会话:', sessions);
            
            // 显示提示
            const notice = document.createElement('div');
            notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#28a745;color:white;padding:10px;border-radius:5px;z-index:9999;';
            notice.textContent = `📖 共有 ${sessions.length} 个会话`;
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), 2000);
        }
        
        function clearAllSessions(nodeId) {
            console.log('🗑️ 清空所有会话:', nodeId);
            
            if (!window.nodeDatabase || !window.nodeDatabase[nodeId]) {
                return;
            }
            
            if (confirm('确定要清空所有会话吗？此操作不可撤销。')) {
                window.nodeDatabase[nodeId].sessions = [];
                
                // 刷新会话列表显示
                const sessionList = document.getElementById(`session-list-${nodeId}`);
                if (sessionList) {
                    sessionList.innerHTML = `
                        <div class="session-item new-session-btn" onclick="addNewSession('${nodeId}')">
                            <span class="new-session-icon">➕</span>
                            <span class="new-session-text">新增会话</span>
                        </div>
                    `;
                }
                
                // 显示提示
                const notice = document.createElement('div');
                notice.style.cssText = 'position:fixed;top:10px;right:10px;background:#dc3545;color:white;padding:10px;border-radius:5px;z-index:9999;';
                notice.textContent = '🗑️ 所有会话已清空';
                document.body.appendChild(notice);
                setTimeout(() => notice.remove(), 2000);
                
                console.log('✅ 所有会话已清空');
            }
        }
        
        // 模板管理函数
        async function openTemplateManager() {
            console.log('🔧 打开模板管理器...');
            
            // 🔍 诊断检查点1：模板管理器打开时的状态
            console.log('🔍 [检查点1] 模板管理器打开');
            console.log('📋 templateData 可用性:', !!window.templateData);
            console.log('📦 templateSelectionService 可用性:', !!window.templateSelectionService);
            console.log('🔧 服务初始化状态:', window.templateSelectionService?.initialized);
            
            if (window.templateData) {
                console.log('📝 可用模板列表:', Object.keys(window.templateData));
            } else {
                console.error('❌ templateData 不可用');
            }
            
            if (!window.templateSelectionService && typeof TemplateSelectionService !== 'undefined' && window.templateData) {
                console.warn('⚠️ templateSelectionService 不可用，尝试手动初始化...');
                window.templateSelectionService = new TemplateSelectionService();
                window.templateSelectionService.init();
                console.log('✅ 手动初始化模板选择服务成功');
            }
            
            // 显示模板管理器容器
            const container = document.getElementById('template-manager-container');
            if (container) {
                console.log('✅ 找到模板管理器容器，显示模态框');
                container.style.display = 'block';
                
                // 检查模态框头部是否存在
                const header = container.querySelector('.modal-header');
                const backBtn = container.querySelector('.back-btn');
                console.log('📋 模态框头部:', header ? '存在' : '不存在');
                console.log('🔙 返回按钮:', backBtn ? '存在' : '不存在');
                
                // 初始化模板管理器内容
                if (!window.templateManagerInitialized) {
                    initializeTemplateManagerContent();
                    window.templateManagerInitialized = true;
                }
                
                showMessage('⚙️ 模板管理器已打开', 2000, 'success');
            } else {
                console.error('❌ 未找到模板管理器容器');
                showMessage('❌ 模板管理器容器不存在', 3000, 'error');
                return;
            }
        }
        
        // 关闭模板管理器
        function closeTemplateManager() {
            const container = document.getElementById('template-manager-container');
            if (container) {
                container.style.display = 'none';
                console.log('❌ 模板管理器已关闭');
            }
        }
        
        // 初始化模板管理器内容
        function initializeTemplateManagerContent() {
            console.log('🔧 初始化模板管理器内容...');
            
            const modalBody = document.querySelector('#template-manager-container .modal-body');
            if (!modalBody) {
                console.error('❌ 未找到模板管理器主体容器');
                return;
            }
            
            // 创建模板管理器界面
            modalBody.innerHTML = `
                <div class="template-manager-content">
                    <!-- 工具栏 -->
                    <div class="template-toolbar">
                        <div class="toolbar-left">
                            <div class="search-box">
                                <input type="text" id="template-search" placeholder="搜索模板..." />
                                <button type="button" class="search-btn">🔍</button>
                            </div>
                        </div>
                        <div class="toolbar-right">
                            <button type="button" class="btn btn-primary" onclick="addNewTemplate()">
                                ➕ 新建模板
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="importTemplates()">
                                📥 导入
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="exportTemplates()">
                                📤 导出
                            </button>
                        </div>
                    </div>

                    <!-- 模板分类标签 -->
                    <div class="template-categories">
                        <div class="category-tabs" id="category-tabs">
                            <button class="category-tab active" data-category="all">全部</button>
                            <button class="category-tab" data-category="natural">自然模式</button>
                            <button class="category-tab" data-category="technical">技术模式</button>
                            <button class="category-tab" data-category="creative">创意模式</button>
                            <button class="category-tab" data-category="log">日志模式</button>
                            <button class="category-tab" data-category="feature">功能开发</button>
                        </div>
                    </div>

                    <!-- 模板网格 -->
                    <div class="template-grid" id="template-grid">
                        <!-- 模板卡片将在这里动态生成 -->
                    </div>
                </div>
            `;
            
            // 绑定事件
            bindTemplateManagerEvents();
            
            // 渲染模板列表
            renderTemplateGrid('all');
            
            console.log('✅ 模板管理器内容初始化完成');
        }
        
        // 绑定模板管理器事件
        function bindTemplateManagerEvents() {
            // 关闭按钮事件
            const closeBtn = document.getElementById('template_manager_close_button');
            if (closeBtn) {
                closeBtn.onclick = closeTemplateManager;
            }
            
            // 返回按钮事件
            const backBtn = document.getElementById('template_manager_back_button');
            if (backBtn) {
                backBtn.onclick = closeTemplateManager;
            }
            
            // 背景点击关闭
            const backdrop = document.getElementById('template_manager_backdrop');
            if (backdrop) {
                backdrop.onclick = closeTemplateManager;
            }
            
            // 分类标签切换
            const categoryTabs = document.querySelectorAll('.category-tab');
            categoryTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有active类
                    categoryTabs.forEach(t => t.classList.remove('active'));
                    // 添加当前active类
                    tab.classList.add('active');
                    // 渲染对应分类的模板
                    renderTemplateGrid(tab.dataset.category);
                });
            });
            
            // 搜索功能
            const searchInput = document.getElementById('template-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (query) {
                        searchTemplates(query);
                    } else {
                        const activeCategory = document.querySelector('.category-tab.active')?.dataset.category || 'all';
                        renderTemplateGrid(activeCategory);
                    }
                });
            }
        }
        
        // 渲染模板网格
        function renderTemplateGrid(category = 'all') {
            const grid = document.getElementById('template-grid');
            if (!grid) return;
            
            // 获取模板数据（这里需要从原始代码中获取templateData）
            const templates = getFilteredTemplates(category);
            
            if (templates.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <div class="empty-text">暂无${category === 'all' ? '' : '该分类的'}模板</div>
                        <button class="btn btn-primary" onclick="addNewTemplate()">创建第一个模板</button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = templates.map(template => `
                <div class="template-card" data-template-id="${template.id}">
                    <div class="template-header">
                        <div class="template-icon">${getTemplateIcon(template.category)}</div>
                        <div class="template-name">${template.name}</div>
                        <div class="template-actions">
                            <button class="action-btn select-btn" onclick="console.log('🔍 [检查点2] 按钮点击模板:', '${template.id}'); console.log('🔍 服务状态:', !!window.templateSelectionService); if(window.templateSelectionService) { window.templateSelectionService.toggleSelection('${template.id}'); } else { console.error('❌ templateSelectionService 不可用'); }" title="选择此模板">✓</button>
                            <button class="action-btn" onclick="editTemplate('${template.id}')" title="编辑">✏️</button>
                            <button class="action-btn" onclick="copyTemplate('${template.id}')" title="复制">📋</button>
                            <button class="action-btn" onclick="deleteTemplate('${template.id}')" title="删除">🗑️</button>
                        </div>
                    </div>
                    <div class="template-description">${template.description || '无描述'}</div>
                    <div class="template-category">${getCategoryName(template.category)}</div>
                </div>
            `).join('');
        }
        
                 // 获取过滤后的模板
         function getFilteredTemplates(category) {
             // 使用已经定义的templateData
             const templates = Object.keys(window.templateData).map(key => ({
                 id: key,
                 name: window.templateData[key].name,
                 description: window.templateData[key].description,
                 category: window.templateData[key].category,
                 prefix: window.templateData[key].prefix,
                 suffix: window.templateData[key].suffix
             }));
             
             if (category === 'all') {
                 return templates;
             }
             
             return templates.filter(template => template.category === category);
         }
        
        // 获取分类名称
        function getCategoryName(category) {
            const categoryNames = {
                'natural': '自然模式',
                'technical': '技术模式',
                'creative': '创意模式',
                'log': '日志模式',
                'feature': '功能开发'
            };
            return categoryNames[category] || category;
        }
        
        // 根据分类获取模板图标
        function getTemplateIcon(category) {
            const icons = {
                'natural': '💬',
                'technical': '⚙️',
                'creative': '🎨',
                'log': '📝',
                'feature': '🚀'
            };
            return icons[category] || '📄';
        }
        
                 // 复制模板内容
         function copyTemplate(templateId) {
             const template = window.templateData[templateId];
             if (!template) {
                 showMessage('❌ 模板不存在', 2000, 'error');
                 return;
             }
             
             const content = `${template.prefix || ''}\n\n[在此输入具体内容]\n\n${template.suffix || ''}`.trim();
             
             navigator.clipboard.writeText(content).then(() => {
                 showMessage(`📋 模板"${template.name}"已复制到剪贴板`, 2000, 'success');
             }).catch(err => {
                 console.error('复制失败:', err);
                 showMessage('❌ 复制失败', 2000, 'error');
             });
         }
        
                 // 搜索模板
         function searchTemplates(query) {
             const templates = Object.keys(window.templateData).map(key => ({
                 id: key,
                 name: window.templateData[key].name,
                 description: window.templateData[key].description,
                 category: window.templateData[key].category,
                 prefix: window.templateData[key].prefix,
                 suffix: window.templateData[key].suffix
             }));
             const results = templates.filter(template => 
                 template.name.toLowerCase().includes(query.toLowerCase()) ||
                 (template.description && template.description.toLowerCase().includes(query.toLowerCase()))
             );
            
            const grid = document.getElementById('template-grid');
            if (!grid) return;
            
            if (results.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🔍</div>
                        <div class="empty-text">未找到匹配"${query}"的模板</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = results.map(template => `
                <div class="template-card" data-template-id="${template.id}">
                    <div class="template-header">
                        <div class="template-icon">${getTemplateIcon(template.category)}</div>
                        <div class="template-name">${template.name}</div>
                        <div class="template-actions">
                            <button class="action-btn select-btn" onclick="console.log('🔍 [检查点3] 搜索结果按钮点击:', '${template.id}'); if(window.templateSelectionService) { window.templateSelectionService.toggleSelection('${template.id}'); } else { console.error('❌ templateSelectionService 不可用'); }" title="选择此模板">✓</button>
                            <button class="action-btn" onclick="editTemplate('${template.id}')" title="编辑">✏️</button>
                            <button class="action-btn" onclick="copyTemplate('${template.id}')" title="复制">📋</button>
                            <button class="action-btn" onclick="deleteTemplate('${template.id}')" title="删除">🗑️</button>
                        </div>
                    </div>
                    <div class="template-description">${template.description || '无描述'}</div>
                    <div class="template-category">${getCategoryName(template.category)}</div>
                </div>
            `).join('');
        }
        
        // (重复的简单版copyContentFromEditor已删除 - 保留功能完整版)
        
        // (重复的简单版pasteContentToEditor已删除 - 保留功能完整版)
        
        // (重复的submitContent函数已删除 - 保留第一个定义)
        
        // 显示消息的辅助函数
        function showMessage(message, duration = 3000, type = 'info') {
            const notice = document.createElement('div');
            
            let backgroundColor;
            switch (type) {
                case 'success':
                    backgroundColor = '#28a745';
                    break;
                case 'error':
                    backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    backgroundColor = '#ffc107';
                    break;
                default:
                    backgroundColor = '#17a2b8';
            }
            
            notice.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: ${backgroundColor};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                z-index: 9999;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                max-width: 350px;
            `;
            notice.textContent = message;
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), duration);
        }
        
        // 传统复制功能（不触发直接注入）
        async function traditionalCopyContent(nodeId) {
            const contentEditor = document.getElementById(`node-content-${nodeId}`);
            if (!contentEditor) {
                showMessage('❌ 找不到内容编辑器', 2000, 'error');
                return;
            }
            
            const content = contentEditor.value.trim();
            if (!content) {
                showMessage('❌ 请先输入要复制的内容', 2000, 'error');
                return;
            }
            
            const nodeData = window.nodeDatabase[nodeId] || {};
            const nodeTitle = nodeData.title || `节点${nodeId}`;
            
            try {
                // 创建传统复制的JSON协议（不包含direct_inject标记）
                const injectionData = {
                    source: 'nodemind',
                    type: 'content-injection',
                    content: content,
                    timestamp: new Date().toISOString(),
                    nodeId: nodeId,
                    nodeTitle: nodeTitle,
                    projectName: 'NodeMind'
                };

                const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;
                await navigator.clipboard.writeText(clipboardContent);

                showMessage('📋 内容已复制到剪贴板，请在injection工具中点击"注入命令"', 3000, 'info');
                console.log('📋 传统协议已复制:', injectionData);

            } catch (error) {
                console.error('复制失败:', error);
                showMessage('❌ 复制失败：' + error.message, 3000, 'error');
            }
        }

        // 显示注入功能帮助信息
        function showInjectionHelp() {
            const helpContent = `
🧠 NodeMind - 一键注入到Cursor 帮助

📋 快捷键说明：
• Ctrl + Enter: 一键直接注入到Cursor
• Ctrl + Shift + Enter: 传统方式（仅复制到剪贴板）
• Ctrl + I: 显示此帮助信息

🎯 使用方法：
1. 选择包含内容的节点
2. 按下快捷键进行注入或复制
3. injection工具会自动执行注入流程

📝 注入协议：
• 使用NODEMIND_INJECTION:JSON格式
• 包含节点ID、标题、内容和时间戳
• direct_inject标记区分直接注入和传统复制

💡 小提示：
• 确保injection工具正在运行
• 一键注入需要完成校准设置
• 传统方式需要手动点击injection工具中的"注入命令"按钮
            `.trim();
            
            // 使用浏览器原生alert显示帮助
            alert(helpContent);
        }

        // 获取当前选中的节点ID（从全局状态或DOM中获取）
        function getCurrentSelectedNodeId() {
            // 优先从全局状态获取
            if (window.selectedNodeId) {
                return window.selectedNodeId;
            }
            
            // 从DOM中查找当前激活的内容编辑器
            const activeEditor = document.querySelector('textarea[id^="node-content-"]:focus');
            if (activeEditor) {
                const match = activeEditor.id.match(/node-content-(.+)/);
                if (match) {
                    return match[1];
                }
            }
            
            // 查找最近更新的内容编辑器
            const allEditors = document.querySelectorAll('textarea[id^="node-content-"]');
            if (allEditors.length > 0) {
                const lastEditor = allEditors[allEditors.length - 1];
                const match = lastEditor.id.match(/node-content-(.+)/);
                if (match) {
                    return match[1];
                }
            }
            
            return null;
        }

        // 键盘快捷键支持
        document.addEventListener('keydown', (e) => {
            // Ctrl + Enter 触发提交功能
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                
                const nodeId = getCurrentSelectedNodeId();
                if (nodeId) {
                    // 检查是否有内容可提交
                    const contentEditor = document.getElementById(`node-content-${nodeId}`);
                    if (contentEditor && contentEditor.value.trim()) {
                        console.log('⌨️ 触发快捷键提交:', nodeId);
                        submitContent(nodeId);
                        showMessage('⌨️ Ctrl+Enter 快捷键提交已触发', 2000, 'info');
                    } else {
                        showMessage('⚠️ 请先输入内容进行提交', 2000, 'warning');
                    }
                } else {
                    showMessage('⚠️ 请先选择一个节点', 2000, 'warning');
                }
            }
            
            // Ctrl + Shift + Enter 触发传统复制方式
            else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                
                const nodeId = getCurrentSelectedNodeId();
                if (nodeId) {
                    const contentEditor = document.getElementById(`node-content-${nodeId}`);
                    if (contentEditor && contentEditor.value.trim()) {
                        // 执行传统复制（不包含direct_inject标记）
                        traditionalCopyContent(nodeId);
                        showMessage('⌨️ Ctrl+Shift+Enter 传统复制已触发', 2000, 'info');
                    } else {
                        showMessage('⚠️ 请先输入内容进行复制', 2000, 'warning');
                    }
                } else {
                    showMessage('⚠️ 请先选择一个节点', 2000, 'warning');
                }
            }
            
            // Ctrl + I 显示注入功能帮助
            else if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                showInjectionHelp();
            }
        });

        // 页面加载完成提示快捷键
        window.addEventListener('load', () => {
            console.log('🧠 NodeMind注入功能已加载');
            console.log('💡 快捷键：');
            console.log('   Ctrl + Enter: 一键注入到Cursor');
            console.log('   Ctrl + Shift + Enter: 传统复制方式');
            console.log('   Ctrl + I: 显示帮助信息');
        });

        // 导出到全局
        window.forceUpdateNodeDetails = forceUpdateNodeDetails;
        window.saveNodeData = saveNodeData;
        window.addNewSession = addNewSession;
        window.selectSession = selectSession;
        window.viewAllSessions = viewAllSessions;
        window.clearAllSessions = clearAllSessions;
        window.openTemplateManager = openTemplateManager;
        window.copyContentFromEditor = copyContentFromEditor;
        window.pasteContentToEditor = pasteContentToEditor;
        window.submitContent = submitContent;
        window.showMessage = showMessage;
        window.traditionalCopyContent = traditionalCopyContent;
        window.showInjectionHelp = showInjectionHelp;

        // 四组件功能代码
        // 全局状态管理
        class GlobalStateManager {
            constructor() {
                this.selectedTags = new Set();
                this.selectedTemplates = [];
                this.qaMode = true;
                this.layoutRatio = 0.6; // 左侧面板占比
            }

            // 标签状态管理
            toggleTag(tagElement) {
                const tagText = tagElement.textContent;
                if (this.selectedTags.has(tagText)) {
                    this.selectedTags.delete(tagText);
                    tagElement.classList.remove('selected');
                } else {
                    this.selectedTags.add(tagText);
                    tagElement.classList.add('selected');
                }
                console.log(`标签"${tagText}"${this.selectedTags.has(tagText) ? '已选中' : '已取消'}`);
            }

            // 模板状态管理
            addTemplate(template) {
                if (!this.selectedTemplates.find(t => t.name === template.name)) {
                    this.selectedTemplates.push(template);
                    this.renderTemplates();
                    console.log(`模板"${template.name}"已添加`);
                }
            }

            removeTemplate(templateName) {
                this.selectedTemplates = this.selectedTemplates.filter(t => t.name !== templateName);
                this.renderTemplates();
                console.log(`模板"${templateName}"已移除`);
            }

            useTemplate(templateName) {
                const template = this.selectedTemplates.find(t => t.name === templateName);
                if (template) {
                    const editor = document.getElementById('content-editor');
                    if (editor) {
                        editor.value = template.content;
                        console.log(`模板"${templateName}"已应用到编辑器`);
                    }
                }
            }

            renderTemplates() {
                const container = document.getElementById('template-list');
                if (!container) return;
                
                // 从模板选择服务获取选中的模板
                let selectedTemplates = [];
                if (window.templateSelectionService) {
                    selectedTemplates = window.templateSelectionService.getSelectedTemplates();
                    console.log('📋 从模板选择服务获取模板:', selectedTemplates.length, '个');
                    
                    // 同步到本地状态
                    this.selectedTemplates = selectedTemplates.map(template => ({
                        name: template.name || template.title,
                        content: template.prefix || template.content || ''
                    }));
                } else {
                    // 回退到本地模板列表
                    selectedTemplates = this.selectedTemplates;
                    console.log('📋 使用本地模板列表:', selectedTemplates.length, '个');
                }
                
                if (selectedTemplates.length === 0) {
                    container.innerHTML = `
                        <div class="empty-template-state">
                            <div class="empty-icon">📝</div>
                            <div class="empty-text">暂无选中模板</div>
                            <div class="empty-hint">点击"管理"按钮添加模板</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = selectedTemplates.map(template => `
                        <div class="template-item">
                            <span class="template-name">${template.name || template.title}</span>
                            <div class="template-actions">
                                <button class="template-btn template-btn-use" onclick="fourComponentUseTemplate('${template.id || template.name}')">使用</button>
                                <button class="template-btn template-btn-remove" onclick="fourComponentRemoveTemplate('${template.id || template.name}')">移除</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                // 自动保存四组件数据
                setTimeout(() => saveFourComponentData(), 100);
            }

            reset() {
                this.selectedTags = new Set();
                this.selectedTemplates = [];
                this.qaMode = true;
                this.layoutRatio = 0.6;
                console.log('🔄 四组件全局状态已重置');
            }
        }

        // 节点状态管理
        class NodeStateManager {
            constructor() {
                this.currentNode = null;
                this.nodeData = {};
                this.sessionData = {};
            }

            loadNode(nodeId) {
                this.currentNode = nodeId;
                console.log(`🔄 NodeStateManager 加载节点: ${nodeId}`);
                
                // 确保节点数据存在，但优先使用已有数据
                if (!this.nodeData[nodeId]) {
                    // 尝试从主应用的nodeDatabase获取数据
                    const mainNodeData = nodeDatabase[nodeId];
                    
                    this.nodeData[nodeId] = {
                        id: nodeId,
                        title: mainNodeData?.title || `节点 ${nodeId}`,
                        content: mainNodeData?.content || '',
                        createTime: mainNodeData?.created ? new Date(mainNodeData.created).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'),
                        updateTime: mainNodeData?.modified ? new Date(mainNodeData.modified).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN')
                    };
                    
                    console.log(`📝 创建节点数据: ${nodeId}, 内容长度: ${this.nodeData[nodeId].content.length}`);
                } else {
                    console.log(`📂 使用已有节点数据: ${nodeId}, 内容长度: ${this.nodeData[nodeId].content.length}`);
                }

                // 确保会话数据存在
                if (!this.sessionData[nodeId]) {
                    this.sessionData[nodeId] = [];
                }

                this.updateUI();
                console.log(`✅ 节点 ${nodeId} 已加载完成`);
            }

            updateUI() {
                if (!this.currentNode) {
                    console.log('❌ updateUI: 没有当前节点');
                    return;
                }

                const nodeData = this.nodeData[this.currentNode];
                if (!nodeData) {
                    console.log(`❌ updateUI: 节点数据不存在: ${this.currentNode}`);
                    return;
                }
                
                console.log(`🔄 updateUI: 更新节点 ${this.currentNode} 的UI，内容长度: ${nodeData.content.length}`);
                
                // 更新标题
                const nodeTitleElement = document.getElementById('node-title');
                
                if (nodeTitleElement) {
                    nodeTitleElement.textContent = nodeData.title;
                    console.log(`✅ 已更新标题显示: ${nodeData.title}`);
                }
                
                // 更新内容
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    contentEditor.value = nodeData.content;
                    console.log(`✅ 已更新内容编辑器: ${nodeData.content.length} 字符`);
                    console.log(`📝 内容预览: "${nodeData.content.substring(0, 100)}..."`);
                } else {
                    console.log('❌ 找不到内容编辑器元素');
                }
                
                // 更新元信息
                const metaInfo = document.getElementById('meta-info');
                if (metaInfo) {
                    metaInfo.textContent = `创建时间: ${nodeData.createTime} | 修改时间: ${nodeData.updateTime}`;
                }
                
                // 更新会话列表
                this.renderSessions();
                
                console.log(`✅ updateUI 完成: ${this.currentNode}`);
            }

            updateContent() {
                if (!this.currentNode) return;

                const titleInput = document.getElementById('title-input');
                const contentEditor = document.getElementById('content-editor');
                
                if (titleInput && contentEditor) {
                    const title = titleInput.value;
                    const content = contentEditor.value;
                    
                    // 使用专门的更新函数（包含思维导图同步）
                    updateFourComponentNodeTitle(this.currentNode, title);
                    updateFourComponentNodeContent(this.currentNode, content);
                    
                    // 更新元信息
                    const metaInfo = document.getElementById('meta-info');
                    if (metaInfo) {
                        metaInfo.textContent = `创建时间: ${this.nodeData[this.currentNode].createTime} | 修改时间: ${this.nodeData[this.currentNode].updateTime}`;
                    }
                    
                    // 自动保存四组件数据
                    setTimeout(() => saveFourComponentData(), 100);
                }
            }

            async submitContent() {
                if (!this.currentNode) return;

                console.log(`🚀 开始提交内容: ${this.currentNode}`);
                
                // 获取内容编辑器
                const contentEditor = document.getElementById('content-editor');
                if (!contentEditor) {
                    console.error('❌ 找不到内容编辑器');
                    return;
                }

                const content = contentEditor.value.trim();
                
                // 获取节点信息
                const nodeData = this.nodeData[this.currentNode] || {};
                const nodeTitle = (nodeData.title || `节点${this.currentNode}`).trim();
                
                // 构建注入内容（标题+内容格式）
                let injectionContent = '';
                
                if (nodeTitle && content) {
                    // 都存在：使用 "- 标题\n- 内容" 格式
                    injectionContent = `- ${nodeTitle}\n- ${content}`;
                } else if (nodeTitle) {
                    // 只有标题：直接使用标题
                    injectionContent = nodeTitle;
                } else if (content) {
                    // 只有内容：直接使用内容
                    injectionContent = content;
                } else {
                    // 都没有：提示错误
                    console.error('❌ 请先输入标题或内容');
                    return;
                }

                try {
                    // 创建一键注入的JSON协议（借鉴node_mind_injection_page.html）
                    const injectionData = {
                        source: 'nodemind',
                        type: 'content-injection',
                        content: injectionContent,
                        direct_inject: true,  // 关键：标识为直接注入
                        timestamp: new Date().toISOString(),
                        nodeId: this.currentNode,
                        nodeTitle: nodeTitle,
                        projectName: 'NodeMind'
                    };

                    // 构建完整的剪贴板内容
                    const clipboardContent = `NODEMIND_INJECTION:${JSON.stringify(injectionData)}`;

                    // 复制到剪贴板
                    await navigator.clipboard.writeText(clipboardContent);

                    // 显示成功消息
                    console.log('🎯 一键注入已触发！injection工具正在自动执行注入流程...');
                    
                    // 获取提交按钮并更新状态
                    const submitButton = document.querySelector('.btn-primary');
                    if (submitButton) {
                        const originalText = submitButton.textContent;
                        submitButton.textContent = '✅ 注入已触发';
                        submitButton.disabled = true;
                        
                        // 2秒后恢复按钮
                        setTimeout(() => {
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                        }, 2000);
                    }

                    // 在内容末尾添加[已注入]标签
                    if (content && !content.includes('[已注入]')) {
                        const newContent = content + '\n[已注入]';
                        contentEditor.value = newContent;
                        
                        // 保存到nodeData
                        if (this.nodeData[this.currentNode]) {
                            this.nodeData[this.currentNode].content = newContent;
                        }
                        
                        console.log('✅ 已添加[已注入]标签到内容');
                    }

                    console.log('🎯 一键注入协议已发送:', injectionData);
                    
                    // 记录到日志
                    const logEntry = `${new Date().toLocaleString()} - 节点 "${nodeTitle}" 标题+内容已注入到Cursor`;
                    console.log(logEntry);

                    // 创建新会话记录注入操作
                    const session = {
                        id: Date.now(),
                        title: `注入会话 ${this.sessionData[this.currentNode].length + 1}`,
                        content: injectionContent,
                        preview: injectionContent.substring(0, 50) + (injectionContent.length > 50 ? '...' : ''),
                        createTime: new Date().toLocaleString('zh-CN')
                    };

                    this.sessionData[this.currentNode].push(session);
                    this.renderSessions();
                    
                    // 自动保存四组件数据
                    setTimeout(() => saveFourComponentData(), 100);

                } catch (error) {
                    console.error('一键注入失败:', error);
                }
            }

            renderSessions() {
                if (!this.currentNode) return;

                const container = document.getElementById('session-list');
                if (!container) return;
                
                const sessions = this.sessionData[this.currentNode] || [];
                
                                 let html = `
                     <div class="session-item new-session-btn" onclick="fourComponentAddNewSession()">
                         <div class="session-title">➕ 新增会话</div>
                     </div>
                 `;

                                 sessions.forEach((session, index) => {
                     html += `
                         <div class="session-item" onclick="fourComponentSelectSession(${index})">
                             <div class="session-header-content">
                                 <span class="session-title">${session.title}</span>
                                 <span class="session-time">${session.createTime}</span>
                             </div>
                             <div class="session-preview">${session.preview}</div>
                         </div>
                     `;
                 });

                container.innerHTML = html;
            }

            selectSession(index) {
                if (!this.currentNode) return;

                const session = this.sessionData[this.currentNode][index];
                if (session) {
                    if (confirm(`是否加载会话"${session.title}"的内容到编辑器？`)) {
                        const contentEditor = document.getElementById('content-editor');
                        if (contentEditor) {
                            contentEditor.value = session.content;
                            console.log(`会话"${session.title}"已加载到编辑器`);
                        }
                    }
                }
            }

            addSession() {
                if (!this.currentNode) return;

                const session = {
                    id: Date.now(),
                    title: `手动会话 ${this.sessionData[this.currentNode].length + 1}`,
                    content: '这是一个手动添加的测试会话。',
                    preview: '这是一个手动添加的测试会话。',
                    createTime: new Date().toLocaleString('zh-CN')
                };

                this.sessionData[this.currentNode].push(session);
                this.renderSessions();
                console.log('测试会话已添加');
                
                // 自动保存四组件数据
                setTimeout(() => saveFourComponentData(), 100);
            }

            clearSessions() {
                if (!this.currentNode) return;

                if (confirm('确定要清空当前节点的所有会话吗？')) {
                    this.sessionData[this.currentNode] = [];
                    this.renderSessions();
                    console.log('会话已清空');
                    // 自动保存四组件数据
                    setTimeout(() => saveFourComponentData(), 100);
                }
            }

            reset() {
                this.nodeData = {};
                this.sessionData = {};
                this.currentNode = null;
                console.log('🔄 四组件节点状态已重置');
            }
        }

        // 初始化四组件状态管理器
        const fourComponentGlobalState = new GlobalStateManager();
        const fourComponentNodeState = new NodeStateManager();

        // 问答模式切换
        function onQAModeChange() {
            const qaToggle = document.getElementById('qa-mode-toggle');
            if (!qaToggle) return;
            
            const qaMode = qaToggle.checked;
            fourComponentGlobalState.qaMode = qaMode;
            
            const rightPanel = document.getElementById('right-panel');
            const mainSplitter = document.getElementById('main-splitter');
            const mainContentArea = document.getElementById('main-content-area');
            const leftPanel = document.getElementById('left-panel');
            
            console.log('🔄 问答模式切换:', qaMode ? '开启' : '关闭');
            console.log('📍 找到的元素:', {
                rightPanel: !!rightPanel,
                mainSplitter: !!mainSplitter, 
                mainContentArea: !!mainContentArea,
                leftPanel: !!leftPanel
            });
            
            if (rightPanel && mainSplitter && mainContentArea) {
                if (qaMode) {
                    rightPanel.classList.remove('hidden');
                    mainSplitter.classList.remove('hidden');
                    mainContentArea.classList.remove('qa-mode-off');
                    console.log('✅ 问答模式已开启 - 显示右侧会话和模板面板');
                } else {
                    rightPanel.classList.add('hidden');
                    mainSplitter.classList.add('hidden');
                    mainContentArea.classList.add('qa-mode-off');
                    console.log('✅ 问答模式已关闭 - 隐藏右侧面板，左侧编辑器区域扩展');
                    console.log('📏 右侧面板类名:', rightPanel.className);
                    console.log('📏 主内容区类名:', mainContentArea.className);
                }
            }
        }

        // 四组件相关函数
        function fourComponentUpdateTitle() {
            // 标题输入框已删除，此函数保留但不执行操作
            console.log('⚠️ 标题输入框已删除，无法更新标题');
        }

        function fourComponentCopyContent() {
            const contentEditor = document.getElementById('content-editor');
            if (contentEditor) {
                navigator.clipboard.writeText(contentEditor.value).then(() => {
                    console.log('内容已复制到剪贴板');
                });
            }
        }

        function fourComponentPasteContent() {
            navigator.clipboard.readText().then(text => {
                const contentEditor = document.getElementById('content-editor');
                if (contentEditor) {
                    contentEditor.value = text;
                    console.log('内容已从剪贴板粘贴');
                }
            });
        }

        function fourComponentSubmitContent() {
            fourComponentNodeState.submitContent();
        }

        function fourComponentToggleTag(tagElement) {
            // 获取当前节点ID
            const currentNodeId = fourComponentNodeState.currentNode;
            if (!currentNodeId) {
                console.log('❌ 没有选中的节点');
                return;
            }
            
            // 使用详细描述选项卡的标签逻辑
            toggleFourComponentTag(currentNodeId, tagElement);
        }

        // 四组件专用的标签切换函数
        function toggleFourComponentTag(nodeId, tagElement) {
            // 确保nodeDatabase中的节点数据存在
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: `节点 ${nodeId}`,
                    content: '',
                    author: 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
            }
            
            const nodeData = nodeDatabase[nodeId];
            
            // 确保标签结构存在
            if (!nodeData.tags) {
                nodeData.tags = { categories: [], technical: [], status: [] };
            }
            
            const tagName = tagElement.dataset.tag;
            const tagGroup = tagElement.dataset.group;
            
            // 切换选中状态
            if (tagElement.classList.contains('selected')) {
                // 取消选中
                tagElement.classList.remove('selected');
                removeFourComponentTagFromNode(nodeData, tagName, tagGroup);
                console.log(`🏷️ 已移除标签：${tagName}`);
            } else {
                // 选中
                tagElement.classList.add('selected');
                addFourComponentTagToNode(nodeData, tagName, tagGroup);
                console.log(`🏷️ 已添加标签：${tagName}`);
            }
            
            // 更新修改时间
            nodeData.modified = new Date().toISOString();
            
            // 同步到四组件数据
            if (fourComponentNodeState.nodeData[nodeId]) {
                fourComponentNodeState.nodeData[nodeId].updateTime = new Date().toLocaleString('zh-CN');
            }
            
            // 自动保存
            setTimeout(autoSaveData, 500);
            
            // 保存四组件数据
            setTimeout(() => saveFourComponentData(), 100);
            
            // 更新任务管理显示
            if (typeof updateTaskManagement === 'function') {
                updateTaskManagement();
            }
        }

        // 将标签添加到节点（四组件版本）
        function addFourComponentTagToNode(nodeData, tagName, tagGroup) {
            // 根据标签组分类存储
            let targetArray;
            switch(tagGroup) {
                case '分类标签':
                    targetArray = nodeData.tags.categories;
                    break;
                case '技术标签':
                    targetArray = nodeData.tags.technical;
                    break;
                case '状态标签':
                    targetArray = nodeData.tags.status;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            // 避免重复添加
            if (!targetArray.includes(tagName)) {
                targetArray.push(tagName);
            }
        }

        // 从节点移除标签（四组件版本）
        function removeFourComponentTagFromNode(nodeData, tagName, tagGroup) {
            // 根据标签组分类移除
            let targetArray;
            switch(tagGroup) {
                case '分类标签':
                    targetArray = nodeData.tags.categories;
                    break;
                case '技术标签':
                    targetArray = nodeData.tags.technical;
                    break;
                case '状态标签':
                    targetArray = nodeData.tags.status;
                    break;
                default:
                    targetArray = nodeData.tags.categories;
            }
            
            const index = targetArray.indexOf(tagName);
            if (index > -1) {
                targetArray.splice(index, 1);
            }
        }

        // 恢复四组件标签选中状态
        function restoreFourComponentTagStates(nodeId) {
            const nodeData = nodeDatabase[nodeId];
            if (!nodeData || !nodeData.tags) return;
            
            // 获取所有已选中的标签
            const allSelectedTags = [
                ...nodeData.tags.status,
                ...nodeData.tags.technical,
                ...nodeData.tags.categories
            ];
            
            // 恢复UI中的选中状态
            const tagContainers = document.querySelectorAll('#category-tags, #technical-tags, #status-tags');
            tagContainers.forEach(container => {
                const tagItems = container.querySelectorAll('.tag');
                tagItems.forEach(tagItem => {
                    const tagName = tagItem.textContent.trim();
                    if (allSelectedTags.includes(tagName)) {
                        tagItem.classList.add('selected');
                    } else {
                        tagItem.classList.remove('selected');
                    }
                });
            });
            
            console.log(`✅ 四组件标签状态已恢复: ${nodeId}`, allSelectedTags);
        }

        // 保存四组件数据到localStorage
        function saveFourComponentData() {
            try {
                // 保存四组件节点状态数据
                const fourComponentData = {
                    nodeData: fourComponentNodeState.nodeData,
                    sessionData: fourComponentNodeState.sessionData,
                    currentNode: fourComponentNodeState.currentNode,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.FOUR_COMPONENT_DATA, JSON.stringify(fourComponentData));
                
                // 保存四组件全局状态
                const fourComponentGlobalData = {
                    qaMode: fourComponentGlobalState.qaMode,
                    selectedTags: Array.from(fourComponentGlobalState.selectedTags), // 将Set转换为数组以便序列化
                    selectedTemplates: fourComponentGlobalState.selectedTemplates,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE, JSON.stringify(fourComponentGlobalData));
                
                console.log('💾 四组件数据已保存');
                return true;
            } catch (error) {
                console.error('❌ 四组件数据保存失败:', error);
                return false;
            }
        }

        // 从localStorage加载四组件数据
        function loadFourComponentData() {
            try {
                // 加载四组件节点状态数据
                const savedFourComponentData = localStorage.getItem(STORAGE_KEYS.FOUR_COMPONENT_DATA);
                if (savedFourComponentData) {
                    const parsedData = JSON.parse(savedFourComponentData);
                    
                    // 恢复节点数据
                    if (parsedData.nodeData) {
                        fourComponentNodeState.nodeData = parsedData.nodeData;
                        console.log(`📂 已恢复四组件节点数据: ${Object.keys(parsedData.nodeData).length} 个节点`);
                        
                        // 详细日志每个节点的内容
                        Object.entries(parsedData.nodeData).forEach(([nodeId, data]) => {
                            console.log(`  节点 ${nodeId}: "${data.title}" (${data.content ? data.content.length : 0} 字符)`);
                        });
                    }
                    
                    // 恢复会话数据
                    if (parsedData.sessionData) {
                        fourComponentNodeState.sessionData = parsedData.sessionData;
                        console.log(`📂 已恢复四组件会话数据: ${Object.keys(parsedData.sessionData).length} 个节点会话`);
                    }
                    
                    console.log('📂 四组件节点数据已加载');
                } else {
                    console.log('⚠️ 没有找到已保存的四组件数据');
                }
                
                // 加载四组件全局状态
                const savedGlobalState = localStorage.getItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE);
                if (savedGlobalState) {
                    const parsedGlobalData = JSON.parse(savedGlobalState);
                    
                    // 恢复全局状态
                    if (parsedGlobalData.qaMode !== undefined) {
                        fourComponentGlobalState.qaMode = parsedGlobalData.qaMode;
                    }
                    
                    if (parsedGlobalData.selectedTags) {
                        // 如果是数组，转换为Set；如果已经是Set，直接使用
                        if (Array.isArray(parsedGlobalData.selectedTags)) {
                            fourComponentGlobalState.selectedTags = new Set(parsedGlobalData.selectedTags);
                        } else {
                            fourComponentGlobalState.selectedTags = new Set(parsedGlobalData.selectedTags);
                        }
                    }
                    
                    if (parsedGlobalData.selectedTemplates) {
                        fourComponentGlobalState.selectedTemplates = parsedGlobalData.selectedTemplates;
                    }
                    
                    console.log('📂 四组件全局状态已加载');
                }
                
                return true;
            } catch (error) {
                console.error('❌ 四组件数据加载失败:', error);
                return false;
            }
        }

        // 清除四组件数据
        function clearFourComponentData() {
            try {
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_DATA);
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE);
                localStorage.removeItem(STORAGE_KEYS.FOUR_COMPONENT_SESSIONS);
                
                // 重置四组件状态
                fourComponentNodeState.reset();
                fourComponentGlobalState.reset();
                
                console.log('🗑️ 四组件数据已清除');
                return true;
            } catch (error) {
                console.error('❌ 四组件数据清除失败:', error);
                return false;
            }
        }

        function fourComponentAddNewSession() {
            fourComponentNodeState.addSession();
        }

        function fourComponentViewAllSessions() {
            if (!fourComponentNodeState.currentNode) {
                console.log('请先选择一个节点');
                return;
            }
            
            const sessions = fourComponentNodeState.sessionData[fourComponentNodeState.currentNode] || [];
            console.log(`当前节点共有 ${sessions.length} 个会话`);
        }

        function fourComponentClearSessions() {
            fourComponentNodeState.clearSessions();
        }

        function fourComponentSelectSession(index) {
            fourComponentNodeState.selectSession(index);
        }

        function openFourComponentTemplateManager() {
            console.log('四组件模板管理器功能演示（实际应用中会打开模板管理界面）');
            
            // 添加一些示例模板
            const templates = [
                { name: '会议记录模板', content: '# 会议记录\n\n## 时间\n\n## 参与者\n\n## 议题\n\n## 决定事项\n\n## 行动计划' },
                { name: '任务清单模板', content: '# 任务清单\n\n## 待办事项\n- [ ] 任务1\n- [ ] 任务2\n\n## 进行中\n- [ ] 任务3\n\n## 已完成\n- [x] 任务4' }
            ];
            
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
            fourComponentGlobalState.addTemplate(randomTemplate);
        }

        // 拖拽功能初始化
        function initializeFourComponentSplitters() {
            const mainSplitter = document.getElementById('main-splitter');
            const rightSplitter = document.getElementById('right-splitter');
            
            if (!mainSplitter || !rightSplitter) return;
            
            // 主分割线拖拽（左右面板）
            let isMainDragging = false;
            mainSplitter.addEventListener('mousedown', (e) => {
                isMainDragging = true;
                document.addEventListener('mousemove', handleMainDrag);
                document.addEventListener('mouseup', () => {
                    isMainDragging = false;
                    document.removeEventListener('mousemove', handleMainDrag);
                });
            });

            function handleMainDrag(e) {
                if (!isMainDragging) return;
                
                const container = document.getElementById('main-content-area');
                if (!container) return;
                
                const rect = container.getBoundingClientRect();
                const ratio = (e.clientX - rect.left) / rect.width;
                
                if (ratio > 0.3 && ratio < 0.8) {
                    const leftPanel = document.getElementById('left-panel');
                    const rightPanel = document.getElementById('right-panel');
                    
                    if (leftPanel && rightPanel) {
                        leftPanel.style.flex = ratio;
                        rightPanel.style.width = `${(1 - ratio) * 100}%`;
                    }
                }
            }

            // 右侧分割线拖拽（会话和模板）
            let isRightDragging = false;
            rightSplitter.addEventListener('mousedown', (e) => {
                isRightDragging = true;
                document.addEventListener('mousemove', handleRightDrag);
                document.addEventListener('mouseup', () => {
                    isRightDragging = false;
                    document.removeEventListener('mousemove', handleRightDrag);
                });
            });

            function handleRightDrag(e) {
                if (!isRightDragging) return;
                
                const rightPanel = document.getElementById('right-panel');
                if (!rightPanel) return;
                
                const rect = rightPanel.getBoundingClientRect();
                const ratio = (e.clientY - rect.top) / rect.height;
                
                if (ratio > 0.2 && ratio < 0.8) {
                    const sessionSection = document.getElementById('session-section');
                    const templateSection = document.getElementById('template-section');
                    
                    if (sessionSection && templateSection) {
                        sessionSection.style.flex = ratio;
                        templateSection.style.flex = (1 - ratio);
                    }
                }
            }
        }

        // 当切换到节点信息选项卡时初始化四组件
        function initializeFourComponents() {
            // 初始化拖拽功能
            initializeFourComponentSplitters();
            
            // 恢复全局状态
            restoreFourComponentGlobalState();
            
            // 初始化模板显示
            fourComponentGlobalState.renderTemplates();
            
            console.log('四组件已初始化');
        }

        // 恢复四组件全局状态
        function restoreFourComponentGlobalState() {
            // 恢复QA模式状态
            const qaToggle = document.getElementById('qa-mode-toggle');
            if (qaToggle) {
                qaToggle.checked = fourComponentGlobalState.qaMode;
                onQAModeChange(); // 应用状态
            }
            
            // 恢复选中的标签状态
            if (fourComponentGlobalState.selectedTags && fourComponentGlobalState.selectedTags.size > 0) {
                const tagContainers = document.querySelectorAll('#category-tags, #technical-tags, #status-tags');
                tagContainers.forEach(container => {
                    const tagItems = container.querySelectorAll('.tag');
                    tagItems.forEach(tagItem => {
                        const tagName = tagItem.textContent.trim();
                        if (fourComponentGlobalState.selectedTags.has(tagName)) {
                            tagItem.classList.add('selected');
                        }
                    });
                });
            }
            
            console.log('✅ 四组件全局状态已恢复');
        }

        // 当选择节点时更新四组件
        function updateFourComponentsForNode(nodeId) {
            if (!nodeId) return;
            
            console.log(`🔄 更新四组件: ${nodeId}`);
            
            // 节点信息页面（原命令注入选项卡）现在是默认页面，无需检查
            
            // 从主应用获取节点数据
            let node = null;
            let cleanTitle = '';
            
            // 尝试从当前思维导图获取节点数据
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    cleanTitle = node.topic.replace(' 📄', '');
                }
            }
            
            // 从nodeDatabase获取更完整的数据
            const nodeData = nodeDatabase[nodeId] || {};
            
            // 如果没有从思维导图获取到标题，使用数据库中的标题
            if (!cleanTitle && nodeData.title) {
                cleanTitle = nodeData.title;
            }
            
            // 如果还是没有标题，使用默认标题
            if (!cleanTitle) {
                cleanTitle = `节点 ${nodeId}`;
            }
            
            // 检查是否有从localStorage恢复的四组件数据
            const savedNodeData = fourComponentNodeState.nodeData[nodeId];
            
            // 更新四组件的节点数据（优先使用nodeDatabase中的数据，因为它是最新的）
            const finalTitle = nodeData.title || savedNodeData?.title || cleanTitle || `节点 ${nodeId}`;
            const finalContent = savedNodeData?.content || nodeData.content || '';
            
            fourComponentNodeState.nodeData[nodeId] = {
                id: nodeId,
                title: finalTitle,
                content: finalContent,
                createTime: savedNodeData?.createTime || (nodeData.created ? new Date(nodeData.created).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN')),
                updateTime: savedNodeData?.updateTime || (nodeData.modified ? new Date(nodeData.modified).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN'))
            };
            
            console.log(`📝 四组件节点数据:`, fourComponentNodeState.nodeData[nodeId]);
            console.log(`📝 准备加载内容: "${finalContent.substring(0, 100)}..."`);
            
            // 加载节点到四组件
            fourComponentNodeState.loadNode(nodeId);
            
            // 确保UI元素显示正确的内容
            setTimeout(() => {
                const contentEditor = document.getElementById('content-editor');
                
                if (contentEditor && contentEditor.value !== finalContent) {
                    contentEditor.value = finalContent;
                    console.log(`🔄 已设置内容编辑器: ${finalContent.length} 字符`);
                }
            }, 100);
            
            // 绑定四组件的输入事件监听器
            bindFourComponentInputEvents(nodeId);
            
            // 恢复标签选中状态
            setTimeout(() => {
                restoreFourComponentTagStates(nodeId);
            }, 100);
            
            console.log(`✅ 四组件更新完成: ${nodeId}`);
        }

        // 绑定四组件输入事件监听器
        function bindFourComponentInputEvents(nodeId) {
            const contentEditor = document.getElementById('content-editor');
            
            // 移除之前的事件监听器（避免重复绑定）
            if (contentEditor) {
                contentEditor.removeEventListener('input', fourComponentContentInputHandler);
                contentEditor.removeEventListener('blur', fourComponentContentBlurHandler);
            }
            
            // 创建事件处理函数 - 使用MD直存逻辑
            window.fourComponentContentInputHandler = async function() {
                const content = this.value;
                console.log(`📝 四组件内容输入: ${nodeId} -> ${content.length} 字符`);
                
                // 立即更新本地数据
                updateFourComponentNodeContent(nodeId, content);
                
                // 清除之前的保存计时器
                clearTimeout(window.fourComponentMDSaveTimeout);
                
                // 使用MD直存逻辑延迟保存
                window.fourComponentMDSaveTimeout = setTimeout(async () => {
                    try {
                        const title = nodeDatabase[nodeId]?.title || '未命名';
                        const mdContent = `# ${title}\n\n${content}`;
                        
                        const service = await initMDDirectService();
                        const result = await service.addMDContent(mdContent, {
                            nodeId: nodeId,
                            updateExisting: true
                        });
                        
                        if (result.success) {
                            console.log(`✅ 四组件MD直存保存: ${nodeId}`);
                        }
                    } catch (error) {
                        console.error('❌ 四组件MD直存保存失败:', error);
                        
                        // 降级到传统保存
                        autoSaveData();
                        console.log(`💾 四组件降级保存: ${nodeId}`);
                    }
                }, 1000);
            };
            
            window.fourComponentContentBlurHandler = function() {
                autoSaveData();
            };
            
            // 绑定内容输入实时联动
            if (contentEditor) {
                contentEditor.addEventListener('input', fourComponentContentInputHandler);
                contentEditor.addEventListener('blur', fourComponentContentBlurHandler);
            }
            
            console.log(`✅ 四组件输入事件已绑定: ${nodeId}`);
        }

        // 更新四组件节点标题
        function updateFourComponentNodeTitle(nodeId, title) {
            console.log(`🔄 更新四组件节点标题: ${nodeId} -> ${title}`);
            
            // 确保nodeDatabase中存在该节点
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: title || `节点 ${nodeId}`,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
                console.log(`📝 创建新的节点数据: ${nodeId}`);
            }
            
            // 更新四组件数据
            if (!fourComponentNodeState.nodeData[nodeId]) {
                fourComponentNodeState.nodeData[nodeId] = {
                    id: nodeId,
                    title: title || `节点 ${nodeId}`,
                    content: nodeDatabase[nodeId].content || '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            }
            
            fourComponentNodeState.nodeData[nodeId].title = title || `节点 ${nodeId}`;
            fourComponentNodeState.nodeData[nodeId].updateTime = new Date().toLocaleString('zh-CN');
            
            // 同步到主应用nodeDatabase
            nodeDatabase[nodeId].title = title || `节点 ${nodeId}`;
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            console.log(`💾 已同步到nodeDatabase: ${nodeId}`);
            
            // 同步更新思维导图显示
            const currentMindmapInstance = getCurrentJsMind();
            if (currentMindmapInstance) {
                const node = currentMindmapInstance.get_node(nodeId);
                if (node) {
                    // 保持内容图标
                    const hasContent = nodeDatabase[nodeId].content && nodeDatabase[nodeId].content.trim().length > 0;
                    const displayTitle = hasContent ? `${title} 📄` : title;
                    currentMindmapInstance.update_node(nodeId, displayTitle);
                    console.log(`🔄 已更新思维导图显示: ${displayTitle}`);
                }
            }
            
            // 更新四组件的标题显示
            const nodeTitleElement = document.getElementById('node-title');
            if (nodeTitleElement) {
                nodeTitleElement.textContent = title;
            }
            
            // 立即保存到localStorage
            try {
                saveFourComponentData();
                console.log(`✅ 四组件数据已保存到localStorage`);
            } catch (error) {
                console.error(`❌ 四组件数据保存失败:`, error);
            }
            
            console.log(`✅ 四组件标题已更新: ${nodeId} -> ${title}`);
        }

        // 更新四组件节点内容
        function updateFourComponentNodeContent(nodeId, content) {
            console.log(`🔄 更新四组件节点内容: ${nodeId}, 长度: ${content ? content.length : 0}`);
            
            // 确保nodeDatabase中存在该节点
            if (!nodeDatabase[nodeId]) {
                nodeDatabase[nodeId] = {
                    id: nodeId,
                    title: `节点 ${nodeId}`,
                    content: '',
                    author: projectInfo.author || 'NodeMind',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    tags: { categories: [], technical: [], status: [] }
                };
                console.log(`📝 创建新的节点数据: ${nodeId}`);
            }
            
            // 更新四组件数据
            if (!fourComponentNodeState.nodeData[nodeId]) {
                fourComponentNodeState.nodeData[nodeId] = {
                    id: nodeId,
                    title: nodeDatabase[nodeId].title || `节点 ${nodeId}`,
                    content: '',
                    createTime: new Date().toLocaleString('zh-CN'),
                    updateTime: new Date().toLocaleString('zh-CN')
                };
            }
            
            fourComponentNodeState.nodeData[nodeId].content = content || '';
            fourComponentNodeState.nodeData[nodeId].updateTime = new Date().toLocaleString('zh-CN');
            
            // 同步到主应用nodeDatabase
            nodeDatabase[nodeId].content = content || '';
            nodeDatabase[nodeId].modified = new Date().toISOString();
            
            console.log(`💾 已同步到nodeDatabase: ${nodeId}`);
            console.log(`📝 内容预览: ${(content || '').substring(0, 50)}...`);
            
            // 更新节点显示图标
            updateNodeContentIcon(nodeId, content);
            
            // 立即保存到localStorage
            try {
                saveFourComponentData();
                console.log(`✅ 四组件数据已保存到localStorage`);
            } catch (error) {
                console.error(`❌ 四组件数据保存失败:`, error);
            }
            
            console.log(`✅ 四组件内容已更新: ${nodeId} -> 长度${content ? content.length : 0}`);
        }

        // 监听选项卡切换
        document.addEventListener('click', (e) => {
            if (e.target.id === 'detail_tab_injection' || e.target.getAttribute('data-tab') === 'injection') {
                // 延迟初始化，确保DOM已渲染
                setTimeout(() => {
                    initializeFourComponents();
                    // 如果有当前选中的节点，重新绑定事件
                    const currentNode = window.selectedNodeId || fourComponentNodeState.currentNode;
                    if (currentNode) {
                        setTimeout(() => {
                            bindFourComponentInputEvents(currentNode);
                        }, 200);
                    }
                }, 100);
            }
        });

        // 测试节点选择功能
        function testNodeSelection() {
            console.log('🧪 开始测试节点选择功能...');
            
            // 检查思维导图是否已初始化
            if (!mindmaps || Object.keys(mindmaps).length === 0) {
                console.log('❌ 思维导图未初始化');
                return;
            }
            
            // 获取第一个可用的思维导图
            const mapIds = Object.keys(mindmaps);
            for (const mapId of mapIds) {
                const mindmap = mindmaps[mapId];
                if (mindmap) {
                    console.log(`🔍 测试 ${mapId} 思维导图...`);
                    
                    // 获取思维导图数据
                    const mapData = mindmap.get_data();
                    if (mapData && mapData.data) {
                        // 获取根节点
                        const rootNode = mindmap.get_node(mapData.data.id);
                        if (rootNode) {
                            console.log(`🎯 测试选择根节点: ${rootNode.topic} (${rootNode.id})`);
                            handleNodeSelect(rootNode, mapId);
                            return;
                        }
                        
                        // 如果有子节点，选择第一个子节点
                        if (mapData.data.children && mapData.data.children.length > 0) {
                            const firstChild = mindmap.get_node(mapData.data.children[0].id);
                            if (firstChild) {
                                console.log(`🎯 测试选择子节点: ${firstChild.topic} (${firstChild.id})`);
                                handleNodeSelect(firstChild, mapId);
                                return;
                            }
                        }
                    }
                }
            }
            
            console.log('❌ 没有找到可测试的节点');
        }
        
        // 测试持久化存储功能
        function testPersistence() {
            console.log('🧪 开始测试持久化存储功能...');
            
            // 检查localStorage中的数据
            const keys = [
                STORAGE_KEYS.MINDMAP_DATA,
                STORAGE_KEYS.NODE_DATABASE,
                STORAGE_KEYS.FOUR_COMPONENT_DATA,
                STORAGE_KEYS.FOUR_COMPONENT_GLOBAL_STATE
            ];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        console.log(`✅ ${key}: ${Object.keys(parsed).length} 个键`);
                    } catch (e) {
                        console.log(`❌ ${key}: 解析失败`);
                    }
                } else {
                    console.log(`⚠️ ${key}: 无数据`);
                }
            });
            
            // 检查四组件节点数据
            if (fourComponentNodeState.nodeData) {
                const nodeCount = Object.keys(fourComponentNodeState.nodeData).length;
                console.log(`📝 四组件节点数据: ${nodeCount} 个节点`);
                
                Object.entries(fourComponentNodeState.nodeData).forEach(([nodeId, data]) => {
                    console.log(`  节点 ${nodeId}: "${data.title}" (${data.content ? data.content.length : 0} 字符)`);
                });
            }
            
            // 检查nodeDatabase
            if (nodeDatabase) {
                const dbNodeCount = Object.keys(nodeDatabase).length;
                console.log(`📂 nodeDatabase: ${dbNodeCount} 个节点`);
                
                Object.entries(nodeDatabase).forEach(([nodeId, data]) => {
                    console.log(`  节点 ${nodeId}: "${data.title}" (${data.content ? data.content.length : 0} 字符)`);
                });
            }
            
            // 立即保存测试
            console.log('💾 执行立即保存测试...');
            const saveResult = autoSaveData();
            console.log(`💾 保存结果: ${saveResult ? '成功' : '失败'}`);
            
            console.log('✅ 持久化存储测试完成');
        }
        
        // 诊断持久化存储问题
        function diagnosePersistence() {
            console.log('🔍 开始诊断持久化存储问题...');
            
            // 1. 检查当前选中的节点
            console.log(`📍 当前选中节点: ${selectedNodeId || '无'}`);
            console.log(`📍 四组件当前节点: ${fourComponentNodeState.currentNode || '无'}`);
            
            // 2. 检查UI元素
            const contentEditor = document.getElementById('content-editor');
            
            console.log(`🔍 内容编辑器: ${contentEditor ? '存在' : '不存在'}`);
            
            if (contentEditor) {
                console.log(`📝 当前内容值: "${contentEditor.value.substring(0, 100)}..." (${contentEditor.value.length} 字符)`);
            }
            
            // 3. 检查数据存储
            const currentNodeId = selectedNodeId || fourComponentNodeState.currentNode;
            if (currentNodeId) {
                console.log(`🔍 检查节点 ${currentNodeId} 的数据:`);
                
                // 检查nodeDatabase
                const nodeData = nodeDatabase[currentNodeId];
                if (nodeData) {
                    console.log(`  📂 nodeDatabase: "${nodeData.title}" (${nodeData.content ? nodeData.content.length : 0} 字符)`);
                    console.log(`  📝 内容预览: "${(nodeData.content || '').substring(0, 100)}..."`);
                } else {
                    console.log(`  ❌ nodeDatabase 中没有该节点数据`);
                }
                
                // 检查四组件数据
                const fourComponentData = fourComponentNodeState.nodeData[currentNodeId];
                if (fourComponentData) {
                    console.log(`  📂 四组件数据: "${fourComponentData.title}" (${fourComponentData.content ? fourComponentData.content.length : 0} 字符)`);
                    console.log(`  📝 内容预览: "${(fourComponentData.content || '').substring(0, 100)}..."`);
                } else {
                    console.log(`  ❌ 四组件数据中没有该节点`);
                }
                
                // 检查localStorage
                const savedData = localStorage.getItem(STORAGE_KEYS.FOUR_COMPONENT_DATA);
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        const savedNodeData = parsed.nodeData?.[currentNodeId];
                        if (savedNodeData) {
                            console.log(`  💾 localStorage: "${savedNodeData.title}" (${savedNodeData.content ? savedNodeData.content.length : 0} 字符)`);
                        } else {
                            console.log(`  ❌ localStorage 中没有该节点数据`);
                        }
                    } catch (e) {
                        console.log(`  ❌ localStorage 数据解析失败`);
                    }
                } else {
                    console.log(`  ❌ localStorage 中没有四组件数据`);
                }
            }
            
            // 4. 测试保存功能
            console.log('🧪 测试保存功能...');
            if (currentNodeId && contentEditor) {
                const testContent = contentEditor.value + '\n[测试保存]';
                console.log(`📝 添加测试内容: ${testContent.length} 字符`);
                
                updateFourComponentNodeContent(currentNodeId, testContent);
                saveFourComponentData();
                autoSaveData();
                
                console.log('✅ 测试保存完成，请检查内容是否保存');
            }
            
            console.log('🔍 持久化存储诊断完成');
        }
        
        // 强制同步数据
        function forceSyncData() {
            console.log('🔄 开始强制同步数据...');
            
            const currentNodeId = selectedNodeId || fourComponentNodeState.currentNode;
            if (!currentNodeId) {
                console.log('❌ 没有当前节点，无法同步');
                return;
            }
            
            const titleInput = document.getElementById('title-input');
            const contentEditor = document.getElementById('content-editor');
            
            if (titleInput && contentEditor) {
                const title = titleInput.value;
                const content = contentEditor.value;
                
                console.log(`🔄 同步节点 ${currentNodeId}: "${title}" (${content.length} 字符)`);
                
                // 强制更新所有数据存储
                updateFourComponentNodeTitle(currentNodeId, title);
                updateFourComponentNodeContent(currentNodeId, content);
                
                // 立即保存
                saveFourComponentData();
                autoSaveData();
                
                console.log('✅ 强制同步完成');
            } else {
                console.log('❌ 找不到输入元素，无法同步');
            }
        }
        
        // 导出测试函数到全局
        window.testNodeSelection = testNodeSelection;
        window.testPersistence = testPersistence;
        window.diagnosePersistence = diagnosePersistence;
        window.forceSyncData = forceSyncData;
        
        // 导出四组件函数到全局
        window.onQAModeChange = onQAModeChange;
        window.fourComponentUpdateTitle = fourComponentUpdateTitle;
        window.fourComponentCopyContent = fourComponentCopyContent;
        // 四组件模板操作函数
        function fourComponentUseTemplate(templateId) {
            if (window.templateSelectionService) {
                const template = window.templateSelectionService.getSelectedTemplates().find(t => t.id === templateId || t.name === templateId);
                if (template) {
                    fourComponentGlobalState.useTemplate(template.name || template.title);
                }
            } else {
                fourComponentGlobalState.useTemplate(templateId);
            }
        }
        
        function fourComponentRemoveTemplate(templateId) {
            if (window.templateSelectionService) {
                window.templateSelectionService.removeTemplate(templateId);
                // 刷新显示
                fourComponentGlobalState.renderTemplates();
            } else {
                fourComponentGlobalState.removeTemplate(templateId);
            }
        }
        
        // 监听模板选择服务的事件
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.templateSelectionService) {
                    // 监听模板更新事件
                    window.templateSelectionService.on('templates:updated', () => {
                        console.log('📋 模板更新事件触发，刷新四组件显示');
                        fourComponentGlobalState.renderTemplates();
                    });
                }
            }, 1000);
        });

        window.fourComponentPasteContent = fourComponentPasteContent;
        window.fourComponentSubmitContent = fourComponentSubmitContent;
        window.fourComponentToggleTag = fourComponentToggleTag;
        window.fourComponentAddNewSession = fourComponentAddNewSession;
        window.fourComponentUseTemplate = fourComponentUseTemplate;
        window.fourComponentRemoveTemplate = fourComponentRemoveTemplate;
        window.fourComponentViewAllSessions = fourComponentViewAllSessions;
        window.fourComponentClearSessions = fourComponentClearSessions;
        window.fourComponentSelectSession = fourComponentSelectSession;
        window.openFourComponentTemplateManager = openFourComponentTemplateManager;
        window.fourComponentGlobalState = fourComponentGlobalState;
        window.fourComponentNodeState = fourComponentNodeState;
        window.initializeFourComponents = initializeFourComponents;
        window.updateFourComponentsForNode = updateFourComponentsForNode;
        window.bindFourComponentInputEvents = bindFourComponentInputEvents;
        window.updateFourComponentNodeTitle = updateFourComponentNodeTitle;
        window.updateFourComponentNodeContent = updateFourComponentNodeContent;
        window.toggleFourComponentTag = toggleFourComponentTag;
        window.addFourComponentTagToNode = addFourComponentTagToNode;
        window.removeFourComponentTagFromNode = removeFourComponentTagFromNode;
        window.restoreFourComponentTagStates = restoreFourComponentTagStates;
        window.saveFourComponentData = saveFourComponentData;
        window.loadFourComponentData = loadFourComponentData;
        window.clearFourComponentData = clearFourComponentData;
        window.restoreFourComponentGlobalState = restoreFourComponentGlobalState;
        
        // MD直存功能
        let mdDirectService = null;
        
        async function initMDDirectService() {
            if (!mdDirectService) {
                try {
                    // 动态导入MD直存服务
                    const { getMDDirectService } = await import('./src/services/md_direct_service.js');
                    mdDirectService = getMDDirectService();
                    console.log('✅ MD直存服务初始化成功');
                } catch (error) {
                    console.error('❌ MD直存服务初始化失败:', error);
                    // 使用模拟服务作为备用
                    mdDirectService = createMockMDDirectService();
                }
            }
            return mdDirectService;
        }
        
        function createMockMDDirectService() {
            return {
                async addMDContent(content, options = {}) {
                    console.log('🔧 模拟MD直存服务处理:', { content: content.substring(0, 50), options });
                    
                    // 解析MD内容
                    const lines = content.split('\n');
                    const title = lines[0].replace(/^#+\s*/, '') || '未命名';
                    const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                    
                    // 如果指定了nodeId且要求更新现有节点
                    if (options.nodeId && options.updateExisting) {
                        console.log(`🔄 更新现有节点: ${options.nodeId}`);
                        
                        // 更新nodeDatabase
                        if (window.nodeDatabase && window.nodeDatabase[options.nodeId]) {
                            window.nodeDatabase[options.nodeId].title = title;
                            window.nodeDatabase[options.nodeId].content = actualContent;
                            window.nodeDatabase[options.nodeId].modified = new Date().toISOString();
                            console.log(`✅ 更新nodeDatabase: ${options.nodeId}`);
                        }
                        
                        // 更新四组件数据
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData[options.nodeId]) {
                                window.fourComponentNodeState.nodeData[options.nodeId] = {};
                            }
                            window.fourComponentNodeState.nodeData[options.nodeId].title = title;
                            window.fourComponentNodeState.nodeData[options.nodeId].content = actualContent;
                            window.fourComponentNodeState.nodeData[options.nodeId].modified = new Date().toISOString();
                            
                            if (window.saveFourComponentData) {
                                window.saveFourComponentData();
                            }
                            console.log(`✅ 更新四组件数据: ${options.nodeId}`);
                        }
                        
                        // 自动保存
                        if (window.autoSaveData) {
                            window.autoSaveData();
                        }
                        
                        return {
                            success: true,
                            id: options.nodeId,
                            data: { title, content: actualContent },
                            message: `节点 ${options.nodeId} 已通过MD直存更新`
                        };
                    } else {
                        // 创建新节点
                        const nodeId = options.nodeId || 'md_' + Date.now();
                        const nodeData = {
                            id: nodeId,
                            title: title,
                            content: actualContent,
                            tags: [],
                            created: new Date().toISOString(),
                            modified: new Date().toISOString()
                        };
                        
                        // 添加到nodeDatabase
                        if (window.nodeDatabase) {
                            window.nodeDatabase[nodeId] = nodeData;
                        }
                        
                        // 添加到四组件数据
                        if (window.fourComponentNodeState) {
                            if (!window.fourComponentNodeState.nodeData) {
                                window.fourComponentNodeState.nodeData = {};
                            }
                            window.fourComponentNodeState.nodeData[nodeId] = nodeData;
                            
                            if (window.saveFourComponentData) {
                                window.saveFourComponentData();
                            }
                        }
                        
                        // 自动保存
                        if (window.autoSaveData) {
                            window.autoSaveData();
                        }
                        
                        return {
                            success: true,
                            id: nodeId,
                            data: nodeData,
                            message: 'MD内容已成功存储到NodeMind'
                        };
                    }
                },
                
                previewMDParsing(content) {
                    const lines = content.split('\n');
                    const title = lines[0].replace(/^#+\s*/, '') || '未命名';
                    const actualContent = lines.slice(1).filter(line => line.trim() !== '').join('\n').trim();
                    
                    let type = 'note';
                    if (content.includes('任务') || content.includes('实现') || content.includes('开发')) {
                        type = 'task';
                    } else if (content.includes('模板') || content.includes('格式')) {
                        type = 'template';
                    }
                    
                    return {
                        success: true,
                        preview: {
                            title,
                            content: actualContent,
                            type,
                            estimatedSize: content.length
                        }
                    };
                }
            };
        }
        
        async function openMDDirectPanel() {
            await initMDDirectService();
            document.getElementById('md-direct-panel').style.display = 'flex';
        }
        
        function closeMDDirectPanel() {
            document.getElementById('md-direct-panel').style.display = 'none';
        }
        
        async function previewMDContent() {
            const content = document.getElementById('md-input').value;
            if (!content.trim()) {
                alert('请输入MD内容');
                return;
            }
            
            const service = await initMDDirectService();
            const result = service.previewMDParsing(content);
            
            document.getElementById('md-result').innerHTML = `
                <h4>📋 解析预览</h4>
                <div class="preview-item"><strong>标题:</strong> ${result.preview.title}</div>
                <div class="preview-item"><strong>类型:</strong> ${result.preview.type}</div>
                <div class="preview-item"><strong>内容长度:</strong> ${result.preview.estimatedSize} 字符</div>
                <div class="preview-content">
                    <strong>内容预览:</strong>
                    <pre>${result.preview.content.substring(0, 200)}${result.preview.content.length > 200 ? '...' : ''}</pre>
                </div>
            `;
        }
        
        async function storeMDContent() {
            const content = document.getElementById('md-input').value;
            if (!content.trim()) {
                alert('请输入MD内容');
                return;
            }
            
            try {
                const service = await initMDDirectService();
                const result = await service.addMDContent(content);
                
                if (result.success) {
                    document.getElementById('md-result').innerHTML = `
                        <h4>✅ 存储成功</h4>
                        <div class="success-item"><strong>节点ID:</strong> ${result.id}</div>
                        <div class="success-item"><strong>标题:</strong> ${result.data.title}</div>
                        <div class="success-item"><strong>状态:</strong> ${result.message}</div>
                        <div class="success-note">
                            💡 内容已成功添加到NodeMind，所有联动机制正常工作！
                        </div>
                    `;
                    
                    // 清空输入
                    document.getElementById('md-input').value = '';
                    
                    // 刷新界面
                    if (window.refreshMindmapDisplay) {
                        window.refreshMindmapDisplay();
                    }
                } else {
                    throw new Error(result.error || '存储失败');
                }
            } catch (error) {
                document.getElementById('md-result').innerHTML = `
                    <h4>❌ 存储失败</h4>
                    <div class="error-message">${error.message}</div>
                `;
            }
        }
        
        function clearMDPanel() {
            document.getElementById('md-input').value = '';
            document.getElementById('md-result').innerHTML = '';
        }
        
        // 暴露MD直存函数到全局
        window.openMDDirectPanel = openMDDirectPanel;
        window.closeMDDirectPanel = closeMDDirectPanel;
        window.previewMDContent = previewMDContent;
        window.storeMDContent = storeMDContent;
        window.clearMDPanel = clearMDPanel;
    </script>

    <!-- MD直存面板 -->
    <div id="md-direct-panel" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 99999;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
    ">
        <div style="
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            height: 80%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        ">
            <!-- 头部 -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div>
                    <h2 style="margin: 0; font-size: 24px;">📝 MD直存集成</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">直接输入MD格式内容，智能解析并存储到NodeMind</p>
                </div>
                <button onclick="closeMDDirectPanel()" style="
                    background: none;
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 5px;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">✕</button>
            </div>
            
            <!-- 内容区 -->
            <div style="
                flex: 1;
                display: flex;
                gap: 20px;
                padding: 20px;
                overflow: hidden;
            ">
                <!-- 左侧输入区 -->
                <div style="
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                ">
                    <div>
                        <label style="
                            display: block;
                            font-weight: 600;
                            color: #495057;
                            margin-bottom: 8px;
                        ">📝 MD内容输入</label>
                        <textarea id="md-input" style="
                            width: 100%;
                            height: 300px;
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            padding: 15px;
                            font-family: 'Consolas', 'Monaco', monospace;
                            font-size: 14px;
                            line-height: 1.6;
                            resize: none;
                            box-sizing: border-box;
                        " placeholder="输入MD格式内容...

示例1 - 任务：
# 实现用户认证功能
使用JWT进行身份验证，包括登录、注册和权限验证。
**负责人**: 我
**时间**: 本周完成

示例2 - 笔记：
# 关于架构设计的思考
模块化设计确实能够有效降低系统耦合度，提高代码可维护性。

示例3 - 模板：
# 会议记录模板
**时间**：
**参与者**：
**议题**：
**决议**："></textarea>
                    </div>
                    
                    <div style="
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                    ">
                        <button onclick="previewMDContent()" style="
                            background: #17a2b8;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 500;
                        ">🔍 预览解析</button>
                        <button onclick="storeMDContent()" style="
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 500;
                        ">💾 直接存储</button>
                        <button onclick="clearMDPanel()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 500;
                        ">🗑️ 清空</button>
                    </div>
                </div>
                
                <!-- 右侧结果区 -->
                <div style="
                    flex: 1;
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 20px;
                    overflow-y: auto;
                ">
                    <h4 style="
                        margin: 0 0 15px 0;
                        color: #495057;
                    ">📊 解析结果</h4>
                    <div id="md-result" style="
                        color: #6c757d;
                        font-size: 14px;
                        line-height: 1.6;
                    ">
                        等待输入MD内容进行解析...
                        
                        <div style="margin-top: 20px;">
                            <h5>✨ 功能特性：</h5>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>🎯 智能类型推断（任务/笔记/模板/标签）</li>
                                <li>🔮 隐性六要素提取</li>
                                <li>🔄 完全兼容现有UI</li>
                                <li>⚡ 联动机制保持</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 