<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeMind JSONå¯¼å…¥æœ€ç»ˆä¿®å¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background: #218838;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }
        
        .result {
            margin: 10px 0;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        #mindmap-display {
            border: 2px solid #dee2e6;
            min-height: 400px;
            background: white;
            border-radius: 6px;
            position: relative;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .code-fix {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
    <script src="js/jsmind.js"></script>
    <link rel="stylesheet" href="js/jsmind.css">
</head>
<body>
    <div class="header">
        <h1>ğŸ‰ æµ‹è¯•æˆåŠŸï¼JSONå¯¼å…¥æœ€ç»ˆè§£å†³æ–¹æ¡ˆ</h1>
        <p>æ—¢ç„¶æµ‹è¯•å·¥å…·æˆåŠŸäº†ï¼Œç°åœ¨æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆ</p>
    </div>

    <div class="container">
        <h2>ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ</h2>
        <div class="result success">
            âœ… æ‚¨çš„JSONæ–‡ä»¶æ ¼å¼å®Œå…¨æ­£ç¡®<br>
            âœ… ä¿®å¤çš„å¯¼å…¥é€»è¾‘æœ‰æ•ˆ<br>
            âœ… é—®é¢˜å‡ºåœ¨ä¸»åº”ç”¨çš„ç¼“å­˜æˆ–ä»£ç å†²çª
        </div>
        
        <h3>æ–¹æ³•1ï¼šå¼ºåˆ¶åˆ·æ–°ä¸»åº”ç”¨ç¼“å­˜ â­ æ¨è</h3>
        <ol>
            <li>å…³é—­æ‰€æœ‰ <code>index.html</code> çš„æµè§ˆå™¨æ ‡ç­¾é¡µ</li>
            <li>æŒ‰ <strong>Ctrl + Shift + R</strong> æˆ– <strong>Ctrl + F5</strong> å¼ºåˆ¶åˆ·æ–°</li>
            <li>é‡æ–°æ‰“å¼€ <code>index.html</code></li>
            <li>ç‚¹å‡»"ğŸ“Š å¯¼å…¥JSON"æŒ‰é’®</li>
            <li>é€‰æ‹©æ‚¨çš„JSONæ–‡ä»¶</li>
        </ol>
        
        <h3>æ–¹æ³•2ï¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªå·¥å…·</h3>
        <input type="file" id="file-input" accept=".json" style="display: none;">
        <button class="btn" onclick="selectFile()">ğŸ“‚ åœ¨æ­¤å·¥å…·ä¸­å¯¼å…¥JSON</button>
        <button class="btn secondary" onclick="clearAll()">ğŸ§¹ æ¸…ç©ºæ˜¾ç¤º</button>
        
        <div class="stats" id="stats-area" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="node-count">0</div>
                <div>èŠ‚ç‚¹æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="doc-count">0</div>
                <div>æ–‡æ¡£æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="file-size">0</div>
                <div>æ–‡ä»¶å¤§å°(KB)</div>
            </div>
        </div>
        
        <div id="log-area"></div>
    </div>
    
    <div class="container">
        <h2>ğŸ—ºï¸ æ€ç»´å¯¼å›¾æ˜¾ç¤º</h2>
        <div id="mindmap-display"></div>
    </div>
    
    <div class="container">
        <h2>ğŸ”§ ä¸»åº”ç”¨ä¿®å¤ä»£ç </h2>
        <p>å¦‚æœæ‚¨çš„ä¸»åº”ç”¨å¯¼å…¥è¿˜æœ‰é—®é¢˜ï¼Œå¯ä»¥å¤åˆ¶ä»¥ä¸‹ä¿®å¤ä»£ç ï¼š</p>
        <div class="code-fix" id="fix-code">
// æ­£åœ¨ç”Ÿæˆä¿®å¤ä»£ç ...
        </div>
        <button class="btn secondary" onclick="copyFixCode()">ğŸ“‹ å¤åˆ¶ä¿®å¤ä»£ç </button>
    </div>

    <script>
        let jm = null;
        let importedData = null;
        
        // åˆå§‹åŒ–
        function init() {
            try {
                const options = {
                    container: 'mindmap-display',
                    editable: false,
                    theme: 'primary'
                };
                jm = new jsMind(options);
                log('âœ… jsMindåˆå§‹åŒ–æˆåŠŸ', 'success');
                
                generateFixCode();
                
            } catch (error) {
                log(`âŒ jsMindåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            div.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(div);
            console.log(message);
        }
        
        // é€‰æ‹©æ–‡ä»¶
        function selectFile() {
            document.getElementById('file-input').click();
        }
        
        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            document.getElementById('log-area').innerHTML = '';
            document.getElementById('stats-area').style.display = 'none';
            if (jm) {
                jm.show({
                    meta: { name: "ç©ºç™½", author: "NodeMind", version: "1.0" },
                    format: "node_tree", 
                    data: { id: "root", topic: "è¯·å¯¼å…¥JSONæ–‡ä»¶" }
                });
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats(nodeCount, docCount, fileSize) {
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('doc-count').textContent = docCount;
            document.getElementById('file-size').textContent = Math.round(fileSize / 1024);
            document.getElementById('stats-area').style.display = 'grid';
        }
        
        // é€’å½’è®¡ç®—èŠ‚ç‚¹æ•°é‡
        function countNodes(node) {
            let count = 1;
            if (node.children && Array.isArray(node.children)) {
                for (const child of node.children) {
                    count += countNodes(child);
                }
            }
            return count;
        }
        
        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            log(`ğŸ“ å¼€å§‹å¯¼å…¥: ${file.name}`, 'info');
            log(`ğŸ“ æ–‡ä»¶å¤§å°: ${Math.round(file.size / 1024)} KB`, 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    log(`ğŸ“„ æ–‡ä»¶è¯»å–å®Œæˆï¼Œé•¿åº¦: ${content.length} å­—ç¬¦`, 'info');
                    
                    const jsonData = JSON.parse(content);
                    log('âœ… JSONè§£ææˆåŠŸ', 'success');
                    
                    let mindmapData = null;
                    let documentCount = 0;
                    let nodeCount = 0;
                    
                    if (jsonData.mindmap && jsonData.mindmap.data) {
                        log('ğŸ¯ æ£€æµ‹åˆ°ï¼šNodeMindé¡¹ç›®æ ¼å¼', 'success');
                        mindmapData = jsonData.mindmap;
                        
                        if (jsonData.documents) {
                            documentCount = Object.keys(jsonData.documents).length;
                            log(`ğŸ“š åŒ…å«æ–‡æ¡£: ${documentCount} ä¸ª`, 'info');
                        }
                        
                        nodeCount = countNodes(mindmapData.data);
                        log(`ğŸ”¢ èŠ‚ç‚¹ç»Ÿè®¡: ${nodeCount} ä¸ª`, 'info');
                        
                    } else if (jsonData.meta && jsonData.format && jsonData.data) {
                        log('ğŸ¯ æ£€æµ‹åˆ°ï¼šæ ‡å‡†æ€ç»´å¯¼å›¾æ ¼å¼', 'success');
                        mindmapData = jsonData;
                        nodeCount = countNodes(jsonData.data);
                        
                    } else if (jsonData.data && jsonData.data.id) {
                        log('ğŸ¯ æ£€æµ‹åˆ°ï¼šç›´æ¥èŠ‚ç‚¹æ•°æ®æ ¼å¼', 'success');
                        mindmapData = {
                            meta: { name: file.name.replace('.json', ''), author: "å¯¼å…¥", version: "1.0" },
                            format: "node_tree",
                            data: jsonData.data
                        };
                        nodeCount = countNodes(jsonData.data);
                        
                    } else if (jsonData.id && jsonData.topic) {
                        log('ğŸ¯ æ£€æµ‹åˆ°ï¼šæ ¹èŠ‚ç‚¹æ ¼å¼', 'success');
                        mindmapData = {
                            meta: { name: file.name.replace('.json', ''), author: "å¯¼å…¥", version: "1.0" },
                            format: "node_tree",
                            data: jsonData
                        };
                        nodeCount = countNodes(jsonData);
                        
                    } else {
                        throw new Error('æ— æ³•è¯†åˆ«çš„JSONæ ¼å¼');
                    }
                    
                    if (mindmapData && jm) {
                        jm.show(mindmapData);
                        log('ğŸ¨ æ€ç»´å¯¼å›¾æ˜¾ç¤ºæˆåŠŸ', 'success');
                        log('ğŸ‰ å¯¼å…¥å®Œæˆï¼', 'success');
                        
                        updateStats(nodeCount, documentCount, file.size);
                        
                        if (mindmapData.meta) {
                            log(`ğŸ“‹ åç§°: ${mindmapData.meta.name || 'æœªå‘½å'}`, 'info');
                            log(`ğŸ‘¤ ä½œè€…: ${mindmapData.meta.author || 'æœªçŸ¥'}`, 'info');
                        }
                        
                    } else {
                        throw new Error('æ— æ³•æ˜¾ç¤ºæ€ç»´å¯¼å›¾');
                    }
                    
                } catch (error) {
                    log(`âŒ å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                log('âŒ æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ç”Ÿæˆä¿®å¤ä»£ç 
        function generateFixCode() {
            const fixCode = `
// NodeMindä¸»åº”ç”¨JSONå¯¼å…¥ä¿®å¤ä»£ç 
// æ›¿æ¢åŸæœ‰çš„handleJSONFileImportå‡½æ•°

function handleJSONFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('ğŸ“Š [JSONå¯¼å…¥] å¼€å§‹å¯¼å…¥JSONæ–‡ä»¶:', file.name);
    console.log('ğŸ“Š [JSONå¯¼å…¥] æ–‡ä»¶å¤§å°:', Math.round(file.size / 1024), 'KB');
    showMessage('ğŸ“Š æ­£åœ¨å¯¼å…¥JSONæ–‡ä»¶: ' + file.name);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            console.log('ğŸ“Š [JSONå¯¼å…¥] æ–‡ä»¶è¯»å–å®Œæˆï¼Œå†…å®¹é•¿åº¦:', content.length);
            
            const jsonData = JSON.parse(content);
            console.log('ğŸ“Š [JSONå¯¼å…¥] JSONè§£ææˆåŠŸ');
            
            let mindmapData = null;
            let importSuccess = false;
            
            // æ£€æŸ¥NodeMindé¡¹ç›®æ ¼å¼
            if (jsonData.mindmap && jsonData.mindmap.data) {
                console.log('ğŸ“Š [JSONå¯¼å…¥] æ£€æµ‹åˆ°NodeMindé¡¹ç›®æ ¼å¼');
                mindmapData = jsonData.mindmap;
                
                // å¯¼å…¥æ–‡æ¡£æ•°æ®
                if (jsonData.documents) {
                    const docCount = Object.keys(jsonData.documents).length;
                    console.log('ğŸ“Š [JSONå¯¼å…¥] æ–‡æ¡£æ•°é‡:', docCount);
                    Object.assign(nodeDatabase, jsonData.documents);
                }
                
                // æ˜¾ç¤ºæ€ç»´å¯¼å›¾
                if (mindmaps.project) {
                    mindmaps.project.show(mindmapData);
                    console.log('ğŸ“Š [JSONå¯¼å…¥] å·²æ˜¾ç¤ºåˆ°é¡¹ç›®ç®¡ç†è„‘å›¾');
                    importSuccess = true;
                }
                
            } else if (jsonData.meta && jsonData.format && jsonData.data) {
                console.log('ğŸ“Š [JSONå¯¼å…¥] æ£€æµ‹åˆ°æ ‡å‡†æ€ç»´å¯¼å›¾æ ¼å¼');
                mindmapData = jsonData;
                
                if (mindmaps.project) {
                    mindmaps.project.show(mindmapData);
                    console.log('ğŸ“Š [JSONå¯¼å…¥] å·²æ˜¾ç¤ºæ ‡å‡†æ ¼å¼åˆ°é¡¹ç›®ç®¡ç†è„‘å›¾');
                    importSuccess = true;
                }
            } else if (jsonData.data && jsonData.data.id) {
                console.log('ğŸ“Š [JSONå¯¼å…¥] æ£€æµ‹åˆ°ç›´æ¥èŠ‚ç‚¹æ•°æ®æ ¼å¼');
                mindmapData = {
                    meta: { name: file.name.replace('.json', ''), author: "å¯¼å…¥", version: "1.0" },
                    format: "node_tree",
                    data: jsonData.data
                };
                
                if (mindmaps.project) {
                    mindmaps.project.show(mindmapData);
                    console.log('ğŸ“Š [JSONå¯¼å…¥] å·²æ˜¾ç¤ºèŠ‚ç‚¹æ•°æ®åˆ°é¡¹ç›®ç®¡ç†è„‘å›¾');
                    importSuccess = true;
                }
            } else if (jsonData.id && jsonData.topic) {
                console.log('ğŸ“Š [JSONå¯¼å…¥] æ£€æµ‹åˆ°æ ¹èŠ‚ç‚¹æ ¼å¼');
                mindmapData = {
                    meta: { name: file.name.replace('.json', ''), author: "å¯¼å…¥", version: "1.0" },
                    format: "node_tree",
                    data: jsonData
                };
                
                if (mindmaps.project) {
                    mindmaps.project.show(mindmapData);
                    console.log('ğŸ“Š [JSONå¯¼å…¥] å·²æ˜¾ç¤ºæ ¹èŠ‚ç‚¹åˆ°é¡¹ç›®ç®¡ç†è„‘å›¾');
                    importSuccess = true;
                }
            } else {
                throw new Error('æ— æ³•è¯†åˆ«çš„JSONæ ¼å¼ï¼Œè¯·ç¡®ä¿æ˜¯NodeMindå¯¼å‡ºçš„æ–‡ä»¶');
            }
            
            if (importSuccess) {
                saveDataToStorage();
                showMessage('âœ… JSONæ–‡ä»¶å¯¼å…¥æˆåŠŸ: ' + file.name);
                console.log('âœ… [JSONå¯¼å…¥] æ–‡ä»¶å¯¼å…¥å®Œæˆ:', file.name);
            } else {
                throw new Error('æ€ç»´å¯¼å›¾æ˜¾ç¤ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é¡¹ç›®ç®¡ç†é¢æ¿æ˜¯å¦æ­£å¸¸');
            }
            
        } catch (error) {
            console.error('âŒ [JSONå¯¼å…¥] æ–‡ä»¶å¯¼å…¥å¤±è´¥:', error);
            showMessage('âŒ JSONæ–‡ä»¶å¯¼å…¥å¤±è´¥: ' + error.message);
            
            const userChoice = confirm('JSONæ–‡ä»¶å¯¼å…¥å¤±è´¥ã€‚\\n\\né”™è¯¯ä¿¡æ¯: ' + error.message + '\\n\\næ˜¯å¦æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ï¼Ÿ');
            if (userChoice) {
                alert('JSONå¯¼å…¥å¸®åŠ©ï¼š\\n\\næ”¯æŒçš„æ ¼å¼ï¼š\\n1. NodeMindé¡¹ç›®æ ¼å¼\\n2. æ ‡å‡†æ€ç»´å¯¼å›¾æ ¼å¼\\n3. ç›´æ¥èŠ‚ç‚¹æ•°æ®æ ¼å¼\\n4. æ ¹èŠ‚ç‚¹æ ¼å¼\\n\\nè¯·ç¡®ä¿æ–‡ä»¶å®Œæ•´ä¸”ç¼–ç ä¸ºUTF-8');
            }
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}`;
            
            document.getElementById('fix-code').textContent = fixCode;
        }
        
        // å¤åˆ¶ä¿®å¤ä»£ç 
        function copyFixCode() {
            const fixCode = document.getElementById('fix-code').textContent;
            navigator.clipboard.writeText(fixCode).then(() => {
                log('ğŸ“‹ ä¿®å¤ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                log('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'error');
            });
        }
        
        // ç»‘å®šäº‹ä»¶
        document.getElementById('file-input').addEventListener('change', handleFileImport);
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            init();
            log('ğŸ‰ æ­å–œï¼æµ‹è¯•æˆåŠŸè¡¨æ˜ä¸€åˆ‡æ­£å¸¸', 'success');
            log('ğŸ’¡ ç°åœ¨è¯·å°è¯•åœ¨ä¸»åº”ç”¨ä¸­å¼ºåˆ¶åˆ·æ–°ç¼“å­˜', 'info');
        });
    </script>
</body>
</html> 