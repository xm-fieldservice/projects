{"version":3,"file":"jsmind.screenshot.js","sources":["../src/plugins/jsmind.screenshot.js"],"sourcesContent":["/**\n * @license BSD\n * @copyright 2014-2025 hizzgdev@163.com\n *\n * Project Home:\n *   https://github.com/hizzgdev/jsmind/\n */\n\nimport jsMind from 'jsmind';\nimport domtoimage from 'dom-to-image';\n\nif (!jsMind) {\n    throw new Error('jsMind is not defined');\n}\n\nif (!domtoimage) {\n    throw new Error('dom-to-image is required');\n}\n\nconst $ = jsMind.$;\n\nconst DEFAULT_OPTIONS = {\n    filename: null,\n    watermark: {\n        left: $.w.location,\n        right: 'https://github.com/hizzgdev/jsmind',\n    },\n    background: 'transparent',\n};\n\nclass JmScreenshot {\n    constructor(jm, options) {\n        var opts = {};\n        jsMind.util.json.merge(opts, DEFAULT_OPTIONS);\n        jsMind.util.json.merge(opts, options);\n\n        this.version = '0.2.0';\n        this.jm = jm;\n        this.options = opts;\n        this.dpr = jm.view.device_pixel_ratio;\n    }\n\n    shoot() {\n        let c = this.create_canvas();\n        let ctx = c.getContext('2d');\n        ctx.scale(this.dpr, this.dpr);\n        Promise.resolve(ctx)\n            .then(() => this.draw_background(ctx))\n            .then(() => this.draw_lines(ctx))\n            .then(() => this.draw_nodes(ctx))\n            .then(() => this.draw_watermark(c, ctx))\n            .then(() => this.download(c))\n            .then(() => this.clear(c));\n    }\n\n    create_canvas() {\n        let c = $.c('canvas');\n        const w = this.jm.view.size.w;\n        const h = this.jm.view.size.h;\n        c.width = w * this.dpr;\n        c.height = h * this.dpr;\n        c.style.width = w + 'px';\n        c.style.height = h + 'px';\n\n        c.style.visibility = 'hidden';\n        this.jm.view.e_panel.appendChild(c);\n        return c;\n    }\n\n    clear(c) {\n        c.parentNode.removeChild(c);\n    }\n\n    draw_background(ctx) {\n        return new Promise(\n            function (resolve, _) {\n                const bg = this.options.background;\n                if (!!bg && bg !== 'transparent') {\n                    ctx.fillStyle = this.options.background;\n                    ctx.fillRect(0, 0, this.jm.view.size.w, this.jm.view.size.h);\n                }\n                resolve(ctx);\n            }.bind(this)\n        );\n    }\n\n    draw_lines(ctx) {\n        return new Promise(\n            function (resolve, _) {\n                this.jm.view.graph.copy_to(ctx, function () {\n                    resolve(ctx);\n                });\n            }.bind(this)\n        );\n    }\n\n    draw_nodes(ctx) {\n        return domtoimage\n            .toSvg(this.jm.view.e_nodes, { style: { zoom: 1 } })\n            .then(this.load_image)\n            .then(function (img) {\n                ctx.drawImage(img, 0, 0);\n                return ctx;\n            });\n    }\n\n    draw_watermark(c, ctx) {\n        ctx.textBaseline = 'bottom';\n        ctx.fillStyle = '#000';\n        ctx.font = '11px Verdana,Arial,Helvetica,sans-serif';\n        if (!!this.options.watermark.left) {\n            ctx.textAlign = 'left';\n            ctx.fillText(this.options.watermark.left, 5.5, c.height - 2.5);\n        }\n        if (!!this.options.watermark.right) {\n            ctx.textAlign = 'right';\n            ctx.fillText(this.options.watermark.right, c.width - 5.5, c.height - 2.5);\n        }\n        return ctx;\n    }\n\n    load_image(url) {\n        return new Promise(function (resolve, reject) {\n            let img = new Image();\n            img.onload = function () {\n                resolve(img);\n            };\n            img.onerror = reject;\n            img.src = url;\n        });\n    }\n\n    download(c) {\n        var name = (this.options.filename || this.jm.mind.name) + '.png';\n\n        if (navigator.msSaveBlob && !!c.msToBlob) {\n            var blob = c.msToBlob();\n            navigator.msSaveBlob(blob, name);\n        } else {\n            var blob_url = c.toDataURL();\n            var anchor = $.c('a');\n            if ('download' in anchor) {\n                anchor.style.visibility = 'hidden';\n                anchor.href = blob_url;\n                anchor.download = name;\n                $.d.body.appendChild(anchor);\n                var evt = $.d.createEvent('MouseEvents');\n                evt.initEvent('click', true, true);\n                anchor.dispatchEvent(evt);\n                $.d.body.removeChild(anchor);\n            } else {\n                location.href = blob_url;\n            }\n        }\n    }\n}\n\nlet screenshot_plugin = new jsMind.plugin('screenshot', function (jm, options) {\n    var jmss = new JmScreenshot(jm, options);\n    jm.screenshot = jmss;\n    jm.shoot = function () {\n        jmss.shoot();\n    };\n});\n\njsMind.register_plugin(screenshot_plugin);\n"],"names":["jsMind","Error","domtoimage","$","DEFAULT_OPTIONS","filename","watermark","left","w","location","right","background","JmScreenshot","constructor","jm","options","opts","util","json","merge","this","version","dpr","view","device_pixel_ratio","shoot","c","create_canvas","ctx","getContext","scale","Promise","resolve","then","draw_background","draw_lines","draw_nodes","draw_watermark","download","clear","size","h","width","height","style","visibility","e_panel","appendChild","parentNode","removeChild","_","bg","fillStyle","fillRect","bind","graph","copy_to","toSvg","e_nodes","zoom","load_image","img","drawImage","textBaseline","font","textAlign","fillText","url","reject","Image","onload","onerror","src","name","mind","navigator","msSaveBlob","msToBlob","blob","blob_url","toDataURL","anchor","href","d","body","evt","createEvent","initEvent","dispatchEvent","screenshot_plugin","plugin","jmss","screenshot","register_plugin"],"mappings":"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"}