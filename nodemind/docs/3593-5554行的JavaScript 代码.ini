        // è®¾ç½®è‡ªåŠ¨ä¿å­˜
        function setupAutoSave() {
            console.log('ğŸš€ åˆå§‹åŒ–è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ...');
            
            // æ£€æŸ¥å­˜å‚¨çŠ¶æ€å’Œè·¯å¾„
            checkStorageStatus();
            
            // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
            setInterval(function() {
                console.log('â° å®šæ—¶è‡ªåŠ¨ä¿å­˜è§¦å‘');
                autoSaveCurrentNodeDetails(); // ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
                autoSaveData();
            }, 30000);
            
            // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜
            window.addEventListener('beforeunload', function() {
                console.log('ğŸšª é¡µé¢å³å°†å…³é—­ï¼Œæ‰§è¡Œæœ€ç»ˆä¿å­˜');
                autoSaveCurrentNodeDetails(); // ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
                autoSaveData();
                // å¦‚æœæœ‰å·²çŸ¥æ–‡ä»¶è·¯å¾„ï¼Œæ‰§è¡Œæ–‡ä»¶è‡ªåŠ¨ä¿å­˜
                if (lastSavedFilePath) {
                    autoSaveToFile();
                }
            });
            
            // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
            window.addEventListener('blur', function() {
                console.log('ğŸ‘ï¸ é¡µé¢å¤±å»ç„¦ç‚¹ï¼Œæ‰§è¡Œè‡ªåŠ¨ä¿å­˜');
                autoSaveCurrentNodeDetails(); // ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
                autoSaveData();
            });
            
            // å¯åŠ¨æ–‡ä»¶è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
            setupFileAutoSave();
            
            console.log('âœ… è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }
        
        // è®¾ç½®æ–‡ä»¶è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        function setupFileAutoSave() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (autoSaveFileTimer) {
                clearInterval(autoSaveFileTimer);
            }
            
            // è®¾ç½®2åˆ†é’Ÿå®šæ—¶è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶
            autoSaveFileTimer = setInterval(function() {
                if (lastSavedFilePath) {
                    autoSaveToFile();
                }
            }, 120000); // 2åˆ†é’Ÿ = 120000æ¯«ç§’
            
            console.log('ğŸ•’ æ–‡ä»¶è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨å·²å¯åŠ¨ï¼ˆæ¯2åˆ†é’Ÿï¼‰');
        }
        
        // è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶
        function autoSaveToFile() {
            try {
                // å…ˆä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹åˆ°å†…å­˜
                autoSaveCurrentNodeDetails();
                autoSaveData();
                
                // ä½¿ç”¨ä¸exportToCustomFileç›¸åŒçš„å®Œæ•´æ•°æ®ç»“æ„
                var mind_data = getCurrentJsMind().get_data();
                if (!mind_data) {
                    console.log('âš ï¸ æ— è„‘å›¾æ•°æ®å¯ä¿å­˜');
                    return;
                }
                
                // ä½¿ç”¨èåˆæ•°æ®ç»“æ„ä¿å­˜ - ç¡®ä¿åŸç”Ÿå­—æ®µå’Œæ‰©å±•å­—æ®µå®Œæ•´ä¿å­˜
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,  // å·²åŒ…å«èåˆç»“æ„çš„å®Œæ•´æ•°æ®
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind",
                        export_type: "auto_save",
                        current_tab: currentMindmap,
                        unified_structure: true  // æ ‡è®°ï¼šä½¿ç”¨èåˆæ•°æ®ç»“æ„
                    }
                };
                
                var content = JSON.stringify(exportData, null, 2);
                
                // æ ¹æ®å½“å‰é€‰é¡¹å¡ç¡®å®šä¿å­˜æ–‡ä»¶å
                var fileName = getAutoSaveFileName();
                console.log('ğŸ’¾ è‡ªåŠ¨ä¿å­˜åˆ°é¡¹ç›®æ–‡ä»¶:', fileName);
                
                // ä½¿ç”¨é¡¹ç›®ç›®å½•è‡ªåŠ¨ä¿å­˜
                autoSaveToProjectFile(content, fileName);
                
            } catch (error) {
                console.error('âŒ æ–‡ä»¶è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                // ä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œé¿å…æ‰“æ–­ç”¨æˆ·å·¥ä½œ
            }
        }
        
        // è·å–è‡ªåŠ¨ä¿å­˜æ–‡ä»¶å - ç»Ÿä¸€çº¦å®šæ ¼å¼
        function getAutoSaveFileName() {
            // ç»Ÿä¸€çº¦å®šï¼š{é¡¹ç›®åç§°}-jsmind.json
            var projectName = projectInfo.name || currentMindmap || 'nodemind';
            console.log('ğŸ“‹ ç”Ÿæˆæ–‡ä»¶å:', {
                'projectInfo.name': projectInfo.name,
                'currentMindmap': currentMindmap,
                'finalName': projectName,
                'fileName': projectName + '-jsmind.json'
            });
            return projectName + '-jsmind.json';
        }
        
        // è·å–é¡¹ç›®æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
        function getProjectFilePath() {
            var fileName = getAutoSaveFileName();
            var projectPath = projectInfo.path;
            
            if (projectPath && projectPath !== 'æœªè®¾ç½®') {
                // ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
                var normalizedPath = projectPath.replace(/\\/g, '/');
                if (!normalizedPath.endsWith('/')) {
                    normalizedPath += '/';
                }
                return normalizedPath + fileName;
            }
            
            return fileName; // åªè¿”å›æ–‡ä»¶å
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„é¡¹ç›®è·¯å¾„
        function hasValidProjectPath() {
            return projectInfo.path && projectInfo.path !== 'æœªè®¾ç½®' && projectInfo.path.trim() !== '';
        }
        
        // è‡ªåŠ¨ä¿å­˜åˆ°é¡¹ç›®æ–‡ä»¶
        function autoSaveToProjectFile(content, fileName) {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ–‡ä»¶å¥æŸ„
                if (lastSavedFilePath && lastSavedFilePath.handle) {
                    console.log('ğŸ”„ ä½¿ç”¨å·²æœ‰æ–‡ä»¶å¥æŸ„è‡ªåŠ¨ä¿å­˜:', fileName);
                    autoSaveWithModernAPI(content, lastSavedFilePath.handle);
                    return;
                }
                
                // æ²¡æœ‰æ–‡ä»¶å¥æŸ„æ—¶ï¼Œå°è¯•è‡ªåŠ¨æ¢å¤ä¿å­˜åŠŸèƒ½
                console.log('âš ï¸ æ²¡æœ‰æ–‡ä»¶å¥æŸ„ï¼Œå°è¯•è‡ªåŠ¨æ¢å¤ä¿å­˜åŠŸèƒ½');
                console.log('ğŸ“ ç›®æ ‡æ–‡ä»¶:', fileName);
                
                // å°è¯•è‡ªåŠ¨è·å–é¡¹ç›®æ–‡ä»¶çš„è®¿é—®æƒé™
                tryAutoRestoreFileSave(content, fileName);
                
            } catch (error) {
                console.error('âŒ é¡¹ç›®æ–‡ä»¶ä¿å­˜å¤±è´¥:', error);
            }
        }
        
        // å°è¯•è‡ªåŠ¨æ¢å¤æ–‡ä»¶ä¿å­˜åŠŸèƒ½
        async function tryAutoRestoreFileSave(content, fileName) {
            try {
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒç°ä»£æ–‡ä»¶ç³»ç»ŸAPI
                if (!window.showSaveFilePicker) {
                    console.log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒç°ä»£æ–‡ä»¶ç³»ç»ŸAPIï¼Œä½¿ç”¨localStorageå¤‡ä»½');
                    backupToLocalStorage(content);
                    return;
                }
                
                // ä»é¡¹ç›®åŸºæœ¬ä¿¡æ¯ä¸­è·å–é¡¹ç›®è·¯å¾„
                var fullPath = getProjectFilePath();
                console.log('ğŸ”„ è‡ªåŠ¨ä¿å­˜åˆ°é¡¹ç›®æ–‡ä»¶:', fileName);
                console.log('ğŸ“ å®Œæ•´è·¯å¾„:', fullPath);
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç”¨æˆ·æˆæƒè¿‡çš„æ–‡ä»¶å¥æŸ„
                var hasAuthorizedBefore = localStorage.getItem('nodemind_file_authorized_' + currentMindmap);
                
                if (!hasAuthorizedBefore && hasValidProjectPath()) {
                    // é¦–æ¬¡ä½¿ç”¨ä¸”æœ‰æœ‰æ•ˆé¡¹ç›®è·¯å¾„ï¼Œè‡ªåŠ¨å°è¯•ä¿å­˜åˆ°é¡¹ç›®ç›®å½•
                    console.log('ğŸ“‹ é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°é¡¹ç›®è·¯å¾„:', fullPath);
                    showMessage('ğŸ“‹ è‡ªåŠ¨ä¿å­˜åˆ°: ' + fullPath, 3000);
                    
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        startIn: 'documents', // ä»æ–‡æ¡£ç›®å½•å¼€å§‹ï¼Œç”¨æˆ·å¯ä»¥å¯¼èˆªåˆ°é¡¹ç›®ç›®å½•
                        types: [
                            {
                                description: 'NodeMindé¡¹ç›®æ–‡ä»¶',
                                accept: {
                                    'application/json': ['.json']
                                }
                            }
                        ]
                    });
                    
                    // ä¿å­˜æ–‡ä»¶
                    const writable = await fileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    
                    // è®°å½•æ–‡ä»¶å¥æŸ„å’ŒæˆæƒçŠ¶æ€
                    lastSavedFilePath = {
                        handle: fileHandle,
                        name: fileName
                    };
                    
                    localStorage.setItem(STORAGE_KEYS.LAST_SAVED_PATH, JSON.stringify({
                        name: fileName,
                        timestamp: new Date().toISOString(),
                        projectPath: projectInfo.path,
                        fullPath: fullPath
                    }));
                    
                    localStorage.setItem('nodemind_file_authorized_' + currentMindmap, 'true');
                    
                    console.log('âœ… è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å·²å¯ç”¨:', fileName);
                    showMessage('âœ… è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å·²å¯ç”¨: ' + fileName, 3000);
                    
                } else if (!hasValidProjectPath()) {
                    // æ²¡æœ‰é¡¹ç›®è·¯å¾„ä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·
                    console.log('âš ï¸ æœªè·å–åˆ°æœ‰æ•ˆçš„é¡¹ç›®è·¯å¾„ä¿¡æ¯');
                    showMessage('âš ï¸ æœªè·å–åˆ°é¡¹ç›®è·¯å¾„ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜', 3000);
                    backupToLocalStorage(content);
                    
                } else {
                    // å·²ç»æˆæƒè¿‡ï¼Œç›´æ¥ä¿å­˜åˆ°localStorageå¤‡ä»½
                    console.log('ğŸ’¾ å·²æˆæƒè¿‡ï¼Œä¿å­˜åˆ°localStorageå¤‡ä»½');
                    backupToLocalStorage(content);
                    
                    // é™é»˜ä¿å­˜ï¼Œå‡å°‘æç¤º
                    console.log('ğŸ’¡ æç¤ºï¼šå¯é€šè¿‡"ğŸ“ è‡ªå®šä¹‰å­˜å‚¨"é‡æ–°è¿æ¥åˆ°é¡¹ç›®æ–‡ä»¶');
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©ï¼Œä½¿ç”¨localStorageå¤‡ä»½');
                } else {
                    console.error('âŒ è‡ªåŠ¨æ¢å¤å¤±è´¥:', error);
                }
                
                // å›é€€åˆ°localStorageå¤‡ä»½
                backupToLocalStorage(content);
            }
        }
        
        // å¤‡ä»½åˆ°localStorage
        function backupToLocalStorage(content) {
            var backupKey = 'nodemind_backup_' + currentMindmap;
            localStorage.setItem(backupKey, content);
            console.log('ğŸ’¾ å·²å¤‡ä»½åˆ°localStorage:', backupKey);
            
            // é™é»˜ä¿å­˜ï¼Œä¸é¢‘ç¹æç¤ºç”¨æˆ·
            // åªåœ¨ç‰¹æ®Šæƒ…å†µä¸‹æ‰æç¤ºï¼ˆæ¯”å¦‚ç”¨æˆ·é•¿æ—¶é—´å·¥ä½œåï¼‰
            var sessionStartKey = 'nodemind_session_start_' + currentMindmap;
            var sessionStart = localStorage.getItem(sessionStartKey);
            var now = Date.now();
            
            if (!sessionStart) {
                localStorage.setItem(sessionStartKey, now.toString());
                return;
            }
            
            // å·¥ä½œè¶…è¿‡30åˆ†é’Ÿä¸”æ²¡æœ‰æ–‡ä»¶è¿æ¥æ—¶ï¼Œæ‰æç¤ºä¸€æ¬¡
            var workDuration = now - parseInt(sessionStart);
            var hasPrompted = localStorage.getItem('nodemind_long_session_prompted_' + currentMindmap);
            
            if (workDuration > 30 * 60 * 1000 && !hasPrompted) {
                var fileName = getAutoSaveFileName();
                showMessage('ğŸ’¡ é•¿æ—¶é—´å·¥ä½œå»ºè®®ï¼šç‚¹å‡»"ğŸ“ è‡ªå®šä¹‰å­˜å‚¨"è¿æ¥é¡¹ç›®æ–‡ä»¶ ' + fileName + ' ä»¥å¯ç”¨æ–‡ä»¶ä¿å­˜', 5000);
                localStorage.setItem('nodemind_long_session_prompted_' + currentMindmap, 'true');
            }
        }
        
        // ä½¿ç”¨ç°ä»£APIè‡ªåŠ¨ä¿å­˜
        async function autoSaveWithModernAPI(content, fileHandle) {
            try {
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                console.log('âœ… æ–‡ä»¶å·²è‡ªåŠ¨ä¿å­˜:', lastSavedFilePath.name);
                // æ˜¾ç¤ºç®€çŸ­çš„æˆåŠŸæç¤º
                showMessage('ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜', 2000);
                
            } catch (error) {
                console.error('âŒ ç°ä»£APIè‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                // ä¸å†å›é€€åˆ°ä¼ ç»Ÿæ–¹å¼ï¼Œé¿å…ä¸‹è½½æ–‡ä»¶
            }
        }
        


        // å½“å‰æ­£åœ¨ç¼–è¾‘çš„èŠ‚ç‚¹IDï¼ˆç”¨äºè‡ªåŠ¨ä¿å­˜ï¼‰
        var currentEditingNodeId = null;
        
        // è‡ªåŠ¨ä¿å­˜å½“å‰ç¼–è¾‘èŠ‚ç‚¹çš„è¯¦ç»†å†…å®¹å¹¶åŒæ­¥åˆ°æ‰€æœ‰å·¥ä½œåŒº
        function autoSaveCurrentNodeDetails() {
            if (!currentEditingNodeId) {
                console.log('âš ï¸ æ²¡æœ‰å½“å‰ç¼–è¾‘èŠ‚ç‚¹IDï¼Œè·³è¿‡è‡ªåŠ¨ä¿å­˜');
                return;
            }
            
            try {
                var titleEl = document.getElementById('node_title_' + currentEditingNodeId);
                var contentEl = document.getElementById('node_content_' + currentEditingNodeId);
                var authorEl = document.getElementById('node_author_' + currentEditingNodeId);
                
                console.log('ğŸ” æ£€æŸ¥èŠ‚ç‚¹å…ƒç´ :', {
                    nodeId: currentEditingNodeId,
                    titleEl: !!titleEl,
                    contentEl: !!contentEl,
                    authorEl: !!authorEl,
                    nodeInDB: !!nodeDatabase[currentEditingNodeId]
                });
                
                if (titleEl && contentEl && authorEl && nodeDatabase[currentEditingNodeId]) {
                    var hasChanges = false;
                    var changes = [];
                    
                    // æ£€æŸ¥å¹¶æ›´æ–°æ ‡é¢˜
                    if (titleEl.value !== nodeDatabase[currentEditingNodeId].title) {
                        var oldTitle = nodeDatabase[currentEditingNodeId].title;
                        nodeDatabase[currentEditingNodeId].title = titleEl.value;
                        hasChanges = true;
                        changes.push(`æ ‡é¢˜: "${oldTitle}" â†’ "${titleEl.value}"`);
                        
                        // åŒæ­¥æ›´æ–°æ‰€æœ‰å·¥ä½œåŒºä¸­çš„ç›¸åŒèŠ‚ç‚¹æ ‡é¢˜
                        Object.keys(mindmaps).forEach(function(tabName) {
                            var mindmap = mindmaps[tabName];
                            var targetNode = mindmap.get_node(currentEditingNodeId);
                            if (targetNode && targetNode.topic !== titleEl.value) {
                                mindmap.update_node(currentEditingNodeId, titleEl.value);
                            }
                        });
                    }
                    
                    // æ£€æŸ¥å¹¶æ›´æ–°è¯¦ç»†å†…å®¹
                    if (contentEl.value !== nodeDatabase[currentEditingNodeId].content) {
                        var oldContent = nodeDatabase[currentEditingNodeId].content;
                        nodeDatabase[currentEditingNodeId].content = contentEl.value;
                        hasChanges = true;
                        changes.push(`å†…å®¹: ${oldContent.length}å­—ç¬¦ â†’ ${contentEl.value.length}å­—ç¬¦`);
                    }
                    
                    // æ£€æŸ¥å¹¶æ›´æ–°ä½œè€…
                    if (authorEl.value !== nodeDatabase[currentEditingNodeId].author) {
                        var oldAuthor = nodeDatabase[currentEditingNodeId].author;
                        nodeDatabase[currentEditingNodeId].author = authorEl.value;
                        hasChanges = true;
                        changes.push(`ä½œè€…: "${oldAuthor}" â†’ "${authorEl.value}"`);
                    }
                    
                    if (hasChanges) {
                        nodeDatabase[currentEditingNodeId].time.modified = new Date().toLocaleString();
                        console.log('âœ… è‡ªåŠ¨ä¿å­˜èŠ‚ç‚¹è¯¦ç»†å†…å®¹:', currentEditingNodeId, changes);
                        // è§¦å‘æŒä¹…åŒ–å­˜å‚¨
                        setTimeout(autoSaveData, 100);
                        
                        // æ˜¾ç¤ºä¿å­˜æç¤º
                        showMessage('ğŸ’¾ å†…å®¹å·²è‡ªåŠ¨ä¿å­˜', 1500);
                    } else {
                        console.log('â„¹ï¸ èŠ‚ç‚¹å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜:', currentEditingNodeId);
                    }
                } else {
                    console.warn('âš ï¸ è‡ªåŠ¨ä¿å­˜æ¡ä»¶ä¸æ»¡è¶³:', {
                        nodeId: currentEditingNodeId,
                        titleEl: !!titleEl,
                        contentEl: !!contentEl,
                        authorEl: !!authorEl,
                        nodeInDB: !!nodeDatabase[currentEditingNodeId]
                    });
                }
            } catch (error) {
                console.error('âŒ è‡ªåŠ¨ä¿å­˜èŠ‚ç‚¹è¯¦ç»†å†…å®¹å¤±è´¥:', error);
                showMessage('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥', 2000);
            }
        }

        // ä¸ºæ‰€æœ‰è„‘å›¾å®ä¾‹æ·»åŠ äº‹ä»¶ç›‘å¬
        function addEventListenersToAllMindmaps() {
            Object.keys(mindmaps).forEach(function(tabName) {
                var mindmap = mindmaps[tabName];
                
                mindmap.add_event_listener(function(type, data) {
                    // ç¡®ä¿å½“å‰è„‘å›¾æ ‡ç­¾è¢«æ¿€æ´»
                    if (currentMindmap !== tabName) {
                        switchMindmapTab(tabName);
                    }
                    
                    if (type === 'select_node') {
                        // åœ¨åˆ‡æ¢åˆ°æ–°èŠ‚ç‚¹å‰ï¼Œå…ˆè‡ªåŠ¨ä¿å­˜å½“å‰ç¼–è¾‘èŠ‚ç‚¹çš„è¯¦ç»†å†…å®¹
                        autoSaveCurrentNodeDetails();
                        
                        updateSelectedNodeDisplay();
                        showNodeDetails(data.node.id);
                        console.log('é€‰ä¸­' + tabName + 'èŠ‚ç‚¹:', data.node.topic);
                        // è‡ªåŠ¨ä¿å­˜é€‰ä¸­çŠ¶æ€
                        setTimeout(autoSaveData, 100);
                    } else if (type === 'edit_node') {
                        showNodeDetails(data.node.id);
                        console.log('ç¼–è¾‘' + tabName + 'èŠ‚ç‚¹:', data.node.topic);
                        // è‡ªåŠ¨ä¿å­˜ç¼–è¾‘
                        setTimeout(autoSaveData, 500);
                    } else if (type === 'move_node') {
                        showMessage('ğŸ”€ èŠ‚ç‚¹å·²ç§»åŠ¨: ' + data.node.topic);
                        console.log('ç§»åŠ¨' + tabName + 'èŠ‚ç‚¹:', data.node.topic, 'åˆ°æ–°ä½ç½®');
                        updateSelectedNodeDisplay();
                        updateNodeRelations(data.node.id);
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        // è‡ªåŠ¨ä¿å­˜ç§»åŠ¨æ“ä½œ
                        setTimeout(autoSaveData, 200);
                    } else if (type === 'add_node') {
                        updateNodeRelations(data.node.id);
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        showNodeDetails(data.node.id);
                        // è‡ªåŠ¨ä¿å­˜æ–°å¢èŠ‚ç‚¹
                        setTimeout(autoSaveData, 200);
                    } else if (type === 'remove_node') {
                        if (data.parent_node) {
                            updateNodeRelations(data.parent_node.id);
                        }
                        // è‡ªåŠ¨ä¿å­˜åˆ é™¤æ“ä½œ
                        setTimeout(autoSaveData, 200);
                    }
                });
            });
        }
        
        // ä¸ºæ‰€æœ‰è„‘å›¾æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        addEventListenersToAllMindmaps();

        // æŒä¹…åŒ–å­˜å‚¨ç›¸å…³å¸¸é‡
        var STORAGE_KEYS = {
            MINDMAP_DATA: 'nodemind_mindmap_data',
            NODE_DATABASE: 'nodemind_node_database', 
            CURRENT_THEME: 'nodemind_current_theme',
            DRAG_ENABLED: 'nodemind_drag_enabled',
            SELECTED_NODE: 'nodemind_selected_node',
            VIEW_DATA: 'nodemind_view_data',
            LAST_SAVED_PATH: 'nodemind_last_saved_path'
        };
        
        // æ–‡ä»¶è·¯å¾„è®°å½•å’Œè‡ªåŠ¨ä¿å­˜ç›¸å…³å˜é‡
        var lastSavedFilePath = null;
        var autoSaveFileTimer = null;
        
        // æ£€æŸ¥localStorageå­˜å‚¨çŠ¶æ€å’Œè·¯å¾„
        function checkStorageStatus() {
            try {
                console.log('ğŸ” æ£€æŸ¥localStorageå­˜å‚¨çŠ¶æ€:');
                console.log('ğŸ“ å­˜å‚¨å¯ç”¨æ€§:', typeof(Storage) !== "undefined");
                console.log('ğŸ“ localStorageå¯¹è±¡:', !!localStorage);
                
                // æ£€æŸ¥å­˜å‚¨é…é¢
                if (navigator.storage && navigator.storage.estimate) {
                    navigator.storage.estimate().then(function(estimate) {
                        console.log('ğŸ’¾ å­˜å‚¨é…é¢:', {
                            quota: Math.round(estimate.quota / 1024 / 1024) + 'MB',
                            usage: Math.round(estimate.usage / 1024 / 1024) + 'MB',
                            available: Math.round((estimate.quota - estimate.usage) / 1024 / 1024) + 'MB'
                        });
                    });
                }
                
                // æ£€æŸ¥ç°æœ‰å­˜å‚¨çš„é”®
                console.log('ğŸ—‚ï¸ ç°æœ‰localStorageé”®:');
                for (var i = 0; i < localStorage.length; i++) {
                    var key = localStorage.key(i);
                    if (key.startsWith('nodemind_')) {
                        var value = localStorage.getItem(key);
                        console.log(`  ${key}: ${value ? value.length + 'å­—ç¬¦' : 'ç©ºå€¼'}`);
                    }
                }
                
                // æ£€æŸ¥STORAGE_KEYSé…ç½®
                console.log('âš™ï¸ STORAGE_KEYSé…ç½®:', STORAGE_KEYS);
                
                return true;
            } catch (error) {
                console.error('âŒ å­˜å‚¨çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                return false;
            }
        }
        
        // è‡ªåŠ¨ä¿å­˜å‡½æ•°
        function autoSaveData() {
            try {
                // ä¿å­˜æ‰€æœ‰è„‘å›¾çš„æ•°æ®
                var allMindmapData = {};
                Object.keys(mindmaps).forEach(function(tabName) {
                    if (mindmaps[tabName]) {
                        allMindmapData[tabName] = mindmaps[tabName].get_data();
                    }
                });
                
                if (Object.keys(allMindmapData).length > 0) {
                    // éªŒè¯å­˜å‚¨é”®é…ç½®
                    console.log('ğŸ” å­˜å‚¨é”®é…ç½®æ£€æŸ¥:', STORAGE_KEYS);
                    
                    // ä¿å­˜æ‰€æœ‰æ€ç»´å¯¼å›¾æ•°æ®
                    localStorage.setItem(STORAGE_KEYS.MINDMAP_DATA, JSON.stringify(allMindmapData));
                    console.log('ğŸ’¾ å·²ä¿å­˜æ€ç»´å¯¼å›¾æ•°æ®åˆ°:', STORAGE_KEYS.MINDMAP_DATA);
                    
                    // ä¿å­˜èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æ•°æ®åº“
                    localStorage.setItem(STORAGE_KEYS.NODE_DATABASE, JSON.stringify(nodeDatabase));
                    console.log('ğŸ’¾ å·²ä¿å­˜èŠ‚ç‚¹æ•°æ®åº“åˆ°:', STORAGE_KEYS.NODE_DATABASE);
                    
                    // ä¿å­˜å½“å‰ä¸»é¢˜
                    localStorage.setItem(STORAGE_KEYS.CURRENT_THEME, currentThemeIndex.toString());
                    console.log('ğŸ’¾ å·²ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°:', STORAGE_KEYS.CURRENT_THEME);
                    
                    // ä¿å­˜æ‹–æ‹½çŠ¶æ€
                    localStorage.setItem(STORAGE_KEYS.DRAG_ENABLED, isDragEnabled.toString());
                    console.log('ğŸ’¾ å·²ä¿å­˜æ‹–æ‹½çŠ¶æ€åˆ°:', STORAGE_KEYS.DRAG_ENABLED);
                    
                    // ä¿å­˜å½“å‰æ´»è·ƒçš„è„‘å›¾é€‰é¡¹å¡
                    localStorage.setItem('nodemind_current_mindmap', currentMindmap);
                    console.log('ğŸ’¾ å·²ä¿å­˜å½“å‰è„‘å›¾åˆ°: nodemind_current_mindmap');
                    
                    // ä¿å­˜é€‰ä¸­èŠ‚ç‚¹
                    var selectedNode = getCurrentJsMind().get_selected_node();
                    if (selectedNode) {
                        localStorage.setItem(STORAGE_KEYS.SELECTED_NODE, selectedNode.id);
                        console.log('ğŸ’¾ å·²ä¿å­˜é€‰ä¸­èŠ‚ç‚¹åˆ°:', STORAGE_KEYS.SELECTED_NODE, 'èŠ‚ç‚¹ID:', selectedNode.id);
                    }
                    
                    // éªŒè¯å­˜å‚¨æ˜¯å¦æˆåŠŸ
                    var verifyData = localStorage.getItem(STORAGE_KEYS.MINDMAP_DATA);
                    if (verifyData) {
                        console.log('âœ… å­˜å‚¨éªŒè¯æˆåŠŸï¼Œæ•°æ®å¤§å°:', verifyData.length, 'å­—ç¬¦');
                    } else {
                        console.error('âŒ å­˜å‚¨éªŒè¯å¤±è´¥ï¼Œæ•°æ®æœªä¿å­˜');
                    }
                    
                    console.log('âœ… æ•°æ®å·²è‡ªåŠ¨ä¿å­˜ï¼ˆåŒ…å«æ‰€æœ‰è„‘å›¾ï¼‰');
                } else {
                    console.warn('âš ï¸ æ²¡æœ‰è„‘å›¾æ•°æ®å¯ä¿å­˜');
                }
            } catch (error) {
                console.error('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                console.error('âŒ é”™è¯¯è¯¦æƒ…:', {
                    message: error.message,
                    stack: error.stack,
                    storageKeys: STORAGE_KEYS
                });
            }
        }
        
        // åŠ è½½ä¿å­˜çš„æ•°æ®
        function loadSavedData() {
            try {
                // åŠ è½½æ€ç»´å¯¼å›¾æ•°æ®
                var savedMindmapData = localStorage.getItem(STORAGE_KEYS.MINDMAP_DATA);
                var savedNodeDatabase = localStorage.getItem(STORAGE_KEYS.NODE_DATABASE);
                var savedTheme = localStorage.getItem(STORAGE_KEYS.CURRENT_THEME);
                var savedDragState = localStorage.getItem(STORAGE_KEYS.DRAG_ENABLED);
                var savedSelectedNode = localStorage.getItem(STORAGE_KEYS.SELECTED_NODE);
                var savedCurrentMindmap = localStorage.getItem('nodemind_current_mindmap');
                
                var hasRecoveredData = false;
                
                // æ¢å¤å¤šå·¥ä½œåŒºæ€ç»´å¯¼å›¾æ•°æ®
                if (savedMindmapData) {
                    try {
                        var allMindmapData = JSON.parse(savedMindmapData);
                        
                        // æ¢å¤æ¯ä¸ªå·¥ä½œåŒºçš„æ•°æ®
                        if (allMindmapData && typeof allMindmapData === 'object') {
                            Object.keys(allMindmapData).forEach(function(tabName) {
                                var mindmapData = allMindmapData[tabName];
                                if (mindmapData && mindmapData.data && mindmaps[tabName]) {
                                    mindmaps[tabName].show(mindmapData);
                                    hasRecoveredData = true;
                                    console.log('âœ… ' + tabName + ' å·¥ä½œåŒºæ•°æ®å·²æ¢å¤');
                                }
                            });
                            
                            // æ¢å¤å½“å‰æ´»è·ƒå·¥ä½œåŒº
                            if (savedCurrentMindmap && mindmaps[savedCurrentMindmap]) {
                                currentMindmap = savedCurrentMindmap;
                                switchMindmapTab(currentMindmap);
                                console.log('âœ… å½“å‰å·¥ä½œåŒºå·²æ¢å¤ä¸º:', currentMindmap);
                            }
                        }
                    } catch (e) {
                        console.error('æ€ç»´å¯¼å›¾æ•°æ®æ¢å¤å¤±è´¥:', e);
                    }
                }
                
                // æ¢å¤èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æ•°æ®åº“
                if (savedNodeDatabase) {
                    try {
                        nodeDatabase = JSON.parse(savedNodeDatabase);
                        console.log('âœ… èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯å·²æ¢å¤');
                        // ç¡®ä¿æ¢å¤çš„æ•°æ®ç¬¦åˆèåˆæ•°æ®ç»“æ„
                        validateAndFixNodeDatabase();
                    } catch (e) {
                        console.error('èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æ¢å¤å¤±è´¥:', e);
                        nodeDatabase = {};
                    }
                }
                
                // æ¢å¤ä¸»é¢˜è®¾ç½®
                if (savedTheme) {
                    try {
                        var themeIndex = parseInt(savedTheme);
                        if (themeIndex >= 0 && themeIndex < themes.length) {
                            currentThemeIndex = themeIndex;
                            jm.set_theme(themes[currentThemeIndex].name);
                            console.log('âœ… ä¸»é¢˜è®¾ç½®å·²æ¢å¤:', themes[currentThemeIndex].label);
                        }
                    } catch (e) {
                        console.error('ä¸»é¢˜è®¾ç½®æ¢å¤å¤±è´¥:', e);
                    }
                }
                
                // æ¢å¤æ‹–æ‹½çŠ¶æ€
                if (savedDragState) {
                    try {
                        isDragEnabled = (savedDragState === 'true');
                        if (isDragEnabled) {
                            jm.enable_draggable_node();
                        } else {
                            jm.disable_draggable_node();
                        }
                        updateDragStatusDisplay();
                        console.log('âœ… æ‹–æ‹½çŠ¶æ€å·²æ¢å¤:', isDragEnabled ? 'å¯ç”¨' : 'ç¦ç”¨');
                    } catch (e) {
                        console.error('æ‹–æ‹½çŠ¶æ€æ¢å¤å¤±è´¥:', e);
                    }
                }
                
                // æ¢å¤é€‰ä¸­èŠ‚ç‚¹
                if (savedSelectedNode && hasRecoveredData) {
                    setTimeout(function() {
                        try {
                            var node = jm.get_node(savedSelectedNode);
                            if (node) {
                                jm.select_node(savedSelectedNode);
                                showNodeDetails(savedSelectedNode);
                                console.log('âœ… é€‰ä¸­èŠ‚ç‚¹å·²æ¢å¤:', node.topic);
                            }
                        } catch (e) {
                            console.error('é€‰ä¸­èŠ‚ç‚¹æ¢å¤å¤±è´¥:', e);
                        }
                    }, 300);
                }
                
                // æ¢å¤æ–‡ä»¶è·¯å¾„ä¿¡æ¯
                var savedFilePath = localStorage.getItem(STORAGE_KEYS.LAST_SAVED_PATH);
                if (savedFilePath) {
                    try {
                        var filePathData = JSON.parse(savedFilePath);
                        lastSavedFilePath = {
                            handle: null, // é¡µé¢é‡æ–°åŠ è½½åæ— æ³•æ¢å¤handle
                            name: filePathData.name
                        };
                        console.log('âœ… æ–‡ä»¶è·¯å¾„å·²æ¢å¤ï¼Œè‡ªåŠ¨ä¿å­˜å·²å¯ç”¨:', filePathData.name);
                    } catch (e) {
                        console.error('æ–‡ä»¶è·¯å¾„æ¢å¤å¤±è´¥:', e);
                    }
                }
                
                // æ— è®ºæ˜¯å¦æ¢å¤æ•°æ®ï¼Œéƒ½è¦æ‰§è¡Œå·¥å…·åˆå§‹åŒ–ï¼ˆå£°æ˜èåˆæ•°æ®ç»“æ„ï¼‰
                initializeNodeMindTool();
                
                if (hasRecoveredData) {
                    showMessage('ğŸ”„ å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤ä¸Šæ¬¡çš„æ€ç»´å¯¼å›¾çŠ¶æ€');
                } else {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
                    initNodeDatabase();
                }
                
                return hasRecoveredData;
                
            } catch (error) {
                console.error('æ•°æ®æ¢å¤å¤±è´¥:', error);
                showMessage('âŒ æ•°æ®æ¢å¤å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                // æ— è®ºå¦‚ä½•éƒ½è¦æ‰§è¡Œå·¥å…·åˆå§‹åŒ–
                initializeNodeMindTool();
                initNodeDatabase();
                return false;
            }
        }
        

        
        // ä¿å­˜æ‰€æœ‰å¯èƒ½æ­£åœ¨ç¼–è¾‘çš„èŠ‚ç‚¹è¯¦ç»†å†…å®¹åˆ°nodeDatabase
        function saveAllEditingNodeDetails() {
            // ä¿å­˜å½“å‰æ­£åœ¨ç¼–è¾‘çš„èŠ‚ç‚¹
            autoSaveCurrentNodeDetails();
            
            // éå†æ‰€æœ‰è¡¨å•å…ƒç´ ï¼Œç¡®ä¿æ‰€æœ‰ç¼–è¾‘å†…å®¹éƒ½è¢«ä¿å­˜
            var allTitleInputs = document.querySelectorAll('[id^="node_title_"]');
            var allContentInputs = document.querySelectorAll('[id^="node_content_"]');
            var allAuthorInputs = document.querySelectorAll('[id^="node_author_"]');
            
            allTitleInputs.forEach(function(input) {
                var nodeId = input.id.replace('node_title_', '');
                if (nodeDatabase[nodeId] && input.value !== nodeDatabase[nodeId].title) {
                    nodeDatabase[nodeId].title = input.value;
                    nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                }
            });
            
            allContentInputs.forEach(function(input) {
                var nodeId = input.id.replace('node_content_', '');
                if (nodeDatabase[nodeId] && input.value !== nodeDatabase[nodeId].content) {
                    nodeDatabase[nodeId].content = input.value;
                    nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                }
            });
            
            allAuthorInputs.forEach(function(input) {
                var nodeId = input.id.replace('node_author_', '');
                if (nodeDatabase[nodeId] && input.value !== nodeDatabase[nodeId].author) {
                    nodeDatabase[nodeId].author = input.value;
                    nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                }
            });
        }


        // è‡ªå®šä¹‰å­˜å‚¨åŠŸèƒ½ - ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ä¿å­˜
        function exportToCustomFile() {
            try {
                // å…ˆä¿å­˜æ‰€æœ‰å¯èƒ½æ­£åœ¨ç¼–è¾‘çš„èŠ‚ç‚¹è¯¦ç»†å†…å®¹åˆ°nodeDatabase
                saveAllEditingNodeDetails();
                
                var mind_data = getCurrentJsMind().get_data();
                if (!mind_data) {
                    showMessage('âŒ æ— æ•°æ®å¯å¯¼å‡º');
                    return;
                }
                
                // æ„å»ºå¯¼å‡ºæ•°æ®
                var exportData = {
                    mindmap: mind_data,
                    nodeDetails: nodeDatabase,
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: "1.0.0",
                        exported_by: "NodeMind",
                        export_type: "custom_with_file_selector",
                        current_tab: currentMindmap
                    }
                };
                
                var mind_str = JSON.stringify(exportData, null, 2);
                
                // ä½¿ç”¨ç»Ÿä¸€çš„æ–‡ä»¶åçº¦å®šï¼š{é¡¹ç›®åç§°}-jsmind.json
                var finalFileName = getAutoSaveFileName();
                
                console.log('ğŸ“ å‡†å¤‡ä¿å­˜æ–‡ä»¶:', finalFileName);
                showMessage('ğŸ“ æ­£åœ¨å‡†å¤‡ä¿å­˜æ–‡ä»¶: ' + finalFileName);
                
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—®APIï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
                if (window.showSaveFilePicker) {
                    // ä½¿ç”¨ç°ä»£æ–‡ä»¶ç³»ç»Ÿè®¿é—®API
                    saveFileWithModernAPI(mind_str, finalFileName);
                } else {
                    // ä½¿ç”¨ä¼ ç»Ÿä¸‹è½½æ–¹å¼
                    saveFileWithTraditionalMethod(mind_str, finalFileName);
                }
                
                console.log('ğŸ“Š å¯¼å‡ºæ•°æ®æ¦‚è§ˆ:', {
                    tab: currentMindmap,
                    nodeCount: Object.keys(nodeDatabase).length,
                    timestamp: exportData.exportInfo.timestamp
                });
                
            } catch (error) {
                console.error('âŒ è‡ªå®šä¹‰å­˜å‚¨å¤±è´¥:', error);
                showMessage('âŒ è‡ªå®šä¹‰å­˜å‚¨å¤±è´¥: ' + error.message);
            }
        }
        
        // ä½¿ç”¨ç°ä»£æ–‡ä»¶ç³»ç»Ÿè®¿é—®APIä¿å­˜æ–‡ä»¶
        async function saveFileWithModernAPI(content, fileName) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [
                        {
                            description: 'NodeMindæ€ç»´å¯¼å›¾æ–‡ä»¶',
                            accept: {
                                'application/json': ['.json']
                            }
                        }
                    ]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                
                // è®°å½•ä¿å­˜è·¯å¾„ï¼Œå¯ç”¨è‡ªåŠ¨ä¿å­˜
                lastSavedFilePath = {
                    handle: fileHandle,
                    name: fileName
                };
                localStorage.setItem(STORAGE_KEYS.LAST_SAVED_PATH, JSON.stringify({
                    name: fileName,
                    timestamp: new Date().toISOString()
                }));
                
                showMessage('âœ… æ–‡ä»¶å·²æˆåŠŸä¿å­˜åˆ°æŒ‡å®šä½ç½®');
                console.log('âœ… ä½¿ç”¨ç°ä»£APIä¿å­˜æ–‡ä»¶æˆåŠŸï¼Œå·²å¯ç”¨è‡ªåŠ¨ä¿å­˜');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜');
                    console.log('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜');
                } else {
                    console.error('ç°ä»£APIä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹å¼:', error);
                    saveFileWithTraditionalMethod(content, fileName);
                }
            }
        }
        
        // ä½¿ç”¨ä¼ ç»Ÿä¸‹è½½æ–¹å¼ä¿å­˜æ–‡ä»¶
        function saveFileWithTraditionalMethod(content, fileName) {
            try {
                // åˆ›å»ºBlobå¯¹è±¡
                var blob = new Blob([content], { type: 'application/json;charset=utf-8' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                var url = URL.createObjectURL(blob);
                var downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = fileName;
                downloadLink.style.display = 'none';
                
                // æ·»åŠ åˆ°DOMå¹¶è§¦å‘ä¸‹è½½
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // æ¸…ç†
                setTimeout(function() {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // è®°å½•ä¿å­˜è·¯å¾„ï¼ˆä¼ ç»Ÿæ–¹å¼åªèƒ½è®°å½•æ–‡ä»¶åï¼‰
                lastSavedFilePath = {
                    handle: null,
                    name: fileName
                };
                localStorage.setItem(STORAGE_KEYS.LAST_SAVED_PATH, JSON.stringify({
                    name: fileName,
                    timestamp: new Date().toISOString()
                }));
                
                showMessage('âœ… æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹: ' + fileName);
                console.log('âœ… ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼ä¸‹è½½æ–‡ä»¶ï¼Œå·²å¯ç”¨è‡ªåŠ¨ä¿å­˜:', fileName);
                
            } catch (error) {
                console.error('ä¼ ç»Ÿä¸‹è½½æ–¹å¼ä¹Ÿå¤±è´¥:', error);
                showMessage('âŒ æ–‡ä»¶ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ›å»ºæ–°è„‘å›¾åŠŸèƒ½
        function createNewMindmap() {
            try {
                // å…ˆè‡ªåŠ¨ä¿å­˜å½“å‰ç¼–è¾‘å†…å®¹
                autoSaveCurrentNodeDetails();
                
                // è¯¢é—®ç”¨æˆ·æ˜¯å¦ç¡®è®¤åˆ›å»ºæ–°è„‘å›¾
                var confirmCreate = confirm('ğŸ¤” ç¡®å®šè¦åˆ›å»ºæ–°è„‘å›¾å—ï¼Ÿ\n\nå½“å‰è„‘å›¾çš„æ•°æ®å°†è¢«ä¿å­˜ï¼Œæ–°è„‘å›¾å°†åœ¨å½“å‰é€‰é¡¹å¡ä¸­æ˜¾ç¤ºã€‚\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"è¿”å›ã€‚');
                
                if (!confirmCreate) {
                    showMessage('ğŸš« ç”¨æˆ·å–æ¶ˆäº†æ–°è„‘å›¾åˆ›å»º');
                    return;
                }
                
                // ç”Ÿæˆæ–°è„‘å›¾çš„åŸºæœ¬ä¿¡æ¯
                var timestamp = new Date().toLocaleString();
                var newMindmapId = 'new_mindmap_' + Date.now();
                
                // åˆ›å»ºæ–°è„‘å›¾æ•°æ®ç»“æ„ - åªæœ‰æ ¹èŠ‚ç‚¹
                var newMindmapData = {
                    meta: {
                        name: "æ–°å»ºæ€ç»´å¯¼å›¾",
                        author: "NodeMindç”¨æˆ·",
                        version: "1.0.0",
                        created: timestamp
                    },
                    format: "node_tree",
                    data: {
                        id: newMindmapId + "_root",
                        topic: "ğŸ’¡ æ–°å»ºæ€ç»´å¯¼å›¾",
                        children: []
                    }
                };
                
                // åœ¨å½“å‰æ´»è·ƒçš„è„‘å›¾ä¸­æ˜¾ç¤ºæ–°è„‘å›¾
                var currentMindmapInstance = getCurrentJsMind();
                currentMindmapInstance.show(newMindmapData);
                
                // ä¸ºæ ¹èŠ‚ç‚¹åˆ›å»ºæ•°æ®åº“è®°å½•
                var rootNodeId = newMindmapId + "_root";
                var rootNode = currentMindmapInstance.get_node(rootNodeId);
                
                if (rootNode) {
                    nodeDatabase[rootNodeId] = {
                        id: rootNodeId,
                        title: rootNode.topic,
                        content: '',
                        relations: {
                            parent: null,
                            children: []
                        },
                        tags: {
                            categories: [],
                            technical: [],
                            status: []
                        },
                        time: {
                            created: timestamp,
                            modified: timestamp
                        },
                        author: 'NodeMindç”¨æˆ·'
                    };
                }
                
                // è‡ªåŠ¨é€‰ä¸­æ ¹èŠ‚ç‚¹
                setTimeout(function() {
                    currentMindmapInstance.select_node(rootNodeId);
                    showNodeDetails(rootNodeId);
                    updateSelectedNodeDisplay();
                }, 300);
                
                // è‡ªåŠ¨ä¿å­˜æ–°è„‘å›¾æ•°æ®
                setTimeout(autoSaveData, 500);
                
                showMessage('âœ¨ æ–°è„‘å›¾åˆ›å»ºæˆåŠŸï¼å·²åœ¨å½“å‰é€‰é¡¹å¡ä¸­æ˜¾ç¤º');
                console.log('âœ¨ æ–°è„‘å›¾åˆ›å»ºæˆåŠŸ:', {
                    id: newMindmapId,
                    tab: currentMindmap,
                    rootNodeId: rootNodeId,
                    timestamp: timestamp
                });
                
            } catch (error) {
                console.error('âŒ æ–°è„‘å›¾åˆ›å»ºå¤±è´¥:', error);
                showMessage('âŒ æ–°è„‘å›¾åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
        
        // å¤‡ç”¨ä¸‹è½½å‡½æ•°
        function downloadFile(content, filename, contentType) {
            var blob = new Blob([content], { type: contentType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        

        
        // åˆ‡æ¢è¯¦æƒ…é¢æ¿æ˜¾ç¤º/éšè—
        function toggleDetailsPanel() {
            var mainLayout = document.querySelector('.main-layout');
            var toggleBtn = document.getElementById('panelToggleBtn');
            
            if (mainLayout.classList.contains('panel-hidden')) {
                // æ˜¾ç¤ºé¢æ¿
                mainLayout.classList.remove('panel-hidden');
                toggleBtn.innerHTML = 'ğŸ“‹ éšè—è¯¦æƒ…é¢æ¿';
            } else {
                // éšè—é¢æ¿
                mainLayout.classList.add('panel-hidden');
                toggleBtn.innerHTML = 'ğŸ“‹ æ˜¾ç¤ºè¯¦æƒ…é¢æ¿';
            }
            
            // å»¶è¿Ÿè°ƒæ•´è„‘å›¾å¤§å°ä»¥ç¡®ä¿å¸ƒå±€å®Œæˆ
            setTimeout(function() {
                updateLayoutHeight(); // é‡æ–°è®¡ç®—å¸ƒå±€é«˜åº¦
                var currentMindmap = getCurrentJsMind();
                if (currentMindmap) {
                    currentMindmap.resize();
                }
            }, 350); // ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´ä»¥ç¡®ä¿CSSåŠ¨ç”»å®Œæˆ
        }
        
        // æ˜¾ç¤ºä½¿ç”¨æŒ‡å—
        function showUserGuide() {
            var guideContent = `
                <h3>ğŸ“– jsMind æ“ä½œæŒ‡å—</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <h4>ğŸ‘›ï¸ é¼ æ ‡æ“ä½œ</h4>
                        <ul>
                            <li>å•å‡»èŠ‚ç‚¹é€‰ä¸­</li>
                            <li>åŒå‡»èŠ‚ç‚¹ç¼–è¾‘å†…å®¹</li>
                            <li>æ‹–æ‹½ç”»å¸ƒç§»åŠ¨è§†å›¾</li>
                            <li>æ»šè½®ç¼©æ”¾æ€ç»´å¯¼å›¾</li>
                            <li><strong>æ‹–æ‹½èŠ‚ç‚¹é‡æ–°ç»„ç»‡ç»“æ„</strong></li>
                        </ul>
                    </div>
                    <div>
                        <h4>âŒ¨ï¸ å¿«æ·é”®</h4>
                        <ul>
                            <li>Ctrl+Enter - æ·»åŠ å­èŠ‚ç‚¹</li>
                            <li>Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹</li>
                            <li>F2 - ç¼–è¾‘èŠ‚ç‚¹</li>
                            <li>Delete - åˆ é™¤èŠ‚ç‚¹</li>
                            <li>Space - å±•å¼€/æ”¶èµ·èŠ‚ç‚¹</li>
                            <li>æ–¹å‘é”® - é€‰æ‹©ç›¸é‚»èŠ‚ç‚¹</li>
                            <li><strong>Ctrl+O - å¯¼å…¥æ–‡ä»¶</strong></li>
                            <li><strong>Ctrl+H - æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©</strong></li>
                        </ul>
                    </div>
                    <div>
                        <h4>ğŸ”€ æ‹–æ‹½åŠŸèƒ½è¯¦è§£</h4>
                        <ul>
                            <li>æŒ‰ä½é¼ æ ‡å·¦é”®å¼€å§‹æ‹–æ‹½</li>
                            <li>æ‹–æ‹½åˆ°ç›®æ ‡èŠ‚ç‚¹ä¸Šæ–¹</li>
                            <li>é‡Šæ”¾é¼ æ ‡å®Œæˆç§»åŠ¨</li>
                            <li>æ”¯æŒè·¨åˆ†æ”¯æ‹–æ‹½ç§»åŠ¨</li>
                            <li>å¯å¼€å¯/å…³é—­æ‹–æ‹½åŠŸèƒ½</li>
                            <li>è‡ªåŠ¨é‡æ–°æ’åˆ—å¸ƒå±€</li>
                        </ul>
                    </div>
                    <div>
                        <h4>ğŸ¨ é«˜çº§åŠŸèƒ½</h4>
                        <ul>
                            <li>15ç§å†…ç½®ä¸»é¢˜</li>
                            <li>è‡ªå®šä¹‰èŠ‚ç‚¹æ ·å¼</li>
                            <li><strong>æœ¬åœ°æ–‡ä»¶å¯¼å…¥ (Ctrl+O)</strong></li>
                            <li><strong>è‡ªåŠ¨æŒä¹…åŒ–å­˜å‚¨</strong></li>
                            <li>è‡ªå®šä¹‰æ–‡ä»¶åæ”¯æŒ</li>
                            <li>å¤šæ ¼å¼æ–‡ä»¶å¯¼å…¥ (JSON/JM/MM)</li>
                            <li>é¡µé¢å…³é—­æ•°æ®ä¿æŠ¤</li>
                            <li>ç§»åŠ¨ç«¯æ”¯æŒ</li>
                            <li>å¿«æ·é”®æ“ä½œ</li>
                            <li>å®æ—¶çŠ¶æ€åé¦ˆ</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;justify-content:center;align-items:center;';
            
            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:white;border-radius:8px;padding:25px;max-width:80%;max-height:80%;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.3);';
            modalContent.innerHTML = guideContent;
            
            var closeButton = document.createElement('button');
            closeButton.textContent = 'å…³é—­';
            closeButton.style.cssText = 'margin-top:20px;padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;';
            closeButton.onclick = function() {
                document.body.removeChild(modal);
            };
            
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            showMessage('ğŸ“– æ˜¾ç¤ºä½¿ç”¨æŒ‡å—');
        }
        
        // è§¦å‘æ–‡ä»¶å¯¼å…¥
        function triggerImport() {
            var fileInput = document.getElementById('import_file_input');
            if (fileInput) {
                fileInput.click();
            }
        }
        
        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(input) {
            var file = input.files[0];
            if (!file) return;
            
            console.log('ğŸ“‚ å¼€å§‹å¯¼å…¥æ–‡ä»¶:', file.name);
            showMessage('ğŸ“‚ æ­£åœ¨å¯¼å…¥æ–‡ä»¶: ' + file.name);
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var content = e.target.result;
                                    var importedData = null;
                var hasNodeDetails = false; // åœ¨å¤–å±‚ä½œç”¨åŸŸå®šä¹‰
                
                // æ ¹æ®æ–‡ä»¶æ‰©å±•åå’Œå†…å®¹åˆ¤æ–­æ ¼å¼
                var fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.json')) {
                    // JSONæ ¼å¼å¤„ç†
                    importedData = JSON.parse(content);
                    console.log('ğŸ“‹ æ£€æµ‹åˆ°JSONæ ¼å¼æ–‡ä»¶');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´å¯¼å‡ºæ ¼å¼ï¼ˆåŒ…å«nodeDetailsï¼‰
                    if (importedData.mindmap && importedData.nodeDetails) {
                        console.log('ğŸ“‹ æ£€æµ‹åˆ°å®Œæ•´å¯¼å‡ºæ ¼å¼ï¼ŒåŒ…å«èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯');
                        
                        // æ¢å¤èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯æ•°æ®åº“
                        Object.assign(nodeDatabase, importedData.nodeDetails);
                        hasNodeDetails = true;
                        
                        // ä½¿ç”¨æ€ç»´å¯¼å›¾æ•°æ®
                        importedData = importedData.mindmap;
                    }
                        
                    } else if (fileName.endsWith('.jm')) {
                        // jsMindåŸç”Ÿæ ¼å¼
                        importedData = JSON.parse(content);
                        console.log('ğŸ“‹ æ£€æµ‹åˆ°jsMindåŸç”Ÿæ ¼å¼æ–‡ä»¶');
                        
                    } else if (fileName.endsWith('.mm')) {
                        // FreeMindæ ¼å¼ï¼ˆç®€å•å¤„ç†ï¼‰
                        console.log('ğŸ“‹ æ£€æµ‹åˆ°FreeMindæ ¼å¼æ–‡ä»¶');
                        showMessage('âš ï¸ FreeMindæ ¼å¼éœ€è¦è½¬æ¢ï¼Œå½“å‰ç‰ˆæœ¬æš‚ä¸æ”¯æŒ');
                        return;
                        
                    } else {
                        // å°è¯•ä½œä¸ºJSONè§£æ
                        importedData = JSON.parse(content);
                        console.log('ğŸ“‹ ä½œä¸ºJSONæ ¼å¼å¤„ç†');
                    }
                    
                    // éªŒè¯å¯¼å…¥æ•°æ®æ ¼å¼
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('æ— æ•ˆçš„æ–‡ä»¶æ ¼å¼');
                    }
                    
                    // æ£€æŸ¥å¿…è¦çš„æ•°æ®ç»“æ„
                    if (!importedData.data || !importedData.data.id) {
                        throw new Error('æ–‡ä»¶ç¼ºå°‘å¿…è¦çš„æ€ç»´å¯¼å›¾æ•°æ®ç»“æ„');
                    }
                    
                    // æ˜¾ç¤ºå¯¼å…¥çš„æ€ç»´å¯¼å›¾
                    var currentMindmap = getCurrentJsMind();
                    currentMindmap.show(importedData);
                    
                    // åªæœ‰åœ¨æ²¡æœ‰å¯¼å…¥nodeDetailsæ—¶æ‰é‡æ–°åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®åº“
                    if (!hasNodeDetails) {
                        var rootNode = currentMindmap.get_node(importedData.data.id);
                        if (rootNode) {
                            traverseNode(rootNode);
                        }
                    }
                    
                    // è‡ªåŠ¨ä¿å­˜å¯¼å…¥çš„æ•°æ®
                    setTimeout(autoSaveData, 500);
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    updateSelectedNodeDisplay();
                    
                    // å¦‚æœæœ‰æ ¹èŠ‚ç‚¹ï¼Œé€‰ä¸­å®ƒ
                    if (rootNode) {
                        currentMindmap.select_node(rootNode.id);
                        showNodeDetails(rootNode.id);
                    }
                    
                    // è®°å½•å¯¼å…¥çš„æ–‡ä»¶è·¯å¾„ï¼Œå¯ç”¨è‡ªåŠ¨ä¿å­˜
                    lastSavedFilePath = {
                        handle: null, // å¯¼å…¥çš„æ–‡ä»¶æ— æ³•è·å–handle
                        name: file.name
                    };
                    localStorage.setItem(STORAGE_KEYS.LAST_SAVED_PATH, JSON.stringify({
                        name: file.name,
                        timestamp: new Date().toISOString(),
                        source: 'import'
                    }));
                    
                    showMessage('âœ… æ–‡ä»¶å¯¼å…¥æˆåŠŸ: ' + file.name);
                    console.log('âœ… æ–‡ä»¶å¯¼å…¥å®Œæˆï¼Œå·²å¯ç”¨è‡ªåŠ¨ä¿å­˜:', file.name);
                    
                } catch (error) {
                    console.error('âŒ æ–‡ä»¶å¯¼å…¥å¤±è´¥:', error);
                    showMessage('âŒ æ–‡ä»¶å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                console.error('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
                showMessage('âŒ æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            // å¼€å§‹è¯»å–æ–‡ä»¶
            reader.readAsText(file, 'UTF-8');
            
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            input.value = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            // é¦–å…ˆç¡®ä¿å¤šå·¥ä½œåŒºå·²æ­£ç¡®åˆå§‹åŒ–
            if (!mindmaps.workspace || !mindmaps.knowledge || !mindmaps.project) {
                console.log('é‡æ–°åˆå§‹åŒ–å¤šå·¥ä½œåŒº...');
                initMindmaps();
            }
            
            // å¯¼å‡ºåŠŸèƒ½å·²é€šè¿‡exportToCustomFileå‡½æ•°å®ç°
            
            // å°è¯•åŠ è½½ä¿å­˜çš„æ•°æ®
            var hasRecoveredData = loadSavedData();
            
            // å¦‚æœæ²¡æœ‰æ¢å¤æ•°æ®ï¼Œè¿›è¡Œæ­£å¸¸åˆå§‹åŒ–
            if (!hasRecoveredData) {
                // æ‰§è¡Œå·¥å…·åˆå§‹åŒ–å¹¶åˆå§‹åŒ–å½“å‰æ´»è·ƒå·¥ä½œåŒºçš„èŠ‚ç‚¹æ•°æ®åº“
                initializeNodeMindTool();
                initNodeDatabase();
                
                // æ˜¾ç¤ºé€‰ä¸­èŠ‚ç‚¹
                updateSelectedNodeDisplay();
                
                // å¦‚æœæœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                var selected = getCurrentJsMind().get_selected_node();
                if (selected) {
                    showNodeDetails(selected.id);
                }
            }
            
            // è®¾ç½®è‡ªåŠ¨ä¿å­˜
            setupAutoSave();
            
            // è·å–URLä¼ å…¥çš„é¡¹ç›®ä¿¡æ¯
            getProjectInfoFromURL();
            
            // åˆå§‹åŒ–æç¤ºè¯æ¨¡æ¿ç®¡ç†å™¨
            setTimeout(() => {
                initializeTemplateManager();
            }, 1000);
            
            // æ·»åŠ å…¨å±€é”®ç›˜äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', function(e) {
                // ESCé”®å…³é—­æ¨¡æ¿ç®¡ç†å™¨
                if (e.key === 'Escape') {
                    const templateModal = document.getElementById('template-manager-container');
                    if (templateModal && templateModal.style.display !== 'none') {
                        closeTemplateManager();
                        e.preventDefault();
                    }
                }
            });
            
            showMessage('ğŸ‰ jsMind æœ¬åœ°æ‹–æ‹½æ¼”ç¤ºå·²å¯åŠ¨ï¼');
            console.log('jsMind æœ¬åœ°æ‹–æ‹½ç‰ˆæœ¬æ¼”ç¤ºå·²å¯åŠ¨');
            console.log('ç‰ˆæœ¬: 0.8.7 (æœ¬åœ°ç‰ˆæœ¬)');
            console.log('æ‹–æ‹½åŠŸèƒ½: å·²å¯ç”¨');
            console.log('å½“å‰ä¸»é¢˜:', themes[currentThemeIndex].label);
        });

        // çŠ¶æ€æ ‡ç­¾ç›¸å…³å‡½æ•°ï¼ˆå·²ç®€åŒ–ï¼‰
        
        // ä¿®æ”¹åŸæœ‰çš„removeTagå‡½æ•°ä»¥æ”¯æŒæ–°çš„æ ‡ç­¾ç±»å‹
        function removeTag(nodeId, tagType, tagValue) {
            if (!nodeDatabase[nodeId] || !nodeDatabase[nodeId].tags[tagType]) return;
            
            var index = nodeDatabase[nodeId].tags[tagType].indexOf(tagValue);
            if (index > -1) {
                nodeDatabase[nodeId].tags[tagType].splice(index, 1);
                
                // æ›´æ–°ä¿®æ”¹æ—¶é—´
                nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
                
                // æ ¹æ®æ ‡ç­¾ç±»å‹åˆ·æ–°å¯¹åº”åŒºåŸŸ
                if (tagType === 'custom') {
                    refreshTagGroups(nodeId);
                } else if (tagType === 'future') {
                    refreshFutureTags(nodeId);
                } else {
                    // åŸæœ‰çš„æ ‡ç­¾ç±»å‹å¤„ç†
                    var tagContainer = document.getElementById(tagType + '_' + nodeId);
                    if (tagContainer) {
                        tagContainer.innerHTML = nodeDatabase[nodeId].tags[tagType].map(tag => 
                            `<span class="tag-item">${tag} <button type="button" onclick="removeTag('${nodeId}', '${tagType}', '${tag}')" class="tag-remove">Ã—</button></span>`
                        ).join('');
                    }
                }
                
                // è‡ªåŠ¨ä¿å­˜
                autoSaveData();
                
                console.log('ğŸ·ï¸ ç§»é™¤æ ‡ç­¾:', tagType, tagValue);
            }
        }

        // è®¾ç½®èŠ‚ç‚¹çŠ¶æ€
        function setNodeStatus(nodeId, status) {
            if (!nodeDatabase[nodeId]) return;
            
            // æ›´æ–°èŠ‚ç‚¹çŠ¶æ€
            nodeDatabase[nodeId].status = status;
            
            // æ›´æ–°ä¿®æ”¹æ—¶é—´
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
            // é‡æ–°æ¸²æŸ“è¯¦æƒ…é¢æ¿ä»¥æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if (document.getElementById('detail-info-content')) {
                renderDetailInfo(nodeId);
            }
            
            // è‡ªåŠ¨ä¿å­˜
            autoSaveData();
            
            showMessage(`âœ… èŠ‚ç‚¹çŠ¶æ€å·²è®¾ç½®ä¸º: ${status}`);
            console.log('ğŸ·ï¸ è®¾ç½®èŠ‚ç‚¹çŠ¶æ€:', nodeId, status);
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®å’Œå¸®åŠ©
        document.addEventListener('keydown', function(e) {
            // å¯¼å‡ºåŠŸèƒ½å¿«æ·é”®å·²ç§»é™¤ï¼Œå°†åœ¨åç»­å¼€å‘ä¸­å®ç°
            
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                triggerImport();
                return;
            }
            
            // å¸®åŠ©å¿«æ·é”®
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                alert('jsMind æ‹–æ‹½æ¼”ç¤º - å¿«æ·é”®å¸®åŠ©:\n\nåŸºæœ¬æ“ä½œ:\nâ€¢ Ctrl+Enter - æ·»åŠ å­èŠ‚ç‚¹\nâ€¢ Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹\nâ€¢ F2 - ç¼–è¾‘èŠ‚ç‚¹å†…å®¹\nâ€¢ Delete - åˆ é™¤èŠ‚ç‚¹\nâ€¢ Space - å±•å¼€/æ”¶èµ·èŠ‚ç‚¹\nâ€¢ æ–¹å‘é”® - é€‰æ‹©ç›¸é‚»èŠ‚ç‚¹\n\næ–‡ä»¶æ“ä½œ:\nâ€¢ Ctrl+O - å¯¼å…¥æ–‡ä»¶ï¼ˆæ”¯æŒJSON/JM/MMæ ¼å¼ï¼‰\n\næ‹–æ‹½æ“ä½œ:\nâ€¢ é¼ æ ‡å·¦é”®æ‹–æ‹½èŠ‚ç‚¹ç§»åŠ¨\nâ€¢ æ‹–æ‹½åˆ°ç›®æ ‡èŠ‚ç‚¹ä¸Šé‡Šæ”¾\nâ€¢ æ”¯æŒè·¨åˆ†æ”¯æ‹–æ‹½\nâ€¢ å®æ—¶è§†è§‰åé¦ˆ\n\nCtrl+H - æ˜¾ç¤ºæ­¤å¸®åŠ©');
            }
        });

        // ===== æ ‡ç­¾åŠŸèƒ½ï¼ˆæ— é¢œè‰²ï¼‰ =====
        
        // åˆ‡æ¢çŠ¶æ€æ ‡ç­¾ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        function toggleStatusTag(nodeId, tag) {
            if (!nodeDatabase[nodeId]) return;
            
            // ç¡®ä¿statusTagsæ•°ç»„å­˜åœ¨
            if (!nodeDatabase[nodeId].statusTags) {
                nodeDatabase[nodeId].statusTags = [];
            }
            
            var statusTags = nodeDatabase[nodeId].statusTags;
            var index = statusTags.indexOf(tag);
            
            if (index > -1) {
                // ç§»é™¤æ ‡ç­¾
                statusTags.splice(index, 1);
                showMessage(`ğŸ·ï¸ ç§»é™¤æ ‡ç­¾: ${tag}`);
            } else {
                // æ·»åŠ æ ‡ç­¾
                statusTags.push(tag);
                showMessage(`ğŸ·ï¸ æ·»åŠ æ ‡ç­¾: ${tag}`);
            }
            
            // æ›´æ–°ä¿®æ”¹æ—¶é—´
            nodeDatabase[nodeId].time.modified = new Date().toLocaleString();
            
            // å®æ—¶æ›´æ–°è¯¦æƒ…é¢æ¿ä¸­çš„çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
            updateCurrentNodeStatusTagsDisplay(nodeId);
            
            // æ›´æ–°æ ‡ç­¾ç®¡ç†é€‰é¡¹å¡ä¸­çš„å½“å‰èŠ‚ç‚¹çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
            updateCurrentNodeStatusTags(nodeId);
            
            // æ›´æ–°æ‰©å±•åŒºåŸŸä¸­çš„å½“å‰èŠ‚ç‚¹çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
            updateCurrentNodeStatusTagsExtension(nodeId);
            
            // è‡ªåŠ¨ä¿å­˜
            autoSaveData();
            
            // å¦‚æœæœ‰å·²çŸ¥æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿä¿å­˜åˆ°æ–‡ä»¶
            if (lastSavedFilePath && lastSavedFilePath.handle) {
                setTimeout(autoSaveToFile, 100);
            }
            
            console.log('ğŸ·ï¸ èŠ‚ç‚¹æ ‡ç­¾æ›´æ–°:', nodeId, statusTags);
        }
        
        // æ›´æ–°æ ‡ç­¾ç®¡ç†é€‰é¡¹å¡ä¸­çš„å½“å‰èŠ‚ç‚¹çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
        function updateCurrentNodeStatusTags(nodeId) {
            var container = document.getElementById('current-node-status-tags');
            if (!container || !nodeDatabase[nodeId]) return;
            
            var statusTags = nodeDatabase[nodeId].statusTags || [];
            
            if (statusTags.length === 0) {
                container.innerHTML = '<div class="empty-state-small">æš‚æ— çŠ¶æ€æ ‡ç­¾</div>';
                return;
            }
            
            var tagsHtml = statusTags.map(function(tag) {
                return `<div class="status-tag-item active" onclick="toggleStatusTag('${nodeId}', '${tag}')">${tag}</div>`;
            }).join('');
            
            container.innerHTML = tagsHtml;
        }
        
        // æ›´æ–°æ‰©å±•åŒºåŸŸä¸­çš„å½“å‰èŠ‚ç‚¹çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
        function updateCurrentNodeStatusTagsExtension(nodeId) {
            var container = document.getElementById('current-node-status-tags-extension');
            if (!container || !nodeDatabase[nodeId]) return;
            
            var statusTags = nodeDatabase[nodeId].statusTags || [];
            
            if (statusTags.length === 0) {
                container.innerHTML = '<div class="empty-state-small">æš‚æ— çŠ¶æ€æ ‡ç­¾</div>';
                return;
            }
            
            var tagsHtml = statusTags.map(function(tag) {
                return `<div class="status-tag-item active" onclick="toggleStatusTag('${nodeId}', '${tag}')">${tag}</div>`;
            }).join('');
            
            container.innerHTML = tagsHtml;
        }

        // æ³¨æ„ï¼šsetNodeStatuså‡½æ•°å·²åœ¨ä¸Šæ–¹å®šä¹‰ï¼Œæ­¤å¤„ä¸å†é‡å¤å£°æ˜

        // ===== é¡¹ç›®å‚æ•°ç®¡ç†åŠŸèƒ½ =====
        
        // å…¨å±€å˜é‡å­˜å‚¨é¡¹ç›®ä¿¡æ¯
        var projectInfo = {
            name: '',
            path: ''
        };
        
        // ä»URLå‚æ•°è·å–é¡¹ç›®ä¿¡æ¯
        function getProjectInfoFromURL() {
            var urlParams = new URLSearchParams(window.location.search);
            var projectName = urlParams.get('projectName') || urlParams.get('project_name') || urlParams.get('name');
            var projectPath = urlParams.get('projectPath') || urlParams.get('project_path') || urlParams.get('path');
            
            console.log('ğŸ” æ£€æŸ¥URLå‚æ•°:', {
                'projectName': urlParams.get('projectName'),
                'project_name': urlParams.get('project_name'),
                'name': urlParams.get('name'),
                'projectPath': urlParams.get('projectPath'),
                'project_path': urlParams.get('project_path'),
                'path': urlParams.get('path'),
                'fullURL': window.location.href
            });
            
            if (projectName) {
                projectInfo.name = decodeURIComponent(projectName);
            }
            if (projectPath) {
                projectInfo.path = decodeURIComponent(projectPath);
                
                // å¦‚æœæ²¡æœ‰é¡¹ç›®åç§°ä½†æœ‰è·¯å¾„ï¼Œä»è·¯å¾„ä¸­æå–é¡¹ç›®åç§°ï¼ˆçº¦å®šï¼šé¡¹ç›®åç§°=æ–‡ä»¶å¤¹åç§°ï¼‰
                if (!projectInfo.name && projectPath) {
                    var pathParts = projectInfo.path.replace(/\\/g, '/').split('/');
                    var folderName = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
                    if (folderName) {
                        projectInfo.name = folderName;
                        console.log('ğŸ“‹ ä»è·¯å¾„æå–é¡¹ç›®åç§°:', folderName);
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰ä»URLè·å–åˆ°å‚æ•°ï¼Œè®¾ç½®é»˜è®¤å€¼ç”¨äºæ¼”ç¤º
            if (!projectInfo.name && !projectInfo.path) {
                projectInfo.name = 'nodemind';
                projectInfo.path = '/d:/AI-Projects/nodemind';
                console.log('ğŸ“‹ ä½¿ç”¨é»˜è®¤é¡¹ç›®ä¿¡æ¯è¿›è¡Œæ¼”ç¤º');
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateProjectInfoDisplay();
            
            console.log('ğŸ“‹ é¡¹ç›®ä¿¡æ¯å·²è·å–:', projectInfo);
        }
        
        // æ›´æ–°é¡¹ç›®ä¿¡æ¯æ˜¾ç¤º
        function updateProjectInfoDisplay() {
            // ä½¿ç”¨querySelectorAllæ›´æ–°æ‰€æœ‰ç›¸åŒIDçš„å…ƒç´ ï¼ˆä¿®å¤é‡å¤IDé—®é¢˜ï¼‰
            var nameElements = document.querySelectorAll('#project-name-display');
            var pathElements = document.querySelectorAll('#project-path-display');
            
            console.log('ğŸ”„ æ›´æ–°é¡¹ç›®ä¿¡æ¯æ˜¾ç¤º:', {
                'projectInfo': projectInfo,
                'nameElements': nameElements.length,
                'pathElements': pathElements.length
            });
            
            // æ›´æ–°æ‰€æœ‰é¡¹ç›®åç§°æ˜¾ç¤ºå…ƒç´ 
            nameElements.forEach(function(element) {
                element.textContent = projectInfo.name || 'æœªè®¾ç½®';
                element.title = projectInfo.name || 'æœªè®¾ç½®';
            });
            
            // æ›´æ–°æ‰€æœ‰é¡¹ç›®è·¯å¾„æ˜¾ç¤ºå…ƒç´ 
            pathElements.forEach(function(element) {
                element.textContent = projectInfo.path || 'æœªè®¾ç½®';
                element.title = projectInfo.path || 'æœªè®¾ç½®';
            });
            
            if (nameElements.length > 0 || pathElements.length > 0) {
                console.log('âœ… é¡¹ç›®ä¿¡æ¯æ˜¾ç¤ºå·²æ›´æ–°:', {
                    'name': projectInfo.name,
                    'path': projectInfo.path,
                    'updatedElements': nameElements.length + pathElements.length
                });
            } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ°é¡¹ç›®ä¿¡æ¯æ˜¾ç¤ºå…ƒç´ ');
            }
        }
        
        // è¾“å…¥æ ¡å‡†åŠŸèƒ½ï¼ˆé¢„ç•™æ¥å£ï¼‰
        function performInputCalibration() {
            showMessage('ğŸ¯ è¾“å…¥æ ¡å‡†åŠŸèƒ½å¼€å‘ä¸­...');
            console.log('ğŸ¯ è¾“å…¥æ ¡å‡†åŠŸèƒ½è¢«è°ƒç”¨');
            console.log('å½“å‰é¡¹ç›®ä¿¡æ¯:', projectInfo);
            
            // TODO: åœ¨è¿™é‡Œå®ç°å…·ä½“çš„è¾“å…¥æ ¡å‡†é€»è¾‘
            // å¯èƒ½åŒ…æ‹¬ï¼š
            // - éªŒè¯é¡¹ç›®è·¯å¾„æ˜¯å¦æœ‰æ•ˆ
            // - æ ¡å‡†è¾“å…¥å‚æ•°æ ¼å¼
            // - åŒæ­¥é¡¹ç›®é…ç½®
            // - é‡æ–°åŠ è½½é¡¹ç›®æ•°æ®ç­‰
        }
        
        // ===== æç¤ºè¯æ¨¡æ¿ç®¡ç†åŠŸèƒ½ =====
        
        // å…¨å±€æ¨¡æ¿ç®¡ç†å™¨å®ä¾‹
        var templateManager = null;
        
        // åˆå§‹åŒ–æç¤ºè¯æ¨¡æ¿ç®¡ç†å™¨
        async function initializeTemplateManager() {
            try {
                // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
                if (!checkBrowserCompatibility()) {
                    console.error('âŒ æµè§ˆå™¨ä¸å…¼å®¹ï¼Œæ— æ³•åˆå§‹åŒ–æ¨¡æ¿ç®¡ç†å™¨');
                    return;
                }
                
                // æŸ¥æ‰¾æ¨¡æ¿ç®¡ç†å™¨å®¹å™¨ï¼ˆä½¿ç”¨modal-bodyä½œä¸ºå®¹å™¨ï¼‰
                const container = document.querySelector('#template-manager-container .modal-body');
                if (!container) {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°æ¨¡æ¿ç®¡ç†å™¨å®¹å™¨');
                    return;
                }
                
                // åˆ›å»ºæ¨¡æ¿ç®¡ç†å™¨å®ä¾‹
                templateManager = createTemplateManager(container);
                
                // ç›‘å¬æ¨¡æ¿ç®¡ç†å™¨äº‹ä»¶
                templateManager.addEventListener('templateManagerReady', (event) => {
                    console.log('ğŸ‰ æ¨¡æ¿ç®¡ç†å™¨å°±ç»ª:', event.detail);
                    showMessage('ğŸ“ æç¤ºè¯æ¨¡æ¿ç®¡ç†å™¨å·²å¯åŠ¨');
                });
                
                templateManager.addEventListener('templateManagerError', (event) => {
                    console.error('âŒ æ¨¡æ¿ç®¡ç†å™¨é”™è¯¯:', event.detail);
                    showMessage('âŒ æ¨¡æ¿ç®¡ç†å™¨å¯åŠ¨å¤±è´¥', 'error');
                });
                
                // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('åˆå§‹åŒ–è¶…æ—¶'));
                    }, 5000);
                    
                    templateManager.addEventListener('templateManagerReady', () => {
                        clearTimeout(timeout);
                        resolve();
                    });
                    
                    templateManager.addEventListener('templateManagerError', (event) => {
                        clearTimeout(timeout);
                        reject(new Error(event.detail.error));
                    });
                });
                
                console.log('ğŸš€ æ¨¡æ¿ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–æ¨¡æ¿ç®¡ç†å™¨å¤±è´¥:', error);
                showMessage('âŒ æ¨¡æ¿ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }
        
        // æ‰“å¼€æ¨¡æ¿ç®¡ç†å™¨
        async function openTemplateManager() {
            console.log('ğŸ”§ æ‰“å¼€æ¨¡æ¿ç®¡ç†å™¨...');
            
            // æ˜¾ç¤ºæ¨¡æ¿ç®¡ç†å™¨å®¹å™¨
            const container = document.getElementById('template-manager-container');
            if (container) {
                console.log('âœ… æ‰¾åˆ°æ¨¡æ¿ç®¡ç†å™¨å®¹å™¨ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†');
                container.style.display = 'block';
                
                // æ£€æŸ¥æ¨¡æ€æ¡†å¤´éƒ¨æ˜¯å¦å­˜åœ¨
                const header = container.querySelector('.modal-header');
                const backBtn = container.querySelector('.back-btn');
                console.log('ğŸ“‹ æ¨¡æ€æ¡†å¤´éƒ¨:', header ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                console.log('ğŸ”™ è¿”å›æŒ‰é’®:', backBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            } else {
                console.error('âŒ æœªæ‰¾åˆ°æ¨¡æ¿ç®¡ç†å™¨å®¹å™¨');
                return;
            }
            
            if (!templateManager) {
                console.log('ğŸ”§ åˆå§‹åŒ–æ¨¡æ¿ç®¡ç†å™¨...');
                await initializeTemplateManager();
                return;
            }
            
            // é‡æ–°åŠ è½½æ•°æ®
            templateManager.reload();
        }
        
        // å…³é—­æ¨¡æ¿ç®¡ç†å™¨
        function closeTemplateManager() {
            const container = document.getElementById('template-manager-container');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        // æµ‹è¯•æ¨¡æ€æ¡†æ˜¾ç¤ºï¼ˆè°ƒè¯•ç”¨ï¼‰
        function testModal() {
            console.log('ğŸ§ª æµ‹è¯•æ¨¡æ€æ¡†æ˜¾ç¤º...');
            const container = document.getElementById('template-manager-container');
            if (container) {
                container.style.display = 'block';
                console.log('âœ… æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                
                // æ£€æŸ¥å„ä¸ªå…ƒç´ 
                const header = container.querySelector('.modal-header');
                const headerLeft = container.querySelector('.modal-header-left');
                const backBtn = container.querySelector('.back-btn');
                const title = container.querySelector('.modal-header h3');
                const closeBtn = container.querySelector('.close-btn');
                
                console.log('ğŸ“‹ æ¨¡æ€æ¡†å¤´éƒ¨:', header ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                console.log('ğŸ“‹ å¤´éƒ¨å·¦ä¾§:', headerLeft ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                console.log('ğŸ”™ è¿”å›æŒ‰é’®:', backBtn ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                console.log('ğŸ“ æ ‡é¢˜:', title ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                console.log('âŒ å…³é—­æŒ‰é’®:', closeBtn ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                
                if (backBtn) {
                    const styles = window.getComputedStyle(backBtn);
                    console.log('ğŸ”™ è¿”å›æŒ‰é’®æ ·å¼:');
                    console.log('  - display:', styles.display);
                    console.log('  - visibility:', styles.visibility);
                    console.log('  - opacity:', styles.opacity);
                    console.log('  - z-index:', styles.zIndex);
                    console.log('  - position:', styles.position);
                }
            } else {
                console.error('âŒ æœªæ‰¾åˆ°æ¨¡æ€æ¡†å®¹å™¨');
            }
        }
        
        // å¿«é€Ÿä½¿ç”¨æ¨¡æ¿
        function quickUseTemplate(templateId, variables = {}) {
            if (!templateManager) {
                showMessage('âŒ æ¨¡æ¿ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                const processedTemplate = templateManager.processTemplate(templateId, variables);
                if (processedTemplate) {
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    templateManager.copyTemplateToClipboard(templateId, variables);
                    showMessage('ğŸ“‹ æ¨¡æ¿å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    
                    return processedTemplate.processedContent;
                }
            } catch (error) {
                console.error('âŒ ä½¿ç”¨æ¨¡æ¿å¤±è´¥:', error);
                showMessage('âŒ ä½¿ç”¨æ¨¡æ¿å¤±è´¥', 'error');
            }
            
            return null;
        }
        
        // è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨ï¼‰
        function getAvailableTemplates() {
            if (!templateManager) {
                return [];
            }
            
            return templateManager.getAllTemplates();
        }
        
        // æœç´¢æ¨¡æ¿
        function searchTemplates(query) {
            if (!templateManager) {
                return [];
            }
            
            return templateManager.searchTemplates(query);
        }
        
        // å¤„ç†æ¨¡æ¿æœç´¢
        function handleTemplateSearch(query) {
            if (!query.trim()) {
                // å¦‚æœæœç´¢ä¸ºç©ºï¼Œæ˜¾ç¤ºé»˜è®¤çš„å¿«é€Ÿæ¨¡æ¿
                updateQuickTemplates();
                return;
            }
            
            const results = searchTemplates(query);
            updateQuickTemplatesWithResults(results);
        }
        
        // æ›´æ–°å¿«é€Ÿæ¨¡æ¿æ˜¾ç¤º
        function updateQuickTemplates() {
            const container = document.getElementById('quick-templates');
            if (!container) return;
            
            container.innerHTML = `
                <div class="template-item" onclick="quickUseTemplate('code_review')">
                    <span class="template-icon">ğŸ”</span>
                    <span class="template-name">ä»£ç å®¡æŸ¥</span>
                </div>
                <div class="template-item" onclick="quickUseTemplate('bug_analysis')">
                    <span class="template-icon">ğŸ›</span>
                    <span class="template-name">Bugåˆ†æ</span>
                </div>
                <div class="template-item" onclick="quickUseTemplate('feature_design')">
                    <span class="template-icon">ğŸ¨</span>
                    <span class="template-name">åŠŸèƒ½è®¾è®¡</span>
                </div>
                <div class="template-item" onclick="quickUseTemplate('documentation')">
                    <span class="template-icon">ğŸ“š</span>
                    <span class="template-name">æ–‡æ¡£ç¼–å†™</span>
                </div>
            `;
        }
        
        // ä½¿ç”¨æœç´¢ç»“æœæ›´æ–°å¿«é€Ÿæ¨¡æ¿
        function updateQuickTemplatesWithResults(results) {
            const container = document.getElementById('quick-templates');
            if (!container) return;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #6c757d;">
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”</div>
                        <div>æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡æ¿</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = results.slice(0, 4).map(template => `
                <div class="template-item" onclick="quickUseTemplate('${template.id}')">
                    <span class="template-icon">${getTemplateIcon(template.category)}</span>
                    <span class="template-name">${template.name}</span>
                </div>
            `).join('');
        }
        
        // æ ¹æ®åˆ†ç±»è·å–æ¨¡æ¿å›¾æ ‡
        function getTemplateIcon(category) {
            const icons = {
                'development': 'ğŸ’»',
                'design': 'ğŸ¨',
                'analysis': 'ğŸ“Š',
                'documentation': 'ğŸ“š',
                'testing': 'ğŸ§ª',
                'planning': 'ğŸ“‹',
                'communication': 'ğŸ’¬'
            };
            return icons[category] || 'ğŸ“';
        }

        // ===== æ‰©å±•åŒºåŸŸæŠ˜å åŠŸèƒ½ =====
        
        // åˆ‡æ¢æ‰©å±•åŒºåŸŸæŠ˜å çŠ¶æ€
        function toggleExtensionPanel() {
            var detailsPanel = document.querySelector('.details-panel');
            var extensionPanel = document.querySelector('.details-panel-right');
            var toggleBtn = document.getElementById('extensionToggleBtn');
            
            if (detailsPanel.classList.contains('extension-collapsed')) {
                // å±•å¼€æ‰©å±•åŒºåŸŸ
                detailsPanel.classList.remove('extension-collapsed');
                extensionPanel.classList.remove('collapsed');
                toggleBtn.innerHTML = 'â—€ æŠ˜å æ‰©å±•åŒº';
                showMessage('ğŸ“– æ‰©å±•åŒºåŸŸå·²å±•å¼€');
            } else {
                // æŠ˜å æ‰©å±•åŒºåŸŸ
                detailsPanel.classList.add('extension-collapsed');
                extensionPanel.classList.add('collapsed');
                toggleBtn.innerHTML = 'â–¶ å±•å¼€æ‰©å±•åŒº';
                showMessage('ğŸ“• æ‰©å±•åŒºåŸŸå·²æŠ˜å ');
            }
            
            // å»¶è¿Ÿè°ƒæ•´è„‘å›¾å¤§å°ä»¥é€‚åº”æ–°çš„å¸ƒå±€
            setTimeout(function() {
                updateLayoutHeight();
                var currentMindmap = getCurrentJsMind();
                if (currentMindmap) {
                    currentMindmap.resize();
                }
            }, 350);
        }

        // ===== URLå‚æ•°å¤„ç†åŠŸèƒ½ =====
        
        // è§£æURLå‚æ•°å¹¶æ›´æ–°é¡¹ç›®ä¿¡æ¯
        function parseURLParamsAndUpdateProject() {
            try {
                // è·å–URLå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                
                console.log('ğŸ”— è§£æURLå‚æ•°...');
                console.log('å®Œæ•´URL:', window.location.href);
                
                // è·å–é¡¹ç›®ä¿¡æ¯å‚æ•°
                const projectId = urlParams.get('id');
                const projectTitle = urlParams.get('title');
                const projectName = urlParams.get('name');
                const projectPath = urlParams.get('path');
                const defaultPanel = urlParams.get('panel');
                const mindmapTab = urlParams.get('mindmap_tab');
                
                console.log('URLå‚æ•°è§£æç»“æœ:');
                console.log('- é¡¹ç›®ID:', projectId);
                console.log('- é¡¹ç›®æ ‡é¢˜:', projectTitle);
                console.log('- é¡¹ç›®åç§°:', projectName);
                console.log('- é¡¹ç›®è·¯å¾„:', projectPath);
                console.log('- é»˜è®¤é¢æ¿:', defaultPanel);
                console.log('- è„‘å›¾é€‰é¡¹å¡:', mindmapTab);
                
                // æ›´æ–°projectInfoå¯¹è±¡ï¼ˆå…³é”®ä¿®å¤ï¼‰
                if (projectName || projectTitle) {
                    projectInfo.name = projectName || projectTitle;
                    console.log('âœ… projectInfo.name å·²æ›´æ–°:', projectInfo.name);
                }
                if (projectPath) {
                    projectInfo.path = decodeURIComponent(projectPath);
                    console.log('âœ… projectInfo.path å·²æ›´æ–°:', projectInfo.path);
                    
                    // å¦‚æœæ²¡æœ‰é¡¹ç›®åç§°ä½†æœ‰è·¯å¾„ï¼Œä»è·¯å¾„ä¸­æå–é¡¹ç›®åç§°
                    if (!projectInfo.name && projectPath) {
                        var pathParts = projectInfo.path.replace(/\\/g, '/').split('/');
                        var folderName = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
                        if (folderName) {
                            projectInfo.name = folderName;
                            console.log('ğŸ“‹ ä»è·¯å¾„æå–é¡¹ç›®åç§°:', folderName);
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰ä»URLè·å–åˆ°å‚æ•°ï¼Œè®¾ç½®é»˜è®¤å€¼
                if (!projectInfo.name && !projectInfo.path) {
                    projectInfo.name = 'nodemind';
                    projectInfo.path = 'D:/AI-Projects/nodemind';
                    console.log('ğŸ“‹ ä½¿ç”¨é»˜è®¤é¡¹ç›®ä¿¡æ¯');
                }
                
                console.log('ğŸ“‹ æœ€ç»ˆprojectInfoå¯¹è±¡:', projectInfo);
                
                // æ›´æ–°é¡¹ç›®åç§°æ˜¾ç¤ºï¼ˆæ›´æ–°æ‰€æœ‰å…·æœ‰è¯¥IDçš„å…ƒç´ ï¼‰
                const projectNameDisplays = document.querySelectorAll('#project-name-display');
                const displayName = projectInfo.name || 'æœªè®¾ç½®';
                if (projectNameDisplays.length > 0) {
                    projectNameDisplays.forEach(element => {
                        element.textContent = displayName;
                    });
                    console.log('âœ… é¡¹ç›®åç§°æ˜¾ç¤ºå·²æ›´æ–°:', displayName, `(æ›´æ–°äº†${projectNameDisplays.length}ä¸ªå…ƒç´ )`);
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°é¡¹ç›®åç§°æ˜¾ç¤ºå…ƒç´ ');
                }
                
                // æ›´æ–°é¡¹ç›®è·¯å¾„æ˜¾ç¤ºï¼ˆæ›´æ–°æ‰€æœ‰å…·æœ‰è¯¥IDçš„å…ƒç´ ï¼‰
                const projectPathDisplays = document.querySelectorAll('#project-path-display');
                const displayPath = projectInfo.path || 'æœªè®¾ç½®';
                if (projectPathDisplays.length > 0) {
                    projectPathDisplays.forEach(element => {
                        element.textContent = displayPath;
                    });
                    console.log('âœ… é¡¹ç›®è·¯å¾„æ˜¾ç¤ºå·²æ›´æ–°:', displayPath, `(æ›´æ–°äº†${projectPathDisplays.length}ä¸ªå…ƒç´ )`);
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°é¡¹ç›®è·¯å¾„æ˜¾ç¤ºå…ƒç´ ');
                }
                
                // æ ¹æ®å‚æ•°è®¾ç½®é»˜è®¤æ‰“å¼€çš„é¢æ¿
                if (defaultPanel) {
                    setTimeout(() => {
                        switchTab(defaultPanel);
                        console.log('âœ… å·²åˆ‡æ¢åˆ°é»˜è®¤é¢æ¿:', defaultPanel);
                    }, 100);
                }
                
                // æ ¹æ®å‚æ•°æ¿€æ´»è„‘å›¾é€‰é¡¹å¡
                if (mindmapTab) {
                    setTimeout(() => {
                        switchMindmapTab(mindmapTab);
                        console.log('âœ… å·²æ¿€æ´»è„‘å›¾é€‰é¡¹å¡:', mindmapTab);
                    }, 200);
                }
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                if (projectName || projectTitle || projectPath) {
                    setTimeout(() => {
                        showMessage(`ğŸ“‹ é¡¹ç›®ä¿¡æ¯å·²åŠ è½½: ${projectName || projectTitle || 'æœªå‘½åé¡¹ç›®'}`);
                    }, 500);
                }
                
            } catch (error) {
                console.error('âŒ URLå‚æ•°è§£æå¤±è´¥:', error);
                showMessage('âŒ é¡¹ç›®ä¿¡æ¯åŠ è½½å¤±è´¥', 'error');
            }
        }
        
        // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // é¡µé¢åŠ è½½å®Œæˆåè§£æURLå‚æ•°
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è§£æURLå‚æ•°...');
            parseURLParamsAndUpdateProject();
            
            // åˆå§‹åŒ–åŸºæœ¬ä¿¡æ¯é€‰é¡¹å¡å†…å®¹
            setTimeout(function() {
                renderBasicInfo('init'); // ä¼ å…¥ç‰¹æ®Šå‚æ•°è¡¨ç¤ºåˆå§‹åŒ–
                console.log('ğŸ”„ é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åŸºæœ¬ä¿¡æ¯é€‰é¡¹å¡');
            }, 100);
            
            // è®¾ç½®å®šæœŸæ›´æ–°é¡¹ç›®ä¿¡æ¯æ˜¾ç¤ºï¼ˆé˜²æ­¢è¢«å…¶ä»–å‡½æ•°è¦†ç›–ï¼‰
            setInterval(function() {
                // åªæœ‰å½“projectInfoæœ‰æœ‰æ•ˆæ•°æ®æ—¶æ‰æ›´æ–°
                if (projectInfo.name && projectInfo.name !== 'æœªè®¾ç½®') {
                    updateProjectInfoDisplay();
                }
            }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
            
            const tagItems = document.querySelectorAll('.tag-item');
            tagItems.forEach(tag => {
                tag.addEventListener('click', function() {
                    const tagText = this.textContent.trim();
                    const tagType = this.classList.contains('tag-yellow') ? 'normal' :
                                  this.classList.contains('tag-green') ? 'ai' :
                                  this.classList.contains('tag-blue') ? 'note' : 'other';
                    
                    // åˆ‡æ¢æ ‡ç­¾é€‰ä¸­çŠ¶æ€
                    this.classList.toggle('selected');
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ ‡ç­¾ç­›é€‰é€»è¾‘
                    console.log(`æ ‡ç­¾ç‚¹å‡»ï¼š${tagText}ï¼Œç±»å‹ï¼š${tagType}`);
                });
            });
        });
            </script>