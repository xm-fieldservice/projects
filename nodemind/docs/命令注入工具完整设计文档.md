# å‘½ä»¤æ³¨å…¥å·¥å…·å®Œæ•´è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

å‘½ä»¤æ³¨å…¥å·¥å…·æ˜¯ä¸€ä¸ªåŸºäºPyQt5çš„æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œä¸“é—¨ç”¨äºå°†ç”¨æˆ·å‘½ä»¤é€šè¿‡Windows APIæ³¨å…¥åˆ°æŒ‡å®šçš„ç›®æ ‡åº”ç”¨ç¨‹åºä¸­ã€‚è¯¥å·¥å…·æ”¯æŒæ¨¡æ¿ç³»ç»Ÿã€é¡¹ç›®ç®¡ç†ã€æ™ºèƒ½æ ¡å‡†ç­‰é«˜çº§åŠŸèƒ½ã€‚

## æ ¸å¿ƒæ¶æ„å›¾

```
CommandInjectionTool
â”œâ”€â”€ æ ¸å¿ƒæ¨¡å— (MainWindow)
â”‚   â”œâ”€â”€ ä¸»å…¥å£ä½ç½®ç®¡ç†
â”‚   â”œâ”€â”€ æ³¨å…¥åŠŸèƒ½å®ç°
â”‚   â””â”€â”€ æ ¡å‡†å’Œé¡¹ç›®ä¿¡æ¯
â”œâ”€â”€ æ¨¡æ¿ç®¡ç† (TemplateManager)
â”‚   â”œâ”€â”€ åœºæ™¯æ¨¡æ¿ç®¡ç†
â”‚   â”œâ”€â”€ å¢åˆ æ”¹æ“ä½œ
â”‚   â””â”€â”€ æ¨¡æ¿åº”ç”¨é€»è¾‘
â”œâ”€â”€ é¡¹ç›®ç®¡ç† (ProjectManager)
â”‚   â”œâ”€â”€ é¡¹ç›®é€‰æ‹©
â”‚   â”œâ”€â”€ å¤šé¡¹ç›®æ”¯æŒ
â”‚   â””â”€â”€ å®ä¾‹å†²çªæ£€æµ‹
â”œâ”€â”€ å…¶ä»–åŠŸèƒ½
â”‚   â”œâ”€â”€ éšå›¾èŠ‚ç‚¹ç›´æ¥æ³¨å…¥
â”‚   â”œâ”€â”€ å¤šé¡¹ç›®éšå›¾æ”¯æŒ
â”‚   â””â”€â”€ æ—¥å¿—è®°å½•ç®¡ç†
â””â”€â”€ è¾…åŠ©æ¨¡å—
    â”œâ”€â”€ UIå¸ƒå±€ç®¡ç† (LayoutManager)
    â”œâ”€â”€ çƒ­é‡è½½ç®¡ç† (HotReloadManager)
    â””â”€â”€ çª—å£ç®¡ç† (WindowManager)
```

## 1. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾è®¡

### 1.1 ä¸»å…¥å£ä½ç½®ç®¡ç†

**åŠŸèƒ½æè¿°**: ç®¡ç†æ³¨å…¥å·¥å…·çš„ä¸»çª—å£æ˜¾ç¤ºå’Œä½ç½®

**æ ¸å¿ƒå®ç°**:
```python
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.instance_id = get_persistent_instance_id()
        self.target_window = None
        self.target_position = None
        self.target_window_title = ""
        self.project_folder = None
        self.project_name = None
        self.log_file = None
        
    def setup_custom_title_bar(self):
        # è‡ªå®šä¹‰æ ‡é¢˜æ è®¾ç½®
        self.setWindowFlags(Qt.FramelessWindowHint)
        # æ·»åŠ æœ€å°åŒ–ã€æœ€å¤§åŒ–ã€å…³é—­æŒ‰é’®
        
    def toggle_maximize(self):
        # çª—å£æœ€å¤§åŒ–/è¿˜åŸåŠŸèƒ½
        if self.isMaximized():
            self.showNormal()
        else:
            self.showMaximized()
```

### 1.2 æ³¨å…¥åŠŸèƒ½æ ¸å¿ƒå®ç°

**åŠŸèƒ½æè¿°**: å°†å‘½ä»¤æ³¨å…¥åˆ°ç›®æ ‡åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒé€»è¾‘

**æŠ€æœ¯è¦ç‚¹**:
- ä½¿ç”¨Win32 APIè¿›è¡Œçª—å£æ“ä½œ
- å‰ªè´´æ¿æ“ä½œå’Œé”®ç›˜æ¨¡æ‹Ÿ
- ç›®æ ‡çª—å£æ¿€æ´»å’Œå®šä½

**æ ¸å¿ƒå®ç°**:
```python
def inject_command(self):
    """ç»Ÿä¸€çš„å‘½ä»¤æ³¨å…¥å®ç°"""
    
    # 1. åŸºç¡€æ ¡éªŒ
    if not self.target_window or not self.target_position:
        QMessageBox.warning(self, "é”™è¯¯", "è¯·å…ˆæ ¡å‡†ç›®æ ‡çª—å£")
        return
    
    # 2. ç¡®ä¿é¡¹ç›®çª—å£åœ¨å‰æ™¯
    if not self.ensure_project_window_active():
        return
        
    # 3. è·å–å’Œå¤„ç†å‘½ä»¤
    command = self.command_input.toPlainText().strip()
    project_name = self.get_cursor_project_name()
    
    # 4. æ™ºèƒ½ç©ºå‘½ä»¤æ£€æŸ¥
    has_template = self.check_template_availability()
    if not command and not has_template:
        QMessageBox.warning(self, "é”™è¯¯", "è¯·è¾“å…¥å‘½ä»¤æˆ–è®¾ç½®åŒ…å«å†…å®¹çš„æ¨¡æ¿")
        return
    
    # 5. åº”ç”¨æ¨¡æ¿å¤„ç†
    final_command = self.apply_template(command, project_name)
    
    try:
        # 6. æ‰§è¡Œæ³¨å…¥æ“ä½œ
        self.perform_injection(final_command)
        
        # 7. è®°å½•æ—¥å¿—
        self.log_injection_result(command, final_command)
        
        # 8. å®Œæˆæ“ä½œ
        self.clear_command()
        self.show_mini_notification("å‘½ä»¤å·²æ³¨å…¥")
        
    except Exception as e:
        QMessageBox.critical(self, "é”™è¯¯", f"æ³¨å…¥å‘½ä»¤å¤±è´¥: {str(e)}")

def perform_injection(self, final_command):
    """æ‰§è¡Œå…·ä½“çš„æ³¨å…¥æ“ä½œ"""
    # 1. é¼ æ ‡å®šä½å’Œç‚¹å‡»
    point = win32gui.ClientToScreen(self.target_window, self.target_position)
    win32api.SetCursorPos(point)
    time.sleep(0.1)
    
    # 2. æ‰§è¡Œé¼ æ ‡ç‚¹å‡»
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0, 0, 0)
    win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0, 0, 0)
    time.sleep(0.1)
    
    # 3. å‰ªè´´æ¿æ“ä½œ
    pyperclip.copy(final_command)
    time.sleep(0.1)
    
    # 4. éªŒè¯å‰ªè´´æ¿
    clipboard_content = pyperclip.paste()
    if clipboard_content != final_command:
        raise Exception("å‰ªè´´æ¿å¤åˆ¶å¤±è´¥")
    
    # 5. æ‰§è¡Œç²˜è´´
    win32api.keybd_event(win32con.VK_CONTROL, 0, 0, 0)
    win32api.keybd_event(ord('V'), 0, 0, 0)
    time.sleep(0.1)
    win32api.keybd_event(ord('V'), 0, win32con.KEYEVENTF_KEYUP, 0)
    win32api.keybd_event(win32con.VK_CONTROL, 0, win32con.KEYEVENTF_KEYUP, 0)
    
    # 6. å‘é€å›è½¦
    win32api.keybd_event(win32con.VK_RETURN, 0, 0, 0)
    win32api.keybd_event(win32con.VK_RETURN, 0, win32con.KEYEVENTF_KEYUP, 0)
    time.sleep(0.2)
```

### 1.3 æ ¡å‡†å’Œé¡¹ç›®ä¿¡æ¯ç®¡ç†

**åŠŸèƒ½æè¿°**: æ ¡å‡†ç›®æ ‡çª—å£ä½ç½®å¹¶ç®¡ç†é¡¹ç›®ç›¸å…³ä¿¡æ¯

**æ ¸å¿ƒå®ç°**:
```python
def start_calibration(self):
    """å¼€å§‹æ ¡å‡†ç›®æ ‡çª—å£"""
    self.calibrating = True
    self.setMouseTracking(True)
    self.calibration_button.setText("ç‚¹å‡»ç›®æ ‡ä½ç½®...")
    self.show_mini_notification("è¯·ç‚¹å‡»ç›®æ ‡åº”ç”¨çš„è¾“å…¥ä½ç½®")

def check_mouse_click(self):
    """æ£€æµ‹é¼ æ ‡ç‚¹å‡»è¿›è¡Œæ ¡å‡†"""
    if self.calibrating:
        # è·å–é¼ æ ‡ä½ç½®
        cursor_pos = win32gui.GetCursorPos()
        window_handle = win32gui.WindowFromPoint(cursor_pos)
        
        if window_handle:
            # è·å–çª—å£ä¿¡æ¯
            window_title = win32gui.GetWindowText(window_handle)
            app_name = self.get_application_name(window_handle, window_title)
            
            # ä¿å­˜æ ¡å‡†ä¿¡æ¯
            self.target_window = window_handle
            self.target_window_title = window_title
            client_pos = win32gui.ScreenToClient(window_handle, cursor_pos)
            self.target_position = client_pos
            
            # å®Œæˆæ ¡å‡†
            self.calibrating = False
            self.setMouseTracking(False)
            self.update_status_label()

def get_application_name(self, hwnd, window_title):
    """è·å–åº”ç”¨ç¨‹åºåç§°"""
    try:
        # è·å–è¿›ç¨‹ID
        _, pid = win32process.GetWindowThreadProcessId(hwnd)
        process_handle = win32api.OpenProcess(win32con.PROCESS_QUERY_INFORMATION | win32con.PROCESS_VM_READ, False, pid)
        exe_path = win32process.GetModuleFileNameEx(process_handle, 0)
        app_name = os.path.basename(exe_path)
        win32api.CloseHandle(process_handle)
        return app_name
    except:
        return "æœªçŸ¥åº”ç”¨"
```

## 2. æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ

### 2.1 æ¨¡æ¿æ•°æ®ç»“æ„

**JSONç»“æ„è®¾è®¡**:
```json
{
  "åœºæ™¯åç§°": {
    "versions": [
      {
        "name": "ç‰ˆæœ¬åç§°",
        "prefix": "å‰ç¼€å†…å®¹",
        "suffix": "åç¼€å†…å®¹"
      }
    ]
  }
}
```

### 2.2 æ¨¡æ¿ç®¡ç†å™¨å®ç°

```python
class TemplateManager:
    def __init__(self):
        self.templates_file = "templates.json"
        self.templates = {}
        self.load_templates()
    
    def load_templates(self):
        """åŠ è½½æ¨¡æ¿æ–‡ä»¶"""
        try:
            if os.path.exists(self.templates_file):
                with open(self.templates_file, 'r', encoding='utf-8') as f:
                    self.templates = json.load(f)
        except Exception as e:
            print(f"åŠ è½½æ¨¡æ¿å¤±è´¥: {e}")
            self.templates = {}
    
    def save_templates(self):
        """ä¿å­˜æ¨¡æ¿åˆ°æ–‡ä»¶"""
        try:
            with open(self.templates_file, 'w', encoding='utf-8') as f:
                json.dump(self.templates, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"ä¿å­˜æ¨¡æ¿å¤±è´¥: {e}")
    
    def get_scenes(self):
        """è·å–æ‰€æœ‰åœºæ™¯åˆ—è¡¨"""
        return list(self.templates.keys())
    
    def get_versions(self, scene):
        """è·å–æŒ‡å®šåœºæ™¯çš„ç‰ˆæœ¬åˆ—è¡¨"""
        if scene in self.templates:
            return [v['name'] for v in self.templates[scene]['versions']]
        return []
    
    def get_template(self, scene, version):
        """è·å–æŒ‡å®šåœºæ™¯å’Œç‰ˆæœ¬çš„æ¨¡æ¿"""
        if scene in self.templates:
            for v in self.templates[scene]['versions']:
                if v['name'] == version:
                    return v
        return None
    
    def add_scene(self, scene_name):
        """æ·»åŠ æ–°åœºæ™¯"""
        if scene_name not in self.templates:
            self.templates[scene_name] = {"versions": []}
            self.save_templates()
            return True
        return False
    
    def add_version(self, scene, version_name, prefix="", suffix=""):
        """æ·»åŠ æ–°ç‰ˆæœ¬"""
        if scene not in self.templates:
            self.add_scene(scene)
        
        # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨
        existing_versions = [v['name'] for v in self.templates[scene]['versions']]
        if version_name not in existing_versions:
            new_version = {
                "name": version_name,
                "prefix": prefix,
                "suffix": suffix
            }
            self.templates[scene]['versions'].append(new_version)
            self.save_templates()
            return True
        return False
    
    def update_template(self, scene, version, prefix, suffix):
        """æ›´æ–°æ¨¡æ¿å†…å®¹"""
        if scene in self.templates:
            for v in self.templates[scene]['versions']:
                if v['name'] == version:
                    v['prefix'] = prefix
                    v['suffix'] = suffix
                    self.save_templates()
                    return True
        return False
    
    def delete_version(self, scene, version):
        """åˆ é™¤ç‰ˆæœ¬"""
        if scene in self.templates:
            self.templates[scene]['versions'] = [
                v for v in self.templates[scene]['versions'] 
                if v['name'] != version
            ]
            self.save_templates()
            return True
        return False
    
    def delete_scene(self, scene):
        """åˆ é™¤åœºæ™¯"""
        if scene in self.templates:
            del self.templates[scene]
            self.save_templates()
            return True
        return False
```

### 2.3 æ¨¡æ¿åº”ç”¨é€»è¾‘

```python
def apply_template(self, command, project_name):
    """åº”ç”¨æ¨¡æ¿åˆ°å‘½ä»¤"""
    # æ„å»ºé¡¹ç›®æ ‡è¯†çš„å‘½ä»¤
    if command:
        command_with_project = f"ã€é¡¹ç›®ï¼š{project_name}ã€‘\n{command}"
    else:
        command_with_project = f"ã€é¡¹ç›®ï¼š{project_name}ã€‘"
    
    # æ£€æŸ¥æ˜¯å¦å¯ç”¨å®æ—¶ç”Ÿæˆ
    if self.realtime_check.isChecked():
        return self.apply_realtime_template(command_with_project)
    else:
        return self.apply_default_template(command_with_project)

def apply_default_template(self, command_with_project):
    """åº”ç”¨é»˜è®¤æ¨¡æ¿"""
    if self.default_scene and self.default_version:
        template = self.template_manager.get_template(self.default_scene, self.default_version)
        if template:
            prefix = template.get('prefix', '')
            suffix = template.get('suffix', '')
            return f"{prefix}\n\n{command_with_project}\n\n{suffix}"
    return command_with_project

def apply_realtime_template(self, command_with_project):
    """åº”ç”¨AIå®æ—¶ç”Ÿæˆçš„æ¨¡æ¿"""
    if not self.ai_service.api_key:
        print("âš ï¸ å®æ—¶ç”Ÿæˆå·²å¯ç”¨ä½†æœªè®¾ç½®APIå¯†é’¥ï¼Œå›é€€åˆ°é»˜è®¤æ¨¡æ¿æ¨¡å¼")
        return self.apply_default_template(command_with_project)
    
    decorators = self.ai_service.generate_decorators(command_with_project, self.default_scene)
    if decorators:
        return f"{decorators['prefix']}\n\n{command_with_project}\n\n{decorators['suffix']}"
    return command_with_project
```

## 3. é¡¹ç›®ç®¡ç†ç³»ç»Ÿ

### 3.1 é¡¹ç›®é€‰æ‹©å’Œç®¡ç†

```python
def auto_detect_current_project(self):
    """è‡ªåŠ¨æ£€æµ‹å½“å‰é¡¹ç›®"""
    try:
        # æ¸…ç†è¿‡æœŸé¡¹ç›®é”
        self.cleanup_expired_project_locks()
        
        # è·å–å½“å‰å·¥ä½œç›®å½•
        current_dir = os.getcwd()
        project_name = os.path.basename(current_dir)
        
        # æ£€æŸ¥é¡¹ç›®å®ä¾‹å†²çª
        conflict_result = self.check_project_instance_conflict(project_name)
        if conflict_result['conflict']:
            print(f"âš ï¸ é¡¹ç›®ç»‘å®šå†²çªï¼š{conflict_result['message']}")
            return False
        
        # è®¾ç½®é¡¹ç›®ä¿¡æ¯
        self.project_folder = current_dir
        self.project_name = project_name
        self.log_file = os.path.join(current_dir, f"{project_name}-log.md")
        
        # åˆ›å»ºé¡¹ç›®é”
        self.create_project_lock(project_name)
        
        # æ›´æ–°UIæ˜¾ç¤º
        self.update_project_display()
        
        return True
        
    except Exception as e:
        print(f"è‡ªåŠ¨æ£€æµ‹é¡¹ç›®å¤±è´¥: {e}")
        return False

def select_project_folder(self):
    """æ‰‹åŠ¨é€‰æ‹©é¡¹ç›®æ–‡ä»¶å¤¹"""
    folder = QFileDialog.getExistingDirectory(self, "é€‰æ‹©é¡¹ç›®æ–‡ä»¶å¤¹")
    if folder:
        project_name = os.path.basename(folder)
        
        # æ£€æŸ¥é¡¹ç›®å®ä¾‹å†²çª
        conflict_result = self.check_project_instance_conflict(project_name)
        if conflict_result['conflict']:
            QMessageBox.warning(self, "é¡¹ç›®å†²çª", conflict_result['message'])
            return
        
        # é‡Šæ”¾å½“å‰é¡¹ç›®é”
        self.release_project_lock()
        
        # è®¾ç½®æ–°é¡¹ç›®
        self.project_folder = folder
        self.project_name = project_name
        self.log_file = os.path.join(folder, f"{project_name}-log.md")
        
        # åˆ›å»ºæ–°é¡¹ç›®é”
        self.create_project_lock(project_name)
        
        # æ›´æ–°é…ç½®å’ŒUI
        self.save_config()
        self.update_project_display()
```

### 3.2 å®ä¾‹å†²çªæ£€æµ‹

```python
def check_project_instance_conflict(self, project_name):
    """æ£€æŸ¥é¡¹ç›®å®ä¾‹å†²çª"""
    try:
        config_dir = os.path.join(os.path.expanduser("~"), ".injection_tool")
        lock_file = os.path.join(config_dir, f"project_lock_{project_name}.json")
        
        if os.path.exists(lock_file):
            with open(lock_file, 'r', encoding='utf-8') as f:
                lock_data = json.load(f)
            
            # æ£€æŸ¥å®ä¾‹æ˜¯å¦ä»åœ¨è¿è¡Œ
            if self.is_instance_running(lock_data['pid'], lock_data['instance_id']):
                return {
                    'conflict': True,
                    'instance_id': lock_data['instance_id'],
                    'message': f"é¡¹ç›® '{project_name}' å·²è¢«å®ä¾‹ {lock_data['instance_id']} ç»‘å®š"
                }
        
        return {'conflict': False}
        
    except Exception as e:
        print(f"æ£€æŸ¥é¡¹ç›®å†²çªå¤±è´¥: {e}")
        return {'conflict': False}

def create_project_lock(self, project_name):
    """åˆ›å»ºé¡¹ç›®é”æ–‡ä»¶"""
    try:
        config_dir = os.path.join(os.path.expanduser("~"), ".injection_tool")
        os.makedirs(config_dir, exist_ok=True)
        
        lock_file = os.path.join(config_dir, f"project_lock_{project_name}.json")
        lock_data = {
            'project_name': project_name,
            'instance_id': self.instance_id,
            'pid': os.getpid(),
            'timestamp': time.time(),
            'project_folder': self.project_folder
        }
        
        with open(lock_file, 'w', encoding='utf-8') as f:
            json.dump(lock_data, f, ensure_ascii=False, indent=2)
            
    except Exception as e:
        print(f"åˆ›å»ºé¡¹ç›®é”å¤±è´¥: {e}")
```

## 4. UIç•Œé¢è®¾è®¡

### 4.1 ä¸»ç•Œé¢å¸ƒå±€

```python
def initUI(self):
    """åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢"""
    self.setWindowTitle("å‘½ä»¤æ³¨å…¥å·¥å…·")
    self.setGeometry(100, 100, 600, 500)
    
    # è®¾ç½®è‡ªå®šä¹‰æ ‡é¢˜æ 
    self.setup_custom_title_bar()
    
    # åˆ›å»ºä¸­å¤®éƒ¨ä»¶
    central_widget = QWidget()
    self.setCentralWidget(central_widget)
    
    # ä½¿ç”¨LayoutManagerç®¡ç†å¸ƒå±€
    self.layout_manager = LayoutManager(self)
    self.layout_manager.setup_layout(central_widget)
    
    # è¿ç§»ç»„ä»¶åˆ°æ–°å¸ƒå±€
    self.migrate_components()

def migrate_components(self):
    """è¿ç§»ç»„ä»¶åˆ°æ–°å¸ƒå±€"""
    # è·å–å¸ƒå±€å®¹å™¨
    left_panel = self.layout_manager.get_left_panel_container()
    command_area = self.layout_manager.get_command_area_container()
    
    # è¿ç§»å·¦ä¾§é¢æ¿ç»„ä»¶
    self.migrate_left_panel_components(left_panel)
    
    # è¿ç§»å‘½ä»¤åŒºåŸŸç»„ä»¶
    self.migrate_command_area_components(command_area)
```

### 4.2 å·¦ä¾§é¢æ¿ç»„ä»¶

```python
def migrate_left_panel_components(self, left_panel_container):
    """è¿ç§»å·¦ä¾§é¢æ¿ç»„ä»¶"""
    
    # é¡¹ç›®ä¿¡æ¯æ˜¾ç¤º
    project_group = QGroupBox("é¡¹ç›®ä¿¡æ¯")
    project_layout = QVBoxLayout()
    
    self.project_label = QLabel("é¡¹ç›®: æœªé€‰æ‹©")
    self.project_folder_label = QLabel("è·¯å¾„: æœªè®¾ç½®")
    project_layout.addWidget(self.project_label)
    project_layout.addWidget(self.project_folder_label)
    
    # é¡¹ç›®é€‰æ‹©æŒ‰é’®
    self.select_project_button = QPushButton("é€‰æ‹©é¡¹ç›®")
    self.select_project_button.clicked.connect(self.select_project_folder)
    project_layout.addWidget(self.select_project_button)
    
    project_group.setLayout(project_layout)
    left_panel_container.addWidget(project_group)
    
    # æ ¡å‡†æ§åˆ¶åŒºåŸŸ
    calibration_group = QGroupBox("æ ¡å‡†æ§åˆ¶")
    calibration_layout = QVBoxLayout()
    
    self.calibration_button = QPushButton("å¼€å§‹æ ¡å‡†")
    self.calibration_button.clicked.connect(self.start_calibration)
    calibration_layout.addWidget(self.calibration_button)
    
    self.status_label = QLabel("çŠ¶æ€: æœªæ ¡å‡†")
    calibration_layout.addWidget(self.status_label)
    
    self.reset_button = QPushButton("é‡ç½®æ ¡å‡†")
    self.reset_button.clicked.connect(self.reset_calibration)
    calibration_layout.addWidget(self.reset_button)
    
    calibration_group.setLayout(calibration_layout)
    left_panel_container.addWidget(calibration_group)
    
    # æ¨¡æ¿æ§åˆ¶åŒºåŸŸ
    template_group = QGroupBox("æ¨¡æ¿æ§åˆ¶")
    template_layout = QVBoxLayout()
    
    # åœºæ™¯é€‰æ‹©
    scene_layout = QHBoxLayout()
    scene_layout.addWidget(QLabel("åœºæ™¯:"))
    self.scene_combo = QComboBox()
    self.scene_combo.currentTextChanged.connect(self.on_scene_changed)
    scene_layout.addWidget(self.scene_combo)
    template_layout.addLayout(scene_layout)
    
    # ç‰ˆæœ¬é€‰æ‹©
    version_layout = QHBoxLayout()
    version_layout.addWidget(QLabel("ç‰ˆæœ¬:"))
    self.version_combo = QComboBox()
    self.version_combo.currentTextChanged.connect(self.on_version_changed)
    version_layout.addWidget(self.version_combo)
    template_layout.addLayout(version_layout)
    
    # æ¨¡æ¿ç®¡ç†æŒ‰é’®
    template_button_layout = QHBoxLayout()
    self.template_dialog_button = QPushButton("æ¨¡æ¿ç®¡ç†")
    self.template_dialog_button.clicked.connect(self.show_template_dialog)
    template_button_layout.addWidget(self.template_dialog_button)
    
    self.set_default_button = QPushButton("è®¾ä¸ºé»˜è®¤")
    self.set_default_button.clicked.connect(self.set_default_template)
    template_button_layout.addWidget(self.set_default_button)
    
    template_layout.addLayout(template_button_layout)
    
    # å®æ—¶ç”Ÿæˆé€‰é¡¹
    self.realtime_check = QCheckBox("å¯ç”¨AIå®æ—¶ç”Ÿæˆ")
    template_layout.addWidget(self.realtime_check)
    
    template_group.setLayout(template_layout)
    left_panel_container.addWidget(template_group)
```

### 4.3 å‘½ä»¤è¾“å…¥åŒºåŸŸ

```python
def migrate_command_area_components(self, command_area_container):
    """è¿ç§»å‘½ä»¤åŒºåŸŸç»„ä»¶"""
    
    # å‘½ä»¤è¾“å…¥æ¡†
    command_label = QLabel("å‘½ä»¤è¾“å…¥:")
    command_area_container.addWidget(command_label)
    
    self.command_input = QTextEdit()
    self.command_input.setPlaceholderText("åœ¨æ­¤è¾“å…¥è¦æ³¨å…¥çš„å‘½ä»¤...")
    self.command_input.setMinimumHeight(150)
    command_area_container.addWidget(self.command_input)
    
    # æ“ä½œæŒ‰é’®åŒºåŸŸ
    button_layout = QHBoxLayout()
    
    # æ³¨å…¥æŒ‰é’®
    self.inject_button = QPushButton("æ³¨å…¥å‘½ä»¤")
    self.inject_button.clicked.connect(self.inject_command)
    self.inject_button.setMinimumHeight(40)
    button_layout.addWidget(self.inject_button)
    
    # æ¸…ç©ºæŒ‰é’®
    self.clear_button = QPushButton("æ¸…ç©º")
    self.clear_button.clicked.connect(self.clear_command)
    button_layout.addWidget(self.clear_button)
    
    # ç²˜è´´æŒ‰é’®
    self.paste_button = QPushButton("ç²˜è´´")
    self.paste_button.clicked.connect(self.paste_from_clipboard)
    button_layout.addWidget(self.paste_button)
    
    command_area_container.addLayout(button_layout)
    
    # è¾…åŠ©åŠŸèƒ½åŒºåŸŸ
    aux_layout = QHBoxLayout()
    
    # è®°ç¬”è®°æŒ‰é’®
    self.note_button = QPushButton("è®°ç¬”è®°")
    self.note_button.clicked.connect(self.take_note)
    aux_layout.addWidget(self.note_button)
    
    # æˆªå–æ–‡æœ¬æŒ‰é’®
    self.capture_button = QPushButton("æˆªå–æ–‡æœ¬")
    self.capture_button.clicked.connect(self.capture_cascade_text)
    aux_layout.addWidget(self.capture_button)
    
    command_area_container.addLayout(aux_layout)
```

## 5. æ—¥å¿—ç®¡ç†ç³»ç»Ÿ

### 5.1 æ—¥å¿—è®°å½•æ ¼å¼

```python
def log_injection_result(self, original_command, final_command):
    """è®°å½•æ³¨å…¥ç»“æœåˆ°æ—¥å¿—"""
    try:
        # ç¡®å®šæ—¥å¿—æ–‡ä»¶è·¯å¾„
        if self.project_folder and self.project_name:
            log_file_path = os.path.join(self.project_folder, f"{self.project_name}-log.md")
        else:
            log_file_path = os.path.join(APP_DIR, "injection-log.md")
        
        # ç”Ÿæˆæ—¥å¿—å†…å®¹
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        app_name = self.target_window_title if self.target_window_title else "æœªçŸ¥åº”ç”¨"
        project_name = self.project_name if self.project_name else "æœªçŸ¥é¡¹ç›®"
        
        log_content = f"""
# {timestamp} ({app_name} - é¡¹ç›®ï¼š{project_name})

## ğŸ“¥ è¾“å…¥

{original_command}

## ğŸ“¤ è¾“å‡º

âœ… å‘½ä»¤æ³¨å…¥å®Œæˆ - {app_name} - {timestamp}

"""
        
        # å†™å…¥æ—¥å¿—æ–‡ä»¶
        with open(log_file_path, 'a', encoding='utf-8') as f:
            f.write(log_content)
        
        # åˆ›å»ºå¤‡ä»½
        self.create_log_backup("auto")
        
    except Exception as e:
        print(f"è®°å½•æ—¥å¿—å¤±è´¥: {e}")
```

### 5.2 å¤‡ä»½ç®¡ç†

```python
def create_log_backup(self, backup_type="auto"):
    """åˆ›å»ºæ—¥å¿—å¤‡ä»½"""
    try:
        if not self.log_file or not os.path.exists(self.log_file):
            return False
        
        # å¤‡ä»½ç›®å½•
        backup_dir = os.path.join(os.path.dirname(self.log_file), "backups")
        os.makedirs(backup_dir, exist_ok=True)
        
        # ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_filename = f"{self.project_name}-log-{backup_type}-{timestamp}.md"
        backup_path = os.path.join(backup_dir, backup_filename)
        
        # åˆ›å»ºå¤‡ä»½
        import shutil
        shutil.copy2(self.log_file, backup_path)
        
        print(f"âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ: {backup_path}")
        return True
        
    except Exception as e:
        print(f"åˆ›å»ºå¤‡ä»½å¤±è´¥: {e}")
        return False
```

## 6. è¾…åŠ©åŠŸèƒ½æ¨¡å—

### 6.1 çª—å£ç®¡ç†

```python
def ensure_project_window_active(self):
    """ç¡®ä¿é¡¹ç›®çª—å£åœ¨å‰æ™¯"""
    try:
        # æŸ¥æ‰¾é¡¹ç›®ç›¸å…³çª—å£
        target_window = self.find_project_cursor_window()
        if not target_window:
            QMessageBox.warning(self, "çª—å£æœªæ‰¾åˆ°", "æœªæ‰¾åˆ°é¡¹ç›®ç›¸å…³çª—å£ï¼Œè¯·ç¡®ä¿ç›®æ ‡åº”ç”¨å·²æ‰“å¼€")
            return False
        
        # æ¿€æ´»çª—å£
        win32gui.SetForegroundWindow(target_window)
        time.sleep(0.2)
        
        # éªŒè¯çª—å£æ˜¯å¦æ¿€æ´»æˆåŠŸ
        current_window = win32gui.GetForegroundWindow()
        if current_window != target_window:
            print("âš ï¸ çª—å£æ¿€æ´»å¯èƒ½æœªå®Œå…¨æˆåŠŸï¼Œä½†ç»§ç»­æ‰§è¡Œæ³¨å…¥")
        
        return True
        
    except Exception as e:
        print(f"æ¿€æ´»é¡¹ç›®çª—å£å¤±è´¥: {e}")
        return False

def find_project_cursor_window(self):
    """æŸ¥æ‰¾é¡¹ç›®ç›¸å…³çš„Cursorçª—å£"""
    def enum_windows_callback(hwnd, results):
        if win32gui.IsWindowVisible(hwnd):
            window_title = win32gui.GetWindowText(hwnd)
            if window_title and self.project_name:
                # æ£€æŸ¥çª—å£æ ‡é¢˜æ˜¯å¦åŒ…å«é¡¹ç›®åç§°
                if (self.project_name.lower() in window_title.lower() and 
                    "cursor" in window_title.lower()):
                    results.append(hwnd)
    
    results = []
    win32gui.EnumWindows(enum_windows_callback, results)
    return results[0] if results else None
```

### 6.2 å¿«æ·é”®æ”¯æŒ

```python
def setupShortcut(self):
    """è®¾ç½®å¿«æ·é”®"""
    # Ctrl+Enter å¿«é€Ÿæ³¨å…¥
    inject_shortcut = QShortcut(QKeySequence("Ctrl+Return"), self)
    inject_shortcut.activated.connect(self.inject_command)
    
    # Ctrl+L æ¸…ç©ºå‘½ä»¤
    clear_shortcut = QShortcut(QKeySequence("Ctrl+L"), self)
    clear_shortcut.activated.connect(self.clear_command)
    
    # Ctrl+V ç²˜è´´
    paste_shortcut = QShortcut(QKeySequence("Ctrl+V"), self)
    paste_shortcut.activated.connect(self.paste_from_clipboard)
    
    # F5 åˆ·æ–°é¡¹ç›®ä¿¡æ¯
    refresh_shortcut = QShortcut(QKeySequence("F5"), self)
    refresh_shortcut.activated.connect(self.refresh_project_info)
```

## 7. é…ç½®ç®¡ç†

### 7.1 é…ç½®æ–‡ä»¶ç»“æ„

```python
def load_config(self):
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    try:
        config_file = os.path.join(os.path.expanduser("~"), ".injection_tool", "config.json")
        if os.path.exists(config_file):
            with open(config_file, 'r', encoding='utf-8') as f:
                config = json.load(f)
                
            # æ¢å¤é…ç½®
            self.project_folder = config.get('project_folder')
            self.project_name = config.get('project_name')
            self.default_scene = config.get('default_scene')
            self.default_version = config.get('default_version')
            
            # è®¾ç½®æ—¥å¿—æ–‡ä»¶è·¯å¾„
            if self.project_folder and self.project_name:
                self.log_file = os.path.join(self.project_folder, f"{self.project_name}-log.md")
                
    except Exception as e:
        print(f"åŠ è½½é…ç½®å¤±è´¥: {e}")

def save_config(self):
    """ä¿å­˜é…ç½®æ–‡ä»¶"""
    try:
        config_dir = os.path.join(os.path.expanduser("~"), ".injection_tool")
        os.makedirs(config_dir, exist_ok=True)
        
        config = {
            'project_folder': self.project_folder,
            'project_name': self.project_name,
            'default_scene': self.default_scene,
            'default_version': self.default_version,
            'instance_id': self.instance_id
        }
        
        config_file = os.path.join(config_dir, "config.json")
        with open(config_file, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
            
    except Exception as e:
        print(f"ä¿å­˜é…ç½®å¤±è´¥: {e}")
```

## 8. ä¾èµ–å’Œç¯å¢ƒè¦æ±‚

### 8.1 Pythonä¾èµ–

```
# requirements.txt
PyQt5>=5.15.0
pywin32>=300
pyperclip>=1.8.2
watchdog>=2.1.9
```

### 8.2 ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Windows 10/11
- **Pythonç‰ˆæœ¬**: 3.7+
- **æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™ï¼ˆç”¨äºçª—å£æ“ä½œï¼‰

## 9. éƒ¨ç½²å’Œå¯åŠ¨

### 9.1 å¯åŠ¨è„šæœ¬

```python
# main.py
import sys
import os
from PyQt5.QtWidgets import QApplication
from PyQt5.QtCore import Qt

# æ·»åŠ å½“å‰ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

def main():
    # åˆ›å»ºåº”ç”¨ç¨‹åº
    app = QApplication(sys.argv)
    app.setAttribute(Qt.AA_EnableHighDpiScaling)
    
    # åˆ›å»ºä¸»çª—å£
    from command_injection_tool import MainWindow
    window = MainWindow()
    window.show()
    
    # è¿è¡Œåº”ç”¨ç¨‹åº
    sys.exit(app.exec_())

if __name__ == '__main__':
    main()
```

### 9.2 æ‰¹å¤„ç†å¯åŠ¨è„šæœ¬

```batch
@echo off
chcp 65001
echo å¯åŠ¨å‘½ä»¤æ³¨å…¥å·¥å…·...

cd /d "%~dp0"

python main.py

if errorlevel 1 (
    echo å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥Pythonç¯å¢ƒ
    pause
)
```

## 10. æ‰©å±•åŠŸèƒ½è§„åˆ’

### 10.1 AIé›†æˆæ¨¡å—

```python
class AIService:
    def __init__(self):
        self.api_key = None
        self.base_url = "https://api.openai.com/v1"
    
    def generate_decorators(self, command, scene):
        """ä½¿ç”¨AIç”Ÿæˆå‘½ä»¤è£…é¥°å™¨"""
        if not self.api_key:
            return None
            
        try:
            # æ„å»ºAIæç¤º
            prompt = f"""
            åŸºäºä»¥ä¸‹åœºæ™¯å’Œå‘½ä»¤ï¼Œç”Ÿæˆåˆé€‚çš„å‰ç¼€å’Œåç¼€ï¼š
            åœºæ™¯ï¼š{scene}
            å‘½ä»¤ï¼š{command}
            
            è¯·è¿”å›JSONæ ¼å¼ï¼š
            {{"prefix": "å‰ç¼€å†…å®¹", "suffix": "åç¼€å†…å®¹"}}
            """
            
            # è°ƒç”¨AI APIï¼ˆå…·ä½“å®ç°æ ¹æ®APIæä¾›å•†ï¼‰
            response = self.call_ai_api(prompt)
            return response
            
        except Exception as e:
            print(f"AIç”Ÿæˆå¤±è´¥: {e}")
            return None
```

### 10.2 éšå›¾èŠ‚ç‚¹åŠŸèƒ½

```python
def handle_mindmap_node_injection(self, node_data):
    """å¤„ç†è„‘å›¾èŠ‚ç‚¹ç›´æ¥æ³¨å…¥"""
    try:
        # æå–èŠ‚ç‚¹ä¿¡æ¯
        node_text = node_data.get('text', '')
        node_type = node_data.get('type', 'normal')
        
        # æ ¹æ®èŠ‚ç‚¹ç±»å‹å†³å®šæ³¨å…¥æ–¹å¼
        if node_type == 'command':
            # ç›´æ¥æ³¨å…¥å‘½ä»¤
            self.command_input.setPlainText(node_text)
            self.inject_command()
        elif node_type == 'template':
            # åº”ç”¨ä¸ºæ¨¡æ¿
            self.apply_node_as_template(node_text)
        
    except Exception as e:
        print(f"è„‘å›¾èŠ‚ç‚¹æ³¨å…¥å¤±è´¥: {e}")
```

## æ€»ç»“

è¿™ä¸ªå‘½ä»¤æ³¨å…¥å·¥å…·è®¾è®¡æ–‡æ¡£åŒ…å«äº†å®Œæ•´çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼Œæ¶µç›–äº†ï¼š

1. **æ ¸å¿ƒæ¶æ„**: åŸºäºPyQt5çš„æ¨¡å—åŒ–è®¾è®¡
2. **æ³¨å…¥æœºåˆ¶**: Win32 APIå®ç°çš„ç²¾ç¡®å‘½ä»¤æ³¨å…¥
3. **æ¨¡æ¿ç³»ç»Ÿ**: çµæ´»çš„åœºæ™¯-ç‰ˆæœ¬æ¨¡æ¿ç®¡ç†
4. **é¡¹ç›®ç®¡ç†**: æ™ºèƒ½çš„é¡¹ç›®æ£€æµ‹å’Œå†²çªé¿å…
5. **UIè®¾è®¡**: ç›´è§‚çš„ç”¨æˆ·äº¤äº’ç•Œé¢
6. **æ—¥å¿—ç³»ç»Ÿ**: å®Œæ•´çš„æ“ä½œè®°å½•å’Œå¤‡ä»½æœºåˆ¶
7. **æ‰©å±•èƒ½åŠ›**: AIé›†æˆå’Œè„‘å›¾è”åŠ¨ç­‰é«˜çº§åŠŸèƒ½

åŸºäºè¿™ä¸ªæ–‡æ¡£ï¼ŒAIåŠ©æ‰‹å¯ä»¥é‡æ–°ç”Ÿæˆä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„å‘½ä»¤æ³¨å…¥å·¥å…·ï¼Œç¡®ä¿æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œè®¾è®¡ç†å¿µå¾—åˆ°æ­£ç¡®å®ç°ã€‚ 