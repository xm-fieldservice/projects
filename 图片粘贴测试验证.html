<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç²˜è´´ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .test-input {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }
        .output {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ–¼ï¸ å›¾ç‰‡ç²˜è´´ç¼–ç é—®é¢˜ä¿®å¤éªŒè¯</h1>
    
    <div class="container">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>1. åœ¨ä¸‹é¢çš„æ–‡æœ¬æ¡†ä¸­æŒ‰ <strong>Ctrl+V</strong> ç²˜è´´å‰ªè´´æ¿ä¸­çš„å›¾ç‰‡</p>
        <p>2. æŸ¥çœ‹ç”Ÿæˆçš„ Markdown ä»£ç ï¼Œç¡®è®¤æ²¡æœ‰åŒé‡ç¼–ç é—®é¢˜</p>
        <p>3. æ­£ç¡®æ ¼å¼ï¼š<code>![å›¾ç‰‡1](data:image/png;base64,iVBORw0...)</code></p>
        <p>4. é”™è¯¯æ ¼å¼ï¼š<code>![å›¾ç‰‡1](data:image/png;base64,data:image/png;base64,iVBORw0...)</code></p>
    </div>

    <div class="container">
        <h2>ğŸ“ æµ‹è¯•åŒºåŸŸ</h2>
        <textarea id="test-input" class="test-input" placeholder="åœ¨è¿™é‡ŒæŒ‰ Ctrl+V ç²˜è´´å›¾ç‰‡..."></textarea>
        
        <div>
            <button id="btn-test" class="btn">æµ‹è¯•å›¾ç‰‡ç¼–ç </button>
            <button id="btn-clear" class="btn">æ¸…ç©º</button>
        </div>
        
        <div id="status-message"></div>
        
        <h3>ğŸ“· å›¾ç‰‡é¢„è§ˆï¼š</h3>
        <div id="image-preview" class="image-preview"></div>
        
        <h3>ğŸ“„ ç”Ÿæˆçš„ Markdownï¼š</h3>
        <div id="markdown-output" class="output"></div>
    </div>

    <!-- å¼•å…¥ä¿®å¤åçš„NoteSaverå·¥å…·åŒ… -->
    <script src="note_saver_toolkit/js/note-saver.js"></script>
    
    <script>
        let testNoteSaver;
        const testInput = document.getElementById('test-input');
        const imagePreview = document.getElementById('image-preview');
        const markdownOutput = document.getElementById('markdown-output');
        const statusMessage = document.getElementById('status-message');

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            statusMessage.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åˆ›å»ºNoteSaverå®ä¾‹
            testNoteSaver = createNoteSaver();
            
            // è®¾ç½®å›¾ç‰‡ç²˜è´´ç›‘å¬
            testNoteSaver.listenPaste(testInput, (imageData, count) => {
                showImagePreview(imageData);
                checkImageEncoding(imageData);
                showStatus(`âœ… æˆåŠŸç²˜è´´ç¬¬${count}å¼ å›¾ç‰‡`, 'success');
            });
            
            showStatus('ğŸ“ å·¥å…·åŒ…å·²åˆå§‹åŒ–ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
        });

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function showImagePreview(imageSrc) {
            const img = document.createElement('img');
            img.src = imageSrc;
            img.title = 'ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ•°æ®';
            img.onclick = () => {
                console.log('å®Œæ•´å›¾ç‰‡æ•°æ®:', imageSrc);
                alert('å›¾ç‰‡æ•°æ®å·²è¾“å‡ºåˆ°æ§åˆ¶å°');
            };
            imagePreview.appendChild(img);
        }

        // æ£€æŸ¥å›¾ç‰‡ç¼–ç 
        function checkImageEncoding(imageData) {
            let markdownText = `æ£€æµ‹åˆ°å›¾ç‰‡æ•°æ®:\n\n`;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŒé‡ç¼–ç 
            const hasDoubleEncoding = imageData.includes('data:image/') && 
                                    imageData.indexOf('data:image/') !== imageData.lastIndexOf('data:image/');
            
            if (hasDoubleEncoding) {
                markdownText += `âŒ å‘ç°åŒé‡ç¼–ç é—®é¢˜!\n`;
                markdownText += `é”™è¯¯æ ¼å¼: ![å›¾ç‰‡](${imageData.substring(0, 100)}...)\n\n`;
            } else {
                markdownText += `âœ… ç¼–ç æ­£ç¡®!\n`;
                markdownText += `æ­£ç¡®æ ¼å¼: ![å›¾ç‰‡1](${imageData.substring(0, 50)}...)\n\n`;
            }
            
            // åˆ†ææ•°æ®æ ¼å¼
            if (imageData.startsWith('data:image/')) {
                const mimeType = imageData.match(/data:(image\/[^;]+)/);
                const encodingType = imageData.match(/;([^,]+),/);
                
                markdownText += `MIMEç±»å‹: ${mimeType ? mimeType[1] : 'æœªçŸ¥'}\n`;
                markdownText += `ç¼–ç ç±»å‹: ${encodingType ? encodingType[1] : 'æœªçŸ¥'}\n`;
                markdownText += `æ•°æ®é•¿åº¦: ${imageData.length} å­—ç¬¦\n`;
                markdownText += `é¢„è§ˆ: ${imageData.substring(0, 150)}...\n\n`;
                
                // ç”Ÿæˆå®Œæ•´çš„Markdown
                markdownText += `å®Œæ•´Markdown:\n![å›¾ç‰‡1](${imageData})\n`;
            } else {
                markdownText += `âš ï¸ éæ ‡å‡†data URLæ ¼å¼\n`;
            }
            
            markdownOutput.textContent = markdownText;
        }

        // æµ‹è¯•æŒ‰é’®
        document.getElementById('btn-test').addEventListener('click', () => {
            if (testNoteSaver.pastedImages.length === 0) {
                showStatus('âš ï¸ è¯·å…ˆç²˜è´´å›¾ç‰‡', 'error');
                return;
            }
            
            let allCorrect = true;
            testNoteSaver.pastedImages.forEach((imageData, index) => {
                const hasDoubleEncoding = imageData.includes('data:image/') && 
                                        imageData.indexOf('data:image/') !== imageData.lastIndexOf('data:image/');
                if (hasDoubleEncoding) {
                    allCorrect = false;
                }
            });
            
            if (allCorrect) {
                showStatus(`âœ… æ‰€æœ‰ ${testNoteSaver.pastedImages.length} å¼ å›¾ç‰‡ç¼–ç æ­£ç¡®ï¼`, 'success');
            } else {
                showStatus('âŒ å‘ç°ç¼–ç é—®é¢˜ï¼Œè¯·æ£€æŸ¥è¾“å‡º', 'error');
            }
        });

        // æ¸…ç©ºæŒ‰é’®
        document.getElementById('btn-clear').addEventListener('click', () => {
            testNoteSaver.pastedImages = [];
            imagePreview.innerHTML = '';
            markdownOutput.textContent = '';
            testInput.value = '';
            statusMessage.innerHTML = '';
        });
    </script>
</body>
</html> 