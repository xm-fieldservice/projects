<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片粘贴修复验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .test-input {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }
        .output {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🖼️ 图片粘贴编码问题修复验证</h1>
    
    <div class="container">
        <h2>测试说明</h2>
        <p>1. 在下面的文本框中按 <strong>Ctrl+V</strong> 粘贴剪贴板中的图片</p>
        <p>2. 查看生成的 Markdown 代码，确认没有双重编码问题</p>
        <p>3. 正确格式：<code>![图片1](data:image/png;base64,iVBORw0...)</code></p>
        <p>4. 错误格式：<code>![图片1](data:image/png;base64,data:image/png;base64,iVBORw0...)</code></p>
    </div>

    <div class="container">
        <h2>📝 测试区域</h2>
        <textarea id="test-input" class="test-input" placeholder="在这里按 Ctrl+V 粘贴图片..."></textarea>
        
        <div>
            <button id="btn-test" class="btn">测试图片编码</button>
            <button id="btn-clear" class="btn">清空</button>
        </div>
        
        <div id="status-message"></div>
        
        <h3>📷 图片预览：</h3>
        <div id="image-preview" class="image-preview"></div>
        
        <h3>📄 生成的 Markdown：</h3>
        <div id="markdown-output" class="output"></div>
    </div>

    <!-- 引入修复后的NoteSaver工具包 -->
    <script src="note_saver_toolkit/js/note-saver.js"></script>
    
    <script>
        let testNoteSaver;
        const testInput = document.getElementById('test-input');
        const imagePreview = document.getElementById('image-preview');
        const markdownOutput = document.getElementById('markdown-output');
        const statusMessage = document.getElementById('status-message');

        // 显示状态消息
        function showStatus(message, type = 'info') {
            statusMessage.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 创建NoteSaver实例
            testNoteSaver = createNoteSaver();
            
            // 设置图片粘贴监听
            testNoteSaver.listenPaste(testInput, (imageData, count) => {
                showImagePreview(imageData);
                checkImageEncoding(imageData);
                showStatus(`✅ 成功粘贴第${count}张图片`, 'success');
            });
            
            showStatus('📝 工具包已初始化，可以开始测试', 'success');
        });

        // 显示图片预览
        function showImagePreview(imageSrc) {
            const img = document.createElement('img');
            img.src = imageSrc;
            img.title = '点击查看完整数据';
            img.onclick = () => {
                console.log('完整图片数据:', imageSrc);
                alert('图片数据已输出到控制台');
            };
            imagePreview.appendChild(img);
        }

        // 检查图片编码
        function checkImageEncoding(imageData) {
            let markdownText = `检测到图片数据:\n\n`;
            
            // 检查是否有双重编码
            const hasDoubleEncoding = imageData.includes('data:image/') && 
                                    imageData.indexOf('data:image/') !== imageData.lastIndexOf('data:image/');
            
            if (hasDoubleEncoding) {
                markdownText += `❌ 发现双重编码问题!\n`;
                markdownText += `错误格式: ![图片](${imageData.substring(0, 100)}...)\n\n`;
            } else {
                markdownText += `✅ 编码正确!\n`;
                markdownText += `正确格式: ![图片1](${imageData.substring(0, 50)}...)\n\n`;
            }
            
            // 分析数据格式
            if (imageData.startsWith('data:image/')) {
                const mimeType = imageData.match(/data:(image\/[^;]+)/);
                const encodingType = imageData.match(/;([^,]+),/);
                
                markdownText += `MIME类型: ${mimeType ? mimeType[1] : '未知'}\n`;
                markdownText += `编码类型: ${encodingType ? encodingType[1] : '未知'}\n`;
                markdownText += `数据长度: ${imageData.length} 字符\n`;
                markdownText += `预览: ${imageData.substring(0, 150)}...\n\n`;
                
                // 生成完整的Markdown
                markdownText += `完整Markdown:\n![图片1](${imageData})\n`;
            } else {
                markdownText += `⚠️ 非标准data URL格式\n`;
            }
            
            markdownOutput.textContent = markdownText;
        }

        // 测试按钮
        document.getElementById('btn-test').addEventListener('click', () => {
            if (testNoteSaver.pastedImages.length === 0) {
                showStatus('⚠️ 请先粘贴图片', 'error');
                return;
            }
            
            let allCorrect = true;
            testNoteSaver.pastedImages.forEach((imageData, index) => {
                const hasDoubleEncoding = imageData.includes('data:image/') && 
                                        imageData.indexOf('data:image/') !== imageData.lastIndexOf('data:image/');
                if (hasDoubleEncoding) {
                    allCorrect = false;
                }
            });
            
            if (allCorrect) {
                showStatus(`✅ 所有 ${testNoteSaver.pastedImages.length} 张图片编码正确！`, 'success');
            } else {
                showStatus('❌ 发现编码问题，请检查输出', 'error');
            }
        });

        // 清空按钮
        document.getElementById('btn-clear').addEventListener('click', () => {
            testNoteSaver.pastedImages = [];
            imagePreview.innerHTML = '';
            markdownOutput.textContent = '';
            testInput.value = '';
            statusMessage.innerHTML = '';
        });
    </script>
</body>
</html> 