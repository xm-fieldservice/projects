<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—®ç­”ç¬”è®°ç³»ç»Ÿ v3.0</title>
    
    <!-- PWA Meta Tags -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="background-color" content="#667eea">
    <meta name="description" content="é›†æˆè®¤è¯çš„æ™ºèƒ½é—®ç­”å’Œç¬”è®°ç®¡ç†ç³»ç»Ÿ">
    <meta name="keywords" content="é—®ç­”,ç¬”è®°,AI,æ™ºèƒ½åŠ©æ‰‹">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="QAç¬”è®°">
    <link rel="apple-touch-icon" href="/favicon.svg">
    
    <!-- Microsoft PWA Meta Tags -->
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <link rel="stylesheet" href="qa-note.css">
</head>
<body>
    <!-- é¡¶éƒ¨æ¨¡å¼åˆ‡æ¢åŒºåŸŸ -->
    <header class="mode-header">
        <div class="mode-container">
            <!-- å·¦ä¾§ï¼šæ±‰å ¡èœå• + é—®ç­”ç¬”è®°å¼€å…³ -->
            <div class="header-left">
                <button id="hamburger-menu" class="menu-btn" title="å±•å¼€åŠŸèƒ½èœå•" aria-label="å±•å¼€èœå•">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                
                <!-- æ¨¡å¼åˆ‡æ¢å¼€å…³ -->
                <div class="mode-switcher">
                    <div class="switch-container">
                        <span class="switch-label">ğŸ“ ç¬”è®°</span>
                        <label class="switch">
                            <input type="checkbox" id="mode-switch" checked>
                            <span class="slider round"></span>
                        </label>
                        <span class="switch-label">ğŸ¤– é—®ç­”</span>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šæ™ºèƒ½ä½“é€‰æ‹©å™¨ -->
            <div class="header-center">
                <!-- AIæ™ºèƒ½ä½“é€‰æ‹©ï¼ˆç§»åˆ°é¡¶éƒ¨ï¼‰ -->
                <div class="agent-selection-header">
                    <label for="agent-select-header" class="agent-label">AIæ™ºèƒ½ä½“ï¼š</label>
                    <select id="agent-select-header" class="agent-select-header">
                        <option value="general">ğŸ§  é€šç”¨æ™ºèƒ½ä½“</option>
                        <option value="code">ğŸ’» ä»£ç åŠ©æ‰‹</option>
                        <option value="writing">âœï¸ å†™ä½œåŠ©æ‰‹</option>
                    </select>
                </div>
            </div>

            <!-- å³ä¾§ï¼šäººå‘˜é€‰æ‹©å’Œç”¨æˆ·ä¿¡æ¯ -->
            <div class="header-right">
                <!-- äººå‘˜é€‰æ‹©æŒ‰é’® -->
                <button id="people-menu" class="menu-btn" title="äººå‘˜é€‰æ‹©" aria-label="å±•å¼€äººå‘˜èœå•">
                    <span class="menu-icon">ğŸ‘¥</span>
                </button>
                
                <div class="current-user">
                    <span id="user-display">ç”¨æˆ·</span>
                    <button id="logout-btn" class="logout-btn">é€€å‡º</button>
                </div>
            </div>
        </div>
    </header>

    <!-- å·¦ä¾§æ»‘å‡ºèœå• -->
    <nav id="left-sidebar" class="left-sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">ğŸ“š åŠŸèƒ½èœå•</h3>
            <button id="close-sidebar" class="close-btn" aria-label="å…³é—­èœå•">&times;</button>
        </div>
        
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li class="menu-item active">
                    <a href="#" data-action="switch-qa" class="menu-link">
                        <span class="menu-icon">ğŸ¤–</span>
                        <span class="menu-text">æ™ºèƒ½é—®ç­”</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-action="switch-note" class="menu-link">
                        <span class="menu-icon">ğŸ“</span>
                        <span class="menu-text">ç¬”è®°ç®¡ç†</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-action="export-data" class="menu-link">
                        <span class="menu-icon">ğŸ“¤</span>
                        <span class="menu-text">æ•°æ®å¯¼å‡º</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-action="clear-all" class="menu-link">
                        <span class="menu-icon">ğŸ—‘ï¸</span>
                        <span class="menu-text">æ¸…ç©ºæ•°æ®</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" data-action="settings" class="menu-link">
                        <span class="menu-icon">âš™ï¸</span>
                        <span class="menu-text">ç³»ç»Ÿè®¾ç½®</span>
                    </a>
                </li>
            </ul>

            <!-- ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
            <div class="system-status">
                <h4 class="status-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h4>
                <div class="status-item">
                    <span class="status-label">å­˜å‚¨æ¨¡å¼:</span>
                    <span class="status-value" id="storage-mode-display">æ··åˆæ¨¡å¼</span>
                </div>
                <div class="status-item">
                    <span class="status-label">åŒæ­¥çŠ¶æ€:</span>
                    <span class="status-value" id="sync-status-display">å·²åŒæ­¥</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æ•°æ®é‡:</span>
                    <span class="status-value" id="data-count-display">0 æ¡è®°å½•</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- å³ä¾§äººå‘˜æ  -->
    <nav id="right-sidebar" class="right-sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">ğŸ‘¥ äººå‘˜é€‰æ‹©</h3>
            <button id="close-people-sidebar" class="close-btn" aria-label="å…³é—­äººå‘˜èœå•">&times;</button>
        </div>
        
        <div class="sidebar-content">
            <!-- å·²é€‰äººå‘˜æ˜¾ç¤º -->
            <div class="selected-people">
                <h4 class="section-title">å·²é€‰äººå‘˜</h4>
                <div id="selected-people-list" class="selected-list">
                    <span class="empty-state">æš‚æœªé€‰æ‹©äººå‘˜</span>
                </div>
                <div class="selection-actions">
                    <button id="clear-selection" class="btn btn-sm btn-secondary">æ¸…ç©ºé€‰æ‹©</button>
                    <button id="apply-selection" class="btn btn-sm btn-primary">åº”ç”¨åˆ°è¾“å…¥æ¡†</button>
                </div>
            </div>

            <!-- äººå‘˜åˆ†ç»„åˆ—è¡¨ -->
            <div class="people-groups">
                <h4 class="section-title">äººå‘˜åˆ†ç»„</h4>
                
                <!-- å¼€å‘å›¢é˜Ÿåˆ†ç»„ -->
                <div class="group-item">
                    <div class="group-header" data-group="dev-team">
                        <input type="checkbox" id="group-dev" class="group-checkbox">
                        <label for="group-dev" class="group-label">
                            <span class="group-icon">ğŸ‘¨â€ğŸ’»</span>
                            <span class="group-name">å¼€å‘å›¢é˜Ÿ</span>
                            <span class="group-count">(3äºº)</span>
                            <span class="expand-icon">â–¼</span>
                        </label>
                    </div>
                    <div class="group-members">
                        <div class="member-item">
                            <input type="checkbox" id="member-zhang" class="member-checkbox" data-group="dev-team" data-member="å¼ å¼€å‘">
                            <label for="member-zhang" class="member-label">
                                <span class="member-avatar">ğŸ‘¨</span>
                                <span class="member-name">å¼ å¼€å‘</span>
                                <span class="member-status online">åœ¨çº¿</span>
                            </label>
                        </div>
                        <div class="member-item">
                            <input type="checkbox" id="member-li" class="member-checkbox" data-group="dev-team" data-member="æç¨‹åº">
                            <label for="member-li" class="member-label">
                                <span class="member-avatar">ğŸ‘©</span>
                                <span class="member-name">æç¨‹åº</span>
                                <span class="member-status offline">ç¦»çº¿</span>
                            </label>
                        </div>
                        <div class="member-item">
                            <input type="checkbox" id="member-wang" class="member-checkbox" data-group="dev-team" data-member="ç‹å‰ç«¯">
                            <label for="member-wang" class="member-label">
                                <span class="member-avatar">ğŸ‘¨</span>
                                <span class="member-name">ç‹å‰ç«¯</span>
                                <span class="member-status online">åœ¨çº¿</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- è®¾è®¡å›¢é˜Ÿåˆ†ç»„ -->
                <div class="group-item">
                    <div class="group-header" data-group="design-team">
                        <input type="checkbox" id="group-design" class="group-checkbox">
                        <label for="group-design" class="group-label">
                            <span class="group-icon">ğŸ¨</span>
                            <span class="group-name">è®¾è®¡å›¢é˜Ÿ</span>
                            <span class="group-count">(2äºº)</span>
                            <span class="expand-icon">â–¼</span>
                        </label>
                    </div>
                    <div class="group-members">
                        <div class="member-item">
                            <input type="checkbox" id="member-liu" class="member-checkbox" data-group="design-team" data-member="åˆ˜è®¾è®¡">
                            <label for="member-liu" class="member-label">
                                <span class="member-avatar">ğŸ‘©</span>
                                <span class="member-name">åˆ˜è®¾è®¡</span>
                                <span class="member-status online">åœ¨çº¿</span>
                            </label>
                        </div>
                        <div class="member-item">
                            <input type="checkbox" id="member-chen" class="member-checkbox" data-group="design-team" data-member="é™ˆUI">
                            <label for="member-chen" class="member-label">
                                <span class="member-avatar">ğŸ‘¨</span>
                                <span class="member-name">é™ˆUI</span>
                                <span class="member-status online">åœ¨çº¿</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- äº§å“å›¢é˜Ÿåˆ†ç»„ -->
                <div class="group-item">
                    <div class="group-header" data-group="product-team">
                        <input type="checkbox" id="group-product" class="group-checkbox">
                        <label for="group-product" class="group-label">
                            <span class="group-icon">ğŸ“Š</span>
                            <span class="group-name">äº§å“å›¢é˜Ÿ</span>
                            <span class="group-count">(2äºº)</span>
                            <span class="expand-icon">â–¼</span>
                        </label>
                    </div>
                    <div class="group-members">
                        <div class="member-item">
                            <input type="checkbox" id="member-zhao" class="member-checkbox" data-group="product-team" data-member="èµµäº§å“">
                            <label for="member-zhao" class="member-label">
                                <span class="member-avatar">ğŸ‘©</span>
                                <span class="member-name">èµµäº§å“</span>
                                <span class="member-status online">åœ¨çº¿</span>
                            </label>
                        </div>
                        <div class="member-item">
                            <input type="checkbox" id="member-sun" class="member-checkbox" data-group="product-team" data-member="å­™è¿è¥">
                            <label for="member-sun" class="member-label">
                                <span class="member-avatar">ğŸ‘¨</span>
                                <span class="member-name">å­™è¿è¥</span>
                                <span class="member-status offline">ç¦»çº¿</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- èƒŒæ™¯é®ç½© -->
    <div id="backdrop" class="backdrop"></div>

    <!-- ä¸»è¦è¾“å…¥åŒºåŸŸ -->
    <main class="main-container">
        <!-- ç»Ÿä¸€è¾“å…¥ç•Œé¢ -->
        <section class="input-section">
            <div class="input-container">
                <!-- æœ¬åœ°æ–‡ä»¶ç®¡ç†å·¥å…·æ ï¼ˆæ–°å¢ï¼‰ -->
                <div class="field-group local-file-toolbar">
                    <div class="toolbar-row">
                        <button id="select-file-btn" class="btn btn-secondary">ğŸ“ é€‰æ‹©æœ¬åœ°ç¬”è®°æ–‡ä»¶</button>
                        <button id="create-file-btn" class="btn btn-secondary">ğŸ“„ æ–°å»ºæœ¬åœ°æ–‡ä»¶</button>
                        <div id="file-status" class="file-status">æœªé€‰æ‹©æ–‡ä»¶</div>
                    </div>
                    <div class="field-hint">é€‰æ‹©æˆ–åˆ›å»ºæœ¬åœ°Markdownæ–‡ä»¶è¿›è¡Œç›´æ¥è¯»å†™ä¿å­˜ï¼ˆæ”¯æŒFile System APIï¼‰</div>
                </div>

                <!-- æ ‡é¢˜è¾“å…¥ -->
                <div class="field-group">
                    <label for="title-input" class="field-label">
                        <span id="title-label">æ ‡é¢˜</span>
                        <span class="required">*</span>
                    </label>
                    <input type="text" 
                           id="title-input" 
                           class="field-input" 
                           placeholder="è¯·è¾“å…¥æ ‡é¢˜..." 
                           maxlength="200" 
                           required>
                    <div class="field-hint" id="title-hint">ä¸ºæ‚¨çš„å†…å®¹èµ·ä¸ªæ ‡é¢˜</div>
                </div>

                <!-- å†…å®¹è¾“å…¥ -->
                <div class="field-group">
                    <label for="content-input" class="field-label">
                        <span id="content-label">å†…å®¹</span>
                        <span class="required">*</span>
                    </label>
                    <textarea id="content-input" 
                              class="field-textarea" 
                              placeholder="è¯·è¾“å…¥å†…å®¹...ï¼ˆæ”¯æŒå›¾ç‰‡ç²˜è´´ï¼‰" 
                              rows="8" 
                              required></textarea>
                    <div class="field-hint" id="content-hint">è¯¦ç»†æè¿°æ‚¨çš„å†…å®¹ã€‚æ”¯æŒCtrl+Vç²˜è´´å›¾ç‰‡</div>
                </div>

                <!-- æ ‡ç­¾è¾“å…¥ -->
                <div class="field-group">
                    <label for="tags-input" class="field-label">
                        <span>æ ‡ç­¾</span>
                        <span class="optional">(å¯é€‰)</span>
                    </label>
                    <input type="text" 
                           id="tags-input" 
                           class="field-input" 
                           placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”...">
                    <div class="field-hint">ä¾‹å¦‚ï¼šç¼–ç¨‹,ç®—æ³•,Python</div>
                </div>

                <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸï¼ˆæ–°å¢ï¼‰ -->
                <div class="field-group" id="image-preview-section" style="display: none;">
                    <label class="field-label">ğŸ“· å·²æ·»åŠ çš„å›¾ç‰‡</label>
                    <div id="image-preview-container" class="image-preview-container">
                        <!-- åŠ¨æ€æ·»åŠ å›¾ç‰‡é¢„è§ˆ -->
                    </div>
                    <div class="field-hint">ç²˜è´´çš„å›¾ç‰‡å°†ä»¥base64æ ¼å¼ä¿å­˜åœ¨ç¬”è®°ä¸­</div>
                </div>

                <!-- ç»Ÿä¸€æ“ä½œæŒ‰é’® -->
                <div class="field-group action-field">
                    <div class="action-buttons-row">
                        <!-- ä¸»æ“ä½œæŒ‰é’® -->
                        <button id="submit-btn" class="btn btn-primary btn-main">
                            <span id="submit-text">ğŸš€ å‘é€é—®é¢˜</span>
                        </button>
                        
                        <!-- é™„ä»¶æŒ‰é’® -->
                        <button id="attachment-btn" class="btn btn-secondary btn-attachment" title="ä¸Šä¼ æ–‡æ¡£">
                            <span>ğŸ“ é™„ä»¶</span>
                            <input type="file" id="file-input" style="display: none;" accept=".txt,.md,.pdf,.doc,.docx">
                        </button>
                        
                        <!-- ç½‘ç»œçŠ¶æ€æ˜¾ç¤º -->
                        <div class="network-status-compact" id="network-status-compact">
                            <span class="status-icon" id="network-icon-compact">ğŸŒ</span>
                            <span class="status-text" id="network-text-compact">åœ¨çº¿</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œè®¾ç½®åŒºåŸŸ -->
            <div class="action-section">
                <div class="storage-options">
                    <div class="storage-mode">
                        <label for="storage-select">å­˜å‚¨æ¨¡å¼ï¼š</label>
                        <select id="storage-select" class="storage-select">
                            <option value="hybrid">ğŸ”„ æ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰</option>
                            <option value="server">â˜ï¸ ä»…æœåŠ¡å™¨</option>
                            <option value="local">ğŸ’¾ ä»…æœ¬åœ°</option>
                            <option value="file">ğŸ“ æœ¬åœ°æ–‡ä»¶ç›´æ¥è¯»å†™</option>
                        </select>
                    </div>
                    <div class="file-api-status" id="file-api-status">
                        <span id="file-api-support">æ£€æŸ¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <section class="result-section" id="result-section" style="display: none;">
            <div class="result-container">
                <div class="result-header">
                    <h3 id="result-title">AIå›ç­”</h3>
                    <div class="result-actions">
                        <button id="save-answer-btn" class="btn btn-sm">ğŸ’¾ ä¿å­˜ä¸ºç¬”è®°</button>
                        <button id="copy-answer-btn" class="btn btn-sm">ğŸ“‹ å¤åˆ¶å›ç­”</button>
                    </div>
                </div>
                <div class="result-content" id="result-content">
                    <!-- AIå›ç­”å†…å®¹ -->
                </div>
                <div class="result-meta" id="result-meta">
                    <!-- å›ç­”å…ƒä¿¡æ¯ï¼šæ—¶é—´ã€æ™ºèƒ½ä½“ã€tokenä½¿ç”¨ç­‰ -->
                </div>
            </div>
        </section>
    </main>

    <!-- çŠ¶æ€æç¤ºåŒºåŸŸï¼ˆæ–°å¢ï¼‰ -->
    <div id="status-overlay" class="status-overlay" style="display: none;">
        <div class="status-message" id="status-message">
            <span id="status-icon">â„¹ï¸</span>
            <span id="status-text">çŠ¶æ€ä¿¡æ¯</span>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
    <div id="message-container" class="message-container"></div>

    <!-- åŠ è½½çŠ¶æ€é®ç½© -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">æ­£åœ¨å¤„ç†ä¸­...</div>
        </div>
    </div>

    <!-- è„šæœ¬å¼•å…¥ -->
    <script src="/shared/api.js"></script>
    <script src="/shared/notebook.js"></script>
    <script src="/shared/utils.js"></script>
    <script src="local-note-saver.js"></script>
    <script src="qa-note-saver.js"></script>
    <script src="qa-note.js"></script>
    
    <!-- Service Worker æ³¨å†Œ -->
    <script>
        // Service Worker æ³¨å†Œå’Œç®¡ç†
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„Service Workerç­‰å¾…æ¿€æ´»
                        if (registration.waiting) {
                            console.log('ğŸ”„ å‘ç°æ–°çš„Service Workerï¼Œæ­£åœ¨æ›´æ–°...');
                            registration.waiting.postMessage({action: 'skipWaiting'});
                        }
                        
                        // ç›‘å¬Service Workeræ›´æ–°
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', function() {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        console.log('ğŸ“¦ Service Worker å·²æ›´æ–°ï¼Œåˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ›´æ”¹');
                                        // å¯ä»¥åœ¨è¿™é‡Œæç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
                                        newWorker.postMessage({action: 'skipWaiting'});
                                    }
                                });
                            }
                        });
                    })
                    .catch(function(error) {
                        console.log('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
                
                // ç›‘å¬Service Workeræ§åˆ¶æƒå˜åŒ–
                navigator.serviceWorker.addEventListener('controllerchange', function() {
                    console.log('ğŸ”„ Service Worker æ§åˆ¶æƒå·²æ›´æ”¹ï¼Œå¯èƒ½éœ€è¦åˆ·æ–°é¡µé¢');
                    // åœ¨è¿™é‡Œå¯ä»¥é€‰æ‹©è‡ªåŠ¨åˆ·æ–°é¡µé¢
                    // window.location.reload();
                });
            });
        } else {
            console.log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒService Worker');
        }
    </script>
    
    <!-- åˆå§‹åŒ–è„šæœ¬ -->
    <script>
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('é¡µé¢é”™è¯¯:', e.error);
            console.error('é”™è¯¯æº:', e.filename, 'è¡Œ:', e.lineno, 'åˆ—:', e.colno);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
        });
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoadingStatus(message) {
            console.log('ğŸ”„', message);
            const statusDiv = document.createElement('div');
            statusDiv.id = 'init-status';
            statusDiv.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8); color: white; padding: 20px;
                border-radius: 8px; z-index: 10000; font-family: Arial, sans-serif;
            `;
            statusDiv.innerHTML = `
                <div style="text-align: center;">
                    <div style="margin-bottom: 10px;">ğŸš€ æ™ºèƒ½é—®ç­”ç³»ç»Ÿåˆå§‹åŒ–</div>
                    <div id="status-text">${message}</div>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">è¯·ç¨å€™...</div>
                </div>
            `;
            document.body.appendChild(statusDiv);
            return statusDiv;
        }
        
        function updateLoadingStatus(message) {
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = message;
            }
            console.log('ğŸ“', message);
        }
        
        function hideLoadingStatus() {
            const statusDiv = document.getElementById('init-status');
            if (statusDiv) {
                statusDiv.remove();
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸŒŸ é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–QANoteBlock...');
            
            const statusDiv = showLoadingStatus('æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿä¾èµ–...');
            
            try {
                // æ­¥éª¤1ï¼šæ£€æŸ¥å¿…è¦çš„å¯¹è±¡æ˜¯å¦å­˜åœ¨
                updateLoadingStatus('æ£€æŸ¥JavaScriptæ¨¡å—...');
                
                if (typeof QANoteBlock === 'undefined') {
                    throw new Error('QANoteBlockæœªå®šä¹‰ï¼Œå¯èƒ½æ˜¯qa-note.jsåŠ è½½å¤±è´¥');
                }
                console.log('âœ… QANoteBlockå¯¹è±¡å­˜åœ¨');
                
                if (typeof QANoteSaver === 'undefined') {
                    console.warn('âš ï¸ QANoteSaveræœªå®šä¹‰ï¼Œå°†ä½¿ç”¨é™çº§æ¨¡å¼');
                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„Mockå¯¹è±¡
                    window.QANoteSaver = class {
                        constructor() {}
                        async saveNote() { return { success: false, message: 'ä¿å­˜åŠŸèƒ½ä¸å¯ç”¨' }; }
                    };
                }
                
                if (typeof LocalNoteSaver === 'undefined') {
                    console.warn('âš ï¸ LocalNoteSaveræœªå®šä¹‰ï¼Œå°†ä½¿ç”¨é™çº§æ¨¡å¼');
                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„Mockå¯¹è±¡
                    window.LocalNoteSaver = class {
                        constructor() {}
                        bindSelectButton() {}
                        bindInput() {}
                        bindCreateButton() {}
                        async saveNote() { return { success: false, message: 'æœ¬åœ°ä¿å­˜åŠŸèƒ½ä¸å¯ç”¨' }; }
                    };
                }
                
                if (typeof APIClient === 'undefined') {
                    console.warn('âš ï¸ APIClientæœªå®šä¹‰ï¼Œå°†ä½¿ç”¨é™çº§æ¨¡å¼');
                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„Mockå¯¹è±¡
                    window.APIClient = class {
                        static async request() { 
                            throw new Error('APIå®¢æˆ·ç«¯ä¸å¯ç”¨'); 
                        }
                    };
                }
                
                // æ­¥éª¤2ï¼šæ£€æŸ¥å…³é”®DOMå…ƒç´ 
                updateLoadingStatus('æ£€æŸ¥é¡µé¢å…ƒç´ ...');
                
                const requiredElements = [
                    'mode-switch', 'submit-btn', 'title-input', 'content-input',
                    'hamburger-menu', 'logout-btn', 'storage-select'
                ];
                
                const missingElements = [];
                for (const elementId of requiredElements) {
                    const element = document.getElementById(elementId);
                    if (!element) {
                        missingElements.push(elementId);
                    }
                }
                
                if (missingElements.length > 0) {
                    console.warn('âš ï¸ æŸäº›é¡µé¢å…ƒç´ æœªæ‰¾åˆ°:', missingElements);
                    console.log('ç³»ç»Ÿå°†åœ¨é™çº§æ¨¡å¼ä¸‹è¿è¡Œ');
                }
                
                // æ­¥éª¤3ï¼šåˆå§‹åŒ–QANoteBlock
                updateLoadingStatus('åˆå§‹åŒ–ç³»ç»Ÿæ ¸å¿ƒ...');
                
                await QANoteBlock.init();
                console.log('âœ… QANoteBlockåˆå§‹åŒ–æˆåŠŸ');
                
                // æ­¥éª¤4ï¼šå®Œæˆåˆå§‹åŒ–
                updateLoadingStatus('åˆå§‹åŒ–å®Œæˆï¼');
                
                setTimeout(() => {
                    hideLoadingStatus();
                    // æ¢å¤é¡µé¢æ˜¾ç¤º
                    document.body.style.opacity = '1';
                    console.log('ğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œé¡µé¢å·²å°±ç»ª');
                }, 500);
                
            } catch (error) {
                console.error('âŒ QANoteBlockåˆå§‹åŒ–å¤±è´¥:', error);
                hideLoadingStatus();
                
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ç•Œé¢
                document.body.innerHTML = `
                    <div style="padding: 40px; text-align: center; font-family: Arial, sans-serif; background: #f8f9fa; min-height: 100vh;">
                        <div style="max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h2 style="color: #dc3545; margin-bottom: 20px;">âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥</h2>
                            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; padding: 15px; margin: 20px 0; color: #721c24;">
                                <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ${error.message}
                            </div>
                            
                            <h3 style="color: #495057; margin: 30px 0 15px 0;">ğŸ”§ æ•…éšœæ’é™¤æ­¥éª¤</h3>
                            <div style="text-align: left; background: #e9ecef; padding: 20px; border-radius: 6px; margin: 20px 0;">
                                <ol style="margin: 0; padding-left: 20px;">
                                    <li style="margin: 10px 0;"><strong>åˆ·æ–°é¡µé¢ï¼š</strong> æŒ‰ F5 æˆ– Ctrl+F5 å¼ºåˆ¶åˆ·æ–°</li>
                                    <li style="margin: 10px 0;"><strong>æ¸…é™¤ç¼“å­˜ï¼š</strong> æŒ‰ Ctrl+Shift+Delete æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</li>
                                    <li style="margin: 10px 0;"><strong>æ£€æŸ¥ç½‘ç»œï¼š</strong> ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸</li>
                                    <li style="margin: 10px 0;"><strong>é‡æ–°ç™»å½•ï¼š</strong> å¯èƒ½æ˜¯è®¤è¯çŠ¶æ€å¤±æ•ˆ</li>
                                    <li style="margin: 10px 0;"><strong>è”ç³»æ”¯æŒï¼š</strong> å¦‚é—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ</li>
                                </ol>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <button onclick="window.location.reload()" 
                                        style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 16px;">
                                    ğŸ”„ åˆ·æ–°é¡µé¢
                                </button>
                                <button onclick="window.location.href='/auth'" 
                                        style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 16px;">
                                    ğŸ” é‡æ–°ç™»å½•
                                </button>
                            </div>
                            
                            <div style="margin-top: 20px; font-size: 14px; color: #6c757d;">
                                <details>
                                    <summary style="cursor: pointer; margin-bottom: 10px;">ğŸ” æŠ€æœ¯è¯¦æƒ…ï¼ˆç‚¹å‡»æŸ¥çœ‹ï¼‰</summary>
                                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: left; overflow-x: auto; font-size: 12px;">${error.stack || error.message}</pre>
                                </details>
                            </div>
                        </div>
                    </div>
                `;
                
                // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œå¯èƒ½æ˜¯è®¤è¯é—®é¢˜ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                if (error.message.includes('è®¤è¯') || error.message.includes('auth') || error.message.includes('token')) {
                    console.log('ğŸ”„ è®¤è¯å¤±è´¥ï¼Œ5ç§’åè·³è½¬åˆ°ç™»å½•é¡µé¢...');
                    setTimeout(() => {
                        window.location.href = '/auth';
                    }, 5000);
                }
            }
        });
        
        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && window.QANoteBlock && typeof QANoteBlock.checkAuthStatus === 'function') {
                // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œæ£€æŸ¥è®¤è¯çŠ¶æ€
                QANoteBlock.checkAuthStatus().then(isValid => {
                    if (!isValid) {
                        console.log('ğŸ”„ è®¤è¯çŠ¶æ€å¤±æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢...');
                        window.location.href = '/auth';
                    }
                }).catch(error => {
                    console.error('è®¤è¯çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                });
            }
        });
        
        // æ·»åŠ æ€§èƒ½ç›‘æ§
        window.addEventListener('load', function() {
            if (window.performance) {
                const perfData = window.performance.timing;
                const loadTime = perfData.loadEventEnd - perfData.navigationStart;
                console.log(`ğŸ“Š é¡µé¢åŠ è½½æ€§èƒ½: ${loadTime}ms`);
            }
        });
    </script>
</body>
</html> 