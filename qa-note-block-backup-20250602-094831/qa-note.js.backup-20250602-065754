/**
 * QANoteBlock - é—®ç­”ç¬”è®°ç»Ÿä¸€åŠŸèƒ½å—
 * v3.0 å®Œæ•´è§£è€¦ç‰ˆæ ¸å¿ƒå®ç° + LocalNoteSaveré›†æˆ
 */
window.QANoteBlock = {
    // å½“å‰çŠ¶æ€
    currentMode: 'qa',
    isProcessing: false,
    lastResponse: null,
    qaSaver: null,
    localNoteSaver: null,

    /**
     * åˆå§‹åŒ–
     */
    init() {
        // åˆå§‹åŒ–æ™ºèƒ½å­˜å‚¨å™¨
        this.qaSaver = new QANoteSaver({
            mode: this.getStorageMode(),
            apiUrl: 'http://localhost:8000/api/v1',
            debugMode: false,
            onSaveSuccess: this.handleSaveSuccess.bind(this),
            onSaveError: this.handleSaveError.bind(this)
        });

        // åˆå§‹åŒ–æœ¬åœ°æ–‡ä»¶ä¿å­˜å™¨
        this.initLocalNoteSaver();

        // åˆå§‹åŒ–ç•Œé¢
        this.initializeUI();
        this.bindEvents();
        this.loadUserInfo();
        this.switchMode('qa'); // é»˜è®¤é—®ç­”æ¨¡å¼
        this.checkFileSystemSupport();
    },

    /**
     * åˆå§‹åŒ–æœ¬åœ°æ–‡ä»¶ä¿å­˜å™¨
     */
    initLocalNoteSaver() {
        try {
            this.localNoteSaver = new LocalNoteSaver({
                appName: 'æ™ºèƒ½é—®ç­”ç¬”è®°ç³»ç»Ÿv3.0',
                timestampFormat: 'zh-CN',
                debugMode: false
            });

            // ç»‘å®šæœ¬åœ°ä¿å­˜åŠŸèƒ½
            this.localNoteSaver.bindSelectButton('#select-file-btn');
            this.localNoteSaver.bindInput('#content-input');
            this.localNoteSaver.bindCreateButton('#create-file-btn');

            // é‡å†™çŠ¶æ€æ˜¾ç¤ºæ–¹æ³•
            this.localNoteSaver.showStatus = this.showLocalStatus.bind(this);

            console.log('âœ… LocalNoteSaver åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('âŒ LocalNoteSaver åˆå§‹åŒ–å¤±è´¥:', error);
            this.showMessage('æœ¬åœ°æ–‡ä»¶ä¿å­˜åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥', 'warning');
        }
    },

    /**
     * æ£€æŸ¥File System APIæ”¯æŒ
     */
    checkFileSystemSupport() {
        const supportElement = document.getElementById('file-api-support');
        const statusElement = document.getElementById('file-api-status');
        
        if ('showSaveFilePicker' in window) {
            supportElement.textContent = 'âœ… æ”¯æŒç›´æ¥æ–‡ä»¶è¯»å†™';
            statusElement.classList.add('supported');
            this.enableLocalFileFeatures();
        } else {
            supportElement.textContent = 'âš ï¸ ä»…æ”¯æŒä¸‹è½½ä¿å­˜';
            statusElement.classList.add('unsupported');
            this.limitLocalFileFeatures();
        }
    },

    /**
     * å¯ç”¨æœ¬åœ°æ–‡ä»¶åŠŸèƒ½
     */
    enableLocalFileFeatures() {
        // æ˜¾ç¤ºæœ¬åœ°ä¿å­˜æŒ‰é’®
        document.getElementById('local-save-btn').style.display = 'inline-flex';
        document.getElementById('local-save-answer-btn').style.display = 'inline-flex';
        document.getElementById('local-export-btn').style.display = 'inline-flex';
        
        // æ›´æ–°å­˜å‚¨æ¨¡å¼é€‰é¡¹
        const fileOption = document.querySelector('option[value="file"]');
        if (fileOption) {
            fileOption.style.display = 'block';
        }
    },

    /**
     * é™åˆ¶æœ¬åœ°æ–‡ä»¶åŠŸèƒ½
     */
    limitLocalFileFeatures() {
        // éšè—éƒ¨åˆ†æœ¬åœ°ä¿å­˜æŒ‰é’®
        const fileOption = document.querySelector('option[value="file"]');
        if (fileOption) {
            fileOption.textContent = 'ğŸ“¥ æœ¬åœ°ä¸‹è½½ä¿å­˜ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰';
        }
    },

    /**
     * æ˜¾ç¤ºæœ¬åœ°çŠ¶æ€
     */
    showLocalStatus(message, type = 'info') {
        const statusOverlay = document.getElementById('status-overlay');
        const statusMessage = document.getElementById('status-message');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');

        // è®¾ç½®å›¾æ ‡
        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            warning: 'âš ï¸',
            info: 'â„¹ï¸'
        };

        statusIcon.textContent = icons[type] || icons.info;
        statusText.textContent = message;
        
        // è®¾ç½®æ ·å¼
        statusMessage.className = `status-message ${type}`;
        
        // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
        const fileStatus = document.getElementById('file-status');
        if (this.localNoteSaver && this.localNoteSaver.currentFileName) {
            fileStatus.textContent = `å·²é€‰æ‹©: ${this.localNoteSaver.currentFileName}`;
            fileStatus.className = 'file-status success';
        }

        // æ˜¾ç¤ºçŠ¶æ€
        statusOverlay.style.display = 'block';
        
        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            statusOverlay.style.display = 'none';
        }, 3000);
    },

    /**
     * åˆå§‹åŒ–ç•Œé¢
     */
    initializeUI() {
        // è®¾ç½®å­˜å‚¨æ¨¡å¼é€‰æ‹©å™¨
        const storageSelect = document.getElementById('storage-select');
        if (storageSelect) {
            storageSelect.value = this.getStorageMode();
        }

        // åŠ è½½ç¬”è®°æœ¬é¢„è§ˆ
        this.loadNotebookPreview();
    },

    /**
     * ç»‘å®šäº‹ä»¶
     */
    bindEvents() {
        // å¼€å…³æ¨¡å¼åˆ‡æ¢
        document.getElementById('mode-switch').addEventListener('change', (e) => {
            const isQAMode = e.target.checked;
            this.switchMode(isQAMode ? 'qa' : 'note');
        });

        // ä¸»è¦æ“ä½œæŒ‰é’®
        document.getElementById('submit-btn').addEventListener('click', () => {
            this.handleSubmit();
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            this.clearInputs();
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            this.saveNote();
        });

        // æœ¬åœ°æ–‡ä»¶ä¿å­˜æŒ‰é’®
        document.getElementById('local-save-btn').addEventListener('click', () => {
            this.saveToLocalFile();
        });

        // ç»“æœåŒºåŸŸæŒ‰é’®
        document.getElementById('save-answer-btn').addEventListener('click', () => {
            this.saveLastResponse();
        });

        document.getElementById('copy-answer-btn').addEventListener('click', () => {
            this.copyAnswer();
        });

        document.getElementById('local-save-answer-btn').addEventListener('click', () => {
            this.saveLastResponseToLocalFile();
        });

        // ç¬”è®°æœ¬æ“ä½œæŒ‰é’®
        document.getElementById('export-btn').addEventListener('click', () => {
            this.exportNotebook();
        });

        document.getElementById('clear-notebook-btn').addEventListener('click', () => {
            this.clearNotebook();
        });

        document.getElementById('local-export-btn').addEventListener('click', () => {
            this.exportToLocalFile();
        });

        // å­˜å‚¨æ¨¡å¼åˆ‡æ¢
        document.getElementById('storage-select').addEventListener('change', (e) => {
            this.setStorageMode(e.target.value);
        });

        // é€€å‡ºç™»å½•
        document.getElementById('logout-btn').addEventListener('click', () => {
            this.logout();
        });

        // è¾“å…¥æ¡†å˜åŒ–ç›‘å¬
        document.getElementById('title-input').addEventListener('input', () => {
            this.validateInputs();
        });

        document.getElementById('content-input').addEventListener('input', () => {
            this.validateInputs();
        });

        // å›¾ç‰‡ç²˜è´´ç›‘å¬
        document.getElementById('content-input').addEventListener('paste', (event) => {
            this.handleImagePaste(event);
        });
    },

    /**
     * å¤„ç†å›¾ç‰‡ç²˜è´´
     */
    handleImagePaste(event) {
        const items = event.clipboardData.items;
        
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                const file = item.getAsFile();
                this.addImagePreview(file);
                event.preventDefault();
                break;
            }
        }
    },

    /**
     * æ·»åŠ å›¾ç‰‡é¢„è§ˆ
     */
    addImagePreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageSection = document.getElementById('image-preview-section');
            const container = document.getElementById('image-preview-container');
            
            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆåŒºåŸŸ
            imageSection.style.display = 'block';
            
            // åˆ›å»ºå›¾ç‰‡é¢„è§ˆå…ƒç´ 
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = file.name || 'ç²˜è´´çš„å›¾ç‰‡';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = 'Ã—';
            removeBtn.onclick = () => {
                preview.remove();
                // å¦‚æœæ²¡æœ‰å›¾ç‰‡äº†ï¼Œéšè—é¢„è§ˆåŒºåŸŸ
                if (container.children.length === 0) {
                    imageSection.style.display = 'none';
                }
            };
            
            preview.appendChild(img);
            preview.appendChild(removeBtn);
            container.appendChild(preview);
            
            // æ›´æ–°LocalNoteSaverçš„å›¾ç‰‡æ•°ç»„
            if (this.localNoteSaver) {
                this.localNoteSaver.addImage(e.target.result);
            }
        };
        
        reader.readAsDataURL(file);
        this.showMessage('å›¾ç‰‡å·²æ·»åŠ ï¼Œå°†åŒ…å«åœ¨ä¿å­˜çš„ç¬”è®°ä¸­', 'success');
    },

    /**
     * ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
     */
    async saveToLocalFile() {
        if (!this.localNoteSaver) {
            this.showMessage('æœ¬åœ°æ–‡ä»¶ä¿å­˜åŠŸèƒ½æœªåˆå§‹åŒ–', 'error');
            return;
        }

        try {
            const result = await this.localNoteSaver.saveNote();
            if (result && result.success) {
                this.showMessage(`å·²ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶: ${result.fileName}`, 'success');
                this.clearInputs();
            }
        } catch (error) {
            this.showMessage(`æœ¬åœ°ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        }
    },

    /**
     * ä¿å­˜æœ€åå›ç­”åˆ°æœ¬åœ°æ–‡ä»¶
     */
    async saveLastResponseToLocalFile() {
        if (!this.lastResponse || !this.localNoteSaver) {
            this.showMessage('æ²¡æœ‰å¯ä¿å­˜çš„å›ç­”æˆ–æœ¬åœ°ä¿å­˜åŠŸèƒ½æœªåˆå§‹åŒ–', 'warning');
            return;
        }

        try {
            // ä¸´æ—¶è®¾ç½®è¾“å…¥å†…å®¹ä¸ºAIå›ç­”
            const originalContent = this.localNoteSaver.getInputContent();
            const contentElement = document.getElementById('content-input');
            const aiResponse = this.lastResponse.ai_response?.response || this.lastResponse.content;
            
            contentElement.value = `AIå›ç­”ï¼š\n\n${aiResponse}`;
            
            const result = await this.localNoteSaver.saveNote();
            
            // æ¢å¤åŸå§‹å†…å®¹
            contentElement.value = originalContent;
            
            if (result && result.success) {
                this.showMessage(`AIå›ç­”å·²ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶: ${result.fileName}`, 'success');
            }
        } catch (error) {
            this.showMessage(`æœ¬åœ°ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        }
    },

    /**
     * å¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶
     */
    async exportToLocalFile() {
        if (!this.localNoteSaver) {
            this.showMessage('æœ¬åœ°æ–‡ä»¶ä¿å­˜åŠŸèƒ½æœªåˆå§‹åŒ–', 'error');
            return;
        }

        try {
            const notebookContent = this.qaSaver.getNotebookContent();
            if (!notebookContent.trim()) {
                this.showMessage('ç¬”è®°æœ¬ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º', 'warning');
                return;
            }

            // ä¸´æ—¶è®¾ç½®å†…å®¹
            const contentElement = document.getElementById('content-input');
            const originalContent = contentElement.value;
            
            contentElement.value = `# ç¬”è®°æœ¬å®Œæ•´å¯¼å‡º\n\n${notebookContent}`;
            
            const result = await this.localNoteSaver.saveNote();
            
            // æ¢å¤åŸå§‹å†…å®¹
            contentElement.value = originalContent;
            
            if (result && result.success) {
                this.showMessage(`ç¬”è®°æœ¬å·²å¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶: ${result.fileName}`, 'success');
            }
        } catch (error) {
            this.showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
        }
    },

    /**
     * åˆ‡æ¢æ¨¡å¼ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
     */
    switchMode(mode) {
        if (!['qa', 'note'].includes(mode)) {
            this.showMessage('æ— æ•ˆçš„æ¨¡å¼', 'error');
            return { success: false, error: 'æ— æ•ˆçš„æ¨¡å¼' };
        }

        this.currentMode = mode;

        // æ›´æ–°å¼€å…³çŠ¶æ€
        const modeSwitch = document.getElementById('mode-switch');
        modeSwitch.checked = (mode === 'qa');

        if (mode === 'qa') {
            // é—®ç­”æ¨¡å¼ç•Œé¢
            this.updateUIForQAMode();
        } else {
            // ç¬”è®°æ¨¡å¼ç•Œé¢
            this.updateUIForNoteMode();
        }

        return {
            success: true,
            data: {
                previousMode: this.currentMode,
                newMode: mode,
                switchedAt: new Date().toISOString()
            }
        };
    },

    /**
     * æ›´æ–°ç•Œé¢ä¸ºé—®ç­”æ¨¡å¼
     */
    updateUIForQAMode() {
        // æ›´æ–°æ ‡ç­¾å’Œæç¤º
        document.getElementById('title-label').textContent = 'é—®é¢˜æ ‡é¢˜';
        document.getElementById('content-label').textContent = 'é—®é¢˜å†…å®¹';
        document.getElementById('title-input').placeholder = 'è¯·è¾“å…¥é—®é¢˜æ ‡é¢˜...';
        document.getElementById('content-input').placeholder = 'è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜...ï¼ˆæ”¯æŒå›¾ç‰‡ç²˜è´´ï¼‰';
        document.getElementById('title-hint').textContent = 'ç®€è¦æè¿°æ‚¨çš„é—®é¢˜';
        document.getElementById('content-hint').textContent = 'è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜ï¼Œä»¥è·å¾—æ›´å‡†ç¡®çš„å›ç­”ã€‚æ”¯æŒCtrl+Vç²˜è´´å›¾ç‰‡';

        // æ˜¾ç¤ºAIæ™ºèƒ½ä½“é€‰æ‹©
        document.getElementById('agent-selection').style.display = 'block';

        // æ›´æ–°æŒ‰é’®
        document.getElementById('submit-text').textContent = 'ğŸš€ å‘é€é—®é¢˜';
        document.getElementById('save-btn').style.display = 'none';
        document.getElementById('local-save-btn').style.display = 'inline-flex';

        // éšè—ç¬”è®°æœ¬é¢„è§ˆï¼Œæ˜¾ç¤ºç»“æœåŒºåŸŸï¼ˆå¦‚æœæœ‰ï¼‰
        document.getElementById('notebook-section').style.display = 'none';
        if (this.lastResponse) {
            document.getElementById('result-section').style.display = 'block';
        }
    },

    /**
     * æ›´æ–°ç•Œé¢ä¸ºç¬”è®°æ¨¡å¼
     */
    updateUIForNoteMode() {
        // æ›´æ–°æ ‡ç­¾å’Œæç¤º
        document.getElementById('title-label').textContent = 'ç¬”è®°æ ‡é¢˜';
        document.getElementById('content-label').textContent = 'ç¬”è®°å†…å®¹';
        document.getElementById('title-input').placeholder = 'è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜...';
        document.getElementById('content-input').placeholder = 'è®°å½•æ‚¨çš„æƒ³æ³•ã€å­¦ä¹ ç¬”è®°ç­‰...ï¼ˆæ”¯æŒå›¾ç‰‡ç²˜è´´ï¼‰';
        document.getElementById('title-hint').textContent = 'ä¸ºæ‚¨çš„ç¬”è®°èµ·ä¸ªæ ‡é¢˜';
        document.getElementById('content-hint').textContent = 'è®°å½•æ‚¨çš„æƒ³æ³•ã€å­¦ä¹ å¿ƒå¾—æˆ–é‡è¦ä¿¡æ¯ã€‚æ”¯æŒCtrl+Vç²˜è´´å›¾ç‰‡';

        // éšè—AIæ™ºèƒ½ä½“é€‰æ‹©
        document.getElementById('agent-selection').style.display = 'none';

        // æ›´æ–°æŒ‰é’®
        document.getElementById('submit-text').textContent = 'ğŸ’¾ ä¿å­˜ç¬”è®°';
        document.getElementById('save-btn').style.display = 'inline-flex';
        document.getElementById('local-save-btn').style.display = 'inline-flex';

        // æ˜¾ç¤ºç¬”è®°æœ¬é¢„è§ˆï¼Œéšè—ç»“æœåŒºåŸŸ
        document.getElementById('result-section').style.display = 'none';
        document.getElementById('notebook-section').style.display = 'block';
        this.loadNotebookPreview();
    },

    /**
     * å¤„ç†æäº¤ï¼ˆé—®ç­”æˆ–ç¬”è®°ï¼‰
     */
    async handleSubmit() {
        if (this.isProcessing) {
            this.showMessage('è¯·ç­‰å¾…å½“å‰æ“ä½œå®Œæˆ', 'warning');
            return;
        }

        if (!this.validateInputs()) {
            return;
        }

        if (this.currentMode === 'qa') {
            await this.askQuestion();
        } else {
            await this.saveNote();
        }
    },

    /**
     * å‘é€é—®é¢˜ï¼ˆå«è‡ªåŠ¨ä¿å­˜é€»è¾‘ï¼‰
     */
    async askQuestion() {
        const questionData = this.getInputData();
        questionData.agent_id = this.getSelectedAgent();

        try {
            this.isProcessing = true;
            this.showLoading('æ­£åœ¨å‘AIæé—®...');

            // 1. æ¨¡æ‹ŸAIå›ç­”ï¼ˆå®é™…éƒ¨ç½²æ—¶è¿æ¥çœŸå®APIï¼‰
            const response = await this.mockAIResponse(questionData);

            if (response.success && response.data) {
                // 2. æ˜¾ç¤ºAIå›ç­”
                this.displayAIResponse(response.data);

                // 3. ä½¿ç”¨æ™ºèƒ½å­˜å‚¨å™¨è‡ªåŠ¨ä¿å­˜
                let autoSaveResult = null;
                try {
                    autoSaveResult = await this.qaSaver.saveContent({
                        title: `é—®ç­”ï¼š${questionData.title}`,
                        content: response.data.ai_response?.response || response.data.content,
                        type: 'qa',
                        agentId: questionData.agent_id,
                        tags: [...(questionData.tags || []), 'AIé—®ç­”', 'auto-saved']
                    });
                } catch (saveError) {
                    console.warn('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', saveError);
                    autoSaveResult = { success: false, error: saveError.message };
                }

                // 4. æ›´æ–°å“åº”æ•°æ®
                response.data.autoSaved = autoSaveResult ? autoSaveResult.success : false;
                response.data.autoSaveDetails = autoSaveResult;
                response.data.userMessage = this.generateSaveMessage(autoSaveResult);

                this.lastResponse = response.data;

                // 5. å¤„ç†é—®ç­”å®Œæˆåçš„åç»­æ“ä½œ
                await this.handleQuestionComplete(response);

                return response;

            } else {
                throw new Error(response.error || 'é—®ç­”å¤±è´¥');
            }

        } catch (error) {
            console.error('é—®ç­”å¤„ç†å¤±è´¥:', error);
            this.showMessage(`é—®ç­”å¤±è´¥: ${error.message}`, 'error');
            return {
                success: false,
                error: error.message,
                data: {
                    autoSaved: false,
                    autoSaveDetails: null
                }
            };

        } finally {
            this.isProcessing = false;
            this.hideLoading();
        }
    },

    /**
     * æ¨¡æ‹ŸAIå›ç­”ï¼ˆæ¼”ç¤ºç”¨ï¼‰
     */
    async mockAIResponse(questionData) {
        // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 1500));

        const responses = {
            general: `åŸºäºæ‚¨çš„é—®é¢˜"${questionData.title}"ï¼Œæˆ‘çš„å»ºè®®å¦‚ä¸‹ï¼š\n\nè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚æ ¹æ®æˆ‘çš„åˆ†æï¼Œæ‚¨å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è€ƒè™‘ï¼š\n\n1. é¦–å…ˆåˆ†æé—®é¢˜çš„æ ¸å¿ƒè¦ç‚¹\n2. ç„¶åå¯»æ‰¾ç›¸å…³çš„è§£å†³æ–¹æ¡ˆ\n3. æœ€ååˆ¶å®šå…·ä½“çš„æ‰§è¡Œè®¡åˆ’\n\nå¸Œæœ›è¿™ä¸ªå›ç­”å¯¹æ‚¨æœ‰å¸®åŠ©ã€‚å¦‚æœè¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚`,
            code: `å…³äºæ‚¨çš„ç¼–ç¨‹é—®é¢˜"${questionData.title}"ï¼š\n\nè¿™é‡Œæ˜¯ä¸€ä¸ªç¤ºä¾‹è§£å†³æ–¹æ¡ˆï¼š\n\n\`\`\`python\n# ç¤ºä¾‹ä»£ç \ndef solve_problem():\n    # å®ç°é€»è¾‘\n    result = process_data()\n    return result\n\`\`\`\n\nä¸»è¦è¦ç‚¹ï¼š\n- ä»£ç ç»“æ„æ¸…æ™°\n- æ³¨æ„é”™è¯¯å¤„ç†\n- æ€§èƒ½ä¼˜åŒ–è€ƒè™‘\n\nå»ºè®®æ‚¨å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–å’Œæµ‹è¯•è¿™ä¸ªæ–¹æ¡ˆã€‚`,
            writing: `å…³äºæ‚¨çš„å†™ä½œéœ€æ±‚"${questionData.title}"ï¼š\n\nå†™ä½œå»ºè®®å¦‚ä¸‹ï¼š\n\n**ç»“æ„æ¡†æ¶ï¼š**\n1. å¼€å¤´ï¼šå¼•å…¥ä¸»é¢˜ï¼Œå¸å¼•è¯»è€…\n2. ä¸»ä½“ï¼šè¯¦ç»†å±•å¼€ï¼Œé€»è¾‘æ¸…æ™°\n3. ç»“å°¾ï¼šæ€»ç»“è¦ç‚¹ï¼Œå‘¼åº”å¼€å¤´\n\n**å†™ä½œæŠ€å·§ï¼š**\n- è¯­è¨€ç®€æ´æ˜äº†\n- é€»è¾‘ç»“æ„æ¸…æ™°\n- é€‚å½“ä½¿ç”¨ä¾‹å­è¯´æ˜\n\nå¸Œæœ›è¿™äº›å»ºè®®èƒ½å¸®åŠ©æ‚¨å®Œæˆé«˜è´¨é‡çš„å†™ä½œã€‚`
        };

        return {
            success: true,
            data: {
                questionId: `q_${Date.now()}`,
                ai_response: {
                    response: responses[questionData.agent_id] || responses.general,
                    tokens_used: Math.floor(Math.random() * 1000) + 500,
                    model: questionData.agent_id === 'code' ? 'GPT-4-Code' : 'GPT-4'
                },
                agent_id: questionData.agent_id,
                timestamp: new Date().toISOString()
            }
        };
    },

    /**
     * é—®ç­”å®Œæˆåçš„åç»­å¤„ç†
     */
    async handleQuestionComplete(result) {
        if (result.success && result.data.autoSaved) {
            // è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬”è®°æ¨¡å¼
            setTimeout(() => {
                this.switchMode('note');
            }, 1000);

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            this.showMessage(
                result.data.userMessage || 'é—®ç­”å·²è‡ªåŠ¨ä¿å­˜ä¸ºç¬”è®°',
                'success',
                {
                    duration: 4000,
                    actions: [
                        {
                            text: 'æŸ¥çœ‹ç¬”è®°',
                            callback: () => {
                                this.switchMode('note');
                                this.loadNotebookPreview();
                            }
                        }
                    ]
                }
            );

        } else if (result.success && !result.data.autoSaved) {
            // é—®ç­”æˆåŠŸä½†è‡ªåŠ¨ä¿å­˜å¤±è´¥
            this.showMessage(
                'AIå›ç­”æˆåŠŸï¼Œä½†è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¿å­˜',
                'warning',
                {
                    duration: 5000,
                    actions: [
                        {
                            text: 'æ‰‹åŠ¨ä¿å­˜',
                            callback: () => this.saveLastResponse()
                        }
                    ]
                }
            );
        }
    },

    /**
     * ä¿å­˜ç¬”è®°
     */
    async saveNote() {
        const noteData = this.getInputData();

        if (!noteData.title.trim() || !noteData.content.trim()) {
            this.showMessage('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹', 'warning');
            return;
        }

        try {
            this.isProcessing = true;
            this.showLoading('æ­£åœ¨ä¿å­˜ç¬”è®°...');

            const result = await this.qaSaver.saveContent({
                title: noteData.title,
                content: noteData.content,
                type: 'note',
                tags: noteData.tags || []
            });

            if (result.success) {
                this.showMessage('ç¬”è®°ä¿å­˜æˆåŠŸï¼', 'success');
                this.clearInputs();
                await this.loadNotebookPreview();
            } else {
                throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
            }

            return this.formatSaveResult(result);

        } catch (error) {
            console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
            this.showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            return {
                success: false,
                error: error.message
            };

        } finally {
            this.isProcessing = false;
            this.hideLoading();
        }
    },

    /**
     * æ˜¾ç¤ºAIå›ç­”
     */
    displayAIResponse(data) {
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');
        const resultMeta = document.getElementById('result-meta');

        // æ˜¾ç¤ºå›ç­”å†…å®¹
        const aiResponse = data.ai_response?.response || data.content || 'æœªèƒ½è·å–åˆ°å›ç­”';
        resultContent.textContent = aiResponse;

        // æ˜¾ç¤ºå…ƒä¿¡æ¯
        const metaHTML = `
            <div class="meta-item">æ—¶é—´: ${new Date().toLocaleString('zh-CN')}</div>
            <div class="meta-item">æ™ºèƒ½ä½“: ${this.getAgentDisplayName(data.agent_id)}</div>
            ${data.ai_response?.tokens_used ? `<div class="meta-item">Token: ${data.ai_response.tokens_used}</div>` : ''}
            ${data.autoSaved ? '<div class="meta-item" style="color: #10b981;">âœ… å·²è‡ªåŠ¨ä¿å­˜</div>' : '<div class="meta-item" style="color: #f59e0b;">âš ï¸ è‡ªåŠ¨ä¿å­˜å¤±è´¥</div>'}
        `;
        resultMeta.innerHTML = metaHTML;

        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth' });
    },

    /**
     * è·å–æ™ºèƒ½ä½“æ˜¾ç¤ºåç§°
     */
    getAgentDisplayName(agentId) {
        const names = {
            general: 'ğŸ§  é€šç”¨æ™ºèƒ½ä½“',
            code: 'ğŸ’» ä»£ç åŠ©æ‰‹', 
            writing: 'âœï¸ å†™ä½œåŠ©æ‰‹'
        };
        return names[agentId] || 'é€šç”¨';
    },

    /**
     * è·å–è¾“å…¥æ•°æ®
     */
    getInputData() {
        const title = document.getElementById('title-input').value.trim();
        const content = document.getElementById('content-input').value.trim();
        const tagsText = document.getElementById('tags-input').value.trim();
        const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

        return { title, content, tags };
    },

    /**
     * è·å–é€‰ä¸­çš„AIæ™ºèƒ½ä½“
     */
    getSelectedAgent() {
        const select = document.getElementById('agent-select');
        return select ? select.value : 'general';
    },

    /**
     * éªŒè¯è¾“å…¥
     */
    validateInputs() {
        const { title, content } = this.getInputData();
        const isValid = title.trim() && content.trim();

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = !isValid;

        return isValid;
    },

    /**
     * æ¸…ç©ºè¾“å…¥æ¡†
     */
    clearInputs() {
        document.getElementById('title-input').value = '';
        document.getElementById('content-input').value = '';
        document.getElementById('tags-input').value = '';
        
        // é‡ç½®AIæ™ºèƒ½ä½“é€‰æ‹©
        const agentSelect = document.getElementById('agent-select');
        if (agentSelect) {
            agentSelect.value = 'general';
        }

        // æ¸…ç©ºå›¾ç‰‡é¢„è§ˆ
        const imageSection = document.getElementById('image-preview-section');
        const container = document.getElementById('image-preview-container');
        container.innerHTML = '';
        imageSection.style.display = 'none';

        // æ¸…ç©ºLocalNoteSaverçš„å›¾ç‰‡
        if (this.localNoteSaver) {
            this.localNoteSaver.images = [];
        }
        
        this.validateInputs();

        return { success: true };
    },

    /**
     * åŠ è½½ç”¨æˆ·ä¿¡æ¯
     */
    loadUserInfo() {
        // è¿™é‡Œåº”è¯¥ä»AuthBlockè·å–ç”¨æˆ·ä¿¡æ¯
        // æš‚æ—¶ä½¿ç”¨æ¼”ç¤ºæ•°æ®
        const userDisplay = document.getElementById('user-display');
        userDisplay.textContent = 'æ¼”ç¤ºç”¨æˆ·';
    },

    /**
     * åŠ è½½ç¬”è®°æœ¬é¢„è§ˆ
     */
    async loadNotebookPreview() {
        const notebookContent = document.getElementById('notebook-content');
        const content = this.qaSaver.getNotebookContent();

        if (content.trim()) {
            notebookContent.innerHTML = `<pre style="white-space: pre-wrap; padding: 1rem; font-family: monospace; line-height: 1.6;">${content}</pre>`;
        } else {
            notebookContent.innerHTML = '<div class="empty-state"><p>ğŸ“ è¿˜æ²¡æœ‰ç¬”è®°ï¼Œå¼€å§‹è®°å½•æ‚¨çš„æƒ³æ³•å§ï¼</p></div>';
        }
    },

    /**
     * ä¿å­˜æœ€åä¸€æ¬¡å›ç­”
     */
    async saveLastResponse() {
        if (!this.lastResponse) {
            this.showMessage('æ²¡æœ‰å¯ä¿å­˜çš„å›ç­”', 'warning');
            return;
        }

        try {
            const content = this.lastResponse.ai_response?.response || this.lastResponse.content;
            const result = await this.qaSaver.saveContent({
                title: `æ‰‹åŠ¨ä¿å­˜çš„é—®ç­”`,
                content: content,
                type: 'qa-manual',
                tags: ['æ‰‹åŠ¨ä¿å­˜', 'AIé—®ç­”']
            });

            if (result.success) {
                this.showMessage('å›ç­”å·²ä¿å­˜ä¸ºç¬”è®°ï¼', 'success');
                this.loadNotebookPreview();
            } else {
                throw new Error(result.error);
            }

        } catch (error) {
            this.showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        }
    },

    /**
     * å¤åˆ¶å›ç­”
     */
    copyAnswer() {
        const resultContent = document.getElementById('result-content');
        const text = resultContent.textContent;

        navigator.clipboard.writeText(text).then(() => {
            this.showMessage('å›ç­”å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(error => {
            this.showMessage('å¤åˆ¶å¤±è´¥', 'error');
        });
    },

    /**
     * å¯¼å‡ºç¬”è®°æœ¬
     */
    exportNotebook() {
        try {
            this.qaSaver.exportNotebook();
            this.showMessage('ç¬”è®°æœ¬å¯¼å‡ºæˆåŠŸï¼', 'success');
        } catch (error) {
            this.showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
        }
    },

    /**
     * æ¸…ç©ºç¬”è®°æœ¬
     */
    clearNotebook() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            this.qaSaver.clearNotebook();
            this.loadNotebookPreview();
            this.showMessage('ç¬”è®°æœ¬å·²æ¸…ç©º', 'info');
        }
    },

    /**
     * è®¾ç½®å­˜å‚¨æ¨¡å¼
     */
    setStorageMode(mode) {
        if (mode === 'file') {
            // æ–‡ä»¶ç›´æ¥è¯»å†™æ¨¡å¼
            this.showMessage('å·²åˆ‡æ¢åˆ°æœ¬åœ°æ–‡ä»¶ç›´æ¥è¯»å†™æ¨¡å¼', 'info');
            return { success: true };
        }

        const result = this.qaSaver.switchMode(mode);
        if (result.success) {
            localStorage.setItem('qa_storage_mode', mode);
            this.showMessage(`å­˜å‚¨æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${this.getStorageModeDisplay(mode)}`, 'info');
        }
        return result;
    },

    /**
     * è·å–å­˜å‚¨æ¨¡å¼
     */
    getStorageMode() {
        return localStorage.getItem('qa_storage_mode') || 'hybrid';
    },

    /**
     * è·å–å­˜å‚¨æ¨¡å¼æ˜¾ç¤ºåç§°
     */
    getStorageModeDisplay(mode) {
        const displays = {
            'hybrid': 'æ··åˆæ¨¡å¼',
            'server': 'ä»…æœåŠ¡å™¨',
            'local': 'ä»…æœ¬åœ°',
            'file': 'æœ¬åœ°æ–‡ä»¶ç›´æ¥è¯»å†™'
        };
        return displays[mode] || mode;
    },

    /**
     * ç”Ÿæˆä¿å­˜æ¶ˆæ¯
     */
    generateSaveMessage(saveResult) {
        if (!saveResult) return 'é—®ç­”å®Œæˆï¼Œä½†ä¿å­˜å¤±è´¥';

        const mode = this.qaSaver.config.mode;

        if (mode === 'hybrid') {
            if (saveResult.synced) {
                return 'é—®ç­”å·²å®Œæˆå¹¶åŒæ­¥ä¿å­˜åˆ°æœåŠ¡å™¨å’Œæœ¬åœ°';
            } else {
                return 'é—®ç­”å·²å®Œæˆå¹¶ä¿å­˜åˆ°æœ¬åœ°ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤æ—¶åŒæ­¥';
            }
        } else if (mode === 'server') {
            return saveResult.success ? 'é—®ç­”å·²å®Œæˆå¹¶ä¿å­˜åˆ°æœåŠ¡å™¨' : 'é—®ç­”å®Œæˆï¼Œä½†æœåŠ¡å™¨ä¿å­˜å¤±è´¥';
        } else {
            return saveResult.success ? 'é—®ç­”å·²å®Œæˆå¹¶ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶' : 'é—®ç­”å®Œæˆï¼Œä½†æœ¬åœ°ä¿å­˜å¤±è´¥';
        }
    },

    /**
     * æ ¼å¼åŒ–ä¿å­˜ç»“æœ
     */
    formatSaveResult(result) {
        return {
            success: result.success || false,
            data: {
                noteId: result.id || result.server?.id || `local_${Date.now()}`,
                savedAt: new Date().toISOString(),
                storageMode: this.qaSaver.config.mode,
                storage: {
                    server: {
                        success: result.server?.success || false,
                        noteId: result.server?.id,
                        error: result.server?.error
                    },
                    local: {
                        success: result.local?.success || result.cached || false,
                        cached: result.cached || false,
                        downloaded: result.local?.downloaded || false,
                        error: result.local?.error
                    }
                },
                performance: {
                    totalTime: result.performance?.totalTime || 0,
                    mode: this.qaSaver.config.mode
                }
            },
            error: result.error
        };
    },

    /**
     * é€€å‡ºç™»å½•
     */
    logout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            localStorage.removeItem('qa_auth_token');
            window.location.href = 'auth-block/auth.html';
        }
    },

    /**
     * æ˜¾ç¤ºæ¶ˆæ¯
     */
    showMessage(text, type = 'info', options = {}) {
        const messageContainer = document.getElementById('message-container');
        const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message-toast message-${type}`;
        messageDiv.id = messageId;

        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            warning: 'âš ï¸',
            info: 'â„¹ï¸'
        };

        let messageHTML = `
            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                <span style="font-size: 1.1rem;">${icons[type]}</span>
                <div style="flex: 1;">
                    <div>${text}</div>
        `;

        if (options.actions && options.actions.length > 0) {
            messageHTML += '<div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">';
            options.actions.forEach((action, index) => {
                messageHTML += `<button onclick="QANoteBlock.handleMessageAction('${messageId}', ${index})" style="padding: 0.25rem 0.75rem; border: 1px solid currentColor; background: transparent; color: inherit; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">${action.text}</button>`;
            });
            messageHTML += '</div>';
        }

        messageHTML += `
                </div>
                <button onclick="QANoteBlock.removeMessage('${messageId}')" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem; opacity: 0.7;">&times;</button>
            </div>
        `;

        messageDiv.innerHTML = messageHTML;
        messageContainer.appendChild(messageDiv);

        // å­˜å‚¨åŠ¨ä½œå›è°ƒ
        if (options.actions) {
            messageDiv._actions = options.actions;
        }

        // æ˜¾ç¤ºåŠ¨ç”»
        requestAnimationFrame(() => {
            messageDiv.classList.add('show');
        });

        // è‡ªåŠ¨å…³é—­
        const duration = options.duration || 3000;
        if (duration > 0) {
            setTimeout(() => {
                this.removeMessage(messageId);
            }, duration);
        }
    },

    /**
     * å¤„ç†æ¶ˆæ¯åŠ¨ä½œ
     */
    handleMessageAction(messageId, actionIndex) {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv && messageDiv._actions && messageDiv._actions[actionIndex]) {
            const action = messageDiv._actions[actionIndex];
            if (action.callback) {
                action.callback();
            }
        }
        this.removeMessage(messageId);
    },

    /**
     * ç§»é™¤æ¶ˆæ¯
     */
    removeMessage(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
            messageDiv.classList.remove('show');
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }
    },

    /**
     * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
     */
    showLoading(text = 'å¤„ç†ä¸­...') {
        const overlay = document.getElementById('loading-overlay');
        const loadingText = document.querySelector('.loading-text');
        if (loadingText) {
            loadingText.textContent = text;
        }
        overlay.style.display = 'flex';
    },

    /**
     * éšè—åŠ è½½çŠ¶æ€
     */
    hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'none';
    },

    /**
     * ä¿å­˜å¤±è´¥æ—¶çš„æ‰‹åŠ¨å…œåº•æ“ä½œ
     */
    handleSaveSuccess(result) {
        console.log('ä¿å­˜æˆåŠŸ:', result);
    },

    handleSaveError(error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
    }
};

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    QANoteBlock.init();
}); 