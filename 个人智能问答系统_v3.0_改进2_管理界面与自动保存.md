# ä¸ªäººæ™ºèƒ½é—®ç­”ç³»ç»Ÿ v3.0 æ”¹è¿›2ï¼šç®¡ç†ç•Œé¢ä¸è‡ªåŠ¨ä¿å­˜

## ğŸ“‹ **æ”¹è¿›æ¦‚è¿°**

**æ”¹è¿›ç›®æ ‡**ï¼šè¡¥é½v3.0ç‰ˆæœ¬çš„ç®¡ç†ç•Œé¢å¯è§†åŒ–å’Œè‡ªåŠ¨ä¿å­˜æµç¨‹å®Œæ•´æ€§
**æ ¸å¿ƒæ”¹è¿›**ï¼šadmin.htmlç®¡ç†ç•Œé¢ + autoSavedæµç¨‹ + UIBlockæ¶ˆæ¯ç³»ç»Ÿ
**å½±å“èŒƒå›´**ï¼šDeployBlockã€QANoteBlockã€UIBlockçš„åŠŸèƒ½å®Œå–„

---

## ğŸš¨ **é—®é¢˜åˆ†æï¼šv3.0åŠŸèƒ½é€€åŒ–**

### **é—®é¢˜æ¥æº**
v3.0åœ¨æ¶æ„è§£è€¦è¿‡ç¨‹ä¸­ï¼Œä¸¢å¤±äº†v2.0ç‰ˆæœ¬çš„ä¸¤ä¸ªå…³é”®åŠŸèƒ½ï¼š

| åŠŸèƒ½ç‚¹ | v2.0çŠ¶æ€ | v3.0çŠ¶æ€ | é—®é¢˜å½±å“ |
|--------|----------|----------|----------|
| **ç®¡ç†ç•Œé¢** | âœ… å®Œæ•´admin.html | âŒ åªæœ‰APIæ¥å£ | æ— æ³•å¯è§†åŒ–ç³»ç»Ÿç®¡ç† |
| **è‡ªåŠ¨ä¿å­˜** | âœ… å®Œæ•´æµç¨‹ | âŒ autoSavedå­—æ®µç¼ºå¤± | é—®ç­”â†’ç¬”è®°è½¬æ¢ä¸­æ–­ |
| **æ¶ˆæ¯æç¤º** | âœ… showMessageå®ç° | âŒ åªæœ‰æ¥å£å®šä¹‰ | ç”¨æˆ·åé¦ˆç¼ºå¤± |

### **å…·ä½“é€€åŒ–è¡¨ç°**

#### **ç®¡ç†ç•Œé¢é€€åŒ–**
```html
<!-- v2.0ç‰ˆæœ¬æœ‰å®Œæ•´çš„å¯¼èˆª -->
<nav class="nav-menu">
    <a href="index.html">ğŸ’¬ é—®ç­”</a>
    <a href="notes.html">ğŸ“ ç¬”è®°</a>
    <a href="admin.html">âš™ï¸ ç®¡ç†</a>  <!-- v3.0ä¸­æ¶ˆå¤± -->
</nav>
```

#### **è‡ªåŠ¨ä¿å­˜æµç¨‹ä¸­æ–­**
```javascript
// v3.0æœŸæœ›æµç¨‹ï¼ˆä½†ä¸å®Œæ•´ï¼‰
QANoteBlock.askQuestion().then(result => {
    if (result.data.autoSaved) { // âŒ å­—æ®µä¸å­˜åœ¨
        QANoteBlock.switchMode('note');
        UIBlock.showMessage('å·²è‡ªåŠ¨ä¿å­˜', 'success'); // âŒ æ–¹æ³•æœªå®ç°
    }
});
```

---

## ğŸ¯ **æ”¹è¿›æ–¹æ¡ˆï¼šç®¡ç†ç•Œé¢æ•´åˆ**

### **1. admin.htmlå®Œæ•´ç•Œé¢è®¾è®¡**

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç† - æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="navbar">
        <div class="nav-container">
            <h1 class="logo">âš™ï¸ ç³»ç»Ÿç®¡ç†</h1>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">ğŸ’¬ é—®ç­”</a>
                <a href="notes.html" class="nav-item">ğŸ“ ç¬”è®°</a>
                <a href="admin.html" class="nav-item active">âš™ï¸ ç®¡ç†</a>
            </nav>
            <div class="user-info">
                <span id="admin-username">ç®¡ç†å‘˜</span>
                <button id="logout-btn" class="btn btn-sm">é€€å‡º</button>
            </div>
        </div>
    </header>

    <!-- ä¸»ç®¡ç†ç•Œé¢ -->
    <main class="admin-main">
        <!-- ç³»ç»Ÿç›‘æ§é¢æ¿ -->
        <section class="metrics-section">
            <h2>ğŸ“Š ç³»ç»Ÿç›‘æ§</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">ğŸ–¥ï¸</div>
                    <div class="metric-info">
                        <span class="metric-label">CPUä½¿ç”¨ç‡</span>
                        <span class="metric-value" id="cpu-usage">--</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">ğŸ§ </div>
                    <div class="metric-info">
                        <span class="metric-label">å†…å­˜ä½¿ç”¨</span>
                        <span class="metric-value" id="memory-usage">--</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">ğŸ’¾</div>
                    <div class="metric-info">
                        <span class="metric-label">ç£ç›˜ç©ºé—´</span>
                        <span class="metric-value" id="disk-usage">--</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">ğŸŒ</div>
                    <div class="metric-info">
                        <span class="metric-label">ç½‘ç»œæµé‡</span>
                        <span class="metric-value" id="network-usage">--</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- æœåŠ¡ç®¡ç†é¢æ¿ -->
        <section class="services-section">
            <h2>ğŸ”§ æœåŠ¡ç®¡ç†</h2>
            <div class="services-grid">
                <div class="service-card">
                    <div class="service-header">
                        <h3>ğŸŒ å‰ç«¯æœåŠ¡</h3>
                        <span class="service-status" id="frontend-status">è¿è¡Œä¸­</span>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-primary" onclick="restartService('qa-frontend')">é‡å¯</button>
                        <button class="btn btn-secondary" onclick="viewLogs('qa-frontend')">æŸ¥çœ‹æ—¥å¿—</button>
                    </div>
                </div>
                
                <div class="service-card">
                    <div class="service-header">
                        <h3>ğŸ”Œ åç«¯æœåŠ¡</h3>
                        <span class="service-status" id="backend-status">è¿è¡Œä¸­</span>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-primary" onclick="restartService('qa-backend')">é‡å¯</button>
                        <button class="btn btn-secondary" onclick="viewLogs('qa-backend')">æŸ¥çœ‹æ—¥å¿—</button>
                    </div>
                </div>
                
                <div class="service-card">
                    <div class="service-header">
                        <h3>ğŸ—„ï¸ æ•°æ®åº“</h3>
                        <span class="service-status" id="mysql-status">è¿è¡Œä¸­</span>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-primary" onclick="restartService('mysql')">é‡å¯</button>
                        <button class="btn btn-secondary" onclick="viewLogs('mysql')">æŸ¥çœ‹æ—¥å¿—</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç”¨æˆ·ç®¡ç†é¢æ¿ -->
        <section class="users-section">
            <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
            <div class="users-controls">
                <button class="btn btn-primary" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
                <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·..." />
            </div>
            <div class="users-table-container">
                <table class="users-table" id="users-table">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·å</th>
                            <th>è§’è‰²</th>
                            <th>çŠ¶æ€</th>
                            <th>æœ€åç™»å½•</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <!-- ç”¨æˆ·åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ç³»ç»Ÿæ—¥å¿—é¢æ¿ -->
        <section class="logs-section">
            <h2>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="logs-controls">
                <select id="log-level">
                    <option value="all">æ‰€æœ‰çº§åˆ«</option>
                    <option value="error">é”™è¯¯</option>
                    <option value="warning">è­¦å‘Š</option>
                    <option value="info">ä¿¡æ¯</option>
                </select>
                <button class="btn btn-secondary" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn btn-primary" onclick="refreshLogs()">åˆ·æ–°</button>
            </div>
            <div class="logs-container" id="logs-container">
                <!-- æ—¥å¿—å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
    </main>

    <!-- è„šæœ¬å¼•å…¥ -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin.js"></script>
</body>
</html>
```

### **2. DeployBlockåŠŸèƒ½å®Œå–„**

#### **ç³»ç»ŸæŒ‡æ ‡é‡‡é›†å®ç°**
```javascript
// deploy-block/deploy.js - ç³»ç»Ÿç›‘æ§å®Œæ•´å®ç°
window.DeployBlock = {
    // åŸæœ‰æ¥å£ä¿æŒä¸å˜...
    
    /**
     * è·å–ç³»ç»ŸæŒ‡æ ‡ï¼ˆå®Œæ•´å®ç°ï¼‰
     */
    getSystemMetrics: async () => {
        try {
            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
            const currentUser = AuthBlock.getCurrentUser();
            if (!currentUser || currentUser.role !== 'admin') {
                return {
                    success: false,
                    error: "æƒé™ä¸è¶³ï¼Œä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ç³»ç»ŸæŒ‡æ ‡"
                };
            }

            // æ¨¡æ‹Ÿç³»ç»ŸæŒ‡æ ‡é‡‡é›†ï¼ˆå®é™…éƒ¨ç½²æ—¶å¯è¿æ¥çœŸå®ç›‘æ§APIï¼‰
            const metrics = {
                cpu: {
                    usage: Math.floor(Math.random() * 60 + 20), // 20-80%
                    cores: navigator.hardwareConcurrency || 4,
                    loadAverage: [1.2, 1.5, 1.8]
                },
                memory: {
                    total: 8 * 1024 * 1024 * 1024, // 8GB
                    used: Math.floor(Math.random() * 4 + 2) * 1024 * 1024 * 1024, // 2-6GB
                    available: null // è®¡ç®—å¾—å‡º
                },
                disk: {
                    total: 500 * 1024 * 1024 * 1024, // 500GB
                    used: Math.floor(Math.random() * 200 + 100) * 1024 * 1024 * 1024, // 100-300GB
                    available: null // è®¡ç®—å¾—å‡º
                },
                network: {
                    bytesIn: Math.floor(Math.random() * 1000000) + 500000, // 0.5-1.5MB
                    bytesOut: Math.floor(Math.random() * 500000) + 200000, // 0.2-0.7MB
                    packetsIn: Math.floor(Math.random() * 1000) + 500,
                    packetsOut: Math.floor(Math.random() * 800) + 300
                }
            };

            // è®¡ç®—å¯ç”¨ç©ºé—´
            metrics.memory.available = metrics.memory.total - metrics.memory.used;
            metrics.disk.available = metrics.disk.total - metrics.disk.used;

            return {
                success: true,
                data: {
                    timestamp: new Date().toISOString(),
                    uptime: Math.floor(Math.random() * 86400 * 7), // 0-7å¤©è¿è¡Œæ—¶é—´
                    metrics: metrics,
                    formatted: {
                        cpu: `${metrics.cpu.usage}%`,
                        memory: `${(metrics.memory.used / 1024 / 1024 / 1024).toFixed(1)}GB / ${(metrics.memory.total / 1024 / 1024 / 1024).toFixed(1)}GB`,
                        disk: `${(metrics.disk.used / 1024 / 1024 / 1024).toFixed(1)}GB / ${(metrics.disk.total / 1024 / 1024 / 1024).toFixed(1)}GB`,
                        network: `â†“${(metrics.network.bytesIn / 1024 / 1024).toFixed(2)}MB â†‘${(metrics.network.bytesOut / 1024 / 1024).toFixed(2)}MB`
                    }
                }
            };

        } catch (error) {
            return {
                success: false,
                error: `è·å–ç³»ç»ŸæŒ‡æ ‡å¤±è´¥: ${error.message}`
            };
        }
    },

    /**
     * è·å–æœåŠ¡çŠ¶æ€
     */
    getServicesStatus: async () => {
        try {
            const currentUser = AuthBlock.getCurrentUser();
            if (!currentUser || currentUser.role !== 'admin') {
                return {
                    success: false,
                    error: "æƒé™ä¸è¶³"
                };
            }

            // æ¨¡æ‹ŸæœåŠ¡çŠ¶æ€æ£€æŸ¥
            const services = {
                'qa-frontend': {
                    status: 'running',
                    uptime: Math.floor(Math.random() * 86400 * 3),
                    port: 3000,
                    health: 'healthy'
                },
                'qa-backend': {
                    status: 'running',
                    uptime: Math.floor(Math.random() * 86400 * 3),
                    port: 8000,
                    health: 'healthy'
                },
                'mysql': {
                    status: 'running',
                    uptime: Math.floor(Math.random() * 86400 * 7),
                    port: 3306,
                    health: 'healthy'
                }
            };

            return {
                success: true,
                data: {
                    services: services,
                    totalServices: Object.keys(services).length,
                    runningServices: Object.values(services).filter(s => s.status === 'running').length,
                    lastChecked: new Date().toISOString()
                }
            };

        } catch (error) {
            return {
                success: false,
                error: `è·å–æœåŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`
            };
        }
    },

    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰
     */
    getUsersList: async (page = 1, size = 20, role = null) => {
        try {
            const currentUser = AuthBlock.getCurrentUser();
            if (!currentUser || currentUser.role !== 'admin') {
                return {
                    success: false,
                    error: "æƒé™ä¸è¶³ï¼Œä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨"
                };
            }

            // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®ï¼ˆå®é™…ä¼šä»APIè·å–ï¼‰
            const mockUsers = [
                {
                    id: 1,
                    username: 'admin',
                    displayName: 'ç³»ç»Ÿç®¡ç†å‘˜',
                    email: 'admin@example.com',
                    role: 'admin',
                    isActive: true,
                    lastLoginAt: new Date(Date.now() - 3600000).toISOString(),
                    createdAt: new Date(Date.now() - 86400000 * 30).toISOString()
                },
                {
                    id: 2,
                    username: 'user1',
                    displayName: 'ç”¨æˆ·1',
                    email: 'user1@example.com',
                    role: 'user',
                    isActive: true,
                    lastLoginAt: new Date(Date.now() - 7200000).toISOString(),
                    createdAt: new Date(Date.now() - 86400000 * 15).toISOString()
                }
            ];

            // è§’è‰²è¿‡æ»¤
            let filteredUsers = mockUsers;
            if (role) {
                filteredUsers = mockUsers.filter(user => user.role === role);
            }

            // åˆ†é¡µ
            const startIndex = (page - 1) * size;
            const endIndex = startIndex + size;
            const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

            return {
                success: true,
                data: {
                    users: paginatedUsers,
                    total: filteredUsers.length,
                    page: page,
                    size: size,
                    totalPages: Math.ceil(filteredUsers.length / size)
                }
            };

        } catch (error) {
            return {
                success: false,
                error: `è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${error.message}`
            };
        }
    }
};
```

### **3. ç®¡ç†ç•Œé¢äº¤äº’é€»è¾‘**

```javascript
// js/admin.js - ç®¡ç†ç•Œé¢æ§åˆ¶å™¨
class AdminController {
    constructor() {
        this.refreshInterval = null;
        this.init();
    }

    async init() {
        // æƒé™æ£€æŸ¥
        if (!this.checkAdminPermission()) {
            window.location.href = 'index.html';
            return;
        }

        // åˆå§‹åŒ–ç•Œé¢
        await this.loadInitialData();
        this.setupEventListeners();
        this.startAutoRefresh();
    }

    checkAdminPermission() {
        const currentUser = AuthBlock.getCurrentUser();
        return currentUser && currentUser.role === 'admin';
    }

    async loadInitialData() {
        await Promise.all([
            this.updateSystemMetrics(),
            this.updateServicesStatus(),
            this.loadUsersList()
        ]);
    }

    async updateSystemMetrics() {
        try {
            const result = await DeployBlock.getSystemMetrics();
            if (result.success) {
                const metrics = result.data.formatted;
                document.getElementById('cpu-usage').textContent = metrics.cpu;
                document.getElementById('memory-usage').textContent = metrics.memory;
                document.getElementById('disk-usage').textContent = metrics.disk;
                document.getElementById('network-usage').textContent = metrics.network;
            }
        } catch (error) {
            console.error('æ›´æ–°ç³»ç»ŸæŒ‡æ ‡å¤±è´¥:', error);
        }
    }

    async updateServicesStatus() {
        try {
            const result = await DeployBlock.getServicesStatus();
            if (result.success) {
                const services = result.data.services;
                Object.keys(services).forEach(serviceName => {
                    const service = services[serviceName];
                    const statusElement = document.getElementById(`${serviceName.split('-')[1]}-status`);
                    if (statusElement) {
                        statusElement.textContent = service.status === 'running' ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                        statusElement.className = `service-status ${service.status}`;
                    }
                });
            }
        } catch (error) {
            console.error('æ›´æ–°æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
        }
    }

    async loadUsersList() {
        try {
            const result = await DeployBlock.getUsersList();
            if (result.success) {
                this.renderUsersTable(result.data.users);
            }
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    renderUsersTable(users) {
        const tbody = document.getElementById('users-tbody');
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.username}</td>
                <td><span class="role-badge ${user.role}">${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</span></td>
                <td><span class="status-badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</span></td>
                <td>${new Date(user.lastLoginAt).toLocaleString('zh-CN')}</td>
                <td>
                    <button class="btn btn-sm" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-danger" onclick="toggleUserStatus(${user.id}, ${!user.isActive})">${user.isActive ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                </td>
            </tr>
        `).join('');
    }

    setupEventListeners() {
        // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.stopAutoRefresh();
            } else {
                this.startAutoRefresh();
            }
        });
    }

    startAutoRefresh() {
        this.refreshInterval = setInterval(() => {
            this.updateSystemMetrics();
            this.updateServicesStatus();
        }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
    }

    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }
}

// å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLç›´æ¥è°ƒç”¨ï¼‰
async function restartService(serviceName) {
    if (!confirm(`ç¡®å®šè¦é‡å¯ ${serviceName} æœåŠ¡å—ï¼Ÿ`)) {
        return;
    }

    try {
        const result = await DeployBlock.restartService(serviceName);
        if (result.success) {
            UIBlock.showMessage(`${serviceName} æœåŠ¡é‡å¯æˆåŠŸ`, 'success');
        } else {
            UIBlock.showMessage(`é‡å¯å¤±è´¥: ${result.error}`, 'error');
        }
    } catch (error) {
        UIBlock.showMessage(`é‡å¯å¤±è´¥: ${error.message}`, 'error');
    }
}

async function viewLogs(serviceName) {
    // æ˜¾ç¤ºæ—¥å¿—æŸ¥çœ‹å™¨
    UIBlock.showMessage(`æ­£åœ¨åŠ è½½ ${serviceName} æ—¥å¿—...`, 'info');
    // è¿™é‡Œå¯ä»¥æ‰©å±•æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½
}

// åˆå§‹åŒ–ç®¡ç†æ§åˆ¶å™¨
document.addEventListener('DOMContentLoaded', () => {
    new AdminController();
});
```

---

## ğŸ”„ **æ”¹è¿›æ–¹æ¡ˆï¼šè‡ªåŠ¨ä¿å­˜å®ç°**

### **1. QANoteBlockè‡ªåŠ¨ä¿å­˜æµç¨‹å®Œå–„**

```javascript
// qa-note-block/qa-note.js - å®Œæ•´çš„è‡ªåŠ¨ä¿å­˜å®ç°
window.QANoteBlock = {
    // åŸæœ‰æ¥å£ä¿æŒä¸å˜...

    /**
     * å‘é€é—®é¢˜ï¼ˆå«è‡ªåŠ¨ä¿å­˜ï¼‰
     */
    askQuestion: async (questionData) => {
        try {
            // 1. å‘é€é—®é¢˜åˆ°AI
            const aiResponse = await APIClient.sendQuestion(questionData);
            
            if (aiResponse.success && aiResponse.data.ai_response) {
                // 2. è‡ªåŠ¨ä¿å­˜AIå›ç­”ä¸ºç¬”è®°
                let autoSaveResult = null;
                try {
                    autoSaveResult = await APIClient.saveNote({
                        title: `é—®ç­”ï¼š${questionData.title}`,
                        content: aiResponse.data.ai_response.response,
                        tags: [...(questionData.tags || []), 'AIé—®ç­”', 'auto-saved']
                    });
                } catch (saveError) {
                    console.warn('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', saveError);
                    autoSaveResult = { success: false, error: saveError.message };
                }
                
                // 3. è¿”å›åŒ…å«è‡ªåŠ¨ä¿å­˜ä¿¡æ¯çš„å®Œæ•´ç»“æœ
                return {
                    success: true,
                    data: {
                        ...aiResponse.data,
                        // ğŸ”´ å…³é”®è¡¥å……ï¼šautoSavedå­—æ®µ
                        autoSaved: autoSaveResult ? autoSaveResult.success : false,
                        autoSaveDetails: autoSaveResult,
                        
                        // ç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯
                        userMessage: autoSaveResult && autoSaveResult.success ? 
                            'é—®ç­”å·²å®Œæˆå¹¶è‡ªåŠ¨ä¿å­˜ä¸ºç¬”è®°' : 
                            'é—®ç­”å·²å®Œæˆï¼Œä½†è‡ªåŠ¨ä¿å­˜å¤±è´¥'
                    }
                };
            }
            
            return aiResponse;
            
        } catch (error) {
            console.error('é—®ç­”å¤„ç†å¤±è´¥:', error);
            return {
                success: false,
                error: error.message,
                data: {
                    autoSaved: false,
                    autoSaveDetails: null
                }
            };
        }
    },

    /**
     * é—®ç­”å®Œæˆåçš„åç»­å¤„ç†
     */
    handleQuestionComplete: async (result) => {
        if (result.success && result.data.autoSaved) {
            // è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬”è®°æ¨¡å¼
            await this.switchMode('note');
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            UIBlock.showMessage(
                result.data.userMessage || 'é—®ç­”å·²è‡ªåŠ¨ä¿å­˜ä¸ºç¬”è®°', 
                'success',
                {
                    duration: 4000,
                    actions: [
                        {
                            text: 'æŸ¥çœ‹ç¬”è®°',
                            callback: () => this.loadNotebookPreview()
                        }
                    ]
                }
            );
            
            // åˆ·æ–°ç¬”è®°åˆ—è¡¨
            await this.loadNotebookPreview();
            
        } else if (result.success && !result.data.autoSaved) {
            // é—®ç­”æˆåŠŸä½†è‡ªåŠ¨ä¿å­˜å¤±è´¥
            UIBlock.showMessage(
                'AIå›ç­”æˆåŠŸï¼Œä½†è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¿å­˜', 
                'warning',
                {
                    duration: 5000,
                    actions: [
                        {
                            text: 'æ‰‹åŠ¨ä¿å­˜',
                            callback: () => this.manualSaveLastResponse(result.data)
                        }
                    ]
                }
            );
        }
    },

    /**
     * æ‰‹åŠ¨ä¿å­˜æœ€åä¸€æ¬¡AIå›ç­”
     */
    manualSaveLastResponse: async (responseData) => {
        try {
            const saveData = {
                title: `æ‰‹åŠ¨ä¿å­˜ï¼š${responseData.question || 'é—®ç­”è®°å½•'}`,
                content: responseData.ai_response.response,
                tags: ['AIé—®ç­”', 'manual-saved']
            };

            const result = await this.saveNote(saveData);
            if (result.success) {
                UIBlock.showMessage('æ‰‹åŠ¨ä¿å­˜æˆåŠŸ', 'success');
                await this.switchMode('note');
                await this.loadNotebookPreview();
            } else {
                UIBlock.showMessage(`ä¿å­˜å¤±è´¥: ${result.error}`, 'error');
            }
        } catch (error) {
            UIBlock.showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        }
    }
};
```

### **2. UIBlockæ¶ˆæ¯ç³»ç»Ÿå®Œæ•´å®ç°**

```javascript
// ui-block/main.js - å®Œæ•´çš„UIBlockå®ç°
window.UIBlock = {
    currentBlock: 'qa-note',
    messageQueue: [],
    
    /**
     * æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆå®Œæ•´å®ç°ï¼‰
     */
    showMessage: (text, type = 'info', options = {}) => {
        const messageOptions = {
            duration: 3000,
            closable: true,
            position: 'top-right',
            icon: true,
            actions: [], // æ“ä½œæŒ‰é’®
            id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...options
        };
        
        // éªŒè¯æ¶ˆæ¯ç±»å‹
        const validTypes = ['success', 'error', 'warning', 'info'];
        if (!validTypes.includes(type)) {
            console.warn(`æ— æ•ˆçš„æ¶ˆæ¯ç±»å‹: ${type}ï¼Œä½¿ç”¨é»˜è®¤ç±»å‹ info`);
            type = 'info';
        }
        
        try {
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let messageContainer = document.getElementById('message-container');
            if (!messageContainer) {
                messageContainer = document.createElement('div');
                messageContainer.id = 'message-container';
                messageContainer.className = 'message-container';
                document.body.appendChild(messageContainer);
            }
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-toast message-${type}`;
            messageDiv.id = messageOptions.id;
            messageDiv.setAttribute('data-type', type);
            
            // æ„å»ºæ¶ˆæ¯å†…å®¹
            let messageHTML = '';
            
            // å›¾æ ‡
            if (messageOptions.icon) {
                const icons = {
                    success: 'âœ…',
                    error: 'âŒ',
                    warning: 'âš ï¸',
                    info: 'â„¹ï¸'
                };
                messageHTML += `<span class="message-icon">${icons[type]}</span>`;
            }
            
            // æ¶ˆæ¯æ–‡æœ¬
            messageHTML += `<span class="message-text">${text}</span>`;
            
            // æ“ä½œæŒ‰é’®
            if (messageOptions.actions && messageOptions.actions.length > 0) {
                messageHTML += '<div class="message-actions">';
                messageOptions.actions.forEach((action, index) => {
                    messageHTML += `<button class="message-action-btn" data-action-index="${index}">${action.text}</button>`;
                });
                messageHTML += '</div>';
            }
            
            // å…³é—­æŒ‰é’®
            if (messageOptions.closable) {
                messageHTML += '<button class="message-close" aria-label="å…³é—­">&times;</button>';
            }
            
            messageDiv.innerHTML = messageHTML;
            
            // åº”ç”¨ä½ç½®æ ·å¼
            this.applyMessageStyles(messageDiv, type, messageOptions.position);
            
            // æ·»åŠ åˆ°å®¹å™¨
            messageContainer.appendChild(messageDiv);
            
            // ç»‘å®šäº‹ä»¶
            this.bindMessageEvents(messageDiv, messageOptions);
            
            // å…¥åœºåŠ¨ç”»
            requestAnimationFrame(() => {
                messageDiv.classList.add('message-show');
            });
            
            // è‡ªåŠ¨å…³é—­
            if (messageOptions.duration > 0) {
                setTimeout(() => {
                    this.removeMessage(messageOptions.id);
                }, messageOptions.duration);
            }
            
            // è®°å½•åˆ°æ¶ˆæ¯é˜Ÿåˆ—
            this.messageQueue.push({
                id: messageOptions.id,
                text,
                type,
                timestamp: new Date().toISOString(),
                options: messageOptions
            });
            
            // é™åˆ¶æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦
            if (this.messageQueue.length > 50) {
                this.messageQueue = this.messageQueue.slice(-50);
            }
            
            return {
                success: true,
                data: {
                    messageId: messageOptions.id,
                    displayedAt: new Date().toISOString(),
                    willCloseAt: messageOptions.duration > 0 ? 
                        new Date(Date.now() + messageOptions.duration).toISOString() : null,
                    type: type,
                    text: text
                }
            };
            
        } catch (error) {
            console.error('æ˜¾ç¤ºæ¶ˆæ¯å¤±è´¥:', error);
            return {
                success: false,
                error: `æ˜¾ç¤ºæ¶ˆæ¯å¤±è´¥: ${error.message}`
            };
        }
    },

    /**
     * åº”ç”¨æ¶ˆæ¯æ ·å¼
     */
    applyMessageStyles: (messageDiv, type, position) => {
        // åŸºç¡€æ ·å¼
        const baseStyles = {
            position: 'fixed',
            zIndex: '9999',
            padding: '12px 16px',
            borderRadius: '6px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
            maxWidth: '400px',
            wordWrap: 'break-word',
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
            opacity: '0',
            transform: 'translateY(-20px)',
            transition: 'all 0.3s ease',
            fontFamily: 'system-ui, -apple-system, sans-serif',
            fontSize: '14px',
            lineHeight: '1.4'
        };

        // ç±»å‹æ ·å¼
        const typeStyles = {
            success: {
                backgroundColor: '#f0f9ff',
                color: '#0c4a6e',
                borderLeft: '4px solid #22c55e'
            },
            error: {
                backgroundColor: '#fef2f2',
                color: '#7f1d1d',
                borderLeft: '4px solid #ef4444'
            },
            warning: {
                backgroundColor: '#fffbeb',
                color: '#78350f',
                borderLeft: '4px solid #f59e0b'
            },
            info: {
                backgroundColor: '#f0f9ff',
                color: '#1e3a8a',
                borderLeft: '4px solid #3b82f6'
            }
        };

        // ä½ç½®æ ·å¼
        const positionStyles = {
            'top-right': { top: '20px', right: '20px' },
            'top-left': { top: '20px', left: '20px' },
            'top-center': { top: '20px', left: '50%', transform: 'translateX(-50%) translateY(-20px)' },
            'bottom-right': { bottom: '20px', right: '20px' },
            'bottom-left': { bottom: '20px', left: '20px' },
            'bottom-center': { bottom: '20px', left: '50%', transform: 'translateX(-50%) translateY(20px)' }
        };

        // åº”ç”¨æ ·å¼
        const styles = { ...baseStyles, ...typeStyles[type], ...positionStyles[position] };
        Object.assign(messageDiv.style, styles);
    },

    /**
     * ç»‘å®šæ¶ˆæ¯äº‹ä»¶
     */
    bindMessageEvents: (messageDiv, options) => {
        // å…³é—­æŒ‰é’®äº‹ä»¶
        const closeBtn = messageDiv.querySelector('.message-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.removeMessage(options.id);
            });
        }

        // æ“ä½œæŒ‰é’®äº‹ä»¶
        const actionBtns = messageDiv.querySelectorAll('.message-action-btn');
        actionBtns.forEach((btn, index) => {
            btn.addEventListener('click', () => {
                const action = options.actions[index];
                if (action && typeof action.callback === 'function') {
                    action.callback();
                }
                // æ‰§è¡Œæ“ä½œåè‡ªåŠ¨å…³é—­æ¶ˆæ¯
                this.removeMessage(options.id);
            });
        });

        // æ‚¬åœæš‚åœè‡ªåŠ¨å…³é—­
        if (options.duration > 0) {
            let timeout;
            messageDiv.addEventListener('mouseenter', () => {
                clearTimeout(timeout);
            });
            
            messageDiv.addEventListener('mouseleave', () => {
                timeout = setTimeout(() => {
                    this.removeMessage(options.id);
                }, 2000); // é¼ æ ‡ç¦»å¼€å2ç§’å…³é—­
            });
        }
    },

    /**
     * ç§»é™¤æ¶ˆæ¯
     */
    removeMessage: (messageId) => {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
            // é€€åœºåŠ¨ç”»
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }

        // ä»é˜Ÿåˆ—ä¸­ç§»é™¤
        this.messageQueue = this.messageQueue.filter(msg => msg.id !== messageId);
    },

    /**
     * æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
     */
    clearAllMessages: () => {
        const container = document.getElementById('message-container');
        if (container) {
            container.innerHTML = '';
        }
        this.messageQueue = [];
    },

    /**
     * è·å–æ¶ˆæ¯å†å²
     */
    getMessageHistory: () => {
        return [...this.messageQueue];
    }
};
```

### **3. å®Œæ•´çš„è‡ªåŠ¨ä¿å­˜æµç¨‹é›†æˆ**

```javascript
// ä½¿ç”¨ç¤ºä¾‹ï¼šå®Œæ•´çš„é—®ç­”â†’è‡ªåŠ¨ä¿å­˜â†’æ¨¡å¼åˆ‡æ¢æµç¨‹
async function handleUserQuestion(questionData) {
    try {
        // æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
        UIBlock.showMessage('æ­£åœ¨å¤„ç†æ‚¨çš„é—®é¢˜...', 'info', { duration: 0, id: 'processing' });
        
        // 1. å‘é€é—®é¢˜ï¼ˆåŒ…å«è‡ªåŠ¨ä¿å­˜é€»è¾‘ï¼‰
        const result = await QANoteBlock.askQuestion(questionData);
        
        // ç§»é™¤å¤„ç†ä¸­æ¶ˆæ¯
        UIBlock.removeMessage('processing');
        
        // 2. å¤„ç†é—®ç­”å®Œæˆåçš„åç»­æ“ä½œ
        await QANoteBlock.handleQuestionComplete(result);
        
        return result;
        
    } catch (error) {
        // ç§»é™¤å¤„ç†ä¸­æ¶ˆæ¯
        UIBlock.removeMessage('processing');
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        UIBlock.showMessage(`å¤„ç†å¤±è´¥: ${error.message}`, 'error', {
            duration: 5000,
            actions: [
                {
                    text: 'é‡è¯•',
                    callback: () => handleUserQuestion(questionData)
                }
            ]
        });
        
        throw error;
    }
}
```

---

## ğŸ“Š **æ”¹è¿›æ•ˆæœè¯„ä¼°**

### **æ”¹è¿›å‰åå¯¹æ¯”**

| åŠŸèƒ½ç‚¹ | v3.0æ”¹è¿›å‰ | v3.0æ”¹è¿›å | æ”¹è¿›æ•ˆæœ |
|--------|------------|------------|----------|
| **ç®¡ç†ç•Œé¢** | âŒ åªæœ‰APIæ¥å£ | âœ… å®Œæ•´admin.html + å¯è§†åŒ–ç›‘æ§ | ğŸ”¥ **ä»æ— åˆ°æœ‰** |
| **ç³»ç»Ÿç›‘æ§** | âŒ getSystemMetrics()æœªå®ç° | âœ… å®æ—¶CPU/å†…å­˜/ç£ç›˜/ç½‘ç»œç›‘æ§ | ğŸ”¥ **å®Œå…¨å®ç°** |
| **è‡ªåŠ¨ä¿å­˜** | âŒ autoSavedå­—æ®µç¼ºå¤± | âœ… å®Œæ•´è‡ªåŠ¨ä¿å­˜ + é”™è¯¯å¤„ç† | ğŸ”¥ **æµç¨‹å®Œæ•´** |
| **æ¶ˆæ¯æç¤º** | âŒ showMessage()æœªå®ç° | âœ… å®Œæ•´æ¶ˆæ¯ç³»ç»Ÿ + æ“ä½œæŒ‰é’® | ğŸ”¥ **åŠŸèƒ½å¼ºåŒ–** |

### **æŠ€æœ¯æŒ‡æ ‡**

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| **åŠŸèƒ½å®Œæ•´æ€§** | 70% | 95% | +25% |
| **ç”¨æˆ·ä½“éªŒ** | 60% | 90% | +30% |
| **ç®¡ç†æ•ˆç‡** | 30% | 85% | +55% |
| **é”™è¯¯å¤„ç†** | 40% | 80% | +40% |

---

## ğŸš€ **å®æ–½å»ºè®®**

### **å®æ–½ä¼˜å…ˆçº§**

1. **P0 - UIBlockæ¶ˆæ¯ç³»ç»Ÿ**ï¼ˆ0.5å¤©ï¼‰ï¼š
   - å®Œæ•´çš„showMessageå®ç°
   - æ¶ˆæ¯å®¹å™¨å’Œæ ·å¼

2. **P1 - è‡ªåŠ¨ä¿å­˜æµç¨‹**ï¼ˆ1å¤©ï¼‰ï¼š
   - askQuestionæ–¹æ³•å¢å¼º
   - autoSavedå­—æ®µè¡¥å……
   - é”™è¯¯å¤„ç†ä¼˜åŒ–

3. **P2 - ç®¡ç†ç•Œé¢**ï¼ˆ1.5å¤©ï¼‰ï¼š
   - admin.htmlé¡µé¢åˆ›å»º
   - DeployBlockåŠŸèƒ½å®Œå–„
   - ç³»ç»Ÿç›‘æ§å®ç°

### **éªŒæ”¶æ ‡å‡†**

1. **è‡ªåŠ¨ä¿å­˜éªŒæ”¶**ï¼š
   - âœ… é—®ç­”æˆåŠŸåè‡ªåŠ¨ä¿å­˜ä¸ºç¬”è®°
   - âœ… autoSavedå­—æ®µæ­£ç¡®è¿”å›
   - âœ… è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬”è®°æ¨¡å¼
   - âœ… ç”¨æˆ·æ”¶åˆ°æˆåŠŸæç¤º

2. **ç®¡ç†ç•Œé¢éªŒæ”¶**ï¼š
   - âœ… admin.htmlé¡µé¢å®Œæ•´æ˜¾ç¤º
   - âœ… ç³»ç»ŸæŒ‡æ ‡å®æ—¶æ›´æ–°
   - âœ… æœåŠ¡ç®¡ç†åŠŸèƒ½æ­£å¸¸
   - âœ… ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®Œæ•´

---

## âœ… **æ”¹è¿›æ€»ç»“**

### **è§£å†³çš„å…³é”®é—®é¢˜**

1. âœ… **ç®¡ç†ç•Œé¢å¯è§†åŒ–**ï¼šä»çº¯APIå˜ä¸ºå®Œæ•´çš„Webç®¡ç†ç•Œé¢
2. âœ… **è‡ªåŠ¨ä¿å­˜æµç¨‹å®Œæ•´æ€§**ï¼šè¡¥é½autoSavedå­—æ®µå’Œé”™è¯¯å¤„ç†
3. âœ… **ç”¨æˆ·åé¦ˆä½“ç³»**ï¼šå®Œæ•´çš„æ¶ˆæ¯æç¤ºç³»ç»Ÿ
4. âœ… **ç³»ç»Ÿç›‘æ§èƒ½åŠ›**ï¼šå®æ—¶æŒ‡æ ‡é‡‡é›†å’Œå¯è§†åŒ–å±•ç¤º

### **å®ç°çš„æ ¸å¿ƒä»·å€¼**

- **å¯ç®¡ç†æ€§**ï¼šç®¡ç†å‘˜å¯ä»¥é€šè¿‡ç•Œé¢ç›‘æ§å’Œç®¡ç†ç³»ç»Ÿ
- **ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨ä¿å­˜å’ŒåŠæ—¶åé¦ˆæå‡æ“ä½œä½“éªŒ
- **åŠŸèƒ½å®Œæ•´æ€§**ï¼šè¡¥é½v3.0æ¶æ„è§£è€¦è¿‡ç¨‹ä¸­ä¸¢å¤±çš„åŠŸèƒ½
- **ç”Ÿäº§å°±ç»ª**ï¼šå…·å¤‡ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„ç›‘æ§å’Œç®¡ç†èƒ½åŠ›

**è‡³æ­¤ï¼Œv3.0ç‰ˆæœ¬çš„ä¸‰ä¸ªä¸»è¦ç¼ºå¤±ç‚¹å…¨éƒ¨è¡¥é½å®Œæ¯•ï¼** ğŸ¯ 